define(["paperdialoghelper"],function(e){function n(){return m?Promise.resolve(m):new Promise(function(e,n){var o="grammar",a=new XMLHttpRequest;a.open("GET","voice/grammar/"+o+".json",!0),a.onload=function(){m=JSON.parse(this.response),e(m)},a.onerror=n,a.send()})}function o(e){for(var n,o,a=e.length;0!==a;)o=Math.floor(Math.random()*a),a-=1,n=e[a],e[a]=e[o],e[o]=n;return e}function a(e){return n().then(function(n){e="undefined"!=typeof e?e:"";var a=[];return n.map(function(n){n.items&&n.items.length>0&&(e==n.groupid||""==e)&&n.items.map(function(e){e.commandtemplates&&e.commandtemplates.length>0&&e.commandtemplates.map(function(e){a.push(e)})})}),o(a)})}function i(e){if(m){var n=-1;return n=m.map(function(e){return e.groupid}).indexOf(e),n>-1?m[n]:null}return null}function t(e,n){n.length=Math.min(n.length,4),n=n.map(function(e){return'<div class="exampleCommand"><span class="exampleCommandText">"'+e+'"</span></div>'}).join(""),$(".exampleCommands",e).html(n)}function c(n){var o=e.createDialog({size:"medium",removeOnClose:!0});o.classList.add("ui-body-b"),o.classList.add("background-theme-b");var c="";if(c+='<h2 class="dialogHeader">',c+='<paper-fab icon="arrow-back" mini class="btnCancelVoiceInput"></paper-fab>',n){var r=i(n);r&&(c+="  "+r.name)}c+="</h2>",c+="<div>";var s=a(n);c+='<div class="voiceHelpContent">',c+='<div class="defaultVoiceHelp">',c+='<h1 style="margin-bottom:1.25em;">'+Globalize.translate("HeaderSaySomethingLike")+"</h1>",c+='<div class="exampleCommands">',c+="</div>",c+="</div>",c+='<div class="unrecognizedCommand" style="display:none;">',c+="<h1>"+Globalize.translate("HeaderYouSaid")+"</h1>",c+='<p class="exampleCommand voiceInputContainer"><i class="fa fa-quote-left"></i><span class="voiceInputText exampleCommandText"></span><i class="fa fa-quote-right"></i></p>',c+="<p>"+Globalize.translate("MessageWeDidntRecognizeCommand")+"</p>",c+="<br/>",c+='<paper-button raised class="submit block btnRetry"><iron-icon icon="mic"></iron-icon><span>'+Globalize.translate("ButtonTryAgain")+"</span></paper-button>",c+='<p class="blockedMessage" style="display:none;">'+Globalize.translate("MessageIfYouBlockedVoice")+"<br/><br/></p>",c+="</div>",c+='<paper-button raised class="block btnCancelVoiceInput" style="background-color:#444;"><iron-icon icon="close"></iron-icon><span>'+Globalize.translate("ButtonCancel")+"</span></paper-button>",c+="</div>",c+="</div>",o.innerHTML=c,document.body.appendChild(o),e.open(o),f=o,o.addEventListener("iron-overlay-closed",function(){f=null}),$(".btnCancelVoiceInput",o).on("click",function(){d(),e.close(o)}),$(".btnRetry",o).on("click",function(){$(".unrecognizedCommand").hide(),$(".defaultVoiceHelp").show(),l(!1)}),s.then(function(e){t(o.querySelector(".voiceHelpContent"),e)})}function r(){$(".unrecognizedCommand").show(),$(".defaultVoiceHelp").hide()}function s(n,o){$(".voiceInputText").html(n),n||AppInfo.isNativeApp?$(".blockedMessage").hide():$(".blockedMessage").show(),n?require(["voice/voicecommands.js","voice/grammarprocessor.js"],function(o,a){var i=a(m,n);i&&i.command?o(i).then(function(e){if("show"===e.item.actionid&&"group"===e.item.sourceid){var n=f;n?u(!1,e):u(!0,e)}}).catch(r):r();var t=f;t&&e.close(t)}):o||r()}function l(e){d();var n=new(window.SpeechRecognition||window.webkitSpeechRecognition||window.mozSpeechRecognition||window.oSpeechRecognition||window.msSpeechRecognition);n.lang=v;n.onresult=function(e){e.results.length>0&&s(e.results[0][0].transcript||"")},n.onerror=function(){s("",n.cancelled)},n.onnomatch=function(){s("",n.cancelled)},n.start(),p=n,u(e)}function d(){var e=p;e&&(e.abort(),p=null)}function u(e,n){e!==!1&&require(["paper-fab","css!voice/voice.css"],function(){n?c(n.groupid,n.name):c()})}var p,m,f,v="en-US";return{startListening:l}});