define(["dialogHelper","jQuery","emby-button"],function(e,n){function o(){return f?Promise.resolve(f):new Promise(function(e,n){var o="grammar",t=new XMLHttpRequest;t.open("GET","voice/grammar/"+o+".json",!0),t.onload=function(){f=JSON.parse(this.response),e(f)},t.onerror=n,t.send()})}function t(e){for(var n,o,t=e.length;0!==t;)o=Math.floor(Math.random()*t),t-=1,n=e[t],e[t]=e[o],e[o]=n;return e}function i(e){return o().then(function(n){e="undefined"!=typeof e?e:"";var o=[];return n.map(function(n){n.items&&n.items.length>0&&(e==n.groupid||""==e)&&n.items.map(function(e){e.commandtemplates&&e.commandtemplates.length>0&&e.commandtemplates.map(function(e){o.push(e)})})}),t(o)})}function a(e){if(f){var n=-1;return n=f.map(function(e){return e.groupid}).indexOf(e),n>-1?f[n]:null}return null}function c(e,o){o.length=Math.min(o.length,4),o=o.map(function(e){return'<div class="exampleCommand"><span class="exampleCommandText">"'+e+'"</span></div>'}).join(""),n(".exampleCommands",e).html(o)}function s(o){var t=e.createDialog({size:"medium",removeOnClose:!0});t.classList.add("ui-body-b"),t.classList.add("background-theme-b");var s="";if(s+='<h2 class="dialogHeader">',s+='<paper-fab icon="arrow-back" mini class="btnCancelVoiceInput"></paper-fab>',o){var r=a(o);r&&(s+="  "+r.name)}s+="</h2>",s+="<div>";var l=i(o);s+='<div class="voiceHelpContent">',s+='<div class="defaultVoiceHelp">',s+='<h1 style="margin-bottom:1.25em;">'+Globalize.translate("HeaderSaySomethingLike")+"</h1>",s+='<div class="exampleCommands">',s+="</div>",s+="</div>",s+='<div class="unrecognizedCommand" style="display:none;">',s+="<h1>"+Globalize.translate("HeaderYouSaid")+"</h1>",s+='<p class="exampleCommand voiceInputContainer"><i class="fa fa-quote-left"></i><span class="voiceInputText exampleCommandText"></span><i class="fa fa-quote-right"></i></p>',s+="<p>"+Globalize.translate("MessageWeDidntRecognizeCommand")+"</p>",s+="<br/>",s+='<button is="emby-button" type="button" class="raised submit block btnRetry"><iron-icon icon="mic"></iron-icon><span>'+Globalize.translate("ButtonTryAgain")+"</span></button>",s+='<p class="blockedMessage" style="display:none;">'+Globalize.translate("MessageIfYouBlockedVoice")+"<br/><br/></p>",s+="</div>",s+='<button is="emby-button" type="button" class="raised block btnCancelVoiceInput" style="background-color:#444;"><iron-icon icon="close"></iron-icon><span>'+Globalize.translate("ButtonCancel")+"</span></button>",s+="</div>",s+="</div>",t.innerHTML=s,document.body.appendChild(t),e.open(t),b=t,t.addEventListener("close",function(){b=null}),n(".btnCancelVoiceInput",t).on("click",function(){d(),e.close(t)}),n(".btnRetry",t).on("click",function(){n(".unrecognizedCommand").hide(),n(".defaultVoiceHelp").show(),u(!1)}),l.then(function(e){c(t.querySelector(".voiceHelpContent"),e)})}function r(){n(".unrecognizedCommand").show(),n(".defaultVoiceHelp").hide()}function l(o,t){n(".voiceInputText").html(o),o||AppInfo.isNativeApp?n(".blockedMessage").hide():n(".blockedMessage").show(),o?require(["voice/voicecommands.js","voice/grammarprocessor.js"],function(n,t){var i=t(f,o);i&&i.command?n(i).then(function(e){if("show"===e.item.actionid&&"group"===e.item.sourceid){var n=b;n?m(!1,e):m(!0,e)}}).catch(r):r();var a=b;a&&e.close(a)}):t||r()}function u(e){d();var n=new(window.SpeechRecognition||window.webkitSpeechRecognition||window.mozSpeechRecognition||window.oSpeechRecognition||window.msSpeechRecognition);n.lang=v;n.onresult=function(e){e.results.length>0&&l(e.results[0][0].transcript||"")},n.onerror=function(){l("",n.cancelled)},n.onnomatch=function(){l("",n.cancelled)},n.start(),p=n,m(e)}function d(){var e=p;e&&(e.abort(),p=null)}function m(e,n){e!==!1&&require(["paper-fab","css!voice/voice.css"],function(){n?s(n.groupid,n.name):s()})}var p,f,b,v="en-US";return{startListening:u}});