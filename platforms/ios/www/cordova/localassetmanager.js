!function(){function e(e,r){var t=DeferredBuilder.Deferred();if(window.ApiClientBridge){var n=ApiClientBridge.getLocalMediaSource(e,r);return n?t.resolveWith(null,[JSON.parse(n)]):t.resolveWith(null,[null]),t.promise()}return d(r,e).then(function(e){if(e&&e.Item.MediaSources.length){var r=e.Item.MediaSources[0];return void C(r.Path).then(function(e){e?t.resolveWith(null,[r]):t.resolveWith(null,[null])},J(t))}t.resolveWith(null,[null])},J(t)),t.promise()}function r(){var e=DeferredBuilder.Deferred();if(window.CameraRoll){var r=[];CameraRoll.getPhotos(function(e){r.push(e)}),setTimeout(function(){Logger.log("Found "+r.length+" in camera roll"),e.resolveWith(null,[r])},2e3)}else e.resolveWith(null,[[]]);return e.promise()}function t(e){return k?void e(k):(k=window.sqlitePlugin.openDatabase({name:"offlineusers.db"}),void k.transaction(function(r){r.executeSql("CREATE TABLE IF NOT EXISTS users (id text primary key, data text)"),r.executeSql("create index if not exists idx_users on users(id)"),e(k)}))}function n(e){var r=DeferredBuilder.Deferred();return t(function(t){t.transaction(function(t){t.executeSql("REPLACE INTO offlineusers (id, data) VALUES (?,?)",[e.Id,JSON.stringify(e)],function(){r.resolve()},function(){r.reject()})})}),r.promise()}function o(){var e=DeferredBuilder.Deferred();return t(function(r){r.transaction(function(r){r.executeSql("DELETE from offlineusers where id=?",[user.Id],function(){e.resolve()},function(){e.reject()})})}),e.promise()}function i(e){return V?void e(V):(V=window.sqlitePlugin.openDatabase({name:"offlineactions.db"}),void V.transaction(function(r){r.executeSql("CREATE TABLE IF NOT EXISTS offlineactions (Id text primary key, ServerId text not null, Json text not null)"),r.executeSql("create index if not exists idx_offlineactions on offlineactions(id)"),e(V)}))}function l(e){var r=DeferredBuilder.Deferred();return i(function(t){t.transaction(function(t){t.executeSql("SELECT Json from offlineactions where ServerId=?",[e],function(e,t){for(var n=[],o=0,i=t.rows.length;i>o;o++)n.push(JSON.parse(t.rows.item(o).Json));r.resolveWith(null,[n])},function(){r.reject()})})}),r.promise()}function u(e){var r=e.map(function(e){return"'"+e.Id+"'"}).join(","),t=DeferredBuilder.Deferred();return i(function(e){e.transaction(function(e){e.executeSql("DELETE from offlineactions where Id in ("+r+")",[],function(){t.resolve()},function(){t.reject()})})}),t.promise()}function s(e){return _?void e(_):(_=window.sqlitePlugin.openDatabase({name:"offlineitems.db"}),void _.transaction(function(r){r.executeSql("CREATE TABLE IF NOT EXISTS Items ( Id text primary key, ItemId text not null, ItemType text not null, MediaType text, ServerId text not null, LocalPath text not null, UserIdsWithAccess text, AlbumId text, AlbumName text, SeriesId text, SeriesName text, Json text not null)"),r.executeSql("create index if not exists idx_items on Items(Id)"),r.executeSql("CREATE TABLE IF NOT EXISTS AlbumArtists ( Id text not null, Name text not null, ItemId text not null)"),r.executeSql("create index if not exists idx_AlbumArtists on AlbumArtists(id)"),e(_)}))}function a(e){var r=DeferredBuilder.Deferred();return s(function(t){t.transaction(function(t){t.executeSql("SELECT ItemId from Items where ServerId=?",[e],function(e,t){for(var n=[],o=0,i=t.rows.length;i>o;o++)n.push(t.rows.item(o).ItemId);r.resolveWith(null,[n])},function(){r.reject()})})}),r.promise()}function c(e,r){var t=DeferredBuilder.Deferred();return s(function(n){n.transaction(function(n){n.executeSql("SELECT UserIdsWithAccess from Items where ItemId=? AND ServerId=?",[e,r],function(e,r){var n=[];r.rows.length&&(n=r.rows.item(0).UserIdsWithAccess,n=n?n.split(","):[]),t.resolveWith(null,[n])},function(){t.reject()})})}),t.promise()}function f(e,r,t){Logger.log("saveUserIdsWithAccess");var n=DeferredBuilder.Deferred();return s(function(o){o.transaction(function(o){var i=[t.join(","),e,r];o.executeSql("Update Items set UserIdsWithAccess=? where ItemId=? and ServerId=?",i),n.resolve()})}),n.promise()}function d(e,r){var t=DeferredBuilder.Deferred();return s(function(n){n.transaction(function(n){n.executeSql("SELECT Json from Items where itemId=? AND serverId=?",[e,r],function(e,r){if(r.rows.length){var n=JSON.parse(r.rows.item(0).Json);t.resolveWith(null,[n])}else t.resolveWith(null,[null])},function(){t.reject()})})}),t.promise()}function m(e){Logger.log("addOrUpdateLocalItem");var r=DeferredBuilder.Deferred();return s(function(t){t.transaction(function(t){var n=e.Item||{},o=[e.Id,e.ItemId,n.Type,n.MediaType,e.ServerId,e.LocalPath,(e.UserIdsWithAccess||[]).join(","),n.AlbumId,n.AlbumName,n.SeriesId,n.SeriesName,JSON.stringify(e)];t.executeSql("REPLACE INTO Items (Id, ItemId, ItemType, MediaType, ServerId, LocalPath, UserIdsWithAccess, AlbumId, AlbumName, SeriesId, SeriesName, Json) VALUES (?,?,?,?,?,?,?,?,?,?,?,?)",o),r.resolve()})}),r.promise()}function g(e,r){var t=DeferredBuilder.Deferred();return d(e,r).then(function(n){s(function(o){o.transaction(function(o){o.executeSql("DELETE from Items where itemId=? AND serverId=?",[e,r]);var i=n.AdditionalFiles||[];i.push(n.LocalPath),v(i).then(function(){t.resolve()},J(t))})})},J(t)),t.promise()}function v(e){var r=DeferredBuilder.Deferred();return h(e,0,r),r.promise()}function h(e,r,t){return r>=e.length?void t.resolve():void I(file).then(function(){h(e,r+1,t)},function(){h(e,r+1,t)})}function I(e){var r=DeferredBuilder.Deferred();return Logger.log("Deleting "+e),p(e,null,function(t){t.remove(function(){Logger.log("Deleted "+e),r.resolve()},function(){Logger.log("Error deleting "+e),r.reject()})},function(){Logger.log("Skipping deletion because file does not exist: "+e),r.resolve()}),r.promise()}function p(e,r,t,n){M().then(function(o){o.root.getFile(e,r||{create:!1},t,n)})}function S(e,r,t){var n=!1,o=D(e,r,n);if(n)o.push(x(e,t));else{var i=t.split("."),l=i.length>1?"."+i[i.length-1]:"";o.push("media"+l)}var u={},s=DeferredBuilder.Deferred(),a=o.join("/");u.LocalPath=a;for(var c=0,f=e.MediaSources.length;f>c;c++){var d=e.MediaSources[c];d.Path=a,d.Protocol="File"}return u.ServerId=r.Id,u.Item=e,u.ItemId=e.Id,u.Id=j(u.ServerId,u.ItemId),s.resolveWith(null,[u]),s.promise()}function D(e,r,t){if(!t)return["sync",e.Id];var n=[];return n.push("sync"),n.push(r.Name),"Episode"==e.Type?(n.push("TV"),n.push(e.SeriesName),e.SeasonName&&n.push(e.SeasonName)):"Video"==e.MediaType?(n.push("Videos"),n.push(e.Name)):"Audio"==e.MediaType?(n.push("Music"),e.AlbumArtist&&n.push(e.AlbumArtist),e.Album&&n.push(e.Album)):"Photo"==e.MediaType&&(n.push("Photos"),e.Album&&n.push(e.Album)),n.map(L)}function x(e,r){var t=r||e.Name;return L(t)}function L(e){return e}function w(e,r,t,n){if(!t)return E(e,r,t);var o=DeferredBuilder.Deferred();return"1"==localStorage.getItem("sync-"+e)?(Logger.log("file was downloaded previously"),o.resolveWith(null,[r,!1]),o.promise()):n===!1?(o.resolveWith(null,[r,!0]),o.promise()):(Logger.log("downloading: "+e+" to "+r),T(P(r)).then(function(){p(r,{create:!0},function(t){var n=new BackgroundTransfer.BackgroundDownloader,i=n.createDownload(e,t),l=!1,u=setTimeout(function(){l=!0,o.resolveWith(null,[r,!0])},500);i.startAsync().then(function(){clearTimeout(u),Logger.log("Downloaded local url: "+r),localStorage.setItem("sync-"+e,"1"),l||o.resolveWith(null,[r,!1])},function(){clearTimeout(u),Logger.log("Error downloading url: "+e),l||o.reject()},function(){})})},J(o)),o.promise())}function A(e){for(var r=0,t=z.length;t>r;r++)e==z[r]&&(z[r]="")}function E(e,r,t){var n=DeferredBuilder.Deferred();if("1"==localStorage.getItem("sync-"+e))return Logger.log("file was downloaded previously"),n.resolveWith(null,[r]),n.promise();var o=e+r;return-1!=z.indexOf(o)&&n.resolveWith(null,[r,!0]),Logger.log("downloading: "+e+" to "+r),T(P(r)).then(function(){p(r,{create:!0},function(i){var l=t,u=!1,s=new FileTransfer;z.push(o),s.download(e,i.toURL(),function(){A(o),t?(Logger.log("Downloaded local url: "+r),localStorage.setItem("sync-"+e,"1"),l=!1):n.resolveWith(null,[r])},function(){A(o),Logger.log("Error downloading url: "+e),t?u=!0:n.reject()}),t&&setTimeout(function(){u?n.reject():n.resolveWith(null,[r,l])},500)},function(){Logger.log("getFile failed for "+r),n.reject()})},J(n)),n.promise()}function T(e){var r=DeferredBuilder.Deferred();return W(e,0,r),r.promise()}function W(e,r,t){var n=e.split("/");if(r>=n.length)return void t.resolve();n.length=r+1;var o=n.join("/");y(o).then(function(){W(e,r+1,t)},J(t))}function y(e){Logger.log("creating directory: "+e);var r=DeferredBuilder.Deferred();return M().then(function(t){t.root.getDirectory(e,{create:!0,exclusive:!1},function(){Logger.log("createDirectory succeeded"),r.resolve()},function(){Logger.log("createDirectory failed"),r.reject()})},J(r)),r.promise()}function B(e,r,t){var n=item.LocalPath,o=N(item,t.Language,t.IsForced)+"."+t.Codec.toLowerCase(),i=P(n);return n=q(i,o),w(e,n)}function N(e,r,t){var n=e.LocalPath,o=b(n);return r&&(o+="."+r.toLowerCase()),t&&(o+=".foreign"),o}function b(e){var r=e.split("/"),t=r[r.length-1],n=t.lastIndexOf(".");return-1!=n&&(t=t.substring(0,n)),t}function P(e){var r=e.split("/");return r.length--,r.join("/")}function q(e,r){return e+r}function j(e,r){return e+"_"+r}function F(e,r,t){var n=DeferredBuilder.Deferred();return U(e,r,t).then(function(e){C(e).then(function(e){n.resolveWith(null,[e])},J(n))},J(n)),n.promise()}function O(e,r,t,n){var o=DeferredBuilder.Deferred();return U(r,t,n).then(function(r){w(e,r).then(function(){o.resolve()},J(o))},J(o)),o.promise()}function U(e,r,t){var n=DeferredBuilder.Deferred(),o="images/"+e+"/"+r+"/"+t;return n.resolveWith(null,[o]),n.promise()}function C(e){var r=DeferredBuilder.Deferred();if(window.NativeFileSystem){var t=NativeFileSystem.fileExists(e);return Logger.log("fileExists: "+t+" - path: "+e),r.resolveWith(null,[t]),r.promise()}return p(e,null,function(){Logger.log("fileExists: true - path: "+e),r.resolveWith(null,[!0])},function(){Logger.log("fileExists: false - path: "+e),r.resolveWith(null,[!1])}),r.promise()}function M(){var e=DeferredBuilder.Deferred();return X?e.resolveWith(null,[X]):requestFileSystem(PERSISTENT,0,function(r){X=r,e.resolveWith(null,[X])}),e.promise()}function J(e){return function(){e.reject()}}function R(e){var r=DeferredBuilder.Deferred();return browserInfo.android?(r.resolveWith(null,["file://"+e]),r.promise()):(p(e,null,function(t){Logger.log("translateFilePath fileExists: true - path: "+e),Logger.log("translateFilePath resolving with: "+t.toURL()),r.resolveWith(null,[t.toURL()])},function(){Logger.log("translateFilePath fileExists: false - path: "+e),r.resolveWith(null,[e])}),r.promise())}var k,V,_,X,z=[];window.LocalAssetManager={getLocalMediaSource:e,saveOfflineUser:n,deleteOfflineUser:o,getCameraPhotos:r,getOfflineActions:l,deleteOfflineActions:u,getServerItemIds:a,removeLocalItem:g,getLocalItem:d,addOrUpdateLocalItem:m,createLocalItem:S,downloadFile:w,downloadSubtitles:B,hasImage:F,downloadImage:O,fileExists:C,translateFilePath:R,getUserIdsWithAccess:c,saveUserIdsWithAccess:f}}();