!function(){function e(e,n){return window.ApiClientBridge?new Promise(function(t){var r=ApiClientBridge.getLocalMediaSource(e,n);t(r?JSON.parse(r):null)}):d(n,e).then(function(e){if(e&&e.Item.MediaSources.length){var n=e.Item.MediaSources[0];return F(n.Path).then(function(e){return e?n:null})}return null})}function n(){var e=jQuery.Deferred();if(window.CameraRoll){var n=[];CameraRoll.getPhotos(function(e){n.push(e)}),setTimeout(function(){e.resolveWith(null,[n])},2e3)}else e.resolveWith(null,[[]]);return e.promise()}function t(e){return B?void e(B):(B=window.sqlitePlugin.openDatabase({name:"offlineusers.db"}),void B.transaction(function(n){n.executeSql("CREATE TABLE IF NOT EXISTS users (id text primary key, data text)"),n.executeSql("create index if not exists idx_users on users(id)"),e(B)}))}function r(e){var n=jQuery.Deferred();return t(function(t){t.transaction(function(t){t.executeSql("REPLACE INTO offlineusers (id, data) VALUES (?,?)",[e.Id,JSON.stringify(e)],function(){n.resolve()},function(){n.reject()})})}),n.promise()}function i(){var e=jQuery.Deferred();return t(function(n){n.transaction(function(n){n.executeSql("DELETE from offlineusers where id=?",[user.Id],function(){e.resolve()},function(){e.reject()})})}),e.promise()}function o(e){return k?void e(k):(k=window.sqlitePlugin.openDatabase({name:"offlineactions.db"}),void k.transaction(function(n){n.executeSql("CREATE TABLE IF NOT EXISTS offlineactions (Id text primary key, ServerId text not null, Json text not null)"),n.executeSql("create index if not exists idx_offlineactions on offlineactions(id)"),e(k)}))}function u(e){var n=jQuery.Deferred();return o(function(t){t.transaction(function(t){t.executeSql("SELECT Json from offlineactions where ServerId=?",[e],function(e,t){for(var r=[],i=0,o=t.rows.length;o>i;i++)r.push(JSON.parse(t.rows.item(i).Json));n.resolveWith(null,[r])},function(){n.reject()})})}),n.promise()}function s(e){var n=e.map(function(e){return"'"+e.Id+"'"}).join(","),t=jQuery.Deferred();return o(function(e){e.transaction(function(e){e.executeSql("DELETE from offlineactions where Id in ("+n+")",[],function(){t.resolve()},function(){t.reject()})})}),t.promise()}function c(e){return V?void e(V):(V=window.sqlitePlugin.openDatabase({name:"offlineitems.db"}),void V.transaction(function(n){n.executeSql("CREATE TABLE IF NOT EXISTS Items ( Id text primary key, ItemId text not null, ItemType text not null, MediaType text, ServerId text not null, LocalPath text not null, UserIdsWithAccess text, AlbumId text, AlbumName text, SeriesId text, SeriesName text, Json text not null)"),n.executeSql("create index if not exists idx_items on Items(Id)"),n.executeSql("CREATE TABLE IF NOT EXISTS AlbumArtists ( Id text not null, Name text not null, ItemId text not null)"),n.executeSql("create index if not exists idx_AlbumArtists on AlbumArtists(id)"),e(V)}))}function l(e){var n=jQuery.Deferred();return c(function(t){t.transaction(function(t){t.executeSql("SELECT ItemId from Items where ServerId=?",[e],function(e,t){for(var r=[],i=0,o=t.rows.length;o>i;i++)r.push(t.rows.item(i).ItemId);n.resolveWith(null,[r])},function(){n.reject()})})}),n.promise()}function a(e,n){var t=jQuery.Deferred();return c(function(r){r.transaction(function(r){r.executeSql("SELECT UserIdsWithAccess from Items where ItemId=? AND ServerId=?",[e,n],function(e,n){var r=[];n.rows.length&&(r=n.rows.item(0).UserIdsWithAccess,r=r?r.split(","):[]),t.resolveWith(null,[r])},function(){t.reject()})})}),t.promise()}function f(e,n,t){var r=jQuery.Deferred();return c(function(i){i.transaction(function(i){var o=[t.join(","),e,n];i.executeSql("Update Items set UserIdsWithAccess=? where ItemId=? and ServerId=?",o),r.resolve()})}),r.promise()}function d(e,n){return new Promise(function(e,n){e(null)})}function m(e){var n=jQuery.Deferred();return c(function(t){t.transaction(function(t){var r=e.Item||{},i=[e.Id,e.ItemId,r.Type,r.MediaType,e.ServerId,e.LocalPath,(e.UserIdsWithAccess||[]).join(","),r.AlbumId,r.AlbumName,r.SeriesId,r.SeriesName,JSON.stringify(e)];t.executeSql("REPLACE INTO Items (Id, ItemId, ItemType, MediaType, ServerId, LocalPath, UserIdsWithAccess, AlbumId, AlbumName, SeriesId, SeriesName, Json) VALUES (?,?,?,?,?,?,?,?,?,?,?,?)",i),n.resolve()})}),n.promise()}function I(e,n){var t=jQuery.Deferred();return d(e,n).then(function(r){c(function(i){i.transaction(function(i){i.executeSql("DELETE from Items where itemId=? AND serverId=?",[e,n]);var o=r.AdditionalFiles||[];o.push(r.LocalPath),v(o).then(function(){t.resolve()},R(t))})})},R(t)),t.promise()}function v(e){var n=jQuery.Deferred();return h(e,0,n),n.promise()}function h(e,n,t){return n>=e.length?void t.resolve():void S(file).then(function(){h(e,n+1,t)},function(){h(e,n+1,t)})}function S(e){var n=jQuery.Deferred();return p(e,null,function(e){e.remove(function(){n.resolve()},function(){n.reject()})},function(){n.resolve()}),n.promise()}function p(e,n,t,r){M().then(function(i){i.root.getFile(e,n||{create:!1},t,r)})}function x(e,n,t){var r=!1,i=A(e,n,r);if(r)i.push(g(e,t));else{var o=t.split("."),u=o.length>1?"."+o[o.length-1]:"";i.push("media"+u)}var s={},c=jQuery.Deferred(),l=i.join("/");s.LocalPath=l;for(var a=0,f=e.MediaSources.length;f>a;a++){var d=e.MediaSources[a];d.Path=l,d.Protocol="File"}return s.ServerId=n.Id,s.Item=e,s.ItemId=e.Id,s.Id=C(s.ServerId,s.ItemId),c.resolveWith(null,[s]),c.promise()}function A(e,n,t){if(!t)return["sync",e.Id];var r=[];return r.push("sync"),r.push(n.Name),"Episode"==e.Type?(r.push("TV"),r.push(e.SeriesName),e.SeasonName&&r.push(e.SeasonName)):"Video"==e.MediaType?(r.push("Videos"),r.push(e.Name)):"Audio"==e.MediaType?(r.push("Music"),e.AlbumArtist&&r.push(e.AlbumArtist),e.Album&&r.push(e.Album)):"Photo"==e.MediaType&&(r.push("Photos"),e.Album&&r.push(e.Album)),r.map(w)}function g(e,n){var t=n||e.Name;return w(t)}function w(e){return e}function y(e,n,t,r){if(!t)return E(e,n,t);var i=jQuery.Deferred();return"1"==localStorage.getItem("sync-"+e)?(i.resolveWith(null,[n,!1]),i.promise()):r===!1?(i.resolveWith(null,[n,!0]),i.promise()):(j(W(n)).then(function(){p(n,{create:!0},function(t){var r=new BackgroundTransfer.BackgroundDownloader,o=r.createDownload(e,t),u=!1,s=setTimeout(function(){u=!0,i.resolveWith(null,[n,!0])},500);o.startAsync().then(function(){clearTimeout(s),localStorage.setItem("sync-"+e,"1"),u||i.resolveWith(null,[n,!1])},function(){clearTimeout(s),u||i.reject()},function(){})})},R(i)),i.promise())}function T(e){for(var n=0,t=X.length;t>n;n++)e==X[n]&&(X[n]="")}function E(e,n,t){var r=jQuery.Deferred();if("1"==localStorage.getItem("sync-"+e))return r.resolveWith(null,[n]),r.promise();var i=e+n;return-1!=X.indexOf(i)&&r.resolveWith(null,[n,!0]),j(W(n)).then(function(){p(n,{create:!0},function(o){var u=t,s=!1,c=new FileTransfer;X.push(i),c.download(e,o.toURL(),function(){T(i),t?(localStorage.setItem("sync-"+e,"1"),u=!1):r.resolveWith(null,[n])},function(){T(i),t?s=!0:r.reject()}),t&&setTimeout(function(){s?r.reject():r.resolveWith(null,[n,u])},500)},function(){r.reject()})},R(r)),r.promise()}function j(e){return new Promise(function(n,t){L(e,0,n,t)})}function L(e,n,t,r){var i=e.split("/");if(n>=i.length)return void t();i.length=n+1;var o=i.join("/");P(o).then(function(){L(e,n+1,t,r)},r)}function P(e){return new Promise(function(n,t){M().then(function(r){r.root.getDirectory(e,{create:!0,exclusive:!1},function(){n()},function(){t()})},t)})}function N(e,n,t){var r=item.LocalPath,i=D(item,t.Language,t.IsForced)+"."+t.Codec.toLowerCase(),o=W(r);return r=q(o,i),y(e,r)}function D(e,n,t){var r=e.LocalPath,i=b(r);return n&&(i+="."+n.toLowerCase()),t&&(i+=".foreign"),i}function b(e){var n=e.split("/"),t=n[n.length-1],r=t.lastIndexOf(".");return-1!=r&&(t=t.substring(0,r)),t}function W(e){var n=e.split("/");return n.length--,n.join("/")}function q(e,n){return e+n}function C(e,n){return e+"_"+n}function O(e,n,t){return Q(e,n,t).then(function(e){return F(e)})}function U(e,n,t,r){return Q(n,t,r).then(function(n){return y(e,n)})}function Q(e,n,t){return new Promise(function(r){r("images/"+e+"/"+n+"/"+t)})}function F(e){return new Promise(function(n){if(window.NativeFileSystem){var t=NativeFileSystem.fileExists(e);return void n(t)}p(e,null,function(){n(!0)},function(){n(!1)})})}function M(){return new Promise(function(e){_?e(_):requestFileSystem(PERSISTENT,0,function(n){_=n,e(_)})})}function R(e){return function(){e.reject()}}function J(e){return new Promise(function(n){return browserInfo.android?void n("file://"+e):void p(e,null,function(e){n(e.toURL())},function(){n(e)})})}var B,k,V,_,X=[];window.LocalAssetManager={getLocalMediaSource:e,saveOfflineUser:r,deleteOfflineUser:i,getCameraPhotos:n,getOfflineActions:u,deleteOfflineActions:s,getServerItemIds:l,removeLocalItem:I,getLocalItem:d,addOrUpdateLocalItem:m,createLocalItem:x,downloadFile:y,downloadSubtitles:N,hasImage:O,downloadImage:U,fileExists:F,translateFilePath:J,getUserIdsWithAccess:a,saveUserIdsWithAccess:f}}();