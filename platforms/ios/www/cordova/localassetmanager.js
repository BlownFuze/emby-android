!function(){function e(e,t){return window.ApiClientBridge?new Promise(function(n){var r=ApiClientBridge.getLocalMediaSource(e,t);n(r?JSON.parse(r):null)}):d(t,e).then(function(e){if(e&&e.Item.MediaSources.length){var t=e.Item.MediaSources[0];return Q(t.Path).then(function(e){return e?t:null})}return null})}function t(){var e=jQuery.Deferred();if(window.CameraRoll){var t=[];CameraRoll.getPhotos(function(e){t.push(e)}),setTimeout(function(){Logger.log("Found "+t.length+" in camera roll"),e.resolveWith(null,[t])},2e3)}else e.resolveWith(null,[[]]);return e.promise()}function n(e){return B?void e(B):(B=window.sqlitePlugin.openDatabase({name:"offlineusers.db"}),void B.transaction(function(t){t.executeSql("CREATE TABLE IF NOT EXISTS users (id text primary key, data text)"),t.executeSql("create index if not exists idx_users on users(id)"),e(B)}))}function r(e){var t=jQuery.Deferred();return n(function(n){n.transaction(function(n){n.executeSql("REPLACE INTO offlineusers (id, data) VALUES (?,?)",[e.Id,JSON.stringify(e)],function(){t.resolve()},function(){t.reject()})})}),t.promise()}function o(){var e=jQuery.Deferred();return n(function(t){t.transaction(function(t){t.executeSql("DELETE from offlineusers where id=?",[user.Id],function(){e.resolve()},function(){e.reject()})})}),e.promise()}function i(e){return k?void e(k):(k=window.sqlitePlugin.openDatabase({name:"offlineactions.db"}),void k.transaction(function(t){t.executeSql("CREATE TABLE IF NOT EXISTS offlineactions (Id text primary key, ServerId text not null, Json text not null)"),t.executeSql("create index if not exists idx_offlineactions on offlineactions(id)"),e(k)}))}function u(e){var t=jQuery.Deferred();return i(function(n){n.transaction(function(n){n.executeSql("SELECT Json from offlineactions where ServerId=?",[e],function(e,n){for(var r=[],o=0,i=n.rows.length;i>o;o++)r.push(JSON.parse(n.rows.item(o).Json));t.resolveWith(null,[r])},function(){t.reject()})})}),t.promise()}function l(e){var t=e.map(function(e){return"'"+e.Id+"'"}).join(","),n=jQuery.Deferred();return i(function(e){e.transaction(function(e){e.executeSql("DELETE from offlineactions where Id in ("+t+")",[],function(){n.resolve()},function(){n.reject()})})}),n.promise()}function s(e){return V?void e(V):(V=window.sqlitePlugin.openDatabase({name:"offlineitems.db"}),void V.transaction(function(t){t.executeSql("CREATE TABLE IF NOT EXISTS Items ( Id text primary key, ItemId text not null, ItemType text not null, MediaType text, ServerId text not null, LocalPath text not null, UserIdsWithAccess text, AlbumId text, AlbumName text, SeriesId text, SeriesName text, Json text not null)"),t.executeSql("create index if not exists idx_items on Items(Id)"),t.executeSql("CREATE TABLE IF NOT EXISTS AlbumArtists ( Id text not null, Name text not null, ItemId text not null)"),t.executeSql("create index if not exists idx_AlbumArtists on AlbumArtists(id)"),e(V)}))}function c(e){var t=jQuery.Deferred();return s(function(n){n.transaction(function(n){n.executeSql("SELECT ItemId from Items where ServerId=?",[e],function(e,n){for(var r=[],o=0,i=n.rows.length;i>o;o++)r.push(n.rows.item(o).ItemId);t.resolveWith(null,[r])},function(){t.reject()})})}),t.promise()}function a(e,t){var n=jQuery.Deferred();return s(function(r){r.transaction(function(r){r.executeSql("SELECT UserIdsWithAccess from Items where ItemId=? AND ServerId=?",[e,t],function(e,t){var r=[];t.rows.length&&(r=t.rows.item(0).UserIdsWithAccess,r=r?r.split(","):[]),n.resolveWith(null,[r])},function(){n.reject()})})}),n.promise()}function f(e,t,n){Logger.log("saveUserIdsWithAccess");var r=jQuery.Deferred();return s(function(o){o.transaction(function(o){var i=[n.join(","),e,t];o.executeSql("Update Items set UserIdsWithAccess=? where ItemId=? and ServerId=?",i),r.resolve()})}),r.promise()}function d(e,t){return new Promise(function(e,t){e(null)})}function g(e){Logger.log("addOrUpdateLocalItem");var t=jQuery.Deferred();return s(function(n){n.transaction(function(n){var r=e.Item||{},o=[e.Id,e.ItemId,r.Type,r.MediaType,e.ServerId,e.LocalPath,(e.UserIdsWithAccess||[]).join(","),r.AlbumId,r.AlbumName,r.SeriesId,r.SeriesName,JSON.stringify(e)];n.executeSql("REPLACE INTO Items (Id, ItemId, ItemType, MediaType, ServerId, LocalPath, UserIdsWithAccess, AlbumId, AlbumName, SeriesId, SeriesName, Json) VALUES (?,?,?,?,?,?,?,?,?,?,?,?)",o),t.resolve()})}),t.promise()}function m(e,t){var n=jQuery.Deferred();return d(e,t).then(function(r){s(function(o){o.transaction(function(o){o.executeSql("DELETE from Items where itemId=? AND serverId=?",[e,t]);var i=r.AdditionalFiles||[];i.push(r.LocalPath),I(i).then(function(){n.resolve()},R(n))})})},R(n)),n.promise()}function I(e){var t=jQuery.Deferred();return h(e,0,t),t.promise()}function h(e,t,n){return t>=e.length?void n.resolve():void v(file).then(function(){h(e,t+1,n)},function(){h(e,t+1,n)})}function v(e){var t=jQuery.Deferred();return Logger.log("Deleting "+e),p(e,null,function(n){n.remove(function(){Logger.log("Deleted "+e),t.resolve()},function(){Logger.log("Error deleting "+e),t.reject()})},function(){Logger.log("Skipping deletion because file does not exist: "+e),t.resolve()}),t.promise()}function p(e,t,n,r){M().then(function(o){o.root.getFile(e,t||{create:!1},n,r)})}function S(e,t,n){var r=!1,o=x(e,t,r);if(r)o.push(L(e,n));else{var i=n.split("."),u=i.length>1?"."+i[i.length-1]:"";o.push("media"+u)}var l={},s=jQuery.Deferred(),c=o.join("/");l.LocalPath=c;for(var a=0,f=e.MediaSources.length;f>a;a++){var d=e.MediaSources[a];d.Path=c,d.Protocol="File"}return l.ServerId=t.Id,l.Item=e,l.ItemId=e.Id,l.Id=F(l.ServerId,l.ItemId),s.resolveWith(null,[l]),s.promise()}function x(e,t,n){if(!n)return["sync",e.Id];var r=[];return r.push("sync"),r.push(t.Name),"Episode"==e.Type?(r.push("TV"),r.push(e.SeriesName),e.SeasonName&&r.push(e.SeasonName)):"Video"==e.MediaType?(r.push("Videos"),r.push(e.Name)):"Audio"==e.MediaType?(r.push("Music"),e.AlbumArtist&&r.push(e.AlbumArtist),e.Album&&r.push(e.Album)):"Photo"==e.MediaType&&(r.push("Photos"),e.Album&&r.push(e.Album)),r.map(w)}function L(e,t){var n=t||e.Name;return w(n)}function w(e){return e}function A(e,t,n,r){if(!n)return y(e,t,n);var o=jQuery.Deferred();return"1"==localStorage.getItem("sync-"+e)?(Logger.log("file was downloaded previously"),o.resolveWith(null,[t,!1]),o.promise()):r===!1?(o.resolveWith(null,[t,!0]),o.promise()):(Logger.log("downloading: "+e+" to "+t),T(W(t)).then(function(){p(t,{create:!0},function(n){var r=new BackgroundTransfer.BackgroundDownloader,i=r.createDownload(e,n),u=!1,l=setTimeout(function(){u=!0,o.resolveWith(null,[t,!0])},500);i.startAsync().then(function(){clearTimeout(l),Logger.log("Downloaded local url: "+t),localStorage.setItem("sync-"+e,"1"),u||o.resolveWith(null,[t,!1])},function(){clearTimeout(l),Logger.log("Error downloading url: "+e),u||o.reject()},function(){})})},R(o)),o.promise())}function E(e){for(var t=0,n=X.length;n>t;t++)e==X[t]&&(X[t]="")}function y(e,t,n){var r=jQuery.Deferred();if("1"==localStorage.getItem("sync-"+e))return Logger.log("file was downloaded previously"),r.resolveWith(null,[t]),r.promise();var o=e+t;return-1!=X.indexOf(o)&&r.resolveWith(null,[t,!0]),Logger.log("downloading: "+e+" to "+t),T(W(t)).then(function(){p(t,{create:!0},function(i){var u=n,l=!1,s=new FileTransfer;X.push(o),s.download(e,i.toURL(),function(){E(o),n?(Logger.log("Downloaded local url: "+t),localStorage.setItem("sync-"+e,"1"),u=!1):r.resolveWith(null,[t])},function(){E(o),Logger.log("Error downloading url: "+e),n?l=!0:r.reject()}),n&&setTimeout(function(){l?r.reject():r.resolveWith(null,[t,u])},500)},function(){Logger.log("getFile failed for "+t),r.reject()})},R(r)),r.promise()}function T(e){return new Promise(function(t,n){j(e,0,t,n)})}function j(e,t,n,r){var o=e.split("/");if(t>=o.length)return void n();o.length=t+1;var i=o.join("/");D(i).then(function(){j(e,t+1,n,r)},r)}function D(e){return Logger.log("creating directory: "+e),new Promise(function(t,n){M().then(function(r){r.root.getDirectory(e,{create:!0,exclusive:!1},function(){Logger.log("createDirectory succeeded"),t()},function(){Logger.log("createDirectory failed"),n()})},n)})}function P(e,t,n){var r=item.LocalPath,o=N(item,n.Language,n.IsForced)+"."+n.Codec.toLowerCase(),i=W(r);return r=q(i,o),A(e,r)}function N(e,t,n){var r=e.LocalPath,o=b(r);return t&&(o+="."+t.toLowerCase()),n&&(o+=".foreign"),o}function b(e){var t=e.split("/"),n=t[t.length-1],r=n.lastIndexOf(".");return-1!=r&&(n=n.substring(0,r)),n}function W(e){var t=e.split("/");return t.length--,t.join("/")}function q(e,t){return e+t}function F(e,t){return e+"_"+t}function U(e,t,n){return C(e,t,n).then(function(e){return Q(e)})}function O(e,t,n,r){return C(t,n,r).then(function(t){return A(e,t)})}function C(e,t,n){return new Promise(function(r){r("images/"+e+"/"+t+"/"+n)})}function Q(e){return new Promise(function(t){if(window.NativeFileSystem){var n=NativeFileSystem.fileExists(e);return Logger.log("fileExists: "+n+" - path: "+e),void t(n)}p(e,null,function(){Logger.log("fileExists: true - path: "+e),t(!0)},function(){Logger.log("fileExists: false - path: "+e),t(!1)})})}function M(){return new Promise(function(e){_?e(_):requestFileSystem(PERSISTENT,0,function(t){_=t,e(_)})})}function R(e){return function(){e.reject()}}function J(e){return new Promise(function(t){return browserInfo.android?void t("file://"+e):void p(e,null,function(n){Logger.log("translateFilePath fileExists: true - path: "+e),Logger.log("translateFilePath resolving with: "+n.toURL()),t(n.toURL())},function(){Logger.log("translateFilePath fileExists: false - path: "+e),t(e)})})}var B,k,V,_,X=[];window.LocalAssetManager={getLocalMediaSource:e,saveOfflineUser:r,deleteOfflineUser:o,getCameraPhotos:t,getOfflineActions:u,deleteOfflineActions:l,getServerItemIds:c,removeLocalItem:m,getLocalItem:d,addOrUpdateLocalItem:g,createLocalItem:S,downloadFile:A,downloadSubtitles:P,hasImage:U,downloadImage:O,fileExists:Q,translateFilePath:J,getUserIdsWithAccess:a,saveUserIdsWithAccess:f}}();