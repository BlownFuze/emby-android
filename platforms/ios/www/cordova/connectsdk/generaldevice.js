define(["appSettings"],function(e){function t(){function t(e){return e.ErrorCode?(MediaController.showPlaybackInfoErrorMessage(e.ErrorCode),!1):!0}function n(e,t){var n=t.filter(function(e){return e.enableDirectPlay=MediaController.supportsDirectPlay(e),e.enableDirectPlay})[0];return n||(n=t.filter(function(e){return e.SupportsDirectStream})[0]),n||t.filter(function(e){return e.SupportsTranscoding})[0]}function o(e,o){if(null==e)throw new Error("item cannot be null");if("Audio"!==e.MediaType&&"Video"!==e.MediaType)throw new Error("Unrecognized media type");if(e.IsPlaceHolder)return void MediaController.showPlaybackInfoErrorMessage("PlaceHolder");var r=m.getDeviceProfile();"Video"===e.MediaType&&Dashboard.showModalLoadingMsg(),MediaController.getPlaybackInfo(e.Id,r,o).then(function(a){if(t(a)){var l=n(e.MediaType,a.MediaSources);l?l.RequiresOpening?getLiveStream(e.Id,a.PlaySessionId,r,o,l,null,null).then(function(t){t.MediaSource.enableDirectPlay=supportsDirectPlay(t.MediaSource),i(e,t.MediaSource,o,callback)}):i(e,l,o,callback):(Dashboard.hideModalLoadingMsg(),MediaController.showPlaybackInfoErrorMessage("NoCompatibleStream"))}})}function i(e,t,n,o){Dashboard.hideModalLoadingMsg();var i=MediaPlayer.createStreamInfo("Video",e,t,n);p.getMediaPlayer().playMedia(i.url,i.MimeType,{title:e.Name,description:e.Overview||"",shouldLoop:!1}).success(function(e,t){Logger.log("Video launch successful"),y=t&&t.acquire()}).error(function(e){Logger.log("error: "+e.message)}),o.resolveWith(null,[i])}function r(){var e={};return e.playableMediaTypes=["Audio","Video"],e.isLocalPlayer=!1,e.supportedCommands=["VolumeUp","VolumeDown","Mute","Unmute","ToggleMute","SetVolume"],e}function a(e){var t=r();return t.appName=t.name=t.deviceName=e.getFriendlyName(),t.playerName=P,t.id=e.getId(),t}function l(e){var t=["AirPlay","Airplay","airplay"];return t.filter(function(t){return e.hasService(t)}).length>0}function u(){var e=m.lastPlayerData||{};return e=e.PlayState||{},null==e.VolumeLevel?100:e.VolumeLevel}function s(){}function c(e){p&&s(),Logger.log("session.connect succeeded"),MediaController.setActivePlayer(P,a(e)),p=e,f=e.getId()}function d(e){e.off("ready"),Logger.log("creating webAppSession"),c(e)}function g(){var e=f;e&&m.tryPair({id:e})}var p,f,y,m=this,P="ConnectSDK";m.name=P,m.getItemsForPlayback=function(e){var t=Dashboard.getCurrentUserId();return e.Limit=e.Limit||100,e.ExcludeLocationTypes="Virtual",ApiClient.getItems(t,e)};var h={};Events.on(h,"playbackstart",function(e,t){Logger.log("cc: playbackstart");var n=m.getPlayerStateInternal(t);Events.trigger(m,"playbackstart",[n])}),Events.on(h,"playbackstop",function(e,t){Logger.log("cc: playbackstop");var n=m.getPlayerStateInternal(t);Events.trigger(m,"playbackstop",[n]),m.lastPlayerData={}}),Events.on(h,"playbackprogress",function(e,t){Logger.log("cc: positionchange");var n=m.getPlayerStateInternal(t);Events.trigger(m,"positionchange",[n])}),m.play=function(e){Dashboard.getCurrentUser().then(function(){e.items?m.playWithCommand(e,"PlayNow"):m.getItemsForPlayback({Ids:e.ids.join(",")}).then(function(t){e.items=t.Items,m.playWithCommand(e,"PlayNow")})})},m.playWithCommand=function(e,t){return e.items?void o(items[0],null,serverAddress):void ApiClient.getItem(Dashboard.getCurrentUserId(),e.ids[0]).then(function(n){e.items=[n],m.playWithCommand(e,t)})},m.unpause=function(){y&&y.pause()},m.pause=function(){y&&y.pause()},m.shuffle=function(e){var t=Dashboard.getCurrentUserId();ApiClient.getItem(t,e).then(function(e){m.playWithCommand({items:[e]},"Shuffle")})},m.instantMix=function(e){var t=Dashboard.getCurrentUserId();ApiClient.getItem(t,e).then(function(e){m.playWithCommand({items:[e]},"InstantMix")})},m.canQueueMediaType=function(e){return"Audio"==e},m.queue=function(e){m.playWithCommnd(e,"PlayLast")},m.queueNext=function(e){m.playWithCommand(e,"PlayNext")},m.stop=function(){y&&y.stop()},m.displayContent=function(){},m.mute=function(){p&&p.getVolumeControl().setMute(!0)},m.unMute=function(){m.setVolume(u()+2)},m.toggleMute=function(){var e=m.lastPlayerData||{};e=e.PlayState||{},e.IsMuted?m.unMute():m.mute()},m.getDeviceProfile=function(){var t=m.getVideoQualityOptions().filter(function(e){return e.selected})[0],n=e.maxStreamingBitrate(),o={};return o.MaxStreamingBitrate=n,o.MaxStaticBitrate=4e7,o.MusicStreamingTranscodingBitrate=Math.min(n,192e3),o.DirectPlayProfiles=[],o.DirectPlayProfiles.push({Container:"mp4,m4v",Type:"Video",VideoCodec:"h264",AudioCodec:"aac,mp3,ac3"}),o.DirectPlayProfiles.push({Container:"mov",Type:"Video"}),o.DirectPlayProfiles.push({Container:"mp3",Type:"Audio"}),o.DirectPlayProfiles.push({Container:"aac",Type:"Audio"}),o.TranscodingProfiles=[],o.TranscodingProfiles.push({Container:"mp3",Type:"Audio",AudioCodec:"mp3",Context:"Streaming",Protocol:"http"}),m.canPlayHls()&&o.TranscodingProfiles.push({Container:"ts",Type:"Video",AudioCodec:"aac",VideoCodec:"h264",Context:"Streaming",Protocol:"hls"}),o.TranscodingProfiles.push({Container:"mp4",Type:"Video",AudioCodec:"aac",VideoCodec:"h264",Context:"Streaming",Protocol:"http"}),o.ContainerProfiles=[],o.CodecProfiles=[],o.CodecProfiles.push({Type:"Audio",Conditions:[{Condition:"LessThanEqual",Property:"AudioChannels",Value:"2"}]}),o.CodecProfiles.push({Type:"VideoAudio",Codec:"aac,mp3",Conditions:[{Condition:"LessThanEqual",Property:"AudioChannels",Value:"6"}]}),o.CodecProfiles.push({Type:"Video",Codec:"h264",Conditions:[{Condition:"NotEquals",Property:"IsAnamorphic",Value:"true",IsRequired:!1},{Condition:"EqualsAny",Property:"VideoProfile",Value:"high|main|baseline|constrained baseline"},{Condition:"LessThanEqual",Property:"VideoLevel",Value:"41"},{Condition:"LessThanEqual",Property:"Width",Value:t.maxWidth}]}),o.SubtitleProfiles=[],o.ResponseProfiles=[],o.ResponseProfiles.push({Type:"Video",Container:"m4v",MimeType:"video/mp4"}),o},m.getTargets=function(){return ConnectSDKHelper.getDeviceList().filter(function(e){return l(e)}).map(a)},m.seek=function(e){e=parseInt(e),e/=1e7},m.setAudioStreamIndex=function(){},m.setSubtitleStreamIndex=function(){},m.nextTrack=function(){},m.previousTrack=function(){},m.beginPlayerUpdates=function(){},m.endPlayerUpdates=function(){},m.volumeDown=function(){p&&p.getVolumeControl().volumeDown()},m.volumeUp=function(){p&&p.getVolumeControl().volumeUp()},m.setVolume=function(e){e=Math.min(e,100),e=Math.max(e,0),p&&p.getVolumeControl().setVolume(e/100)},m.getPlayerState=function(){var e=$.Deferred(),t=m.getPlayerStateInternal();return e.resolveWith(null,[t]),e.promise()},m.lastPlayerData={},m.getPlayerStateInternal=function(e){return e=e||m.lastPlayerData,m.lastPlayerData=e,Logger.log(JSON.stringify(e)),e},m.tryPair=function(e){var t=$.Deferred(),n=ConnectSDKHelper.getDeviceList().filter(function(t){return t.getId()==e.id})[0];return n?m.tryPairWithDevice(n,t):t.reject(),t.promise()},m.tryPairWithDevice=function(e){Logger.log("Will attempt to connect to Connect Device"),e.on("disconnect",function(){e.off("ready"),e.off("disconnect")}),e.isReady()?(Logger.log("Device is already ready, calling onDeviceReady"),d(e)):(Logger.log("Binding device ready handler"),e.on("ready",function(){Logger.log("device.ready fired"),d(e)}),Logger.log("Calling device.connect"),e.connect())},Events.on(MediaController,"playerchange",function(e,t,n){p&&n.id!=f&&p&&(Logger.log("Disconnecting from connect device"),s(),p=null,f=null,y=null)}),document.addEventListener("resume",g,!1)}MediaController.registerPlayer(new t)});