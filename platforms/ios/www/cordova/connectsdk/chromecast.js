define(["appSettings"],function(e){function t(){function t(t){t=Object.assign(t,{userId:Dashboard.getCurrentUserId(),deviceId:ApiClient.deviceId(),accessToken:ApiClient.accessToken(),serverAddress:ApiClient.serverAddress(),receiverName:D.getFriendlyName()});var a=e.maxChromecastBitrate();a&&(t.maxBitrate=a),require(["chromecasthelpers"],function(e){e.getServerAddress(ApiClient).then(function(e){t.serverAddress=e,n(t)})})}function n(e){b.sendText(JSON.stringify(e))}function a(){var e={};return e.playerName=x,e.playableMediaTypes=["Audio","Video"],e.isLocalPlayer=!1,e.appName=x,e.supportedCommands=["VolumeUp","VolumeDown","Mute","Unmute","ToggleMute","SetVolume","SetAudioStreamIndex","SetSubtitleStreamIndex","DisplayContent","SetRepeatMode","EndSession"],e}function o(e){var t=a();return t.name=t.deviceName=e.getFriendlyName(),t.id=e.getId(),t}function i(e){e=(e||"").toLowerCase();var t=[];return t.push("nexusplayer"),t.filter(function(t){return-1!=e.replace(" ","").indexOf(t)}).length>0}function r(){return ConnectSDKHelper.getDeviceList().filter(function(e){return e.hasService(ConnectSDK.Services.Chromecast)||i(e.getModelName())||i(e.getFriendlyName())})}function s(){var e=M.lastPlayerData||{};return e=e.PlayState||{},null==e.VolumeLevel?100:e.VolumeLevel}function u(e){if("playbackerror"==e.type){var t=e.data;setTimeout(function(){Dashboard.alert({message:Globalize.translate("MessagePlaybackError"+t),title:Globalize.translate("HeaderPlaybackError")})},300)}else"connectionerror"==e.type?setTimeout(function(){Dashboard.alert({message:Globalize.translate("MessageChromecastConnectionError"),title:Globalize.translate("HeaderError")})},300):e.type&&0==e.type.indexOf("playback")&&Events.trigger(k,e.type,[e.data])}function c(e){u("string"==typeof e?JSON.parse(e):e)}function l(){}function d(e,t){b=e,e.setWebAppSessionListener(),D=t,A=t.getId(),M.lastPlayerData={},MediaController.setActivePlayer(x,o(t)),f()}function m(e,t,n){var a=t.acquire();a.on("message",c),a.on("disconnect",l),n||browserInfo.safari?a.connect().success(function(){d(a,e)}).error(p):d(a,e)}function f(){t({options:{},command:"Identify"})}function p(){y()}function y(){var e=b;e&&(e.off("message"),e.off("disconnect"),e.disconnect(),e.release(),b=null),M.lastPlayerData={}}function g(e){e.getWebAppLauncher().launchWebApp(T).success(function(t){m(e,t,!0)}).error(function(e){})}function v(e,t,n){e.getWebAppLauncher().joinWebApp(T).success(function(t){m(e,t,!1)}).error(function(a){return t?void v(e,!1,!0):void(n&&g(e))})}function h(e){b&&y(),v(e,!1,!0)}function I(e){e.off("ready"),M.lastPlayerData={},h(e)}function P(e,t){var n=b;n&&n.close();var a=D;a&&(e&&a.getWebAppLauncher().closeWebApp(T),a.disconnect()),y(),D=null,t||(A=null)}function S(e,t){var n=r().filter(function(t){return t.getId()==e})[0];n?M.tryPair({id:e}):t&&setTimeout(function(){S(e,!1)},2e3)}function C(){var e=A;e&&setTimeout(function(){S(e,!0)},0)}var b,D,A,M=this,x="Chromecast",T="2D4B1DA3";M.name=x,M.getItemsForPlayback=function(e){var t=Dashboard.getCurrentUserId();return e.Ids&&1==e.Ids.split(",").length?new Promise(function(n){ApiClient.getItem(t,e.Ids.split(",")).then(function(e){n({Items:[e],TotalRecordCount:1})})}):(e.Limit=e.Limit||100,e.ExcludeLocationTypes="Virtual",ApiClient.getItems(t,e))};var k={};Events.on(k,"playbackstart",function(e,t){var n=M.getPlayerStateInternal(t);Events.trigger(M,"playbackstart",[n])}),Events.on(k,"playbackstop",function(e,t){var n=M.getPlayerStateInternal(t);Events.trigger(M,"playbackstop",[n]),M.lastPlayerData={}}),Events.on(k,"playbackprogress",function(e,t){var n=M.getPlayerStateInternal(t);Events.trigger(M,"positionchange",[n])}),M.play=function(e){Dashboard.getCurrentUser().then(function(){e.items?M.playWithCommand(e,"PlayNow"):M.getItemsForPlayback({Ids:e.ids.join(",")}).then(function(t){e.items=t.Items,M.playWithCommand(e,"PlayNow")})})},M.playWithCommand=function(e,n){return e.items?(e.items=e.items.map(function(e){return{Id:e.Id,Name:e.Name,Type:e.Type,MediaType:e.MediaType,IsFolder:e.IsFolder}}),void t({options:e,command:n})):void ApiClient.getItem(Dashboard.getCurrentUserId(),e.ids[0]).then(function(t){e.items=[t],M.playWithCommand(e,n)})},M.unpause=function(){t({command:"Unpause"})},M.pause=function(){t({command:"Pause"})},M.shuffle=function(e){var t=Dashboard.getCurrentUserId();ApiClient.getItem(t,e).then(function(e){M.playWithCommand({items:[e]},"Shuffle")})},M.instantMix=function(e){var t=Dashboard.getCurrentUserId();ApiClient.getItem(t,e).then(function(e){M.playWithCommand({items:[e]},"InstantMix")})},M.canQueueMediaType=function(e){return"Audio"==e},M.queue=function(e){M.playWithCommnd(e,"PlayLast")},M.queueNext=function(e){M.playWithCommand(e,"PlayNext")},M.stop=function(){t({command:"Stop"})},M.displayContent=function(e){t({options:e,command:"DisplayContent"})},M.mute=function(){t({command:"Mute"})},M.unMute=function(){M.setVolume(s()+2)},M.toggleMute=function(){var e=M.lastPlayerData||{};e=e.PlayState||{},e.IsMuted?M.unMute():M.mute()},M.getTargets=function(){return new Promise(function(e){e(r().map(o))})},M.seek=function(e){e=parseInt(e),e/=1e7,t({options:{position:e},command:"Seek"})},M.setAudioStreamIndex=function(e){t({options:{index:e},command:"SetAudioStreamIndex"})},M.setSubtitleStreamIndex=function(e){t({options:{index:e},command:"SetSubtitleStreamIndex"})},M.nextTrack=function(){t({options:{},command:"NextTrack"})},M.previousTrack=function(){t({options:{},command:"PreviousTrack"})},M.beginPlayerUpdates=function(){},M.endPlayerUpdates=function(){},M.volumeDown=function(){t({options:{},command:"VolumeDown"})},M.setRepeatMode=function(e){t({options:{RepeatMode:e},command:"SetRepeatMode"})},M.volumeUp=function(){t({options:{},command:"VolumeUp"})},M.setVolume=function(e){e=Math.min(e,100),e=Math.max(e,0),t({options:{volume:e},command:"SetVolume"})},M.getPlayerState=function(){return new Promise(function(e){var t=M.getPlayerStateInternal();e(t)})},M.lastPlayerData={},M.getPlayerStateInternal=function(e){return e=e||M.lastPlayerData,M.lastPlayerData=e,e},M.tryPair=function(e){return new Promise(function(t,n){var a=r().filter(function(t){return t.getId()==e.id})[0];a?M.tryPairWithDevice(a,t,n):n()})},M.tryPairWithDevice=function(e){e.on("disconnect",function(){e.off("ready"),e.off("disconnect")}),e.isReady()?I(e):(e.on("ready",function(){I(e)}),e.connect())},M.endSession=function(){M.stop(),setTimeout(function(){P(!0,!1)},1e3)},document.addEventListener("resume",C,!1)}MediaController.registerPlayer(new t)});