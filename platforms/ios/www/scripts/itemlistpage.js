define(["libraryBrowser","alphaPicker","listView","cardBuilder","emby-itemscontainer"],function(e,t,r,a){return function(i,n){function o(){var t=f;if(!t){t=f={query:{SortBy:"IsFolder,SortName",SortOrder:"Ascending",Fields:"DateCreated,PrimaryImageAspectRatio,MediaSourceCount",ImageTypeLimit:1,EnableImageTypes:"Primary,Backdrop,Banner,Thumb",StartIndex:0,Limit:e.getDefaultPageSize()}},t.query.Filters="",t.query.NameStartsWithOrGreater="";var r=s();t.view=e.getSavedView(r)||"Poster",t.query.ParentId=n.parentId||null,e.loadSavedQueryValues(r,t.query)}return t}function l(){return o().query}function s(){return i.savedQueryKey||(i.savedQueryKey=e.getSavedQueryKey("itemsv1")),i.savedQueryKey}function d(){var e=o(i).view,t=i.querySelector("#items");"List"==e?(t.classList.add("vertical-list"),t.classList.remove("vertical-wrap")):(t.classList.remove("vertical-list"),t.classList.add("vertical-wrap"),t.classList.add("centered")),t.innerHTML=""}function u(){Dashboard.showLoadingMsg();var t=l(),s=Dashboard.getCurrentUserId(),d=t.ParentId?ApiClient.getItem(s,t.ParentId):ApiClient.getRootFolder(s),c=ApiClient.getItems(s,t);Promise.all([d,c]).then(function(l){function s(){t.StartIndex+=t.Limit,u(i)}function d(){t.StartIndex-=t.Limit,u(i)}var c=l[0];y=c;var m=l[1];window.scrollTo(0,0);var f=o(i).view,g="",h=e.getQueryPagingHtml({startIndex:t.StartIndex,limit:t.Limit,totalRecordCount:m.TotalRecordCount,showLimit:!1,addLayoutButton:!1,currentLayout:f,sortButton:!1,filterButton:!1});v();var p=n.context,S={items:m.Items,shape:"auto",centerText:!0,lazy:!0,coverImage:"PhotoAlbum"==c.Type,context:"folders"};"PosterCard"==f?(S.showTitle=!0,S.showYear=!0,S.cardLayout=!0,S.centerText=!1,g=a.getCardsHtml(S)):"List"==f?g=r.getListViewHtml({items:m.Items,sortBy:t.SortBy}):"Thumb"==f?(S.preferThumb=!0,S.showTitle=!0,S.shape="backdrop",S.centerText=!0,S.overlayText=!1,S.overlayMoreButton=!0,g=a.getCardsHtml(S)):(S.showTitle="photos"==p?"auto":!0,S.overlayText="photos"==p,S.overlayMoreButton=!0,g=a.getCardsHtml(S)),"boxsets"==y.CollectionType?(i.querySelector(".btnNewCollection").classList.remove("hide"),m.Items.length||(g='<p style="text-align:center;">'+Globalize.translate("MessageNoCollectionsAvailable")+"</p>")):i.querySelector(".btnNewCollection").classList.add("hide");var b=i.querySelector("#items");b.innerHTML=g,ImageLoader.lazyChildren(b);var L,w,I=i.querySelectorAll(".paging");for(L=0,w=I.length;w>L;L++)I[L].innerHTML=h;for(I=i.querySelectorAll(".btnNextPage"),L=0,w=I.length;w>L;L++)I[L].addEventListener("click",s);for(I=i.querySelectorAll(".btnPreviousPage"),L=0,w=I.length;w>L;L++)I[L].addEventListener("click",d);e.saveQueryValues(n.parentId,t);var P=c.Name;null!=c.IndexNumber&&(P=c.IndexNumber+" - "+P),null!=c.ParentIndexNumber&&(P=c.ParentIndexNumber+"."+P),LibraryMenu.setTitle(P),i.dispatchEvent(new CustomEvent("displayingitem",{detail:{item:c},bubbles:!0})),Dashboard.hideLoadingMsg()})}function c(){require(["components/filterdialog/filterdialog"],function(e){var t=new e({query:l()});Events.on(t,"filterchange",function(){u()}),t.show()})}function m(e,t){for(;!e.classList||!e.classList.contains(t);)if(e=e.parentNode,!e)return null;return e}function v(){var e=l();self.alphaPicker.value(e.NameStartsWithOrGreater)}var y,f,g=i.querySelector(".alphaPicker");g.addEventListener("alphavaluechanged",function(e){var t=e.detail.value,r=l();r.NameStartsWithOrGreater=t,r.StartIndex=0,u(i)}),self.alphaPicker=new t({element:g,valueChangeEvent:"click"}),i.addEventListener("click",function(t){var r=m(t.target,"mediaItem");if(r){var a=l(),n=e.getListItemInfo(r);if("Photo"==n.mediaType)return require(["scripts/photos"],function(){Photos.startSlideshow(i,a,n.id)}),t.preventDefault(),!1}});var h=i.querySelector(".btnSelectView");h.addEventListener("click",function(t){e.showLayoutMenu(t.target,o().view,"List,Poster,PosterCard,Thumb".split(","))}),h.addEventListener("layoutchange",function(t){var r=t.detail.viewStyle;o().view=r,e.saveViewSetting(s(),r),d(),u(i)}),d(),i.querySelector(".btnFilter").addEventListener("click",function(){c()}),i.querySelector(".btnSort").addEventListener("click",function(){e.showSortMenu({items:[{name:Globalize.translate("OptionNameSort"),id:"IsFolder,SortName"},{name:Globalize.translate("OptionCommunityRating"),id:"CommunityRating,SortName"},{name:Globalize.translate("OptionCriticRating"),id:"CriticRating,SortName"},{name:Globalize.translate("OptionDateAdded"),id:"DateCreated,SortName"},{name:Globalize.translate("OptionDatePlayed"),id:"DatePlayed,SortName"},{name:Globalize.translate("OptionParentalRating"),id:"OfficialRating,SortName"},{name:Globalize.translate("OptionPlayCount"),id:"PlayCount,SortName"},{name:Globalize.translate("OptionReleaseDate"),id:"PremiereDate,SortName"},{name:Globalize.translate("OptionRuntime"),id:"Runtime,SortName"}],callback:function(){u(i)},query:l()})}),i.querySelector(".btnNewCollection").addEventListener("click",function(){require(["collectionEditor"],function(e){var t=ApiClient.serverInfo().Id;(new e).show({items:[],serverId:t})})}),i.addEventListener("viewbeforeshow",function(){u(i),v(),LibraryMenu.setBackButtonVisible(n.context)}),i.addEventListener("viewdestroy",function(){self.alphaPicker&&self.alphaPicker.destroy()})}});