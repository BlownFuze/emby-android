define(["libraryBrowser","alphaPicker"],function(e,t){return function(r,a){function n(){var t=m;if(!t){t=m={query:{SortBy:"IsFolder,SortName",SortOrder:"Ascending",Fields:"DateCreated,PrimaryImageAspectRatio,MediaSourceCount,SyncInfo",ImageTypeLimit:1,EnableImageTypes:"Primary,Backdrop,Banner,Thumb",StartIndex:0,Limit:e.getDefaultPageSize()}},t.query.Filters="",t.query.NameStartsWithOrGreater="";var r=o();t.view=e.getSavedView(r)||e.getDefaultItemsView("Poster","Poster"),t.query.ParentId=a.parentId||null,e.loadSavedQueryValues(r,t.query)}return t}function i(){return n().query}function o(){return r.savedQueryKey||(r.savedQueryKey=e.getSavedQueryKey("itemsv1")),r.savedQueryKey}function l(){Dashboard.showLoadingMsg();var t=i(),o=Dashboard.getCurrentUserId(),s=t.ParentId?ApiClient.getItem(o,t.ParentId):ApiClient.getRootFolder(o),u=ApiClient.getItems(o,t);Promise.all([s,u]).then(function(i){function o(){t.StartIndex+=t.Limit,l(r)}function s(){t.StartIndex-=t.Limit,l(r)}var u=i[0];c=u;var m=i[1];window.scrollTo(0,0);var v=n(r).view,y="",g=e.getQueryPagingHtml({startIndex:t.StartIndex,limit:t.Limit,totalRecordCount:m.TotalRecordCount,showLimit:!1,addLayoutButton:!1,currentLayout:v,sortButton:!1,filterButton:!1});r.querySelector(".paging").innerHTML=g,d();var f=a.context,h={items:m.Items,shape:"auto",centerText:!0,lazy:!0,coverImage:"PhotoAlbum"==u.Type};"Backdrop"==v?(h.shape="backdrop",h.showTitle=!0,h.preferBackdrop=!0,y=e.getPosterViewHtml(h)):"PosterCard"==v?(h.showTitle=!0,h.showYear=!0,h.cardLayout=!0,h.centerText=!1,y=e.getPosterViewHtml(h)):"Thumb"==v?(h.preferThumb=!0,h.shape="backdrop",y=e.getPosterViewHtml(h)):(h.showTitle="photos"==f?"auto":!0,h.overlayText="photos"==f,y=e.getPosterViewHtml(h)),"boxsets"==c.CollectionType?(r.querySelector(".btnNewCollection").classList.remove("hide"),m.Items.length||(y='<p style="text-align:center;">'+Globalize.translate("MessageNoCollectionsAvailable")+"</p>")):r.querySelector(".btnNewCollection").classList.add("hide");var p=r.querySelector("#items");p.innerHTML=y+g,ImageLoader.lazyChildren(p);var S,b,w=r.querySelectorAll(".paging");for(S=0,b=w.length;b>S;S++)w[S].innerHTML=g;for(w=r.querySelectorAll(".btnNextPage"),S=0,b=w.length;b>S;S++)w[S].addEventListener("click",o);for(w=r.querySelectorAll(".btnPreviousPage"),S=0,b=w.length;b>S;S++)w[S].addEventListener("click",s);e.saveQueryValues(a.parentId,t);var P=u.Name;null!=u.IndexNumber&&(P=u.IndexNumber+" - "+P),null!=u.ParentIndexNumber&&(P=u.ParentIndexNumber+"."+P),LibraryMenu.setTitle(P),r.dispatchEvent(new CustomEvent("displayingitem",{detail:{item:u},bubbles:!0})),Dashboard.hideLoadingMsg()})}function s(){require(["components/filterdialog/filterdialog"],function(e){var t=new e({query:i()});Events.on(t,"filterchange",function(){l()}),t.show()})}function u(e,t){for(;!e.classList||!e.classList.contains(t);)if(e=e.parentNode,!e)return null;return e}function d(){var e=i();self.alphaPicker.value(e.NameStartsWithOrGreater)}var c,m,v=r.querySelector(".alphaPicker");v.addEventListener("alphavaluechanged",function(e){var t=e.detail.value,a=i();a.NameStartsWithOrGreater=t,a.StartIndex=0,l(r)}),self.alphaPicker=new t({element:v,valueChangeEvent:"click"}),r.addEventListener("click",function(t){var a=u(t.target,"mediaItem");if(a){var n=i(),o=e.getListItemInfo(a);if("Photo"==o.mediaType)return require(["scripts/photos"],function(){Photos.startSlideshow(r,n,o.id)}),t.preventDefault(),!1}});var y=r.querySelector(".btnSelectView");y.addEventListener("click",function(t){e.showLayoutMenu(t.target,n().view,"Poster,PosterCard,Thumb".split(","))}),y.addEventListener("layoutchange",function(t){var a=t.detail.viewStyle;n().view=a,e.saveViewSetting(o(),a),l(r)}),r.querySelector(".btnFilter").addEventListener("click",function(){s()}),r.querySelector(".btnSort").addEventListener("click",function(){e.showSortMenu({items:[{name:Globalize.translate("OptionNameSort"),id:"IsFolder,SortName"},{name:Globalize.translate("OptionCommunityRating"),id:"CommunityRating,SortName"},{name:Globalize.translate("OptionCriticRating"),id:"CriticRating,SortName"},{name:Globalize.translate("OptionDateAdded"),id:"DateCreated,SortName"},{name:Globalize.translate("OptionDatePlayed"),id:"DatePlayed,SortName"},{name:Globalize.translate("OptionParentalRating"),id:"OfficialRating,SortName"},{name:Globalize.translate("OptionPlayCount"),id:"PlayCount,SortName"},{name:Globalize.translate("OptionReleaseDate"),id:"PremiereDate,SortName"},{name:Globalize.translate("OptionRuntime"),id:"Runtime,SortName"}],callback:function(){l(r)},query:i()})}),r.querySelector(".btnNewCollection").addEventListener("click",function(){require(["collectionEditor"],function(e){var t=ApiClient.serverInfo().Id;(new e).show({items:[],serverId:t})})}),r.addEventListener("viewbeforeshow",function(){l(r),d(),LibraryMenu.setBackButtonVisible(a.context)}),r.addEventListener("viewdestroy",function(){self.alphaPicker&&self.alphaPicker.destroy()})}});