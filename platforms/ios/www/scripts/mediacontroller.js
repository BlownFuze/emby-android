define(["appStorage"],function(e){function t(e){var t=e.item;MediaController.getCurrentPlayer().displayContent({ItemName:t.Name,ItemId:t.Id,ItemType:t.Type,Context:e.context})}function n(e){if(e=e||f,e&&MediaController.enableDisplayMirroring()){var n=MediaController.getPlayerInfo();n.isLocalPlayer||-1==n.supportedCommands.indexOf("DisplayContent")||t(e)}}function a(e){Events.on(e,"playbackstart",function(e,t){var n={QueueableMediaTypes:t.NowPlayingItem.MediaType,ItemId:t.NowPlayingItem.Id,NowPlayingItem:t.NowPlayingItem};n=Object.assign(n,t.PlayState),ApiClient.reportPlaybackStart(n)}),Events.on(e,"playbackstop",function(e,t){var n={itemId:t.NowPlayingItem.Id,mediaSourceId:t.PlayState.MediaSourceId,positionTicks:t.PlayState.PositionTicks};t.PlayState.LiveStreamId&&(n.LiveStreamId=t.PlayState.LiveStreamId),t.PlayState.PlaySessionId&&(n.PlaySessionId=t.PlayState.PlaySessionId),ApiClient.reportPlaybackStopped(n)})}function r(e,t){var a=MediaController.getPlayerInfo();return a.isLocalPlayer?(Dashboard.showLoadingMsg(),void MediaController.getTargets().then(function(r){var i=r.map(function(e){var t=e.name;return e.appName&&e.appName!=e.name&&(t+=" - "+e.appName),{name:t,id:e.id,selected:a.id==e.id}});require(["actionsheet"],function(a){Dashboard.hideLoadingMsg(),a.show({title:Globalize.translate("HeaderSelectPlayer"),items:i,positionTo:e,enableHistory:t!==!1,callback:function(e){var t=r.filter(function(t){return t.id==e})[0];MediaController.trySetActivePlayer(t.playerName,t),n()}})})})):void i(a)}function i(e){require(["dialogHelper","emby-checkbox","emby-button"],function(t){o(t,e)})}function o(e,t){var n="",a={removeOnClose:!0};a.modal=!1,a.entryAnimationDuration=160,a.exitAnimationDuration=160,a.autoFocus=!1;var r=e.createDialog(a);if(n+="<h2>",n+=t.deviceName||t.name,n+="</h2>",n+='<div style="padding:0 2em;">',-1!=t.supportedCommands.indexOf("DisplayContent")){n+='<label class="checkboxContainer" style="margin-bottom:0;">';var i=MediaController.enableDisplayMirroring()?" checked":"";n+='<input type="checkbox" is="emby-checkbox" class="chkMirror"'+i+"/>",n+="<span>"+Globalize.translate("OptionEnableDisplayMirroring")+"</span>",n+="</label>"}n+="</div>",n+='<div class="buttons">',screen.availWidth>=600&&(n+='<button is="emby-button" type="button" class="btnRemoteControl">'+Globalize.translate("ButtonRemoteControl")+"</button>"),n+='<button is="emby-button" type="button" class="btnDisconnect">'+Globalize.translate("ButtonDisconnect")+"</button>",n+='<button is="emby-button" type="button" class="btnCancel">'+Globalize.translate("ButtonCancel")+"</button>",n+="</div>",r.innerHTML=n,document.body.appendChild(r);var o=r.querySelector(".chkMirror");o&&o.addEventListener("change",l);var s="",u=r.querySelector(".btnRemoteControl");u&&u.addEventListener("click",function(){s="nowplaying.html",e.close(r)}),r.querySelector(".btnDisconnect").addEventListener("click",function(){MediaController.disconnectFromPlayer(),e.close(r)}),r.querySelector(".btnCancel").addEventListener("click",function(){e.close(r)}),e.open(r).then(function(){s&&Dashboard.navigate(s)})}function l(){MediaController.enableDisplayMirroring(this.checked)}function s(e){var t=this,n={};t.keyBinding=function(e){a()||n[e.keyCode]&&(e.preventDefault(),n[e.keyCode](e))},t.keyPrevent=function(e){if(!a()){var t=[32,38,40,37,39,81,77,65,84,83,70];-1!=t.indexOf(e.keyCode)&&e.preventDefault()}},n[32]=function(){var t=e.getCurrentPlayer();t.getPlayerState().then(function(e){var n=e;n.NowPlayingItem&&n.PlayState&&(n.PlayState.IsPaused?t.unpause():t.pause())})};var a=function(){var e=document.activeElement,t=e.type||e.tagName.toLowerCase();return"text"===t||"select"===t||"textarea"===t||"password"==t}}function u(){function t(e,t){Events.trigger(v,"beforeplaybackstart",[t,this])}function i(e,t){Events.trigger(v,"playbackstop",[t,this])}function o(e,t,n){Events.trigger(v,"playerchange",[e,t,n])}function l(e,t){return e.isLocalPlayer?void requirejs(["registrationservices"],function(){v.playbackTimeLimitMs=null,RegistrationServices.validateFeature("playback").then(t,function(){v.playbackTimeLimitMs=M,u(),t()})}):void t()}function u(){d(),S=setTimeout(c,M)}function c(){d(),MediaController.stop()}function d(){var e=S;e&&(clearTimeout(e),S=null)}function y(e,t,n,a){return a.SupportsDirectPlay=!0,{MediaSources:[a],PlaySessionId:(new Date).getTime().toString()}}function f(e,t,n,a,r,i,o,l,s){v.getPlaybackInfoInternal(e,t,n,a,r,i,o).then(l,s)}var m,g,v=this,b=[],P=new s(v);window.addEventListener("keydown",P.keyBinding),window.addEventListener("keypress",P.keyPrevent),window.addEventListener("keyup",P.keyPrevent),v.registerPlayer=function(e){b.push(e),e.isLocalPlayer&&a(e),Events.on(e,"playbackstop",i),Events.on(e,"beforeplaybackstart",t)},v.getPlayerInfo=function(){var e=m||{},t=g||{};return{name:e.name,isLocalPlayer:e.isLocalPlayer,id:t.id,deviceName:t.deviceName,playableMediaTypes:t.playableMediaTypes,supportedCommands:t.supportedCommands}},v.setActivePlayer=function(e,t){if("string"==typeof e&&(e=b.filter(function(t){return t.name==e})[0]),!e)throw new Error("null player");var n=m;I=null,m=e,g=t,o(e,t,n)};var I=null;v.trySetActivePlayer=function(e,t){if("string"==typeof e&&(e=b.filter(function(t){return t.name==e})[0]),!e)throw new Error("null player");I!=t.id&&(I=t.id,e.tryPair(t).then(function(){var n=m;m=e,g=t,o(e,t,n)}))},v.trySetActiveDeviceName=function(e){function t(e){return e.toLowerCase().replace(" ","")}e=t(e),v.getTargets().then(function(n){var a=n.filter(function(n){return t(n.name)==e})[0];a&&v.trySetActivePlayer(a.playerName,a)})},v.setDefaultPlayerActive=function(){var e=v.getDefaultPlayer();e.getTargets().then(function(t){v.setActivePlayer(e,t[0])})},v.removeActivePlayer=function(e){v.getPlayerInfo().name==e&&v.setDefaultPlayerActive()},v.removeActiveTarget=function(e){v.getPlayerInfo().id==e&&v.setDefaultPlayerActive()},v.disconnectFromPlayer=function(){var e=v.getPlayerInfo();if(-1!=e.supportedCommands.indexOf("EndSession")){var t=[];t.push({name:Globalize.translate("ButtonYes"),id:"yes"}),t.push({name:Globalize.translate("ButtonNo"),id:"no"}),t.push({name:Globalize.translate("ButtonCancel"),id:"cancel"}),require(["actionsheet"],function(e){e.show({items:t,title:Globalize.translate("ConfirmEndPlayerSession"),callback:function(e){switch(e){case"yes":MediaController.getCurrentPlayer().endSession(),v.setDefaultPlayerActive();break;case"no":v.setDefaultPlayerActive()}}})})}else v.setDefaultPlayerActive()},v.getPlayers=function(){return b},v.getTargets=function(){var e=b.map(function(e){return e.getTargets()});return Promise.all(e).then(function(e){for(var t=[],n=0;n<e.length;n++)for(var a=e[n],r=0;r<a.length;r++)t.push(a[r]);return t=t.sort(function(e,t){var n=e.isLocalPlayer?0:1,a=t.isLocalPlayer?0:1;return n=n.toString()+e.name,a=a.toString()+t.name,n.localeCompare(a)})})};var S,M=6e4;v.toggleDisplayMirroring=function(){v.enableDisplayMirroring(!v.enableDisplayMirroring())},v.enableDisplayMirroring=function(t){if(null!=t){var a=t?"1":"0";return e.setItem("displaymirror--"+Dashboard.getCurrentUserId(),a),void(t&&n())}return"0"!=(e.getItem("displaymirror--"+Dashboard.getCurrentUserId())||"")},v.play=function(e){l(m,function(){"string"==typeof e&&(e={ids:[e]}),m.play(e)})},v.shuffle=function(e){e.Id&&(e=e.Id),l(m,function(){m.shuffle(e)})},v.instantMix=function(e){e.Id&&(e=e.Id),l(m,function(){m.instantMix(e)})},v.queue=function(e){"string"==typeof e&&(e={ids:[e]}),m.queue(e)},v.queueNext=function(e){"string"==typeof e&&(e={ids:[e]}),m.queueNext(e)},v.canPlay=function(e){return"Program"==e.Type?(new Date).getTime()>p.parseISO8601Date(e.EndDate).getTime()||(new Date).getTime()<p.parseISO8601Date(e.StartDate).getTime()?!1:!0:v.canPlayByAttributes(e.Type,e.MediaType,e.PlayAccess,e.LocationType)},v.canPlayByAttributes=function(e,t,n,a){return"Full"!=n?!1:"Virtual"==a?!1:"Program"==e?!1:"MusicGenre"==e||"Season"==e||"Series"==e||"BoxSet"==e||"MusicAlbum"==e||"MusicArtist"==e||"Playlist"==e?!0:-1!=v.getPlayerInfo().playableMediaTypes.indexOf(t)},v.canQueueMediaType=function(e,t){return("MusicAlbum"==t||"MusicArtist"==t||"MusicGenre"==t)&&(e="Audio"),m.canQueueMediaType(e)},v.getLocalPlayer=function(){return m.isLocalPlayer?m:b.filter(function(e){return e.isLocalPlayer})[0]},v.getDefaultPlayer=function(){return m.isLocalPlayer?m:b.filter(function(e){return e.isDefaultPlayer})[0]},v.getCurrentPlayer=function(){return m},v.pause=function(){m.pause()},v.stop=function(){m.stop()},v.unpause=function(){m.unpause()},v.seek=function(e){m.seek(e)},v.currentPlaylistIndex=function(e){return null==e?m.currentPlaylistIndex?m.currentPlaylistIndex():-1:void m.currentPlaylistIndex(e)},v.removeFromPlaylist=function(e){m.removeFromPlaylist(e)},v.nextTrack=function(){m.nextTrack()},v.previousTrack=function(){m.previousTrack()},v.mute=function(){m.mute()},v.unMute=function(){m.unMute()},v.toggleMute=function(){m.toggleMute()},v.volumeDown=function(){m.volumeDown()},v.volumeUp=function(){m.volumeUp()},v.setRepeatMode=function(e){m.setRepeatMode(e)},v.playlist=function(){return m.playlist||[]},v.sendCommand=function(e,t){switch(t=t||v.getLocalPlayer(),e.Name){case"SetRepeatMode":t.setRepeatMode(e.Arguments.RepeatMode);break;case"VolumeUp":t.volumeUp();break;case"VolumeDown":t.volumeDown();break;case"Mute":t.mute();break;case"Unmute":t.unMute();break;case"ToggleMute":t.toggleMute();break;case"SetVolume":t.setVolume(e.Arguments.Volume);break;case"SetAudioStreamIndex":t.setAudioStreamIndex(parseInt(e.Arguments.Index));break;case"SetSubtitleStreamIndex":t.setSubtitleStreamIndex(parseInt(e.Arguments.Index));break;case"ToggleFullscreen":t.toggleFullscreen();break;default:t.isLocalPlayer||t.sendCommand(e)}},v.getNowPlayingNames=function(e,t){var n=e,a=null,r=e.Name;e.AlbumId&&"Audio"==e.MediaType&&(n={Id:e.AlbumId,Name:e.Album,Type:"MusicAlbum",IsFolder:!0}),"Video"==e.MediaType&&(null!=e.IndexNumber&&(r=e.IndexNumber+" - "+r),null!=e.ParentIndexNumber&&(r=e.ParentIndexNumber+"."+r));var i="";e.Artists&&e.Artists.length?e.ArtistItems&&e.ArtistItems.length?(a={Id:e.ArtistItems[0].Id,Name:e.ArtistItems[0].Name,Type:"MusicArtist",IsFolder:!0},i=a.Name):i=e.Artists[0]:e.SeriesName||e.Album?(i=r,r=e.SeriesName||e.Album,a=n,n=e.SeriesId?{Id:e.SeriesId,Name:e.SeriesName,Type:"Series",IsFolder:!0}:null):e.ProductionYear&&t!==!1&&(i=e.ProductionYear);var o=[];return o.push({text:r,item:n}),i&&o.push({text:i,item:a}),o},v.getNowPlayingNameHtml=function(e,t){var n=v.getNowPlayingNames(e,t);return n.map(function(e){return e.text}).join("<br/>")},v.showPlaybackInfoErrorMessage=function(e){require(["alert"],function(t){t({title:Globalize.translate("HeaderPlaybackError"),text:Globalize.translate("MessagePlaybackError"+e),type:"error"})})},v.getPlaybackInfo=function(e,t,n,a,r,i,o){return new Promise(function(l,s){require(["localassetmanager"],function(){var u=ApiClient.serverInfo();return u.Id?void LocalAssetManager.getLocalMediaSource(u.Id,e).then(function(u){if(u&&(!a||a.Id==u.Id)){var c=y(e,t,n,u);return void l(c)}f(e,t,n,a,r,i,o,l,s)}):void f(e,t,n,a,r,i,o,l,s)})})},v.getPlaybackInfoInternal=function(e,t,n,a,r,i,o){var l={DeviceProfile:t},s={UserId:Dashboard.getCurrentUserId(),StartTimeTicks:n||0};return null!=r&&(s.AudioStreamIndex=r),null!=i&&(s.SubtitleStreamIndex=i),a&&(s.MediaSourceId=a.Id),o&&(s.LiveStreamId=o),ApiClient.ajax({url:ApiClient.getUrl("Items/"+e+"/PlaybackInfo",s),type:"POST",data:JSON.stringify(l),contentType:"application/json",dataType:"json"})},v.getLiveStream=function(e,t,n,a,r,i,o){var l={DeviceProfile:n,OpenToken:r.OpenToken},s={UserId:Dashboard.getCurrentUserId(),StartTimeTicks:a||0,ItemId:e,PlaySessionId:t};return null!=i&&(s.AudioStreamIndex=i),null!=o&&(s.SubtitleStreamIndex=o),ApiClient.ajax({url:ApiClient.getUrl("LiveStreams/Open",s),type:"POST",data:JSON.stringify(l),contentType:"application/json",dataType:"json"})},v.supportsDirectPlay=function(e){return new Promise(function(t){if(e.SupportsDirectPlay){if("Http"==e.Protocol&&!e.RequiredHttpHeaders.length)if(e.SupportsDirectStream||e.SupportsTranscoding){var n=0==e.Path.toLowerCase().replace("https:","http").indexOf(ApiClient.serverAddress().toLowerCase().replace("https:","http").substring(0,14));t(n)}else t(!0);"File"==e.Protocol&&require(["localassetmanager"],function(){LocalAssetManager.fileExists(e.Path).then(function(e){t(e)})})}else t(!1)})},v.showPlayerSelection=r}function c(e,t){"ServerShuttingDown"===t.MessageType?MediaController.setDefaultPlayerActive():"ServerRestarting"===t.MessageType&&MediaController.setDefaultPlayerActive()}function d(e){Events.off(e,"websocketmessage",c),Events.on(e,"websocketmessage",c)}function y(){r(this)}var f,p;window.MediaController=new u,MediaController.init=function(){require(["datetime"],function(e){p=e}),window.ApiClient&&d(window.ApiClient),Events.on(ConnectionManager,"apiclientcreated",function(e,t){d(t)})},document.addEventListener("headercreated",function(){var e=document.querySelector(".viewMenuBar .btnCast");e.removeEventListener("click",y),e.addEventListener("click",y)}),pageClassOn("pagebeforeshow","page",function(){f=null}),pageClassOn("displayingitem","libraryPage",function(e){var t=e.detail;n(t)})});