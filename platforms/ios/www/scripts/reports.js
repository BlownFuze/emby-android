define(["jQuery","libraryBrowser"],function(e,t){function i(e){var t="";return t+='<table id="tblReport" data-role="table" data-mode="reflow" class="tblLibraryReport stripedTable ui-responsive table-stroke detailTable" style="display:table;">',t+="<thead>",e.Headers.map(function(e){var i='<th data-priority="persist">';e.ShowHeaderLabel&&(e.SortField&&(i+='<a class="lnkColumnSort" href="#" data-sortfield="'+e.SortField+'" style="text-decoration:underline;">'),i+=e.Name||"&nbsp;",e.SortField&&(i+="</a>",e.SortField===S&&(i+="Descending"===x.SortOrder?'<span style="font-weight:bold;margin-left:5px;vertical-align:top;font-size:14px">&darr;</span>':'<span style="font-weight:bold;margin-left:5px;vertical-align:top;font-size:14px;">&uarr;</span>'))),i+="</th>",t+=i}),t+="</thead>",t+="<tbody>",e.IsGrouped===!1?e.Rows.map(function(i){t+=a(e.Headers,i)}):e.Groups.map(function(i){t+='<tr style="background-color: rgb(51, 51, 51);">',t+='<th scope="rowgroup" colspan="'+e.Headers.length+'">'+(i.Name||"&nbsp;")+"</th>",t+="</tr>",i.Rows.map(function(i){t+=a(e.Headers,i)}),t+="<tr>",t+='<th scope="rowgroup" colspan="'+e.Headers.length+'">&nbsp;</th>',t+="</tr>"}),t+="</tbody>",t+="</table>"}function a(e,t){var i="";i+="<tr>";for(var a=0;a<e.length;a++){var s=e[a],n=t.Columns[a];i+=r(s,t,n)}return i+="</tr>"}function r(e,t,i){var a="";switch(a+="<td>",e.ItemViewType){case"None":a+=i.Name;break;case"Detail":var r=t.Id;i.Id&&(r=i.Id),a+='<a href="itemdetails.html?id='+r+'">'+i.Name+"</a>";break;case"Edit":a+='<a href="edititemmetadata.html?id='+t.Id+'">'+i.Name+"</a>";break;case"List":a+='<a href="itemlist.html?id='+t.Id+'">'+i.Name+"</a>";break;case"ItemByNameDetails":a+='<a href="itemdetails.html?id='+i.Id+"&context="+t.RowType+'">'+i.Name+"</a>";break;case"EmbeddedImage":t.HasEmbeddedImage&&(a+='<div class="libraryReportIndicator clearLibraryReportIndicator"><div class="ui-icon-check ui-btn-icon-notext"></div></div>');break;case"SubtitleImage":t.HasSubtitles&&(a+='<div class="libraryReportIndicator clearLibraryReportIndicator"><div class="ui-icon-check ui-btn-icon-notext"></div></div>');break;case"TrailersImage":t.HasLocalTrailer&&(a+='<div class="libraryReportIndicator clearLibraryReportIndicator"><div class="ui-icon-check ui-btn-icon-notext"></div></div>');break;case"SpecialsImage":t.HasSpecials&&(a+='<div class="libraryReportIndicator clearLibraryReportIndicator"><div class="ui-icon-check ui-btn-icon-notext"></div></div>');break;case"LockDataImage":t.HasLockData&&(a+='<i class="md-icon">lock</i>');break;case"TagsPrimaryImage":t.HasImageTagsPrimary||(a+='<a href="edititemimages.html?id='+t.Id+'"><img src="css/images/editor/missingprimaryimage.png" title="Missing primary image." style="width:18px"/></a>');break;case"TagsBackdropImage":t.HasImageTagsBackdrop||"Episode"!==t.RowType&&"Season"!==t.RowType&&"Audio"!==t.MediaType&&"TvChannel"!==t.RowType&&"MusicAlbum"!==t.RowType&&(a+='<a href="edititemimages.html?id='+t.Id+'"><img src="css/images/editor/missingbackdrop.png" title="Missing backdrop image." style="width:18px"/></a>');break;case"TagsLogoImage":t.HasImageTagsLogo||("Movie"===t.RowType||"Trailer"===t.RowType||"Series"===t.RowType||"MusicArtist"===t.RowType||"BoxSet"===t.RowType)&&(a+='<a href="edititemimages.html?id='+t.Id+'"><img src="css/images/editor/missinglogo.png" title="Missing logo image." style="width:18px"/></a>');break;case"UserPrimaryImage":if(t.UserId){var s=ApiClient.getUserImageUrl(t.UserId,{height:24,type:"Primary"});a+=s?'<img src="'+s+'" />':""}break;case"StatusImage":t.HasLockData&&(a+='<i class="md-icon">lock</i>'),t.HasLocalTrailer||"Movie"!==t.RowType||(a+='<i title="Missing local trailer." class="md-icon">videocam</i>'),t.HasImageTagsPrimary||(a+='<a href="edititemimages.html?id='+t.Id+'"><img src="css/images/editor/missingprimaryimage.png" title="Missing primary image." style="width:18px"/></a>'),t.HasImageTagsBackdrop||"Episode"!==t.RowType&&"Season"!==t.RowType&&"Audio"!==t.MediaType&&"TvChannel"!==t.RowType&&"MusicAlbum"!==t.RowType&&(a+='<a href="edititemimages.html?id='+t.Id+'"><img src="css/images/editor/missingbackdrop.png" title="Missing backdrop image." style="width:18px"/></a>'),t.HasImageTagsLogo||("Movie"===t.RowType||"Trailer"===t.RowType||"Series"===t.RowType||"MusicArtist"===t.RowType||"BoxSet"===t.RowType)&&(a+='<a href="edititemimages.html?id='+t.Id+'"><img src="css/images/editor/missinglogo.png" title="Missing logo image." style="width:18px"/></a>');break;default:a+=i.Name}return a+="</td>"}function s(e){var t="";return t+='<div class="detailSection" >',t+='<div class="detailSectionContent">',e.Groups.map(function(e){t+='<div class="card transparentCard bannerCard"  style="vertical-align: top;">',t+='<div class="visualCardBox">',t+='<div class="cardBox " >',t+='<div class="detailSection">',t+='<div class="detailSectionHeader">',t+="<span>"+e.Header+"&nbsp;</span>",t+="</div>",t+='<div class="detailSectionContent">',t+='<div class="childrenItemsContainer itemsContainer" style="text-align: left;">',t+='<ul class="itemsListview ui-listview" >';for(var i=e.Items.length-1,a=0;T>a;a++){if(t+='<li class="ui-li listItem ui-li-has-alt ui-first-child">',i>=a){var r=e.Items[a];t+='<a class="item ui-btn"',r.Id>""&&(t+=' href="itemdetails.html?id='+r.Id+'"'),t+=">"+r.Name+"&nbsp;</a>",t+='<a title="" class="listviewMenuButton ui-btn ui-btn-inline">'+r.Value+"&nbsp;</a>"}else t+='<a class="item ui-btn">&nbsp;</a>';t+="</li>"}t+="</ul>",t+="</div>",t+="</div>",t+="</div>",t+="</div>",t+="</div>",t+="</div>"}),t+="</div>",t+="</div>"}function n(){x.UserId=Dashboard.getCurrentUserId(),x.HasQueryLimit=!1;var e=ApiClient.getUrl("Reports/Items/Download",x);e&&(window.location.href=e)}function o(t){x.UserId=Dashboard.getCurrentUserId();var i="";i=ApiClient.getUrl("Reports/Headers",x),ApiClient.getJSON(i).then(function(i){var a="None";e("#selectReportGroup",t).find("option").remove().end(),e("#selectReportGroup",t).append('<option value="None"></option>'),i.map(function(i){if(("Screen"===i.DisplayType||"ScreenExport"===i.DisplayType)&&i.CanGroup&&i.FieldName.length>0){var r='<option value="'+i.FieldName+'">'+i.Name+"</option>";e("#selectReportGroup",t).append(r),x.GroupBy===i.FieldName&&(a=i.FieldName)}}),e("#selectPageSize",t).val(a)})}function c(a,r){window.scrollTo(0,0);var n="";"ReportData"===x.ReportView||"ReportStatistics"===x.ReportView?(e("#selectIncludeItemTypesBox",a).show(),e("#tabFilter",a).show()):(e("#selectIncludeItemTypesBox",a).hide(),e("#tabFilterBox",a).hide(),e("#tabFilter",a).hide());var o=t.getQueryPagingHtml({startIndex:x.StartIndex,limit:x.Limit,totalRecordCount:r.TotalRecordCount,updatePageSizeSetting:!1,viewButton:!0,showLimit:!1});switch("ReportData"===x.ReportView||"ReportActivities"===x.ReportView?(e(".listTopPaging",a).html(o).trigger("create"),e(".listTopPaging",a).show(),e(".listBottomPaging",a).html(o).trigger("create"),e(".listBottomPaging",a).show(),e(".btnNextPage",a).on("click",function(){x.StartIndex+=x.Limit,d(a)}),e(".btnNextPage",a).show(),e(".btnPreviousPage",a).on("click",function(){x.StartIndex-=x.Limit,d(a)}),e(".btnPreviousPage",a).show(),e("#btnReportExport",a).show(),e("#selectPageSizeBox",a).show(),e("#selectReportGroupingBox",a).show(),e("#grpReportsColumns",a).show(),n+=i(r),e(".reporContainer",a).html(n).trigger("create"),e(".lnkColumnSort",a).on("click",function(){var e=this.getAttribute("data-sortfield");x.SortBy===e?"Descending"===x.SortOrder?(x.SortOrder="Ascending",x.SortBy=S):(x.SortOrder="Descending",x.SortBy=e):(x.SortOrder="Ascending",x.SortBy=e),x.StartIndex=0,d(a)})):(e(".listTopPaging",a).html(o).trigger("create"),e(".listTopPaging",a).show(),e(".listBottomPaging",a).hide(),e(".btnNextPage",a).hide(),e(".btnPreviousPage",a).hide(),e("#btnReportExport",a).hide(),e("#selectPageSizeBox",a).hide(),e("#selectReportGroupingBox",a).hide(),e("#grpReportsColumns",a).hide(),n+=s(r),e(".reporContainer",a).html(n).trigger("create")),e("#GroupStatus",a).hide(),e("#GroupAirDays",a).hide(),e("#GroupEpisodes",a).hide(),x.IncludeItemTypes){case"Series":case"Season":e("#GroupStatus",a).show(),e("#GroupAirDays",a).show();break;case"Episode":e("#GroupStatus",a).show(),e("#GroupAirDays",a).show(),e("#GroupEpisodes",a).show()}e(".viewPanel",a).refresh}function d(e){Dashboard.showLoadingMsg(),x.UserId=Dashboard.getCurrentUserId();var t="";switch(x.ReportView){case"ReportData":x.HasQueryLimit=!0,t=ApiClient.getUrl("Reports/Items",x);break;case"ReportStatistics":x.TopItems=T,x.HasQueryLimit=!1,t=ApiClient.getUrl("Reports/Statistics",x);break;case"ReportActivities":x.HasQueryLimit=!0,t=ApiClient.getUrl("Reports/Activities",x)}ApiClient.getJSON(t).then(function(t){l(e),c(e,t)}),Dashboard.hideLoadingMsg()}function l(t){e(".chkStandardFilter",t).each(function(){var e=","+(x.Filters||""),t=this.getAttribute("data-filter");this.checked=-1!=e.indexOf(","+t)}).checkboxradio("refresh"),e(".chkVideoTypeFilter",t).each(function(){var e=","+(x.VideoTypes||""),t=this.getAttribute("data-filter");this.checked=-1!=e.indexOf(","+t)}).checkboxradio("refresh"),e(".chkStatus",t).each(function(){var e=","+(x.SeriesStatus||""),t=this.getAttribute("data-filter");this.checked=-1!=e.indexOf(","+t)}).checkboxradio("refresh"),e(".chkAirDays",t).each(function(){var e=","+(x.AirDays||""),t=this.getAttribute("data-filter");this.checked=-1!=e.indexOf(","+t)}).checkboxradio("refresh"),e("#chk3D",t).checked(1==x.Is3D).checkboxradio("refresh"),e("#chkHD",t).checked(1==x.IsHD).checkboxradio("refresh"),e("#chkSD",t).checked(0==x.IsHD).checkboxradio("refresh"),e("#chkSubtitle",t).checked(1==x.HasSubtitles).checkboxradio("refresh"),e("#chkTrailer",t).checked(1==x.HasTrailer).checkboxradio("refresh"),e("#chkMissingTrailer",t).checked(0==x.HasTrailer).checkboxradio("refresh"),e("#chkSpecialFeature",t).checked(1==x.HasSpecialFeature).checkboxradio("refresh"),e("#chkThemeSong",t).checked(1==x.HasThemeSong).checkboxradio("refresh"),e("#chkThemeVideo",t).checked(1==x.HasThemeVideo).checkboxradio("refresh"),e("#selectPageSize",t).val(x.Limit),e("#chkMissingRating",t).checked(0==x.HasOfficialRating).checkboxradio("refresh"),e("#chkMissingOverview",t).checked(0==x.HasOverview).checkboxradio("refresh"),e("#chkIsLocked",t).checked(1==x.IsLocked).checkboxradio("refresh"),e("#chkMissingImdbId",t).checked(0==x.HasImdbId).checkboxradio("refresh"),e("#chkMissingTmdbId",t).checked(0==x.HasTmdbId).checkboxradio("refresh"),e("#chkMissingTvdbId",t).checked(0==x.HasTvdbId).checkboxradio("refresh"),e("#chkSpecialEpisode",t).checked(0==x.ParentIndexNumber).checkboxradio("refresh"),e("#chkMissingEpisode",t).checked(1==x.IsMissing).checkboxradio("refresh"),e("#chkFutureEpisode",t).checked(1==x.IsUnaired).checkboxradio("refresh"),e("#selectIncludeItemTypes").val(x.IncludeItemTypes),e("#isFavorite").val(1==x.IsFavorite?"true":0==x.IsFavorite?"false":"-")}function h(e){y||(y=!0,QueryReportFilters.loadFilters(e,Dashboard.getCurrentUserId(),x,function(){d(e)}),QueryReportColumns.loadColumns(e,Dashboard.getCurrentUserId(),x,function(){d(e)}))}function u(t,i,a,r){var s;s=r.length?e(i,t).show():e(i,t).hide();var n="";n+='<div data-role="controlgroup">';var o=0,c="chk"+i.substring(1);n+=r.map(function(e){var t="",i=c+o,r=e,s=e,n=!1;return e.FieldName&&(r=e.Name,s=e.FieldName,n=e.Visible),t+='<label for="'+i+'">'+r+"</label>",t+='<input id="'+i+'" type="checkbox" data-filter="'+s+'" class="'+a+'"',n&&(t+=' checked="checked" '),t+="/>",o++,t}).join(""),n+="</div>",e(".filterOptions",s).html(n).trigger("create")}function g(e,t){t.Tags&&(t.Tags.length=Math.min(t.Tags.length,50)),u(e,".genreFilters","chkGenreFilter",t.Genres),u(e,".officialRatingFilters","chkOfficialRatingFilter",t.OfficialRatings),u(e,".tagFilters","chkTagFilter",t.Tags),u(e,".yearFilters","chkYearFilter",t.Years)}function p(e,t){t.Tags&&(t.Tags.length=Math.min(t.Tags.length,50)),u(e,".reportsColumns","chkReportColumns",t)}function m(t,i,a){e(".chkGenreFilter",t).on("change",function(){var e=this.getAttribute("data-filter"),t=i.Genres||"",r="|";t=(r+t).replace(r+e,"").substring(1),this.checked&&(t=t?t+r+e:e),i.StartIndex=0,i.Genres=t,a()}),e(".chkTagFilter",t).on("change",function(){var e=this.getAttribute("data-filter"),t=i.Tags||"",r="|";t=(r+t).replace(r+e,"").substring(1),this.checked&&(t=t?t+r+e:e),i.StartIndex=0,i.Tags=t,a()}),e(".chkYearFilter",t).on("change",function(){var e=this.getAttribute("data-filter"),t=i.Years||"",r=",";t=(r+t).replace(r+e,"").substring(1),this.checked&&(t=t?t+r+e:e),i.StartIndex=0,i.Years=t,a()}),e(".chkOfficialRatingFilter",t).on("change",function(){var e=this.getAttribute("data-filter"),t=i.OfficialRatings||"",r="|";t=(r+t).replace(r+e,"").substring(1),this.checked&&(t=t?t+r+e:e),i.StartIndex=0,i.OfficialRatings=t,a()})}function k(t,i,a){e(".chkReportColumns",t).on("change",function(){var e=this.getAttribute("data-filter"),t=i.ReportColumns||"",r="|";t=(r+t).replace(r+e,"").substring(1),this.checked&&(t=t?t+r+e:e),i.StartIndex=0,i.ReportColumns=t,a()})}function f(e,t,i,a){return ApiClient.getJSON(ApiClient.getUrl("Items/Filters",{UserId:t,ParentId:i.ParentId,IncludeItemTypes:i.IncludeItemTypes,ReportView:i.ReportView})).then(function(t){g(e,t),m(e,i,a)})}function I(e,t,i,a){return ApiClient.getJSON(ApiClient.getUrl("Reports/Headers",{UserId:t,IncludeItemTypes:i.IncludeItemTypes,ReportView:i.ReportView})).then(function(t){p(e,t);var r="",s="|";t.map(function(e){("Screen"===e.DisplayType||"ScreenExport"===e.DisplayType)&&(r=r?r+s+e.FieldName:e.FieldName)}),i.ReportColumns||(i.ReportColumns=r),k(e,i,a)})}function b(e,t){t.Genres=null,t.Years=null,t.OfficialRatings=null,t.Tags=null}function v(e,t){t.ReportColumns=null}var y,S="SortName",T=5,x={StartIndex:0,Limit:100,IncludeItemTypes:"Movie",HasQueryLimit:!0,GroupBy:"None",ReportView:"ReportData",DisplayType:"Screen"};e(document).on("pageinit","#libraryReportManagerPage",function(){var t=this;e("#selectIncludeItemTypes",t).on("change",function(){x.StartIndex=0,x.ReportView=e("#selectViewType",t).val(),x.IncludeItemTypes=this.value,x.SortOrder="Ascending",x.ReportColumns=null,e(".btnReportExport",t).hide(),y=!1,o(t),h(t),d(t)}),e("#selectViewType",t).on("change",function(){x.StartIndex=0,x.ReportView=this.value,x.IncludeItemTypes=e("#selectIncludeItemTypes",t).val(),x.SortOrder="Ascending",y=!1,x.ReportColumns=null,o(t),h(t),d(t)}),e("#selectReportGroup",t).on("change",function(){x.GroupBy=this.value,x.StartIndex=0,d(t)}),e("#btnReportExportCsv",t).on("click",function(e){x.ExportType="CSV",n(t,e)}),e("#btnReportExportExcel",t).on("click",function(e){x.ExportType="Excel",n(t,e)}),e("#btnResetReportColumns",t).on("click",function(){x.ReportColumns=null,x.StartIndex=0,y=!1,h(t),d(t)}),e(".viewPanel",t).on("panelopen",function(){h(t)}),e("#selectPageSize",t).on("change",function(){x.Limit=parseInt(this.value),x.StartIndex=0,d(t)}),e("#isFavorite",t).on("change",function(){x.IsFavorite="true"==this.value?!0:"false"==this.value?!1:null,x.StartIndex=0,d(t)}),e(".chkStandardFilter",this).on("change",function(){var e=this.getAttribute("data-filter"),i=x.Filters||"";i=(","+i).replace(","+e,"").substring(1),this.checked&&(i=i?i+","+e:e),x.StartIndex=0,x.Filters=i,d(t)}),e(".chkVideoTypeFilter",this).on("change",function(){var e=this.getAttribute("data-filter"),i=x.VideoTypes||"";i=(","+i).replace(","+e,"").substring(1),this.checked&&(i=i?i+","+e:e),x.StartIndex=0,x.VideoTypes=i,d(t)}),e("#chk3D",this).on("change",function(){x.StartIndex=0,x.Is3D=this.checked?!0:null,d(t)}),e("#chkHD",this).on("change",function(){x.StartIndex=0,x.IsHD=this.checked?!0:null,d(t)}),e("#chkSD",this).on("change",function(){x.StartIndex=0,x.IsHD=this.checked?!1:null,d(t)}),e("#chkSubtitle",this).on("change",function(){x.StartIndex=0,x.HasSubtitles=this.checked?!0:null,d(t)}),e("#chkTrailer",this).on("change",function(){x.StartIndex=0,x.HasTrailer=this.checked?!0:null,d(t)}),e("#chkMissingTrailer",this).on("change",function(){x.StartIndex=0,x.HasTrailer=this.checked?!1:null,d(t)}),e("#chkSpecialFeature",this).on("change",function(){x.StartIndex=0,x.HasSpecialFeature=this.checked?!0:null,d(t)}),e("#chkThemeSong",this).on("change",function(){x.StartIndex=0,x.HasThemeSong=this.checked?!0:null,d(t)}),e("#chkThemeVideo",this).on("change",function(){x.StartIndex=0,x.HasThemeVideo=this.checked?!0:null,d(t)}),e("#radioBasicFilters",this).on("change",function(){this.checked?(e(".basicFilters",t).show(),e(".advancedFilters",t).hide()):e(".basicFilters",t).hide()}),e("#radioAdvancedFilters",this).on("change",function(){this.checked?(e(".advancedFilters",t).show(),e(".basicFilters",t).hide()):e(".advancedFilters",t).hide()}),e("#chkIsLocked",t).on("change",function(){x.StartIndex=0,x.IsLocked=this.checked?!0:null,d(t)}),e("#chkMissingOverview",t).on("change",function(){x.StartIndex=0,x.HasOverview=this.checked?!1:null,d(t)}),e("#chkMissingEpisode",t).on("change",function(){x.StartIndex=0,x.IsMissing=this.checked?!0:!1,d(t)}),e("#chkMissingRating",t).on("change",function(){x.StartIndex=0,x.HasOfficialRating=this.checked?!1:null,d(t)}),e("#chkMissingImdbId",t).on("change",function(){x.StartIndex=0,x.HasImdbId=this.checked?!1:null,d(t)}),e("#chkMissingTmdbId",t).on("change",function(){x.StartIndex=0,x.HasTmdbId=this.checked?!1:null,d(t)}),e("#chkMissingTvdbId",t).on("change",function(){x.StartIndex=0,x.HasTvdbId=this.checked?!1:null,d(t)}),e("#chkMissingEpisode",t).on("change",function(){x.StartIndex=0,x.IsMissing=this.checked?!0:!1,d(t)}),e("#chkFutureEpisode",t).on("change",function(){x.StartIndex=0,this.checked?(x.IsUnaired=!0,x.IsVirtualUnaired=null):(x.IsUnaired=null,x.IsVirtualUnaired=!1),d(t)}),e("#chkSpecialEpisode",t).on("change",function(){x.ParentIndexNumber=this.checked?0:null,d(t)}),e(".chkAirDays",this).on("change",function(){var e=this.getAttribute("data-filter"),i=x.AirDays||"";i=(","+i).replace(","+e,"").substring(1),this.checked&&(i=i?i+","+e:e),x.AirDays=i,x.StartIndex=0,d(t)}),e(".chkStatus",this).on("change",function(){var e=this.getAttribute("data-filter"),i=x.SeriesStatus||"";i=(","+i).replace(","+e,"").substring(1),this.checked&&(i=i?i+","+e:e),x.SeriesStatus=i,x.StartIndex=0,d(t)}),e(t.getElementsByClassName("viewTabButton")).on("click",function(){var t=e(this).parents(".viewPanel");e(".viewTabButton",t).removeClass("ui-btn-active"),this.classList.add("ui-btn-active"),e(".viewTab",t).addClass("hide"),e("."+this.getAttribute("data-tab"),t).removeClass("hide")})}).on("pageshow","#libraryReportManagerPage",function(){x.UserId=Dashboard.getCurrentUserId();var t=this;x.SortOrder="Ascending",QueryReportFilters.onPageShow(t,x),QueryReportColumns.onPageShow(t,x),e("#selectIncludeItemTypes",t).val(x.IncludeItemTypes).trigger("change"),l(t),y=!1,l(this)}),window.QueryReportFilters={loadFilters:f,onPageShow:b},window.QueryReportColumns={loadColumns:I,onPageShow:v}});