define(["backdrop","appStorage"],function(e,r){function a(){return AppInfo.hasLowImageBandwidth?!1:!1}function t(){var e=Dashboard.getCurrentUserId(),t=r.getItem("enableBackdrops-"+e);return"1"==t||"0"!=t&&a()}function n(e,r,a,t){var n="backdrops2_"+r+(a||"")+(t||""),s=o[n];if(s)return s=JSON.parse(s),Promise.resolve(s);var i={SortBy:"IsFavoriteOrLiked,Random",Limit:20,Recursive:!0,IncludeItemTypes:a,ImageTypes:"Backdrop",ParentId:t};return e.getItems(Dashboard.getCurrentUserId(),i).then(function(e){var r=e.Items.map(function(e){return{Id:e.Id,tag:e.BackdropImageTags[0],ServerId:e.ServerId}});return o[n]=JSON.stringify(r),r})}function s(r,a){var t=window.ApiClient;t&&n(t,Dashboard.getCurrentUserId(),r,a).then(function(r){r.length?e.setBackdrops(r.map(function(e){return e.BackdropImageTags=[e.tag],e})):e.clear()})}var o={};pageClassOn("pagebeforeshow","page",function(){var r=this;if(!r.classList.contains("selfBackdropPage"))if(r.classList.contains("backdropPage"))if(t()){var a=r.getAttribute("data-backdroptype"),n=r.classList.contains("globalBackdropPage")?"":LibraryMenu.getTopParentId();s(a,n)}else r.classList.remove("backdropPage"),e.clear();else e.clear()})});