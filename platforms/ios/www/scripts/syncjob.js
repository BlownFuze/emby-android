define(["datetime","dom","listViewStyle","paper-icon-button-light","emby-button"],function(e,t){function n(t,n,i){var r="";r+="<div>",r+=Globalize.translate("ValueDateCreated",e.parseISO8601Date(n.DateCreated,!0).toLocaleString()),r+="</div>",r+="<br/>",r+='<div class="formFields"></div>',r+="<br/>",r+="<br/>",r+='<button is="emby-button" type="submit" class="raised submit block"><span>'+Globalize.translate("ButtonSave")+"</span></button>",t.querySelector(".syncJobForm").innerHTML=r,require(["syncDialog"],function(e){e.renderForm({elem:t.querySelector(".formFields"),dialogOptions:i,dialogOptionsFn:a(i),showName:!0,readOnlySyncTarget:!0}).then(function(){b(t,n,i)})})}function a(e){return function(){return Promise.resolve(e)}}function i(e){var t="";t+='<div class="listItem" data-itemid="'+e.Id+'" data-status="'+e.Status+'" data-remove="'+e.IsMarkedForRemoval+'">';var n,a=-1!=["Queued","Cancelled","Failed","ReadyToTransfer","Transferring","Converting","Synced"].indexOf(e.Status);return e.PrimaryImageItemId&&(n=ApiClient.getImageUrl(e.PrimaryImageItemId,{type:"Primary",width:80,tag:e.PrimaryImageTag,minScale:1.5})),t+=n?'<button type="button" is="emby-button" class="blue mini fab autoSize" icon="sync" style="background-image:url(\''+n+'\');background-repeat:no-repeat;background-position:center center;background-size: cover;"><i style="visibility:hidden;" class="md-icon">sync</i></button>':'<button type="button" is="emby-button" class="blue mini fab autoSize" icon="sync"><i class="md-icon">sync</i></button>',t+='<div class="listItemBody three-line">',t+="<div>",t+=e.ItemName,t+="</div>",t+="Failed"==e.Status?'<div class="secondary" style="color:red;">':'<div class="secondary">',t+=Globalize.translate("SyncJobItemStatus"+e.Status),"Synced"==e.Status&&e.IsMarkedForRemoval&&(t+="<br/>",t+=Globalize.translate("SyncJobItemStatusSyncedMarkForRemoval")),t+="</div>",t+='<div class="secondary" style="padding-top:5px;">',t+='<div style="background:#e0e0e0;height:4px;"><div style="background:#52B54B;width:'+(e.Progress||0)+'%;height:100%;"></div></div>',t+="</div>",t+="</div>",t+=a?'<button type="button" is="paper-icon-button-light" class="btnJobItemMenu autoSize"><i class="md-icon">'+AppInfo.moreIcon.replace("-","_")+"</i></button>":'<button type="button" is="paper-icon-button-light" class="btnJobItemMenu autoSize" disabled><i class="md-icon">'+AppInfo.moreIcon.replace("-","_")+"</i></button>",t+="</div>"}function r(e,t){var n="";n+="<h1>"+Globalize.translate("HeaderItems")+"</h1>",n+='<div class="paperList">';var a=0;n+=t.map(function(e){return i(e,a++)}).join(""),n+="</div>";var r=e.querySelector(".jobItems");r.innerHTML=n,ImageLoader.lazyChildren(r)}function o(e,t){for(;!e.classList||!e.classList.contains(t);)if(e=e.parentNode,!e)return null;return e}function s(e){var t=o(e,"page"),n=o(e,"listItem"),a=n.getAttribute("data-itemid"),i=n.getAttribute("data-status"),r="true"==n.getAttribute("data-remove").toLowerCase(),s=[];"Failed"==i?s.push({name:Globalize.translate("ButtonQueueForRetry"),id:"retry"}):"Cancelled"==i?s.push({name:Globalize.translate("ButtonReenable"),id:"retry"}):"Queued"==i||"Transferring"==i||"Converting"==i||"ReadyToTransfer"==i?s.push({name:Globalize.translate("ButtonCancelItem"),id:"cancel"}):"Synced"==i&&r?s.push({name:Globalize.translate("ButtonUnmarkForRemoval"),id:"unmarkforremoval"}):"Synced"==i&&s.push({name:Globalize.translate("ButtonMarkForRemoval"),id:"markforremoval"}),require(["actionsheet"],function(n){n.show({items:s,positionTo:e,callback:function(e){switch(e){case"cancel":l(t,a);break;case"retry":d(t,a);break;case"markforremoval":c(t,a);break;case"unmarkforremoval":u(t,a)}}})})}function l(e,t){Dashboard.showLoadingMsg(),ApiClient.ajax({type:"DELETE",url:ApiClient.getUrl("Sync/JobItems/"+t)}).then(function(){m(e)})}function c(e,t){ApiClient.ajax({type:"POST",url:ApiClient.getUrl("Sync/JobItems/"+t+"/MarkForRemoval")}).then(function(){m(e)})}function u(e,t){ApiClient.ajax({type:"POST",url:ApiClient.getUrl("Sync/JobItems/"+t+"/UnmarkForRemoval")}).then(function(){m(e)})}function d(e,t){ApiClient.ajax({type:"POST",url:ApiClient.getUrl("Sync/JobItems/"+t+"/Enable")}).then(function(){m(e)})}function b(e,t,n){var a=e.querySelector("#txtSyncJobName");a&&(a.value=t.Name);var i=e.querySelector("#selectProfile");i&&(i.value=t.Profile||"");var r=e.querySelector("#selectQuality");r&&(r.value=t.Quality||"");var o=e.querySelector("#chkUnwatchedOnly");o&&(o.checked=t.UnwatchedOnly);var s=e.querySelector("#chkSyncNewContent");s&&(s.checked=t.SyncNewContent);var l=e.querySelector("#txtItemLimit");l&&(l.value=t.ItemLimit);var c=e.querySelector("#txtBitrate");c.value=t.Bitrate?t.Bitrate/1e6:"";var u=n.Targets.filter(function(e){return e.Id==t.TargetId})[0],d=u?u.Name:"",b=e.querySelector("#selectSyncTarget");b&&(b.value=d)}function m(e){Dashboard.showLoadingMsg();var t=getParameterByName("id");ApiClient.getJSON(ApiClient.getUrl("Sync/Jobs/"+t)).then(function(t){ApiClient.getJSON(ApiClient.getUrl("Sync/Options",{UserId:t.UserId,ItemIds:t.RequestedItemIds&&t.RequestedItemIds.length?t.RequestedItemIds.join(""):null,ParentId:t.ParentId,Category:t.Category,TargetId:t.TargetId})).then(function(a){p=a,n(e,t,a),Dashboard.hideLoadingMsg()})}),ApiClient.getJSON(ApiClient.getUrl("Sync/JobItems",{JobId:t,AddMetadata:!0})).then(function(t){r(e,t.Items),Dashboard.hideLoadingMsg()})}function y(e,t,n){r(e,n),Dashboard.hideLoadingMsg()}function g(e){Dashboard.showLoadingMsg();var t=getParameterByName("id");ApiClient.getJSON(ApiClient.getUrl("Sync/Jobs/"+t)).then(function(n){require(["syncDialog"],function(a){a.setJobValues(n,e),ApiClient.ajax({url:ApiClient.getUrl("Sync/Jobs/"+t),type:"POST",data:JSON.stringify(n),contentType:"application/json"}).then(function(){Dashboard.hideLoadingMsg(),require(["toast"],function(e){e(Globalize.translate("SettingsSaved"))})})})})}var p;return function(e){function n(t,n){"SyncJob"==n.MessageType&&y(e,n.Data.Job,n.Data.JobItems)}function a(){var e="0,1500";e+=","+getParameterByName("id"),ApiClient.isWebSocketOpen()&&ApiClient.sendWebSocketMessage("SyncJobStart",e)}function i(){ApiClient.isWebSocketOpen()&&ApiClient.sendWebSocketMessage("SyncJobStop","")}e.querySelector(".syncJobForm").addEventListener("submit",function(t){return g(e),t.preventDefault(),!1}),e.querySelector(".jobItems").addEventListener("click",function(e){var n=t.parentWithClass(e.target,"btnJobItemMenu");n&&s(n)}),e.addEventListener("viewshow",function(){var e=this;m(e),a(e),Events.on(ApiClient,"websocketmessage",n)}),e.addEventListener("viewbeforehide",function(){i(),Events.off(ApiClient,"websocketmessage",n)})}});