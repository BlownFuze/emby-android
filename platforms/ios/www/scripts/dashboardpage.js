define(["datetime","jQuery","cardStyle"],function(e,a){function t(e){var a='<p style="padding:0 .5em;display:flex;align-items:center;">';a+='<iron-icon icon="check" style="margin-right:.5em;background-color: #52B54B;border-radius:1em;color: #fff;"></iron-icon>',a+=Globalize.translate("HealthMonitorNoAlerts")+"</p>",e.querySelector(".healthMonitor").innerHTML=a}function n(e){t(e)}function s(e){return e.preventDefault(),!1}window.DashboardPage={newsStartIndex:0,onPageInit:function(){var e=this;e.querySelector("#btnConnectionHelp").addEventListener("click",s)},onPageShow:function(){var e=this,t=ApiClient;t&&(Dashboard.lastSystemInfo&&(e.querySelector(".serverNameHeader").innerHTML=Dashboard.lastSystemInfo.ServerName),DashboardPage.newsStartIndex=0,Dashboard.showLoadingMsg(),DashboardPage.pollForInfo(e),DashboardPage.startInterval(t),Events.on(t,"websocketmessage",DashboardPage.onWebSocketMessage),Events.on(t,"websocketopen",DashboardPage.onWebSocketOpen),DashboardPage.lastAppUpdateCheck=null,DashboardPage.lastPluginUpdateCheck=null,Dashboard.getPluginSecurityInfo().then(function(a){DashboardPage.renderSupporterIcon(e,a)}),DashboardPage.reloadSystemInfo(e),DashboardPage.reloadNews(e),DashboardPage.sessionUpdateTimer=setInterval(DashboardPage.refreshSessionsLocally,6e4),a(".activityItems",e).activityLogList(),a(".swaggerLink",e).attr("href",t.getUrl("swagger-ui/index.html",{api_key:ApiClient.accessToken()})),n(e))},onPageHide:function(){var e=this;a(".activityItems",e).activityLogList("destroy");var t=ApiClient;t&&(Events.off(t,"websocketmessage",DashboardPage.onWebSocketMessage),Events.off(t,"websocketopen",DashboardPage.onWebSocketOpen),DashboardPage.stopInterval(t)),DashboardPage.sessionUpdateTimer&&clearInterval(DashboardPage.sessionUpdateTimer)},renderPaths:function(e,t){a("#cachePath",e).html(t.CachePath),a("#logPath",e).html(t.LogPath),a("#transcodingTemporaryPath",e).html(t.TranscodingTempPath),a("#metadataPath",e).html(t.InternalMetadataPath)},refreshSessionsLocally:function(){var e=DashboardPage.sessionsList;e&&DashboardPage.renderActiveConnections(a.mobile.activePage,e)},reloadSystemInfo:function(e){ApiClient.getSystemInfo().then(function(t){e.querySelector(".serverNameHeader").innerHTML=t.ServerName,Dashboard.updateSystemInfo(t),a("#appVersionNumber",e).html(Globalize.translate("LabelVersionNumber").replace("{0}",t.Version)),a("#ports",e).html(t.SupportsHttps?Globalize.translate("LabelRunningOnPorts","<b>"+t.HttpServerPortNumber+"</b>","<b>"+t.HttpsPortNumber+"</b>"):Globalize.translate("LabelRunningOnPort","<b>"+t.HttpServerPortNumber+"</b>")),t.CanSelfRestart?a(".btnRestartContainer",e).removeClass("hide"):a(".btnRestartContainer",e).addClass("hide"),DashboardPage.renderUrls(e,t),DashboardPage.renderPendingInstallations(e,t),t.CanSelfUpdate?(a("#btnUpdateApplicationContainer",e).show(),a("#btnManualUpdateContainer",e).hide()):(a("#btnUpdateApplicationContainer",e).hide(),a("#btnManualUpdateContainer",e).show()),DashboardPage.renderPaths(e,t),DashboardPage.renderHasPendingRestart(e,t.HasPendingRestart)})},reloadNews:function(t){var n={StartIndex:DashboardPage.newsStartIndex,Limit:7};ApiClient.getProductNews(n).then(function(s){var i=s.Items.map(function(a){var t="";t+='<a class="clearLink" href="'+a.Link+'" target="_blank">',t+='<div class="listItem listItem-noborder">',t+='<i class="listItemIcon md-icon">dvr</i>',t+='<div class="listItemBody three-line">',t+='<h3 class="listItemBodyText">',t+=a.Title,t+="</h3>",t+='<div class="listItemBodyText secondary">';var n=e.parseISO8601Date(a.Date,!0);return t+=n.toLocaleDateString(),t+="</div>",t+='<div class="listItemBodyText secondary listItemBodyText-nowrap">',t+=a.Description,t+="</div>",t+="</div>",t+="</div>",t+="</a>"}),r="";r+="<div>",r+=LibraryBrowser.getQueryPagingHtml({startIndex:n.StartIndex,limit:n.Limit,totalRecordCount:s.TotalRecordCount,showLimit:!1,updatePageSizeSetting:!1}),r+="</div>",i=i.join("")+r;var o=a(".latestNewsItems",t).html(i);a(".btnNextPage",o).on("click",function(){DashboardPage.newsStartIndex+=n.Limit,DashboardPage.reloadNews(t)}),a(".btnPreviousPage",o).on("click",function(){DashboardPage.newsStartIndex-=n.Limit,DashboardPage.reloadNews(t)})})},startInterval:function(e){e.isWebSocketOpen()&&(e.sendWebSocketMessage("SessionsStart","0,1500"),e.sendWebSocketMessage("ScheduledTasksInfoStart","0,1000"))},stopInterval:function(e){e.isWebSocketOpen()&&(e.sendWebSocketMessage("SessionsStop"),e.sendWebSocketMessage("ScheduledTasksInfoStop"))},onWebSocketMessage:function(e,t){var n=a.mobile.activePage;if("Sessions"==t.MessageType)DashboardPage.renderInfo(n,t.Data);else if("RestartRequired"==t.MessageType)DashboardPage.renderHasPendingRestart(n,!0);else if("ServerShuttingDown"==t.MessageType)DashboardPage.renderHasPendingRestart(n,!0);else if("ServerRestarting"==t.MessageType)DashboardPage.renderHasPendingRestart(n,!0);else if("ScheduledTasksInfo"==t.MessageType){var s=t.Data;DashboardPage.renderRunningTasks(n,s)}else("PackageInstalling"==t.MessageType||"PackageInstallationCompleted"==t.MessageType)&&(DashboardPage.pollForInfo(n,!0),DashboardPage.reloadSystemInfo(n))},onWebSocketOpen:function(){var e=this;DashboardPage.startInterval(e)},pollForInfo:function(e,a){var t=window.ApiClient;t&&(t.getSessions().then(function(t){DashboardPage.renderInfo(e,t,a)}),t.getScheduledTasks().then(function(a){DashboardPage.renderRunningTasks(e,a)}))},renderInfo:function(e,a,t){DashboardPage.renderActiveConnections(e,a),DashboardPage.renderPluginUpdateInfo(e,t),Dashboard.hideLoadingMsg()},renderActiveConnections:function(e,t){var n="";DashboardPage.sessionsList=t;var s=a(".activeDevices",e);a(".card",s).addClass("deadSession");for(var i=0,r=t.length;r>i;i++){var o=t[i],l="session"+o.Id,d=a("#"+l,e);if(d.length)DashboardPage.updateSession(d,o);else{var g=o.NowPlayingItem,c=g?"scalableCard card activeSession backdropCard":"scalableCard card activeSession backdropCard";o.TranscodingInfo&&o.TranscodingInfo.CompletionPercentage&&(c+=" transcodingSession"),n+='<div class="'+c+'" id="'+l+'">',n+='<div class="cardBox visualCardBox">',n+='<div class="cardScalable visualCardBox-cardScalable">',n+='<div class="cardPadder cardPadder-backdrop"></div>',n+='<div class="cardContent">',n+='<div class="sessionNowPlayingContent"';var m=DashboardPage.getNowPlayingImageUrl(g);m&&(n+=' data-src="'+m+'" style="display:inline-block;background-image:url(\''+m+"');\""),n+="></div>",n+='<div class="sessionNowPlayingInnerContent">',n+='<div class="sessionAppInfo">';var p=DashboardPage.getClientImage(o);p&&(n+=p),n+='<div class="sessionAppName" style="display:inline-block;">',n+='<div class="sessionDeviceName">'+o.DeviceName+"</div>",n+='<div class="sessionAppSecondaryText">'+DashboardPage.getAppSecondaryText(o)+"</div>",n+="</div>",n+="</div>",n+='<div class="sessionNowPlayingTime">'+DashboardPage.getSessionNowPlayingTime(o)+"</div>";var h=DashboardPage.getNowPlayingName(o);if(n+='<div class="sessionNowPlayingInfo" data-imgsrc="'+h.image+'">',n+=h.html,n+="</div>",g&&g.RunTimeTicks){var u=o.PlayState.PositionTicks||0,b=100*u/g.RunTimeTicks;n+='<progress class="playbackProgress" min="0" max="100" value="'+b+'"></progress>'}else n+='<progress class="playbackProgress" min="0" max="100" style="display:none;"></progress>';n+=o.TranscodingInfo&&o.TranscodingInfo.CompletionPercentage?'<progress class="transcodingProgress" min="0" max="100" value="'+o.TranscodingInfo.CompletionPercentage.toFixed(1)+'"></progress>':'<progress class="transcodingProgress" min="0" max="100" style="display:none;"></progress>',n+="</div>",n+="</div>",n+="</div>",n+='<div style="padding:1em;border-top:1px solid #eee;background:#fff;text-align:center;">',n+='<div class="sessionNowPlayingStreamInfo" style="padding:0 0 1em;">',n+=DashboardPage.getSessionNowPlayingStreamInfo(o),n+="</div>",n+='<div style="display:flex;align-items:center;justify-content:center;text-transform:uppercase;">';var v=DashboardPage.getUserImage(o);n+=v?'<img style="border-radius:50px;margin-right:.5em;" src="'+v+'" />':'<div style="height:24px;"></div>',n+='<div class="sessionUserName">',n+=DashboardPage.getUsersHtml(o)||"&nbsp;",n+="</div>",n+="</div>",n+="</div>",n+="</div>",n+="</div>"}}s.append(n),a(".deadSession",s).remove()},getSessionNowPlayingStreamInfo:function(e){var a="",t=!1;if(e.TranscodingInfo&&e.TranscodingInfo.IsAudioDirect&&e.TranscodingInfo.IsVideoDirect?a+=Globalize.translate("LabelPlayMethodDirectStream"):e.TranscodingInfo&&e.TranscodingInfo.IsVideoDirect?a+=Globalize.translate("LabelPlayMethodDirectStream"):"Transcode"==e.PlayState.PlayMethod?(a+=Globalize.translate("LabelPlayMethodTranscoding"),e.TranscodingInfo&&e.TranscodingInfo.Framerate&&(a+=" ("+e.TranscodingInfo.Framerate+" fps)"),t=!0):"DirectStream"==e.PlayState.PlayMethod?a+=Globalize.translate("LabelPlayMethodDirectPlay"):"DirectPlay"==e.PlayState.PlayMethod&&(a+=Globalize.translate("LabelPlayMethodDirectPlay")),t){var n=[];e.TranscodingInfo&&(e.TranscodingInfo.Bitrate&&n.push(e.TranscodingInfo.Bitrate>1e6?(e.TranscodingInfo.Bitrate/1e6).toFixed(1)+" Mbps":Math.floor(e.TranscodingInfo.Bitrate/1e3)+" kbps"),e.TranscodingInfo.Container&&n.push(e.TranscodingInfo.Container),e.TranscodingInfo.VideoCodec&&n.push(e.TranscodingInfo.VideoCodec),e.TranscodingInfo.AudioCodec&&e.TranscodingInfo.AudioCodec!=e.TranscodingInfo.Container&&n.push(e.TranscodingInfo.AudioCodec)),n.length&&(a+=" - "+n.join(" "))}return a||"&nbsp;"},getSessionNowPlayingTime:function(a){var t="";t+=a.PlayState.PositionTicks?e.getDisplayRunningTime(a.PlayState.PositionTicks):"--:--:--",t+=" / ";var n=a.NowPlayingItem;return t+=n&&n.RunTimeTicks?e.getDisplayRunningTime(n.RunTimeTicks):"--:--:--"},getAppSecondaryText:function(e){return e.ApplicationVersion},getNowPlayingName:function(e){var a="",t=e.NowPlayingItem;if(!t)return{html:"Last seen "+humane_date(e.LastActivityDate),image:a};var n=t.Name,s="";t.Artists&&t.Artists.length?(s=n,n=t.Artists[0]):t.SeriesName||t.Album?(s=n,n=t.SeriesName||t.Album):t.ProductionYear&&(s=t.ProductionYear),t.LogoItemId&&(a=ApiClient.getScaledImageUrl(t.LogoItemId,{tag:e.LogoImageTag,maxHeight:24,maxWidth:130,type:"Logo"}),n='<img src="'+a+'" style="max-height:24px;max-width:130px;" />');var i=s?n+"<br/>"+s:n;return{html:i,image:a}},getUsersHtml:function(e){var a=[];e.UserId&&a.push(e.UserName);for(var t=0,n=e.AdditionalUsers.length;n>t;t++)a.push(e.AdditionalUsers[t].UserName);return a.join(", ")},getUserImage:function(e){return e.UserId&&e.UserPrimaryImageTag?ApiClient.getUserImageUrl(e.UserId,{tag:e.UserPrimaryImageTag,height:24,type:"Primary"}):null},updateSession:function(e,t){e.removeClass("deadSession");var n=t.NowPlayingItem;n?e.addClass("playingSession"):e.removeClass("playingSession"),a(".sessionNowPlayingStreamInfo",e).html(DashboardPage.getSessionNowPlayingStreamInfo(t)),a(".sessionNowPlayingTime",e).html(DashboardPage.getSessionNowPlayingTime(t)),a(".sessionUserName",e).html(DashboardPage.getUsersHtml(t)||"&nbsp;"),a(".sessionAppSecondaryText",e).html(DashboardPage.getAppSecondaryText(t)),a(".sessionTranscodingFramerate",e).html(t.TranscodingInfo&&t.TranscodingInfo.Framerate?t.TranscodingInfo.Framerate+" fps":"");var s=DashboardPage.getNowPlayingName(t),i=a(".sessionNowPlayingInfo",e);if(s.image&&s.image==i.attr("data-imgsrc")||(i.html(s.html),i.attr("data-imgsrc",s.image||"")),n&&n.RunTimeTicks){var r=t.PlayState.PositionTicks||0,o=100*r/n.RunTimeTicks;a(".playbackProgress",e).show().val(o)}else a(".playbackProgress",e).hide();t.TranscodingInfo&&t.TranscodingInfo.CompletionPercentage?(e.addClass("transcodingSession"),a(".transcodingProgress",e).show().val(t.TranscodingInfo.CompletionPercentage)):(a(".transcodingProgress",e).hide(),e.removeClass("transcodingSession"));var l=DashboardPage.getNowPlayingImageUrl(n)||"",d=a(".sessionNowPlayingContent",e)[0];l!=d.getAttribute("data-src")&&(d.style.backgroundImage=l?"url('"+l+"')":"",d.setAttribute("data-src",l))},getClientImage:function(e){var a=e.Client.toLowerCase(),t=e.DeviceName.toLowerCase();if(e.AppIconUrl)return"<img src='"+e.AppIconUrl+"' />";if("dashboard"==a||"emby web client"==a){var n;return n=-1!=t.indexOf("chrome")?"css/images/clients/chrome.png":"css/images/clients/html5.png","<img src='"+n+"' alt='Emby Web Client' />"}return-1!=a.indexOf("android")?"<img src='css/images/clients/android.png' />":-1!=a.indexOf("ios")?"<img src='css/images/clients/ios.png' />":"mb-classic"==a?"<img src='css/images/clients/mbc.png' />":"roku"==a?"<img src='css/images/clients/roku.jpg' />":"windows phone"==a?"<img src='css/images/clients/windowsphone.png' />":"dlna"==a?"<img src='css/images/clients/dlna.png' />":"kodi"==a||"xbmc"==a?"<img src='css/images/clients/kodi.png' />":"chromecast"==a?"<img src='css/images/clients/chromecast.png' />":null},getNowPlayingImageUrl:function(e){return e&&e.BackdropImageTag?ApiClient.getScaledImageUrl(e.BackdropItemId,{type:"Backdrop",width:275,tag:e.BackdropImageTag}):e&&e.ThumbImageTag?ApiClient.getScaledImageUrl(e.ThumbItemId,{type:"Thumb",width:275,tag:e.ThumbImageTag}):e&&e.PrimaryImageTag?ApiClient.getScaledImageUrl(e.PrimaryImageItemId,{type:"Primary",width:275,tag:e.PrimaryImageTag}):null},systemUpdateTaskKey:"SystemUpdateTask",renderRunningTasks:function(e,t){var n="";t=t.filter(function(e){return"Idle"!=e.State&&!e.IsHidden}),a("#btnUpdateApplication",e).buttonEnabled(t.filter(function(e){return e.Key==DashboardPage.systemUpdateTaskKey}).length?!1:!0),t.length?a("#runningTasksCollapsible",e).show():a("#runningTasksCollapsible",e).hide();for(var s=0,i=t.length;i>s;s++){var r=t[s];if(n+="<p>",n+=r.Name+"<br/>","Running"==r.State){var o=(r.CurrentProgressPercentage||0).toFixed(1);n+='<progress max="100" value="'+o+'" title="'+o+'%">',n+=""+o+"%",n+="</progress>",n+="<span style='color:#009F00;margin-left:5px;margin-right:5px;'>"+o+"%</span>",n+='<button type="button" is="paper-icon-button-light" title="'+Globalize.translate("ButtonStop")+'" onclick="DashboardPage.stopTask(\''+r.Id+'\');" class="autoSize"><i class="md-icon">cancel</i></button>'}else"Cancelling"==r.State&&(n+='<span style="color:#cc0000;">'+Globalize.translate("LabelStopping")+"</span>");n+="</p>"}a("#divRunningTasks",e).html(n)},renderUrls:function(e,t){if(t.LocalAddress){var n=Globalize.translate("LabelLocalAccessUrl",'<a href="'+t.LocalAddress+'" target="_blank">'+t.LocalAddress+"</a>");a(".localUrl",e).html(n).show().trigger("create")}else a(".externalUrl",e).hide();if(t.WanAddress){var s=t.WanAddress,i=Globalize.translate("LabelRemoteAccessUrl",'<a href="'+s+'" target="_blank">'+s+"</a>");a(".externalUrl",e).html(i).show().trigger("create")}else a(".externalUrl",e).hide()},renderSupporterIcon:function(e,a){var t,n,s=e.querySelector(".supporterIconContainer");AppInfo.enableSupporterMembership&&a.IsMBSupporter?(s.classList.remove("hide"),t="css/images/supporter/supporterbadge.png",n=Globalize.translate("MessageThankYouForSupporting"),s.innerHTML='<a class="imageLink supporterIcon" href="http://emby.media/premiere" target="_blank" title="'+n+'"><img src="'+t+'" style="height:32px;vertical-align: middle; margin-right: .5em;" /></a><span style="position:relative;top:2px;text-decoration:none;">'+n+"</span>"):s.classList.add("hide")},renderHasPendingRestart:function(e,t){if(t)e.querySelector("#pUpToDate").classList.add("hide"),a("#pUpdateNow",e).hide();else{if(DashboardPage.lastAppUpdateCheck&&(new Date).getTime()-DashboardPage.lastAppUpdateCheck<18e5)return;DashboardPage.lastAppUpdateCheck=(new Date).getTime(),ApiClient.getAvailableApplicationUpdate().then(function(t){var n=t[0];n?(e.querySelector("#pUpToDate").classList.add("hide"),a("#pUpdateNow",e).show(),a("#newVersionNumber",e).html(Globalize.translate("VersionXIsAvailableForDownload").replace("{0}",n.versionStr))):(e.querySelector("#pUpToDate").classList.remove("hide"),a("#pUpdateNow",e).hide())})}},renderPendingInstallations:function(e,t){if(!t.CompletedInstallations.length)return void a("#collapsiblePendingInstallations",e).hide();a("#collapsiblePendingInstallations",e).show();for(var n="",s=0,i=t.CompletedInstallations.length;i>s;s++){var r=t.CompletedInstallations[s];n+="<div><strong>"+r.Name+"</strong> ("+r.Version+")</div>"}a("#pendingInstallations",e).html(n)},renderPluginUpdateInfo:function(e,t){!t&&DashboardPage.lastPluginUpdateCheck&&(new Date).getTime()-DashboardPage.lastPluginUpdateCheck<18e5||(DashboardPage.lastPluginUpdateCheck=(new Date).getTime(),ApiClient.getAvailablePluginUpdates().then(function(t){var n=a("#pPluginUpdates",e);if(!t.length)return void n.hide();n.show();for(var s="",i=0,r=t.length;r>i;i++){var o=t[i];s+="<p><strong>"+Globalize.translate("NewVersionOfSomethingAvailable").replace("{0}",o.name)+"</strong></p>",s+='<button type="button" data-icon="arrow-d" data-theme="b" onclick="DashboardPage.installPluginUpdate(this);" data-name="'+o.name+'" data-guid="'+o.guid+'" data-version="'+o.versionStr+'" data-classification="'+o.classification+'">'+Globalize.translate("ButtonUpdateNow")+"</button>"}n.html(s)}))},installPluginUpdate:function(e){a(e).buttonEnabled(!1);var t=e.getAttribute("data-name"),n=e.getAttribute("data-guid"),s=e.getAttribute("data-version"),i=e.getAttribute("data-classification");Dashboard.showLoadingMsg(),ApiClient.installPlugin(t,n,i,s).then(function(){Dashboard.hideLoadingMsg()})},updateApplication:function(){var e=a.mobile.activePage;a("#btnUpdateApplication",e).buttonEnabled(!1),Dashboard.showLoadingMsg(),ApiClient.getScheduledTasks().then(function(a){var t=a.filter(function(e){return e.Key==DashboardPage.systemUpdateTaskKey})[0];ApiClient.startScheduledTask(t.Id).then(function(){DashboardPage.pollForInfo(e),Dashboard.hideLoadingMsg()})})},stopTask:function(e){var t=a.mobile.activePage;ApiClient.stopScheduledTask(e).then(function(){DashboardPage.pollForInfo(t)})},restart:function(){require(["confirm"],function(e){e(Globalize.translate("MessageConfirmRestart"),Globalize.translate("HeaderRestart")).then(function(){a("#btnRestartServer").buttonEnabled(!1),a("#btnShutdown").buttonEnabled(!1),Dashboard.restartServer()})})},shutdown:function(){require(["confirm"],function(e){e(Globalize.translate("MessageConfirmShutdown"),Globalize.translate("HeaderShutdown")).then(function(){a("#btnRestartServer").buttonEnabled(!1),a("#btnShutdown").buttonEnabled(!1),ApiClient.shutdownServer()})})}},a(document).on("pageinit","#dashboardPage",DashboardPage.onPageInit).on("pageshow","#dashboardPage",DashboardPage.onPageShow).on("pagebeforehide","#dashboardPage",DashboardPage.onPageHide),function(a){function t(a){var t="";t+='<div class="listItem listItem-noborder">';var n="Error"==a.Severity||"Fatal"==a.Severity||"Warn"==a.Severity?"#cc0000":"#52B54B";if(a.UserId&&a.UserPrimaryImageTag){var s=ApiClient.getUserImageUrl(a.UserId,{type:"Primary",tag:a.UserPrimaryImageTag,height:40});t+='<i class="listItemIcon md-icon" style="width:2em!important;height:2em!important;padding:0;color:transparent;background-color:'+n+";background-image:url('"+s+"');background-repeat:no-repeat;background-position:center center;background-size: cover;\">dvr</i>"}else t+='<i class="listItemIcon md-icon" style="background-color:'+n+'">dvr</i>';t+='<div class="listItemBody three-line">',t+='<h3 class="listItemBodyText">',t+=a.Name,t+="</h3>",t+='<div class="listItemBodyText secondary">';var i=e.parseISO8601Date(a.Date,!0);return t+=i.toLocaleDateString()+" "+i.toLocaleTimeString().toLowerCase(),t+="</div>",t+='<div class="listItemBodyText secondary listItemBodyText-nowrap">',t+=a.ShortOverview||"",t+="</div>",t+="</div>",t+="</div>"}function n(e,n,i,r){var o=n.Items.map(t).join("");if(n.TotalRecordCount>r){var l={StartIndex:i,Limit:r};o+=LibraryBrowser.getQueryPagingHtml({startIndex:l.StartIndex,limit:l.Limit,totalRecordCount:n.TotalRecordCount,showLimit:!1,updatePageSizeSetting:!1})}a(e).html(o),a(".btnNextPage",e).on("click",function(){s(e,i+r,r)}),a(".btnPreviousPage",e).on("click",function(){s(e,i-r,r)}),a(".btnShowOverview",e).on("click",function(){var e=a(this).parents(".newsItem"),t=a(".newsItemLongDescription",e).html(),n=a(".notificationName",e).html();Dashboard.alert({message:'<div style="max-height:300px; overflow: auto;">'+t+"</div>",title:n})})}function s(e,a,t){null==a&&(a=parseInt(e.getAttribute("data-activitystartindex")||"0")),t=t||parseInt(e.getAttribute("data-activitylimit")||"7");var s=new Date;s.setTime(s.getTime()-864e5),ApiClient.getJSON(ApiClient.getUrl("System/ActivityLog/Entries",{startIndex:a,limit:t,minDate:s.toISOString()})).then(function(s){e.setAttribute("data-activitystartindex",a),e.setAttribute("data-activitylimit",t),n(e,s,a,t)})}function i(e){e.each(function(){s(this)}).addClass("activityLogListWidget");var a=ApiClient;a&&(Events.on(a,"websocketopen",l),Events.on(a,"websocketmessage",d))}function r(e){e.isWebSocketOpen()&&e.sendWebSocketMessage("ActivityLogEntryStart","0,1500")}function o(e){e.isWebSocketOpen()&&e.sendWebSocketMessage("ActivityLogEntryStop","0,1500")}function l(){var e=ApiClient;e&&r(e)}function d(e,t){var n=t;"ActivityLogEntry"===n.MessageType&&a(".activityLogListWidget").each(function(){s(this)})}function g(){var e=ApiClient;e&&(Events.off(e,"websocketopen",l),Events.off(e,"websocketmessage",d),o(e))}a.fn.activityLogList=function(e){"destroy"==e?(this.removeClass("activityLogListWidget"),g(this)):i(this);var a=ApiClient;return a&&r(a),this}}(jQuery,document,window),function(e,a){function t(a,t){ApiClient.getDisplayPreferences("dashboard",t,"dashboard").then(function(n){n.CustomPrefs[o]=r,ApiClient.updateDisplayPreferences("dashboard",n,t,"dashboard"),e(a).off("pageshow",i)})}function n(a,t){var n=Dashboard.getCurrentUserId();t.getDisplayPreferences("dashboard",n,"dashboard").then(function(t){if(t.CustomPrefs[o]==r)e(".welcomeMessage",a).hide();else{var n=e(".welcomeMessage",a).show();t.CustomPrefs[o]?(e(".tourHeader",n).html(Globalize.translate("HeaderWelcomeBack")),e(".tourButtonText",n).html(Globalize.translate("ButtonTakeTheTourToSeeWhatsNew"))):(e(".tourHeader",n).html(Globalize.translate("HeaderWelcomeToProjectServerDashboard")),e(".tourButtonText",n).html(Globalize.translate("ButtonTakeTheTour")))}})}function s(a,n){require(["slideshow"],function(){var s=[{imageUrl:"css/images/tour/admin/dashboard.png",title:Globalize.translate("DashboardTourDashboard")},{imageUrl:"css/images/tour/admin/help.png",title:Globalize.translate("DashboardTourHelp")},{imageUrl:"css/images/tour/admin/users.png",title:Globalize.translate("DashboardTourUsers")},{imageUrl:"css/images/tour/admin/sync.png",title:Globalize.translate("DashboardTourSync")},{imageUrl:"css/images/tour/admin/cinemamode.png",title:Globalize.translate("DashboardTourCinemaMode")},{imageUrl:"css/images/tour/admin/chapters.png",title:Globalize.translate("DashboardTourChapters")},{imageUrl:"css/images/tour/admin/subtitles.png",title:Globalize.translate("DashboardTourSubtitles")},{imageUrl:"css/images/tour/admin/plugins.png",title:Globalize.translate("DashboardTourPlugins")},{imageUrl:"css/images/tour/admin/notifications.png",title:Globalize.translate("DashboardTourNotifications")},{imageUrl:"css/images/tour/admin/scheduledtasks.png",title:Globalize.translate("DashboardTourScheduledTasks")},{imageUrl:"css/images/tour/admin/mobile.png",title:Globalize.translate("DashboardTourMobile")},{imageUrl:"css/images/tour/enjoy.jpg",title:Globalize.translate("MessageEnjoyYourStay")}];require(["slideshow"],function(i){var r=new i({slides:s,interactive:!0,loop:!1});r.show(),t(a,n),e(".welcomeMessage",a).hide()})})}function i(){var e=this,a=ApiClient;a&&!AppInfo.isNativeApp&&n(e,a)}var r="12",o="welcomeTour";e(a).on("pageinit","#dashboardPage",function(){var a=this;e(".btnTakeTour",a).on("click",function(){s(a,Dashboard.getCurrentUserId())})}).on("pageshow","#dashboardPage",i)}(jQuery,document,window),pageClassOn("pageshow","type-interior",function(){var e=this;Dashboard.getPluginSecurityInfo().then(function(t){if(!e.querySelector(".customSupporterPromotion")&&(a(".supporterPromotion",e).remove(),!t.IsMBSupporter&&AppInfo.enableSupporterMembership)){var n='<div class="supporterPromotionContainer"><div class="supporterPromotion"><a class="clearLink" href="http://emby.media/premiere" target="_blank"><button is="emby-button" type="button" class="raised block" style="text-transform:none;background-color:#52B54B;color:#fff;"><div>'+Globalize.translate("HeaderSupportTheTeam")+'</div><div style="font-weight:normal;margin-top:5px;">'+Globalize.translate("TextEnjoyBonusFeatures")+"</div></button></a></div></div>";e.querySelector(".content-primary").insertAdjacentHTML("afterbegin",n)}})})});