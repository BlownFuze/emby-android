define(["jQuery"],function(e){function i(i,t){for(var a="",r=0,n=Math.min(i.versions.length,10);n>r;r++){var s=i.versions[r];a+='<h2 style="margin:.5em 0;">'+s.versionStr+" ("+s.classification+")</h2>",a+='<div style="margin-bottom:1.5em;">'+s.description+"</div>"}e("#revisionHistory",t).html(a)}function t(i,t,a){for(var r="",n=0,s=i.versions.length;s>n;n++){var l=i.versions[n];r+='<option value="'+l.versionStr+"|"+l.classification+'">'+l.versionStr+" ("+l.classification+")</option>"}var o=e("#selectVersion",t).html(r);a||e("#pCurrentVersion",t).hide().html("");var g=i.versions.filter(function(e){return"Release"==e.classification})[0];if(g||(g=i.versions.filter(function(e){return"Beta"==e.classification})[0]),g){var h=g.versionStr+"|"+g.classification;o.val(h)}}function a(i,t){ApiClient.getPackageReviews(i,null,null,3).then(function(i){var a="";if(i&&i.length>0){a+='<div style="margin-top: 2em;" >',a+="<h3>"+Globalize.translate("HeaderLatestReviews")+"</h3>",a+="<div><br/>";for(var r=0;r<i.length;r++){var n=i[r];a+="<div>",a+="<span class='storeItemReviewText' style='display:inline-flex;align-items:center;'>",a+=new Date(n.timestamp).toDateString(),n.rating&&(a+='<i class="md-icon" style="color:#cc3333;height:auto;width:auto;margin-left:.5em;">star</i>',a+=n.rating.toFixed(1)),a+=" "+n.title,a+="</span>",n.review&&(a+="<p class='storeItemReviewText'>",a+=n.review,a+="</p>"),a+="</div>",a+="<hr/>"}a+="</div>",a+="</div>"}e("#latestReviews",t).html(a).trigger("create")})}function r(e,i,t){AppInfo.isNativeApp||require(["jQuery"],function(a){if(i.isPremium){a(".premiumPackage",e).show();var r="";if(i.isRegistered)r+="<p style='color:green;'>",r+=Globalize.translate("MessageFeatureIncludedWithSupporter");else{var n=new Date(i.expDate).getTime(),s=(new Date).getTime();s>=n?(r+="<p style='color:red;'>",r+=Globalize.translate("MessageTrialExpired")):n>new Date(1970,1,1).getTime()&&(r+="<p style='color:blue;'>",r+=Globalize.translate("MessageTrialWillExpireIn").replace("{0}",Math.round(n-s)/864e5))}if(r+="</p>",a("#regStatus",e).html(r),t.IsMBSupporter)if(a("#regInfo",e).html(i.regInfo||""),a(".premiumDescription",e).hide(),a(".supporterDescription",e).hide(),i.price>0){a(".premiumHasPrice",e).show(),a("#featureId",e).val(i.featureId),a("#featureName",e).val(i.name),a("#amount",e).val(i.price),a("#regPrice",e).html("<h3>"+Globalize.translate("ValuePriceUSD").replace("{0}","$"+i.price.toFixed(2))+"</h3>"),a("#ppButton",e).hide();var l="https://mb3admin.com/admin/service/user/getPayPalEmail?id="+i.owner;fetch(l).then(function(e){return e.json()}).then(function(i){i.payPalEmail&&(a("#payPalEmail",e).val(i.payPalEmail),a("#ppButton",e).show())})}else a(".premiumHasPrice",e).hide();else i.price?(a(".premiumDescription",e).show(),a(".supporterDescription",e).hide(),a("#regInfo",e).html("")):(a(".premiumDescription",e).hide(),a(".supporterDescription",e).show(),a("#regInfo",e).html("")),a("#ppButton",e).hide()}else a(".premiumPackage",e).hide()})}function n(n,s,l,o){var g=s.filter(function(e){return e.Name==n.name})[0];if(t(n,o,g),i(n,o),n.totalRatings>0&&a(n.id,o),e(".pluginName",o).html(n.name),"Server"==n.targetSystem)e("#btnInstallDiv",o).removeClass("hide"),e("#nonServerMsg",o).hide(),e("#pSelectVersion",o).removeClass("hide");else{e("#btnInstallDiv",o).addClass("hide"),e("#pSelectVersion",o).addClass("hide");var h=Globalize.translate("MessageInstallPluginFromApp");e("#nonServerMsg",o).html(h).show()}n.shortDescription?e("#tagline",o).show().html(n.shortDescription):e("#tagline",o).hide(),e("#overview",o).html(n.overview||""),e("#developer",o).html(n.owner),r(o,n,l);var u="";if(n.avgRating&&(u+='<i class="md-icon" style="color:#cc3333;height:auto;width:auto;">star</i>',u+=n.avgRating.toFixed(1)),u+="<span>",u+=" "+Globalize.translate("ValueReviewCount").replace("{0}",n.totalRatings),u+="</span>",e("#ratingLine",o).html(u),n.richDescUrl?(e("#pViewWebsite",o).show(),e("#pViewWebsite a",o).attr("href",n.richDescUrl)):e("#pViewWebsite",o).hide(),n.previewImage||n.thumbImage){var d=n.tileColor||"#38c",m=n.previewImage?n.previewImage:n.thumbImage;e("#pPreviewImage",o).show().html("<img src='"+m+"' style='max-width: 100%;-moz-box-shadow: 0 0 20px 3px "+d+";-webkit-box-shadow: 0 0 20px 3px "+d+";box-shadow: 0 0 20px 3px "+d+";' />")}else e("#pPreviewImage",o).hide().html("");if(g){var c=Globalize.translate("MessageYouHaveVersionInstalled").replace("{0}","<strong>"+g.Version+"</strong>");e("#pCurrentVersion",o).show().html(c)}else e("#pCurrentVersion",o).hide().html("");Dashboard.hideLoadingMsg()}function s(i,t,a,r,n){var s=e("#developer",i).html().toLowerCase(),l=function(e){e&&(Dashboard.showLoadingMsg(),i.querySelector("#btnInstall").disabled=!0,ApiClient.installPlugin(t,a,r,n).then(function(){Dashboard.hideLoadingMsg()}))};if("luke"!=s&&"ebr"!=s){Dashboard.hideLoadingMsg();var o=Globalize.translate("MessagePluginInstallDisclaimer");o+="<br/>",o+="<br/>",o+=Globalize.translate("PleaseConfirmPluginInstallation"),require(["confirm"],function(e){e(o,Globalize.translate("HeaderConfirmPluginInstallation")).then(function(){l(!0)},function(){l(!1)})})}else l(!0)}function l(){var i=this;i.onSubmit=function(){Dashboard.showLoadingMsg();var i=e(this).parents("#addPluginPage")[0],t=getParameterByName("name"),a=getParameterByName("guid");return ApiClient.getInstalledPlugins().then(function(r){var n=r.filter(function(e){return e.Name==t})[0],l=e("#selectVersion",i).val().split("|"),o=l[0];n&&n.Version==o?(Dashboard.hideLoadingMsg(),Dashboard.alert({message:Globalize.translate("MessageAlreadyInstalled"),title:Globalize.translate("HeaderPluginInstallation")})):s(i,t,a,l[1],o)}),!1}}e(document).on("pageinit","#addPluginPage",function(){e(".addPluginForm").off("submit",AddPluginPage.onSubmit).on("submit",AddPluginPage.onSubmit)}).on("pageshow","#addPluginPage",function(){var e=this;Dashboard.showLoadingMsg();var i=getParameterByName("name"),t=getParameterByName("guid"),a=ApiClient.getPackageInfo(i,t),r=ApiClient.getInstalledPlugins(),s=ApiClient.getPluginSecurityInfo();Promise.all([a,r,s]).then(function(i){n(i[0],i[1],i[2],e)})}).on("pagebeforeshow pageinit pageshow","#addPluginPage",function(){var i=this,t=getParameterByName("context");e(".notificationsTabs",i).hide(),"sync"==t?(i.setAttribute("data-helpurl","https://github.com/MediaBrowser/Wiki/wiki/Sync"),Dashboard.setPageTitle(Globalize.translate("TitleSync"))):"livetv"==t?(Dashboard.setPageTitle(Globalize.translate("TitleLiveTV")),i.setAttribute("data-helpurl","https://github.com/MediaBrowser/Wiki/wiki/Live%20TV")):"notifications"==t?(e(".notificationsTabs",i).show(),Dashboard.setPageTitle(Globalize.translate("TitleNotifications")),i.setAttribute("data-helpurl","https://github.com/MediaBrowser/Wiki/wiki/Notifications")):(i.setAttribute("data-helpurl","https://github.com/MediaBrowser/Wiki/wiki/Plugins"),Dashboard.setPageTitle(Globalize.translate("TitlePlugins")))}),window.AddPluginPage=new l});