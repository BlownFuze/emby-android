define(["jQuery"],function(e){function i(i,t){for(var a="",n=0,s=Math.min(i.versions.length,10);s>n;n++){var r=i.versions[n];a+='<h2 style="margin:.5em 0;">'+r.versionStr+" ("+r.classification+")</h2>",a+='<div style="margin-bottom:1.5em;">'+r.description+"</div>"}e("#revisionHistory",t).html(a)}function t(i,t,a){for(var n="",s=0,r=i.versions.length;r>s;s++){var l=i.versions[s];n+='<option value="'+l.versionStr+"|"+l.classification+'">'+l.versionStr+" ("+l.classification+")</option>"}var o=e("#selectVersion",t).html(n);a||e("#pCurrentVersion",t).hide().html("");var g=i.versions.filter(function(e){return"Release"==e.classification})[0];if(g||(g=i.versions.filter(function(e){return"Beta"==e.classification})[0]),g){var d=g.versionStr+"|"+g.classification;o.val(d)}}function a(i,t){ApiClient.getPackageReviews(i,null,null,3).then(function(i){var a="";if(i&&i.length>0){a+='<div data-role="collapsible" data-collapsed="true" style="margin-top: 2em;" >',a+="<h3>"+Globalize.translate("HeaderLatestReviews")+"</h3>",a+="<div><br/>";for(var n=0;n<i.length;n++){var s=i[n];a+="<div>",a+="<span class='storeItemReviewText'>",a+=new Date(s.timestamp).toDateString(),a+=" "+RatingHelpers.getStoreRatingHtml(s.rating,s.id,s.name,!0),a+=" "+s.title,a+="</span>",s.review&&(a+="<p class='storeItemReviewText'>",a+=s.review,a+="</p>"),a+="</div>",a+="<hr/>"}a+="</div>",a+="</div>"}e("#latestReviews",t).html(a).trigger("create")})}function n(n,s,r,l){var o=s.filter(function(e){return e.Name==n.name})[0];if(t(n,l,o),i(n,l),n.totalRatings>0&&a(n.id,l),e(".pluginName",l).html(n.name),"Server"==n.targetSystem)e("#btnInstallDiv",l).removeClass("hide"),e("#nonServerMsg",l).hide(),e("#pSelectVersion",l).removeClass("hide");else{e("#btnInstallDiv",l).addClass("hide"),e("#pSelectVersion",l).addClass("hide");var g=Globalize.translate("MessageInstallPluginFromApp");e("#nonServerMsg",l).html(g).show()}n.shortDescription?e("#tagline",l).show().html(n.shortDescription):e("#tagline",l).hide(),e("#overview",l).html(n.overview||""),e("#developer",l).html(n.owner),RegistrationServices.renderPluginInfo(l,n,r);var d=RatingHelpers.getStoreRatingHtml(n.avgRating,n.id,n.name);if(d+="<span class='storeReviewCount'>",d+=" "+Globalize.translate("ValueReviewCount").replace("{0}",n.totalRatings),d+="</span>",e("#ratingLine",l).html(d),n.richDescUrl?(e("#pViewWebsite",l).show(),e("#pViewWebsite a",l).attr("href",n.richDescUrl)):e("#pViewWebsite",l).hide(),n.previewImage||n.thumbImage){var h=n.tileColor||"#38c",u=n.previewImage?n.previewImage:n.thumbImage;e("#pPreviewImage",l).show().html("<img src='"+u+"' style='max-width: 100%;-moz-box-shadow: 0 0 20px 3px "+h+";-webkit-box-shadow: 0 0 20px 3px "+h+";box-shadow: 0 0 20px 3px "+h+";' />")}else e("#pPreviewImage",l).hide().html("");if(o){var m=Globalize.translate("MessageYouHaveVersionInstalled").replace("{0}","<strong>"+o.Version+"</strong>");e("#pCurrentVersion",l).show().html(m)}else e("#pCurrentVersion",l).hide().html("");Dashboard.hideLoadingMsg()}function s(i,t,a,n,s){var r=e("#developer",i).html().toLowerCase(),l=function(e){e&&(Dashboard.showLoadingMsg(),i.querySelector("#btnInstall").disabled=!0,ApiClient.installPlugin(t,a,n,s).then(function(){Dashboard.hideLoadingMsg()}))};if("luke"!=r&&"ebr"!=r){Dashboard.hideLoadingMsg();var o=Globalize.translate("MessagePluginInstallDisclaimer");o+="<br/>",o+="<br/>",o+=Globalize.translate("PleaseConfirmPluginInstallation"),require(["confirm"],function(e){e(o,Globalize.translate("HeaderConfirmPluginInstallation")).then(function(){l(!0)},function(){l(!1)})})}else l(!0)}function r(){var i=this;i.onSubmit=function(){Dashboard.showLoadingMsg();var i=e(this).parents("#addPluginPage")[0],t=getParameterByName("name"),a=getParameterByName("guid");return ApiClient.getInstalledPlugins().then(function(n){var r=n.filter(function(e){return e.Name==t})[0],l=e("#selectVersion",i).val().split("|"),o=l[0];r&&r.Version==o?(Dashboard.hideLoadingMsg(),Dashboard.alert({message:Globalize.translate("MessageAlreadyInstalled"),title:Globalize.translate("HeaderPluginInstallation")})):s(i,t,a,l[1],o)}),!1}}e(document).on("pageinit","#addPluginPage",function(){e(".addPluginForm").off("submit",AddPluginPage.onSubmit).on("submit",AddPluginPage.onSubmit)}).on("pageshow","#addPluginPage",function(){var e=this;Dashboard.showLoadingMsg();var i=getParameterByName("name"),t=getParameterByName("guid"),a=ApiClient.getPackageInfo(i,t),s=ApiClient.getInstalledPlugins(),r=ApiClient.getPluginSecurityInfo();Promise.all([a,s,r]).then(function(i){n(i[0],i[1],i[2],e)})}).on("pagebeforeshow pageinit pageshow","#addPluginPage",function(){var i=this,t=getParameterByName("context");e(".notificationsTabs",i).hide(),"sync"==t?(i.setAttribute("data-helpurl","https://github.com/MediaBrowser/Wiki/wiki/Sync"),Dashboard.setPageTitle(Globalize.translate("TitleSync"))):"livetv"==t?(Dashboard.setPageTitle(Globalize.translate("TitleLiveTV")),i.setAttribute("data-helpurl","https://github.com/MediaBrowser/Wiki/wiki/Live%20TV")):"notifications"==t?(e(".notificationsTabs",i).show(),Dashboard.setPageTitle(Globalize.translate("TitleNotifications")),i.setAttribute("data-helpurl","https://github.com/MediaBrowser/Wiki/wiki/Notifications")):(i.setAttribute("data-helpurl","https://github.com/MediaBrowser/Wiki/wiki/Plugins"),Dashboard.setPageTitle(Globalize.translate("TitlePlugins")))}),window.AddPluginPage=new r});