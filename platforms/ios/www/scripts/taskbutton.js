define(["appStorage"],function(e){$.fn.taskButton=function(t){function n(e){ApiClient.getScheduledTasks({IsEnabled:!0}).then(function(t){a(e,t)})}function a(e,n){var a=n.filter(function(e){return e.Key==t.taskKey})[0];if(t.panel&&(a?$(t.panel).show():$(t.panel).hide()),a){"Idle"==a.State?$(e).removeAttr("disabled"):$(e).attr("disabled","disabled"),$(e).attr("data-taskid",a.Id);var s=(a.CurrentProgressPercentage||0).toFixed(1);if(t.progressElem&&(t.progressElem.value=s,"Running"==a.State?t.progressElem.classList.remove("hide"):t.progressElem.classList.add("hide")),t.lastResultElem){var l=a.LastExecutionResult?a.LastExecutionResult.Status:"";t.lastResultElem.html("Failed"==l?'<span style="color:#FF0000;">'+Globalize.translate("LabelFailed")+"</span>":"Cancelled"==l?'<span style="color:#0026FF;">'+Globalize.translate("LabelCancelled")+"</span>":"Aborted"==l?'<span style="color:#FF0000;">'+Globalize.translate("LabelAbortedByServerShutdown")+"</span>":l)}}}function s(e,t){ApiClient.startScheduledTask(t).then(function(){n(e)})}function l(){var n=this,a=n.getAttribute("data-taskid"),l="scheduledTaskButton"+t.taskKey,i=(new Date).getMonth()+"5";if(e.getItem(l)==i)s(n,a);else{var o=Globalize.translate("ConfirmMessageScheduledTaskButton");o+="<br/>",o+='<div style="margin-top:1em;">',o+='<a class="clearLink" href="scheduledtasks.html"><paper-button style="color:#3f51b5!important;margin:0;">'+Globalize.translate("ButtonScheduledTasks")+"</paper-button></a>",o+="</div>",require(["confirm"],function(t){t(o,Globalize.translate("HeaderConfirmation")).then(function(){e.setItem(l,i),s(n,a)})})}}function i(){c()}function o(e,t){if("ScheduledTasksInfo"==t.MessageType){var n=t.Data;a(p,n)}}function r(){ApiClient.isWebSocketOpen()||n(p)}function c(){ApiClient.isWebSocketOpen()&&ApiClient.sendWebSocketMessage("ScheduledTasksInfoStart","1000,1000"),u&&clearInterval(u),u=setInterval(r,5e3)}function d(){ApiClient.isWebSocketOpen()&&ApiClient.sendWebSocketMessage("ScheduledTasksInfoStop"),u&&clearInterval(u)}var u,p=this;return t.panel&&$(t.panel).hide(),"off"==t.mode?(this.off("click",l),Events.off(ApiClient,"websocketmessage",o),Events.off(ApiClient,"websocketopen",i),d()):this.length&&(this.on("click",l),n(p),c(),Events.on(ApiClient,"websocketmessage",o),Events.on(ApiClient,"websocketopen",i)),this}});