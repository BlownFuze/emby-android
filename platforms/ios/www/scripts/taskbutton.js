define(["appStorage","jQuery","emby-button"],function(e,t){t.fn.taskButton=function(n){function s(e){ApiClient.getScheduledTasks({IsEnabled:!0}).then(function(t){a(e,t)})}function a(e,s){var a=s.filter(function(e){return e.Key==n.taskKey})[0];if(n.panel&&(a?n.panel.classList.remove("hide"):n.panel.classList.add("hide")),a){"Idle"==a.State?t(e).removeAttr("disabled"):t(e).attr("disabled","disabled"),t(e).attr("data-taskid",a.Id);var l=(a.CurrentProgressPercentage||0).toFixed(1);if(n.progressElem&&(n.progressElem.value=l,"Running"==a.State?n.progressElem.classList.remove("hide"):n.progressElem.classList.add("hide")),n.lastResultElem){var i=a.LastExecutionResult?a.LastExecutionResult.Status:"";n.lastResultElem.html("Failed"==i?'<span style="color:#FF0000;">('+Globalize.translate("LabelFailed")+")</span>":"Cancelled"==i?'<span style="color:#0026FF;">('+Globalize.translate("LabelCancelled")+")</span>":"Aborted"==i?'<span style="color:#FF0000;">'+Globalize.translate("LabelAbortedByServerShutdown")+"</span>":i)}}}function l(e,t){ApiClient.startScheduledTask(t).then(function(){s(e)})}function i(){var t=this,s=t.getAttribute("data-taskid"),a="scheduledTaskButton"+n.taskKey,i=(new Date).getMonth()+"6";if(e.getItem(a)==i)l(t,s);else{var o=Globalize.translate("ConfirmMessageScheduledTaskButton");o+="<br/>",o+='<div style="margin-top:1em;">',o+='<a class="clearLink" href="scheduledtasks.html"><button is="emby-button" type="button" style="color:#3f51b5!important;margin:0;">'+Globalize.translate("ButtonScheduledTasks")+"</button></a>",o+="</div>",require(["confirm"],function(n){n({title:Globalize.translate("HeaderConfirmation"),html:o,text:Globalize.translate("ConfirmMessageScheduledTaskButton")+"\n\n"+Globalize.translate("ButtonScheduledTasks")}).then(function(){e.setItem(a,i),l(t,s)})})}}function o(){c()}function r(e,t){if("ScheduledTasksInfo"==t.MessageType){var n=t.Data;a(p,n)}}function d(){ApiClient.isWebSocketOpen()||s(p)}function c(){ApiClient.isWebSocketOpen()&&ApiClient.sendWebSocketMessage("ScheduledTasksInfoStart","1000,1000"),f&&clearInterval(f),f=setInterval(d,5e3)}function u(){ApiClient.isWebSocketOpen()&&ApiClient.sendWebSocketMessage("ScheduledTasksInfoStop"),f&&clearInterval(f)}var f,p=this;return n.panel&&n.panel.classList.add("hide"),"off"==n.mode?(this.off("click",i),Events.off(ApiClient,"websocketmessage",r),Events.off(ApiClient,"websocketopen",o),u()):this.length&&(this.on("click",i),s(p),c(),Events.on(ApiClient,"websocketmessage",r),Events.on(ApiClient,"websocketopen",o)),this}});