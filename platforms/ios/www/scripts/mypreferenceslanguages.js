define(["appSettings","userSettingsBuilder"],function(e,t){function a(e,t){var a="";a+="<option value=''></option>";for(var r=0,n=t.length;n>r;r++){var o=t[r];a+="<option value='"+o.ThreeLetterISOLanguageName+"'>"+o.DisplayName+"</option>"}e.innerHTML=a}return function(r,n){function o(t,r,n,o){o.then(function(e){a(t.querySelector("#selectAudioLanguage"),e),a(t.querySelector("#selectSubtitleLanguage"),e),t.querySelector("#selectAudioLanguage",t).value=r.Configuration.AudioLanguagePreference||"",t.querySelector("#selectSubtitleLanguage",t).value=r.Configuration.SubtitleLanguagePreference||"",t.querySelector(".chkEpisodeAutoPlay").checked=r.Configuration.EnableNextEpisodeAutoPlay||!1}),t.querySelector("#selectSubtitlePlaybackMode").value=r.Configuration.SubtitleMode||"",t.querySelector(".chkPlayDefaultAudioTrack").checked=r.Configuration.PlayDefaultAudioTrack||!1,t.querySelector(".chkEnableCinemaMode").checked=s.enableCinemaMode(),t.querySelector(".chkExternalVideoPlayer").checked=e.enableExternalPlayers(),require(["qualityoptions"],function(a){var r=a.getVideoQualityOptions(e.maxStreamingBitrate()).map(function(e){return'<option value="'+e.bitrate+'">'+e.name+"</option>"}).join("");r='<option value="">'+Globalize.translate("OptionAutomatic")+"</option>"+r,t.querySelector("#selectMaxBitrate").innerHTML=r,t.querySelector("#selectMaxChromecastBitrate").innerHTML=r,t.querySelector("#selectMaxBitrate").value=e.enableAutomaticBitrateDetection()?"":e.maxStreamingBitrate(),t.querySelector("#selectMaxChromecastBitrate").value=e.maxChromecastBitrate()||"",Dashboard.hideLoadingMsg()})}function i(e){Dashboard.showLoadingMsg();var t=ApiClient.getUser(c),a=Dashboard.getCurrentUser(),r=ApiClient.getCultures();Promise.all([t,a]).then(function(t){o(e,t[1],t[0],r)}),ApiClient.getNamedConfiguration("cinemamode").then(function(t){t.EnableIntrosForMovies||t.EnableIntrosForEpisodes?e.querySelector(".cinemaModeOptions").classList.remove("hide"):e.querySelector(".cinemaModeOptions").classList.add("hide")})}function l(e,t){return t.Configuration.AudioLanguagePreference=e.querySelector("#selectAudioLanguage").value,t.Configuration.SubtitleLanguagePreference=e.querySelector("#selectSubtitleLanguage").value,t.Configuration.SubtitleMode=e.querySelector("#selectSubtitlePlaybackMode").value,t.Configuration.PlayDefaultAudioTrack=e.querySelector(".chkPlayDefaultAudioTrack").checked,t.Configuration.EnableNextEpisodeAutoPlay=e.querySelector(".chkEpisodeAutoPlay").checked,s.enableCinemaMode(e.querySelector(".chkEnableCinemaMode").checked),ApiClient.updateUserConfiguration(t.Id,t.Configuration)}function u(t){e.enableExternalPlayers(t.querySelector(".chkExternalVideoPlayer").checked),t.querySelector("#selectMaxBitrate").value?(e.maxStreamingBitrate(t.querySelector("#selectMaxBitrate").value),e.enableAutomaticBitrateDetection(!1)):e.enableAutomaticBitrateDetection(!0),e.maxChromecastBitrate(t.querySelector("#selectMaxChromecastBitrate").value),AppInfo.enableAutoSave||Dashboard.showLoadingMsg(),ApiClient.getUser(c).then(function(e){l(t,e).then(function(){Dashboard.hideLoadingMsg(),AppInfo.enableAutoSave||require(["toast"],function(e){e(Globalize.translate("SettingsSaved"))})},function(){Dashboard.hideLoadingMsg()})})}var c=n.userId||Dashboard.getCurrentUserId(),s=new t(c);r.querySelector("#selectSubtitlePlaybackMode").addEventListener("change",function(){for(var e=r.querySelectorAll(".subtitlesHelp"),t=0,a=e.length;a>t;t++)e[t].classList.add("hide");r.querySelector(".subtitles"+this.value+"Help").classList.remove("hide")}),r.querySelector(".languagePreferencesForm").addEventListener("submit",function(e){return u(r),e.preventDefault(),!1}),AppInfo.enableAutoSave?r.querySelector(".btnSave").classList.add("hide"):r.querySelector(".btnSave").classList.remove("hide"),r.addEventListener("viewshow",function(){AppInfo.supportsExternalPlayers?r.querySelector(".fldExternalPlayer").classList.remove("hide"):r.querySelector(".fldExternalPlayer").classList.add("hide"),AppInfo.supportsExternalPlayerMenu?(r.querySelector(".labelNativeExternalPlayers").classList.remove("hide"),r.querySelector(".labelGenericExternalPlayers").classList.add("hide")):(r.querySelector(".labelGenericExternalPlayers").classList.remove("hide"),r.querySelector(".labelNativeExternalPlayers").classList.add("hide")),i(r)}),r.addEventListener("viewbeforehide",function(){var e=this;AppInfo.enableAutoSave&&u(e)})}});