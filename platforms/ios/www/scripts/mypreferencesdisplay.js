define(["userSettingsBuilder","appStorage"],function(e,n){return function(s,a){function i(e,s){e.querySelector(".chkDisplayMissingEpisodes").checked=s.Configuration.DisplayMissingEpisodes||!1,e.querySelector(".chkDisplayUnairedEpisodes").checked=s.Configuration.DisplayUnairedEpisodes||!1,e.querySelector("#selectThemeSong").value=n.getItem("enableThemeSongs-"+s.Id)||"",e.querySelector("#selectBackdrop").value=n.getItem("enableBackdrops-"+s.Id)||"",e.querySelector("#selectLanguage").value=l.language()||"",Dashboard.hideLoadingMsg()}function t(e,s){return s.Configuration.DisplayMissingEpisodes=e.querySelector(".chkDisplayMissingEpisodes").checked,s.Configuration.DisplayUnairedEpisodes=e.querySelector(".chkDisplayUnairedEpisodes").checked,l.language(e.querySelector("#selectLanguage").value),n.setItem("enableThemeSongs-"+s.Id,e.querySelector("#selectThemeSong").value),n.setItem("enableBackdrops-"+s.Id,e.querySelector("#selectBackdrop").value),ApiClient.updateUserConfiguration(s.Id,s.Configuration)}function r(e){AppInfo.enableAutoSave||Dashboard.showLoadingMsg(),ApiClient.getUser(o).then(function(n){t(e,n).then(function(){Dashboard.hideLoadingMsg(),AppInfo.enableAutoSave||require(["toast"],function(e){e(Globalize.translate("SettingsSaved"))})},function(){Dashboard.hideLoadingMsg()})})}var o=a.userId||Dashboard.getCurrentUserId(),l=new e(o);s.querySelector(".displayPreferencesForm").addEventListener("submit",function(e){return r(s),e.preventDefault(),!1}),AppInfo.enableAutoSave?s.querySelector(".btnSave").classList.add("hide"):s.querySelector(".btnSave").classList.remove("hide"),s.addEventListener("viewshow",function(){var e=this;Dashboard.showLoadingMsg(),ApiClient.getUser(o).then(function(n){i(e,n);for(var a=s.querySelectorAll(".requiresUserPreferences"),t=0,r=a.length;r>t;t++)n.Policy.EnableUserPreferenceAccess?a[t].classList.remove("hide"):a[t].classList.add("hide")}),AppInfo.supportsUserDisplayLanguageSetting?e.querySelector(".languageSection").classList.remove("hide"):e.querySelector(".languageSection").classList.add("hide")}),s.addEventListener("viewbeforehide",function(){var e=this;AppInfo.enableAutoSave&&r(e)})}});