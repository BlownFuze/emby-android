!function(e,t,s){function n(){return p?new Promise(function(e){e(p)}):ApiClient.getJSON(ApiClient.getUrl("System/Endpoint")).then(function(e){return p=e,e})}function i(){function e(){var e=t.lastPlayerData||{};return e=e.PlayState||{},null==e.VolumeLevel?100:e.VolumeLevel}var t=this;t.name=c,t.getItemsForPlayback=function(e){var t=Dashboard.getCurrentUserId();return e.Ids&&1==e.Ids.split(",").length?new Promise(function(s){ApiClient.getItem(t,e.Ids.split(",")).then(function(e){s({Items:[e],TotalRecordCount:1})})}):(e.Limit=e.Limit||100,e.ExcludeLocationTypes="Virtual",ApiClient.getItems(t,e))},Events.on(m,"connect",function(){MediaController.setActivePlayer(c,t.getCurrentTargetInfo()),s.log("cc: connect"),t.lastPlayerData={}}),Events.on(m,"playbackstart",function(e,n){s.log("cc: playbackstart"),m.initializeCastPlayer();var i=t.getPlayerStateInternal(n);Events.trigger(t,"playbackstart",[i])}),Events.on(m,"playbackstop",function(e,n){s.log("cc: playbackstop");var i=t.getPlayerStateInternal(n);Events.trigger(t,"playbackstop",[i]),t.lastPlayerData={}}),Events.on(m,"playbackprogress",function(e,n){s.log("cc: positionchange");var i=t.getPlayerStateInternal(n);Events.trigger(t,"positionchange",[i])}),t.play=function(e){Dashboard.getCurrentUser().then(function(){e.items?t.playWithCommand(e,"PlayNow"):t.getItemsForPlayback({Ids:e.ids.join(",")}).then(function(s){e.items=s.Items,t.playWithCommand(e,"PlayNow")})})},t.playWithCommand=function(e,s){return e.items?void m.loadMedia(e,s):void ApiClient.getItem(Dashboard.getCurrentUserId(),e.ids[0]).then(function(n){e.items=[n],t.playWithCommand(e,s)})},t.unpause=function(){m.sendMessage({options:{},command:"Unpause"})},t.pause=function(){m.sendMessage({options:{},command:"Pause"})},t.shuffle=function(e){var s=Dashboard.getCurrentUserId();ApiClient.getItem(s,e).then(function(e){t.playWithCommand({items:[e]},"Shuffle")})},t.instantMix=function(e){var s=Dashboard.getCurrentUserId();ApiClient.getItem(s,e).then(function(e){t.playWithCommand({items:[e]},"InstantMix")})},t.canQueueMediaType=function(e){return"Audio"==e},t.queue=function(e){t.playWithCommnd(e,"PlayLast")},t.queueNext=function(e){t.playWithCommand(e,"PlayNext")},t.stop=function(){m.sendMessage({options:{},command:"Stop"})},t.displayContent=function(e){m.sendMessage({options:e,command:"DisplayContent"})},t.mute=function(){m.sendMessage({options:{},command:"Mute"})},t.unMute=function(){t.setVolume(e()+2)},t.setRepeatMode=function(e){m.sendMessage({options:{RepeatMode:e},command:"SetRepeatMode"})},t.toggleMute=function(){var e=t.lastPlayerData||{};e=e.PlayState||{},e.IsMuted?t.unMute():t.mute()},t.getTargets=function(){var e=[];return m.hasReceivers&&e.push(t.getCurrentTargetInfo()),e},t.getCurrentTargetInfo=function(){var e=null;return m.session&&m.session.receiver&&m.session.receiver.friendlyName&&(e=m.session.receiver.friendlyName),{name:c,id:c,playerName:c,playableMediaTypes:["Audio","Video"],isLocalPlayer:!1,appName:c,deviceName:e,supportedCommands:["VolumeUp","VolumeDown","Mute","Unmute","ToggleMute","SetVolume","SetAudioStreamIndex","SetSubtitleStreamIndex","DisplayContent","SetRepeatMode","EndSession"]}},t.seek=function(e){e=parseInt(e),e/=1e7,m.sendMessage({options:{position:e},command:"Seek"})},t.setAudioStreamIndex=function(e){m.sendMessage({options:{index:e},command:"SetAudioStreamIndex"})},t.setSubtitleStreamIndex=function(e){m.sendMessage({options:{index:e},command:"SetSubtitleStreamIndex"})},t.nextTrack=function(){m.sendMessage({options:{},command:"NextTrack"})},t.previousTrack=function(){m.sendMessage({options:{},command:"PreviousTrack"})},t.beginPlayerUpdates=function(){},t.endPlayerUpdates=function(){},t.volumeDown=function(){m.sendMessage({options:{},command:"VolumeDown"})},t.endSession=function(){t.stop(),setTimeout(function(){m.stopApp()},1e3)},t.volumeUp=function(){m.sendMessage({options:{},command:"VolumeUp"})},t.setVolume=function(e){e=Math.min(e,100),e=Math.max(e,0),m.sendMessage({options:{volume:e},command:"SetVolume"})},t.getPlayerState=function(){return new Promise(function(e){var s=t.getPlayerStateInternal();e(s)})},t.lastPlayerData={},t.getPlayerStateInternal=function(e){return e=e||t.lastPlayerData,t.lastPlayerData=e,s.log(JSON.stringify(e)),e},t.tryPair=function(){return new Promise(function(e){e()})}}function o(){m=new u,MediaController.registerPlayer(new i),Events.on(MediaController,"playerchange",function(e,t){t.name==c&&m.deviceState!=a.ACTIVE&&m.isInitialized&&m.launchApp()})}var a={IDLE:0,ACTIVE:1,WARNING:2,ERROR:3},r={IDLE:"IDLE",LOADING:"LOADING",LOADED:"LOADED",PLAYING:"PLAYING",PAUSED:"PAUSED",STOPPED:"STOPPED",SEEKING:"SEEKING",ERROR:"ERROR"},c="Chromecast",d="2D4B1DA3",l="urn:x-cast:com.connectsdk",u=function(){this.deviceState=a.IDLE,this.currentMediaSession=null,this.session=null,this.castPlayerState=r.IDLE,this.hasReceivers=!1,this.errorHandler=this.onError.bind(this),this.mediaStatusUpdateHandler=this.onMediaStatusUpdate.bind(this),this.initializeCastPlayer()};u.prototype.initializeCastPlayer=function(){if(t){if(!t.cast||!t.cast.isAvailable)return void setTimeout(this.initializeCastPlayer.bind(this),1e3);var e=new t.cast.SessionRequest(d),n=new t.cast.ApiConfig(e,this.sessionListener.bind(this),this.receiverListener.bind(this));s.log("chromecast.initialize"),t.cast.initialize(n,this.onInitSuccess.bind(this),this.errorHandler)}},u.prototype.onInitSuccess=function(){this.isInitialized=!0,s.log("chromecast init success")},u.prototype.onError=function(){s.log("chromecast error")},u.prototype.sessionListener=function(e){this.session=e,this.session&&(s.log("sessionListener "+JSON.stringify(e)),this.session.media[0]&&this.onMediaDiscovered("activeSession",this.session.media[0]),this.onSessionConnected(e))},u.prototype.messageListener=function(e,t){if(t=JSON.parse(t),"playbackerror"==t.type){var s=t.data;setTimeout(function(){Dashboard.alert({message:Globalize.translate("MessagePlaybackError"+s),title:Globalize.translate("HeaderPlaybackError")})},300)}else"connectionerror"==t.type?setTimeout(function(){Dashboard.alert({message:Globalize.translate("MessageChromecastConnectionError"),title:Globalize.translate("HeaderError")})},300):t.type&&0==t.type.indexOf("playback")&&Events.trigger(this,t.type,[t.data])},u.prototype.receiverListener=function(e){"available"===e?(s.log("chromecast receiver found"),this.hasReceivers=!0):(s.log("chromecast receiver list empty"),this.hasReceivers=!1)},u.prototype.sessionUpdateListener=function(e){s.log("sessionUpdateListener alive: "+e),e||(this.session=null,this.deviceState=a.IDLE,this.castPlayerState=r.IDLE,s.log("sessionUpdateListener: setting currentMediaSession to null"),this.currentMediaSession=null,MediaController.removeActivePlayer(c))},u.prototype.launchApp=function(){s.log("chromecast launching app..."),t.cast.requestSession(this.onRequestSessionSuccess.bind(this),this.onLaunchError.bind(this))},u.prototype.onRequestSessionSuccess=function(e){s.log("chromecast session success: "+e.sessionId),this.onSessionConnected(e)},u.prototype.onSessionConnected=function(e){this.session=e,this.deviceState=a.ACTIVE,this.session.addMessageListener(l,this.messageListener.bind(this)),this.session.addMediaListener(this.sessionMediaListener.bind(this)),this.session.addUpdateListener(this.sessionUpdateListener.bind(this)),Events.trigger(this,"connect"),this.sendMessage({options:{},command:"Identify"})},u.prototype.sessionMediaListener=function(e){s.log("sessionMediaListener"),this.currentMediaSession=e,this.currentMediaSession.addUpdateListener(this.mediaStatusUpdateHandler)},u.prototype.onLaunchError=function(){s.log("chromecast launch error"),this.deviceState=a.ERROR,MediaController.removeActivePlayer(c)},u.prototype.stopApp=function(){this.session&&this.session.stop(this.onStopAppSuccess.bind(this,"Session stopped"),this.errorHandler)},u.prototype.onStopAppSuccess=function(e){s.log(e),this.deviceState=a.IDLE,this.castPlayerState=r.IDLE,s.log("onStopAppSuccess: setting currentMediaSession to null"),this.currentMediaSession=null},u.prototype.loadMedia=function(e,t){return this.session?(e.items=e.items.map(function(e){return{Id:e.Id,Name:e.Name,Type:e.Type,MediaType:e.MediaType,IsFolder:e.IsFolder}}),void this.sendMessage({options:e,command:t})):void s.log("no session")};var p;u.prototype.sendMessage=function(e){var t=this,s=AppSettings.maxChromecastBitrate(),i=null;m.session&&m.session.receiver&&m.session.receiver.friendlyName&&(i=m.session.receiver.friendlyName),e=$.extend(e,{userId:Dashboard.getCurrentUserId(),deviceId:ApiClient.deviceId(),accessToken:ApiClient.accessToken(),serverAddress:ApiClient.serverAddress(),maxBitrate:s,receiverName:i,supportsAc3:AppSettings.enableChromecastAc3()}),n().then(function(s){s.IsInNetwork?ApiClient.getPublicSystemInfo().then(function(s){e.serverAddress=s.LocalAddress,t.sendMessageInternal(e)}):t.sendMessageInternal(e)})},u.prototype.sendMessageInternal=function(e){e=JSON.stringify(e),this.session.sendMessage(l,e,this.onPlayCommandSuccess.bind(this),this.errorHandler)},u.prototype.onPlayCommandSuccess=function(){s.log("Message was sent to receiver ok.")},u.prototype.onMediaDiscovered=function(e,t){s.log("chromecast new media session ID:"+t.mediaSessionId+" ("+e+")"),this.currentMediaSession=t,"loadMedia"==e&&(this.castPlayerState=r.PLAYING),"activeSession"==e&&(this.castPlayerState=t.playerState),this.currentMediaSession.addUpdateListener(this.mediaStatusUpdateHandler)},u.prototype.onMediaStatusUpdate=function(e){0==e&&(this.castPlayerState=r.IDLE),s.log("chromecast updating media: "+e)},u.prototype.setReceiverVolume=function(e,t){return this.currentMediaSession?void(e?this.session.setReceiverMuted(!0,this.mediaCommandSuccessCallback.bind(this),this.errorHandler):this.session.setReceiverVolumeLevel(t||1,this.mediaCommandSuccessCallback.bind(this),this.errorHandler)):void s.log("this.currentMediaSession is null")},u.prototype.mute=function(){this.setReceiverVolume(!0)},u.prototype.mediaCommandSuccessCallback=function(e){s.log(e)};var m;requirejs(["https://www.gstatic.com/cv/js/sender/v1/cast_sender.js"],o)}(window,window.chrome,console);