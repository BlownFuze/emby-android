define(["appSettings","cardStyle","emby-checkbox"],function(e){function a(){var e=getParameterByName("serverid");return e?ConnectionManager.getOrCreateApiClient(e):ApiClient}function t(){Dashboard.alert({message:Globalize.translate("MessageUnableToConnectToServer"),title:Globalize.translate("HeaderConnectionFailure")})}function r(a,t,r){a.querySelector(".chkRememberLogin").checked=e.enableAutoLogin(),a.querySelector(".manualLoginForm").classList.remove("hide"),a.querySelector(".visualLoginForm").classList.add("hide"),r?a.querySelector("#txtManualPassword").focus():a.querySelector("#txtManualName").focus(),t?a.querySelector(".btnCancel").classList.remove("hide"):a.querySelector(".btnCancel").classList.add("hide")}function n(){var e=Math.floor(Math.random()*(d.length-1));return d[e]}function o(e){if(e){for(var a=String(e.substr(0,1).charCodeAt()),t=0,r=0;r<a.length;r++)t+=parseInt(a.charAt(r));var o=String(t).substr(-1);return d[o]}return n()}function s(e,a,t){for(var r="",n=0,s=t.length;s>n;n++){var i=t[n];r+='<div class="card squareCard scalableCard"><div class="cardBox cardBox-bottompadded visualCardBox">',r+='<div class="cardScalable visualCardBox-cardScalable">',r+='<div class="cardPadder cardPadder-square"></div>',r+='<a class="cardContent" href="#" data-ajax="false" data-haspw="'+i.HasPassword+'" data-username="'+i.Name+'" data-userid="'+i.Id+'">';var d;if(i.PrimaryImageTag)d=a.getUserImageUrl(i.Id,{width:300,tag:i.PrimaryImageTag,type:"Primary"}),r+='<div class="cardImageContainer coveredImage coveredImage-noScale" style="background-image:url(\''+d+"');\"></div>";else{var l=o(i.Id);d="css/images/logindefault.png",r+='<div class="cardImageContainer coveredImage coveredImage-noScale" style="background-image:url(\''+d+"');background-color:"+l+';"></div>'}r+="</a>",r+="</div>",r+='<div class="cardFooter visualCardBox-cardFooter">',r+='<div class="cardText">'+i.Name+"</div>",r+='<div class="cardText cardText-secondary">';var u=c.getLastSeenText(i.LastActivityDate);r+=""!=u?u:"&nbsp;",r+="</div>",r+="</div>",r+="</div>",r+="</div>"}e.querySelector("#divUsers").innerHTML=r}function i(e,a){for(;!e.classList||!e.classList.contains(a);)if(e=e.parentNode,!e)return null;return e}var c={showVisualForm:function(e){e.querySelector(".visualLoginForm").classList.remove("hide"),e.querySelector(".manualLoginForm").classList.add("hide")},getLastSeenText:function(e){return e?"Last seen "+humane_date(e):""},authenticateUserByName:function(e,a,r,n){Dashboard.showLoadingMsg(),a.authenticateUserByName(r,n).then(function(e){var t,r=e.User,n=getParameterByName("serverid");t=r.Policy.IsAdministrator&&!n?"dashboard.html":"home.html",Dashboard.hideLoadingMsg(),Dashboard.onServerChanged(r.Id,e.AccessToken,a),Dashboard.navigate(t)},function(a){e.querySelector("#txtManualName").value="",e.querySelector("#txtManualPassword").value="",Dashboard.hideLoadingMsg(),401==a.status?require(["toast"],function(e){e(Globalize.translate("MessageInvalidUser"))}):t()})}},d=["#6FBD45","#4BB3DD","#4164A5","#E12026","#800080","#E1B222","#008040","#0094FF","#FF00C7","#FF870F","#7F0037"];return function(t){t.querySelector("#divUsers").addEventListener("click",function(e){var n=i(e.target,"cardContent");if(n){var o=t,s=n.getAttribute("data-userid"),d=n.getAttribute("data-username"),l=n.getAttribute("data-haspw");"manual"==s?(o.querySelector("#txtManualName").value="",r(o,!0)):"false"==l?c.authenticateUserByName(o,a(),d,""):(o.querySelector("#txtManualName").value=d,o.querySelector("#txtManualPassword").value="",r(o,!0,!0))}}),t.querySelector(".manualLoginForm").addEventListener("submit",function(r){e.enableAutoLogin(t.querySelector(".chkRememberLogin").checked);var n=a();return c.authenticateUserByName(t,n,t.querySelector("#txtManualName").value,t.querySelector("#txtManualPassword").value),r.preventDefault(),!1}),t.querySelector(".btnForgotPassword").addEventListener("click",function(){Dashboard.navigate("forgotpassword.html")}),t.querySelector(".btnCancel").addEventListener("click",function(){c.showVisualForm(t)}),t.querySelector(".btnManual").addEventListener("click",function(){t.querySelector("#txtManualName").value="",r(t,!0)}),t.addEventListener("viewshow",function(){Dashboard.showLoadingMsg();var e=a();e.getPublicUsers().then(function(a){a.length?(c.showVisualForm(t),s(t,e,a)):(t.querySelector("#txtManualName").value="",r(t,!1,!1)),Dashboard.hideLoadingMsg()}),e.getJSON(e.getUrl("Branding/Configuration")).then(function(e){t.querySelector(".disclaimer").innerHTML=e.LoginDisclaimer||""}),Dashboard.isConnectMode()?t.querySelector(".connectButtons").classList.remove("hide"):t.querySelector(".connectButtons").classList.add("hide")})}});