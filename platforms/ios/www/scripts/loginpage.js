define(["jQuery"],function(a){function e(){Dashboard.alert({message:Globalize.translate("MessageUnableToConnectToServer"),title:Globalize.translate("HeaderConnectionFailure")})}function t(){var a=getParameterByName("serverid");return Promise.resolve(a?ConnectionManager.getOrCreateApiClient(a):ApiClient)}function n(){var e=a(this).parents(".page");return t().then(function(t){i.authenticateUserByName(e,t,a("#txtManualName",e).val(),a("#txtManualPassword",e).val())}),!1}function r(e,t,n){a(".visualLoginForm",e).hide(),a(".manualLoginForm",e).show(),n?a("#txtManualPassword",e).focus():a("#txtManualName",e).focus(),t?a(".btnCancel",e).show():a(".btnCancel",e).hide()}function s(e,t,n){for(var s="",o=0,d=n.length;d>o;o++){var l=n[o];s+='<div class="card squareCard bottomPaddedCard"><div class="cardBox visualCardBox">',s+='<div class="cardScalable">',s+='<div class="cardPadder"></div>',s+='<a class="cardContent" href="#" data-ajax="false" data-haspw="'+l.HasPassword+'" data-username="'+l.Name+'" data-userid="'+l.Id+'">';var c;if(l.PrimaryImageTag)c=t.getUserImageUrl(l.Id,{width:300,tag:l.PrimaryImageTag,type:"Primary"}),s+='<div class="cardImage" style="background-image:url(\''+c+"');\"></div>";else{var u=LibraryBrowser.getMetroColor(l.Id);c="css/images/logindefault.png",s+='<div class="cardImage" style="background-image:url(\''+c+"');background-color:"+u+';"></div>'}s+="</a>",s+="</div>",s+='<div class="cardFooter">',s+='<div class="cardText">'+l.Name+"</div>",s+='<div class="cardText">';var g=i.getLastSeenText(l.LastActivityDate);s+=""!=g?g:"&nbsp;",s+="</div>",s+="</div>",s+="</div>",s+="</div>"}var h=a("#divUsers",e).html(s);a("a",h).on("click",function(){var n=this.getAttribute("data-userid"),s=this.getAttribute("data-username"),o=this.getAttribute("data-haspw");"manual"==n?r(e,!0):"false"==o?i.authenticateUserByName(e,t,s,""):(a("#txtManualName",e).val(s),a("#txtManualPassword",e).val(""),r(e,!0,!0))})}var i={showVisualForm:function(e){a(".visualLoginForm",e).show(),a(".manualLoginForm",e).hide()},getLastSeenText:function(a){return a?"Last seen "+humane_date(a):""},authenticateUserByName:function(t,n,r,s){Dashboard.showLoadingMsg(),n.authenticateUserByName(r,s).then(function(a){var e,t=a.User,r=getParameterByName("serverid");e=t.Policy.IsAdministrator&&!r?"dashboard.html":"home.html",Dashboard.hideLoadingMsg(),Dashboard.onServerChanged(t.Id,a.AccessToken,n),Dashboard.navigate(e)},function(n){a("#pw",t).val(""),a("#txtManualName",t).val(""),a("#txtManualPassword",t).val(""),Dashboard.hideLoadingMsg(),401==n.status?require(["toast"],function(a){a(Globalize.translate("MessageInvalidUser"))}):e()})}};return function(e){a(".manualLoginForm",e).on("submit",n),e.querySelector(".btnForgotPassword").addEventListener("click",function(){Dashboard.navigate("forgotpassword.html")}),e.querySelector(".btnCancel").addEventListener("click",function(){i.showVisualForm(e)}),e.querySelector(".btnManual").addEventListener("click",function(){r(e,!0)}),e.addEventListener("viewshow",function(){Dashboard.showLoadingMsg(),t().then(function(t){t.getPublicUsers().then(function(a){a.length?(i.showVisualForm(e),s(e,t,a)):r(e,!1,!1),Dashboard.hideLoadingMsg()}),t.getJSON(t.getUrl("Branding/Configuration")).then(function(t){a(".disclaimer",e).html(t.LoginDisclaimer||"")})}),Dashboard.isConnectMode()?a(".connectButtons",e).show():a(".connectButtons",e).hide()})}});