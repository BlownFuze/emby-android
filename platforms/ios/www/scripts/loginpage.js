define(["appSettings","dom","connectionManager","cardStyle","emby-checkbox"],function(e,a,r){function t(e,a,r,t){Dashboard.showLoadingMsg(),a.authenticateUserByName(r,t).then(function(e){var r,t=e.User,n=getParameterByName("serverid");r=t.Policy.IsAdministrator&&!n?"dashboard.html":"home.html",Dashboard.hideLoadingMsg(),Dashboard.onServerChanged(t.Id,e.AccessToken,a),Dashboard.navigate(r)},function(a){e.querySelector("#txtManualName").value="",e.querySelector("#txtManualPassword").value="",Dashboard.hideLoadingMsg(),401==a.status?require(["toast"],function(e){e(Globalize.translate("MessageInvalidUser"))}):n()})}function n(){Dashboard.alert({message:Globalize.translate("MessageUnableToConnectToServer"),title:Globalize.translate("HeaderConnectionFailure")})}function o(a,r,t){a.querySelector(".chkRememberLogin").checked=e.enableAutoLogin(),a.querySelector(".manualLoginForm").classList.remove("hide"),a.querySelector(".visualLoginForm").classList.add("hide"),t?a.querySelector("#txtManualPassword").focus():a.querySelector("#txtManualName").focus(),r?a.querySelector(".btnCancel").classList.remove("hide"):a.querySelector(".btnCancel").classList.add("hide")}function s(){var e=Math.floor(Math.random()*(l.length-1));return l[e]}function i(e){if(e){for(var a=String(e.substr(0,1).charCodeAt()),r=0,t=0;t<a.length;t++)r+=parseInt(a.charAt(t));var n=String(r).substr(-1);return l[n]}return s()}function d(e,a,r){for(var t="",n=0,o=r.length;o>n;n++){var s=r[n];t+='<div class="card squareCard scalableCard squareCard-scalable"><div class="cardBox cardBox-bottompadded visualCardBox">',t+='<div class="cardScalable visualCardBox-cardScalable">',t+='<div class="cardPadder cardPadder-square"></div>',t+='<a class="cardContent" href="#" data-ajax="false" data-haspw="'+s.HasPassword+'" data-username="'+s.Name+'" data-userid="'+s.Id+'">';var d;if(s.PrimaryImageTag)d=a.getUserImageUrl(s.Id,{width:300,tag:s.PrimaryImageTag,type:"Primary"}),t+='<div class="cardImageContainer coveredImage coveredImage-noScale" style="background-image:url(\''+d+"');\"></div>";else{var l=i(s.Id);d="css/images/logindefault.png",t+='<div class="cardImageContainer coveredImage coveredImage-noScale" style="background-image:url(\''+d+"');background-color:"+l+';"></div>'}t+="</a>",t+="</div>",t+='<div class="cardFooter visualCardBox-cardFooter">',t+='<div class="cardText">'+s.Name+"</div>",t+='<div class="cardText cardText-secondary">';var u=c(s.LastActivityDate);t+=""!=u?u:"&nbsp;",t+="</div>",t+="</div>",t+="</div>",t+="</div>"}e.querySelector("#divUsers").innerHTML=t}function c(e){return e?"Last seen "+humane_date(e):""}var l=["#6FBD45","#4BB3DD","#4164A5","#E12026","#800080","#E1B222","#008040","#0094FF","#FF00C7","#FF870F","#7F0037"];return function(n,s){function i(){var e=s.serverid;return e?r.getOrCreateApiClient(e):ApiClient}function c(){n.querySelector(".visualLoginForm").classList.remove("hide"),n.querySelector(".manualLoginForm").classList.add("hide")}n.querySelector("#divUsers").addEventListener("click",function(e){var r=a.parentWithClass(e.target,"cardContent");if(r){var s=n,d=r.getAttribute("data-userid"),c=r.getAttribute("data-username"),l=r.getAttribute("data-haspw");"manual"==d?(s.querySelector("#txtManualName").value="",o(s,!0)):"false"==l?t(s,i(),c,""):(s.querySelector("#txtManualName").value=c,s.querySelector("#txtManualPassword").value="",o(s,!0,!0))}}),n.querySelector(".manualLoginForm").addEventListener("submit",function(a){e.enableAutoLogin(n.querySelector(".chkRememberLogin").checked);var r=i();return t(n,r,n.querySelector("#txtManualName").value,n.querySelector("#txtManualPassword").value),a.preventDefault(),!1}),n.querySelector(".btnForgotPassword").addEventListener("click",function(){Dashboard.navigate("forgotpassword.html")}),n.querySelector(".btnCancel").addEventListener("click",c),n.querySelector(".btnManual").addEventListener("click",function(){n.querySelector("#txtManualName").value="",o(n,!0)}),n.addEventListener("viewshow",function(){Dashboard.showLoadingMsg();var e=i();e.getPublicUsers().then(function(a){a.length?(c(),d(n,e,a)):(n.querySelector("#txtManualName").value="",o(n,!1,!1)),Dashboard.hideLoadingMsg()}),e.getJSON(e.getUrl("Branding/Configuration")).then(function(e){n.querySelector(".disclaimer").innerHTML=e.LoginDisclaimer||""}),Dashboard.isConnectMode()?n.querySelector(".connectButtons").classList.remove("hide"):n.querySelector(".connectButtons").classList.add("hide")})}});