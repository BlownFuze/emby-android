define(["appSettings","cardStyle","emby-checkbox"],function(e){function a(){var e=getParameterByName("serverid");return e?ConnectionManager.getOrCreateApiClient(e):ApiClient}function r(){Dashboard.alert({message:Globalize.translate("MessageUnableToConnectToServer"),title:Globalize.translate("HeaderConnectionFailure")})}function t(a,r,t){a.querySelector(".chkRememberLogin").checked=e.enableAutoLogin(),a.querySelector(".manualLoginForm").classList.remove("hide"),a.querySelector(".visualLoginForm").classList.add("hide"),t?a.querySelector("#txtManualPassword").focus():a.querySelector("#txtManualName").focus(),r?a.querySelector(".btnCancel").classList.remove("hide"):a.querySelector(".btnCancel").classList.add("hide")}function n(){var e=Math.floor(Math.random()*(d.length-1));return d[e]}function s(e){if(e){for(var a=String(e.substr(0,1).charCodeAt()),r=0,t=0;t<a.length;t++)r+=parseInt(a.charAt(t));var s=String(r).substr(-1);return d[s]}return n()}function o(e,a,r){for(var t="",n=0,o=r.length;o>n;n++){var i=r[n];t+='<div class="card squareCard scalableCard squareCard-scalable"><div class="cardBox cardBox-bottompadded visualCardBox">',t+='<div class="cardScalable visualCardBox-cardScalable">',t+='<div class="cardPadder cardPadder-square"></div>',t+='<a class="cardContent" href="#" data-ajax="false" data-haspw="'+i.HasPassword+'" data-username="'+i.Name+'" data-userid="'+i.Id+'">';var d;if(i.PrimaryImageTag)d=a.getUserImageUrl(i.Id,{width:300,tag:i.PrimaryImageTag,type:"Primary"}),t+='<div class="cardImageContainer coveredImage coveredImage-noScale" style="background-image:url(\''+d+"');\"></div>";else{var l=s(i.Id);d="css/images/logindefault.png",t+='<div class="cardImageContainer coveredImage coveredImage-noScale" style="background-image:url(\''+d+"');background-color:"+l+';"></div>'}t+="</a>",t+="</div>",t+='<div class="cardFooter visualCardBox-cardFooter">',t+='<div class="cardText">'+i.Name+"</div>",t+='<div class="cardText cardText-secondary">';var u=c.getLastSeenText(i.LastActivityDate);t+=""!=u?u:"&nbsp;",t+="</div>",t+="</div>",t+="</div>",t+="</div>"}e.querySelector("#divUsers").innerHTML=t}function i(e,a){for(;!e.classList||!e.classList.contains(a);)if(e=e.parentNode,!e)return null;return e}var c={showVisualForm:function(e){e.querySelector(".visualLoginForm").classList.remove("hide"),e.querySelector(".manualLoginForm").classList.add("hide")},getLastSeenText:function(e){return e?"Last seen "+humane_date(e):""},authenticateUserByName:function(e,a,t,n){Dashboard.showLoadingMsg(),a.authenticateUserByName(t,n).then(function(e){var r,t=e.User,n=getParameterByName("serverid");r=t.Policy.IsAdministrator&&!n?"dashboard.html":"home.html",Dashboard.hideLoadingMsg(),Dashboard.onServerChanged(t.Id,e.AccessToken,a),Dashboard.navigate(r)},function(a){e.querySelector("#txtManualName").value="",e.querySelector("#txtManualPassword").value="",Dashboard.hideLoadingMsg(),401==a.status?require(["toast"],function(e){e(Globalize.translate("MessageInvalidUser"))}):r()})}},d=["#6FBD45","#4BB3DD","#4164A5","#E12026","#800080","#E1B222","#008040","#0094FF","#FF00C7","#FF870F","#7F0037"];return function(r){r.querySelector("#divUsers").addEventListener("click",function(e){var n=i(e.target,"cardContent");if(n){var s=r,o=n.getAttribute("data-userid"),d=n.getAttribute("data-username"),l=n.getAttribute("data-haspw");"manual"==o?(s.querySelector("#txtManualName").value="",t(s,!0)):"false"==l?c.authenticateUserByName(s,a(),d,""):(s.querySelector("#txtManualName").value=d,s.querySelector("#txtManualPassword").value="",t(s,!0,!0))}}),r.querySelector(".manualLoginForm").addEventListener("submit",function(t){e.enableAutoLogin(r.querySelector(".chkRememberLogin").checked);var n=a();return c.authenticateUserByName(r,n,r.querySelector("#txtManualName").value,r.querySelector("#txtManualPassword").value),t.preventDefault(),!1}),r.querySelector(".btnForgotPassword").addEventListener("click",function(){Dashboard.navigate("forgotpassword.html")}),r.querySelector(".btnCancel").addEventListener("click",function(){c.showVisualForm(r)}),r.querySelector(".btnManual").addEventListener("click",function(){r.querySelector("#txtManualName").value="",t(r,!0)}),r.addEventListener("viewshow",function(){Dashboard.showLoadingMsg();var e=a();e.getPublicUsers().then(function(a){a.length?(c.showVisualForm(r),o(r,e,a)):(r.querySelector("#txtManualName").value="",t(r,!1,!1)),Dashboard.hideLoadingMsg()}),e.getJSON(e.getUrl("Branding/Configuration")).then(function(e){r.querySelector(".disclaimer").innerHTML=e.LoginDisclaimer||""}),Dashboard.isConnectMode()?r.querySelector(".connectButtons").classList.remove("hide"):r.querySelector(".connectButtons").classList.add("hide")})}});