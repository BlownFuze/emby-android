define(["jQuery"],function(e){function n(n){function d(){C(),Events.trigger(O,"ended")}function s(){Events.trigger(O,"timeupdate")}function u(){Events.trigger(O,"volumechange")}function l(n){var t=n.target;t.removeEventListener("playing",l),e(".mediaPlayerAudioContainer").hide()}function c(){Events.trigger(O,"playing")}function v(){Events.trigger(O,"play")}function f(){Events.trigger(O,"pause")}function m(){Events.trigger(O,"click")}function p(){Events.trigger(O,"dblclick")}function g(e){C();{var n=e.target;n.error?n.error.code:""}Events.trigger(O,"error")}function y(e){var n=e.target;n.removeEventListener("loadedmetadata",y),r||n.play()}function E(e){require(["hlsjs"],function(n){window.Hls=n,e()})}function L(e){var n=e,t=n.split("#");return t.length>1&&(t=t[t.length-1].split("="),2==t.length)?parseFloat(t[1]):0}function T(n){var t=n.target;t.removeEventListener("playing",T),O.setCurrentTrackElement(a);var r=!O.enableCustomVideoControls();if(r&&e(t).attr("controls","controls"),i){var o=(O.currentSrc()||"").toLowerCase(),d=L(o);if(d&&-1!=o.indexOf(".m3u8")){var s=browserInfo.safari?2500:0;s?setTimeout(function(){t.currentTime=d},s):t.currentTime=d}}}function k(){var n=e(".mediaPlayerAudio");if(!n.length){var t="",r=!MediaPlayer.canAutoPlayAudio();t+=r?'<div class="mediaPlayerAudioContainer" style="position: fixed;top: 40%;text-align: center;left: 0;right: 0;z-index:999999;"><div class="mediaPlayerAudioContainerInner">':'<div class="mediaPlayerAudioContainer" style="display:none;padding: 1em;background: #222;"><div class="mediaPlayerAudioContainerInner">',t+='<audio class="mediaPlayerAudio" controls>',t+="</audio></div></div>",e(document.body).append(t),n=e(".mediaPlayerAudio")}return n=n[0],n.addEventListener("playing",l),n.addEventListener("timeupdate",s),n.addEventListener("ended",d),n.addEventListener("volumechange",u),n.addEventListener("error",g),n.addEventListener("pause",f),n.addEventListener("play",v),n.addEventListener("playing",c),n}function w(e){return e&&-1==e.indexOf(".m3u8")?!1:MediaPlayer.canPlayHls()&&!MediaPlayer.canPlayNativeHls()}function b(){return"anonymous"}function h(){var t="",r=!O.enableCustomVideoControls(),i=!browserInfo.safari&&n.poster?' poster="'+n.poster+'"':"";t+=r&&AppInfo.isNativeApp&&browserInfo.android?'<video class="itemVideo" id="itemVideo" preload="metadata" autoplay="autoplay"'+i+" webkit-playsinline>":r?'<video class="itemVideo" id="itemVideo" preload="metadata" autoplay="autoplay"'+i+' controls="controls" webkit-playsinline>':'<video class="itemVideo" id="itemVideo" preload="metadata" autoplay="autoplay"'+i+" webkit-playsinline>",t+="</video>";var a=e("#videoElement","#videoPlayer").prepend(t),o=e(".itemVideo",a)[0];return o.addEventListener("loadedmetadata",y),o.addEventListener("timeupdate",s),o.addEventListener("ended",d),o.addEventListener("volumechange",u),o.addEventListener("play",v),o.addEventListener("pause",f),o.addEventListener("playing",c),o.addEventListener("click",m),o.addEventListener("dblclick",p),o.addEventListener("error",g),o}function x(e,n){var t=n.map(function(e){var n=e.isDefault?" default":"",t=e.language||"und";return'<track id="textTrack'+e.index+'" label="'+t+'" kind="subtitles" src="'+e.url+'" srclang="'+e.language+'"'+n+"></track>"}).join("");e.innerHTML=t}function A(){return browserInfo.safari&&browserInfo.mobile?!1:browserInfo.firefox&&-1!=(j||"").toLowerCase().indexOf(".m3u8")?!1:!0}function C(e){if(e)for(var n=N.textTracks,t=0;t<n.length;t++){var r=n[t];-1!=r.label.indexOf("manualTrack")&&(r.mode="disabled")}H=-1}function P(e){return ApiClient.ajax({url:e.url.replace(".vtt",".js"),type:"GET",dataType:"json"})}function I(e){return e?void(H!=e.index&&(C(!0),H=e.index,V(e))):void C(!0)}function V(e){for(var n=null,t="manualTrack"+e.index,r=N.textTracks,i=0;i<r.length;i++){var a=r[i];if(a.label==t){n=a;break}a.mode="disabled"}n?n.mode="showing":(n=N.addTextTrack("subtitles","manualTrack"+e.index,e.language||"und"),n.label="manualTrack"+e.index,P(e).then(function(e){e.TrackEvents.forEach(function(e){n.addCue(new VTTCue(e.StartPositionTicks/1e7,e.EndPositionTicks/1e7,e.Text.replace(/\\N/gi,"\n")))}),n.mode="showing"}))}var N,S,O=this;O.currentTime=function(e){return N?null!=e?void(N.currentTime=e/1e3):S?1e3*S:1e3*(N.currentTime||0):void 0},O.duration=function(){return N?N.duration:null},O.stop=function(){if(C(),N&&(N.pause(),r)){S=N.currentTime;try{r.destroy()}catch(e){}r=null}},O.pause=function(){N&&N.pause()},O.unpause=function(){N&&N.play()},O.volume=function(e){return N?null!=e?void(N.volume=e):N.volume:void 0};var j;O.setCurrentSrc=function(e,n,t,d){var s=N;if(!s)return void(j=null);if(!e)return j=null,s.src=null,s.src="",void(browserInfo.safari&&(s.src="files/dummy.mp4",s.play()));s.crossOrigin=b(t);var u=e.url;AppInfo.isNativeApp&&browserInfo.safari&&(u=u.replace("file://","")),i=!1;var l=L(u),c=!1;if("audio"==s.tagName.toLowerCase())s.src=u,c=!0;else{s.removeEventListener("playing",T),s.addEventListener("playing",T),r&&(r.destroy(),r=null),l&&(i=!0),d=d||[],o=d;for(var v=-1,f=0,m=d.length;m>f;f++)if(d[f].isDefault){v=d[f].index;break}if(a=v,w(u)){x(s,d);var p=new Hls;p.loadSource(u),p.attachMedia(s),p.on(Hls.Events.MANIFEST_PARSED,function(){s.play()}),r=p}else s.src=u,s.autoplay=!0,x(s,d),s.addEventListener("loadedmetadata",y),c=!0;j=u,O.setCurrentTrackElement(v)}j=u,c&&s.play()},O.currentSrc=function(){return N?j:void 0},O.paused=function(){return N?N.paused:!1},O.cleanup=function(){O.setCurrentSrc(null),S=null;var n=N;n&&("AUDIO"==n.tagName?(n.removeEventListener("timeupdate",s),n.removeEventListener("ended",d),n.removeEventListener("volumechange",u),n.removeEventListener("playing",l),n.removeEventListener("play",v),n.removeEventListener("pause",f),n.removeEventListener("playing",c),n.removeEventListener("error",g)):(n.removeEventListener("loadedmetadata",y),n.removeEventListener("playing",T),n.removeEventListener("timeupdate",s),n.removeEventListener("ended",d),n.removeEventListener("volumechange",u),n.removeEventListener("play",v),n.removeEventListener("pause",f),n.removeEventListener("playing",c),n.removeEventListener("click",m),n.removeEventListener("dblclick",p),n.removeEventListener("error",g)),"audio"!=n.tagName.toLowerCase()&&e(n).remove())},O.supportsTextTracks=function(){return null==t&&(t=null!=document.createElement("video").textTracks),t};var H=-1;O.setCurrentTrackElement=function(e){var n=-1==e?null:o.filter(function(n){return n.index==e})[0];A(n)?I(null):(I(n),e=-1,n=null);for(var t="textTrack"+e,r=-1!=e&&n?o.indexOf(n):-1,i=["disabled","showing","hidden"],a=N.textTracks,d=0;d<a.length;d++){var s,u=a[d];if(browserInfo.msie||browserInfo.edge)s=r==d?1:0;else{if(-1!=u.label.indexOf("manualTrack"))continue;s=u.id==t?1:0}var l=!1;!isNaN(u.mode),u.mode=l?s:i[s]}},O.updateTextStreamUrls=function(n){if(O.supportsTextTracks()){for(var t=N.textTracks,r=0;r<t.length;r++){var i=t[r];try{for(;i.cues.length;)i.removeCue(i.cues[0])}catch(a){}}e("track",N).each(function(){this.src=replaceQueryString(this.src,"startPositionTicks",n)})}},O.enableCustomVideoControls=function(){return AppInfo.isNativeApp&&browserInfo.safari?-1!=navigator.userAgent.toLowerCase().indexOf("iphone")?!0:!1:O.canAutoPlayVideo()},O.canAutoPlayVideo=function(){return AppInfo.isNativeApp?!0:browserInfo.mobile?!1:!0},O.init=function(){return new Promise(function(e){"video"==n.type&&w()?E(e):e()})},N="audio"==n.type?k():h()}var t,r,i,a,o;window.AudioRenderer||(window.AudioRenderer=function(e){return e=e||{},e.type="audio",new n(e)}),window.VideoRenderer||(window.VideoRenderer=function(e){return e=e||{},e.type="video",new n(e)})});