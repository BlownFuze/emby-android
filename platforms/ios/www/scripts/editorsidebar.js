!function(e,t,r){function i(e,t,r){var i=n(e),a={id:e.Id,text:i,state:{opened:e.IsFolder&&"open"==t,selected:r},li_attr:{}};return e.IsFolder?(a.children=[{text:"Loading...",icon:!1}],a.icon=!1):a.icon=!1,a.state.opened&&(a.li_attr.loadedFromServer=!0),r&&(y=e.Id),a}function n(e){var t=e.Name;e.Number&&(t=e.Number+" - "+t),null!=e.IndexNumber&&"Season"!=e.Type&&(t=e.IndexNumber+" - "+t);var r="editorNode";"Offline"==e.LocationType&&(r+=" offlineEditorNode");var i="<div class='"+r+"'>";if(e.LockData&&(i+='<img src="css/images/editor/lock.png" />'),i+=t,e.LocalTrailerCount||"Movie"!=e.Type||(i+='<img src="css/images/editor/missingtrailer.png" title="'+Globalize.translate("MissingLocalTrailer")+'" />'),e.ImageTags&&e.ImageTags.Primary||(i+='<img src="css/images/editor/missingprimaryimage.png" title="'+Globalize.translate("MissingPrimaryImage")+'" />'),e.BackdropImageTags&&e.BackdropImageTags.length||"Episode"!==e.Type&&"Season"!==e.Type&&"Audio"!==e.MediaType&&"TvChannel"!==e.Type&&"MusicAlbum"!==e.Type&&(i+='<img src="css/images/editor/missingbackdrop.png" title="'+Globalize.translate("MissingBackdropImage")+'" />'),e.ImageTags&&e.ImageTags.Logo||("Movie"==e.Type||"Trailer"==e.Type||"Series"==e.Type||"MusicArtist"==e.Type||"BoxSet"==e.Type)&&(i+='<img src="css/images/editor/missinglogo.png" title="'+Globalize.translate("MissingLogoImage")+'" />'),"Episode"==e.Type&&"Virtual"==e.LocationType)try{e.PremiereDate&&(new Date).getTime()>=parseISO8601Date(e.PremiereDate,{toLocal:!0}).getTime()&&(i+='<img src="css/images/editor/missing.png" title="'+Globalize.translate("MissingEpisode")+'" />')}catch(n){}return i+="</div>"}function a(e,t,r){ApiClient.getLiveTvChannels({limit:0}).then(function(e){var i=[];i.push({id:"MediaFolders",text:Globalize.translate("HeaderMediaFolders"),state:{opened:!0},li_attr:{itemtype:"mediafolders",loadedFromServer:!0},icon:!1}),e.TotalRecordCount&&i.push({id:"livetv",text:Globalize.translate("HeaderLiveTV"),state:{opened:!1},li_attr:{itemtype:"livetv"},children:[{text:"Loading...",icon:!1}],icon:!1}),r.call(t,i),I.push("MediaFolders")})}function o(e,t,r){ApiClient.getLiveTvChannels({ServiceName:e,AddCurrentProgram:!1}).then(function(e){var n=e.Items.map(function(e){var r=-1==t.indexOf(e.Id)?"closed":"open";return i(e,r,!1)});r(n)})}function d(e,t,r,n){ApiClient.getJSON(ApiClient.getUrl("Library/MediaFolders")).then(function(e){var a=e.Items.map(function(e){var t=-1==r.indexOf(e.Id)?"closed":"open";return i(e,t,!1)});n.call(t,a);for(var o=0,d=a.length;d>o;o++)a[o].state.opened&&I.push(a[o].id)})}function s(e,t,r,n,s,l,c){var g=r.id;if("#"==g)return void a(e,t,c);if("livetv"==g)return void o(g,n,c);if("MediaFolders"==g)return void d(e,t,n,c);var m={ParentId:g,Fields:"Settings"},u=r.li_attr.itemtype;"Season"!=u&&"Series"!=u&&(m.SortBy="SortName"),ApiClient.getItems(Dashboard.getCurrentUserId(),m).then(function(e){var r=e.Items.map(function(e){var t=-1==n.indexOf(e.Id)?"closed":"open";return i(e,t,e.Id==s)});c.call(t,r);for(var a=0,o=r.length;o>a;a++)r[a].state.opened&&I.push(r[a].id)})}function l(t,r){var i=e("#"+r,t)[0];i&&i.scrollIntoView()}function c(e,t,r,i){require(["jstree"],function(){p(e,t,r,i)})}function g(t,r){var i=r.node,n={id:i.id,itemType:i.li_attr.itemtype};"livetv"!=n.itemType&&"mediafolders"!=n.itemType&&e(this).trigger("itemclicked",[n])}function m(t,r){var i=e(this).parents(".page")[0],n=r.node;n.children&&n.children&&f(i,n),n.li_attr&&"#"!=n.id&&!n.li_attr.loadedFromServer&&(n.li_attr.loadedFromServer=!0,e.jstree.reference(".libraryTree",i).load_node(n.id,v))}function u(t,r){var i=e(this).parents(".page")[0],n=r.node;n.children&&n.children&&f(i,n),n.li_attr&&"#"!=n.id&&!n.li_attr.loadedFromServer&&(n.li_attr.loadedFromServer=!0,e.jstree.reference(".libraryTree",i).load_node(n.id,v))}function p(t,r,i,n){I=[],y=null,e.jstree.destroy(),e(".libraryTree",t).jstree({plugins:["wholerow"],core:{check_callback:!0,data:function(e,a){s(t,this,e,i,n,r,a)},themes:{variant:"large"}}}).off("select_node.jstree",g).on("select_node.jstree",g).off("open_node.jstree",m).on("open_node.jstree",m).off("load_node.jstree",u).on("load_node.jstree",u)}function f(t,r){for(var i=r.children,n=0,a=i.length;a>n;n++){var o=i[n];-1!=I.indexOf(o)&&(I=I.filter(function(e){return e!=o}),e.jstree.reference(".libraryTree",t).load_node(o,v))}}function v(t){y&&t.children&&-1!=t.children.indexOf(y)&&setTimeout(function(){l(e.mobile.activePage,y)},500)}function h(t,r){var i=e("#"+r.Id+">a",t)[0];if(null!=i&&(e(".editorNode",i).remove(),e(i).append(n(r)),r.IsFolder)){var a=jQuery.jstree._reference(".libraryTree"),o=a._get_node(null,!1);a.refresh(o)}}function T(){var e=r.location.hash||r.location.href;return getParameterByName("id",e)}var y,I=[];e(t).on("itemsaved",".metadataEditorPage",function(e,t){h(this,t)}).on("pagebeforeshow",".metadataEditorPage",function(){Dashboard.importCss("css/metadataeditor.css")}).on("pagebeforeshow",".metadataEditorPage",function(){var e=this;Dashboard.getCurrentUser().then(function(t){var r=T();r?ApiClient.getAncestorItems(r,t.Id).then(function(i){var n=i.map(function(e){return e.Id});c(e,t,n,r)}):c(e,t,[])})}).on("pagebeforehide",".metadataEditorPage",function(){var t=this;e(".libraryTree",t).off("select_node.jstree",g).off("open_node.jstree",m).off("load_node.jstree",u)}),r.MetadataEditor={getItemPromise:function(){var e=T();return e?ApiClient.getItem(Dashboard.getCurrentUserId(),e):ApiClient.getRootFolder(Dashboard.getCurrentUserId())},getCurrentItemId:T}}(jQuery,document,window);