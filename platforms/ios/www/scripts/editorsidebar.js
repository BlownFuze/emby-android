define(["datetime","jQuery","material-icons"],function(e,t){function r(e,t,r){var n=i(e),a={id:e.Id,text:n,state:{opened:e.IsFolder&&"open"==t,selected:r},li_attr:{}};return e.IsFolder?(a.children=[{text:"Loading...",icon:!1}],a.icon=!1):a.icon=!1,a.state.opened&&(a.li_attr.loadedFromServer=!0),r&&(T=e.Id),a}function i(t){var r=t.Name;t.Number&&(r=t.Number+" - "+r),null!=t.IndexNumber&&"Season"!=t.Type&&(r=t.IndexNumber+" - "+r);var i="editorNode";"Offline"==t.LocationType&&(i+=" offlineEditorNode");var n="<div class='"+i+"'>";if(t.LockData&&(n+='<i class="md-icon">lock</i>'),n+=r,t.ImageTags&&t.ImageTags.Primary||(n+='<img src="css/images/editor/missingprimaryimage.png" title="'+Globalize.translate("MissingPrimaryImage")+'" />'),t.BackdropImageTags&&t.BackdropImageTags.length||"Episode"!==t.Type&&"Season"!==t.Type&&"Audio"!==t.MediaType&&"TvChannel"!==t.Type&&"MusicAlbum"!==t.Type&&(n+='<img src="css/images/editor/missingbackdrop.png" title="'+Globalize.translate("MissingBackdropImage")+'" />'),t.ImageTags&&t.ImageTags.Logo||("Movie"==t.Type||"Trailer"==t.Type||"Series"==t.Type||"MusicArtist"==t.Type||"BoxSet"==t.Type)&&(n+='<img src="css/images/editor/missinglogo.png" title="'+Globalize.translate("MissingLogoImage")+'" />'),"Episode"==t.Type&&"Virtual"==t.LocationType)try{t.PremiereDate&&(new Date).getTime()>=e.parseISO8601Date(t.PremiereDate,!0).getTime()&&(n+='<img src="css/images/editor/missing.png" title="'+Globalize.translate("MissingEpisode")+'" />')}catch(a){}return n+="</div>"}function n(e,t,r){ApiClient.getLiveTvChannels({limit:0}).then(function(e){var i=[];i.push({id:"MediaFolders",text:Globalize.translate("HeaderMediaFolders"),state:{opened:!0},li_attr:{itemtype:"mediafolders",loadedFromServer:!0},icon:!1}),e.TotalRecordCount&&i.push({id:"livetv",text:Globalize.translate("HeaderLiveTV"),state:{opened:!1},li_attr:{itemtype:"livetv"},children:[{text:"Loading...",icon:!1}],icon:!1}),r.call(t,i),y.push("MediaFolders")})}function a(e,t,i){ApiClient.getLiveTvChannels({ServiceName:e,AddCurrentProgram:!1}).then(function(e){var n=e.Items.map(function(e){var i=-1==t.indexOf(e.Id)?"closed":"open";return r(e,i,!1)});i(n)})}function o(e,t,i,n){ApiClient.getJSON(ApiClient.getUrl("Library/MediaFolders")).then(function(e){var a=e.Items.map(function(e){var t=-1==i.indexOf(e.Id)?"closed":"open";return r(e,t,!1)});n.call(t,a);for(var o=0,d=a.length;d>o;o++)a[o].state.opened&&y.push(a[o].id)})}function d(e,t,i,d,s,l,c){var m=i.id;if("#"==m)return void n(e,t,c);if("livetv"==m)return void a(m,d,c);if("MediaFolders"==m)return void o(e,t,d,c);var u={ParentId:m,Fields:"Settings"},f=i.li_attr.itemtype;"Season"!=f&&"Series"!=f&&(u.SortBy="SortName"),ApiClient.getItems(Dashboard.getCurrentUserId(),u).then(function(e){var i=e.Items.map(function(e){var t=-1==d.indexOf(e.Id)?"closed":"open";return r(e,t,e.Id==s)});c.call(t,i);for(var n=0,a=i.length;a>n;n++)i[n].state.opened&&y.push(i[n].id)})}function s(e){var r=t("#"+e)[0];r&&r.scrollIntoView()}function l(e,t,r,i){require(["jstree"],function(){f(e,t,r,i)})}function c(e,r){var i=r.node,n={id:i.id,itemType:i.li_attr.itemtype};"livetv"!=n.itemType&&"mediafolders"!=n.itemType&&t(this).trigger("itemclicked",[n])}function m(e,r){var i=t(this).parents(".page")[0],n=r.node;n.children&&n.children&&g(i,n),n.li_attr&&"#"!=n.id&&!n.li_attr.loadedFromServer&&(n.li_attr.loadedFromServer=!0,t.jstree.reference(".libraryTree",i).load_node(n.id,p))}function u(e,r){var i=t(this).parents(".page")[0],n=r.node;n.children&&n.children&&g(i,n),n.li_attr&&"#"!=n.id&&!n.li_attr.loadedFromServer&&(n.li_attr.loadedFromServer=!0,t.jstree.reference(".libraryTree",i).load_node(n.id,p))}function f(e,r,i,n){y=[],T=null,t.jstree.destroy(),t(".libraryTree",e).jstree({plugins:["wholerow"],core:{check_callback:!0,data:function(t,a){d(e,this,t,i,n,r,a)},themes:{variant:"large"}}}).off("select_node.jstree",c).on("select_node.jstree",c).off("open_node.jstree",m).on("open_node.jstree",m).off("load_node.jstree",u).on("load_node.jstree",u)}function g(e,r){for(var i=r.children,n=0,a=i.length;a>n;n++){var o=i[n];-1!=y.indexOf(o)&&(y=y.filter(function(e){return e!=o}),t.jstree.reference(".libraryTree",e).load_node(o,p))}}function p(e){T&&e.children&&-1!=e.children.indexOf(T)&&setTimeout(function(){s(T)},500)}function v(e,r){var n=t("#"+r.Id+">a",e)[0];if(null!=n&&(t(".editorNode",n).remove(),t(n).append(i(r)),r.IsFolder)){var a=jQuery.jstree._reference(".libraryTree"),o=a._get_node(null,!1);a.refresh(o)}}function h(e){_=e}function I(){if(_)return _;var e=window.location.hash||window.location.href;return getParameterByName("id",e)}var T,y=[];t(document).on("itemsaved",".metadataEditorPage",function(e,t){v(this,t)}).on("pagebeforeshow",".metadataEditorPage",function(){require(["css!css/metadataeditor.css"])}).on("pagebeforeshow",".metadataEditorPage",function(){var e=this;Dashboard.getCurrentUser().then(function(t){var r=I();r?ApiClient.getAncestorItems(r,t.Id).then(function(i){var n=i.map(function(e){return e.Id});l(e,t,n,r)}):l(e,t,[])})}).on("pagebeforehide",".metadataEditorPage",function(){var e=this;t(".libraryTree",e).off("select_node.jstree",c).off("open_node.jstree",m).off("load_node.jstree",u)});var _;window.MetadataEditor={getItemPromise:function(){var e=I();return e?ApiClient.getItem(Dashboard.getCurrentUserId(),e):ApiClient.getRootFolder(Dashboard.getCurrentUserId())},getCurrentItemId:I,setCurrentItemId:h}});