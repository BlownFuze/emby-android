define(["appSettings","appStorage","libraryBrowser","apphost","itemHelper","mediaInfo"],function(e,t,a,n,r,i){function o(e){var t=e.target;t.classList.contains("card")&&(j&&(clearTimeout(j),j=null),t=t.querySelector(".cardOverlayTarget"),t&&s(t))}function s(e){return e.classList.contains("hide")?void 0:e.animate?void requestAnimationFrame(function(){var t=[{transform:"translateY(0)",offset:0},{transform:"translateY(100%)",offset:1}],a={duration:300,iterations:1,fill:"forwards",easing:"ease-out"};e.animate(t,a).onfinish=function(){e.classList.add("hide")}}):void e.classList.add("hide")}function l(e){e.classList.contains("hide")&&(e.classList.remove("hide"),e.animate&&requestAnimationFrame(function(){var t=[{transform:"translateY(100%)",offset:0},{transform:"translateY(0)",offset:1}],a={duration:300,iterations:1,fill:"forwards",easing:"ease-out"};e.animate(t,a)}))}function d(e,t,n,o){var s="";s+='<div class="cardOverlayInner">';var l=n.className.toLowerCase(),d=-1!=l.indexOf("mini"),c=d||-1!=l.indexOf("small"),u=-1!=l.indexOf("portrait"),m=(-1!=l.indexOf("square"),c||d||u?null:e.SeriesName),f=r.getDisplayName(e);s+='<div style="margin-bottom:1em;">';var p,g=c||d?20:26;m&&e.ParentLogoItemId?(p=ApiClient.getScaledImageUrl(e.ParentLogoItemId,{maxHeight:g,type:"logo",tag:e.ParentLogoImageTag}),s+='<img src="'+p+'" style="max-height:'+g+'px;max-width:100%;" />'):e.ImageTags.Logo?(p=ApiClient.getScaledImageUrl(e.Id,{maxHeight:g,type:"logo",tag:e.ImageTags.Logo}),s+='<img src="'+p+'" style="max-height:'+g+'px;max-width:100%;" />'):s+=m||f,s+="</div>",m?(s+="<p>",s+=f,s+="</p>"):c||d||(s+='<div class="itemMiscInfo">',s+=i.getPrimaryMediaInfoHtml(e,{endsAt:!1}),s+="</div>"),d||(s+='<div style="margin:1em 0 .75em;">',u?(s+='<div class="userDataIcons" style="margin:.5em 0 0em;">',s+=a.getUserDataIconsHtml(e),s+="</div>"):(s+='<span class="userDataIcons" style="vertical-align:middle;">',s+=a.getUserDataIconsHtml(e),s+="</span>"),s+="</div>"),s+="<div>";var h=0;if(MediaController.canPlay(e)){var v=(e.UserData||{}).PlaybackPositionTicks||0;s+='<button is="paper-icon-button-light" class="btnPlayItem autoSize" data-itemid="'+e.Id+'" data-itemtype="'+e.Type+'" data-isfolder="'+e.IsFolder+'" data-mediatype="'+e.MediaType+'" data-resumeposition="'+v+'"><i class="md-icon">play_circle_outline</i></button>',h++}return-1!=o.indexOf("trailer")&&(s+='<button is="paper-icon-button-light" class="btnPlayTrailer autoSize" data-itemid="'+e.Id+'"><i class="md-icon">videocam</i></button>',h++),s+='<button is="paper-icon-button-light" class="btnMoreCommands autoSize"><i class="md-icon">more_vert</i></button>',h++,s+="</div>",s+="</div>"}function c(e){var t=this.getAttribute("data-itemid");return ApiClient.getLocalTrailers(Dashboard.getCurrentUserId(),t).then(function(e){MediaController.play({items:e})}),e.preventDefault(),e.stopPropagation(),!1}function u(e){var t=this,n=t.getAttribute("data-itemid"),r=t.getAttribute("data-itemtype"),i="true"==t.getAttribute("data-isfolder"),o=t.getAttribute("data-mediatype"),s=parseInt(t.getAttribute("data-resumeposition"));return a.showPlayMenu(this,n,r,i,o,s),e.preventDefault(),e.stopPropagation(),!1}function m(e){var t=P(this,"card");return g(t,{showPlayOptions:!1}),e.preventDefault(),e.stopPropagation(),!1}function f(e){var t=P(e.target,"card");if(t){var a=t.querySelector(".itemSelectionPanel");return a||g(t,{}),e.preventDefault(),!1}}function p(e,t){require(["confirm"],function(a){a(Globalize.translate("MessageConfirmRecordingCancellation"),Globalize.translate("HeaderConfirmRecordingCancellation")).then(function(){Dashboard.showLoadingMsg(),ApiClient.cancelLiveTvTimer(e).then(function(){require(["toast"],function(e){e(Globalize.translate("MessageRecordingCancelled"))}),Dashboard.hideLoadingMsg(),t.dispatchEvent(new CustomEvent("timercancelled",{bubbles:!0}))})})})}function g(t,r){var i=t;t.classList.contains("card")||t.classList.contains("listItem")||(t=C(t,["listItem","card"]));var o=t.getAttribute("data-itemid"),s=t.getAttribute("data-playlistitemid"),l=t.getAttribute("data-commands").split(","),d=t.getAttribute("data-itemtype"),c=t.getAttribute("data-mediatype"),u=parseInt(t.getAttribute("data-positionticks")||"0"),m=t.getAttribute("data-playaccess"),f=t.getAttribute("data-locationtype"),g=t.getAttribute("data-index"),h=t.getAttribute("data-albumid"),v=t.getAttribute("data-artistid"),b=ApiClient.serverInfo().Id;Dashboard.getCurrentUser().then(function(y){var I=[];-1!=l.indexOf("addtocollection")&&I.push({name:Globalize.translate("ButtonAddToCollection"),id:"addtocollection",ironIcon:"add"}),-1!=l.indexOf("playlist")&&I.push({name:Globalize.translate("ButtonAddToPlaylist"),id:"playlist",ironIcon:"playlist-add"}),y.Policy.EnableContentDownloading&&n.supports("filedownload")&&c&&I.push({name:Globalize.translate("ButtonDownload"),id:"download",ironIcon:"file-download"}),-1!=l.indexOf("delete")&&I.push({name:Globalize.translate("ButtonDelete"),id:"delete",ironIcon:"delete"}),y.Policy.IsAdministrator&&(-1!=l.indexOf("edit")&&I.push({name:Globalize.translate("ButtonEdit"),id:"edit",ironIcon:"mode-edit"}),-1!=l.indexOf("editimages")&&I.push({name:Globalize.translate("ButtonEditImages"),id:"editimages",ironIcon:"photo"}),-1!=l.indexOf("editsubtitles")&&I.push({name:Globalize.translate("ButtonEditSubtitles"),id:"editsubtitles",ironIcon:"closed-caption"})),-1!=l.indexOf("instantmix")&&I.push({name:Globalize.translate("ButtonInstantMix"),id:"instantmix",ironIcon:"shuffle"}),"Timer"==d&&y.Policy.EnableLiveTvManagement&&I.push({name:Globalize.translate("ButtonCancel"),id:"canceltimer",ironIcon:"cancel"}),I.push({name:Globalize.translate("Timer"==d?"ButtonEdit":"ButtonOpen"),id:"open",ironIcon:"folder-open"}),r.showPlayOptions!==!1&&(MediaController.canPlayByAttributes(d,c,m,f)&&(I.push({name:Globalize.translate("ButtonPlay"),id:"play",ironIcon:"play-arrow"}),-1!=l.indexOf("playfromhere")&&I.push({name:Globalize.translate("ButtonPlayAllFromHere"),id:"playallfromhere",ironIcon:"play-arrow"})),"Video"==c&&AppInfo.supportsExternalPlayers&&e.enableExternalPlayers()&&I.push({name:Globalize.translate("ButtonPlayExternalPlayer"),id:"externalplayer",ironIcon:"airplay"}),u&&"Audio"!=c&&I.push({name:Globalize.translate("ButtonResume"),id:"resume",ironIcon:"play-arrow"}),-1!=l.indexOf("trailer")&&I.push({name:Globalize.translate("ButtonPlayTrailer"),id:"trailer",ironIcon:"play-arrow"})),MediaController.canQueueMediaType(c,d)&&(I.push({name:Globalize.translate("ButtonQueue"),id:"queue",ironIcon:"playlist-add"}),-1!=l.indexOf("queuefromhere")&&I.push({name:Globalize.translate("ButtonQueueAllFromHere"),id:"queueallfromhere",ironIcon:"playlist-add"})),-1!=l.indexOf("shuffle")&&I.push({name:Globalize.translate("ButtonShuffle"),id:"shuffle",ironIcon:"shuffle"}),-1!=l.indexOf("record")&&I.push({name:Globalize.translate("ButtonRecord"),id:"record",ironIcon:"videocam"}),-1!=l.indexOf("removefromcollection")&&I.push({name:Globalize.translate("ButtonRemoveFromCollection"),id:"removefromcollection",ironIcon:"remove"}),-1!=l.indexOf("removefromplaylist")&&I.push({name:Globalize.translate("ButtonRemoveFromPlaylist"),id:"removefromplaylist",ironIcon:"remove"}),y.Policy.EnablePublicSharing&&-1!=l.indexOf("share")&&I.push({name:Globalize.translate("ButtonShare"),id:"share",ironIcon:"share"}),-1!=l.indexOf("sync")&&I.push({name:Globalize.translate("ButtonSync"),id:"sync",ironIcon:"sync"}),h&&I.push({name:Globalize.translate("ButtonViewAlbum"),id:"album",ironIcon:"album"}),v&&I.push({name:Globalize.translate("ButtonViewArtist"),id:"artist",ironIcon:"person"});var C=t.getAttribute("data-href")||t.href;if(!C){var A=t.getElementsByTagName("a");A.length&&(C=A[0].href)}require(["actionsheet"],function(e){e.show({items:I,positionTo:i,callback:function(e){switch(e){case"addtocollection":require(["collectionEditor"],function(e){(new e).show({items:[o],serverId:b})});break;case"playlist":require(["playlistEditor"],function(e){(new e).show({items:[o],serverId:b})});break;case"delete":a.deleteItems([o]);break;case"download":require(["fileDownloader"],function(e){var t=ApiClient.getUrl("Items/"+o+"/Download",{api_key:ApiClient.accessToken()});e.download([{url:t,itemId:o,serverId:b}])});break;case"edit":"Timer"==d?a.editTimer(o):a.editMetadata(o);break;case"refresh":require(["refreshDialog"],function(e){new e({itemIds:[o],serverId:b}).show()});break;case"instantmix":MediaController.instantMix(o);break;case"shuffle":MediaController.shuffle(o);break;case"open":"Timer"==d?a.editTimer(o):Dashboard.navigate(C);break;case"album":Dashboard.navigate("itemdetails.html?id="+h);break;case"record":require(["recordingCreator"],function(e){e.show(o,b)});break;case"artist":Dashboard.navigate("itemdetails.html?context=music&id="+v);break;case"play":MediaController.play(o);break;case"playallfromhere":H(g,P(t,"itemsContainer"),"play");break;case"queue":MediaController.queue(o);break;case"trailer":ApiClient.getLocalTrailers(Dashboard.getCurrentUserId(),o).then(function(e){MediaController.play({items:e})});break;case"resume":MediaController.play({ids:[o],startPositionTicks:u});break;case"queueallfromhere":H(g,P(t,"itemsContainer"),"queue");break;case"sync":require(["syncDialog"],function(e){e.showMenu({items:[{Id:o}]})});break;case"editsubtitles":a.editSubtitles(o);break;case"editimages":a.editImages(o);break;case"externalplayer":a.playInExternalPlayer(o);break;case"canceltimer":p(o,P(t,"itemsContainer"));break;case"share":require(["sharingmanager"],function(e){e.showMenu({serverId:b,itemId:o})});break;case"removefromplaylist":var n=P(t,"itemsContainer");n&&n.dispatchEvent(new CustomEvent("removefromplaylist",{detail:{playlistItemId:s},cancelable:!1}));break;case"removefromcollection":var n=P(t,"collectionItems");n&&n.dispatchEvent(new CustomEvent("removefromcollection",{detail:{itemId:o},cancelable:!1}))}}})})})}function h(e,t){var n=e.target;n.classList.contains("card")||n.classList.contains("listItem")||(n=C(n,["listItem","card"]));var r=n.getAttribute("data-itemid"),i=n.getAttribute("data-itemtype"),o="true"==n.getAttribute("data-isfolder"),s=n.getAttribute("data-mediatype"),l=parseInt(n.getAttribute("data-positionticks"));return("MusicAlbum"==i||"MusicArtist"==i||"MusicGenre"==i||"Playlist"==i)&&(o=!0),"Program"==i&&(r=n.getAttribute("data-channelid")),a.showPlayMenu(t,r,i,o,s,l),e.preventDefault(),!1}function v(e){for(;null!=e;){var t=e.tagName||"";return"A"==t||-1!=t.indexOf("BUTTON")||-1!=t.indexOf("INPUT")?!0:!1}return!1}function b(e){var t=P(e.target,"cardOverlayPlayButton");if(t)return h(e,t);var a=P(e.target,"listviewMenuButton")||P(e.target,"cardOverlayMoreButton");if(a)return g(a,{}),e.stopPropagation(),e.preventDefault(),!1;var n=P(e.target,"btnUserItemRating");if(n)return e.stopPropagation(),e.preventDefault(),!1;var r=P(e.target,"card");if(r){var i=r.querySelector(".itemSelectionPanel");if(i)return x(e,i);if(r.classList.contains("groupedCard"))return y(e,r)}}function y(e,t){var n=t.getAttribute("data-itemid"),r=t.getAttribute("data-context"),i=Dashboard.getCurrentUserId(),o=t.querySelector(".playedIndicator"),s=o?o.innerHTML:null,l={Limit:parseInt(s||"10"),Fields:"PrimaryImageAspectRatio,DateCreated",ParentId:n,GroupItems:!1},d=e.target;return v(d)?void 0:(ApiClient.getJSON(ApiClient.getUrl("Users/"+i+"/Items/Latest",l)).then(function(e){if(1==e.length)return void Dashboard.navigate(a.getHref(e[0],r));var t="itemdetails.html?id="+n;r&&(t+="&context="+r),Dashboard.navigate(t)}),e.stopPropagation(),e.preventDefault(),!1)}function I(e,t){return t.filter(function(t){return e.classList.contains(t)}).length>0}function C(e,t){for(;!e.classList||!I(e,t);)if(e=e.parentNode,!e)return null;return e}function P(e,t){for(;!e.classList||!e.classList.contains(t);)if(e=e.parentNode,!e)return null;return e}function A(e){if(e.classList.contains("itemsContainer"))return void L(e);for(var t=e.querySelectorAll(".itemsContainer"),a=0,n=t.length;n>a;a++)L(t[a])}function L(e){a.allowSwipe(e)&&(e.classList.contains("hasTapHold")||(require(["hammer"],function(t){var a=new t.Manager(e),n=new t.Press({time:500});a.add(n),e.classList.add("hasTapHold"),a.on("press",w)}),S(e)))}function S(e){var a=P(e,"page");if(a&&!(a.classList.contains("homePage")||a.classList.contains("itemDetailPage")||a.classList.contains("liveTvPage"))){var n="8";t.getItem("tapholdhelp")!=n&&(t.setItem("tapholdhelp",n),Dashboard.alert({message:Globalize.translate("TryMultiSelectMessage"),title:Globalize.translate("HeaderTryMultiSelect")}))}}function k(e){return e.preventDefault(),e.stopPropagation(),!1}function w(e){var t=P(e.target,"card");return t?(E(t),e.stopPropagation&&e.stopPropagation(),e.preventDefault(),!1):(e.preventDefault(),e.stopPropagation&&e.stopPropagation(),!1)}function x(e,t){if(!P(e.target,"chkItemSelect")){var a=t.querySelector(".chkItemSelect");if(a)if(a.classList.contains("checkedInitial"))a.classList.remove("checkedInitial");else{var n=!a.checked;a.checked=n,G(a,n)}}return e.preventDefault(),e.stopPropagation(),!1}function D(){G(this,this.checked)}function M(e,t){var a=e.querySelector(".itemSelectionPanel");if(!a){a=document.createElement("div"),a.classList.add("itemSelectionPanel"),e.querySelector(".cardContent").appendChild(a);var n="chkItemSelect";t&&!browserInfo.firefox&&(n+=" checkedInitial");var r=t?" checked":"";a.innerHTML='<label class="checkboxContainer"><input type="checkbox" is="emby-checkbox" class="'+n+'"'+r+"/><span></span></label>>";var i=a.querySelector(".chkItemSelect");i.addEventListener("change",D)}}function q(){var e=document.querySelector(".selectionCommandsPanel");if(!e){e=document.createElement("div"),e.classList.add("selectionCommandsPanel"),document.body.appendChild(e);var t="";t+='<div style="float:left;">',t+='<button is="paper-icon-button-light" class="btnCloseSelectionPanel autoSize"><i class="md-icon">close</i></button>',t+='<span class="itemSelectionCount"></span>',t+="</div>",t+='<button is="paper-icon-button-light" class="btnSelectionPanelOptions autoSize" style="margin-left:auto;"><i class="md-icon">more_vert</i></button>',e.innerHTML=t,e.querySelector(".btnCloseSelectionPanel").addEventListener("click",z);var a=e.querySelector(".btnSelectionPanelOptions");a.addEventListener("click",B),browserInfo.mobile||T(a,1)}}function T(e,t){var a=[{transform:"translate3d(0, 0, 0)",offset:0},{transform:"translate3d(-10px, 0, 0)",offset:.1},{transform:"translate3d(10px, 0, 0)",offset:.2},{transform:"translate3d(-10px, 0, 0)",offset:.3},{transform:"translate3d(10px, 0, 0)",offset:.4},{transform:"translate3d(-10px, 0, 0)",offset:.5},{transform:"translate3d(10px, 0, 0)",offset:.6},{transform:"translate3d(-10px, 0, 0)",offset:.7},{transform:"translate3d(10px, 0, 0)",offset:.8},{transform:"translate3d(-10px, 0, 0)",offset:.9},{transform:"translate3d(0, 0, 0)",offset:1}],n={duration:900,iterations:t};e.animate&&e.animate(a,n)}function E(e){require(["emby-checkbox"],function(){for(var t=document.querySelectorAll(".card"),a=0,n=t.length;n>a;a++)M(t[a],e==t[a]);q(),G(e,!0)})}function z(){var e=document.querySelector(".selectionCommandsPanel");if(e){e.parentNode.removeChild(e),Q=[];for(var t=document.querySelectorAll(".itemSelectionPanel"),a=0,n=t.length;n>a;a++)t[a].parentNode.removeChild(t[a])}}function G(e,t){var a=P(e,"card").getAttribute("data-itemid");if(t){var n=Q.filter(function(e){return e==a});n.length||Q.push(a)}else Q=Q.filter(function(e){return e!=a});if(Q.length){var r=document.querySelector(".itemSelectionCount");r&&(r.innerHTML=Q.length)}else z()}function B(e){Dashboard.getCurrentUser().then(function(t){var r=[];r.push({name:Globalize.translate("ButtonAddToCollection"),id:"addtocollection",ironIcon:"add"}),r.push({name:Globalize.translate("ButtonAddToPlaylist"),id:"playlist",ironIcon:"playlist-add"}),t.Policy.EnableContentDeletion&&r.push({name:Globalize.translate("ButtonDelete"),id:"delete",ironIcon:"delete"}),t.Policy.EnableContentDownloading&&n.supports("filedownload"),r.push({name:Globalize.translate("HeaderGroupVersions"),id:"groupvideos",ironIcon:"call-merge"}),r.push({name:Globalize.translate("MarkPlayed"),id:"markplayed"}),r.push({name:Globalize.translate("MarkUnplayed"),id:"markunplayed"}),r.push({name:Globalize.translate("ButtonRefresh"),id:"refresh",ironIcon:"refresh"}),r.push({name:Globalize.translate("ButtonSync"),id:"sync",ironIcon:"sync"}),require(["actionsheet"],function(t){t.show({items:r,positionTo:e.target,callback:function(t){var n=Q.slice(0),r=ApiClient.serverInfo().Id;switch(t){case"addtocollection":require(["collectionEditor"],function(e){(new e).show({items:n,serverId:r})}),z();break;case"playlist":require(["playlistEditor"],function(e){(new e).show({items:n,serverId:r})}),z();break;case"delete":a.deleteItems(n).then(function(){Dashboard.navigate("home.html")}),z();break;case"groupvideos":O(P(e.target,"page"),n);break;case"markplayed":n.forEach(function(e){ApiClient.markPlayed(Dashboard.getCurrentUserId(),e)}),z();break;case"markunplayed":n.forEach(function(e){ApiClient.markUnplayed(Dashboard.getCurrentUserId(),e)}),z();break;case"refresh":require(["refreshDialog"],function(e){new e({itemIds:n,serverId:r}).show()}),z();break;case"sync":require(["syncDialog"],function(e){e.showMenu({items:n.map(function(e){return{Id:e}})})}),z()}}})})})}function O(e,t){if(t.length<2)return void Dashboard.alert({message:Globalize.translate("MessagePleaseSelectTwoItems"),title:Globalize.translate("HeaderError")});var a=Globalize.translate("MessageTheSelectedItemsWillBeGrouped");require(["confirm"],function(n){n(a,Globalize.translate("HeaderGroupVersions")).then(function(){Dashboard.showLoadingMsg(),ApiClient.ajax({type:"POST",url:ApiClient.getUrl("Videos/MergeVersions",{Ids:t.join(",")})}).then(function(){Dashboard.hideLoadingMsg(),z(),e.querySelector(".itemsContainer").dispatchEvent(new CustomEvent("needsrefresh",{}))})})})}function U(e){var t=P(e.target,"itemWithAction");if(t){var n=t.getAttribute("data-action"),r=t;if(n)for(;!r.getAttribute("data-itemid");)r=r.parentNode;var i,o,s=r.getAttribute("data-itemid");if("play"==n)MediaController.play(s);else if("playallfromhere"==n)i=r.getAttribute("data-index"),o=P(t,"itemsContainer"),H(i,o,"play");else if("instantmix"==n)MediaController.instantMix(s);else if("edit"==n){var l=r.getAttribute("data-itemtype");"Timer"==l?a.editTimer(s):a.editMetadata(s)}return e.stopPropagation(),e.preventDefault(),!1}}function H(e,t,a){for(var n=[],r=t.querySelectorAll(".mediaItem"),i=0,o=r.length;o>i;i++){for(var s=r[i],l=s.getAttribute("data-itemid");!l;)s=s.parentNode,l=s.getAttribute("data-itemid");n.push(l)}n=n.slice(e),ApiClient.getItems(Dashboard.getCurrentUserId(),{Ids:n.join(","),Fields:"MediaSources,Chapters",Limit:100}).then(function(e){MediaController[a]({items:e.Items})})}function N(e){var t=window.ApiClient;t&&t.getCurrentUserId()&&Dashboard.getCurrentUser().then(function(t){for(var n={SupportsSync:!0},r=e.querySelectorAll(".categorySyncButton"),i=0,o=r.length;o>i;i++)a.enableSync(n,t)?r[i].classList.remove("hide"):r[i].classList.add("hide")})}function F(){var e=this,t=e.getAttribute("data-category"),a=LibraryMenu.getTopParentId();require(["syncDialog"],function(e){e.showMenu({ParentId:a,Category:t})})}function R(e,t){if(t.Played){var n=e.querySelector(".playedIndicator");n||(n=document.createElement("div"),n.classList.add("playedIndicator"),e.querySelector(".cardContent").appendChild(n)),n.innerHTML='<i class="md-icon">check</i>'}else if(t.UnplayedItemCount){var n=e.querySelector(".playedIndicator");n||(n=document.createElement("div"),n.classList.add("playedIndicator"),e.querySelector(".cardContent").appendChild(n)),n.innerHTML=t.UnplayedItemCount}var r,i=a.getItemProgressBarHtml(t);if(i){if(r=e.querySelector(".cardProgress"),!r){r=document.createElement("div"),r.classList.add("cardProgress");var o=e.querySelector(".cardFooter");o&&o.appendChild(r)}r.innerHTML=i}else r=e.querySelector(".cardProgress"),r&&r.parentNode.removeChild(r)}function V(e){for(var t=document.querySelectorAll("*[data-itemid='"+e.ItemId+"']"),a=0,n=t.length;n>a;a++){var r=t[a],i=r.getAttribute("data-mediatype");"Video"==i&&(r.setAttribute("data-positionticks",e.PlaybackPositionTicks||0),r.classList.contains("card")&&R(r,e))}}function _(e,t){var a=t;if("UserDataChanged"===a.MessageType&&a.Data.UserId==Dashboard.getCurrentUserId())for(var n=0,r=a.Data.UserDataList.length;r>n;n++)V(a.Data.UserDataList[n])}function Y(e){Events.off(e,"websocketmessage",_),Events.on(e,"websocketmessage",_)}var j;a.createCardMenus=function(e){function t(e){if(e=e.querySelector("a"),!e.querySelector(".itemSelectionPanel")){var t=e.querySelector(".cardOverlayTarget");t||(t=document.createElement("div"),t.classList.add("hide"),t.classList.add("cardOverlayTarget"),P(e,"cardContent").appendChild(t));for(var a=e;a&&!a.getAttribute("data-itemid");)a=a.parentNode;var n=a.getAttribute("data-itemid"),r=a.getAttribute("data-commands").split(","),i=ApiClient.getItem(Dashboard.getCurrentUserId(),n),o=Dashboard.getCurrentUser();Promise.all([i,o]).then(function(a){for(var n=a[0],i=a[1],o=e;!o.classList.contains("card");)o=o.parentNode;t.innerHTML=d(n,i,o,r);var s=t.querySelector(".btnPlayItem");s&&s.addEventListener("click",u);var l=t.querySelector(".btnPlayTrailer");l&&l.addEventListener("click",c);var f=t.querySelector(".btnMoreCommands");f&&f.addEventListener("click",m)}),l(t)}}function a(e){var a=e.target;if(a.classList.contains("cardImage")){if(r===!0)return void(r=!1);for(j&&(clearTimeout(j),j=null);!a.classList.contains("card");)a=a.parentNode;j=setTimeout(function(){t(a)},1200)}}function n(){r=!0}var r=!1;e.removeEventListener("click",b),e.addEventListener("click",b),AppInfo.isTouchPreferred?(e.removeEventListener("contextmenu",k),e.addEventListener("contextmenu",k)):(e.removeEventListener("contextmenu",f),e.addEventListener("contextmenu",f),e.removeEventListener("mouseenter",a),e.addEventListener("mouseenter",a,!0),e.removeEventListener("mouseleave",o),e.addEventListener("mouseleave",o,!0),e.removeEventListener("touchstart",n),e.addEventListener("touchstart",n)),A(e)};var Q=[];pageClassOn("pageinit","libraryPage",function(){var e=this;e.addEventListener("click",U);var t,n,r=e.querySelectorAll(".itemsContainer:not(.noautoinit)");for(t=0,n=r.length;n>t;t++)a.createCardMenus(r[t]);var i=e.querySelectorAll(".categorySyncButton");for(t=0,n=i.length;n>t;t++)i[t].addEventListener("click",F)}),pageClassOn("pageshow","libraryPage",function(){var e=this;Dashboard.isServerlessPage()||N(e)}),pageClassOn("pagebeforehide","libraryPage",function(){z()}),window.ApiClient&&Y(window.ApiClient),Events.on(ConnectionManager,"apiclientcreated",function(e,t){Y(t)})});