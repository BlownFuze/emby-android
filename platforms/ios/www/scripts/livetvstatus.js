define(["jQuery","scripts/taskbutton","listViewStyle"],function(e,t){function i(e,t){var i=Globalize.translate("MessageConfirmResetTuner");require(["confirm"],function(n){n(i,Globalize.translate("HeaderResetTuner")).then(function(){Dashboard.showLoadingMsg(),ApiClient.resetLiveTvTuner(t).then(function(){Dashboard.hideLoadingMsg(),l(e)})})})}function n(t,n){var a="";if(n.length){a+='<div class="paperList">';for(var s=0,r=n.length;r>s;s++){var o=n[s];a+='<div class="listItem">',a+='<i class="listItemIcon md-icon">live_tv</i>',a+='<div class="listItemBody two-line">',a+='<h3 class="listItemBodyText">',a+=o.Name,a+="</h3>",a+='<div class="listItemBodyText secondary">',a+=o.SourceType,a+="</div>",a+='<div class="listItemBodyText secondary">',"RecordingTv"==o.Status?o.ChannelName?(a+='<a href="itemdetails.html?id='+o.ChannelId+'">',a+=Globalize.translate("StatusRecordingProgram").replace("{0}",o.ChannelName),a+="</a>"):a+=Globalize.translate("StatusRecording"):"LiveTv"==o.Status?o.ChannelName?(a+='<a href="itemdetails.html?id='+o.ChannelId+'">',a+=Globalize.translate("StatusWatchingProgram").replace("{0}",o.ChannelName),a+="</a>"):a+=Globalize.translate("StatusWatching"):a+=o.Status,a+="</div>",a+="</div>",o.CanReset&&(a+='<button type="button" is="paper-icon-button-light" data-tunerid="'+o.Id+'" title="'+Globalize.translate("ButtonResetTuner")+'" class="btnResetTuner"><i class="md-icon">refresh</i></button>'),a+="</div>"}a+="</div>"}n.length?t.querySelector(".tunerSection").classList.remove("hide"):t.querySelector(".tunerSection").classList.add("hide");var l=e(".tunerList",t).html(a);e(".btnResetTuner",l).on("click",function(){var e=this.getAttribute("data-tunerid");i(t,e)})}function a(e){var t="";t+="<div>";var i=e.HomePageUrl||"#";t+='<p><a href="'+i+'" target="_blank">'+e.Name+"</a></p>";var n=e.Version||"Unknown";n+=e.HasUpdateAvailable?' <a style="margin-left: .25em;" href="'+i+'" target="_blank">'+Globalize.translate("LiveTvUpdateAvailable")+"</a>":'<img src="css/images/checkmarkgreen.png" style="height: 17px; margin-left: 10px; margin-right: 0; position: relative; top: 5px; border-radius:3px;" /> '+Globalize.translate("LabelVersionUpToDate"),t+="<p>"+n+"</p>";var a=e.Status;return"Ok"==e.Status?a='<span style="color:green;">'+a+"</span>":(e.StatusMessage&&(a+=" ("+e.StatusMessage+")"),a='<span style="color:red;">'+a+"</span>"),t+="<p>"+Globalize.translate("ValueStatus",a)+"</p>",t+="</div>"}function s(t,i){i.IsEnabled?e(".liveTvStatusContent",t).show():e(".liveTvStatusContent",t).hide();var s=i.Services.filter(function(e){return e.IsVisible});s.length?e(".servicesSection",t).show():e(".servicesSection",t).hide(),e(".servicesList",t).html(s.map(a).join(""));for(var o=[],l=0,c=i.Services.length;c>l;l++)for(var d=0,v=i.Services[l].Tuners.length;v>d;d++)o.push(i.Services[l].Tuners[d]);n(t,o),ApiClient.getNamedConfiguration("livetv").then(function(e){r(t,e.TunerHosts),u(t,e.ListingProviders)}),Dashboard.hideLoadingMsg()}function r(t,i){var n="";if(i.length){n+='<div class="paperList">';for(var a=0,s=i.length;s>a;a++){var r=i[a],l="livetvtunerprovider-"+r.Type+".html?id="+r.Id;n+='<div class="listItem">',n+='<i class="listItemIcon md-icon">live_tv</i>',n+='<div class="listItemBody two-line">',n+='<a class="clearLink" href="'+l+'">',n+='<h3 class="listItemBodyText">',n+=r.FriendlyName||m(r.Type),n+="</h3>",n+='<div class="listItemBodyText secondary">',n+=r.Url,n+="</div>",n+="</a>",n+="</div>",n+='<button type="button" is="paper-icon-button-light" class="btnDeleteDevice" data-id="'+r.Id+'" title="'+Globalize.translate("ButtonDelete")+'"><i class="md-icon">delete</i></button>',n+="</div>"}n+="</div>"}var c=e(".devicesList",t).html(n);e(".btnDeleteDevice",c).on("click",function(){var e=this.getAttribute("data-id");o(t,e)})}function o(e,t){var i=Globalize.translate("MessageConfirmDeleteTunerDevice");require(["confirm"],function(n){n(i,Globalize.translate("HeaderDeleteDevice")).then(function(){Dashboard.showLoadingMsg(),ApiClient.ajax({type:"DELETE",url:ApiClient.getUrl("LiveTv/TunerHosts",{Id:t})}).then(function(){l(e)})})})}function l(e){Dashboard.showLoadingMsg(),ApiClient.getLiveTvInfo().then(function(t){s(e,t)},function(){s(e,{Services:[],IsEnabled:!0})})}function c(t){t.querySelector(".dlgAddDevice").close(),Dashboard.showLoadingMsg(),ApiClient.ajax({type:"POST",url:ApiClient.getUrl("LiveTv/TunerHosts"),data:JSON.stringify({Type:e("#selectTunerDeviceType",t).val(),Url:e("#txtDevicePath",t).val()}),contentType:"application/json"}).then(function(){l(t)},function(){Dashboard.alert({message:Globalize.translate("ErrorAddingTunerDevice")})})}function u(t,i){var n="";if(i.length){n+='<div class="paperList">';for(var a=0,s=i.length;s>a;a++){var r=i[a];n+='<div class="listItem">',n+='<i class="listItemIcon md-icon">dvr</i>',n+='<div class="listItemBody two-line">',n+='<a class="clearLink" href="'+f(r.Type)+"&id="+r.Id+'">',n+='<h3 class="listItemBodyText">',n+=p(r.Type),n+="</h3>",n+="</a>",n+="</div>",n+='<button type="button" is="paper-icon-button-light" class="btnOptions" data-id="'+r.Id+'"><i class="md-icon">more_vert</i></button>',n+="</div>"}n+="</div>"}var o=e(".providerList",t).html(n);e(".btnOptions",o).on("click",function(){var e=this.getAttribute("data-id");d(t,e,this)})}function d(e,t,i){var n=[];n.push({name:Globalize.translate("ButtonDelete"),id:"delete"}),n.push({name:Globalize.translate("MapChannels"),id:"map"}),require(["actionsheet"],function(a){a.show({items:n,positionTo:i}).then(function(i){switch(i){case"delete":h(e,t);break;case"map":v(e,t)}})})}function v(e,t){require(["components/channelmapper/channelmapper"],function(e){new e({serverId:ApiClient.serverInfo().Id,providerId:t}).show()})}function h(e,t){var i=Globalize.translate("MessageConfirmDeleteGuideProvider");require(["confirm"],function(n){n(i,Globalize.translate("HeaderDeleteProvider")).then(function(){Dashboard.showLoadingMsg(),ApiClient.ajax({type:"DELETE",url:ApiClient.getUrl("LiveTv/ListingProviders",{Id:t})}).then(function(){l(e)},function(){l(e)})})})}function m(e){switch(e=e.toLowerCase()){case"m3u":return"M3U Playlist";case"hdhomerun":return"HDHomerun";case"satip":return"DVB";default:return"Unknown"}}function p(e){switch(e=e.toLowerCase()){case"schedulesdirect":return"Schedules Direct";case"xmltv":return"Xml TV";case"emby":return"Emby Guide";default:return"Unknown"}}function f(e){switch(e=e.toLowerCase()){case"xmltv":return"livetvguideprovider.html?type=xmltv";case"schedulesdirect":return"livetvguideprovider.html?type=schedulesdirect";case"emby":return"livetvguideprovider.html?type=emby"}}function b(e){var t=[];t.push({name:"Schedules Direct",id:"SchedulesDirect"}),t.push({name:"Xml TV",id:"xmltv"}),t.push({name:Globalize.translate("ButtonOther"),id:"other"}),require(["actionsheet"],function(i){i.show({items:t,positionTo:e,callback:function(e){"other"==e?Dashboard.alert({message:Globalize.translate("ForAdditionalLiveTvOptions")}):Dashboard.navigate(f(e))}})})}function g(e){var t=[];t.push({name:"HDHomerun",id:"hdhomerun"}),t.push({name:m("m3u"),id:"m3u"}),t.push({name:Globalize.translate("ButtonOther"),id:"other"}),require(["actionsheet"],function(i){i.show({items:t,positionTo:e,callback:function(e){"other"==e?Dashboard.alert({message:Globalize.translate("ForAdditionalLiveTvOptions")}):Dashboard.navigate("livetvtunerprovider-"+e+".html")}})})}function T(){return[{href:"livetvstatus.html",name:Globalize.translate("TabDevices")},{href:"livetvsettings.html",name:Globalize.translate("TabSettings")},{href:"appservices.html?context=livetv",name:Globalize.translate("TabServices")}]}e(document).on("pageinit","#liveTvStatusPage",function(){var t=this;e(".btnAddDevice",t).on("click",function(){g(this)}),e(".formAddDevice",t).on("submit",function(){return c(t),!1}),e(".btnAddProvider",t).on("click",function(){b(this)})}).on("pageshow","#liveTvStatusPage",function(){LibraryMenu.setTabs("livetvadmin",0,T);var e=this;l(e),t({mode:"on",progressElem:e.querySelector(".refreshGuideProgress"),taskKey:"RefreshGuide",button:e.querySelector(".btnRefresh")})}).on("pagehide","#liveTvStatusPage",function(){var e=this;t({mode:"off",progressElem:e.querySelector(".refreshGuideProgress"),taskKey:"RefreshGuide",button:e.querySelector(".btnRefresh")})})});