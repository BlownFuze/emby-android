define(["appSettings"],function(e){function t(t,a,n){Dashboard.showLoadingMsg(),e.enableAutoLogin(!0),ConnectionManager.loginToConnect(a,n).then(function(){Dashboard.hideLoadingMsg(),Dashboard.navigate("selectserver.html")},function(){Dashboard.hideLoadingMsg(),Dashboard.alert({message:Globalize.translate("MessageInvalidUser"),title:Globalize.translate("HeaderLoginFailure")}),t.querySelector("#txtManualPassword").value=""})}function a(e,t){switch(Dashboard.hideLoadingMsg(),t.State){case MediaBrowser.ConnectionState.SignedIn:var a=t.ApiClient;Dashboard.onServerChanged(a.getCurrentUserId(),a.accessToken(),a),Dashboard.navigate("home.html");break;case MediaBrowser.ConnectionState.ServerSignIn:Dashboard.navigate("login.html?serverid="+t.Servers[0].Id,!1,"none");break;case MediaBrowser.ConnectionState.ServerSelection:Dashboard.navigate("selectserver.html",!1,"none");break;case MediaBrowser.ConnectionState.ConnectSignIn:o(e,"welcome");break;case MediaBrowser.ConnectionState.ServerUpdateNeeded:Dashboard.alert({message:Globalize.translate("ServerUpdateNeeded",'<a href="https://emby.media">https://emby.media</a>')});break;case MediaBrowser.ConnectionState.Unavailable:Dashboard.alert({message:Globalize.translate("MessageUnableToConnectToServer"),title:Globalize.translate("HeaderConnectionFailure")})}}function n(t){Dashboard.showLoadingMsg(),ConnectionManager.connect({enableAutoLogin:e.enableAutoLogin()}).then(function(e){a(t,e)})}function r(e,t){var a=t.mode||"auto";if("auto"==a){if(AppInfo.isNativeApp)return void n(e);a="connect"}o(e,a)}function o(e,t){"welcome"==t?(e.querySelector(".connectLoginForm").classList.add("hide"),e.querySelector(".welcomeContainer").classList.remove("hide"),e.querySelector(".manualServerForm").classList.add("hide"),e.querySelector(".signupForm").classList.add("hide")):"connect"==t?(e.querySelector(".connectLoginForm").classList.remove("hide"),e.querySelector(".welcomeContainer").classList.add("hide"),e.querySelector(".manualServerForm").classList.add("hide"),e.querySelector(".signupForm").classList.add("hide")):"manualserver"==t?(e.querySelector(".manualServerForm").classList.remove("hide"),e.querySelector(".connectLoginForm").classList.add("hide"),e.querySelector(".welcomeContainer").classList.add("hide"),e.querySelector(".signupForm").classList.add("hide")):"signup"==t&&(e.querySelector(".manualServerForm").classList.add("hide"),e.querySelector(".connectLoginForm").classList.add("hide"),e.querySelector(".welcomeContainer").classList.add("hide"),e.querySelector(".signupForm").classList.remove("hide"),c(e))}function i(){Dashboard.navigate("selectserver.html")}function s(){return!AppInfo.isNativeApp&&0==window.location.href.toLowerCase().indexOf("https")}function l(){return AppInfo.isNativeApp||0==window.location.href.toLowerCase().indexOf("https")}function c(e){l()&&s()&&require(["https://www.google.com/recaptcha/api.js?render=explicit"],function(){setTimeout(function(){var t=e.querySelector(".recaptchaContainer");g=grecaptcha.render(t,{sitekey:"6Le2LAgTAAAAAK06Wvttt_yUnbISTy6q3Azqp9po",theme:"dark"})},100)})}function d(t){var n=t.querySelector("#txtServerHost").value,r=t.querySelector("#txtServerPort").value;r&&(n+=":"+r),Dashboard.showLoadingMsg(),ConnectionManager.connectToAddress(n,{enableAutoLogin:e.enableAutoLogin()}).then(function(e){a(t,e)},function(){a(t,{State:MediaBrowser.ConnectionState.Unavailable})})}function u(e){var a=e.querySelector("#txtManualName").value,n=e.querySelector("#txtManualPassword").value;t(e,a,n)}var g;return function(e,t){function a(t){return u(e),t.preventDefault(),!1}function n(t){return d(e),t.preventDefault(),!1}function o(t){if(!l())return t.preventDefault(),!1;var a=e,n=g?grecaptcha.getResponse(g):null;return ConnectionManager.signupForConnect({email:a.querySelector("#txtSignupEmail",a).value,username:a.querySelector("#txtSignupUsername",a).value,password:a.querySelector("#txtSignupPassword",a).value,passwordConfirm:a.querySelector("#txtSignupPasswordConfirm",a).value,grecaptcha:n}).then(function(){Dashboard.alert({message:Globalize.translate("MessageThankYouForConnectSignUp"),callback:function(){Dashboard.navigate("connectlogin.html?mode=welcome")}})},function(e){Dashboard.alert("passwordmatch"==e.errorCode?{message:Globalize.translate("ErrorMessagePasswordNotMatchConfirm")}:"USERNAME_IN_USE"==e.errorCode?{message:Globalize.translate("ErrorMessageUsernameInUse")}:"EMAIL_IN_USE"==e.errorCode?{message:Globalize.translate("ErrorMessageEmailInUse")}:{message:Globalize.translate("DefaultErrorMessage")})}),t.preventDefault(),!1}e.querySelector(".btnSkipConnect").addEventListener("click",i),e.querySelector(".connectLoginForm").addEventListener("submit",a),e.querySelector(".manualServerForm").addEventListener("submit",n),e.querySelector(".signupForm").addEventListener("submit",o),e.querySelector(".btnSignupForConnect").addEventListener("click",function(e){return l()?(e.preventDefault(),e.stopPropagation(),Dashboard.navigate("connectlogin.html?mode=signup"),!1):void 0}),e.querySelector(".btnCancelSignup").addEventListener("click",function(){Emby.Page.back()}),e.querySelector(".btnCancelManualServer").addEventListener("click",function(){Emby.Page.back()}),e.querySelector(".btnWelcomeNext").addEventListener("click",function(){Dashboard.navigate("connectlogin.html?mode=connect")});var s=e.querySelector(".terms");s.innerHTML=Globalize.translate("LoginDisclaimer")+"<div style='margin-top:5px;'><a href='http://emby.media/terms' target='_blank'>"+Globalize.translate("TermsOfUse")+"</a></div>",AppInfo.isNativeApp?(s.classList.add("hide"),e.querySelector(".tvAppInfo").classList.add("hide")):(s.classList.remove("hide"),e.querySelector(".tvAppInfo").classList.remove("hide")),e.addEventListener("viewbeforeshow",function(){var e=this;if(e.querySelector("#txtSignupEmail").value="",e.querySelector("#txtSignupUsername").value="",e.querySelector("#txtSignupPassword").value="",e.querySelector("#txtSignupPasswordConfirm").value="",browserInfo.safari&&AppInfo.isNativeApp)e.querySelector(".embyIntroDownloadMessage").innerHTML=Globalize.translate("EmbyIntroDownloadMessageWithoutLink");else{var t='<a href="http://emby.media" target="_blank">http://emby.media</a>';e.querySelector(".embyIntroDownloadMessage").innerHTML=Globalize.translate("EmbyIntroDownloadMessage",t)}}),e.addEventListener("viewshow",function(){r(e,t)})}});