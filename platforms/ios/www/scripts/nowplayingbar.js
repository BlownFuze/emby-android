define(["datetime","userdataButtons","itemHelper","events","browser","paper-icon-button-light"],function(e,t,n,i,a){function o(){var e="";return e+='<div class="nowPlayingBar hide">',e+='<div class="nowPlayingBarTop">',e+='<div class="nowPlayingBarPositionContainer sliderContainer">',e+='<input type="range" is="emby-slider" pin step=".1" min="0" max="100" value="0" class="nowPlayingBarPositionSlider"/>',e+="</div>",e+='<div class="nowPlayingBarInfoContainer">',e+='<div class="nowPlayingImage"></div>',e+='<div class="nowPlayingBarText"></div>',e+="</div>",e+='<div class="nowPlayingBarCenter">',e+='<button is="paper-icon-button-light" class="previousTrackButton mediaButton autoSize"><i class="md-icon">skip_previous</i></button>',e+='<button is="paper-icon-button-light" class="unpauseButton mediaButton autoSize"><i class="md-icon">play_arrow</i></button>',e+='<button is="paper-icon-button-light" class="pauseButton mediaButton autoSize"><i class="md-icon">pause</i></button>',e+='<button is="paper-icon-button-light" class="stopButton mediaButton autoSize"><i class="md-icon">stop</i></button>',e+='<button is="paper-icon-button-light" class="nextTrackButton mediaButton autoSize"><i class="md-icon">skip_next</i></button>',e+='<div class="nowPlayingBarCurrentTime"></div>',e+="</div>",e+='<div class="nowPlayingBarRight">',e+='<button is="paper-icon-button-light" class="muteButton mediaButton autoSize"><i class="md-icon">volume_up</i></button>',e+='<button is="paper-icon-button-light" class="unmuteButton mediaButton autoSize"><i class="md-icon">volume_off</i></button>',e+='<div class="sliderContainer nowPlayingBarVolumeSliderContainer hide" style="width:100px;vertical-align:middle;display:inline-flex;">',e+='<input type="range" is="emby-slider" pin step="1" min="0" max="100" value="0" class="nowPlayingBarVolumeSlider"/>',e+="</div>",e+='<button is="paper-icon-button-light" class="toggleRepeatButton mediaButton autoSize"><i class="md-icon">repeat</i></button>',e+='<div class="nowPlayingBarUserDataButtons">',e+="</div>",e+='<button is="paper-icon-button-light" class="unpauseButton mediaButton autoSize"><i class="md-icon">play_arrow</i></button>',e+='<button is="paper-icon-button-light" class="pauseButton mediaButton autoSize"><i class="md-icon">pause</i></button>',e+='<button is="paper-icon-button-light" class="remoteControlButton mediaButton autoSize"><i class="md-icon">tablet_android</i></button>',e+='<button is="paper-icon-button-light" class="playlistButton mediaButton autoSize"><i class="md-icon">queue_music</i></button>',e+="</div>",e+="</div>",e+="</div>"}function s(e){if(!e.classList.contains("hide")){var t=function(){e.classList.add("hide")};return!a.animate||a.slow?void t():void requestAnimationFrame(function(){var n=[{transform:"none",offset:0},{transform:"translateY(100%)",offset:1}],i={duration:200,iterations:1,fill:"both",easing:"ease-out"};e.animate(n,i).onfinish=t})}}function l(e){e.classList.contains("hide")&&(e.classList.remove("hide"),a.animate&&!a.slow&&requestAnimationFrame(function(){var t=[{transform:"translateY(100%)",offset:0},{transform:"none",offset:1}],n={duration:200,iterations:1,fill:"both",easing:"ease-out"};e.animate(t,n)}))}function r(){M&&M.pause()}function u(){M&&M.unpause()}function c(t){C=t.querySelector(".nowPlayingBarCurrentTime"),R=t.querySelector(".nowPlayingImage"),q=t.querySelector(".nowPlayingBarText"),A=t.querySelector(".nowPlayingBarUserDataButtons"),x=t.querySelector(".unmuteButton"),x.addEventListener("click",function(){M&&M.unMute()}),N=t.querySelector(".muteButton"),N.addEventListener("click",function(){M&&M.mute()}),t.querySelector(".stopButton").addEventListener("click",function(){M&&M.stop()});var n,i;for(U=t.querySelectorAll(".pauseButton"),n=0,i=U.length;i>n;n++)U[n].addEventListener("click",r);for(D=t.querySelectorAll(".unpauseButton"),n=0,i=D.length;i>n;n++)D[n].addEventListener("click",u);t.querySelector(".nextTrackButton").addEventListener("click",function(){M&&M.nextTrack()}),t.querySelector(".previousTrackButton").addEventListener("click",function(){M&&M.previousTrack()}),t.querySelector(".remoteControlButton").addEventListener("click",function(){d()}),t.querySelector(".playlistButton").addEventListener("click",function(){d(2)}),H=t.querySelector(".toggleRepeatButton"),H.addEventListener("click",function(){if(M){var e=O||{};switch((e.PlayState||{}).RepeatMode){case"RepeatAll":M.setRepeatMode("RepeatOne");break;case"RepeatOne":M.setRepeatMode("RepeatNone");break;default:M.setRepeatMode("RepeatAll")}}}),_=H.querySelector("i"),z=t.querySelector(".nowPlayingBarVolumeSlider"),E=t.querySelector(".nowPlayingBarVolumeSliderContainer"),AppInfo.hasPhysicalVolumeButtons?E.classList.add("hide"):E.classList.remove("hide"),z.addEventListener("change",function(){M&&M.setVolume(this.value)}),V=t.querySelector(".nowPlayingBarPositionSlider"),V.addEventListener("change",function(){if(M&&O){var e=parseFloat(this.value),t=e/100*O.NowPlayingItem.RunTimeTicks;M.seek(Math.floor(t))}}),V.getBubbleText=function(t){var n=O;if(!n||!n.NowPlayingItem||!n.NowPlayingItem.RunTimeTicks)return"--:--";var i=n.NowPlayingItem.RunTimeTicks;return i/=100,i*=t,e.getDisplayRunningTime(i)}}function d(e){Dashboard.navigate(e?"nowplaying.html?tab="+e:"nowplaying.html")}function m(){return F?Promise.resolve(F):new Promise(function(e){require(["appfooter-shared","itemShortcuts","css!css/nowplayingbar.css","emby-slider"],function(t,n){var i=t.element;return(F=i.querySelector(".nowPlayingBar"))?void e(F):(i.insertAdjacentHTML("beforeend",o()),F=i.querySelector(".nowPlayingBar"),a.safari&&a.slow&&F.classList.add("noMediaProgress"),n.on(F),c(F),void e(F))})})}function g(e){e.classList.remove("hide")}function p(e){e.classList.add("hide")}function y(e,t){return t.NowPlayingItem?F?void f(e,t):void m().then(function(){f(e,t)}):void T()}function f(t,n){if(B(),"positionchange"==t.type){var i=(new Date).getTime();if(700>i-Y)return;Y=i}O=n;var a,o,s=MediaController.getPlayerInfo(),l=n.PlayState||{};if(l.IsPaused){for(a=0,o=U.length;o>a;a++)p(U[a]);for(a=0,o=D.length;o>a;a++)g(D[a])}else{for(a=0,o=U.length;o>a;a++)g(U[a]);for(a=0,o=D.length;o>a;a++)p(D[a])}v(n,s);var r=n.NowPlayingItem||{};if(V&&!V.dragging){if(r.RunTimeTicks){var u=l.PositionTicks/r.RunTimeTicks;u*=100,V.value=u}else V.value=0;V.disabled=!l.CanSeek}var c=null==l.PositionTicks?"--:--":e.getDisplayRunningTime(l.PositionTicks);r.RunTimeTicks&&(c+=" / "+e.getDisplayRunningTime(r.RunTimeTicks)),C.innerHTML=c,P(n)}function v(e,t){t=t||MediaController.getPlayerInfo();var n=e.PlayState||{},i=t.supportedCommands,a=!0,o=!0,s=!0;-1==i.indexOf("Mute")&&(a=!1),-1==i.indexOf("Unmute")&&(o=!1),n.IsMuted?a=!1:o=!1,-1==i.indexOf("SetRepeatMode")?H.classList.add("hide"):H.classList.remove("hide"),"RepeatAll"==n.RepeatMode?(_.innerHTML="repeat",H.classList.add("repeatActive")):"RepeatOne"==n.RepeatMode?(_.innerHTML="repeat_one",H.classList.add("repeatActive")):(_.innerHTML="repeat",H.classList.remove("repeatActive")),-1==i.indexOf("SetVolume")&&(s=!1),t.isLocalPlayer&&AppInfo.hasPhysicalVolumeButtons&&(a=!1,o=!1,s=!1),a?g(N):p(N),o?g(x):p(x),z&&(s?E.classList.remove("hide"):E.classList.add("hide"),z.dragging||(z.value=n.VolumeLevel||0))}function h(e,t){t||(t=n.getDisplayName(e));var i='<button data-id="'+e.Id+'" data-type="'+e.Type+'" data-mediatype="'+e.MediaType+'" data-channelid="'+e.ChannelId+'" data-isfolder="'+e.IsFolder+'" type="button" class="itemAction textActionButton" data-action="link">';return i+=t,i+="</button>"}function P(e){q.innerHTML=MediaController.getNowPlayingNames(e.NowPlayingItem).map(function(e){return e.item?"<div>"+h(e.item,e.text)+"</div>":"<div>"+e.text+"</div>"}).join("");var n,i=70,a=e.NowPlayingItem;n=a.PrimaryImageTag?ApiClient.getScaledImageUrl(a.PrimaryImageItemId,{type:"Primary",height:i,tag:a.PrimaryImageTag}):a.BackdropImageTag?ApiClient.getScaledImageUrl(a.BackdropItemId,{type:"Backdrop",height:i,tag:a.BackdropImageTag,index:0}):a.ThumbImageTag?ApiClient.getScaledImageUrl(a.ThumbImageItemId,{type:"Thumb",height:i,tag:a.ThumbImageTag}):"TvChannel"==a.Type||"Recording"==a.Type?"css/images/items/detail/tv.png":"Audio"==a.MediaType?"css/images/items/detail/audio.png":"css/images/items/detail/video.png",n!=j&&(j=n,ImageLoader.lazyImage(R,n),a.Id?ApiClient.getItem(Dashboard.getCurrentUserId(),a.Id).then(function(e){A.innerHTML=t.getIconsHtml({item:e,includePlayed:!1})}):A.innerHTML="")}function b(e,t){var n=this;n.beginPlayerUpdates(),S.call(n,e,t)}function B(){m().then(l)}function T(){var e=document.getElementsByClassName("nowPlayingBar")[0];e&&s(e)}function w(e){var t=this;t.endPlayerUpdates(),T()}function S(e,t){var n=this;n.isDefaultPlayer&&t.NowPlayingItem&&"Video"==t.NowPlayingItem.MediaType||y(e,t)}function I(){M&&(i.off(M,"playbackstart",b),i.off(M,"playbackstop",w),i.off(M,"volumechange",k),i.off(M,"playstatechange",S),i.off(M,"positionchange",S),M.endPlayerUpdates(),M=null,T())}function k(){var e=this;Promise.all([e.getPlayerState(),m()]).then(function(t){var n=t[0];e.isDefaultPlayer&&n.NowPlayingItem&&"Video"==n.NowPlayingItem.MediaType||v(n)})}function L(e){I(),M=e,e.getPlayerState().then(function(t){t.NowPlayingItem&&e.beginPlayerUpdates(),S.call(e,{type:"init"},t)}),i.on(e,"playbackstart",b),i.on(e,"playbackstop",w),i.on(e,"volumechange",k),i.on(e,"playstatechange",S),i.on(e,"positionchange",S)}var M,C,R,q,A,x,N,z,E,D,U,V,H,_,O,F,j,Y=0;i.on(MediaController,"playerchange",function(){L(MediaController.getCurrentPlayer())}),L(MediaController.getCurrentPlayer())});