define(["datetime","userdataButtons","paper-icon-button-light"],function(e,t){function n(){var e="";return e+='<div class="nowPlayingBar hide">',e+='<div class="nowPlayingBarPositionContainer sliderContainer">',e+='<input type="range" is="emby-slider" pin step=".1" min="0" max="100" value="0" class="nowPlayingBarPositionSlider"/>',e+="</div>",e+='<div class="nowPlayingBarInfoContainer">',e+='<div class="nowPlayingImage"></div>',e+='<div class="nowPlayingBarText"></div>',e+="</div>",e+='<div class="nowPlayingBarCenter">',e+='<button is="paper-icon-button-light" class="previousTrackButton mediaButton autoSize"><i class="md-icon">skip_previous</i></button>',e+='<button is="paper-icon-button-light" class="unpauseButton mediaButton autoSize"><i class="md-icon">play_arrow</i></button>',e+='<button is="paper-icon-button-light" class="pauseButton mediaButton autoSize"><i class="md-icon">pause</i></button>',e+='<button is="paper-icon-button-light" class="stopButton mediaButton autoSize"><i class="md-icon">stop</i></button>',e+='<button is="paper-icon-button-light" class="nextTrackButton mediaButton autoSize"><i class="md-icon">skip_next</i></button>',e+='<div class="nowPlayingBarCurrentTime"></div>',e+="</div>",e+='<div class="nowPlayingBarRight">',e+='<button is="paper-icon-button-light" class="muteButton mediaButton autoSize"><i class="md-icon">volume_up</i></button>',e+='<button is="paper-icon-button-light" class="unmuteButton mediaButton autoSize"><i class="md-icon">volume_off</i></button>',e+='<div class="sliderContainer nowPlayingBarVolumeSliderContainer hide" style="width:100px;vertical-align:middle;display:inline-flex;">',e+='<input type="range" is="emby-slider" pin step="1" min="0" max="100" value="0" class="nowPlayingBarVolumeSlider"/>',e+="</div>",e+='<button is="paper-icon-button-light" class="toggleRepeatButton mediaButton autoSize"><i class="md-icon">repeat</i></button>',e+='<div class="nowPlayingBarUserDataButtons">',e+="</div>",e+='<button is="paper-icon-button-light" class="unpauseButton mediaButton autoSize"><i class="md-icon">play_arrow</i></button>',e+='<button is="paper-icon-button-light" class="pauseButton mediaButton autoSize"><i class="md-icon">pause</i></button>',e+='<button is="paper-icon-button-light" class="remoteControlButton mediaButton autoSize"><i class="md-icon">tablet_android</i></button>',e+='<button is="paper-icon-button-light" class="playlistButton mediaButton autoSize"><i class="md-icon">queue_music</i></button>',e+="</div>",e+="</div>"}function i(e){return H||(H=e.offsetHeight),H+"px"}function a(e){if(!e.classList.contains("hide")){var t=function(){e.classList.add("hide")};return!browserInfo.animate||browserInfo.mobile?void t():void requestAnimationFrame(function(){var n=[{height:i(e),offset:0},{height:"0",display:"none",offset:1}],a={duration:200,iterations:1,fill:"both",easing:"ease-out"};e.animate(n,a).onfinish=t})}}function o(e){e.classList.contains("hide")&&(e.classList.remove("hide"),browserInfo.animate&&!browserInfo.mobile&&requestAnimationFrame(function(){var t=[{height:"0",offset:0},{height:i(e),offset:1}],n={duration:200,iterations:1,fill:"both",easing:"ease-out"};e.animate(t,n)}))}function s(){S&&S.pause()}function r(){S&&S.unpause()}function l(t){L=t.querySelector(".nowPlayingBarCurrentTime"),k=t.querySelector(".nowPlayingImage"),M=t.querySelector(".nowPlayingBarText"),C=t.querySelector(".nowPlayingBarUserDataButtons"),R=t.querySelector(".unmuteButton"),R.addEventListener("click",function(){S&&S.unMute()}),q=t.querySelector(".muteButton"),q.addEventListener("click",function(){S&&S.mute()}),t.querySelector(".stopButton").addEventListener("click",function(){S&&S.stop()});var n,i;for(N=t.querySelectorAll(".pauseButton"),n=0,i=N.length;i>n;n++)N[n].addEventListener("click",s);for(A=t.querySelectorAll(".unpauseButton"),n=0,i=A.length;i>n;n++)A[n].addEventListener("click",r);t.querySelector(".nextTrackButton").addEventListener("click",function(){S&&S.nextTrack()}),t.querySelector(".previousTrackButton").addEventListener("click",function(){S&&S.previousTrack()}),t.querySelector(".remoteControlButton").addEventListener("click",function(){u()}),t.querySelector(".playlistButton").addEventListener("click",function(){u(2)}),U=t.querySelector(".toggleRepeatButton"),U.addEventListener("click",function(){if(S){var e=D||{};switch((e.PlayState||{}).RepeatMode){case"RepeatAll":S.setRepeatMode("RepeatOne");break;case"RepeatOne":S.setRepeatMode("RepeatNone");break;default:S.setRepeatMode("RepeatAll")}}}),V=U.querySelector("i"),E=t.querySelector(".nowPlayingBarVolumeSlider"),x=t.querySelector(".nowPlayingBarVolumeSliderContainer"),AppInfo.hasPhysicalVolumeButtons?x.classList.add("hide"):x.classList.remove("hide"),E.addEventListener("change",function(){S&&S.setVolume(this.value)}),z=t.querySelector(".nowPlayingBarPositionSlider"),z.addEventListener("change",function(){if(S&&D){var e=parseFloat(this.value),t=e/100*D.NowPlayingItem.RunTimeTicks;S.seek(Math.floor(t))}}),z.getBubbleText=function(t){var n=D;if(!n||!n.NowPlayingItem||!n.NowPlayingItem.RunTimeTicks)return"--:--";var i=n.NowPlayingItem.RunTimeTicks;return i/=100,i*=t,e.getDisplayRunningTime(i)}}function u(e){Dashboard.navigate(e?"nowplaying.html?tab="+e:"nowplaying.html")}function c(){return _?Promise.resolve(_):new Promise(function(e){require(["itemShortcuts","css!css/nowplayingbar.css","emby-slider"],function(t){return(_=document.querySelector(".nowPlayingBar"))?void e(_):(document.body.insertAdjacentHTML("beforeend",n()),_=document.querySelector(".nowPlayingBar"),browserInfo.safari&&browserInfo.mobile&&_.classList.add("noMediaProgress"),t.on(_),l(_),void e(_))})})}function d(e){e.classList.remove("hide")}function m(e){e.classList.add("hide")}function g(e,t){return t.NowPlayingItem?_?void p(e,t):void c().then(function(){p(e,t)}):void b()}function p(t,n){if(h(),"positionchange"==t.type){var i=(new Date).getTime();if(700>i-F)return;F=i}D=n;var a,o,s=MediaController.getPlayerInfo(),r=n.PlayState||{};if(r.IsPaused){for(a=0,o=N.length;o>a;a++)m(N[a]);for(a=0,o=A.length;o>a;a++)d(A[a])}else{for(a=0,o=N.length;o>a;a++)d(N[a]);for(a=0,o=A.length;o>a;a++)m(A[a])}y(n,s);var l=n.NowPlayingItem||{};if(z&&!z.dragging){if(l.RunTimeTicks){var u=r.PositionTicks/l.RunTimeTicks;u*=100,z.value=u}else z.value=0;z.disabled=!r.CanSeek}var c=e.getDisplayRunningTime(r.PositionTicks);l.RunTimeTicks&&(c+=" / "+e.getDisplayRunningTime(l.RunTimeTicks)),L.innerHTML=c,f(n)}function y(e,t){t=t||MediaController.getPlayerInfo();var n=e.PlayState||{},i=t.supportedCommands,a=!0,o=!0,s=!0;-1==i.indexOf("Mute")&&(a=!1),-1==i.indexOf("Unmute")&&(o=!1),n.IsMuted?a=!1:o=!1,-1==i.indexOf("SetRepeatMode")?U.classList.add("hide"):U.classList.remove("hide"),"RepeatAll"==n.RepeatMode?(V.innerHTML="repeat",U.classList.add("repeatActive")):"RepeatOne"==n.RepeatMode?(V.innerHTML="repeat_one",U.classList.add("repeatActive")):(V.innerHTML="repeat",U.classList.remove("repeatActive")),-1==i.indexOf("SetVolume")&&(s=!1),t.isLocalPlayer&&AppInfo.hasPhysicalVolumeButtons&&(a=!1,o=!1,s=!1),a?d(q):m(q),o?d(R):m(R),E&&(s?x.classList.remove("hide"):x.classList.add("hide"),E.dragging||(E.value=n.VolumeLevel||0))}function f(e){M.innerHTML=MediaController.getNowPlayingNames(e.NowPlayingItem).map(function(e){return e.item?"<div>"+LibraryBrowser.getTextActionButton(e.item,e.text)+"</div>":"<div>"+e.text+"</div>"}).join("");var n,i=80,a=e.NowPlayingItem;n=a.PrimaryImageTag?ApiClient.getScaledImageUrl(a.PrimaryImageItemId,{type:"Primary",height:i,tag:a.PrimaryImageTag}):a.BackdropImageTag?ApiClient.getScaledImageUrl(a.BackdropItemId,{type:"Backdrop",height:i,tag:a.BackdropImageTag,index:0}):a.ThumbImageTag?ApiClient.getScaledImageUrl(a.ThumbImageItemId,{type:"Thumb",height:i,tag:a.ThumbImageTag}):"TvChannel"==a.Type||"Recording"==a.Type?"css/images/items/detail/tv.png":"Audio"==a.MediaType?"css/images/items/detail/audio.png":"css/images/items/detail/video.png",n!=O&&(O=n,ImageLoader.lazyImage(k,n),a.Id?ApiClient.getItem(Dashboard.getCurrentUserId(),a.Id).then(function(e){C.innerHTML=t.getIconsHtml({item:e,includePlayed:!1})}):C.innerHTML="")}function v(e,t){var n=this;n.beginPlayerUpdates(),B.call(n,e,t)}function h(){c().then(o)}function b(){var e=document.getElementsByClassName("nowPlayingBar")[0];e&&a(e)}function P(e){var t=this;t.endPlayerUpdates(),b()}function B(e,t){var n=this;n.isDefaultPlayer&&t.NowPlayingItem&&"Video"==t.NowPlayingItem.MediaType||g(e,t)}function T(){S&&(Events.off(S,"playbackstart",v),Events.off(S,"playbackstop",P),Events.off(S,"volumechange",w),Events.off(S,"playstatechange",B),Events.off(S,"positionchange",B),S.endPlayerUpdates(),S=null,b())}function w(){var e=this;Promise.all([e.getPlayerState(),c()]).then(function(t){var n=t[0];e.isDefaultPlayer&&n.NowPlayingItem&&"Video"==n.NowPlayingItem.MediaType||y(n)})}function I(e){T(),S=e,e.getPlayerState().then(function(t){t.NowPlayingItem&&e.beginPlayerUpdates(),B.call(e,{type:"init"},t)}),Events.on(e,"playbackstart",v),Events.on(e,"playbackstop",P),Events.on(e,"volumechange",w),Events.on(e,"playstatechange",B),Events.on(e,"positionchange",B)}var S,L,k,M,C,R,q,E,x,A,N,z,U,V,D,H,_,O,F=0;Events.on(MediaController,"playerchange",function(){I(MediaController.getCurrentPlayer())}),I(MediaController.getCurrentPlayer())});