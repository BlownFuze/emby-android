define(["jQuery","paper-icon-button-light"],function(e){function t(e,t){var a=Globalize.translate("CancelSyncJobConfirmation");require(["confirm"],function(n){n(a,Globalize.translate("HeaderCancelSyncJob")).then(function(){Dashboard.showLoadingMsg(),ApiClient.ajax({url:ApiClient.getUrl("Sync/Jobs/"+t),type:"DELETE"}).then(function(){l(e)})})})}function a(e){var t=".85",a="rgba(204,51,51,"+t+")",n=Globalize.translate("SyncJobStatus"+e.Status);"Completed"==e.Status?a="rgba(82, 181, 75, "+t+")":"CompletedWithError"==e.Status||("Queued"==e.Status?a="rgba(51, 136, 204, "+t+")":"ReadyToTransfer"==e.Status?a="rgba(51, 136, 204, "+t+")":"Transferring"==e.Status?a="rgba(72, 0, 255, "+t+")":"Converting"==e.Status&&(a="rgba(255, 106, 0, "+t+")"));var r="";return r+='<div class="syncStatusBanner" data-status="'+e.Status+'" style="background-color:'+a+';position:absolute;top:0;right:0;padding:.5em .5em; text-align:left;color: #fff; font-weight: 500; text-transform:uppercase; border-bottom-left-radius: 3px;">',r+=n,r+="</div>"}function n(e,t,n,r){var i="";i+="<div class='card squareCard' data-id='"+t.Id+"' data-status='"+t.Status+"'>",i+='<div class="'+n+'">',i+='<div class="cardScalable">',i+='<div class="cardPadder"></div>',r+="?id="+t.Id,i+='<a class="cardContent" href="'+r+'">';var o,s="";t.PrimaryImageItemId?(o=ApiClient.getScaledImageUrl(t.PrimaryImageItemId,{type:"Primary",width:400,tag:t.PrimaryImageTag}),s="background-position:center center;"):(s="background-color:#38c;background-position:center center;",o="css/images/items/detail/video.png"),i+='<div class="cardImage coveredCardImage lazy" data-src="'+o+'" style="'+s+'">';var c=t.Progress||0,l="cardFooter fullCardFooter lightCardFooter";(0==c||c>=100)&&(l+=" hide"),i+='<div class="'+l+'">',i+="<div class='cardText cardProgress'>",i+='<progress class="itemProgressBar" min="0" max="100" value="'+c+'"></progress>',i+="</div>",i+="</div>",i+="</div>",i+=a(t),i+="</a>",i+="</div>",i+='<div class="cardFooter outerCardFooter">';var d=[];t.ParentName&&d.push(t.ParentName),d.push(t.Name),d.push(1==t.ItemCount?Globalize.translate("ValueItemCount",t.ItemCount):Globalize.translate("ValueItemCountPlural",t.ItemCount)),t.ParentName||d.push("&nbsp;"),i+='<div class="cardText" style="text-align:right; float:right;padding:0;">',i+='<button type="button" is="paper-icon-button-light" class="btnJobMenu"><iron-icon icon="'+AppInfo.moreIcon+'"></iron-icon></button>',i+="</div>";for(var u=0,g=d.length;g>u;u++)i+="<div class='cardText' style='margin-right:30px;'>",i+=d[u],i+="</div>";return i+="</div>",i+="</div>",i+="</div>"}function r(t,a){if((new Date).getTime()-b<6e4)return void i(t,a);b=(new Date).getTime();var r="",o="",l="cardBox visualCardBox",d="syncjob.html",u=!0;e(t).hasClass("mySyncPage")&&(d="mysyncjob.html",u=!c());for(var g=0,v=a.length;v>g;g++){var m=a[g];if(u){var p=m.TargetName||"Unknown";p!=o&&(o&&(r+="<br/>",r+="<br/>",r+="<br/>"),o=p,r+='<div class="detailSectionHeader">',r+="<div>"+p+"</div>",r+="</div>")}r+=n(t,m,l,d)}var h=e(".syncActivity",t).html(r).lazyChildren();e(".btnJobMenu",h).on("click",function(){s(t,this)}),a.length||h.html('<div style="padding:1em .25em;">'+Globalize.translate("MessageNoSyncJobsFound")+"</div>")}function i(e,t){for(var a=0,n=t.length;n>a;a++){var r=t[a];o(e,r)}}function o(e,t){var n=e.querySelector(".card[data-id='"+t.Id+"']");if(n){var r=n.querySelector(".syncStatusBanner");if(r.getAttribute("data-status")==t.Status){var i=document.createElement("div");i.innerHTML=a(t),i=i.querySelector(".syncStatusBanner"),i.parentNode.removeChild(i),r.parentNode.replaceChild(i,r)}var o=t.Progress||0,s=n.querySelector(".cardFooter");0==o||o>=100?s.classList.add("hide"):(s.classList.remove("hide"),s.querySelector(".itemProgressBar").value=o)}}function s(a,n){var r=e(n).parents(".card"),i=r.attr("data-id"),o=r.attr("data-status"),s=[];s.push("Cancelled"==o?{name:Globalize.translate("ButtonDelete"),id:"delete",ironIcon:"delete"}:{name:Globalize.translate("ButtonCancelSyncJob"),id:"cancel",ironIcon:"delete"}),require(["actionsheet"],function(e){e.show({items:s,positionTo:n,callback:function(e){switch(e){case"delete":t(a,i);break;case"cancel":t(a,i)}}})})}function c(){return Dashboard.capabilities().SupportsSync}function l(t){b=0,Dashboard.showLoadingMsg();var a={};Dashboard.getCurrentUser().then(function(){e(t).hasClass("mySyncPage")&&(a.UserId=Dashboard.getCurrentUserId(),c()&&(a.TargetId=ApiClient.deviceId())),ApiClient.getJSON(ApiClient.getUrl("Sync/Jobs",a)).then(function(e){r(t,e.Items),Dashboard.hideLoadingMsg()})})}function d(t,a){var n=e(e.mobile.activePage)[0];if("SyncJobs"==a.MessageType){var i=a.Data;if(c()){var o=ApiClient.deviceId();i=i.filter(function(e){return e.TargetId==o})}r(n,i)}}function u(t){var a="0,1500";e(t).hasClass("mySyncPage")&&(a+=","+Dashboard.getCurrentUserId()),ApiClient.isWebSocketOpen()&&ApiClient.sendWebSocketMessage("SyncJobsStart",a)}function g(){ApiClient.isWebSocketOpen()&&ApiClient.sendWebSocketMessage("SyncJobsStop","")}function v(){return[{href:"syncactivity.html",name:Globalize.translate("TabSyncJobs")},{href:"devicesupload.html",name:Globalize.translate("TabCameraUpload")},{href:"syncsettings.html",name:Globalize.translate("TabSettings")}]}var b=0;e.fn.lazyChildren=function(){for(var e=0,t=this.length;t>e;e++)ImageLoader.lazyChildren(this[e]);return this},e(document).on("pageinit",".syncActivityPage",function(){var t=this;e(".btnSyncSupporter",t).on("click",function(){requirejs(["registrationservices"],function(){RegistrationServices.validateFeature("sync")})}),e(".supporterPromotion .mainText",t).html(Globalize.translate("HeaderSyncRequiresSupporterMembership"))}).on("pageshow",".syncActivityPage",function(){"syncActivityPage"==this.id&&LibraryMenu.setTabs("syncadmin",0,v);var t=this;Dashboard.getPluginSecurityInfo().then(function(a){a.IsMBSupporter?e(".supporterPromotionContainer",t).hide():e(".supporterPromotionContainer",t).show()}),l(t),e(".btnSync",t).taskButton({mode:"on",progressElem:t.querySelector(".syncProgress"),taskKey:"SyncPrepare"}),u(t),Events.on(ApiClient,"websocketmessage",d)}).on("pagebeforehide",".syncActivityPage",function(){var t=this;e(".btnSync",t).taskButton({mode:"off"}),g(),Events.off(ApiClient,"websocketmessage",d)})});