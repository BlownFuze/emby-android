define(["appStorage"],function(e){function r(){var e=i(),r=l[e];return r||(r=l[e]={query:{Fields:"PrimaryImageAspectRatio,SyncInfo",EnableImageTypes:"Primary,Backdrop,Banner,Thumb",StartIndex:0,Limit:200},view:LibraryBrowser.getSavedView(e)||LibraryBrowser.getDefaultItemsView("List","List")},r.query.ParentId=LibraryMenu.getTopParentId(),LibraryBrowser.loadSavedQueryValues(e,r.query)),r}function t(){return r().query}function i(){return LibraryBrowser.getSavedQueryKey()}function a(e,i){Dashboard.showLoadingMsg();var s=t();s.UserId=Dashboard.getCurrentUserId(),ApiClient.getJSON(ApiClient.getUrl("Playlists/"+i.Id+"/Items",s)).then(function(t){window.scrollTo(0,0);var l="";l+=LibraryBrowser.getQueryPagingHtml({startIndex:s.StartIndex,limit:s.Limit,totalRecordCount:t.TotalRecordCount,showLimit:!1,updatePageSizeSetting:!1});var d=r().view;"List"==d&&(l=LibraryBrowser.getListViewHtml({items:t.Items,sortBy:s.SortBy,showIndex:!1,showRemoveFromPlaylist:!0,playFromHere:!0,defaultAction:"playallfromhere",smallIcon:!0}));var u=e.querySelector("#childrenContent .itemsContainer");u.innerHTML=l;for(var g=[],y=u.querySelectorAll("PAPER-ICON-ITEM"),c=0,f=y.length;f>c;c++)g.push(y[c]);var m=u.querySelector(".paperList");AppInfo.isTouchPreferred||require(["sortable"],function(r){new r(m,{draggable:".listItem",onEnd:function(r){n(r,e,i)}})}),ImageLoader.lazyChildren(u),$(u).createCardMenus(),$(u).off("needsrefresh").on("needsrefresh",function(){a(e,i)}).off("removefromplaylist").on("removefromplaylist",function(r,t){o(e,i,[t])}),$(".btnNextPage",u).on("click",function(){s.StartIndex+=s.Limit,a(e,i)}),$(".btnPreviousPage",u).on("click",function(){s.StartIndex-=s.Limit,a(e,i)}),Dashboard.hideLoadingMsg()})}function n(e,r,t){var i=e.item,n=e.newIndex,o=i.getAttribute("data-playlistitemid");Dashboard.showLoadingMsg(),ApiClient.ajax({url:ApiClient.getUrl("Playlists/"+t.Id+"/Items/"+o+"/Move/"+n),type:"POST"}).then(function(){Dashboard.hideLoadingMsg()},function(){Dashboard.hideLoadingMsg(),a(r,t)})}function o(e,r,t){ApiClient.ajax({url:ApiClient.getUrl("Playlists/"+r.Id+"/Items",{EntryIds:t.join(",")}),type:"DELETE"}).then(function(){a(e,r)})}function s(){if(!AppInfo.isTouchPreferred){var r="7";e.getItem("playlistitemdragdrophelp")!=r&&(e.setItem("playlistitemdragdrophelp",r),Dashboard.alert({message:Globalize.translate("TryDragAndDropMessage"),title:Globalize.translate("HeaderTryDragAndDrop")}))}}var l={};window.PlaylistViewer={render:function(e,r){a(e,r),s()}}});