define(["jQuery","listViewStyle"],function(t){function e(t){ApiClient.getScheduledTasks({isHidden:!1}).then(function(e){a(t,e),Dashboard.hideLoadingMsg()})}function a(t,e){e=e.sort(function(t,e){return t=t.Category+" "+t.Name,e=e.Category+" "+e.Name,t==e?0:e>t?-1:1});for(var a,s="",i=0,l=e.length;l>i;i++){var o=e[i];o.Category!=a&&(a=o.Category,a&&(s+="</div>",s+="</div>"),s+='<div style="margin-bottom:2em;">',s+="<h1>",s+=a,s+="</h1>",s+='<div class="paperList">'),s+='<div class="listItem scheduledTaskPaperIconItem" data-status="'+o.State+'">',s+="<a item-icon class='clearLink listItemIconContainer' href='scheduledtask.html?id="+o.Id+"'>",s+='<i class="md-icon listItemIcon">schedule</i>',s+="</a>",s+='<div class="listItemBody two-line">',s+="<a class='clearLink' href='scheduledtask.html?id="+o.Id+"'>",s+="<h3 class='listItemBodyText'>"+o.Name+"</h3>",s+="<div class='secondary listItemBodyText' id='taskProgress"+o.Id+"'>"+n(o)+"</div>",s+="</a>",s+="</div>",s+="Idle"==o.State?'<button type="button" is="paper-icon-button-light" id="btnTask'+o.Id+'" class="btnStartTask" data-taskid="'+o.Id+'" title="'+Globalize.translate("ButtonStart")+'"><i class="md-icon">play_arrow</i></button>':"Running"==o.State?'<button type="button" is="paper-icon-button-light" id="btnTask'+o.Id+'" class="btnStopTask" data-taskid="'+o.Id+'" title="'+Globalize.translate("ButtonStop")+'"><i class="md-icon">stop</i></button>':'<button type="button" is="paper-icon-button-light" id="btnTask'+o.Id+'" class="btnStartTask hide" data-taskid="'+o.Id+'" title="'+Globalize.translate("ButtonStart")+'"><i class="md-icon">play_arrow</i></button>',s+="</div>"}e.length&&(s+="</div>",s+="</div>");var r=t.querySelector(".divScheduledTasks");r.innerHTML=s}function s(t,e){var a=new Date(t),s=new Date(e),n=(s.getTime()-a.getTime())/1e3,i=Math.floor(n%31536e3/86400),l=Math.floor(n%31536e3%86400/3600),o=Math.floor(n%31536e3%86400%3600/60),r=Math.round(n%31536e3%86400%3600%60),d="";return d+=1==i?i+" day ":"",d+=i>1?i+" days ":"",d+=1==l?l+" hour ":"",d+=l>1?l+" hours ":"",d+=1==o?o+" minute ":"",d+=o>1?o+" minutes ":"",d+=d.length>0?"and ":"",d+=1==r?r+" second":"",d+=0==r||r>1?r+" seconds":""}function n(t){var e="";if("Idle"==t.State)t.LastExecutionResult&&(e+=Globalize.translate("LabelScheduledTaskLastRan").replace("{0}",humane_date(t.LastExecutionResult.EndTimeUtc)).replace("{1}",s(t.LastExecutionResult.StartTimeUtc,t.LastExecutionResult.EndTimeUtc)),"Failed"==t.LastExecutionResult.Status?e+=" <span style='color:#FF0000;'>("+Globalize.translate("LabelFailed")+")</span>":"Cancelled"==t.LastExecutionResult.Status?e+=" <span style='color:#0026FF;'>("+Globalize.translate("LabelCancelled")+")</span>":"Aborted"==t.LastExecutionResult.Status&&(e+=" <span style='color:#FF0000;'>"+Globalize.translate("LabelAbortedByServerShutdown")+"</span>"));else if("Running"==t.State){var a=(t.CurrentProgressPercentage||0).toFixed(1);e+='<div style="display:flex;align-items:center;">',e+='<div class="taskProgressOuter" title="'+a+'%" style="flex-grow:1;">',e+='<div class="taskProgressInner" style="width:'+a+'%;">',e+="</div>",e+="</div>",e+="<span style='color:#009F00;margin-left:5px;'>"+a+"%</span>",e+="</div>"}else e+="<span style='color:#FF0000;'>"+Globalize.translate("LabelStopping")+"</span>";return e}function i(e,a){if("ScheduledTasksInfo"==a.MessageType){var s=a.Data,n=t(t.mobile.activePage)[0];l(n,s)}}function l(t,e){for(var a=0,s=e.length;s>a;a++){var i=e[a];t.querySelector("#taskProgress"+i.Id).innerHTML=n(i);var l=t.querySelector("#btnTask"+i.Id);o(l,i.State)}}function o(e,a){"Idle"==a?(e.classList.add("btnStartTask"),e.classList.remove("btnStopTask"),e.classList.remove("hide"),e.querySelector("i").innerHTML="play_arrow",e.title=Globalize.translate("ButtonStart")):"Running"==a?(e.classList.remove("btnStartTask"),e.classList.add("btnStopTask"),e.classList.remove("hide"),e.querySelector("i").innerHTML="stop",e.title=Globalize.translate("ButtonStop")):(e.classList.add("btnStartTask"),e.classList.remove("btnStopTask"),e.classList.add("hide"),e.querySelector("i").innerHTML="play_arrow",e.title=Globalize.translate("ButtonStart"));var s=t(e).parents(".listItem")[0];s.setAttribute("data-status",a)}function r(){var a=t(t.mobile.activePage)[0];c(),e(a)}function d(){var a=t(t.mobile.activePage)[0];ApiClient.isWebSocketOpen()||e(a)}function c(){ApiClient.isWebSocketOpen()&&ApiClient.sendWebSocketMessage("ScheduledTasksInfoStart","1000,1000"),p&&clearInterval(p),p=setInterval(d,5e3)}function u(){ApiClient.isWebSocketOpen()&&ApiClient.sendWebSocketMessage("ScheduledTasksInfoStop"),p&&clearInterval(p)}var p;t(document).on("pageinit","#scheduledTasksPage",function(){var a=this;t(".divScheduledTasks",a).on("click",".btnStartTask",function(){var t=this,s=t.getAttribute("data-taskid");ApiClient.startScheduledTask(s).then(function(){o(t,"Running"),e(a)})}).on("click",".btnStopTask",function(){var t=this,s=t.getAttribute("data-taskid");ApiClient.stopScheduledTask(s).then(function(){o(t,""),e(a)})})}).on("pageshow","#scheduledTasksPage",function(){var t=this;Dashboard.showLoadingMsg(),c(),e(t),Events.on(ApiClient,"websocketmessage",i),Events.on(ApiClient,"websocketopen",r)}).on("pagebeforehide","#scheduledTasksPage",function(){Events.off(ApiClient,"websocketmessage",i),Events.off(ApiClient,"websocketopen",r),u()})});