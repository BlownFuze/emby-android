define(["dialogHelper","require","layoutManager","globalize","scrollHelper","appStorage","connectionManager","loading","focusManager","emby-select","listViewStyle","paper-icon-button-light","css!./../formdialog","material-icons","css!./subtitleeditor","emby-button"],function(e,t,n,i,a,s,r,o,l){function c(e,n){var a="Items/"+q.Id+"/RemoteSearch/Subtitles/"+n,s=r.getApiClient(q.ServerId);s.ajax({type:"POST",url:s.getUrl(a)}).then(function(){C=!0,t(["toast"],function(e){e(i.translate("sharedcomponents#MessageDownloadQueued"))}),l.autoFocus(e)})}function u(e,n){var a=i.translate("sharedcomponents#MessageAreYouSureDeleteSubtitles");t(["confirm"],function(t){t(a,i.translate("sharedcomponents#ConfirmDeletion")).then(function(){o.show();var t=q.Id,i="Videos/"+t+"/Subtitles/"+n,a=r.getApiClient(q.ServerId);a.ajax({type:"DELETE",url:a.getUrl(i)}).then(function(){C=!0,g(e,a,t)})})})}function d(e,t){var a=t.MediaStreams||[],s=a.filter(function(e){return"Subtitle"==e.Type}),r="";s.length&&(r+="<h1>"+i.translate("sharedcomponents#MySubtitles")+"</h1>",r+=n.tv?'<div class="paperList clear">':'<div class="paperList">',r+=s.map(function(e){var t="",a=n.tv?"button":"div",s=n.tv&&e.Path?"listItem btnDelete":"listItem";return t+="<"+a+' class="'+s+'" data-index="'+e.Index+'">',t+='<i class="listItemIcon md-icon">closed_caption</i>',t+='<div class="listItemBody">',t+='<h3 class="listItemBodyText">',t+=e.DisplayTitle||"",t+="</h3>",e.Path&&(t+='<div class="secondary listItemBodyText">'+e.Path+"</div>"),t+="</a>",t+="</div>",n.tv||e.Path&&(t+='<button is="paper-icon-button-light" data-index="'+e.Index+'" title="'+i.translate("sharedcomponents#Delete")+'" class="btnDelete"><i class="md-icon">delete</i></button>'),t+="</"+a+">"}).join(""),r+="</div>");var o=e.querySelector(".subtitleList");s.length?o.classList.remove("hide"):o.classList.add("hide"),o.innerHTML=r}function v(e,t,n){var i=e.querySelector("#selectLanguage");i.innerHTML=n.map(function(e){return'<option value="'+e.ThreeLetterISOLanguageName+'">'+e.DisplayName+"</option>"});var a=s.getItem("subtitleeditor-language");a?i.value=a:t.getCurrentUser().then(function(e){var t=e.Configuration.SubtitleLanguagePreference;t&&(i.value=t)})}function h(e,t){var i="",a="";if(!t.length)return e.querySelector(".noSearchResults").classList.remove("hide"),e.querySelector(".subtitleResults").innerHTML="",void o.hide();e.querySelector(".noSearchResults").classList.add("hide");for(var s=0,r=t.length;r>s;s++){var l=t[s],c=l.ProviderName;c!=i&&(s>0&&(a+="</div>"),a+="<h1>"+c+"</h1>",a+=n.tv?'<div class="paperList clear">':'<div class="paperList">',i=c);var u=n.tv?"button":"div",d=n.tv?"listItem btnOptions":"listItem";a+="<"+u+' class="'+d+'" data-subid="'+l.Id+'">',a+='<i class="listItemIcon md-icon">closed_caption</i>',a+='<div class="listItemBody">',a+='<h3 class="listItemBodyText">'+l.Name+"</h3>",a+='<div class="secondary listItemBodyText">'+l.Format+"</div>",l.Comment&&(a+='<div class="secondary listItemBodyText">'+l.Comment+"</div>"),a+="</div>",a+='<div class="secondary">'+(l.DownloadCount||0)+"</div>",n.tv||(a+='<button type="button" is="paper-icon-button-light" data-subid="'+l.Id+'" class="btnOptions"><i class="md-icon">more_vert</i></button>'),a+="</"+u+">"}t.length&&(a+="</div>");var v=e.querySelector(".subtitleResults");v.innerHTML=a,o.hide()}function m(e,t){s.setItem("subtitleeditor-language",t),o.show();var n=r.getApiClient(q.ServerId),i=n.getUrl("Items/"+q.Id+"/RemoteSearch/Subtitles/"+t);n.getJSON(i).then(function(t){h(e,t)})}function g(e,t,n){function i(t){q=t,d(e,t);var n=t.Path||"",i=Math.max(n.lastIndexOf("/"),n.lastIndexOf("\\"));i>-1&&(n=n.substring(i+1)),n?(e.querySelector(".pathValue").innerHTML=n,e.querySelector(".originalFile").classList.remove("hide")):(e.querySelector(".pathValue").innerHTML="",e.querySelector(".originalFile").classList.add("hide")),o.hide()}e.querySelector(".noSearchResults").classList.add("hide"),"string"==typeof n?t.getItem(t.getCurrentUserId(),n).then(i):i(n)}function p(e,t){for(;!e.classList||!e.classList.contains(t);)if(e=e.parentNode,!e)return null;return e}function b(e){var t=this,n=t.querySelector("#selectLanguage",t).value;return m(p(t,"dialogContent"),n),e.preventDefault(),!1}function f(e){var t=p(e.target,"btnDelete");if(t){var n=t.getAttribute("data-index"),i=p(t,"subtitleEditorDialog");u(i,n)}}function S(e){var t=p(e.target,"btnOptions");if(t){var n=t.getAttribute("data-subid"),i=p(t,"subtitleEditorDialog");y(t,i,n)}}function y(e,n,i){var a=[];a.push({name:Globalize.translate("sharedcomponents#Download"),id:"download"}),t(["actionsheet"],function(t){t.show({items:a,positionTo:e}).then(function(e){switch(e){case"download":c(n,i)}})})}function L(t,s,o){C=!1;var l=r.getApiClient(s);return l.getItem(l.getCurrentUserId(),t).then(function(t){var s={removeOnClose:!0};s.size=n.tv?"fullscreen":"small";var r=e.createDialog(s);r.classList.add("formDialog"),r.classList.add("subtitleEditorDialog"),r.innerHTML=i.translateDocument(o,"sharedcomponents"),document.body.appendChild(r),r.querySelector(".originalFileLabel").innerHTML=i.translate("sharedcomponents#File"),r.querySelector(".subtitleSearchForm").addEventListener("submit",b);var c=r.querySelector(".btnSubmit");n.tv?(a.centerFocus.on(r.querySelector(".dialogContent"),!1),r.querySelector(".btnSearchSubtitles").classList.add("hide")):c.classList.add("hide");var u=r.querySelector(".dialogContent");return r.querySelector(".subtitleList").addEventListener("click",f),r.querySelector(".subtitleResults").addEventListener("click",S),l.getCultures().then(function(e){v(u,l,e)}),r.querySelector(".btnCancel").addEventListener("click",function(){e.close(r)}),new Promise(function(n,i){r.addEventListener("close",function(){C?n():i()}),e.open(r),g(u,l,t)})})}function I(e,n){return o.show(),new Promise(function(i,a){t(["text!./subtitleeditor.template.html"],function(t){L(e,n,t).then(i,a)})})}var q,C;return{show:I}});