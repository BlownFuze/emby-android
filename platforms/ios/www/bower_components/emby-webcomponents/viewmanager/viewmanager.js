define(["viewcontainer","focusManager","queryString","layoutManager"],function(e,t,n,o){function i(e,n,i){var c=s;c&&a(c,"viewhide"),s=e;var u=r(e,n,i);i?o.mobile||(e.activeElement&&document.body.contains(e.activeElement)&&t.isCurrentlyFocusable(e.activeElement)?t.focus(e.activeElement):t.autoFocus(e)):n.autoFocus!==!1&&t.autoFocus(e),e.dispatchEvent(new CustomEvent("viewshow",u)),l&&e.dispatchEvent(new CustomEvent("pageshow",u))}function a(e,t,n,o){var i=e.dispatchEvent(new CustomEvent(t,{detail:{type:e.getAttribute("data-type"),isRestored:n},bubbles:!0,cancelable:o||!1}));return l&&e.dispatchEvent(new CustomEvent(t.replace("view","page"),{detail:{type:e.getAttribute("data-type"),isRestored:n},bubbles:!0,cancelable:!1})),i}function r(e,t,o){var i=t.url,a=(t.state,i.indexOf("?")),r=-1==a?{}:n.parse(i.substring(a+1));return{detail:{type:e.getAttribute("data-type"),params:r,isRestored:o,state:t.state,options:t.options||{}},bubbles:!0,cancelable:!1}}function c(){e.reset()}function u(){}var s,l;return e.setOnBeforeChange(function(e,t,n){var o=s;if(o){a(o,"viewbeforehide",null,!0)}if(!e.initComplete){e.initComplete=!0;var i=r(e,n,!1);if(n.controllerFactory){new n.controllerFactory(e,i.detail.params)}(!n.controllerFactory||l)&&a(e,"viewinit")}a(e,"viewbeforeshow",t)}),document.addEventListener("skinunload",c),u.prototype.loadView=function(t){var n=s;n&&(n.activeElement=document.activeElement),t.cancel||e.loadView(t).then(function(e){i(e,t)})},u.prototype.tryRestoreView=function(t,n){return t.cancel?Promise.reject({cancelled:!0}):(s&&(s.activeElement=document.activeElement),e.tryRestoreView(t).then(function(e){n(),i(e,t,!0)}))},u.prototype.currentView=function(){return s},u.prototype.dispatchPageEvents=function(e){l=e},new u});