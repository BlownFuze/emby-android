define(["dialogHelper","loading","cardBuilder","connectionManager","require","globalize","scrollHelper","layoutManager","focusManager","emby-input","emby-checkbox","paper-icon-button-light","css!./../formdialog","material-icons","cardStyle"],function(e,t,r,a,o,n,i,d,c){function l(){return a.getApiClient(b)}function s(e){var r,a,i={ProviderIds:{}},d=e.querySelectorAll(".identifyField");for(r=0,a=d.length;a>r;r++){var c=d[r].value;c&&("number"==d[r].type&&(c=parseInt(c)),i[d[r].getAttribute("data-lookup")]=c)}var s=!1,m=e.querySelectorAll(".txtLookupId");for(r=0,a=m.length;a>r;r++){var c=m[r].value;c&&(s=!0),i.ProviderIds[m[r].getAttribute("data-providerkey")]=c}if(!s&&!i.Name)return void o(["toast"],function(e){e(n.translate("sharedcomponents#PleaseEnterNameOrId"))});q&&q.GameSystem&&(i.GameSystem=q.GameSystem),i={SearchInfo:i,IncludeDisabledProviders:!0},t.show();var v=l();v.ajax({type:"POST",url:v.getUrl("Items/RemoteSearch/"+x),data:JSON.stringify(i),contentType:"application/json",dataType:"json"}).then(function(r){t.hide(),u(e,r)})}function u(e,t){function r(){var r=parseInt(this.getAttribute("data-index")),a=t[r];null!=q?v(e,a):m(e,a)}var a=e.querySelector(".identificationSearchResults");e.querySelector(".popupIdentifyForm").classList.add("hide"),a.classList.remove("hide"),e.querySelector(".identifyOptionsForm").classList.add("hide"),e.querySelector(".dialogContentInner").classList.remove("dialog-content-centered");var o,n,i="";for(o=0,n=t.length;n>o;o++){var l=t[o];i+=p(l,o)}var s=e.querySelector(".identificationSearchResultList");s.innerHTML=i;var u=s.querySelectorAll(".card");for(o=0,n=u.length;n>o;o++)u[o].addEventListener("click",r);d.tv&&c.autoFocus(a)}function m(r,a){T=a,P=!0,t.hide(),e.close(r)}function v(e,t){var r=e.querySelector(".identifyOptionsForm");e.querySelector(".popupIdentifyForm").classList.add("hide"),e.querySelector(".identificationSearchResults").classList.add("hide"),r.classList.remove("hide"),e.querySelector("#chkIdentifyReplaceImages").checked=!0,e.querySelector(".dialogContentInner").classList.add("dialog-content-centered"),T=t;var a=[];a.push(t.Name),t.ProductionYear&&a.push(t.ProductionYear),t.GameSystem&&a.push(t.GameSystem);var o=a.join("<br/>");if(t.ImageUrl){var n=f(t.ImageUrl,t.SearchProviderName);o='<div style="display:flex;align-items:center;"><img src="'+n+'" style="max-height:240px;" /><div style="margin-left:1em;">'+o+"</div>"}e.querySelector(".selectedSearchResult").innerHTML=o,c.focus(r.querySelector(".btnSubmit"))}function p(e,t){var a,o="",n="card scalableCard",i="cardBox visualCardBox";if("Episode"==x?(n+=" backdropCard backdropCard-scalable",a="cardPadder-backdrop"):"MusicAlbum"==x||"MusicArtist"==x?(n+=" squareCard squareCard-scalable",a="cardPadder-square"):(n+=" portraitCard portraitCard-scalable",a="cardPadder-portrait"),d.tv&&(n+=" card-focusscale",i+=" cardBox-focustransform cardBox-focustransform-transition"),o+='<button type="button" class="'+n+'" data-index="'+t+'">',o+='<div class="'+i+'">',o+='<div class="cardScalable visualCardBox-cardScalable">',o+='<div class="'+a+'"></div>',o+='<div class="cardContent searchImage">',e.ImageUrl){var c=f(e.ImageUrl,e.SearchProviderName);o+='<div class="cardImageContainer coveredImage" style="background-image:url(\''+c+"');\"></div>"}else o+='<div class="cardImageContainer coveredImage '+r.getDefaultColorClass(e.Name)+'"><div class="cardText cardCenteredText">'+e.Name+"</div></div>";return o+="</div>",o+="</div>",o+='<div class="cardFooter visualCardBox-cardFooter">',o+='<div class="cardText cardTextCentered">'+e.Name+"</div>",o+='<div class="cardText cardText-secondary cardTextCentered">',o+=e.ProductionYear||"&nbsp;",o+="</div>",e.GameSystem&&(o+='<div class="cardText cardText-secondary cardTextCentered">',o+=e.GameSystem,o+="</div>"),o+="</div>",o+="</div>",o+="</button>"}function f(e,t){var r=l();return r.getUrl("Items/RemoteSearch/Image",{imageUrl:e,ProviderName:t})}function y(r){t.show();var a={ReplaceAllImages:r.querySelector("#chkIdentifyReplaceImages").checked},o=l();o.ajax({type:"POST",url:o.getUrl("Items/RemoteSearch/Apply/"+q.Id,a),data:JSON.stringify(T),contentType:"application/json"}).then(function(){P=!0,t.hide(),e.close(r)},function(){t.hide(),e.close(r)})}function g(e,t){var r=l();r.getJSON(r.getUrl("Items/"+t.Id+"/ExternalIdInfos")).then(function(r){for(var a="",o=t.ProviderIds||{},i=0,d=r.length;d>i;i++){var c=r[i],l="txtLookup"+c.Key;a+='<div class="inputContainer">';{var s=n.translate("sharedcomponents#LabelDynamicExternalId").replace("{0}",c.Name);o[c.Key]||""}a+='<input is="emby-input" class="txtLookupId" data-providerkey="'+c.Key+'" id="'+l+'" label="'+s+'"/>',a+="</div>"}e.querySelector("#txtLookupName").value="","Person"==t.Type||"BoxSet"==t.Type?(e.querySelector(".fldLookupYear").classList.add("hide"),e.querySelector("#txtLookupYear").value=""):(e.querySelector(".fldLookupYear").classList.remove("hide"),e.querySelector("#txtLookupYear").value=""),e.querySelector(".identifyProviderIds").innerHTML=a,e.querySelector(".formDialogHeaderTitle").innerHTML=n.translate("sharedcomponents#Identify")})}function h(r){t.show(),o(["text!./itemidentifier.template.html"],function(a){var o=l();o.getItem(o.getCurrentUserId(),r).then(function(r){q=r,x=q.Type;var o={size:"medium",removeOnClose:!0,scrollY:!1};d.tv&&(o.size="fullscreen");var c=e.createDialog(o);c.classList.add("formDialog"),c.classList.add("recordingDialog");var l="";l+=n.translateDocument(a,"sharedcomponents"),c.innerHTML=l,document.body.appendChild(c),c.addEventListener("close",S),d.tv&&i.centerFocus.on(c.querySelector(".formDialogContent"),!1),e.open(c),c.querySelector(".popupIdentifyForm").addEventListener("submit",function(e){return e.preventDefault(),s(c),!1}),c.querySelector(".identifyOptionsForm").addEventListener("submit",function(e){return e.preventDefault(),y(c),!1}),c.querySelector(".btnCancel").addEventListener("click",function(){e.close(c)}),c.classList.add("identifyDialog"),g(c,r),t.hide()})})}function S(){t.hide(),P?C():k()}function L(r,a,c,l){q=null,x=c,o(["text!./itemidentifier.template.html"],function(o){var u={size:"medium",removeOnClose:!0,scrollY:!1};d.tv&&(u.size="fullscreen");var m=e.createDialog(u);m.classList.add("formDialog"),m.classList.add("recordingDialog");var v="";v+=n.translateDocument(o,"sharedcomponents"),m.innerHTML=v,document.body.appendChild(m),d.tv&&i.centerFocus.on(m.querySelector(".formDialogContent"),!1),e.open(m),m.querySelector(".btnCancel").addEventListener("click",function(){e.close(m)}),m.querySelector(".popupIdentifyForm").addEventListener("submit",function(e){return e.preventDefault(),s(m),!1}),m.addEventListener("close",function(){t.hide();var e=P?T:null;l(e)}),m.classList.add("identifyDialog"),I(m,r,a,c)})}function I(e,t,r,a){e.querySelector("#txtLookupName").value=t,"Person"==a||"BoxSet"==a?(e.querySelector(".fldLookupYear").classList.add("hide"),e.querySelector("#txtLookupYear").value=""):(e.querySelector(".fldLookupYear").classList.remove("hide"),e.querySelector("#txtLookupYear").value=r),e.querySelector(".formDialogHeaderTitle").innerHTML=n.translate("sharedcomponents#Search")}var q,x,b,C,k,T,P=!1;return{show:function(e,t){return new Promise(function(r,a){C=r,k=a,b=t,P=!1,h(e)})},showFindNew:function(e,t,r,a){return new Promise(function(o){b=a,P=!1,L(e,t,r,o)})}}});