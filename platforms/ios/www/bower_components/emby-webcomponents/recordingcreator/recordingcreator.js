define(["dialogHelper","globalize","layoutManager","mediaInfo","apphost","connectionManager","require","loading","scrollHelper","emby-checkbox","emby-button","emby-collapse","emby-input","paper-icon-button-light","css!./../formdialog","css!./recordingcreator","material-icons"],function(e,r,t,n,i,o,c,s,a){function d(){return["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"]}function l(e){for(var r=d(),t=[],n=0,i=r.length;i>n;n++){var o=r[n];e.querySelector("#chk"+o).checked&&t.push(o)}return t}function u(e){f(e.querySelector(".seriesFields")),f(e.querySelector(".seriesDays")),e.querySelector(".btnSubmit").classList.remove("hide"),e.querySelector(".supporterContainer").classList.add("hide")}function h(r){I=r,e.close(A)}function y(e){s.show();var r=this,t=o.getApiClient(R);return t.getNamedConfiguration("livetv").then(function(e){e.EnableRecordingEncoding=r.querySelector("#chkConvertRecordings").checked,t.updateNamedConfiguration("livetv",e)}),t.getNewLiveTvTimerDefaults({programId:P}).then(function(e){e.PrePaddingSeconds=60*r.querySelector("#txtPrePaddingMinutes").value,e.PostPaddingSeconds=60*r.querySelector("#txtPostPaddingMinutes").value,e.RecordNewOnly=r.querySelector("#chkNewOnly").checked,e.RecordAnyChannel=r.querySelector("#chkAllChannels").checked,e.RecordAnyTime=r.querySelector("#chkAnyTime").checked,e.Days=l(r),r.querySelector("#chkRecordSeries").checked?t.createLiveTvSeriesTimer(e).then(function(){s.hide(),h(!0)}):t.createLiveTvTimer(e).then(function(){s.hide(),h(!0)})}),e.preventDefault(),!1}function m(e,r){return s.show(),r.getJSON(r.getUrl("LiveTv/Registration",{ProgramId:e,Feature:"seriesrecordings"})).then(function(e){return s.hide(),e},function(){return s.hide(),{TrialVersion:!0,IsValid:!0,IsRegistered:!1}})}function S(e){e.querySelector("#chkAnyTime").checked?f(e.querySelector(".seriesDays")):v(e.querySelector(".seriesDays"))}function g(e,r){v(e.querySelector(".seriesFields")),S(e),e.querySelector(".btnSubmit").classList.remove("hide"),m(P,r).then(function(r){r.IsValid?e.querySelector(".btnSubmit").classList.remove("hide"):e.querySelector(".btnSubmit").classList.add("hide"),r.IsRegistered?e.querySelector(".supporterContainer").classList.add("hide"):(e.querySelector(".supporterContainer").classList.remove("hide"),r.TrialVersion?e.querySelector(".supporterTrial").classList.remove("hide"):e.querySelector(".supporterTrial").classList.add("hide"))})}function v(e){e.classList.contains("hide")&&(e.classList.remove("hide"),e.style.overflowY="hidden",requestAnimationFrame(function(){e.animate([{height:0},{height:e.offsetHeight+"px"}],{duration:400,easing:"ease"}).onfinish=function(){e.classList.remove("hide")}}))}function f(e){e.classList.contains("hide")||(e.style.overflowY="hidden",requestAnimationFrame(function(){e.animate([{height:e.offsetHeight+"px"},{height:0}],{duration:400,easing:"ease"}).onfinish=function(){e.classList.add("hide")}}))}function p(e){var r=o.getApiClient(R);e.querySelector("#chkRecordSeries").addEventListener("change",function(){this.checked?g(e,r):u(e)}),e.querySelector(".btnCancel").addEventListener("click",function(){h(!1)}),e.querySelector("#chkAnyTime").addEventListener("change",function(){S(e)}),e.querySelector("form",e).addEventListener("submit",y);for(var n=e.querySelectorAll(".btnSupporter"),c=0,s=n.length;s>c;c++)i.supports("externalpremium")?n[c].classList.remove("hide"):n[c].classList.add("hide");r.getNamedConfiguration("livetv").then(function(r){e.querySelector("#chkConvertRecordings").checked=r.EnableRecordingEncoding}),t.tv?e.querySelector(".advanced").classList.add("hide"):e.querySelector(".advanced").classList.remove("hide")}function q(e,r){for(var t=d(),n=0,i=t.length;i>n;n++){var o=t[n];e.querySelector("#chk"+o).checked=-1!=r.indexOf(o)}}function L(e,r,t,i){e.querySelector(".itemName").innerHTML=t.Name,e.querySelector(".itemMiscInfoPrimary").innerHTML=n.getPrimaryMediaInfoHtml(t),e.querySelector(".itemMiscInfoSecondary").innerHTML=n.getSecondaryMediaInfoHtml(t),e.querySelector("#chkNewOnly").checked=r.RecordNewOnly,e.querySelector("#chkAllChannels").checked=r.RecordAnyChannel,e.querySelector("#chkAnyTime").checked=r.RecordAnyTime,e.querySelector("#txtPrePaddingMinutes").value=r.PrePaddingSeconds/60,e.querySelector("#txtPostPaddingMinutes").value=r.PostPaddingSeconds/60,t.IsSeries?e.querySelector("#eligibleForSeriesFields").classList.remove("hide"):e.querySelector("#eligibleForSeriesFields").classList.add("hide"),q(e,r.Days),"Emby"==t.ServiceName?(e.querySelector(".convertRecordingsContainer").classList.remove("hide"),b(e,i)):e.querySelector(".convertRecordingsContainer").classList.add("hide"),s.hide()}function b(e,r){r.getPluginSecurityInfo().then(function(r){r.IsMBSupporter?e.querySelector(".btnSupporterForConverting").classList.add("hide"):e.querySelector(".btnSupporterForConverting").classList.remove("hide")},function(){e.querySelector(".btnSupporterForConverting").classList.remove("hide")})}function k(){i.supports("externalpremium")&&c(["shell"],function(e){e.openUrl("https://emby.media/premiere")})}function C(e,r){s.show();var t=o.getApiClient(R),n=t.getNewLiveTvTimerDefaults({programId:r}),i=t.getLiveTvProgram(r,t.getCurrentUserId());Promise.all([n,i]).then(function(r){var n=r[0],i=r[1];L(e,n,i,t)})}function T(n,i){return new Promise(function(o,d){I=!1,P=n,R=i,s.show(),c(["text!./recordingcreator.template.html"],function(i){var s={removeOnClose:!0,scrollY:!1};s.size=t.tv?"fullscreen":"small";var l=e.createDialog(s);l.classList.add("formDialog"),l.classList.add("recordingDialog");var h="";h+=r.translateDocument(i,"sharedcomponents"),l.innerHTML=h,document.body.appendChild(l),A=l,l.addEventListener("close",function(){I?(c(["toast"],function(e){e(r.translate("sharedcomponents#RecordingScheduled"))}),o()):d()}),t.tv&&a.centerFocus.on(l.querySelector(".formDialogContent"),!1),l.querySelector(".btnSupporterForConverting").addEventListener("click",k),u(l),p(l),C(l,n),e.open(l)})})}var P,R,A,I=!1;return{show:T}});