define(["browser","appStorage","apphost","loading","connectionManager","globalize","embyRouter","dom","css!./multiselect"],function(e,t,n,r,a,o,i,s){function l(){var e=S;if(e){e.parentNode.removeChild(e),S=null,C=[],x=[];for(var t=document.querySelectorAll(".itemSelectionPanel"),n=0,r=t.length;r>n;n++)t[n].parentNode.removeChild(t[n])}}function c(){if(!(P>=15||(P++,15>P))){var e="8";t.getItem("tapholdhelp")!=e&&(t.setItem("tapholdhelp",e),require(["alert"],function(e){e({text:o.translate("sharedcomponents#TryMultiSelectMessage"),title:o.translate("sharedcomponents#TryMultiSelect")})}))}}function d(e,t){if(!s.parentWithClass(e.target,"chkItemSelect")){var n=t.querySelector(".chkItemSelect");if(n)if(n.classList.contains("checkedInitial"))n.classList.remove("checkedInitial");else{var r=!n.checked;n.checked=r,u(n,r)}}return e.preventDefault(),e.stopPropagation(),!1}function u(e,t){var n=s.parentWithClass(e,"card").getAttribute("data-id");if(t){var r=C.filter(function(e){return e==n});r.length||(C.push(n),x.push(e))}else C=C.filter(function(e){return e!=n}),x=x.filter(function(t){return t!=e});if(C.length){var a=document.querySelector(".itemSelectionCount");a&&(a.innerHTML=C.length)}else l()}function f(){u(this,this.checked)}function m(t,n){var r=t.querySelector(".itemSelectionPanel");if(!r){r=document.createElement("div"),r.classList.add("itemSelectionPanel"),t.querySelector(".cardContent,.cardBox").appendChild(r);var a="chkItemSelect";n&&!e.firefox&&(a+=" checkedInitial");var o=n?" checked":"";r.innerHTML='<label class="checkboxContainer"><input type="checkbox" is="emby-checkbox" class="'+a+'"'+o+"/><span></span></label>";var i=r.querySelector(".chkItemSelect");i.addEventListener("change",f)}}function p(e,t){var n=[{transform:"translate3d(0, 0, 0)",offset:0},{transform:"translate3d(-10px, 0, 0)",offset:.1},{transform:"translate3d(10px, 0, 0)",offset:.2},{transform:"translate3d(-10px, 0, 0)",offset:.3},{transform:"translate3d(10px, 0, 0)",offset:.4},{transform:"translate3d(-10px, 0, 0)",offset:.5},{transform:"translate3d(10px, 0, 0)",offset:.6},{transform:"translate3d(-10px, 0, 0)",offset:.7},{transform:"translate3d(10px, 0, 0)",offset:.8},{transform:"translate3d(-10px, 0, 0)",offset:.9},{transform:"translate3d(0, 0, 0)",offset:1}],r={duration:900,iterations:t};e.animate&&e.animate(n,r)}function h(){var t=S;if(!t){t=document.createElement("div"),t.classList.add("selectionCommandsPanel"),document.body.appendChild(t),S=t;var r="";r+='<div style="float:left;">',r+='<button is="paper-icon-button-light" class="btnCloseSelectionPanel autoSize"><i class="md-icon">close</i></button>',r+='<span class="itemSelectionCount"></span>',r+="</div>";var a="dots-horiz"==n.moreIcon?"&#xE5D3;":"&#xE5D4;";r+='<button is="paper-icon-button-light" class="btnSelectionPanelOptions autoSize" style="margin-left:auto;"><i class="md-icon">'+a+"</i></button>",t.innerHTML=r,t.querySelector(".btnCloseSelectionPanel").addEventListener("click",l);var o=t.querySelector(".btnSelectionPanelOptions");o.addEventListener("click",g),e.mobile||p(o,1)}}function v(e,t){return new Promise(function(n,r){var a=o.translate("ConfirmDeleteItem"),i=o.translate("HeaderDeleteItem");t.length>1&&(a=o.translate("ConfirmDeleteItems"),i=o.translate("HeaderDeleteItems")),require(["confirm"],function(o){o(a,i).then(function(){t.map(function(t){e.deleteItem(t)});n()},r)})})}function g(e){var t=a.currentApiClient();t.getCurrentUser().then(function(r){var a=[];a.push({name:o.translate("sharedcomponents#AddToCollection"),id:"addtocollection",ironIcon:"add"}),a.push({name:o.translate("sharedcomponents#AddToPlaylist"),id:"playlist",ironIcon:"playlist-add"}),r.Policy.EnableContentDeletion&&a.push({name:o.translate("sharedcomponents#Delete"),id:"delete",ironIcon:"delete"}),r.Policy.EnableContentDownloading&&n.supports("filedownload"),a.push({name:o.translate("sharedcomponents#GroupVersions"),id:"groupvideos",ironIcon:"call-merge"}),a.push({name:o.translate("sharedcomponents#MarkPlayed"),id:"markplayed"}),a.push({name:o.translate("sharedcomponents#MarkUnplayed"),id:"markunplayed"}),a.push({name:o.translate("sharedcomponents#Refresh"),id:"refresh",ironIcon:"refresh"}),a.push({name:o.translate("sharedcomponents#Sync"),id:"sync",ironIcon:"sync"}),b(),require(["actionsheet"],function(n){n.show({items:a,positionTo:e.target,callback:function(e){var n=C.slice(0),r=t.serverInfo().Id;switch(e){case"addtocollection":require(["collectionEditor"],function(e){(new e).show({items:n,serverId:r})}),l();break;case"playlist":require(["playlistEditor"],function(e){(new e).show({items:n,serverId:r})}),l();break;case"delete":v(n).then(function(){i.goHome()}),l();break;case"groupvideos":y(t,n);break;case"markplayed":n.forEach(function(e){t.markPlayed(t.getCurrentUserId(),e)}),l();break;case"markunplayed":n.forEach(function(e){t.markUnplayed(t.getCurrentUserId(),e)}),l();break;case"refresh":require(["refreshDialog"],function(e){new e({itemIds:n,serverId:r}).show()}),l();break;case"sync":require(["syncDialog"],function(e){e.showMenu({items:n.map(function(e){return{Id:e}})})}),l()}}})})})}function b(){var e=[];[].forEach.call(x,function(t){var n=s.parentWithAttribute(t,"is","emby-itemscontainer");n&&-1==e.indexOf(n)&&e.push(n)});for(var t=0,n=e.length;n>t;t++)e[t].dispatchEvent(new CustomEvent("needsrefresh",{detail:{},cancelable:!1,bubbles:!0}))}function y(e,t){if(t.length<2)return void require(["alert"],function(e){e({text:o.translate("sharedcomponents#PleaseSelectTwoItems")})});var n=o.translate("sharedcomponents#TheSelectedItemsWillBeGrouped");require(["confirm"],function(a){a(n,o.translate("sharedcomponents#GroupVersions")).then(function(){r.show(),e.ajax({type:"POST",url:e.getUrl("Videos/MergeVersions",{Ids:t.join(",")})}).then(function(){r.hide(),l(),b()})})})}function k(e){require(["emby-checkbox"],function(){for(var t=document.querySelectorAll(".card"),n=0,r=t.length;r>n;n++)m(t[n],e==t[n]);h(),u(e,!0)})}function I(e){var t=e.target;if(C.length){var n=s.parentWithClass(t,"card");if(n){var r=n.querySelector(".itemSelectionPanel");if(r)return d(e,r)}return e.preventDefault(),e.stopPropagation(),!1}}var S,C=[],x=[],P=0;return document.addEventListener("viewbeforehide",l),function(t){function n(e){var t=s.parentWithClass(e.target,"card");return t&&k(t),e.preventDefault(),e.stopPropagation&&e.stopPropagation(),!1}function r(t){e.mobile&&!e.safari?o.addEventListener("contextmenu",n):require(["hammer"],function(e){var r=new e.Manager(t),o=new e.Press({time:500});r.add(o),r.on("press",n),a.manager=r}),c(t)}var a=this,o=t.container;r(o),t.bindOnClick!==!1&&o.addEventListener("click",I),a.onContainerClick=I,a.destroy=function(){o.removeEventListener("click",I),o.removeEventListener("contextmenu",n);var e=a.manager;e&&(e.destroy(),a.manager=null)}}});