define(["require","browser","globalize","connectionManager","serverNotifications","loading","scrollHelper","datetime","focusManager","imageLoader","events","layoutManager","itemShortcuts","registrationservices","clearButtonStyle","css!./guide.css","material-icons","scrollStyles","emby-button"],function(e,t,r,a,n,i,o,s,c,l,d,u,m,v){function f(f){function g(e){var t=e.getMinutes()-V;return t>=0?e.setHours(e.getHours(),V,0,0):e.setHours(e.getHours(),0,0,0),e}function h(){i.show()}function I(){i.hide()}function p(){T(),rt=setInterval(S,6e4),S()}function T(){var e=rt;e&&clearInterval(e),rt=null,at=null,nt=null}function S(){at||(at=f.element.querySelector(".currentTimeIndicatorBar")),nt||(nt=f.element.querySelector(".currentTimeIndicatorArrowContainer"));var e=(new Date).getTime()-J.getTime(),t=e>0?e/et:0;t=Math.min(t,1),0>=t||t>=1?(at.classList.add("hide"),nt.classList.add("hide")):(at.classList.remove("hide"),nt.classList.remove("hide"),at.style.transform="scaleX("+t+")",nt.style.transform="translateX("+100*t+"%)")}function y(e){return v.validateFeature("livetv").then(function(){var r=t.mobile?100:400;return e.querySelector(".guideRequiresUnlock").classList.add("hide"),r},function(){var t=5;return e.querySelector(".guideRequiresUnlock").classList.remove("hide"),e.querySelector(".unlockText").innerHTML=r.translate("sharedcomponents#LiveTvGuideRequiresUnlock",t),t})}function L(e,t){var r=a.currentApiClient();tt.UserId=r.getCurrentUserId(),y(e).then(function(a){h(),tt.Limit=a,tt.AddCurrentProgram=!1,Q=Q||r.getLiveTvChannels(tt);var n=t;n=new Date(n.getTime()+1e3);var i=new Date(n.getTime()+$-2e3);Q.then(function(t){r.getLiveTvPrograms({UserId:r.getCurrentUserId(),MaxStartDate:i.toISOString(),MinEndDate:n.toISOString(),channelIds:t.Items.map(function(e){return e.Id}).join(","),ImageTypeLimit:1,EnableImageTypes:"Primary,Backdrop",SortBy:"StartDate",EnableTotalRecordCount:!1}).then(function(a){P(e,n,t.Items,a.Items,r),I()})})})}function D(e){if("string"===(typeof e).toString().toLowerCase())try{e=s.parseISO8601Date(e,{toLocal:!0})}catch(t){return e}return s.getDisplayTime(e).toLowerCase()}function w(e,t){var r="";for(e=new Date(e.getTime()),r+='<div class="timeslotHeadersInner">';e.getTime()<t;)r+='<div class="timeslotHeader">',r+=D(e),r+="</div>",e.setTime(e.getTime()+Z);return r+='<div class="currentTimeIndicatorBar hide">',r+="</div>",r+='<div class="currentTimeIndicatorArrowContainer hide">',r+='<i class="currentTimeIndicatorArrow md-icon">arrow_drop_down</i>',r+="</div>"}function b(e){if(!e.StartDateLocal)try{e.StartDateLocal=s.parseISO8601Date(e.StartDate,{toLocal:!0})}catch(t){}if(!e.EndDateLocal)try{e.EndDateLocal=s.parseISO8601Date(e.EndDate,{toLocal:!0})}catch(t){}return null}function C(e,t,a,n,i){var o="",s=t.getTime(),c=s+$-1;n=n.filter(function(e){return e.ChannelId==a.Id}),o+='<div class="channelPrograms" data-channelid="'+a.Id+'">';for(var l=0,d=n.length;d>l;l++){var u=n[l];if(u.ChannelId==a.Id&&(b(u),!(u.EndDateLocal.getTime()<s))){if(u.StartDateLocal.getTime()>c)break;Y[u.Id]=u;var m=Math.max(u.StartDateLocal.getTime(),s),v=(u.StartDateLocal.getTime()-s)/$;v*=100,v=Math.max(v,0);var f=Math.min(u.EndDateLocal.getTime(),c),g=(f-m)/$;g*=100;var h="programCell clearButton itemAction",I=!0;u.IsKids?h+=" childProgramInfo":u.IsSports?h+=" sportsProgramInfo":u.IsNews?h+=" newsProgramInfo":u.IsMovie?h+=" movieProgramInfo":(h+=" plainProgramInfo",I=!1);var p="";u.TimerId&&(p+=' data-timerid="'+u.TimerId+'"'),u.SeriesTimerId&&(p+=' data-seriestimerid="'+u.SeriesTimerId+'"'),o+='<button data-action="link"'+p+' data-isfolder="'+u.IsFolder+'" data-id="'+u.Id+'" data-serverid="'+u.ServerId+'" data-type="'+u.Type+'" class="'+h+'" style="left:'+v+"%;width:"+g+'%;">';var T="guideProgramName";o+='<div class="'+T+'">',u.IsLive&&i.showLiveIndicator?o+='<span class="liveTvProgram">'+r.translate("sharedcomponents#AttributeLive")+"&nbsp;</span>":u.IsPremiere&&i.showPremiereIndicator?o+='<span class="premiereTvProgram">'+r.translate("sharedcomponents#AttributePremiere")+"&nbsp;</span>":u.IsSeries&&!u.IsRepeat&&i.showNewIndicator&&(o+='<span class="newTvProgram">'+r.translate("sharedcomponents#AttributeNew")+"&nbsp;</span>"),o+=u.Name,o+="</div>",u.IsHD&&i.showHdIcon&&(o+='<i class="guideHdIcon md-icon">hd</i>'),u.SeriesTimerId?o+='<i class="seriesTimerIcon md-icon">fiber_smart_record</i>':u.TimerId&&(o+='<i class="timerIcon md-icon">fiber_manual_record</i>'),I&&(o+='<div class="programAccent"></div>'),o+="</button>"}}return o+="</div>"}function q(e,t,r,a){var n=[],i=window.innerWidth>=800;i=!1;for(var o={showHdIcon:i,showLiveIndicator:i,showPremiereIndicator:i,showNewIndicator:i},s=0,c=r.length;c>s;s++)n.push(C(e,t,r[s],a,o));var l=e.querySelector(".programGrid");l.innerHTML=n.join(""),l.scrollTop=0,l.scrollLeft=0}function H(e,t,r){for(var a="",n=0,i=t.length;i>n;n++){var o=t[n],s=o.ImageTags.Primary,c="";if(s){var d=r.getScaledImageUrl(o.Id,{maxHeight:200,tag:o.ImageTags.Primary,type:"Primary"});c=' data-src="'+d+'"'}var u="channelHeaderCell clearButton itemAction lazy";s&&(u+=" withImage"),a+='<button type="button" class="'+u+'"'+c+' data-action="link" data-isfolder="'+o.IsFolder+'" data-id="'+o.Id+'" data-serverid="'+o.ServerId+'" data-type="'+o.Type+'">',a+='<div class="guideChannelNumber">'+o.Number+"</div>",s||(a+='<div class="guideChannelName">'+o.Name+"</div>"),a+="</button>"}var m=e.querySelector(".channelList");m.innerHTML=a,l.lazyChildren(m)}function A(e,t){for(;!e.classList||!e.classList.contains(t);)if(e=e.parentNode,!e)return null;return e}function P(e,t,r,a,n){var i=document.activeElement,o=i&&i.getAttribute?i.getAttribute("data-id"):null,s=null;i&&(s=A(i,"channelPrograms"),s=s&&s.getAttribute?s.getAttribute("data-channelid"):null),H(e,r,n);var l=t,d=new Date(l.getTime()+$);if(e.querySelector(".timeslotHeaders").innerHTML=w(l,d),p(),Y={},q(e,t,r,a),u.tv){var m;if(o&&(m=e.querySelector('[data-id="'+o+'"]')),m)c.focus(m);else{var v;s&&(v=e.querySelector('[data-channelid="'+s+'"]')),v||(v=e.querySelector(".programGrid")),c.autoFocus(v,!0)}}}function M(e,t,r){e.scrollTo?r?e.scrollTo(t,0):e.scrollTo(0,t):r?e.scrollLeft=Math.round(t):e.scrollTop=Math.round(t)}function E(e,t,r){(new Date).getTime()-ct>=1e3&&(st=(new Date).getTime(),M(r,t.scrollLeft,!0))}function O(e,t,r){(new Date).getTime()-st>=1e3&&(ct=(new Date).getTime(),M(r,t.scrollLeft,!0))}function N(e){var t=[];t[0]=r.translate("sharedcomponents#OptionSundayShort"),t[1]=r.translate("sharedcomponents#OptionMondayShort"),t[2]=r.translate("sharedcomponents#OptionTuesdayShort"),t[3]=r.translate("sharedcomponents#OptionWednesdayShort"),t[4]=r.translate("sharedcomponents#OptionThursdayShort"),t[5]=r.translate("sharedcomponents#OptionFridayShort"),t[6]=r.translate("sharedcomponents#OptionSaturdayShort");var a=t[e.getDay()];return e=s.toLocaleDateString(e),-1==e.toLowerCase().indexOf(a.toLowerCase())?a+" "+e:e}function k(e,t){T();var r=g(t);J=r,L(e,r);var a=N(t);a='<span class="guideCurrentDay">'+a.replace(" "," </span>"),e.querySelector(".btnSelectDate").innerHTML=a}function x(e,t){var r=new Date;r.setHours(r.getHours(),0,0,0);var a=s.parseISO8601Date(t.StartDate,{toLocal:!0}),n=s.parseISO8601Date(t.EndDate,{toLocal:!0});for(a.setHours(0,0,0,0),n.setHours(0,0,0,0),a.getTime()>=n.getTime()&&n.setDate(a.getDate()+1),a=new Date(Math.max(r,a)),lt=[];n>=a;)lt.push({name:N(a),id:a.getTime()}),a.setDate(a.getDate()+1),a.setHours(0,0,0,0);var i=new Date;J&&i.setTime(J.getTime()),k(e,i)}function U(e){h();var t=a.currentApiClient();t.getLiveTvGuideInfo().then(function(t){x(e,t)})}function F(t){e(["actionsheet"],function(e){e.show({items:lt,title:r.translate("sharedcomponents#HeaderSelectDate"),callback:function(e){var r=new Date;r.setTime(parseInt(e)),k(t,r)}})})}function _(e){if(u.tv){o.centerFocus.on(e.querySelector(".smoothScrollY"),!1);var t=e.querySelector(".programGrid");o.centerFocus.on(t,!0)}}function A(e,t){for(;!e.classList||!e.classList.contains(t);)if(e=e.parentNode,!e)return null;return e}function B(e){var t=A(e.target,"programCell");t&&(ot=e.target,it&&clearTimeout(it),it=setTimeout(G,700))}function G(){var e=ot;if(e&&document.activeElement==e){var t=e.getAttribute("data-id"),r=Y[t];r&&d.trigger(K,"focus",[{item:r}])}}function R(e,t,r,a){var n=a;dt||(n=a.capture),e.addEventListener(t,r,n)}function j(e,t,r){for(var a=r.ProgramId,n=r.Id,i=f.element.querySelectorAll('.programCell[data-id="'+a+'"]'),o=0,s=i.length;s>o;o++){var c=i[o],l=c.querySelector(".timerIcon");l||c.insertAdjacentHTML("beforeend",'<i class="timerIcon md-icon">fiber_manual_record</i>'),n&&c.setAttribute("data-timerid",n)}}function z(){}function W(e,t,r){for(var a=r.Id,n=f.element.querySelectorAll('.programCell[data-timerid="'+a+'"]'),i=0,o=n.length;o>i;i++){var n=n[i],s=cell.querySelector(".timerIcon");s&&s.parentNode.removeChild(s),cell.removeAttribute("data-timerid")}}function X(e,t,r){for(var a=r.Id,n=f.element.querySelectorAll('.programCell[data-seriestimerid="'+a+'"]'),i=0,o=n.length;o>i;i++){var n=n[i],s=cell.querySelector(".seriesTimerIcon");s&&s.parentNode.removeChild(s),cell.removeAttribute("data-seriestimerid")}}var K=this,Y={};K.options=f;var J,Q,V=30,Z=60*V*1e3,$=864e5,et=$,tt={StartIndex:0,EnableFavoriteSorting:!0};K.refresh=function(){J=null,U(f.element)},K.destroy=function(){d.off(n,"TimerCreated",j),d.off(n,"SeriesTimerCreated",z),d.off(n,"TimerCancelled",W),d.off(n,"SeriesTimerCancelled",X),T(),m.off(f.element),Y={}};var rt,at,nt,it,ot,st=0,ct=0,lt=[],dt=!1;try{var ut=Object.defineProperty({},"capture",{get:function(){dt=!0}});window.addEventListener("test",null,ut)}catch(mt){}e(["text!./tvguide.template.html"],function(e){var t=f.element;t.innerHTML=r.translateDocument(e,"sharedcomponents");var a=t.querySelector(".programGrid"),i=t.querySelector(".timeslotHeaders");a.addEventListener("focus",B,!0),R(a,"scroll",function(){E(t,this,i)},{passive:!0}),R(i,"scroll",function(){O(t,this,a)},{passive:!0}),t.querySelector(".btnSelectDate").addEventListener("click",function(){F(t)}),t.querySelector(".btnUnlockGuide").addEventListener("click",function(){U(t)}),t.classList.add("tvguide"),_(t,K),m.on(t),d.trigger(K,"load"),d.on(n,"TimerCreated",j),d.on(n,"SeriesTimerCreated",z),d.on(n,"TimerCancelled",W),d.on(n,"SeriesTimerCancelled",X),K.refresh()})}return f});