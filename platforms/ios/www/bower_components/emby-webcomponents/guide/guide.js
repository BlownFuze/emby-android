define(["require","browser","globalize","connectionManager","serverNotifications","loading","datetime","focusManager","imageLoader","events","layoutManager","itemShortcuts","registrationservices","dom","clearButtonStyle","css!./guide.css","material-icons","scrollStyles","emby-button","paper-icon-button-light"],function(e,t,r,a,n,i,o,s,c,l,d,u,m,v){function g(g){function f(e){var t=e.getMinutes()-J;return t>=0?e.setHours(e.getHours(),J,0,0):e.setHours(e.getHours(),0,0,0),e}function h(){i.show()}function I(){i.hide()}function p(){S(),rt=setInterval(T,6e4),T()}function S(){var e=rt;e&&clearInterval(e),rt=null,at=null,nt=null}function T(){at||(at=g.element.querySelector(".currentTimeIndicatorBar")),nt||(nt=g.element.querySelector(".currentTimeIndicatorArrowContainer"));var e=(new Date).getTime()-X.getTime(),t=e>0?e/Z:0;t=Math.min(t,1),0>=t||t>=1?(at.classList.add("hide"),nt.classList.add("hide")):(at.classList.remove("hide"),nt.classList.remove("hide"),at.style.transform="scaleX("+t+")",nt.style.transform="translateX("+100*t+"%)")}function y(e){return m.validateFeature("livetv").then(function(){var r=t.slow?100:500;return e.querySelector(".guideRequiresUnlock").classList.add("hide"),r},function(){var t=5;return e.querySelector(".guideRequiresUnlock").classList.remove("hide"),e.querySelector(".unlockText").innerHTML=r.translate("sharedcomponents#LiveTvGuideRequiresUnlock",t),t})}function L(e,t){var r=a.currentApiClient();tt.UserId=r.getCurrentUserId(),y(e).then(function(a){et=a,h(),tt.StartIndex=$,tt.Limit=a,tt.AddCurrentProgram=!1,tt.EnableUserData=!1,tt.EnableImageTypes="Primary",Y=Y||r.getLiveTvChannels(tt);var n=t;n=new Date(n.getTime()+1e3);var i=new Date(n.getTime()+V-2e3);Y.then(function(t){t.TotalRecordCount>a?(e.querySelector(".guidePaging").classList.remove("hide"),e.querySelector(".btnPreviousPage").disabled=tt.StartIndex?!1:!0,e.querySelector(".btnNextPage").disabled=tt.StartIndex+a<t.TotalRecordCount?!1:!0):e.querySelector(".guidePaging").classList.add("hide"),r.getLiveTvPrograms({UserId:r.getCurrentUserId(),MaxStartDate:i.toISOString(),MinEndDate:n.toISOString(),channelIds:t.Items.map(function(e){return e.Id}).join(","),ImageTypeLimit:1,EnableImages:!1,SortBy:"StartDate",EnableTotalRecordCount:!1,EnableUserData:!1}).then(function(a){H(e,n,t.Items,a.Items,r),I()})})})}function D(e){if("string"===(typeof e).toString().toLowerCase())try{e=o.parseISO8601Date(e,{toLocal:!0})}catch(t){return e}return o.getDisplayTime(e).toLowerCase()}function b(e,t){var r="";for(e=new Date(e.getTime()),r+='<div class="timeslotHeadersInner">';e.getTime()<t;)r+='<div class="timeslotHeader">',r+=D(e),r+="</div>",e.setTime(e.getTime()+Q);return r+='<div class="currentTimeIndicatorBar hide">',r+="</div>",r+='<div class="currentTimeIndicatorArrowContainer hide">',r+='<i class="currentTimeIndicatorArrow md-icon">arrow_drop_down</i>',r+="</div>"}function w(e){if(!e.StartDateLocal)try{e.StartDateLocal=o.parseISO8601Date(e.StartDate,{toLocal:!0})}catch(t){}if(!e.EndDateLocal)try{e.EndDateLocal=o.parseISO8601Date(e.EndDate,{toLocal:!0})}catch(t){}return null}function C(e,t,a,n,i){var o="",s=t.getTime(),c=s+V-1;n=n.filter(function(e){return e.ChannelId==a.Id});var l=d.tv?"channelPrograms channelPrograms-tv":"channelPrograms";o+='<div class="'+l+'" data-channelid="'+a.Id+'">';for(var u=0,m=n.length;m>u;u++){var v=n[u];if(v.ChannelId==a.Id&&(w(v),!(v.EndDateLocal.getTime()<s))){if(v.StartDateLocal.getTime()>c)break;W[v.Id]=v;var g=Math.max(v.StartDateLocal.getTime(),s),f=(v.StartDateLocal.getTime()-s)/V;f*=100,f=Math.max(f,0);var h=Math.min(v.EndDateLocal.getTime(),c),I=(h-g)/V;I*=100;var l="programCell clearButton itemAction",p=!0;v.IsKids?l+=" childProgramInfo":v.IsSports?l+=" sportsProgramInfo":v.IsNews?l+=" newsProgramInfo":v.IsMovie?l+=" movieProgramInfo":(l+=" plainProgramInfo",p=!1);var S="";v.TimerId&&(S+=' data-timerid="'+v.TimerId+'"'),v.SeriesTimerId&&(S+=' data-seriestimerid="'+v.SeriesTimerId+'"'),o+='<button data-action="link"'+S+' data-isfolder="'+v.IsFolder+'" data-id="'+v.Id+'" data-serverid="'+v.ServerId+'" data-type="'+v.Type+'" class="'+l+'" style="left:'+f+"%;width:"+I+'%;">';var T="guideProgramName";o+='<div class="'+T+'">',v.IsLive&&i.showLiveIndicator?o+='<span class="liveTvProgram">'+r.translate("sharedcomponents#AttributeLive")+"&nbsp;</span>":v.IsPremiere&&i.showPremiereIndicator?o+='<span class="premiereTvProgram">'+r.translate("sharedcomponents#AttributePremiere")+"&nbsp;</span>":v.IsSeries&&!v.IsRepeat&&i.showNewIndicator&&(o+='<span class="newTvProgram">'+r.translate("sharedcomponents#AttributeNew")+"&nbsp;</span>"),o+=v.Name,o+="</div>",v.IsHD&&i.showHdIcon&&(o+='<i class="guideHdIcon md-icon programIcon">hd</i>'),v.SeriesTimerId?o+='<i class="seriesTimerIcon md-icon programIcon">fiber_smart_record</i>':v.TimerId&&(o+='<i class="timerIcon md-icon programIcon">fiber_manual_record</i>'),p&&(v.IsKids?o+='<div class="programAccent childAccent"></div>':v.IsSports?o+='<div class="programAccent sportsAccent"></div>':v.IsNews?o+='<div class="programAccent newsAccent"></div>':v.IsMovie&&(o+='<div class="programAccent movieAccent"></div>')),o+="</button>"}}return o+="</div>"}function q(e,t,r,a){for(var n=[],i=!1,o={showHdIcon:i,showLiveIndicator:i,showPremiereIndicator:i,showNewIndicator:i},s=0,c=r.length;c>s;s++)n.push(C(e,t,r[s],a,o));var l=e.querySelector(".programGrid");l.innerHTML=n.join(""),l.scrollTop=0,l.scrollLeft=0}function P(e,t,r){for(var a="",n=0,i=t.length;i>n;n++){var o=t[n],s=o.ImageTags.Primary,l="";if(s){var u=r.getScaledImageUrl(o.Id,{maxHeight:200,tag:o.ImageTags.Primary,type:"Primary"});l=' data-src="'+u+'"'}var m="channelHeaderCell clearButton itemAction lazy";d.tv&&(m+=" channelHeaderCell-tv"),a+='<button type="button" class="'+m+'"'+l+' data-action="link" data-isfolder="'+o.IsFolder+'" data-id="'+o.Id+'" data-serverid="'+o.ServerId+'" data-type="'+o.Type+'">',m="guideChannelNumber",s&&(m+=" guideChannelNumberWithImage"),a+='<div class="'+m+'">'+o.Number+"</div>",s||(a+='<div class="guideChannelName">'+o.Name+"</div>"),a+="</button>"}var v=e.querySelector(".channelList");v.innerHTML=a,c.lazyChildren(v)}function A(e,t){for(;!e.classList||!e.classList.contains(t);)if(e=e.parentNode,!e)return null;return e}function H(e,t,r,a,n){var i=document.activeElement,o=i&&i.getAttribute?i.getAttribute("data-id"):null,c=null;i&&(c=A(i,"channelPrograms"),c=c&&c.getAttribute?c.getAttribute("data-channelid"):null),P(e,r,n);var l=t,u=new Date(l.getTime()+V);if(e.querySelector(".timeslotHeaders").innerHTML=b(l,u),p(),W={},q(e,t,r,a),d.tv){var m;if(o&&(m=e.querySelector('[data-id="'+o+'"]')),m)s.focus(m);else{var v;c&&(v=e.querySelector('[data-channelid="'+c+'"]')),v||(v=e.querySelector(".programGrid")),s.autoFocus(v,!0)}}}function M(e,t,r){e.scrollTo?r?e.scrollTo(t,0):e.scrollTo(0,t):r?e.scrollLeft=Math.round(t):e.scrollTop=Math.round(t)}function E(e,t,r){(new Date).getTime()-ot>=1e3&&(it=(new Date).getTime(),M(r,t.scrollLeft,!0))}function N(e,t,r){(new Date).getTime()-it>=1e3&&(ot=(new Date).getTime(),M(r,t.scrollLeft,!0))}function x(e){var t=[];t[0]=r.translate("sharedcomponents#OptionSundayShort"),t[1]=r.translate("sharedcomponents#OptionMondayShort"),t[2]=r.translate("sharedcomponents#OptionTuesdayShort"),t[3]=r.translate("sharedcomponents#OptionWednesdayShort"),t[4]=r.translate("sharedcomponents#OptionThursdayShort"),t[5]=r.translate("sharedcomponents#OptionFridayShort"),t[6]=r.translate("sharedcomponents#OptionSaturdayShort");var a=t[e.getDay()];return e=o.toLocaleDateString(e),-1==e.toLowerCase().indexOf(a.toLowerCase())?a+" "+e:e}function O(e,t){S();var r=f(t);X=r,L(e,r);var a=x(t);a='<span class="guideCurrentDay">'+a.replace(" "," </span>"),e.querySelector(".btnSelectDate").innerHTML=a}function k(e,t){var r=new Date;r.setHours(r.getHours(),0,0,0);var a=o.parseISO8601Date(t.StartDate,{toLocal:!0}),n=o.parseISO8601Date(t.EndDate,{toLocal:!0});for(a.setHours(0,0,0,0),n.setHours(0,0,0,0),a.getTime()>=n.getTime()&&n.setDate(a.getDate()+1),a=new Date(Math.max(r,a)),st=[];n>=a;)st.push({name:x(a),id:a.getTime()}),a.setDate(a.getDate()+1),a.setHours(0,0,0,0);var i=new Date;X&&i.setTime(X.getTime()),O(e,i)}function U(e){h();var t=a.currentApiClient();t.getLiveTvGuideInfo().then(function(t){k(e,t)})}function F(t){e(["actionsheet"],function(e){e.show({items:st,title:r.translate("sharedcomponents#HeaderSelectDate"),callback:function(e){var r=new Date;r.setTime(parseInt(e)),O(t,r)}})})}function _(t,r){d.tv&&e(["scrollHelper"],function(e){var a=r?"on":"off";e.centerFocus[a](t.querySelector(".smoothScrollY"),!1),e.centerFocus[a](t.querySelector(".programGrid"),!0)})}function A(e,t){for(;!e.classList||!e.classList.contains(t);)if(e=e.parentNode,!e)return null;return e}function G(e){var t=A(e.target,"programCell");if(t){var r=e.target,a=r.getAttribute("data-id"),n=W[a];n&&l.trigger(K,"focus",[{item:n}])}}function R(e,t,r){for(var a=r.ProgramId,n=r.Id,i=g.element.querySelectorAll('.programCell[data-id="'+a+'"]'),o=0,s=i.length;s>o;o++){var c=i[o],l=c.querySelector(".timerIcon");l||c.insertAdjacentHTML("beforeend",'<i class="timerIcon md-icon">fiber_manual_record</i>'),n&&c.setAttribute("data-timerid",n)}}function B(){}function j(e,t,r){for(var a=r.Id,n=g.element.querySelectorAll('.programCell[data-timerid="'+a+'"]'),i=0,o=n.length;o>i;i++){var n=n[i],s=cell.querySelector(".timerIcon");s&&s.parentNode.removeChild(s),cell.removeAttribute("data-timerid")}}function z(e,t,r){for(var a=r.Id,n=g.element.querySelectorAll('.programCell[data-seriestimerid="'+a+'"]'),i=0,o=n.length;o>i;i++){var n=n[i],s=cell.querySelector(".seriesTimerIcon");s&&s.parentNode.removeChild(s),cell.removeAttribute("data-seriestimerid")}}var K=this,W={};K.options=g;var X,Y,J=30,Q=60*J*1e3,V=864e5,Z=V,$=0,et=0,tt={StartIndex:0,EnableFavoriteSorting:!0};K.refresh=function(){X=null,U(g.element)},K.destroy=function(){l.off(n,"TimerCreated",R),l.off(n,"SeriesTimerCreated",B),l.off(n,"TimerCancelled",j),l.off(n,"SeriesTimerCancelled",z),S(),_(g.element,!1),u.off(g.element),W={}};var rt,at,nt,it=0,ot=0,st=[];e(["text!./tvguide.template.html"],function(e){var t=g.element;t.innerHTML=r.translateDocument(e,"sharedcomponents");var a=t.querySelector(".programGrid"),i=t.querySelector(".timeslotHeaders");a.addEventListener("focus",G,!0),v.addEventListener(a,"scroll",function(){E(t,this,i)},{passive:!0}),v.addEventListener(i,"scroll",function(){N(t,this,a)},{passive:!0}),t.querySelector(".btnSelectDate").addEventListener("click",function(){F(t)}),t.querySelector(".btnSelectDateIcon").addEventListener("click",function(){F(t)}),t.querySelector(".btnUnlockGuide").addEventListener("click",function(){$=0,Y=null,U(t)}),t.querySelector(".btnNextPage").addEventListener("click",function(){$+=et,Y=null,U(t)}),t.querySelector(".btnPreviousPage").addEventListener("click",function(){$=Math.max($-et,0),Y=null,U(t)}),t.classList.add("tvguide"),_(t,!0),u.on(t),l.trigger(K,"load"),l.on(n,"TimerCreated",R),l.on(n,"SeriesTimerCreated",B),l.on(n,"TimerCancelled",j),l.on(n,"SeriesTimerCancelled",z),K.refresh()})}return g});