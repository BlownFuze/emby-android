define(["dialogHelper","connectionManager","loading","dom","layoutManager","focusManager","globalize","scrollHelper","imageLoader","require","cardStyle","formDialogStyle","emby-button","paper-icon-button-light"],function(e,t,a,n,i,r,o,s,d,c){function l(){var e={};return e.itemId=A.Id,e}function u(e,n,i){a.show();var r;n?(r=t.getApiClient(n.ServerId),m(e,n,r,i)):(r=t.getApiClient(A.ServerId),r.getItem(r.getCurrentUserId(),A.Id).then(function(t){m(e,t,r,i)}))}function g(e,t,a,i){e.addEventListener(a,function(e){var a=n.parentWithClass(e.target,t);a&&i.call(a,e)})}function m(e,t,n,o){A=t,n.getRemoteImageProviders(l()).then(function(s){for(var d=e.querySelectorAll(".btnBrowseAllImages"),c=0,l=d.length;l>c;c++)s.length?d[c].classList.remove("hide"):d[c].classList.add("hide");n.getItemImageInfos(A.Id).then(function(d){b(e,n,t,d,s),y(e,n,t,d,s),x(e,n,t,d,s),a.hide(),i.tv&&r.autoFocus(o||e)})})}function h(e,t,a,n,i){return i=i||{},i.type=a,i.index=n,i.tag="Backdrop"==a?e.BackdropImageTags[n]:"Screenshot"==a?e.ScreenshotImageTags[n]:"Primary"==a?e.PrimaryImageTag||e.ImageTags[a]:e.ImageTags[a],t.getScaledImageUrl(e.Id||e.ItemId,i)}function p(e,t,a,n,i,r,s,d){var c="",l="card scalableCard imageEditorCard",u="cardBox visualCardBox";l+=" backdropCard backdropCard-scalable","button"==s?(l+=" card-focusscale btnImageCard",u+=" cardBox-focustransform cardBox-focustransform-transition",c+='<button type="button" class="'+l+'"'):c+='<div class="'+l+'"',c+=' data-id="'+A.Id+'" data-serverid="'+n.serverId()+'" data-index="'+t+'" data-numimages="'+a+'" data-imagetype="'+e.ImageType+'" data-providers="'+i.length+'"',c+=">",c+='<div class="'+u+'">',c+='<div class="cardScalable visualCardBox-cardScalable" style="background-color:transparent;">',c+='<div class="cardPadder-backdrop"></div>',c+='<div class="cardContent">';var g=h(A,n,e.ImageType,e.ImageIndex,{maxWidth:r});return c+='<div class="cardImageContainer" style="background-image:url(\''+g+"');background-position:center bottom;\"></div>",c+="</div>",c+="</div>",c+='<div class="cardFooter visualCardBox-cardFooter">',c+='<h3 class="cardText cardTextCentered" style="margin:0;">'+e.ImageType+"</h3>",c+='<div class="cardText cardText-secondary cardTextCentered">',c+=e.Width&&e.Height?e.Width+" X "+e.Height:"&nbsp;",c+="</div>",d&&(c+='<div class="cardText cardTextCentered">',"Backdrop"==e.ImageType||"Screenshot"==e.ImageType?(c+=t>0?'<button is="paper-icon-button-light" class="btnMoveImage autoSize" data-imagetype="'+e.ImageType+'" data-index="'+e.ImageIndex+'" data-newindex="'+(e.ImageIndex-1)+'" title="'+o.translate("sharedcomponents#MoveLeft")+'"><i class="md-icon">chevron_left</i></button>':'<button is="paper-icon-button-light" class="autoSize" disabled title="'+o.translate("sharedcomponents#MoveLeft")+'"><i class="md-icon">chevron_left</i></button>',c+=a-1>t?'<button is="paper-icon-button-light" class="btnMoveImage autoSize" data-imagetype="'+e.ImageType+'" data-index="'+e.ImageIndex+'" data-newindex="'+(e.ImageIndex+1)+'" title="'+o.translate("sharedcomponents#MoveRight")+'"><i class="md-icon">chevron_right</i></button>':'<button is="paper-icon-button-light" class="autoSize" disabled title="'+o.translate("sharedcomponents#MoveRight")+'"><i class="md-icon">chevron_right</i></button>'):i.length&&(c+='<button is="paper-icon-button-light" data-imagetype="'+e.ImageType+'" class="btnSearchImages autoSize" title="'+o.translate("sharedcomponents#Search")+'"><i class="md-icon">search</i></button>'),c+='<button is="paper-icon-button-light" data-imagetype="'+e.ImageType+'" data-index="'+(null!=e.ImageIndex?e.ImageIndex:"null")+'" class="btnDeleteImage autoSize" title="'+o.translate("sharedcomponents#Delete")+'"><i class="md-icon">delete</i></button>',c+="</div>"),c+="</div>",c+="</div>",c+="</div>",c+="</"+s+">"}function I(e,t,a,n,i,r){var s=function(){i.deleteItemImage(t,a,n).then(function(){w=!0,u(e)})};return r?void c(["confirm"],function(e){e(o.translate("sharedcomponents#ConfirmDeleteImage")).then(s)}):void s()}function v(e,t,a,n,i,r,o){t.updateItemImageIndex(a,n,i,r).then(function(){w=!0,u(e,null,o)})}function f(e,t,a,r,o,s){var c="",l=300,u=n.getWindowSize();u.innerWidth>=1280&&(l=Math.round(u.innerWidth/4));for(var m=i.tv?"button":"div",h=!i.tv,f=0,b=r.length;b>f;f++){var y=r[f];c+=p(y,f,b,a,o,l,m,h)}s.innerHTML=c,d.lazyChildren(s),g(s,"btnSearchImages","click",function(){C(e,this.getAttribute("data-imagetype"))}),g(s,"btnDeleteImage","click",function(){var t=this.getAttribute("data-imagetype"),n=this.getAttribute("data-index");n="null"==n?null:parseInt(n),I(e,A.Id,t,n,a,!0)}),g(s,"btnMoveImage","click",function(){var t=this.getAttribute("data-imagetype"),i=this.getAttribute("data-index"),r=this.getAttribute("data-newindex");v(e,a,A.Id,t,i,r,n.parentWithClass(this,"itemsContainer"))})}function b(e,t,a,n,i){var r=n.filter(function(e){return"Screenshot"!=e.ImageType&&"Backdrop"!=e.ImageType&&"Chapter"!=e.ImageType});f(e,a,t,r,i,e.querySelector("#images"))}function y(e,t,a,n,i){var r=n.filter(function(e){return"Backdrop"==e.ImageType}).sort(function(e,t){return e.ImageIndex-t.ImageIndex});r.length?(e.querySelector("#backdropsContainer",e).classList.remove("hide"),f(e,a,t,r,i,e.querySelector("#backdrops"))):e.querySelector("#backdropsContainer",e).classList.add("hide")}function x(e,t,a,n,i){var r=n.filter(function(e){return"Screenshot"==e.ImageType}).sort(function(e,t){return e.ImageIndex-t.ImageIndex});r.length?(e.querySelector("#screenshotsContainer",e).classList.remove("hide"),f(e,a,t,r,i,e.querySelector("#screenshots"))):e.querySelector("#screenshotsContainer",e).classList.add("hide")}function C(e,t){c(["components/imagedownloader/imagedownloader"],function(a){a.show(A.Id,A.Type,t).then(function(){w=!0,u(e)})})}function S(e,a){var i=a.getAttribute("data-id"),r=a.getAttribute("data-serverid"),s=t.getApiClient(r),d=a.getAttribute("data-imagetype"),l=parseInt(a.getAttribute("data-index")),u=parseInt(a.getAttribute("data-providers")),g=parseInt(a.getAttribute("data-numimages"));c(["actionsheet"],function(t){var r=[];r.push({name:o.translate("sharedcomponents#Delete"),id:"delete"}),("Backdrop"==d||"Screenshot"==d)&&(l>0&&r.push({name:o.translate("sharedcomponents#MoveLeft"),id:"moveleft"}),g-1>l&&r.push({name:o.translate("sharedcomponents#MoveRight"),id:"moveright"})),u&&r.push({name:o.translate("sharedcomponents#Search"),id:"search"}),t.show({items:r,positionTo:a}).then(function(t){switch(t){case"delete":I(e,i,d,l,s,!1);break;case"search":C(e,d);break;case"moveleft":v(e,s,i,d,l,l-1,n.parentWithClass(a,"itemsContainer"));break;case"moveright":v(e,s,i,d,l,l+1,n.parentWithClass(a,"itemsContainer"))}})})}function T(e,t){g(e,"btnOpenUploadMenu","click",function(){var a=this.getAttribute("data-imagetype");c(["components/imageuploader/imageuploader"],function(n){n.show(A.Id,{theme:t.theme,imageType:a}).then(function(t){t&&(w=!0,u(e))})})}),g(e,"btnBrowseAllImages","click",function(){C(e,this.getAttribute("data-imagetype")||"Primary")}),g(e,"btnImageCard","click",function(){S(e,this)})}function k(n,r,d){var l=n.itemId,g=n.serverId;a.show(),c(["text!./imageeditor.template.html"],function(c){var m=t.getApiClient(g);m.getItem(m.getCurrentUserId(),l).then(function(t){var l={removeOnClose:!0};l.size=i.tv?"fullscreen":"fullscreen-border";var g=e.createDialog(l);g.classList.add("formDialog"),g.innerHTML=o.translateDocument(c,"sharedcomponents"),document.body.appendChild(g),i.tv&&s.centerFocus.on(g,!1),T(g,n),g.addEventListener("close",function(){i.tv&&s.centerFocus.off(g,!1),a.hide(),w?r():d()}),e.open(g),u(g,t),g.querySelector(".btnCancel").addEventListener("click",function(){e.close(g)})})})}var A,w=!1;return{show:function(e){return new Promise(function(t,a){w=!1,k(e,t,a)})}}});