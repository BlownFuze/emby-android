define(["loading","viewManager","skinManager","pluginManager","backdrop","browser","pageJs","appSettings"],function(e,n,t,r,o,i,a,u){function s(){o.clear(),e.show(),H.connect({enableAutoLogin:u.enableAutoLogin()}).then(function(n){c(n,e)})}function c(e,n){switch(e.State){case MediaBrowser.ConnectionState.SignedIn:n.hide(),t.loadUserSkin();break;case MediaBrowser.ConnectionState.ServerSignIn:e.ApiClient.getPublicUsers().then(function(n){n.length?J.showLocalLogin(e.ApiClient,e.Servers[0].Id):J.showLocalLogin(e.ApiClient,e.Servers[0].Id,!0)});break;case MediaBrowser.ConnectionState.ServerSelection:J.showSelectServer();break;case MediaBrowser.ConnectionState.ConnectSignIn:J.showWelcome();break;case MediaBrowser.ConnectionState.ServerUpdateNeeded:require(["alert"],function(e){e({text:Globalize.translate("sharedcomponents#ServerUpdateNeeded","https://emby.media"),html:Globalize.translate("sharedcomponents#ServerUpdateNeeded",'<a href="https://emby.media">https://emby.media</a>')}).then(function(){J.showSelectServer()})})}}function l(e,n,t,r){var o=t.contentPath||t.path;if(0!=o.toLowerCase().indexOf("http")&&0!=o.indexOf("file:")&&(0!=o.indexOf("/")&&(o="/"+o),o=L()+o),e.querystring&&t.enableContentQueryString&&(o+="?"+e.querystring),t.enableCache!==!1){var i=Q[o];if(i)return void y(e,t,i,r)}o+=-1==o.indexOf("?")?"?":"&",o+="v="+X;var a=new XMLHttpRequest;a.onload=a.onerror=function(){if(this.status<400){var i=this.response;t.enableCache!==!1&&(Q[o.split("?")[0]]=i),y(e,t,i,r)}else n()},a.onerror=n,a.open("GET",o,!0),a.send()}function d(e,n,t){w(e,t,function(){f(e,n,t)})}function f(e,n,t){var r=function(r){p(e,n,t,r)};require(t.dependencies||[],function(){t.controller?require([t.controller],r):r()})}function h(){var e=V;e&&(e.cancel=!0)}function p(e,t,r,o){if(j&&"home"==r.type)return void(j=!1);h();var i=e.isBack,a={url:L()+e.path,transition:r.transition,isBack:i,state:e.state,type:r.type,controllerFactory:o,options:{supportsThemeMedia:r.supportsThemeMedia||!1},autoFocus:r.autoFocus};V=a;var u=function(){"string"==typeof r.path?l(e,t,r,a):t()};return i?void n.tryRestoreView(a).then(function(){Y={route:r,path:e.path}},u):void u()}function g(n){e.show(),require(["connectionManager"],function(t){H=t,H.connect({enableAutoLogin:u.enableAutoLogin()}).then(function(t){z=t,e.hide(),n=n||{},a({click:n.click!==!1,hashbang:n.hashbang!==!1,enableHistory:m()})})})}function m(){return i.xboxOne?!1:!0}function v(){return a.enableNativeHistory()}function w(n,r,o){var i=z;if(i&&(z=null,i.State!=MediaBrowser.ConnectionState.SignedIn&&!r.anonymous))return void c(i,e);{var a=H.currentApiClient();n.pathname.toLowerCase()}if(!(a&&a.isLoggedIn()||r.anonymous))return void s();if(a&&a.isLoggedIn()){var u=Y?Y.route.startup:!0;if(n.isBack&&(r.isDefaultRoute||r.startup)&&!u)return void k();if(r.isDefaultRoute)return void t.loadUserSkin();if(r.roles)return void S(a,r.roles).then(function(){a.ensureWebSocket(),o()},s)}o()}function S(e,n){return Promise.all(n.split(",").map(function(n){return b(e,n)}))}function b(e,n){return"admin"==n?e.getCurrentUser().then(function(e){return e.Policy.IsAdministrator?Promise.resolve():Promise.reject()}):Promise.resolve()}function k(){j=!0,t.loadUserSkin(),W||t.getCurrentSkin().showBackMenu().then(function(){W=!1})}function y(e,t,r,o){r=Globalize.translateDocument(r,t.dictionary),o.view=r,n.loadView(o),Y={route:t,path:e.path},e.handled=!0}function C(){var e=window.location.pathname||"",n=e.lastIndexOf("/");return e=-1!=n?e.substring(n):"/"+e,e&&"/"!=e||(e="/index.html"),e}function L(){return K}function I(e){return function(n,t){d(n,t,e)}}function x(){var e=Y?Y.path||"":"",n=e.indexOf("?"),t="";return-1!=n&&(t=e.substring(n)),t||""}function B(e,n){e=e.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var t="[\\?&]"+e+"=([^&#]*)",r=new RegExp(t,"i"),o=r.exec(n||x());return null==o?"":decodeURIComponent(o[1].replace(/\+/g," "))}function M(){a.back()}function T(){var e=A();return e?"home"==e.type?!1:a.canGoBack():!1}function R(e,n){return new Promise(function(t){var r=L();return e=e.replace(r,""),Y&&Y.path==e&&"home"!=Y.route.type?void t():(a.show(e,n),void setTimeout(t,500))})}function A(){return Y?Y.route:null}function U(){var e=t.getCurrentSkin(),n=e.getRoutes().filter(function(e){return"home"==e.type})[0];return R(r.mapRoute(e,n))}function O(e,n){"string"==typeof e?require(["connectionManager"],function(t){var r=n?t.getApiClient(n):t.currentApiClient();r.getItem(r.getCurrentUserId(),e).then(function(e){J.showItem(e)})}):t.getCurrentSkin().showItem(e)}function q(e){t.getCurrentSkin().setTitle(e)}function G(){var e=t.getCurrentSkin(),n=e.getRoutes().filter(function(e){return"video-osd"==e.type})[0];return R(r.mapRoute(e,n))}function P(e,n){a(e,I(n)),Z.push(n)}function D(){return Z}function E(e){"full"==e||e==Emby.TransparencyLevel.Full?(o.clear(!0),document.documentElement.classList.add("transparentDocument")):"backdrop"==e||e==Emby.TransparencyLevel.Backdrop?(o.externalBackdrop(!0),document.documentElement.classList.add("transparentDocument")):(o.externalBackdrop(!1),document.documentElement.classList.remove("transparentDocument"))}function N(e,n,t){e.navigate=!1,a.pushState(e,n,t)}function F(){var e=window.location.pathname.replace(C(),"");e.lastIndexOf("/")==e.length-1&&(e=e.substring(0,e.length-1)),a.base(e)}var H,V,z,W,j,J={showLocalLogin:function(e,n,t){var r=t?"manuallogin":"login";R("/startup/"+r+".html?serverid="+n)},showSelectServer:function(){R("/startup/selectserver.html")},showWelcome:function(){R("/startup/welcome.html")},showSettings:function(){R("/settings/settings.html")},showSearch:function(){t.getCurrentSkin().search()},showGuide:function(){t.getCurrentSkin().showGuide()},showLiveTV:function(){t.getCurrentSkin().showLiveTV()}},Q={},X=(new Date).getTime(),K=window.location.href.split("?")[0].replace(C(),"");K=K.split("#")[0],K.lastIndexOf("/")==K.length-1&&(K=K.substring(0,K.length-1));var Y,Z=[];return F(),J.addRoute=P,J.param=B,J.back=M,J.show=R,J.start=g,J.baseUrl=L,J.canGoBack=T,J.current=A,J.beginConnectionWizard=s,J.goHome=U,J.showItem=O,J.setTitle=q,J.setTransparency=E,J.getRoutes=D,J.pushState=N,J.enableNativeHistory=v,J.showVideoOsd=G,J.TransparencyLevel={None:0,Backdrop:1,Full:2},J});