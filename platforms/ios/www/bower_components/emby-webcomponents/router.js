define(["loading","viewManager","skinManager","pluginManager","backdrop","browser","pageJs","appSettings","apphost"],function(e,n,t,r,o,i,a,s,u){function c(){o.clear(),e.show(),H.connect({enableAutoLogin:s.enableAutoLogin()}).then(function(n){l(n,e)})}function l(e,n){switch(e.State){case MediaBrowser.ConnectionState.SignedIn:n.hide(),t.loadUserSkin();break;case MediaBrowser.ConnectionState.ServerSignIn:e.ApiClient.getPublicUsers().then(function(n){n.length?Q.showLocalLogin(e.ApiClient,e.Servers[0].Id):Q.showLocalLogin(e.ApiClient,e.Servers[0].Id,!0)});break;case MediaBrowser.ConnectionState.ServerSelection:Q.showSelectServer();break;case MediaBrowser.ConnectionState.ConnectSignIn:Q.showWelcome();break;case MediaBrowser.ConnectionState.ServerUpdateNeeded:require(["alert"],function(e){e({text:Globalize.translate("sharedcomponents#ServerUpdateNeeded","https://emby.media"),html:Globalize.translate("sharedcomponents#ServerUpdateNeeded",'<a href="https://emby.media">https://emby.media</a>')}).then(function(){Q.showSelectServer()})})}}function d(e,n,t,r){var o=t.contentPath||t.path;if(0!=o.toLowerCase().indexOf("http")&&0!=o.indexOf("file:")&&(0!=o.indexOf("/")&&(o="/"+o),o=x()+o),e.querystring&&t.enableContentQueryString&&(o+="?"+e.querystring),t.enableCache!==!1){var i=X[o];if(i)return void y(e,t,i,r)}o+=-1==o.indexOf("?")?"?":"&",o+="v="+K;var a=new XMLHttpRequest;a.onload=a.onerror=function(){if(this.status<400){var i=this.response;t.enableCache!==!1&&(X[o.split("?")[0]]=i),y(e,t,i,r)}else n()},a.onerror=n,a.open("GET",o,!0),a.send()}function h(e,n,t){S(e,t,function(){f(e,n,t)})}function f(e,n,t){var r=function(r){g(e,n,t,r)};require(t.dependencies||[],function(){t.controller?require([t.controller],r):r()})}function p(){var e=z;e&&(e.cancel=!0)}function g(e,t,r,o){if(J&&"home"==r.type)return void(J=!1);p();var i=e.isBack,a={url:x()+e.path,transition:r.transition,isBack:i,state:e.state,type:r.type,controllerFactory:o,options:{supportsThemeMedia:r.supportsThemeMedia||!1},autoFocus:r.autoFocus};z=a;var s=function(){"string"==typeof r.path?d(e,t,r,a):t()};return i?void n.tryRestoreView(a).then(function(){Z={route:r,path:e.path}},s):void s()}function m(n){e.show(),require(["connectionManager"],function(t){H=t,H.connect({enableAutoLogin:s.enableAutoLogin()}).then(function(t){W=t,e.hide(),n=n||{},a({click:n.click!==!1,hashbang:n.hashbang!==!1,enableHistory:v()})})})}function v(){return i.xboxOne?!1:!0}function w(){return a.enableNativeHistory()}function S(n,r,o){var i=W;if(i&&(W=null,i.State!=MediaBrowser.ConnectionState.SignedIn&&!r.anonymous))return void l(i,e);var a=H.currentApiClient(),s=(n.pathname.toLowerCase(),Z?Z.route.startup:!0),d=n.isBack&&r.isDefaultRoute&&s;if(!(d||a&&a.isLoggedIn()||r.anonymous))return void c();if(d){if(u.supports("exit"))return void u.exit()}else{if(a&&a.isLoggedIn()){if(n.isBack&&(r.isDefaultRoute||r.startup)&&!s)return void C();if(r.isDefaultRoute)return void t.loadUserSkin();if(r.roles)return void b(a,r.roles).then(function(){a.ensureWebSocket(),o()},c)}o()}}function b(e,n){return Promise.all(n.split(",").map(function(n){return k(e,n)}))}function k(e,n){return"admin"==n?e.getCurrentUser().then(function(e){return e.Policy.IsAdministrator?Promise.resolve():Promise.reject()}):Promise.resolve()}function C(){return!u.supports("exitmenu")&&u.supports("exit")?void u.exit():(J=!0,t.loadUserSkin(),void(j||t.getCurrentSkin().showBackMenu().then(function(){j=!1})))}function y(e,t,r,o){r=Globalize.translateDocument(r,t.dictionary),o.view=r,n.loadView(o),Z={route:t,path:e.path},e.handled=!0}function L(){var e=window.location.pathname||"",n=e.lastIndexOf("/");return e=-1!=n?e.substring(n):"/"+e,e&&"/"!=e||(e="/index.html"),e}function x(){return Y}function I(e){return function(n,t){h(n,t,e)}}function B(){var e=Z?Z.path||"":"",n=e.indexOf("?"),t="";return-1!=n&&(t=e.substring(n)),t||""}function M(e,n){e=e.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var t="[\\?&]"+e+"=([^&#]*)",r=new RegExp(t,"i"),o=r.exec(n||B());return null==o?"":decodeURIComponent(o[1].replace(/\+/g," "))}function R(){a.back()}function T(){var e=U();return e?"home"==e.type?!1:a.canGoBack():!1}function A(n,t){var r=x();return n=n.replace(r,""),Z&&Z.path==n&&"home"!=Z.route.type?(e.hide(),Promise.resolve()):(a.show(n,t),new Promise(function(e){setTimeout(e,500)}))}function U(){return Z?Z.route:null}function q(){var e=t.getCurrentSkin(),n=e.getRoutes().filter(function(e){return"home"==e.type})[0];return A(r.mapRoute(e,n))}function G(e,n,r){"string"==typeof e?require(["connectionManager"],function(t){var o=n?t.getApiClient(n):t.currentApiClient();o.getItem(o.getCurrentUserId(),e).then(function(e){Q.showItem(e,r)})}):(2==arguments.length&&(r=arguments[1]),t.getCurrentSkin().showItem(e,r))}function O(e){t.getCurrentSkin().setTitle(e)}function P(){var e=t.getCurrentSkin(),n=e.getRoutes().filter(function(e){return"video-osd"==e.type})[0];return A(r.mapRoute(e,n))}function D(e,n){a(e,I(n)),en.push(n)}function E(){return en}function F(e){$||($=document.querySelector(".backdropContainer")),_||(_=document.querySelector(".backgroundContainer")),"full"==e||e==Emby.TransparencyLevel.Full?(o.clear(!0),document.documentElement.classList.add("transparentDocument"),_.classList.add("backgroundContainer-transparent"),$.classList.add("hide")):"backdrop"==e||e==Emby.TransparencyLevel.Backdrop?(o.externalBackdrop(!0),document.documentElement.classList.add("transparentDocument"),_.classList.add("backgroundContainer-transparent"),$.classList.add("hide")):(o.externalBackdrop(!1),document.documentElement.classList.remove("transparentDocument"),_.classList.remove("backgroundContainer-transparent"),$.classList.remove("hide"))}function V(e,n,t){e.navigate=!1,a.pushState(e,n,t)}function N(){var e=window.location.pathname.replace(L(),"");e.lastIndexOf("/")==e.length-1&&(e=e.substring(0,e.length-1)),a.base(e)}var H,z,W,j,J,Q={showLocalLogin:function(e,n,t){var r=t?"manuallogin":"login";A("/startup/"+r+".html?serverid="+n)},showSelectServer:function(){A("/startup/selectserver.html")},showWelcome:function(){A("/startup/welcome.html")},showSettings:function(){A("/settings/settings.html")},showSearch:function(){t.getCurrentSkin().search()},showGenre:function(e){t.getCurrentSkin().showGenre(e)},showGuide:function(){t.getCurrentSkin().showGuide()},showLiveTV:function(){t.getCurrentSkin().showLiveTV()},showRecordedTV:function(){t.getCurrentSkin().showRecordedTV()},showFavorites:function(){t.getCurrentSkin().showFavorites()}},X={},K=(new Date).getTime(),Y=window.location.href.split("?")[0].replace(L(),"");Y=Y.split("#")[0],Y.lastIndexOf("/")==Y.length-1&&(Y=Y.substring(0,Y.length-1));var Z,$,_,en=[];return N(),Q.addRoute=D,Q.param=M,Q.back=R,Q.show=A,Q.start=m,Q.baseUrl=x,Q.canGoBack=T,Q.current=U,Q.beginConnectionWizard=c,Q.goHome=q,Q.showItem=G,Q.setTitle=O,Q.setTransparency=F,Q.getRoutes=E,Q.pushState=V,Q.enableNativeHistory=w,Q.showVideoOsd=P,Q.TransparencyLevel={None:0,Backdrop:1,Full:2},Q});