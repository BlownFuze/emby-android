define(["playbackManager","inputManager","connectionManager","embyRouter","globalize","loading","dom"],function(e,t,i,n,r,a,o){function d(t,i,n){for(var r=t.parentNode,a=t.classList.length?"."+t.classList[0]:"",o=r.querySelectorAll(a+"[data-id]"),d=[],l=!1,s=0,u=o.length;u>s;s++)o[s]==t&&(l=!0),l&&d.push(o[s].getAttribute("data-id"));d.length&&(n?e.queue({ids:d,serverId:i}):e.play({ids:d,serverId:i}))}function l(e,t){var n=i.getApiClient(t),r=n.getCurrentUserId();return n.getItem(r,e).then(function(t){return n.getItems(r,{MediaTypes:"Photo",Filters:"IsNotFolder",ParentId:t.ParentId}).then(function(t){var i=t.Items,n=i.map(function(e){return e.Id}).indexOf(e);-1==n&&(n=0),require(["slideshow"],function(e){var t=new e({showTitle:!1,cover:!1,items:i,startIndex:n,interval:8e3,interactive:!0});t.show()})})})}function s(e,t){return"Photo"==e.Type?void l(e.Id,e.ServerId):void n.showItem(e,t)}function u(e){e=o.parentWithAttribute(e,"data-id");var t=e.getAttribute("data-serverid"),n=e.getAttribute("data-id"),r=e.getAttribute("data-type"),a=i.getApiClient(t);return"Timer"==r?a.getLiveTvTimer(n):a.getItem(a.getCurrentUserId(),n)}function c(e,t){u(e).then(function(i){var n=e.getAttribute("data-playlistid"),r=e.getAttribute("data-collectionid");if(n){var a=o.parentWithAttribute(e,"data-playlistitemid");i.PlaylistItemId=a?a.getAttribute("data-playlistitemid"):null}require(["itemContextMenu"],function(a){a.show(Object.assign({item:i,play:!0,queue:!0,playAllFromHere:!i.IsFolder,queueAllFromHere:!i.IsFolder,playlistId:n,collectionId:r},t||{})).then(function(i){if("playallfromhere"==i.command||"queueallfromhere"==i.command)p(e,t.positionTo,i.command);else if("removefromplaylist"==i.command||"removefromcollection"==i.command){var n=t.itemsContainer||o.parentWithAttribute(e,"is","emby-itemscontainer");n&&n.dispatchEvent(new CustomEvent("needsrefresh",{detail:{},cancelable:!1,bubbles:!0}))}else if("canceltimer"==i.command){var n=t.itemsContainer||o.parentWithAttribute(e,"is","emby-itemscontainer");n&&n.dispatchEvent(new CustomEvent("timercancelled",{detail:{},cancelable:!1,bubbles:!0}))}})})})}function m(e){return{Type:e.getAttribute("data-type"),Id:e.getAttribute("data-id"),CollectionType:e.getAttribute("data-collectiontype"),ChannelId:e.getAttribute("data-channelid"),SeriesId:e.getAttribute("data-seriesid"),ServerId:e.getAttribute("data-serverid"),MediaType:e.getAttribute("data-mediatype"),IsFolder:"true"==e.getAttribute("data-isfolder"),UserData:{PlaybackPositionTicks:parseInt(e.getAttribute("data-positionticks")||"0")}}}function f(e,t){var i=m(e);require(["playMenu"],function(e){e.show({item:i,positionTo:t})})}function p(t,i,n){i=i||t;var r=t.getAttribute("data-id");r||(t=o.parentWithAttribute(t,"data-id"),r=t.getAttribute("data-id"));var a=m(t),l=a.ServerId,p=a.Type;if("link"==n)s(a,{context:t.getAttribute("data-context")});else if("instantmix"==n)e.instantMix(r,l);else if("play"==n){var b=parseInt(t.getAttribute("data-positionticks")||"0");e.play({ids:[r],startPositionTicks:b,serverId:l})}else if("playallfromhere"==n)d(t,l);else if("queueallfromhere"==n)d(t,l,!0);else if("setplaylistindex"==n)e.currentPlaylistIndex(parseInt(t.getAttribute("data-index")));else if("record"==n)v(l,r,p,t.getAttribute("data-timerid"),t.getAttribute("data-seriestimerid"));else if("menu"==n){var I="false"==i.getAttribute("data-playoptions")?{shuffle:!1,instantMix:!1,play:!1,playAllFromHere:!1,queue:!1,queueAllFromHere:!1}:{};I.positionTo=i,c(t,I)}else"playmenu"==n?f(t,i):"edit"==n?u(i).then(function(e){h(e,l)}):"playtrailer"==n&&u(i).then(g)}function g(t){var n=i.getApiClient(t.ServerId);n.getLocalTrailers(n.getCurrentUserId(),t.Id).then(function(t){e.play({items:t})})}function h(e,t){var n=i.getApiClient(t);return new Promise(function(t,i){var r=n.serverInfo().Id;"Timer"==e.Type?require(["recordingEditor"],function(n){n.show(e.Id,r).then(t,i)}):require(["metadataEditor"],function(n){n.show(e.Id,r).then(t,i)})})}function v(e,t,n,r,a){var o=i.getApiClient(e);a&&r?I(o,r,!0):r?b(o,r,t):"Program"==n&&A(o,t)}function b(e,t,i){a.show(),e.getItem(e.getCurrentUserId(),i).then(function(n){n.IsSeries?I(e,t,!1).then(function(){e.getNewLiveTvTimerDefaults({programId:i}).then(function(t){e.createLiveTvSeriesTimer(t).then(function(){a.hide(),y(r.translate("sharedcomponents#SeriesRecordingScheduled"))})})}):I(e,t,!0)})}function I(e,t,i){return a.show(),e.cancelLiveTvTimer(t).then(function(){i&&(a.hide(),y(r.translate("sharedcomponents#RecordingCancelled")))})}function A(e,t){a.show(),e.getNewLiveTvTimerDefaults({programId:t}).then(function(t){e.createLiveTvTimer(t).then(function(){a.hide(),y(r.translate("sharedcomponents#RecordingScheduled"))})})}function y(e){require(["toast"],function(t){t(e)})}function T(e){var t=o.parentWithClass(e.target,"itemAction");if(t){var i=t,n=i.getAttribute("data-action");if(n||(i=o.parentWithAttribute(i,"data-action"),n=i.getAttribute("data-action")),n)return p(t,i,n),e.preventDefault(),e.stopPropagation(),!1}}function C(e){var t=e.detail.command;if("play"==t||"record"==t||"menu"==t||"info"==t){var i=o.parentWithClass(e.target,"itemAction");i&&p(i,i,t)}}function w(e,i){i=i||{},i.click!==!1&&e.addEventListener("click",T),i.command!==!1&&t.on(e,C)}function q(e,i){i=i||{},e.removeEventListener("click",T),i.command!==!1&&t.off(e,C)}return{on:w,off:q,onClick:T,showContextMenu:c}});