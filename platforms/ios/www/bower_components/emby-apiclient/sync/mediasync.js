!function(e){function n(){function e(e,n){var r=jQuery.Deferred();return require(["localassetmanager"],function(){LocalAssetManager.getOfflineActions(n.Id).then(function(n){return n.length?void e.reportOfflineActions(n).then(function(){LocalAssetManager.deleteOfflineActions(n).then(function(){r.resolve()},y(r))},y(r)):void r.resolve()},y(r))}),r.promise()}function n(e,n,t){var o=jQuery.Deferred();return require(["localassetmanager"],function(){LocalAssetManager.getServerItemIds(n.Id).then(function(i){var a={TargetId:e.deviceId(),LocalItemIds:i,OfflineUserIds:(n.Users||[]).map(function(e){return e.Id})};e.syncData(a).then(function(i){r(e,n,t,i,o)},y(o))},y(o))}),o.promise()}function r(e,n,r,o,i){t(o,n.Id).then(function(){r?h(o,n.Id).then(function(){i.resolve()},y(i)):i.resolve()},y(i)),i.resolve()}function t(e,n){var r=jQuery.Deferred();return o(e.ItemIdsToRemove,0,n,r),r.promise()}function o(e,n,r,t){var a=e.length;return n>=a?void t.resolve():void i(e[n],r).then(function(){o(e,n+1,r,t)},function(){o(e,n+1,r,t)})}function i(e,n){var r=jQuery.Deferred();return require(["localassetmanager"],function(){LocalAssetManager.removeLocalItem(e,n).then(function(){r.resolve()},y(r))}),r.promise()}function a(e,n,r){var t=jQuery.Deferred();return e.getReadySyncItems(e.deviceId()).then(function(o){s(o,0,e,n,r,t)},y(t)),t.promise()}function s(e,n,r,t,o,i){var a=e.length;if(n>=a)return void i.resolve();var u=!1,f=function(){u||(u=!0,s(e,n+1,r,t,o,i))};c(e[n],r,t,o).then(f,f)}function c(e,n,r,t){var o=jQuery.Deferred();return require(["localassetmanager"],function(){var i=e.Item;LocalAssetManager.createLocalItem(i,r,e.OriginalFileName).then(function(r){u(n,e,r,t).then(function(t){return t?void o.resolve():void f(n,e,r).then(function(){d(n,e,r).then(function(){n.reportSyncJobItemTransferred(e.SyncJobItemId).then(function(){o.resolve()},y(o))},y(o))},y(o))},y(o))},y(o))}),o.promise()}function u(e,n,r,t){var o=jQuery.Deferred();return require(["localassetmanager"],function(){var i=e.getUrl("Sync/JobItems/"+n.SyncJobItemId+"/File",{api_key:e.accessToken()}),a=r.LocalPath;t=t||{},LocalAssetManager.downloadFile(i,a,t.enableBackgroundTransfer,t.enableNewDownloads).then(function(e,n){return n?void o.resolveWith(null,[!0]):void LocalAssetManager.addOrUpdateLocalItem(r).then(function(){o.resolveWith(null,[!1])},y(o))},y(o))}),o.promise()}function f(e,n,r){var t=jQuery.Deferred();return l(0,e,r,t),t.promise()}function l(e,n,r,t){return e>=4?void t.resolve():void t.resolve()}function d(e,n,r){var t=jQuery.Deferred();return require(["localassetmanager"],function(){if(!n.Item.MediaSources.length)return void t.resolve();var o=n.AdditionalFiles.filter(function(e){return"Subtitles"==e.Type}),i=n.Item.MediaSources[0];v(o,0,e,n,r,i,t)}),t.promise()}function v(e,n,r,t,o,i,a){var s=e.length;return n>=s?void a.resolve():void m(file,r,t,o,i).then(function(){v(e,n+1,r,t,o,i,a)},function(){v(e,n+1,r,t,o,i,a)})}function m(e,n,r,t,o){var i=jQuery.Deferred(),a=o.MediaStreams.filter(function(n){return"Subtitle"==n.Type&&n.Index==e.Index})[0];if(!a)return void i.reject();var s=n.getUrl("Sync/JobItems/"+r.SyncJobItemId+"/AdditionalFiles",{Name:e.Name,api_key:n.accessToken()});return require(["localassetmanager"],function(){LocalAssetManager.downloadSubtitles(s,t,a).then(function(e){a.Path=e,LocalAssetManager.addOrUpdateLocalItem(t).then(function(){i.resolve()},y(i))},y(i))}),i.promise()}function h(e,n){var r=jQuery.Deferred(),t=[];for(var o in e.ItemUserAccess)t.push(o);return I(t,0,e,n,r),r.promise()}function I(e,n,r,t,o){var i=e.length;return n>=i?void o.resolve():void g(e[n],r).then(function(){I(e,n+1,r,t,o)},function(){I(e,n+1,r,t,o)})}function g(e,n){var r=jQuery.Deferred();return require(["localassetmanager"],function(){LocalAssetManager.getUserIdsWithAccess(e,serverId).then(function(t){var o=n.ItemUserAccess[e];o.join(",")==t.join(",")?r.resolve():LocalAssetManager.saveUserIdsWithAccess(e,serverId,o).then(function(){r.resolve()},y(r))},y(r))}),r.promise()}function y(e){return function(){e.reject()}}var p=this;p.sync=function(r,t,o){var i=jQuery.Deferred();return e(r,t).then(function(){n(r,t,!1).then(function(){a(r,t,o).then(function(){n(r,t,!1).then(function(){i.resolve()},y(i))},y(i))},y(i))},y(i)),i.promise()}}e.MediaBrowser||(e.MediaBrowser={}),e.MediaBrowser.MediaSync=n}(this);