!function(e){function r(){function e(e,r){var n=DeferredBuilder.Deferred();return require(["localassetmanager"],function(){LocalAssetManager.getOfflineActions(r.Id).then(function(r){return r.length?void e.reportOfflineActions(r).then(function(){LocalAssetManager.deleteOfflineActions(r).then(function(){n.resolve()},D(n))},D(n)):void n.resolve()},D(n))}),n.promise()}function r(e,r,t){var o=DeferredBuilder.Deferred();return require(["localassetmanager"],function(){LocalAssetManager.getServerItemIds(r.Id).then(function(i){var a={TargetId:e.deviceId(),LocalItemIds:i,OfflineUserIds:(r.Users||[]).map(function(e){return e.Id})};e.syncData(a).then(function(i){n(e,r,t,i,o)},D(o))},D(o))}),o.promise()}function n(e,r,n,o,i){t(o,r.Id).then(function(){n?h(o,r.Id).then(function(){i.resolve()},D(i)):i.resolve()},D(i)),i.resolve()}function t(e,r){var n=DeferredBuilder.Deferred();return o(e.ItemIdsToRemove,0,r,n),n.promise()}function o(e,r,n,t){var a=e.length;return r>=a?void t.resolve():void i(e[r],n).then(function(){o(e,r+1,n,t)},function(){o(e,r+1,n,t)})}function i(e,r){var n=DeferredBuilder.Deferred();return require(["localassetmanager"],function(){LocalAssetManager.removeLocalItem(e,r).then(function(){n.resolve()},D(n))}),n.promise()}function a(e,r,n){var t=DeferredBuilder.Deferred();return e.getReadySyncItems(e.deviceId()).then(function(o){s(o,0,e,r,n,t)},D(t)),t.promise()}function s(e,r,n,t,o,i){var a=e.length;if(r>=a)return void i.resolve();var u=!1,f=function(){u||(u=!0,s(e,r+1,n,t,o,i))};c(e[r],n,t,o).then(f,f)}function c(e,r,n,t){var o=DeferredBuilder.Deferred();return require(["localassetmanager"],function(){var i=e.Item;LocalAssetManager.createLocalItem(i,n,e.OriginalFileName).then(function(n){u(r,e,n,t).then(function(t){return t?void o.resolve():void f(r,e,n).then(function(){l(r,e,n).then(function(){r.reportSyncJobItemTransferred(e.SyncJobItemId).then(function(){o.resolve()},D(o))},D(o))},D(o))},D(o))},D(o))}),o.promise()}function u(e,r,n,t){var o=DeferredBuilder.Deferred();return require(["localassetmanager"],function(){var i=e.getUrl("Sync/JobItems/"+r.SyncJobItemId+"/File",{api_key:e.accessToken()}),a=n.LocalPath;t=t||{},LocalAssetManager.downloadFile(i,a,t.enableBackgroundTransfer,t.enableNewDownloads).then(function(e,r){return r?void o.resolveWith(null,[!0]):void LocalAssetManager.addOrUpdateLocalItem(n).then(function(){o.resolveWith(null,[!1])},D(o))},D(o))}),o.promise()}function f(e,r,n){var t=DeferredBuilder.Deferred();return d(0,e,n,t),t.promise()}function d(e,r,n,t){return e>=4?void t.resolve():void t.resolve()}function l(e,r,n){var t=DeferredBuilder.Deferred();return require(["localassetmanager"],function(){if(!r.Item.MediaSources.length)return void t.resolve();var o=r.AdditionalFiles.filter(function(e){return"Subtitles"==e.Type}),i=r.Item.MediaSources[0];v(o,0,e,r,n,i,t)}),t.promise()}function v(e,r,n,t,o,i,a){var s=e.length;return r>=s?void a.resolve():void m(file,n,t,o,i).then(function(){v(e,r+1,n,t,o,i,a)},function(){v(e,r+1,n,t,o,i,a)})}function m(e,r,n,t,o){var i=DeferredBuilder.Deferred(),a=o.MediaStreams.filter(function(r){return"Subtitle"==r.Type&&r.Index==e.Index})[0];if(!a)return void i.reject();var s=r.getUrl("Sync/JobItems/"+n.SyncJobItemId+"/AdditionalFiles",{Name:e.Name,api_key:r.accessToken()});return require(["localassetmanager"],function(){LocalAssetManager.downloadSubtitles(s,t,a).then(function(e){a.Path=e,LocalAssetManager.addOrUpdateLocalItem(t).then(function(){i.resolve()},D(i))},D(i))}),i.promise()}function h(e,r){var n=DeferredBuilder.Deferred(),t=[];for(var o in e.ItemUserAccess)t.push(o);return I(t,0,e,r,n),n.promise()}function I(e,r,n,t,o){var i=e.length;return r>=i?void o.resolve():void g(e[r],n).then(function(){I(e,r+1,n,t,o)},function(){I(e,r+1,n,t,o)})}function g(e,r){var n=DeferredBuilder.Deferred();return require(["localassetmanager"],function(){LocalAssetManager.getUserIdsWithAccess(e,serverId).then(function(t){var o=r.ItemUserAccess[e];o.join(",")==t.join(",")?n.resolve():LocalAssetManager.saveUserIdsWithAccess(e,serverId,o).then(function(){n.resolve()},D(n))},D(n))}),n.promise()}function D(e){return function(){e.reject()}}var p=this;p.sync=function(n,t,o){var i=DeferredBuilder.Deferred();return e(n,t).then(function(){r(n,t,!1).then(function(){a(n,t,o).then(function(){r(n,t,!1).then(function(){i.resolve()},D(i))},D(i))},D(i))},D(i)),i.promise()}}e.MediaBrowser||(e.MediaBrowser={}),e.MediaBrowser.MediaSync=r}(this);