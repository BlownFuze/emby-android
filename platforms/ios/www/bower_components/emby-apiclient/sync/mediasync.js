define(["localassetmanager"],function(e){return function(){function n(n,r){return e.getOfflineActions(r.Id).then(function(r){return r.length?n.reportOfflineActions(r).then(function(){return e.deleteOfflineActions(r)}):Promise.resolve()})}function r(n,r,o){var i=DeferredBuilder.Deferred();return e.getServerItemIds(r.Id).then(function(e){var u={TargetId:n.deviceId(),LocalItemIds:e,OfflineUserIds:(r.Users||[]).map(function(e){return e.Id})};n.syncData(u).then(function(e){t(n,r,o,e,i)},g(i))},g(i)),i.promise()}function t(e,n,r,t,i){o(t,n.Id).then(function(){r?m(t,n.Id).then(function(){i.resolve()},g(i)):i.resolve()},g(i)),i.resolve()}function o(e,n){var r=DeferredBuilder.Deferred();return i(e.ItemIdsToRemove,0,n,r),r.promise()}function i(e,n,r,t){var o=e.length;return n>=o?void t.resolve():void u(e[n],r).then(function(){i(e,n+1,r,t)},function(){i(e,n+1,r,t)})}function u(n,r){return e.removeLocalItem(n,r)}function c(e,n,r){var t=DeferredBuilder.Deferred();return e.getReadySyncItems(e.deviceId()).then(function(o){f(o,0,e,n,r,t)},g(t)),t.promise()}function f(e,n,r,t,o,i){var u=e.length;if(n>=u)return void i.resolve();var c=!1,s=function(){c||(c=!0,f(e,n+1,r,t,o,i))};d(e[n],r,t,o).then(s,s)}function d(n,r,t,o){var i=DeferredBuilder.Deferred(),u=n.Item;return e.createLocalItem(u,t,n.OriginalFileName).then(function(e){s(r,n,e,o).then(function(t){return t?void i.resolve():void l(r,n,e).then(function(){v(r,n,e).then(function(){r.reportSyncJobItemTransferred(n.SyncJobItemId).then(function(){i.resolve()},g(i))},g(i))},g(i))},g(i))},g(i)),i.promise()}function s(n,r,t,o){var i=DeferredBuilder.Deferred(),u=n.getUrl("Sync/JobItems/"+r.SyncJobItemId+"/File",{api_key:n.accessToken()}),c=t.LocalPath;return o=o||{},e.downloadFile(u,c,o.enableBackgroundTransfer,o.enableNewDownloads).then(function(n,r){return r?void i.resolveWith(null,[!0]):void e.addOrUpdateLocalItem(t).then(function(){i.resolveWith(null,[!1])},g(i))},g(i)),i.promise()}function l(e,n,r){var t=DeferredBuilder.Deferred();return a(0,e,r,t),t.promise()}function a(e,n,r,t){return e>=4?void t.resolve():void t.resolve()}function v(e,n,r){var t=DeferredBuilder.Deferred();if(!n.Item.MediaSources.length)return void t.resolve();var o=n.AdditionalFiles.filter(function(e){return"Subtitles"==e.Type}),i=n.Item.MediaSources[0];return I(o,0,e,n,r,i,t),t.promise()}function I(e,n,r,t,o,i,u){var c=e.length;return n>=c?void u.resolve():void h(file,r,t,o,i).then(function(){I(e,n+1,r,t,o,i,u)},function(){I(e,n+1,r,t,o,i,u)})}function h(n,r,t,o,i){var u=DeferredBuilder.Deferred(),c=i.MediaStreams.filter(function(e){return"Subtitle"==e.Type&&e.Index==n.Index})[0];if(!c)return void u.reject();var f=r.getUrl("Sync/JobItems/"+t.SyncJobItemId+"/AdditionalFiles",{Name:n.Name,api_key:r.accessToken()});return e.downloadSubtitles(f,o,c).then(function(n){c.Path=n,e.addOrUpdateLocalItem(o).then(function(){u.resolve()},g(u))},g(u)),u.promise()}function m(e,n){var r=DeferredBuilder.Deferred(),t=[];for(var o in e.ItemUserAccess)t.push(o);return D(t,0,e,n,r),r.promise()}function D(e,n,r,t,o){var i=e.length;return n>=i?void o.resolve():void p(e[n],r).then(function(){D(e,n+1,r,t,o)},function(){D(e,n+1,r,t,o)})}function p(n,r){var t=DeferredBuilder.Deferred();return e.getUserIdsWithAccess(n,serverId).then(function(o){var i=r.ItemUserAccess[n];i.join(",")==o.join(",")?t.resolve():e.saveUserIdsWithAccess(n,serverId,i).then(function(){t.resolve()},g(t))},g(t)),t.promise()}function g(e){return function(){e.reject()}}var y=this;y.sync=function(e,t,o){return n(e,t).then(function(){return r(e,t,!1).then(function(){return c(e,t,o).then(function(){return r(e,t,!1)})})})}}});