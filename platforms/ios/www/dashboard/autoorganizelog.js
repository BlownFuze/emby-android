define(["serverNotifications","events","scripts/taskbutton","datetime","paper-icon-button-light"],function(e,t,a,r){function n(e,t){for(;!e.classList||!e.classList.contains(t);)if(e=e.parentNode,!e)return null;return e}function i(e){var t=p.Items.filter(function(t){return t.Id==e})[0];Dashboard.alert({title:c(t,!1),message:t.StatusMessage})}function o(e,t){var a=p.Items.filter(function(e){return e.Id==t})[0],r=Globalize.translate("MessageFileWillBeDeleted")+"<br/><br/>"+a.OriginalPath+"<br/><br/>"+Globalize.translate("MessageSureYouWishToProceed");require(["confirm"],function(a){a(r,Globalize.translate("HeaderDeleteFile")).then(function(){Dashboard.showLoadingMsg(),ApiClient.deleteOriginalFileFromOrganizationResult(t).then(function(){Dashboard.hideLoadingMsg(),d(e,!0)},Dashboard.processErrorResponse)})})}function s(e,t){l(e,t)}function l(e,t){require(["components/fileorganizer/fileorganizer"],function(a){a.show(t).then(function(){d(e,!1)})})}function u(e,t){var a=p.Items.filter(function(e){return e.Id==t})[0];if(!a.TargetPath)return void("Episode"==a.Type&&s(e,a));var r=Globalize.translate("MessageFollowingFileWillBeMovedFrom")+"<br/><br/>"+a.OriginalPath+"<br/><br/>"+Globalize.translate("MessageDestinationTo")+"<br/><br/>"+a.TargetPath;a.DuplicatePaths.length&&(r+="<br/><br/>"+Globalize.translate("MessageDuplicatesWillBeDeleted"),r+="<br/><br/>"+a.DuplicatePaths.join("<br/>")),r+="<br/><br/>"+Globalize.translate("MessageSureYouWishToProceed"),require(["confirm"],function(a){a(r,Globalize.translate("HeaderOrganizeFile")).then(function(){Dashboard.showLoadingMsg(),ApiClient.performOrganization(t).then(function(){Dashboard.hideLoadingMsg(),d(e,!0)},Dashboard.processErrorResponse)})})}function d(e,t){t&&Dashboard.showLoadingMsg(),ApiClient.getFileOrganizationResults(v).then(function(t){p=t,g(e,t),Dashboard.hideLoadingMsg()},Dashboard.processErrorResponse)}function c(e,t){var a=e.Status,r=null;return"SkippedExisting"==a?a=Globalize.translate("StatusSkipped"):"Failure"==a&&(r="#cc0000",a=Globalize.translate("StatusFailed")),"Success"==a&&(r="green",a=Globalize.translate("StatusSuccess")),t?e.StatusMessage?'<a style="color:'+r+';" data-resultid="'+e.Id+'" href="#" class="btnShowStatusMessage">'+a+"</a>":'<span data-resultid="'+e.Id+'" style="color:'+r+';">'+a+"</span>":a}function g(e,t){var a=t.Items.map(function(e){var t="";return t+='<tr id="row'+e.Id+'">',t+=b(e),t+="</tr>"}).join(""),r=e.querySelector(".resultBody");r.innerHTML=a,r.addEventListener("click",f);var n=LibraryBrowser.getQueryPagingHtml({startIndex:v.StartIndex,limit:v.Limit,totalRecordCount:t.TotalRecordCount,showLimit:!1,updatePageSizeSetting:!1}),i=e.querySelector(".listTopPaging");i.innerHTML=n;var o=e.querySelector(".listBottomPaging");o.innerHTML=n;var s=i.querySelector(".btnNextPage"),l=o.querySelector(".btnNextPage"),u=i.querySelector(".btnPreviousPage"),c=o.querySelector(".btnPreviousPage");s&&s.addEventListener("click",function(){v.StartIndex+=v.Limit,d(e,!0)}),l&&l.addEventListener("click",function(){v.StartIndex+=v.Limit,d(e,!0)}),u&&u.addEventListener("click",function(){v.StartIndex-=v.Limit,d(e,!0)}),c&&c.addEventListener("click",function(){v.StartIndex-=v.Limit,d(e,!0)});var g=e.querySelector(".btnClearLog");t.TotalRecordCount?g.classList.remove("hide"):g.classList.add("hide")}function b(e){var t="";t+="<td>";var a=e.IsInProgress?"":" hide";t+='<img src="css/images/throbber.gif" alt="" class="syncSpinner'+a+'" style="vertical-align: middle;" />',t+="</td>",t+='<td data-title="Date">';var n=r.parseISO8601Date(e.Date,!0);t+=n.toLocaleDateString(),t+="</td>",t+='<td data-title="Source" class="fileCell">';var i=e.Status;return e.IsInProgress?(t+='<span style="color:darkorange;">',t+=e.OriginalFileName,t+="</span>"):"SkippedExisting"==i?(t+='<a data-resultid="'+e.Id+'" style="color:blue;" href="#" class="btnShowStatusMessage">',t+=e.OriginalFileName,t+="</a>"):"Failure"==i?(t+='<a data-resultid="'+e.Id+'" style="color:red;" href="#" class="btnShowStatusMessage">',t+=e.OriginalFileName,t+="</a>"):(t+='<span style="color:green;">',t+=e.OriginalFileName,t+="</span>"),t+="</td>",t+='<td data-title="Destination" class="fileCell">',t+=e.TargetPath||"",t+="</td>",t+='<td class="organizerButtonCell">',"Success"!=e.Status&&(t+='<button type="button" is="paper-icon-button-light" data-resultid="'+e.Id+'" class="btnProcessResult organizerButton autoSize" title="'+Globalize.translate("ButtonOrganizeFile")+'"><i class="md-icon">folder</i></button>',t+='<button type="button" is="paper-icon-button-light" data-resultid="'+e.Id+'" class="btnDeleteResult organizerButton autoSize" title="'+Globalize.translate("ButtonDeleteFile")+'"><i class="md-icon">delete</i></button>'),t+="</td>"}function f(e){var t,a=n(e.target,"btnShowStatusMessage");a&&(t=a.getAttribute("data-resultid"),i(t));var r=n(e.target,"btnProcessResult");r&&(t=r.getAttribute("data-resultid"),u(e.view,t));var s=n(e.target,"btnDeleteResult");s&&(t=s.getAttribute("data-resultid"),o(e.view,t))}function h(e,t,a){"ScheduledTaskEnded"==e.type?a&&"AutoOrganize"==a.Key&&d(z,!1):"AutoOrganize_ItemUpdated"==e.type&&a?S(z,a):d(z,!1)}function S(e,t){var a="#row"+t.Id,r=e.querySelector(a);r&&(r.innerHTML=b(t))}function m(){return[{href:"autoorganizelog.html",name:Globalize.translate("TabActivityLog")},{href:"autoorganizetv.html",name:Globalize.translate("TabTV")},{href:"autoorganizesmart.html",name:Globalize.translate("TabSmartMatches")}]}var p,z,v={StartIndex:0,Limit:50};return function(r){z=r;var n=r.querySelector(".btnClearLog");n.addEventListener("click",function(){ApiClient.clearOrganizationLog().then(function(){d(r,!0)},Dashboard.processErrorResponse)}),r.addEventListener("viewshow",function(){LibraryMenu.setTabs("autoorganize",0,m),d(r,!0),t.on(e,"AutoOrganize_LogReset",h),t.on(e,"AutoOrganize_ItemUpdated",h),t.on(e,"AutoOrganize_ItemRemoved",h),t.on(e,"AutoOrganize_ItemAdded",h),t.on(e,"ScheduledTaskEnded",h),a({mode:"on",progressElem:r.querySelector(".organizeProgress"),panel:r.querySelector(".organizeTaskPanel"),taskKey:"AutoOrganize",button:r.querySelector(".btnOrganize")})}),r.addEventListener("viewhide",function(){p=null,t.off(e,"AutoOrganize_LogReset",h),t.off(e,"AutoOrganize_ItemUpdated",h),t.off(e,"AutoOrganize_ItemRemoved",h),t.off(e,"AutoOrganize_ItemAdded",h),t.off(e,"ScheduledTaskEnded",h),a({mode:"off",button:r.querySelector(".btnOrganize")})})}});