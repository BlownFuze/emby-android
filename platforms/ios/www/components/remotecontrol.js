define(["browser","jQuery","paper-fab","paper-tabs","paper-slider","paper-icon-button"],function(e,t){function a(e,t,a,n,r){var i=(n.MediaStreams||[]).filter(function(e){return"Audio"==e.Type}),o=i.map(function(e){var t=(e.Codec||"").toUpperCase();e.Profile&&(t+=" "+e.Profile),e.Language&&(t+=" · "+e.Language),e.Layout?t+=" · "+e.Layout:e.Channels&&(t+=" · "+e.Channels+" ch");var a={name:t,id:e.Index};return e.Index==r&&(a.ironIcon="check"),a});require(["actionsheet"],function(e){e.show({items:o,positionTo:a,callback:function(e){t.setAudioStreamIndex(parseInt(e))}})})}function n(e,t,a,n,r){var i=(n.MediaStreams||[]).filter(function(e){return"Subtitle"==e.Type}),o=i.map(function(e){var t=e.Language||Globalize.translate("LabelUnknownLanguage");e.IsDefault&&e.IsForced?t+=" · "+Globalize.translate("LabelDefaultForcedStream"):e.IsDefault?t+=" · "+Globalize.translate("LabelDefaultStream"):e.IsForced&&(t+=" · "+Globalize.translate("LabelForcedStream")),e.Codec&&(t+=" · "+e.Codec.toUpperCase());var a={name:t,id:e.Index};return e.Index==r&&(a.ironIcon="check"),a});o.unshift({id:-1,name:Globalize.translate("ButtonOff"),ironIcon:null==r?"check":null}),require(["actionsheet"],function(e){e.show({items:o,positionTo:a,callback:function(e){t.setSubtitleStreamIndex(parseInt(e))}})})}function r(e){e.classList.remove("hide")}function i(e){e.classList.add("hide")}function o(e,t){return e&&e.MediaStreams&&e.MediaStreams.filter(function(e){return e.Type==t}).length>0}function l(t,a){var n=a.NowPlayingItem,r=n?MediaController.getNowPlayingNameHtml(n).replace("<br/>"," - "):"";t.querySelector(".nowPlayingPageTitle").innerHTML=r,r.length>0?t.querySelector(".nowPlayingPageTitle").classList.remove("hide"):t.querySelector(".nowPlayingPageTitle").classList.add("hide");var i,o=null;n&&(n.PrimaryImageTag?i=ApiClient.getScaledImageUrl(n.PrimaryImageItemId,{type:"Primary",maxHeight:300,tag:n.PrimaryImageTag}):n.BackdropImageTag?i=ApiClient.getScaledImageUrl(n.BackdropItemId,{type:"Backdrop",maxHeight:300,tag:n.BackdropImageTag,index:0}):n.ThumbImageTag&&(i=ApiClient.getScaledImageUrl(n.ThumbImageItemId,{type:"Thumb",maxHeight:300,tag:n.ThumbImageTag}))),i!=g&&(n&&n.BackdropImageTag&&(o=ApiClient.getScaledImageUrl(n.BackdropItemId,{type:"Backdrop",maxHeight:300,tag:n.BackdropImageTag,index:0})),s(t,i),n?(e.mobile||require(["backdrop"],function(e){e.setBackdrop(o)}),ApiClient.getItem(Dashboard.getCurrentUserId(),n.Id).then(function(e){t.querySelector(".nowPlayingPageUserDataButtons").innerHTML=LibraryBrowser.getUserDataIconsHtml(e,!1)})):t.querySelector(".nowPlayingPageUserDataButtons").innerHTML="")}function s(e,t){g=t,t?ImageLoader.lazyImage(e.querySelector(".nowPlayingPageImage"),t):e.querySelector(".nowPlayingPageImage").style.backgroundImage=""}function c(e,t){e.disabled=!t}function u(e,t){for(var a=e.querySelectorAll(".btnCommand"),n=0,r=a.length;r>n;n++)c(a[n],-1!=t.indexOf(a[n].getAttribute("data-command")))}function d(){}var g;return function(){function s(e){if(e&&N){var t=N;switch((t.PlayState||{}).RepeatMode){case"RepeatNone":e.setRepeatMode("RepeatAll");break;case"RepeatAll":e.setRepeatMode("RepeatOne");break;case"RepeatOne":e.setRepeatMode("RepeatNone")}}}function y(e,t){N=t;var a=t.NowPlayingItem,n=MediaController.getPlayerInfo(),s=n.supportedCommands,u=t.PlayState||{};c(e.querySelector(".btnToggleFullscreen"),a&&"Video"==a.MediaType&&-1!=s.indexOf("ToggleFullscreen")),c(e.querySelector(".btnAudioTracks"),o(a,"Audio")&&-1!=s.indexOf("SetAudioStreamIndex")),c(e.querySelector(".btnSubtitles"),o(a,"Subtitle")&&-1!=s.indexOf("SetSubtitleStreamIndex")),a&&a.Chapters&&a.Chapters.length&&u.CanSeek?c(e.querySelector(".btnChapters"),!0):(c(e.querySelector(".btnChapters"),!1),d(e)),-1!=s.indexOf("DisplayMessage")?e.querySelector(".sendMessageSection").classList.remove("hide"):e.querySelector(".sendMessageSection").classList.add("hide"),-1!=s.indexOf("SendString")?e.querySelector(".sendTextSection").classList.remove("hide"):e.querySelector(".sendTextSection").classList.add("hide"),c(e.querySelector(".btnStop"),null!=a),c(e.querySelector(".btnNextTrack"),null!=a),c(e.querySelector(".btnPreviousTrack"),null!=a);var g=e.querySelector(".btnPause"),y=e.querySelector(".btnPlay");c(g,null!=a),c(y,null!=a),u.IsPaused?(i(g),r(y)):(r(g),i(y));var m=e.querySelector(".nowPlayingPositionSlider");if(!m.dragging){if(a&&a.RunTimeTicks){var p=u.PositionTicks/a.RunTimeTicks;p*=100,m.value=p}else m.value=0;m.disabled=!u.CanSeek}e.querySelector(".positionTime").innerHTML=null==u.PositionTicks?"--:--":Dashboard.getDisplayTime(u.PositionTicks),e.querySelector(".runtime").innerHTML=a&&null!=a.RunTimeTicks?Dashboard.getDisplayTime(a.RunTimeTicks):"--:--",a&&"Video"==a.MediaType?e.classList.remove("hideVideoButtons"):e.classList.add("hideVideoButtons"),n.isLocalPlayer&&AppInfo.hasPhysicalVolumeButtons?e.classList.add("hideVolumeButtons"):e.classList.remove("hideVolumeButtons"),a&&"Audio"==a.MediaType?e.querySelector(".buttonsRow2").classList.add("hide"):e.querySelector(".buttonsRow2").classList.remove("hide");var f=e.querySelector(".repeatToggleButton");"RepeatAll"==u.RepeatMode?(f.icon="repeat",f.classList.add("nowPlayingPageRepeatActive")):"RepeatOne"==u.RepeatMode?(f.icon="repeat-one",f.classList.add("nowPlayingPageRepeatActive")):(f.icon="repeat",f.classList.remove("nowPlayingPageRepeatActive")),l(e,t)}function m(e){var t="",a=p(e);a&&(t+=LibraryBrowser.getListViewHtml({items:MediaController.playlist(),smallIcon:!0}),H=!1);var n=[];a&&(n.push("paper-icon-item"),n.push("paper-item-body")),require(n,function(){var n=e.querySelector(".playlist");if(n.innerHTML=t,a){var r=MediaController.currentPlaylistIndex();if(-1!=r){var i=n.querySelectorAll(".listItem")[r];if(i){var o=i.querySelector(".listviewImage");o.classList.remove("lazy"),o.classList.add("playlistIndexIndicatorImage")}}}ImageLoader.lazyChildren(n)})}function p(e){return 2==e.querySelector("paper-tabs").selected}function f(e,t){if("positionchange"==e.type){var a=(new Date).getTime();if(700>a-B)return;B=a}y(E,t)}function v(e,t){var a=this;a.beginPlayerUpdates(),f.call(a,e,t),p(E)?m(E):H=!0}function S(e){var t=this;t.endPlayerUpdates(),f.call(t,e,{}),p(E)?m(E):H=!0}function b(){R&&(Events.off(R,"playbackstart",v),Events.off(R,"playbackstop",S),Events.off(R,"volumechange",f),Events.off(R,"playstatechange",f),Events.off(R,"positionchange",f),R.endPlayerUpdates(),R=null)}function P(e,t){b(),R=t,t.getPlayerState().then(function(e){e.NowPlayingItem&&t.beginPlayerUpdates(),f.call(t,{type:"init"},e)}),Events.on(t,"playbackstart",v),Events.on(t,"playbackstop",S),Events.on(t,"volumechange",f),Events.on(t,"playstatechange",f),Events.on(t,"positionchange",f);var a=MediaController.getPlayerInfo(),n=a.supportedCommands;u(e,n)}function h(e){var t=MediaController.getPlayerInfo(),a=e.querySelector(".nowPlayingCastIcon");t.isLocalPlayer?(a.icon="cast",a.classList.remove("btnActiveCast"),e.querySelector(".nowPlayingSelectedPlayer").innerHTML=""):(a.icon="cast-connected",a.classList.add("btnActiveCast"),e.querySelector(".nowPlayingSelectedPlayer").innerHTML=t.deviceName||t.name)}function I(e,t){for(;!e.classList||!e.classList.contains(t);)if(e=e.parentNode,!e)return null;return e}function T(e){var t=I(e.target,"lnkPlayFromIndex");if(null!=t){var a=parseInt(t.getAttribute("data-index"));return MediaController.currentPlaylistIndex(a),m(context),e.preventDefault(),e.stopPropagation(),!1}var n=I(e.target,"lnkRemoveFromPlaylist");if(null!=n){var a=parseInt(n.getAttribute("data-index"));return MediaController.removeFromPlaylist(a),m(context),e.preventDefault(),e.stopPropagation(),!1}var r=I(e.target,"mediaItem");if(null!=r){var i=LibraryBrowser.getListItemInfo(r);return MediaController.currentPlaylistIndex(i.index),e.preventDefault(),e.stopPropagation(),!1}}function L(e){t(".btnCommand",e).on("click",function(){R&&(this.classList.contains("repeatToggleButton")?s(R):MediaController.sendCommand({Name:this.getAttribute("data-command")},R))}),e.querySelector(".btnToggleFullscreen").addEventListener("click",function(e){R&&MediaController.sendCommand({Name:e.target.getAttribute("data-command")},R)}),e.querySelector(".btnAudioTracks").addEventListener("click",function(t){if(R&&N&&N.PlayState){var n=N.PlayState.AudioStreamIndex;a(e,R,t.target,N.NowPlayingItem,n)}}),e.querySelector(".btnSubtitles").addEventListener("click",function(t){if(R&&N&&N.PlayState){var a=N.PlayState.SubtitleStreamIndex;n(e,R,t.target,N.NowPlayingItem,a)}}),e.querySelector(".btnChapters").addEventListener("click",function(){}),e.querySelector(".btnStop").addEventListener("click",function(){R&&R.stop()}),e.querySelector(".btnPlay").addEventListener("click",function(){R&&R.unpause()}),e.querySelector(".btnPause").addEventListener("click",function(){R&&R.pause()}),e.querySelector(".btnNextTrack").addEventListener("click",function(){R&&R.nextTrack()}),e.querySelector(".btnPreviousTrack").addEventListener("click",function(){R&&R.previousTrack()}),e.querySelector(".nowPlayingPositionSlider").addEventListener("change",function(){var e=this.value;if(R&&N){var t=parseFloat(e),a=t/100*N.NowPlayingItem.RunTimeTicks;R.seek(Math.floor(a))}}),e.querySelector(".nowPlayingPositionSlider",e)._setPinValue=function(e){var t=N;if(!t||!t.NowPlayingItem||!t.NowPlayingItem.RunTimeTicks)return void(this.pinValue="--:--");var a=t.NowPlayingItem.RunTimeTicks;a/=100,a*=e,this.pinValue=Dashboard.getDisplayTime(a)},e.addEventListener("click",T)}function q(){var e=E;h(e),P(e,MediaController.getCurrentPlayer())}function k(e){var a=e.target;return MediaController.sendCommand({Name:"DisplayMessage",Arguments:{Header:t("#txtMessageTitle",a).val(),Text:t("#txtMessageText",a).val()}},R),t("input",a).val(""),require(["toast"],function(e){e("Message sent.")}),e.preventDefault(),e.stopPropagation(),!1}function C(e){var a=e.target;return MediaController.sendCommand({Name:"SendString",Arguments:{String:t("#txtTypeText",a).val()}},R),t("input",a).val(""),require(["toast"],function(e){e("Text sent.")}),e.preventDefault(),e.stopPropagation(),!1}function w(e){var t=E.querySelectorAll(".nowPlayingPageTab");e=(e||0).toString();for(var a=0,n=t.length;n>a;a++){var r=t[a];r.getAttribute("data-tab")==e?r.classList.remove("hide"):r.classList.add("hide")}}function x(e){Dashboard.importCss("css/nowplaying.css"),L(e),e.querySelector(".sendMessageForm").addEventListener("submit",k),e.querySelector(".typeTextForm").addEventListener("submit",C),e.querySelector(".nowPlayingCastIcon").addEventListener("click",function(){MediaController.showPlayerSelection()}),e.querySelector(".btnExitRemoteControl").addEventListener("click",function(){history.back()});var a=e.querySelector("paper-tabs");AppInfo.enableNowPlayingPageBottomTabs?(a.classList.remove("hide"),e.querySelector(".libraryViewNav").classList.add("hide")):(a.classList.add("hide"),e.querySelector(".libraryViewNav").classList.remove("hide")),a.noSlide=!0,a.addEventListener("iron-select",function(t){var a=e.querySelector(".libraryViewNav a.ui-btn-active");a&&a.classList.remove("ui-btn-active"),e.querySelector(".libraryViewNav a[data-index='"+t.target.selected+"']").classList.add("ui-btn-active"),2==t.target.selected&&H&&m(e),w(t.target.selected)}),t(e.querySelectorAll(".libraryViewNav a")).on("click",function(){var e=this.getAttribute("data-index");a.selected=e}),Events.on(MediaController,"playerchange",q),t(e.querySelector(".itemsContainer")).createCardMenus()}function M(){b(),Events.off(MediaController,"playerchange",q),N=null}function A(t,a){g=null,P(t,MediaController.getCurrentPlayer());var n="#playlist"==a?2:0,r=e.animate?0:1e3;setTimeout(function(){AppInfo.enableNowPlayingPageBottomTabs?t.querySelector("paper-tabs").selected=n:w(n)},r),h(t)}var E,R,N,B=0,D=this,H=!0;D.init=function(e){E=e,AppInfo.enableNowPlayingPageBottomTabs||(e.querySelector(".btnExitRemoteControl").style.position="relative",e.querySelector(".topRightContainer").style.position="relative"),x(E)},D.onShow=function(){A(E,window.location.hash)},D.destroy=function(){M()}}});