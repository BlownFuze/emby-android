define(["serverNotifications","events","loading","connectionManager","imageLoader","dom","globalize","listViewStyle"],function(t,e,n,s,i,o,a){function r(t,e,n){var s=this;v(s,n)}function c(t,e){for(var n=0,s=e.length;s>n;n++){var i=e[n];d(t,i)}}function l(t,e){require(["confirm"],function(s){var i=a.translate(t.options.isLocalSync?"ConfirmRemoveDownload":"CancelSyncJobConfirmation");s(i).then(function(){n.show();var s=f(t);s.ajax({url:s.getUrl("Sync/Jobs/"+e),type:"DELETE"}).then(function(){m(t)})})})}function d(t,e){var n=t.options.element.querySelector(".listItem[data-id='"+e.Id+"']");if(n){var s=e.Progress||0,i=n.querySelector(".statusIcon");0===s?(i.innerHTML="file_download",i.classList.add("md-icon"),i.classList.remove("status-text-icon"),i.classList.add("zeroProgressStatus")):s>=100?(i.innerHTML="check",i.classList.add("md-icon"),i.classList.remove("status-text-icon"),i.classList.remove("zeroProgressStatus")):(i.classList.remove("md-icon"),i.classList.remove("zeroProgressStatus"),i.classList.add("status-text-icon"),i.innerHTML=Math.round(s)+"%")}}function u(t,e){var n="";n+='<div class="listItem" data-id="'+e.Id+'" data-status="'+e.Status+'">';var s=e.Progress||0;n+=0===s?'<i class="md-icon listItemIcon statusIcon zeroProgressStatus">file_download</i>':s>=100?'<i class="md-icon listItemIcon statusIcon">check</i>':'<i class="listItemIcon statusIcon status-text-icon">'+Math.round(s)+"%</i>";var i=[];e.ParentName&&i.push(e.ParentName),i.push(e.Name),i.push(1==e.ItemCount?a.translate("ValueItemCount",e.ItemCount):a.translate("ValueItemCountPlural",e.ItemCount)),n+=i>=3?'<div class="listItemBody three-line">':'<div class="listItemBody two-line">';for(var o=0,r=i.length;r>o;o++)0==o?(n+='<h3 class="listItemBodyText">',n+=i[o],n+="</h3>"):(n+='<div class="listItemBodyText secondary">',n+=i[o],n+="</div>");return n+="</div>",n+='<button type="button" is="paper-icon-button-light" class="btnJobMenu listItemButton"><i class="md-icon">more_vert</i></button>',n+="</div>"}function v(t,e){if((new Date).getTime()-t.lastDataLoad<6e4)return void c(t,e);t.lastDataLoad=(new Date).getTime();for(var n="",s="",o=t.options.isLocalSync,r=!o,l=!1,d=0,v=e.length;v>d;d++){var m=e[d];if(r){var h=m.TargetName||"Unknown";h!=s&&(s&&(n+="</div>",n+="<br/>",n+="<br/>",n+="<br/>",l=!1),s=h,n+='<div class="detailSectionHeader">',n+="<div>"+h+"</div>",n+="</div>",n+='<div class="itemsContainer vertical-list">',l=!0)}n+=u(t,m)}l&&(n+="</div>");var p=t.options.element;n||(n=o?'<div style="padding:1em .25em;">'+a.translate("MessageDownloadsFound")+"</div>":'<div style="padding:1em .25em;">'+a.translate("MessageNoSyncJobsFound")+"</div>"),p.innerHTML=n,i.lazyChildren(p)}function m(t){t.lastDataLoad=0,n.show();var e={},s=f(t);return t.options.userId&&(e.UserId=t.options.userId),t.options.isLocalSync?e.TargetId=s.deviceId():e.ExcludeTargetIds=s.deviceId(),s.getJSON(ApiClient.getUrl("Sync/Jobs",e)).then(function(e){v(t,e.Items),n.hide()})}function h(t){var e="0,1500",n=f(t);t.options.userId&&(e+=","+t.options.userId),t.options.isLocalSync&&(e+=","+n.deviceId()),n.isWebSocketOpen()&&n.sendWebSocketMessage("SyncJobsStart",e)}function p(t){var e=f(t);e.isWebSocketOpen()&&e.sendWebSocketMessage("SyncJobsStop","")}function f(t){return s.getApiClient(t.options.serverId)}function I(t,e){var n=o.parentWithClass(e,"listItem"),s=n.getAttribute("data-id"),i=n.getAttribute("data-status"),r=[];if("Cancelled"==i)r.push({name:a.translate("ButtonDelete"),id:"delete"});else{var c=a.translate(t.options.isLocalSync?"RemoveDownload":"ButtonCancelSyncJob");r.push({name:a.translate(c),id:"cancel"})}require(["actionsheet"],function(n){n.show({items:r,positionTo:e,callback:function(e){switch(e){case"delete":l(t,s);break;case"cancel":l(t,s)}}})})}function b(t){var n=this,s=o.parentWithClass(t.target,"btnJobMenu");if(s)return void I(this,s);var i=o.parentWithClass(t.target,"listItem");if(i){var a=i.getAttribute("data-id");e.trigger(n,"jobedit",[a,n.options.serverId])}}function g(n){this.options=n;var s=r.bind(this);this.onSyncJobsUpdatedHandler=s,e.on(t,"SyncJobs",s);var i=b.bind(this);n.element.addEventListener("click",i),this.onClickHandler=i,m(this),h(this)}return g.prototype.destroy=function(){p(this);var n=this.onSyncJobsUpdatedHandler;this.onSyncJobsUpdatedHandler=null,e.off(t,"SyncJobs",n);var s=this.onClickHandler;this.onClickHandler=null,this.options.element.removeEventListener("click",s),this.options=null},g});