define(["dialogHelper","loading","emby-input","emby-checkbox","paper-icon-button-light"],function(e,t){function r(e){var r,a,n={ProviderIds:{}},o=e.querySelectorAll(".identifyField");for(r=0,a=o.length;a>r;r++){var d=o[r].value;d&&("number"==o[r].type&&(d=parseInt(d)),n[o[r].getAttribute("data-lookup")]=d)}var l=!1,s=e.querySelectorAll(".txtLookupId");for(r=0,a=o.length;a>r;r++){var d=s[r].value;d&&(l=!0),n.ProviderIds[s[r].getAttribute("data-providerkey")]=d}return l||n.Name?(v&&v.GameSystem&&(n.GameSystem=v.GameSystem),n={SearchInfo:n,IncludeDisabledProviders:!0},t.show(),void ApiClient.ajax({type:"POST",url:ApiClient.getUrl("Items/RemoteSearch/"+y),data:JSON.stringify(n),contentType:"application/json",dataType:"json"}).then(function(r){t.hide(),i(e,r)})):void require(["toast"],function(e){e(Globalize.translate("MessagePleaseEnterNameOrId"))})}function i(e,t){function r(){var r=parseInt(this.getAttribute("data-index")),i=t[r];null!=v?n(e,i):a(e,i)}e.querySelector(".popupIdentifyForm").classList.add("hide"),e.querySelector(".identificationSearchResults").classList.remove("hide"),e.querySelector(".identifyOptionsForm").classList.add("hide");var i,d,l="";for(i=0,d=t.length;d>i;i++){var s=t[i];l+=o(s,i)}var c=e.querySelector(".identificationSearchResultList");c.innerHTML=l;var u=c.querySelectorAll(".searchImage");for(i=0,d=u.length;d>i;i++)u[i].addEventListener("click",r)}function a(r,i){S=i,L=!0,t.hide(),e.close(r)}function n(e,t){e.querySelector(".popupIdentifyForm").classList.add("hide"),e.querySelector(".identificationSearchResults").classList.add("hide"),e.querySelector(".identifyOptionsForm").classList.remove("hide"),e.querySelector("#chkIdentifyReplaceImages").checked=!0,S=t;var r=[];r.push(t.Name),t.ProductionYear&&r.push(t.ProductionYear),t.GameSystem&&r.push(t.GameSystem);var i=r.join("<br/>");if(t.ImageUrl){var a=d(t.ImageUrl,t.SearchProviderName);i='<img src="'+a+'" style="max-height:160px;" /><br/>'+i}e.querySelector(".selectedSearchResult").innerHTML=i}function o(e,t){var r="",i="card";if(i+="Episode"==y?" backdropCard":"MusicAlbum"==y||"MusicArtist"==y?" squareCard":" portraitCard",r+='<div class="'+i+'">',r+='<div class="cardBox">',r+='<div class="cardScalable">',r+='<div class="cardPadder"></div>',r+='<a class="cardContent searchImage" href="#" data-index="'+t+'">',e.ImageUrl){var a=d(e.ImageUrl,e.SearchProviderName);r+='<div class="cardImage" style="background-image:url(\''+a+"');\"></div>"}else r+='<div class="cardImage iconCardImage"><iron-icon icon="search"></iron-icon></div>';return r+="</a>",r+="</div>",r+='<div class="cardFooter outerCardFooter">',r+='<div class="cardText cardTextCentered">'+e.Name+"</div>",r+='<div class="cardText cardTextCentered">',r+=e.ProductionYear||"&nbsp;",r+="</div>",e.GameSystem&&(r+='<div class="cardText cardTextCentered">',r+=e.GameSystem,r+="</div>"),r+="</div>",r+="</div>",r+="</div>"}function d(e,t){return ApiClient.getUrl("Items/RemoteSearch/Image",{imageUrl:e,ProviderName:t})}function l(r){t.show();var i={ReplaceAllImages:r.querySelector("#chkIdentifyReplaceImages").checked};ApiClient.ajax({type:"POST",url:ApiClient.getUrl("Items/RemoteSearch/Apply/"+v.Id,i),data:JSON.stringify(S),contentType:"application/json"}).then(function(){L=!0,t.hide(),e.close(r)},function(){t.hide(),e.close(r)})}function s(e,t){ApiClient.getJSON(ApiClient.getUrl("Items/"+t.Id+"/ExternalIdInfos")).then(function(r){for(var i="",a=t.ProviderIds||{},n=0,o=r.length;o>n;n++){var d=r[n],l="txtLookup"+d.Key;i+='<div class="inputContainer">';{var s=Globalize.translate("LabelDynamicExternalId").replace("{0}",d.Name);a[d.Key]||""}i+='<input is="emby-input" class="txtLookupId" data-providerkey="'+d.Key+'" id="'+l+'" label="'+s+'"/>',i+="</div>"}e.querySelector("#txtLookupName").value="","Person"==t.Type||"BoxSet"==t.Type?(e.querySelector(".fldLookupYear").classList.add("hide"),e.querySelector("#txtLookupYear").value=""):(e.querySelector(".fldLookupYear").classList.remove("hide"),e.querySelector("#txtLookupYear").value=""),e.querySelector(".identifyProviderIds").innerHTML=i,e.querySelector(".dialogHeaderTitle").innerHTML=Globalize.translate("HeaderIdentify")})}function c(i){t.show();var a=new XMLHttpRequest;a.open("GET","components/itemidentifier/itemidentifier.template.html",!0),a.onload=function(){var a=this.response;ApiClient.getItem(ApiClient.getCurrentUserId(),i).then(function(i){v=i,y=v.Type;var n=e.createDialog({size:"medium",removeOnClose:!0});n.classList.add("ui-body-b"),n.classList.add("background-theme-b");var o="";o+=Globalize.translateDocument(a),n.innerHTML=o,document.body.appendChild(n),n.addEventListener("close",u),e.open(n),n.querySelector(".popupIdentifyForm").addEventListener("submit",function(e){return e.preventDefault(),r(n),!1}),n.querySelector(".identifyOptionsForm").addEventListener("submit",function(e){return e.preventDefault(),l(n),!1}),n.querySelector(".btnCancel").addEventListener("click",function(){e.close(n)}),n.classList.add("identifyDialog"),s(n,i),t.hide()})},a.send()}function u(){t.hide(),L?f():h()}function p(i,a,n,o){v=null,y=n;var d=new XMLHttpRequest;d.open("GET","components/itemidentifier/itemidentifier.template.html",!0),d.onload=function(){var d=this.response,l=e.createDialog({size:"medium"});l.classList.add("ui-body-a"),l.classList.add("background-theme-a");var s="";s+=Globalize.translateDocument(d),l.innerHTML=s,document.body.appendChild(l),e.open(l),l.querySelector(".btnCancel").addEventListener("click",function(){e.close(l)}),l.querySelector(".popupIdentifyForm").addEventListener("submit",function(e){return e.preventDefault(),r(l),!1}),l.addEventListener("close",function(){t.hide();var e=L?S:null;o(e)}),l.classList.add("identifyDialog"),m(l,i,a,n)},d.send()}function m(e,t,r,i){e.querySelector("#txtLookupName").value=t,"Person"==i||"BoxSet"==i?(e.querySelector(".fldLookupYear").classList.add("hide"),e.querySelector("#txtLookupYear").value=""):(e.querySelector(".fldLookupYear").classList.remove("hide"),e.querySelector("#txtLookupYear").value=r),e.querySelector(".dialogHeaderTitle").innerHTML=Globalize.translate("HeaderSearch")}var v,y,f,h,S,L=!1;return{show:function(e){return new Promise(function(t,r){f=t,h=r,L=!1,c(e)})},showFindNew:function(e,t,r){return new Promise(function(i){L=!1,p(e,t,r,i)})}}});