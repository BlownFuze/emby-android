define(["paperdialoghelper","paper-fab","paper-item-body","paper-icon-item"],function(e){function t(e,t){Dashboard.showLoadingMsg();var i=$(".popupSubtitleViewer",e).popup("open");$(".subtitleContent",e).html("");var a="Videos/"+c.Id+"/Subtitles/"+t;ApiClient.ajax({type:"GET",url:a}).then(function(t){$(".subtitleContent",e).html(t),Dashboard.hideLoadingMsg(),i.popup("reposition",{})})}function i(e,t){Dashboard.showLoadingMsg();var i=$(".popupSubtitleViewer",e).popup("open");$(".subtitleContent",e).html("");var a="Providers/Subtitles/Subtitles/"+t;ApiClient.get(ApiClient.getUrl(a)).then(function(t){$(".subtitleContent",e).html(t),Dashboard.hideLoadingMsg(),i.popup("reposition",{})})}function a(e,t){var i="Items/"+c.Id+"/RemoteSearch/Subtitles/"+t;ApiClient.ajax({type:"POST",url:ApiClient.getUrl(i)}).then(function(){require(["toast"],function(e){e(Globalize.translate("MessageDownloadQueued"))})})}function n(e,t){var i=Globalize.translate("MessageAreYouSureDeleteSubtitles");require(["confirm"],function(a){a(i,Globalize.translate("HeaderConfirmDeletion")).then(function(){Dashboard.showLoadingMsg();var i=c.Id,a="Videos/"+i+"/Subtitles/"+t;ApiClient.ajax({type:"DELETE",url:ApiClient.getUrl(a)}).then(function(){d(e,i)})})})}function o(e,i){var a=i.MediaStreams||[],o=a.filter(function(e){return"Subtitle"==e.Type}),r="";o.length&&(r+='<h1 style="margin-top:1.5em;">'+Globalize.translate("HeaderCurrentSubtitles")+"</h1>",r+='<div class="paperList">',r+=o.map(function(e){var t="";t+="<paper-icon-item>",t+='<paper-fab mini class="blue" icon="closed-caption" item-icon></paper-fab>';var i=[];return i.push(e.Codec),e.IsDefault&&i.push("Default"),e.IsForced&&i.push("Forced"),t+=3==i.length?"<paper-item-body three-line>":"<paper-item-body two-line>",t+="<div>",t+=e.Language||Globalize.translate("LabelUnknownLanaguage"),t+="</div>",t+="<div secondary>"+i.join(" - ")+"</div>",e.Path&&(t+="<div secondary>"+e.Path+"</div>"),r+="</a>",t+="</paper-item-body>",e.Path&&(t+='<paper-icon-button icon="delete" data-index="'+e.Index+'" title="'+Globalize.translate("Delete")+'" class="btnDelete"></paper-icon-button>'),t+="</paper-icon-item>"}).join(""),r+="</div>");var l=$(".subtitleList",e).html(r).trigger("create");$(".btnViewSubtitles",l).on("click",function(){var i=this.getAttribute("data-index");t(e,i)}),$(".btnDelete",l).on("click",function(){var t=this.getAttribute("data-index");n(e,t)})}function r(e,t){$("#selectLanguage",e).html(t.map(function(e){return'<option value="'+e.ThreeLetterISOLanguageName+'">'+e.DisplayName+"</option>"}));var i=appStorage.getItem("subtitleeditor-language");i?$("#selectLanguage",e).val(i):Dashboard.getCurrentUser().then(function(t){var i=t.Configuration.SubtitleLanguagePreference;i&&$("#selectLanguage",e).val(i)})}function l(e,t){var n="",o="";if(!t.length)return $(".noSearchResults",e).show(),$(".subtitleResults",e).html(""),void Dashboard.hideLoadingMsg();$(".noSearchResults",e).hide();for(var r=0,l=t.length;l>r;r++){var s=t[r],d=s.ProviderName;d!=n&&(r>0&&(o+="</div>"),o+="<h1>"+d+"</h1>",o+='<div class="paperList">',n=d),o+="<paper-icon-item>",o+='<paper-fab mini class="blue" icon="closed-caption" item-icon></paper-fab>',o+=s.Comment?"<paper-item-body three-line>":"<paper-item-body two-line>",o+="<div>"+s.Name+"</div>",o+="<div secondary>"+s.Format+"</div>",s.Comment&&(o+="<div secondary>"+s.Comment+"</div>"),o+="</paper-item-body>",o+='<div style="font-size:86%;opacity:.7;">'+(s.DownloadCount||0)+"</div>",o+='<paper-icon-button icon="cloud-download" data-subid="'+s.Id+'" title="'+Globalize.translate("ButtonDownload")+'" class="btnDownload"></paper-icon-button>',o+="</paper-icon-item>"}t.length&&(o+="</div>");var u=$(".subtitleResults",e).html(o).trigger("create");$(".btnViewSubtitle",u).on("click",function(){var t=this.getAttribute("data-subid");i(e,t)}),$(".btnDownload",u).on("click",function(){var t=this.getAttribute("data-subid");a(e,t)}),Dashboard.hideLoadingMsg()}function s(e,t){appStorage.setItem("subtitleeditor-language",t),Dashboard.showLoadingMsg();var i=ApiClient.getUrl("Items/"+c.Id+"/RemoteSearch/Subtitles/"+t);ApiClient.getJSON(i).then(function(t){l(e,t)})}function d(e,t){function i(t){c=t,o(e,t);var i=t.Path||"",a=Math.max(i.lastIndexOf("/"),i.lastIndexOf("\\"));a>-1&&(i=i.substring(a+1)),i?(e.querySelector(".pathValue").innerHTML=i,e.querySelector(".originalFile").classList.remove("hide")):(e.querySelector(".pathValue").innerHTML="",e.querySelector(".originalFile").classList.add("hide")),Dashboard.hideLoadingMsg()}$(".noSearchResults",e).hide(),"string"==typeof t?ApiClient.getItem(Dashboard.getCurrentUserId(),t).then(i):i(t)}function u(){var e=this,t=$("#selectLanguage",e).val();return s($(e).parents(".editorContent"),t),!1}function p(t){Dashboard.showLoadingMsg();var i=new XMLHttpRequest;i.open("GET","components/subtitleeditor/subtitleeditor.template.html",!0),i.onload=function(){var i=this.response;ApiClient.getItem(Dashboard.getCurrentUserId(),t).then(function(t){var a=e.createDialog({size:"small",removeOnClose:!0});a.classList.add("ui-body-b"),a.classList.add("background-theme-b");var n="";n+='<div class="dialogHeader">',n+='<paper-icon-button icon="arrow-back" class="btnCancel" tabindex="-1"></paper-icon-button>',n+='<div class="dialogHeaderTitle">',n+=t.Name,n+="</div>",n+="</div>",n+='<div class="editorContent">',n+=Globalize.translateDocument(i),n+="</div>",a.innerHTML=n,document.body.appendChild(a),a.querySelector(".pathLabel").innerHTML=Globalize.translate("MediaInfoFile"),$(".subtitleSearchForm",a).off("submit",u).on("submit",u),e.open(a);var o=a.querySelector(".editorContent");d(o,t),ApiClient.getCultures().then(function(e){r(o,e)}),$(".btnCancel",a).on("click",function(){e.close(a)})})},i.send()}var c;return{show:p}});