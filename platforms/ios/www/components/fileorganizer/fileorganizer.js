define(["dialogHelper","paper-checkbox","paper-input","paper-button","paper-icon-button-light"],function(e){function r(e){Dashboard.hideLoadingMsg(),require(["alert"],function(r){r({title:Globalize.translate("AutoOrganizeError"),text:Globalize.translate("ErrorOrganizingFileWithErrorCode",e.headers.get("X-Application-Error-Code"))})})}function t(e,t){!t.ExtractedName||t.ExtractedName.length<3?e.querySelector(".fldRemember").classList.add("hide"):e.querySelector(".fldRemember").classList.remove("hide"),e.querySelector(".inputFile").innerHTML=t.OriginalFileName,e.querySelector("#txtSeason").value=t.ExtractedSeasonNumber,e.querySelector("#txtEpisode").value=t.ExtractedEpisodeNumber,e.querySelector("#txtEndingEpisode").value=t.ExtractedEndingEpisodeNumber,l=t.ExtractedName,a=t.ExtractedYear,e.querySelector("#chkRememberCorrection").checked=!1,e.querySelector("#hfResultId").value=t.Id,ApiClient.getItems(null,{recursive:!0,includeItemTypes:"Series",sortBy:"SortName"}).then(function(t){u=t.Items.map(function(e){return'<option value="'+e.Id+'">'+e.Name+"</option>"}).join(""),u='<option value=""></option>'+u,e.querySelector("#selectSeries").innerHTML=u,ApiClient.getVirtualFolders().then(function(r){for(var t=[],i=0;i<r.length;i++)for(var o=r[i],n=0,l=o.Locations.length;l>n;n++){var a={value:o.Locations[n],display:o.Name+": "+o.Locations[n]};"tvshows"==o.CollectionType&&t.push(a)}c=t.length;var s=t.map(function(e){return'<option value="'+e.value+'">'+e.display+"</option>"}).join("");t.length>1&&(s='<option value=""></option>'+s),e.querySelector("#selectSeriesFolder").innerHTML=s},r)},r)}function i(t){Dashboard.showLoadingMsg();var i,o,n,l,a=t.querySelector("#hfResultId").value,u=t.querySelector("#selectSeries").value;"##NEW##"==u&&null!=s&&(u=null,o=JSON.stringify(s.ProviderIds),n=s.Name,l=s.ProductionYear,i=t.querySelector("#selectSeriesFolder").value);var c={SeriesId:u,SeasonNumber:t.querySelector("#txtSeason").value,EpisodeNumber:t.querySelector("#txtEpisode").value,EndingEpisodeNumber:t.querySelector("#txtEndingEpisode").value,RememberCorrection:t.querySelector("#chkRememberCorrection").checked,NewSeriesProviderIds:o,NewSeriesName:n,NewSeriesYear:l,TargetFolder:i};ApiClient.performEpisodeOrganization(a,c).then(function(){Dashboard.hideLoadingMsg(),t.submitted=!0,e.close(t)},r)}function o(e){return 0==c?void require(["alert"],function(e){e({title:Globalize.translate("AutoOrganizeError"),text:Globalize.translate("NoTvFoldersConfigured")})}):void require(["components/itemidentifier/itemidentifier"],function(r){r.showFindNew(l,a,"Series").then(function(r){if(null!=r){s=r;var t=u;t=t+'<option selected value="##NEW##">'+s.Name+"</option>",e.querySelector("#selectSeries").innerHTML=t,n(e)}})})}function n(e){var r=e.querySelector("#selectSeries").value;"##NEW##"==r?(e.querySelector(".fldSelectSeriesFolder").classList.remove("hide"),e.querySelector("#selectSeriesFolder").setAttribute("required","required")):(e.querySelector(".fldSelectSeriesFolder").classList.add("hide"),e.querySelector("#selectSeriesFolder").removeAttribute("required"))}var l,a,s,u,c=0;return{show:function(r){return new Promise(function(c,d){l=null,a=null,s=null,u=null;var S=new XMLHttpRequest;S.open("GET","components/fileorganizer/fileorganizer.template.html",!0),S.onload=function(){var l=this.response,a=e.createDialog({removeOnClose:!0,size:"small"});a.classList.add("ui-body-a"),a.classList.add("background-theme-a"),a.classList.add("formDialog");var s="";s+=Globalize.translateDocument(l),a.innerHTML=s,document.body.appendChild(a),a.querySelector(".dialogHeaderTitle").innerHTML=Globalize.translate("FileOrganizeManually"),e.open(a),a.addEventListener("close",function(){a.submitted?c():d()}),a.querySelector(".btnCancel").addEventListener("click",function(){e.close(a)}),a.querySelector("form").addEventListener("submit",function(e){return i(a),e.preventDefault(),!1}),a.querySelector("#btnNewSeries").addEventListener("click",function(){o(a)}),a.querySelector("#selectSeries").addEventListener("change",function(){n(a)}),t(a,r)},S.send()})}}});