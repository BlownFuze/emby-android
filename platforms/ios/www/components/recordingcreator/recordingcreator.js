define(["dialogHelper","jQuery","scripts/livetvcomponents","livetvcss","paper-checkbox","paper-input","paper-toggle-button"],function(e,n){function i(){return LiveTvHelpers.getDaysOfWeek().map(function(e){return e.value})}function t(e){for(var t=i(),r=[],o=0,s=t.length;s>o;o++){var a=t[o];n("#chk"+a,e).checked()&&r.push(a)}return r}function r(e){l(e.querySelector("#seriesFields")),e.querySelector(".btnSubmitContainer").classList.remove("hide"),e.querySelector(".supporterContainer").classList.add("hide")}function o(n){S=n,e.close(b)}function s(){Dashboard.showLoadingMsg();var e=this;return ApiClient.getNamedConfiguration("livetv").then(function(i){i.EnableRecordingEncoding=n("#chkConvertRecordings",e).checked(),ApiClient.updateNamedConfiguration("livetv",i).then(Dashboard.processServerConfigurationUpdateResult)}),ApiClient.getNewLiveTvTimerDefaults({programId:v}).then(function(i){i.PrePaddingSeconds=60*n("#txtPrePaddingMinutes",e).val(),i.PostPaddingSeconds=60*n("#txtPostPaddingMinutes",e).val(),i.RecordNewOnly=n("#chkNewOnly",e).checked(),i.RecordAnyChannel=n("#chkAllChannels",e).checked(),i.RecordAnyTime=n("#chkAnyTime",e).checked(),i.Days=t(e),n("#chkRecordSeries",e).checked()?ApiClient.createLiveTvSeriesTimer(i).then(function(){Dashboard.hideLoadingMsg(),o(!0)}):ApiClient.createLiveTvTimer(i).then(function(){Dashboard.hideLoadingMsg(),o(!0)})}),!1}function a(e){return Dashboard.showLoadingMsg(),ApiClient.getJSON(ApiClient.getUrl("LiveTv/Registration",{ProgramId:e,Feature:"seriesrecordings"})).then(function(e){return Dashboard.hideLoadingMsg(),e},function(){return Dashboard.hideLoadingMsg(),{TrialVersion:!0,IsValid:!0,IsRegistered:!1}})}function c(e){d(e.querySelector("#seriesFields")),e.querySelector(".btnSubmitContainer").classList.remove("hide"),a(v).then(function(n){n.IsValid?e.querySelector(".btnSubmitContainer").classList.remove("hide"):e.querySelector(".btnSubmitContainer").classList.add("hide"),n.IsRegistered?e.querySelector(".supporterContainer").classList.add("hide"):(e.querySelector(".supporterContainer").classList.remove("hide"),n.TrialVersion?e.querySelector(".supporterTrial").classList.remove("hide"):e.querySelector(".supporterTrial").classList.add("hide"))})}function d(e){e.classList.contains("hide")&&(e.classList.remove("hide"),e.style.overflow="hidden",requestAnimationFrame(function(){e.animate([{height:0},{height:e.offsetHeight+"px"}],{duration:400,easing:"ease"}).onfinish=function(){e.classList.remove("hide")}}))}function l(e){e.classList.contains("hide")||(e.style.overflow="hidden",requestAnimationFrame(function(){e.animate([{height:e.offsetHeight+"px"},{height:0}],{duration:400,easing:"ease"}).onfinish=function(){e.classList.add("hide")}}))}function h(e){n("#chkRecordSeries",e).on("change",function(){this.checked?c(e):r(e)}),n(".btnCancel",e).on("click",function(){o(!1)}),e.querySelector(".chkAdvanced").addEventListener("change",function(n){for(var i=e.querySelectorAll(".advancedToggle"),t=n.target.checked,r=0,o=i.length;o>r;r++)t?d(i[r]):l(i[r])}),n("form",e).off("submit",s).on("submit",s);for(var i=e.querySelectorAll(".btnSupporter"),t=0,a=i.length;a>t;t++)AppInfo.enableSupporterMembership?i[t].classList.remove("hide"):i[t].classList.add("hide");e.querySelector(".btnSupporterForConverting a").href=AppInfo.enableSupporterMembership?"https://emby.media/premiere":"#",ApiClient.getNamedConfiguration("livetv").then(function(i){n("#chkConvertRecordings",e).checked(i.EnableRecordingEncoding)})}function u(e,t){for(var r=i(),o=0,s=r.length;s>o;o++){var a=r[o];n("#chk"+a,e).checked(-1!=t.indexOf(a))}}function g(e,i,t){n(".itemName",e).html(t.Name),n(".itemEpisodeName",e).html(t.EpisodeTitle||""),n(".itemMiscInfo",e).html(LibraryBrowser.getMiscInfoHtml(t)),n(".itemMiscInfo a").each(function(){n(this).replaceWith(this.innerHTML)}),n("#chkNewOnly",e).checked(i.RecordNewOnly),n("#chkAllChannels",e).checked(i.RecordAnyChannel),n("#chkAnyTime",e).checked(i.RecordAnyTime),n("#txtPrePaddingMinutes",e).val(i.PrePaddingSeconds/60),n("#txtPostPaddingMinutes",e).val(i.PostPaddingSeconds/60),t.IsSeries?n("#eligibleForSeriesFields",e).show():n("#eligibleForSeriesFields",e).hide(),u(e,i.Days),"Emby"==t.ServiceName?(e.querySelector(".convertRecordingsContainer").classList.remove("hide"),p(e)):e.querySelector(".convertRecordingsContainer").classList.add("hide"),Dashboard.hideLoadingMsg()}function p(e){Dashboard.getPluginSecurityInfo().then(function(n){n.IsMBSupporter?e.querySelector(".btnSupporterForConverting").classList.add("hide"):e.querySelector(".btnSupporterForConverting").classList.remove("hide")},function(){e.querySelector(".btnSupporterForConverting").classList.remove("hide")})}function f(e,n){Dashboard.showLoadingMsg();var i=ApiClient.getNewLiveTvTimerDefaults({programId:n}),t=ApiClient.getLiveTvProgram(n,Dashboard.getCurrentUserId());Promise.all([i,t]).then(function(n){var i=n[0],t=n[1];g(e,i,t)})}function m(n){return new Promise(function(i,t){S=!1,v=n,Dashboard.showLoadingMsg();var o=new XMLHttpRequest;o.open("GET","components/recordingcreator/recordingcreator.template.html",!0),o.onload=function(){var o=this.response,s=e.createDialog({removeOnClose:!0,size:"small"});s.classList.add("ui-body-b"),s.classList.add("background-theme-b"),s.classList.add("formDialog");var a="";a+=Globalize.translateDocument(o),s.innerHTML=a,document.body.appendChild(s),e.open(s),b=s,s.addEventListener("close",function(){S?(require(["toast"],function(e){e(Globalize.translate("MessageRecordingScheduled"))}),i()):t()}),r(s),h(s),f(s,n)},o.send()})}var v,b,S=!1;return{show:m}});