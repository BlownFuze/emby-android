define(["components/paperdialoghelper","paper-dialog","paper-fab"],function(e){function a(e){switch(Dashboard.hideLoadingMsg(),e.target.error.code){case e.target.error.NOT_FOUND_ERR:Dashboard.alert(Globalize.translate("MessageFileNotFound"));break;case e.target.error.ABORT_ERR:break;default:Dashboard.alert(Globalize.translate("MessageFileReadError"))}}function r(e,r){var o=r[0];if(!o||!o.type.match("image.*"))return $("#imageOutput",e).html(""),$("#fldUpload",e).hide(),void(s=null);s=o;var t=new FileReader;t.onerror=a,t.onloadstart=function(){$("#fldUpload",e).hide()},t.onabort=function(){Dashboard.hideLoadingMsg(),Logger.log("File read cancelled")},t.onload=function(a){return function(r){var o=['<img style="max-width:300px;max-height:100px;" src="',r.target.result,'" title="',escape(a.name),'"/>'].join("");$("#imageOutput",e).html(o),$("#fldUpload",e).show()}}(o),t.readAsDataURL(o)}function o(){p=!0,history.back()}function t(){var e=s;if(!e)return!1;if("image/png"!=e.type&&"image/jpeg"!=e.type&&"image/jpeg"!=e.type)return!1;Dashboard.showLoadingMsg();var a=$(this).parents("paper-dialog"),r=$("#selectImageType",a).val();return ApiClient.uploadItemImage(d,r,e).then(function(){$("#uploadImage",a).val("").trigger("change"),Dashboard.hideLoadingMsg(),o(a)}),!1}function n(e){$("form",e).off("submit",t).on("submit",t),$("#uploadImage",e).on("change",function(){r(e,this.files)}),$("#imageDropZone",e).on("dragover",function(e){return e.preventDefault(),e.originalEvent.dataTransfer.dropEffect="Copy",!1}).on("drop",function(a){return a.preventDefault(),r(e,a.originalEvent.dataTransfer.files),!1})}function i(a,r){r=r||{};var o=new XMLHttpRequest;o.open("GET","components/imageuploader/imageuploader.template.html",!0),o.onload=function(){var o=this.response;d=a;var t=e.createDialog({theme:r.theme}),i="";i+='<h2 class="dialogHeader">',i+='<paper-fab icon="arrow-back" mini class="btnCloseDialog"></paper-fab>',i+='<div style="display:inline-block;margin-left:.6em;vertical-align:middle;">'+Globalize.translate("HeaderUploadImage")+"</div>",i+="</h2>",i+='<div class="editorContent">',i+=Globalize.translateDocument(o),i+="</div>",t.innerHTML=i,document.body.appendChild(t),$(t).on("iron-overlay-closed",l),e.open(t);var s=t.querySelector(".editorContent");n(s),$(".btnCloseDialog",t).on("click",function(){e.close(t)})},o.send()}function l(){$(this).remove(),Dashboard.hideLoadingMsg(),g.resolveWith(null,[p])}var d,s,g,p=!1;return{show:function(e,a){var r=DeferredBuilder.Deferred();return g=r,p=!1,i(e,a),r.promise()}}});