define(["paperdialoghelper","jQuery"],function(e,n){function o(){return f?Promise.resolve(f):new Promise(function(e,n){var o="grammar",a=new XMLHttpRequest;a.open("GET","voice/grammar/"+o+".json",!0),a.onload=function(){f=JSON.parse(this.response),e(f)},a.onerror=n,a.send()})}function a(e){for(var n,o,a=e.length;0!==a;)o=Math.floor(Math.random()*a),a-=1,n=e[a],e[a]=e[o],e[o]=n;return e}function i(e){return o().then(function(n){e="undefined"!=typeof e?e:"";var o=[];return n.map(function(n){n.items&&n.items.length>0&&(e==n.groupid||""==e)&&n.items.map(function(e){e.commandtemplates&&e.commandtemplates.length>0&&e.commandtemplates.map(function(e){o.push(e)})})}),a(o)})}function t(e){if(f){var n=-1;return n=f.map(function(e){return e.groupid}).indexOf(e),n>-1?f[n]:null}return null}function c(e,o){o.length=Math.min(o.length,4),o=o.map(function(e){return'<div class="exampleCommand"><span class="exampleCommandText">"'+e+'"</span></div>'}).join(""),n(".exampleCommands",e).html(o)}function r(o){var a=e.createDialog({size:"medium",removeOnClose:!0});a.classList.add("ui-body-b"),a.classList.add("background-theme-b");var r="";if(r+='<h2 class="dialogHeader">',r+='<paper-fab icon="arrow-back" mini class="btnCancelVoiceInput"></paper-fab>',o){var s=t(o);s&&(r+="  "+s.name)}r+="</h2>",r+="<div>";var l=i(o);r+='<div class="voiceHelpContent">',r+='<div class="defaultVoiceHelp">',r+='<h1 style="margin-bottom:1.25em;">'+Globalize.translate("HeaderSaySomethingLike")+"</h1>",r+='<div class="exampleCommands">',r+="</div>",r+="</div>",r+='<div class="unrecognizedCommand" style="display:none;">',r+="<h1>"+Globalize.translate("HeaderYouSaid")+"</h1>",r+='<p class="exampleCommand voiceInputContainer"><i class="fa fa-quote-left"></i><span class="voiceInputText exampleCommandText"></span><i class="fa fa-quote-right"></i></p>',r+="<p>"+Globalize.translate("MessageWeDidntRecognizeCommand")+"</p>",r+="<br/>",r+='<paper-button raised class="submit block btnRetry"><iron-icon icon="mic"></iron-icon><span>'+Globalize.translate("ButtonTryAgain")+"</span></paper-button>",r+='<p class="blockedMessage" style="display:none;">'+Globalize.translate("MessageIfYouBlockedVoice")+"<br/><br/></p>",r+="</div>",r+='<paper-button raised class="block btnCancelVoiceInput" style="background-color:#444;"><iron-icon icon="close"></iron-icon><span>'+Globalize.translate("ButtonCancel")+"</span></paper-button>",r+="</div>",r+="</div>",a.innerHTML=r,document.body.appendChild(a),e.open(a),v=a,a.addEventListener("iron-overlay-closed",function(){v=null}),n(".btnCancelVoiceInput",a).on("click",function(){d(),e.close(a)}),n(".btnRetry",a).on("click",function(){n(".unrecognizedCommand").hide(),n(".defaultVoiceHelp").show(),u(!1)}),l.then(function(e){c(a.querySelector(".voiceHelpContent"),e)})}function s(){n(".unrecognizedCommand").show(),n(".defaultVoiceHelp").hide()}function l(o,a){n(".voiceInputText").html(o),o||AppInfo.isNativeApp?n(".blockedMessage").hide():n(".blockedMessage").show(),o?require(["voice/voicecommands.js","voice/grammarprocessor.js"],function(n,a){var i=a(f,o);i&&i.command?n(i).then(function(e){if("show"===e.item.actionid&&"group"===e.item.sourceid){var n=v;n?p(!1,e):p(!0,e)}}).catch(s):s();var t=v;t&&e.close(t)}):a||s()}function u(e){d();var n=new(window.SpeechRecognition||window.webkitSpeechRecognition||window.mozSpeechRecognition||window.oSpeechRecognition||window.msSpeechRecognition);n.lang=h;n.onresult=function(e){e.results.length>0&&l(e.results[0][0].transcript||"")},n.onerror=function(){l("",n.cancelled)},n.onnomatch=function(){l("",n.cancelled)},n.start(),m=n,p(e)}function d(){var e=m;e&&(e.abort(),m=null)}function p(e,n){e!==!1&&require(["paper-fab","css!voice/voice.css"],function(){n?r(n.groupid,n.name):r()})}var m,f,v,h="en-US";return{startListening:u}});