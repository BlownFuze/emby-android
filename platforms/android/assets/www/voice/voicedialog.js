define(["paperdialoghelper","jQuery"],function(e,n){function o(){return f?Promise.resolve(f):new Promise(function(e,n){var o="grammar",a=new XMLHttpRequest;a.open("GET","voice/grammar/"+o+".json",!0),a.onload=function(){f=JSON.parse(this.response),e(f)},a.onerror=n,a.send()})}function a(e){for(var n,o,a=e.length;0!==a;)o=Math.floor(Math.random()*a),a-=1,n=e[a],e[a]=e[o],e[o]=n;return e}function i(e){return o().then(function(n){e="undefined"!=typeof e?e:"";var o=[];return n.map(function(n){n.items&&n.items.length>0&&(e==n.groupid||""==e)&&n.items.map(function(e){e.commandtemplates&&e.commandtemplates.length>0&&e.commandtemplates.map(function(e){o.push(e)})})}),a(o)})}function t(e){if(f){var n=-1;return n=f.map(function(e){return e.groupid}).indexOf(e),n>-1?f[n]:null}return null}function c(e,o){o.length=Math.min(o.length,4),o=o.map(function(e){return'<div class="exampleCommand"><span class="exampleCommandText">"'+e+'"</span></div>'}).join(""),n(".exampleCommands",e).html(o)}function s(o){var a=e.createDialog({size:"medium",removeOnClose:!0});a.classList.add("ui-body-b"),a.classList.add("background-theme-b");var s="";if(s+='<h2 class="dialogHeader">',s+='<paper-fab icon="arrow-back" mini class="btnCancelVoiceInput"></paper-fab>',o){var r=t(o);r&&(s+="  "+r.name)}s+="</h2>",s+="<div>";var l=i(o);s+='<div class="voiceHelpContent">',s+='<div class="defaultVoiceHelp">',s+='<h1 style="margin-bottom:1.25em;">'+Globalize.translate("HeaderSaySomethingLike")+"</h1>",s+='<div class="exampleCommands">',s+="</div>",s+="</div>",s+='<div class="unrecognizedCommand" style="display:none;">',s+="<h1>"+Globalize.translate("HeaderYouSaid")+"</h1>",s+='<p class="exampleCommand voiceInputContainer"><i class="fa fa-quote-left"></i><span class="voiceInputText exampleCommandText"></span><i class="fa fa-quote-right"></i></p>',s+="<p>"+Globalize.translate("MessageWeDidntRecognizeCommand")+"</p>",s+="<br/>",s+='<paper-button raised class="submit block btnRetry"><iron-icon icon="mic"></iron-icon><span>'+Globalize.translate("ButtonTryAgain")+"</span></paper-button>",s+='<p class="blockedMessage" style="display:none;">'+Globalize.translate("MessageIfYouBlockedVoice")+"<br/><br/></p>",s+="</div>",s+='<paper-button raised class="block btnCancelVoiceInput" style="background-color:#444;"><iron-icon icon="close"></iron-icon><span>'+Globalize.translate("ButtonCancel")+"</span></paper-button>",s+="</div>",s+="</div>",a.innerHTML=s,document.body.appendChild(a),e.open(a),h=a,a.addEventListener("close",function(){h=null}),n(".btnCancelVoiceInput",a).on("click",function(){d(),e.close(a)}),n(".btnRetry",a).on("click",function(){n(".unrecognizedCommand").hide(),n(".defaultVoiceHelp").show(),u(!1)}),l.then(function(e){c(a.querySelector(".voiceHelpContent"),e)})}function r(){n(".unrecognizedCommand").show(),n(".defaultVoiceHelp").hide()}function l(o,a){n(".voiceInputText").html(o),o||AppInfo.isNativeApp?n(".blockedMessage").hide():n(".blockedMessage").show(),o?require(["voice/voicecommands.js","voice/grammarprocessor.js"],function(n,a){var i=a(f,o);i&&i.command?n(i).then(function(e){if("show"===e.item.actionid&&"group"===e.item.sourceid){var n=h;n?p(!1,e):p(!0,e)}}).catch(r):r();var t=h;t&&e.close(t)}):a||r()}function u(e){d();var n=new(window.SpeechRecognition||window.webkitSpeechRecognition||window.mozSpeechRecognition||window.oSpeechRecognition||window.msSpeechRecognition);n.lang=v;n.onresult=function(e){e.results.length>0&&l(e.results[0][0].transcript||"")},n.onerror=function(){l("",n.cancelled)},n.onnomatch=function(){l("",n.cancelled)},n.start(),m=n,p(e)}function d(){var e=m;e&&(e.abort(),m=null)}function p(e,n){e!==!1&&require(["paper-fab","css!voice/voice.css"],function(){n?s(n.groupid,n.name):s()})}var m,f,h,v="en-US";return{startListening:u}});