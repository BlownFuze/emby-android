!function(){function e(){function e(){return M?new Promise(function(e){e(M)}):ApiClient.getJSON(ApiClient.getUrl("System/Endpoint")).then(function(e){return M=e,e})}function n(n){var o=AppSettings.maxChromecastBitrate();n=$.extend(n,{userId:Dashboard.getCurrentUserId(),deviceId:ApiClient.deviceId(),accessToken:ApiClient.accessToken(),serverAddress:ApiClient.serverAddress(),maxBitrate:o,receiverName:I.getFriendlyName(),supportsAc3:AppSettings.enableChromecastAc3()}),Logger.log("Sending command to Chromecast: "+n.command),e().then(function(e){e.IsInNetwork?ApiClient.getPublicSystemInfo().then(function(e){n.serverAddress=e.LocalAddress,t(n)}):t(n)})}function t(e){C.sendText(JSON.stringify(e))}function o(){var e={};return e.playerName=L,e.playableMediaTypes=["Audio","Video"],e.isLocalPlayer=!1,e.appName=L,e.supportedCommands=["VolumeUp","VolumeDown","Mute","Unmute","ToggleMute","SetVolume","SetAudioStreamIndex","SetSubtitleStreamIndex","DisplayContent","SetRepeatMode","EndSession"],e}function a(e){var n=o();return n.name=n.deviceName=e.getFriendlyName(),n.id=e.getId(),n}function r(e){e=(e||"").toLowerCase();var n=[];return n.push("chromecast"),n.push("nexusplayer"),n.filter(function(n){return-1!=e.replace(" ","").indexOf(n)}).length>0}function i(){return ConnectSDKHelper.getDeviceList().filter(function(e){return e.hasService(ConnectSDK.Services.Chromecast)||r(e.getModelName())||r(e.getFriendlyName())})}function s(){var e=P.lastPlayerData||{};return e=e.PlayState||{},null==e.VolumeLevel?100:e.VolumeLevel}function c(e){if("playbackerror"==e.type){var n=e.data;setTimeout(function(){Dashboard.alert({message:Globalize.translate("MessagePlaybackError"+n),title:Globalize.translate("HeaderPlaybackError")})},300)}else"connectionerror"==e.type?setTimeout(function(){Dashboard.alert({message:Globalize.translate("MessageChromecastConnectionError"),title:Globalize.translate("HeaderError")})},300):e.type&&0==e.type.indexOf("playback")&&Events.trigger(W,e.type,[e.data])}function l(e){c("string"==typeof e?JSON.parse(e):e)}function u(){Logger.log("session disconnected")}function d(e,n){C=e,Logger.log("session.connect succeeded"),e.setWebAppSessionListener(),I=n,A=n.getId(),P.lastPlayerData={},MediaController.setActivePlayer(L,a(n)),m()}function g(e,n,t){var o=n.acquire();o.on("message",l),o.on("disconnect",u),t||browserInfo.safari?o.connect().success(function(){d(o,e)}).error(p):d(o,e)}function m(){n({options:{},command:"Identify"})}function p(){Logger.log("chromecast session connect error"),f()}function f(){var e=C;e&&(e.off("message"),e.off("disconnect"),e.disconnect(),e.release()),P.lastPlayerData={},C=null}function y(e){Logger.log("calling launchWebApp"),e.getWebAppLauncher().launchWebApp(D).success(function(n){Logger.log("launchWebApp success. calling onSessionConnected"),g(e,n,!0)}).error(function(e){Logger.log("launchWebApp error:"+JSON.stringify(e))})}function v(e,n,t){Logger.log("calling joinWebApp"),e.getWebAppLauncher().joinWebApp(D).success(function(n){Logger.log("joinWebApp success. calling onSessionConnected"),g(e,n,!1)}).error(function(o){return Logger.log("joinWebApp error: "+JSON.stringify(o)),n?void v(e,!1,!0):void(t&&(Logger.log("calling launchWebApp"),y(e)))})}function h(e){C&&f(),v(e,!1,!0)}function S(e){e.off("ready"),Logger.log("creating webAppSession"),P.lastPlayerData={},h(e)}function b(){var e=A;e&&P.tryPair({id:e})}var C,I,A,P=this,L="Chromecast",D="2D4B1DA3";P.name=L,P.getItemsForPlayback=function(e){var n=Dashboard.getCurrentUserId();return e.Ids&&1==e.Ids.split(",").length?new Promise(function(t){ApiClient.getItem(n,e.Ids.split(",")).then(function(e){t({Items:[e],TotalRecordCount:1})})}):(e.Limit=e.Limit||100,e.ExcludeLocationTypes="Virtual",ApiClient.getItems(n,e))};var W={};Events.on(W,"playbackstart",function(e,n){Logger.log("cc: playbackstart");var t=P.getPlayerStateInternal(n);Events.trigger(P,"playbackstart",[t])}),Events.on(W,"playbackstop",function(e,n){Logger.log("cc: playbackstop");var t=P.getPlayerStateInternal(n);Events.trigger(P,"playbackstop",[t]),P.lastPlayerData={}}),Events.on(W,"playbackprogress",function(e,n){Logger.log("cc: positionchange");var t=P.getPlayerStateInternal(n);Events.trigger(P,"positionchange",[t])});var M;P.play=function(e){Dashboard.getCurrentUser().then(function(){e.items?P.playWithCommand(e,"PlayNow"):P.getItemsForPlayback({Ids:e.ids.join(",")}).then(function(n){e.items=n.Items,P.playWithCommand(e,"PlayNow")})})},P.playWithCommand=function(e,t){return e.items?(e.items=e.items.map(function(e){return{Id:e.Id,Name:e.Name,Type:e.Type,MediaType:e.MediaType,IsFolder:e.IsFolder}}),void n({options:e,command:t})):void ApiClient.getItem(Dashboard.getCurrentUserId(),e.ids[0]).then(function(n){e.items=[n],P.playWithCommand(e,t)})},P.unpause=function(){n({command:"Unpause"})},P.pause=function(){n({command:"Pause"})},P.shuffle=function(e){var n=Dashboard.getCurrentUserId();ApiClient.getItem(n,e).then(function(e){P.playWithCommand({items:[e]},"Shuffle")})},P.instantMix=function(e){var n=Dashboard.getCurrentUserId();ApiClient.getItem(n,e).then(function(e){P.playWithCommand({items:[e]},"InstantMix")})},P.canQueueMediaType=function(e){return"Audio"==e},P.queue=function(e){P.playWithCommnd(e,"PlayLast")},P.queueNext=function(e){P.playWithCommand(e,"PlayNext")},P.stop=function(){n({command:"Stop"})},P.displayContent=function(e){n({options:e,command:"DisplayContent"})},P.mute=function(){n({command:"Mute"})},P.unMute=function(){P.setVolume(s()+2)},P.toggleMute=function(){var e=P.lastPlayerData||{};e=e.PlayState||{},e.IsMuted?P.unMute():P.mute()},P.getTargets=function(){return i().map(a)},P.seek=function(e){e=parseInt(e),e/=1e7,n({options:{position:e},command:"Seek"})},P.setAudioStreamIndex=function(e){n({options:{index:e},command:"SetAudioStreamIndex"})},P.setSubtitleStreamIndex=function(e){n({options:{index:e},command:"SetSubtitleStreamIndex"})},P.nextTrack=function(){n({options:{},command:"NextTrack"})},P.previousTrack=function(){n({options:{},command:"PreviousTrack"})},P.beginPlayerUpdates=function(){},P.endPlayerUpdates=function(){},P.volumeDown=function(){n({options:{},command:"VolumeDown"})},P.setRepeatMode=function(e){n({options:{RepeatMode:e},command:"SetRepeatMode"})},P.volumeUp=function(){n({options:{},command:"VolumeUp"})},P.setVolume=function(e){e=Math.min(e,100),e=Math.max(e,0),n({options:{volume:e},command:"SetVolume"})},P.getPlayerState=function(){return new Promise(function(e){var n=P.getPlayerStateInternal();e(n)})},P.lastPlayerData={},P.getPlayerStateInternal=function(e){return e=e||P.lastPlayerData,P.lastPlayerData=e,Logger.log(JSON.stringify(e)),e},P.tryPair=function(e){return new Promise(function(n,t){var o=i().filter(function(n){return n.getId()==e.id})[0];o?P.tryPairWithDevice(o,n,t):t()})},P.tryPairWithDevice=function(e){Logger.log("Will attempt to connect to Chromecast"),e.on("disconnect",function(){e.off("ready"),e.off("disconnect")}),e.isReady()?(Logger.log("Device is already ready, calling onDeviceReady"),S(e)):(Logger.log("Binding device ready handler"),e.on("ready",function(){Logger.log("device.ready fired"),S(e)}),Logger.log("Calling device.connect"),e.connect())},P.endSession=function(){Logger.log("Ending Chromecast session"),P.stop(),setTimeout(function(){var e=C;e&&e.close();var n=I;n&&(n.getWebAppLauncher().closeWebApp(D),n.disconnect()),f(),I=null,A=null},1e3)},document.addEventListener("resume",b,!1)}MediaController.registerPlayer(new e)}();