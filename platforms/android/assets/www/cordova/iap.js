!function(){function e(e){return"embypremieremonthly"==e?"emby.subscription.monthly":"appunlock"}function r(e){l=l.filter(function(r){return r.id!=e.id}),l.push(e),Events.trigger(IapManager,"productupdated",[e])}function t(r){var t=e(r),n=l.filter(function(e){return e.id==t});return n.length?n[0]:null}function n(r,t){t&&(p=t),m={};var n=e(r);store.order(n)}function o(){m={},store.refresh()}function i(e,r){var t=e.id;if(-1!=(t||"").toLowerCase().indexOf("appunlock"))return void r(!0,e);var n=t+(e.transaction.id||""),o=m[n];if(o&&(new Date).getTime()-o.date<6e4)return void(o.result?r(!0,e):r(!1,{code:o.errorCode,error:{message:o.errorMessage}}));var i,a=e.transaction.appStoreReceipt,u=e.price,c={store:"Apple",application:"com.emby.mobile",product:t,type:"Subscription",storeToken:a,amt:u};p?(c.email=p,c.storeId=p,c.feature="MBSClubMonthly",i=ApiClient.ajax({type:"POST",url:ApiClient.getUrl("Appstore/Register"),data:{Parameters:JSON.stringify(c)}})):i=fetch("http://mb3admin.com/admin/service/appstore/register",{method:"POST",body:JSON.stringify(c),headers:{"X-Emby-Token":"EMBY-APPLE-VALIDATE","Content-Type":"application/json"}}),i.then(function(){s(n,!0),r(!0,e)},function(e){402==e.status?(s(n,!1,store.PURCHASE_EXPIRED,"Subscription Expired"),r(!1,{code:store.PURCHASE_EXPIRED,error:{message:"Subscription Expired"}})):(m={},r(!1,{code:store.CONNECTION_FAILED,error:{message:"Connection Failure"}}))})}function s(e,r,t,n){m[e]={date:(new Date).getTime(),result:r,errorCode:t,errorMessage:n}}function a(e,t,n){store.register({id:e,alias:e,type:n}),store.when(e).approved(function(e){t?e.verify():e.finish()}),t&&store.when(e).verified(function(e){r(e),e.finish()}),store.when(e).updated(function(e){e.loaded&&e.valid&&e.state==store.APPROVED&&(Logger.log("finishing previously created transaction"),t?e.owned:e.finish()),r(e)})}function u(){store.verbosity=store.INFO,store.validator=i,a(e(""),!1,store.NON_CONSUMABLE),a(e("embypremieremonthly"),!0,store.PAID_SUBSCRIPTION),store.ready(function(){Logger.log("Store ready")}),store.refresh()}function c(){return new Promise(function(r){var n=[];n.push({feature:"embypremieremonthly",buttonText:"EmbyPremiereMonthlyWithPrice"}),n=n.filter(function(e){return null!=t(e.feature)}).map(function(r){return r.id=e(r.feature),r.buttonText=Globalize.translate(r.buttonText,t(r.feature).price),r.owned=t(r.feature).owned,r}),r(n)})}function d(){return new Promise(function(e){e(!1)})}function f(){return!0}var p,l=[],m={};window.IapManager={getProductInfo:t,beginPurchase:n,restorePurchase:o,getSubscriptionOptions:c,isUnlockedOverride:d,enableRestore:f},u()}();