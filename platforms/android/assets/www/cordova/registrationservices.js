define(["appSettings","loading","emby-button"],function(e,t){function a(e){return ConnectionManager.getRegistrationInfo(e,ApiClient)}function n(t){var n="featurepurchased-"+t;if("1"==e.get(n))return Promise.resolve();var r=IapManager.getProductInfo(t);if(r){var i="productpurchased-"+r.id;if(r.owned)return e.set(n,"1"),e.set(i,"1"),Promise.resolve();if("1"==e.get(i))return Promise.resolve()}var o=r?{enableAppUnlock:!0,id:r.id,price:r.price,feature:t}:null,l=browserInfo.android?"android":"ios";return IapManager.isUnlockedOverride(t).then(function(e){return e?Promise.resolve():IapManager.getSubscriptionOptions().then(function(e){return e.filter(function(e){return e.owned}).length>0?Promise.resolve():a(l+"appunlock").catch(function(){var a={title:Globalize.translate("HeaderUnlockApp"),enablePlayMinute:"playback"==t,feature:t};return d(e,o,a)})})})}function r(e){var t=document.querySelector(".inAppPurchaseOverlay");t&&e.close(t)}function i(){v=[],g=null}function o(e,a,n,o,d,b){function p(){var t=function(){e.close(f),b()};"playback"==o.feature?Dashboard.alert({message:Globalize.translate("ThankYouForTryingEnjoyOneMinute"),title:Globalize.translate("HeaderTryPlayback"),callback:t}):t()}r(),v=a.slice(0),n&&v.push(n);var f=e.createDialog({size:"fullscreen-border",removeOnClose:!0});f.classList.add("ui-body-b"),f.classList.add("background-theme-b");var m="";m+='<h2 class="dialogHeader">',m+='<paper-fab icon="arrow-back" mini class="btnCloseDialog" tabindex=-1""></paper-fab>',m+='<div style="display:inline-block;margin-left:.6em;vertical-align:middle;">'+o.title+"</div>",m+="</h2>",m+='<div class="editorContent">',m+='<form style="max-width: 800px;margin:auto;">',m+='<p style="margin:2em 0;">',m+=Globalize.translate(n?"MessageUnlockAppWithPurchaseOrSupporter":"MessageUnlockAppWithSupporter"),m+="</p>",m+='<p style="margin:2em 0;">',m+=Globalize.translate("MessageToValidateSupporter"),m+="</p>";for(var y=!1,g=0,h=a.length;h>g;g++)y=!0,m+="<p>",m+='<button is="emby-button" type="button" class="raised submit block btnPurchase" data-email="true" data-feature="'+a[g].feature+'"><iron-icon icon="check"></iron-icon><span>',m+=a[g].buttonText,m+="</span></button>",m+="</p>";if(n){y=!0;var k=Globalize.translate("ButtonUnlockWithPurchase");n.price&&(k=Globalize.translate("ButtonUnlockPrice",n.price)),m+="<p>",m+='<button is="emby-button" type="button" class="raised secondary block btnPurchase" data-feature="'+n.feature+'"><iron-icon icon="check"></iron-icon><span>'+k+"</span></button>",m+="</p>"}y&&IapManager.enableRestore(o.feature,a,n)&&(m+="<p>",m+=browserInfo.safari?'<button is="emby-button" type="button" class="raised secondary block btnRestorePurchase subdued"><iron-icon icon="check"></iron-icon><span>'+Globalize.translate("ButtonRestorePreviousPurchase")+"</span></button>":'<button is="emby-button" type="button" class="raised secondary block btnRestorePurchase subdued"><span>'+Globalize.translate("AlreadyPaid")+"</span></button>",m+="</p>"),a.length&&(m+="<br/>",m+="<h1>"+Globalize.translate("HeaderBenefitsEmbyPremiere")+"</h1>",m+='<div class="paperList" style="margin-bottom:1em;">',m+=l().map(s).join(""),m+="</div>"),o.enablePlayMinute&&(m+="<p>",m+='<button is="emby-button" type="button" class="raised secondary block btnCloseDialog subdued"><iron-icon icon="play-arrow"></iron-icon><span>'+Globalize.translate("ButtonPlayOneMinute")+"</span></button>",m+="</p>"),m+="</form>",m+="</div>",f.innerHTML=m,document.body.appendChild(f);for(var P=f.querySelectorAll(".btnPurchase"),g=0,h=P.length;h>g;g++)P[g].addEventListener("click",c);var z=f.querySelector(".btnRestorePurchase");z&&z.addEventListener("click",function(){u()}),t.hide();for(var G=f.querySelectorAll(".btnCloseDialog"),g=0,h=G.length;h>g;g++)G[g].addEventListener("click",p);f.addEventListener("close",function(){i(),window.TabBar&&TabBar.show()}),f.classList.add("inAppPurchaseOverlay"),e.open(f)}function l(){var e=[];return e.push({name:Globalize.translate("CoverArt"),icon:"photo",text:Globalize.translate("CoverArtFeatureDescription")}),e.push({name:Globalize.translate("HeaderFreeApps"),icon:"check",text:Globalize.translate("FreeAppsFeatureDescription")}),e.push(Dashboard.capabilities().SupportsSync?{name:Globalize.translate("HeaderMobileSync"),icon:"sync",text:Globalize.translate("MobileSyncFeatureDescription")}:AppInfo.isNativeApp?{name:Globalize.translate("HeaderCloudSync"),icon:"sync",text:Globalize.translate("CloudSyncFeatureDescription")}:{name:Globalize.translate("HeaderCinemaMode"),icon:"movie",text:Globalize.translate("CinemaModeFeatureDescription")}),e}function s(e){var t=!browserInfo.safari,a="";return a+="<paper-icon-item>",a+='<paper-fab mini style="background-color:#52B54B;" icon="'+e.icon+'" item-icon></paper-fab>',a+="<paper-item-body three-line>",t&&(a+='<a class="clearLink" href="https://emby.media/premiere" target="_blank">'),a+="<div>",a+=e.name,a+="</div>",a+='<div secondary style="white-space:normal;">',a+=e.text,a+="</div>",t&&(a+="</a>"),a+="</paper-item-body>",a+="</paper-icon-item>"}function c(){"true"==this.getAttribute("data-email")?b(this.getAttribute("data-feature")):IapManager.beginPurchase(this.getAttribute("data-feature"))}function u(){require(["dialogHelper"],function(e){var a=e.createDialog({size:"fullscreen-border",removeOnClose:!0});a.classList.add("ui-body-b"),a.classList.add("background-theme-b");var n="";n+='<h2 class="dialogHeader">',n+='<paper-fab icon="arrow-back" mini class="btnCloseDialog" tabindex=-1""></paper-fab>',n+='<div style="display:inline-block;margin-left:.6em;vertical-align:middle;">'+Globalize.translate("ButtonRestorePreviousPurchase")+"</div>",n+="</h2>",n+='<div class="editorContent">',n+='<p style="margin:2em 0;">',n+=Globalize.translate("HowDidYouPay"),n+="</p>",n+="<p>",n+='<button is="emby-button" type="button" class="raised secondary block btnRestoreSub subdued"><span>'+Globalize.translate("IHaveEmbyPremiere")+"</span></button>",n+="</p>",n+="<p>",n+='<button is="emby-button" type="button" class="raised secondary block btnRestoreUnlock subdued"><span>'+Globalize.translate("IPurchasedThisApp")+"</span></button>",n+="</p>",n+="</div>",a.innerHTML=n,document.body.appendChild(a),t.hide(),e.open(a),a.querySelector(".btnCloseDialog").addEventListener("click",function(){e.close(a)}),a.querySelector(".btnRestoreSub").addEventListener("click",function(){e.close(a),Dashboard.alert({message:Globalize.translate("MessageToValidateSupporter"),title:Globalize.translate("TabEmbyPremiere")})}),a.querySelector(".btnRestoreUnlock").addEventListener("click",function(){e.close(a),IapManager.restorePurchase()})})}function d(e,t,a){return new Promise(function(n,r){require(["dialogHelper","paper-fab","paper-icon-item","paper-item-body"],function(i){window.TabBar&&TabBar.hide(),o(i,e,t,a,n,r),g=n})})}function b(e){if(ConnectionManager.isLoggedIntoConnect()){var t=ConnectionManager.connectUser();if(t&&t.Email)return void IapManager.beginPurchase(e,t.Email)}p(e)}function p(e){require(["prompt"],function(t){t({label:Globalize.translate("TextPleaseEnterYourEmailAddressForSubscription")}).then(function(t){t&&IapManager.beginPurchase(e,t)})})}function f(e,t){if(t.owned){var a=g;a&&v.filter(function(e){return t.id==e.id}).length&&require(["dialogHelper"],function(e){r(e),a()})}}function m(){return a("Sync").catch(function(){return IapManager.getSubscriptionOptions().then(function(e){var t={title:Globalize.translate("HeaderUnlockSync"),feature:"sync"};return d(e,null,t)})})}function y(){Events.on(IapManager,"productupdated",f)}var v=[],g=null;return window.RegistrationServices={renderPluginInfo:function(){},validateFeature:function(e){return"playback"==e?n(e):"livetv"==e?n(e):"sync"==e?m():Promise.resolve()}},browserInfo.android?requirejs(["cordova/android/iap"],y):requirejs(["cordova/iap"],y),window.RegistrationServices});