define(["appSettings","emby-button"],function(e){function t(e){return ConnectionManager.getRegistrationInfo(e,ApiClient)}function a(a){var n="featurepurchased-"+a;if("1"==e.get(n))return Promise.resolve();var r=IapManager.getProductInfo(a);if(r){var i="productpurchased-"+r.id;if(r.owned)return e.set(n,"1"),e.set(i,"1"),Promise.resolve();if("1"==e.get(i))return Promise.resolve()}var o=r?{enableAppUnlock:!0,id:r.id,price:r.price,feature:a}:null,l=browserInfo.android?"android":"ios";return IapManager.isUnlockedOverride(a).then(function(e){return e?Promise.resolve():IapManager.getSubscriptionOptions().then(function(e){return e.filter(function(e){return e.owned}).length>0?Promise.resolve():t(l+"appunlock").catch(function(){var t={title:Globalize.translate("HeaderUnlockApp"),enablePlayMinute:"playback"==a,feature:a};return b(e,o,t)})})})}function n(){var e=document.querySelector(".inAppPurchaseOverlay");e&&require(["dialogHelper"],function(t){t.close(e)})}function r(){g=[],h=null,k=null}function i(e,t,a,r,i,s){n(),g=t.slice(0),a&&g.push(a);var u=e.createDialog({size:"fullscreen-border"});u.classList.add("ui-body-b"),u.classList.add("background-theme-b");var b="";b+='<h2 class="dialogHeader">',b+='<paper-fab icon="arrow-back" mini class="btnCloseDialog" tabindex=-1""></paper-fab>',b+='<div style="display:inline-block;margin-left:.6em;vertical-align:middle;">'+r.title+"</div>",b+="</h2>",b+='<div class="editorContent">',b+='<form style="max-width: 800px;margin:auto;">',b+='<p style="margin:2em 0;">',b+=Globalize.translate(a?"MessageUnlockAppWithPurchaseOrSupporter":"MessageUnlockAppWithSupporter"),b+="</p>",b+='<p style="margin:2em 0;">',b+=Globalize.translate("MessageToValidateSupporter"),b+="</p>";for(var d=!1,p=0,f=t.length;f>p;p++)d=!0,b+="<p>",b+='<button is="emby-button" type="button" class="raised submit block btnPurchase" data-email="true" data-feature="'+t[p].feature+'"><iron-icon icon="check"></iron-icon><span>',b+=t[p].buttonText,b+="</span></button>",b+="</p>";if(a){d=!0;var m=Globalize.translate("ButtonUnlockWithPurchase");a.price&&(m=Globalize.translate("ButtonUnlockPrice",a.price)),b+="<p>",b+='<button is="emby-button" type="button" class="raised secondary block btnPurchase" data-feature="'+a.feature+'"><iron-icon icon="check"></iron-icon><span>'+m+"</span></button>",b+="</p>"}d&&IapManager.enableRestore(r.feature,t,a)&&(b+="<p>",b+=browserInfo.safari?'<button is="emby-button" type="button" class="raised secondary block btnRestorePurchase subdued"><iron-icon icon="check"></iron-icon><span>'+Globalize.translate("ButtonRestorePreviousPurchase")+"</span></button>":'<button is="emby-button" type="button" class="raised secondary block btnRestorePurchase subdued"><span>'+Globalize.translate("AlreadyPaid")+"</span></button>",b+="</p>"),t.length&&(b+="<br/>",b+="<h1>"+Globalize.translate("HeaderBenefitsEmbyPremiere")+"</h1>",b+='<div class="paperList" style="margin-bottom:1em;">',b+=o().map(l).join(""),b+="</div>"),r.enablePlayMinute&&(b+="<p>",b+='<button is="emby-button" type="button" class="raised secondary block btnCloseDialog subdued"><iron-icon icon="play-arrow"></iron-icon><span>'+Globalize.translate("ButtonPlayOneMinute")+"</span></button>",b+="</p>"),b+="</form>",b+="</div>",u.innerHTML=b,document.body.appendChild(u),c(u,r.feature,i,s),e.open(u);for(var y=elem.querySelectorAll(".btnCloseDialog"),p=0,f=btnPurchases.length;f>p;p++)y[p].addEventListener("click",function(){e.close(u)});u.addEventListener("close",function(){window.TabBar&&TabBar.show()}),u.classList.add("inAppPurchaseOverlay")}function o(){var e=[];return e.push({name:Globalize.translate("CoverArt"),icon:"photo",text:Globalize.translate("CoverArtFeatureDescription")}),e.push({name:Globalize.translate("HeaderFreeApps"),icon:"check",text:Globalize.translate("FreeAppsFeatureDescription")}),e.push(Dashboard.capabilities().SupportsSync?{name:Globalize.translate("HeaderMobileSync"),icon:"sync",text:Globalize.translate("MobileSyncFeatureDescription")}:AppInfo.isNativeApp?{name:Globalize.translate("HeaderCloudSync"),icon:"sync",text:Globalize.translate("CloudSyncFeatureDescription")}:{name:Globalize.translate("HeaderCinemaMode"),icon:"movie",text:Globalize.translate("CinemaModeFeatureDescription")}),e}function l(e){var t=!browserInfo.safari,a="";return a+="<paper-icon-item>",a+='<paper-fab mini style="background-color:#52B54B;" icon="'+e.icon+'" item-icon></paper-fab>',a+="<paper-item-body three-line>",t&&(a+='<a class="clearLink" href="https://emby.media/premiere" target="_blank">'),a+="<div>",a+=e.name,a+="</div>",a+='<div secondary style="white-space:normal;">',a+=e.text,a+="</div>",t&&(a+="</a>"),a+="</paper-item-body>",a+="</paper-icon-item>"}function s(){v=!1,"true"==this.getAttribute("data-email")?d(this.getAttribute("data-feature")):IapManager.beginPurchase(this.getAttribute("data-feature"))}function c(e,t,a,n){v=!0;for(var i=e.querySelectorAll(".btnPurchase"),o=0,l=i.length;l>o;o++)i[o].addEventListener("click",s);var c=e.querySelector(".btnRestorePurchase");c&&c.addEventListener("click",function(){v=!1,u()}),e.addEventListener("close",function(){r();v&&("playback"==t?Dashboard.alert({message:Globalize.translate("ThankYouForTryingEnjoyOneMinute"),title:Globalize.translate("HeaderTryPlayback"),callback:function(){n()}}):n())})}function u(){require(["dialogHelper"],function(e){var t=e.createDialog({size:"fullscreen-border",removeOnClose:!0});t.classList.add("ui-body-b"),t.classList.add("background-theme-b");var a="";a+='<h2 class="dialogHeader">',a+='<paper-fab icon="arrow-back" mini class="btnCloseDialog" tabindex=-1""></paper-fab>',a+='<div style="display:inline-block;margin-left:.6em;vertical-align:middle;">'+Globalize.translate("ButtonRestorePreviousPurchase")+"</div>",a+="</h2>",a+='<div class="editorContent">',a+='<p style="margin:2em 0;">',a+=Globalize.translate("HowDidYouPay"),a+="</p>",a+="<p>",a+='<button is="emby-button" type="button" class="raised secondary block btnRestoreSub subdued"><span>'+Globalize.translate("IHaveEmbyPremiere")+"</span></button>",a+="</p>",a+="<p>",a+='<button is="emby-button" type="button" class="raised secondary block btnRestoreUnlock subdued"><span>'+Globalize.translate("IPurchasedThisApp")+"</span></button>",a+="</p>",a+="</div>",t.innerHTML=a,document.body.appendChild(t),e.open(t),t.querySelector(".btnCloseDialog").addEventListener("click",function(){e.close(t)}),t.querySelector(".btnRestoreSub").addEventListener("click",function(){e.close(t),Dashboard.alert({message:Globalize.translate("MessageToValidateSupporter"),title:Globalize.translate("TabEmbyPremiere")})}),t.querySelector(".btnRestoreUnlock").addEventListener("click",function(){e.close(t),IapManager.restorePurchase()})})}function b(e,t,a){return new Promise(function(n,r){require(["dialogHelper","paper-fab","paper-icon-item","paper-item-body"],function(o){window.TabBar&&TabBar.hide(),i(o,e,t,a,n,r),h=n,k=r})})}function d(e){if(ConnectionManager.isLoggedIntoConnect()){var t=ConnectionManager.connectUser();if(t&&t.Email)return void IapManager.beginPurchase(e,t.Email)}p(e)}function p(e){require(["prompt"],function(t){t({label:Globalize.translate("TextPleaseEnterYourEmailAddressForSubscription")}).then(function(t){t&&IapManager.beginPurchase(e,t)})})}function f(e,t){if(t.owned){var a=h;a&&g.filter(function(e){return t.id==e.id}).length&&(v=!1,n(),a())}}function m(){return t("Sync").catch(function(){return IapManager.getSubscriptionOptions().then(function(e){var t={title:Globalize.translate("HeaderUnlockSync"),feature:"sync"};return b(e,null,t)})})}function y(){Events.on(IapManager,"productupdated",f)}var v=!0,g=[],h=null,k=null;return window.RegistrationServices={renderPluginInfo:function(){},validateFeature:function(e){return"playback"==e?a(e):"livetv"==e?a(e):"sync"==e?m():Promise.resolve()}},browserInfo.android?requirejs(["cordova/android/iap"],y):requirejs(["cordova/iap"],y),window.RegistrationServices});