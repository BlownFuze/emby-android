define(["appSettings","loading","emby-button"],function(e,t){function n(e){return ConnectionManager.getRegistrationInfo(e,ApiClient)}function a(t){var a="featurepurchased-"+t;if("1"==e.get(a))return Promise.resolve();var r=IapManager.getProductInfo(t);if(r){var i="productpurchased-"+r.id;if(r.owned)return e.set(a,"1"),e.set(i,"1"),Promise.resolve();if("1"==e.get(i))return Promise.resolve()}var o=r?{enableAppUnlock:!0,id:r.id,price:r.price,feature:t}:null,s=browserInfo.android?"android":"ios";return IapManager.isUnlockedOverride(t).then(function(e){return e?Promise.resolve():IapManager.getSubscriptionOptions().then(function(e){return e.filter(function(e){return e.owned}).length>0?Promise.resolve():n(s+"appunlock").catch(function(){var n={title:Globalize.translate("HeaderUnlockApp"),enablePlayMinute:"playback"==t,feature:t};return d(e,o,n)})})})}function r(e){var t=document.querySelector(".inAppPurchaseOverlay");t&&e.close(t)}function i(){g=[],h=null}function o(e,n,a,o,d,b){function p(){var t=function(){e.close(f),b()};"playback"==o.feature?Dashboard.alert({message:Globalize.translate("ThankYouForTryingEnjoyOneMinute"),title:Globalize.translate("HeaderTryPlayback"),callback:t}):t()}r(),g=n.slice(0),a&&g.push(a);var f=e.createDialog({size:"fullscreen-border",removeOnClose:!0});f.classList.add("ui-body-b"),f.classList.add("background-theme-b");var m="";m+='<h2 class="dialogHeader">',m+='<button is="paper-icon-button-light" class="btnCloseDialog autoSize" tabindex="-1"><i class="md-icon">&#xE5C4;</i></button>',m+='<div style="display:inline-block;margin-left:.6em;vertical-align:middle;">'+o.title+"</div>",m+="</h2>",m+='<div class="editorContent">',m+='<form style="max-width: 800px;margin:auto;">',m+='<p style="margin:2em 0;">',m+=Globalize.translate(a?"MessageUnlockAppWithPurchaseOrSupporter":"MessageUnlockAppWithSupporter"),m+="</p>",m+='<p style="margin:2em 0;">',m+=Globalize.translate("MessageToValidateSupporter"),m+="</p>";for(var y=!1,v=0,h=n.length;h>v;v++)y=!0,m+="<p>",m+='<button is="emby-button" type="button" class="raised submit block btnPurchase" data-email="true" data-feature="'+n[v].feature+'"><iron-icon icon="check"></iron-icon><span>',m+=n[v].buttonText,m+="</span></button>",m+="</p>";if(a){y=!0;var P=Globalize.translate("ButtonUnlockWithPurchase");a.price&&(P=Globalize.translate("ButtonUnlockPrice",a.price)),m+="<p>",m+='<button is="emby-button" type="button" class="raised secondary block btnPurchase" data-feature="'+a.feature+'"><iron-icon icon="check"></iron-icon><span>'+P+"</span></button>",m+="</p>"}y&&IapManager.enableRestore(o.feature,n,a)&&(m+="<p>",m+=browserInfo.safari?'<button is="emby-button" type="button" class="raised secondary block btnRestorePurchase subdued"><iron-icon icon="check"></iron-icon><span>'+Globalize.translate("ButtonRestorePreviousPurchase")+"</span></button>":'<button is="emby-button" type="button" class="raised secondary block btnRestorePurchase subdued"><span>'+Globalize.translate("AlreadyPaid")+"</span></button>",m+="</p>"),n.length&&(m+="<br/>",m+="<h1>"+Globalize.translate("HeaderBenefitsEmbyPremiere")+"</h1>",m+='<div class="paperList" style="margin-bottom:1em;">',m+=s().map(l).join(""),m+="</div>"),o.enablePlayMinute&&(m+="<p>",m+='<button is="emby-button" type="button" class="raised secondary block btnCloseDialog subdued"><iron-icon icon="play-arrow"></iron-icon><span>'+Globalize.translate("ButtonPlayOneMinute")+"</span></button>",m+="</p>"),m+="</form>",m+="</div>",f.innerHTML=m,document.body.appendChild(f);for(var k=f.querySelectorAll(".btnPurchase"),v=0,h=k.length;h>v;v++)k[v].addEventListener("click",c);var z=f.querySelector(".btnRestorePurchase");z&&z.addEventListener("click",function(){u()}),t.hide();for(var S=f.querySelectorAll(".btnCloseDialog"),v=0,h=S.length;h>v;v++)S[v].addEventListener("click",p);f.addEventListener("close",function(){i(),window.TabBar&&TabBar.show()}),f.classList.add("inAppPurchaseOverlay"),e.open(f)}function s(){var e=[];return e.push({name:Globalize.translate("CoverArt"),icon:"photo",text:Globalize.translate("CoverArtFeatureDescription")}),e.push({name:Globalize.translate("HeaderFreeApps"),icon:"check",text:Globalize.translate("FreeAppsFeatureDescription")}),e.push(Dashboard.capabilities().SupportsSync?{name:Globalize.translate("HeaderMobileSync"),icon:"sync",text:Globalize.translate("MobileSyncFeatureDescription")}:AppInfo.isNativeApp?{name:Globalize.translate("HeaderCloudSync"),icon:"sync",text:Globalize.translate("CloudSyncFeatureDescription")}:{name:Globalize.translate("HeaderCinemaMode"),icon:"movie",text:Globalize.translate("CinemaModeFeatureDescription")}),e}function l(e){var t=!browserInfo.safari,n="";return n+='<div class="listItem">',n+='<i class="listItemIcon md-icon">'+e.icon+"</i>",n+='<div class="listItemBody three-line">',t&&(n+='<a class="clearLink" href="https://emby.media/premiere" target="_blank">'),n+='<div class="listItemBodyText">',n+=e.name,n+="</div>",n+='<div class="listItemBodyText secondary" style="white-space:normal;">',n+=e.text,n+="</div>",t&&(n+="</a>"),n+="</div>",n+="</div>"}function c(){"true"==this.getAttribute("data-email")?b(this.getAttribute("data-feature")):IapManager.beginPurchase(this.getAttribute("data-feature"))}function u(){require(["dialogHelper"],function(e){var n=e.createDialog({size:"fullscreen-border",removeOnClose:!0});n.classList.add("ui-body-b"),n.classList.add("background-theme-b");var a="";a+='<h2 class="dialogHeader">',a+='<button is="paper-icon-button-light" class="btnCloseDialog autoSize" tabindex="-1"><i class="md-icon">&#xE5C4;</i></button>',a+='<div style="display:inline-block;margin-left:.6em;vertical-align:middle;">'+Globalize.translate("ButtonRestorePreviousPurchase")+"</div>",a+="</h2>",a+='<div class="editorContent">',a+='<p style="margin:2em 0;">',a+=Globalize.translate("HowDidYouPay"),a+="</p>",a+="<p>",a+='<button is="emby-button" type="button" class="raised secondary block btnRestoreSub subdued"><span>'+Globalize.translate("IHaveEmbyPremiere")+"</span></button>",a+="</p>",a+="<p>",a+='<button is="emby-button" type="button" class="raised secondary block btnRestoreUnlock subdued"><span>'+Globalize.translate("IPurchasedThisApp")+"</span></button>",a+="</p>",a+="</div>",n.innerHTML=a,document.body.appendChild(n),t.hide(),e.open(n),n.querySelector(".btnCloseDialog").addEventListener("click",function(){e.close(n)}),n.querySelector(".btnRestoreSub").addEventListener("click",function(){e.close(n),Dashboard.alert({message:Globalize.translate("MessageToValidateSupporter"),title:Globalize.translate("TabEmbyPremiere")})}),n.querySelector(".btnRestoreUnlock").addEventListener("click",function(){e.close(n),IapManager.restorePurchase()})})}function d(e,t,n){return new Promise(function(a,r){require(["dialogHelper","listViewStyle"],function(i){window.TabBar&&TabBar.hide(),o(i,e,t,n,a,r),h=a})})}function b(e){if(ConnectionManager.isLoggedIntoConnect()){var t=ConnectionManager.connectUser();if(t&&t.Email)return void IapManager.beginPurchase(e,t.Email)}p(e)}function p(e){require(["prompt"],function(t){t({label:Globalize.translate("TextPleaseEnterYourEmailAddressForSubscription")}).then(function(t){t&&IapManager.beginPurchase(e,t)})})}function f(e,t){if(t.owned){var n=h;n&&g.filter(function(e){return t.id==e.id}).length&&require(["dialogHelper"],function(e){r(e),n()})}}function m(){return n("Sync").catch(function(){return IapManager.getSubscriptionOptions().then(function(e){var t={title:Globalize.translate("HeaderUnlockSync"),feature:"sync"};return d(e,null,t)})})}function y(){return IapManager.getSubscriptionOptions().then(function(e){var t={title:"Emby Premiere",feature:"sync"};return d(e,null,t)})}function v(){Events.on(IapManager,"productupdated",f)}var g=[],h=null;return window.RegistrationServices={renderPluginInfo:function(){},validateFeature:function(e){return"playback"==e?a(e):"livetv"==e?a(e):"sync"==e?m():Promise.resolve()},showPremiereInfo:y},browserInfo.android?requirejs(["cordova/android/iap"],v):requirejs(["cordova/iap"],v),window.RegistrationServices});