define(["appSettings"],function(e){function a(e){return ConnectionManager.getRegistrationInfo(e,ApiClient)}function n(n){var t="featurepurchased-"+n;if("1"==e.get(t))return Promise.resolve();var r=IapManager.getProductInfo(n);if(r){var i="productpurchased-"+r.id;if(r.owned)return e.set(t,"1"),e.set(i,"1"),Promise.resolve();if("1"==e.get(i))return Promise.resolve()}var o=r?{enableAppUnlock:!0,id:r.id,price:r.price,feature:n}:null,l=browserInfo.android?"android":"ios";return IapManager.isUnlockedOverride(n).then(function(e){return e?Promise.resolve():IapManager.getSubscriptionOptions().then(function(e){return e.filter(function(e){return e.owned}).length>0?Promise.resolve():a(l+"appunlock").catch(function(){var a={title:Globalize.translate("HeaderUnlockApp"),enablePlayMinute:"playback"==n,feature:n};return p(e,o,a)})})})}function t(){var e=document.querySelector(".inAppPurchaseOverlay");e&&require(["dialogHelper"],function(a){a.close(e)})}function r(){h=[],y=null,k=null}function i(e,a,n,r,i,s){t(),h=a.slice(0),n&&h.push(n);var u=e.createDialog({size:"fullscreen-border"});u.classList.add("ui-body-b"),u.classList.add("background-theme-b");var p="";p+='<h2 class="dialogHeader">',p+='<paper-fab icon="arrow-back" mini class="btnCloseDialog" tabindex=-1""></paper-fab>',p+='<div style="display:inline-block;margin-left:.6em;vertical-align:middle;">'+r.title+"</div>",p+="</h2>",p+='<div class="editorContent">',p+='<form style="max-width: 800px;margin:auto;">',p+='<p style="margin:2em 0;">',p+=Globalize.translate(n?"MessageUnlockAppWithPurchaseOrSupporter":"MessageUnlockAppWithSupporter"),p+="</p>",p+='<p style="margin:2em 0;">',p+=Globalize.translate("MessageToValidateSupporter"),p+="</p>";for(var d=!1,b=0,f=a.length;f>b;b++)d=!0,p+="<p>",p+='<paper-button raised class="submit block btnPurchase" data-email="true" data-feature="'+a[b].feature+'"><iron-icon icon="check"></iron-icon><span>',p+=a[b].buttonText,p+="</span></paper-button>",p+="</p>";if(n){d=!0;var m=Globalize.translate("ButtonUnlockWithPurchase");n.price&&(m=Globalize.translate("ButtonUnlockPrice",n.price)),p+="<p>",p+='<paper-button raised class="secondary block btnPurchase" data-feature="'+n.feature+'"><iron-icon icon="check"></iron-icon><span>'+m+"</span></paper-button>",p+="</p>"}d&&IapManager.enableRestore(r.feature,a,n)&&(p+="<p>",p+=browserInfo.safari?'<paper-button raised class="secondary block btnRestorePurchase subdued"><iron-icon icon="check"></iron-icon><span>'+Globalize.translate("ButtonRestorePreviousPurchase")+"</span></paper-button>":'<paper-button raised class="secondary block btnRestorePurchase subdued"><span>'+Globalize.translate("AlreadyPaid")+"</span></paper-button>",p+="</p>"),a.length&&(p+="<br/>",p+="<h1>"+Globalize.translate("HeaderBenefitsEmbyPremiere")+"</h1>",p+='<div class="paperList" style="margin-bottom:1em;">',p+=o().map(l).join(""),p+="</div>"),r.enablePlayMinute&&(p+="<p>",p+='<paper-button raised class="secondary block btnCloseDialog subdued"><iron-icon icon="play-arrow"></iron-icon><span>'+Globalize.translate("ButtonPlayOneMinute")+"</span></paper-button>",p+="</p>"),p+="</form>",p+="</div>",u.innerHTML=p,document.body.appendChild(u),c(u,r.feature,i,s),e.open(u);for(var v=elem.querySelectorAll(".btnCloseDialog"),b=0,f=btnPurchases.length;f>b;b++)v[b].addEventListener("click",function(){e.close(u)});u.addEventListener("close",function(){window.TabBar&&TabBar.show()}),u.classList.add("inAppPurchaseOverlay")}function o(){var e=[];return e.push({name:Globalize.translate("CoverArt"),icon:"photo",text:Globalize.translate("CoverArtFeatureDescription")}),e.push({name:Globalize.translate("HeaderFreeApps"),icon:"check",text:Globalize.translate("FreeAppsFeatureDescription")}),e.push(Dashboard.capabilities().SupportsSync?{name:Globalize.translate("HeaderMobileSync"),icon:"sync",text:Globalize.translate("MobileSyncFeatureDescription")}:AppInfo.isNativeApp?{name:Globalize.translate("HeaderCloudSync"),icon:"sync",text:Globalize.translate("CloudSyncFeatureDescription")}:{name:Globalize.translate("HeaderCinemaMode"),icon:"movie",text:Globalize.translate("CinemaModeFeatureDescription")}),e}function l(e){var a=!browserInfo.safari,n="";return n+="<paper-icon-item>",n+='<paper-fab mini style="background-color:#52B54B;" icon="'+e.icon+'" item-icon></paper-fab>',n+="<paper-item-body three-line>",a&&(n+='<a class="clearLink" href="https://emby.media/premiere" target="_blank">'),n+="<div>",n+=e.name,n+="</div>",n+='<div secondary style="white-space:normal;">',n+=e.text,n+="</div>",a&&(n+="</a>"),n+="</paper-item-body>",n+="</paper-icon-item>"}function s(){g=!1,"true"==this.getAttribute("data-email")?d(this.getAttribute("data-feature")):IapManager.beginPurchase(this.getAttribute("data-feature"))}function c(e,a,n,t){g=!0;for(var i=e.querySelectorAll(".btnPurchase"),o=0,l=i.length;l>o;o++)i[o].addEventListener("click",s);var c=e.querySelector(".btnRestorePurchase");c&&c.addEventListener("click",function(){g=!1,u()}),e.addEventListener("close",function(){r();g&&("playback"==a?Dashboard.alert({message:Globalize.translate("ThankYouForTryingEnjoyOneMinute"),title:Globalize.translate("HeaderTryPlayback"),callback:function(){t()}}):t())})}function u(){require(["dialogHelper"],function(e){var a=e.createDialog({size:"fullscreen-border",removeOnClose:!0});a.classList.add("ui-body-b"),a.classList.add("background-theme-b");var n="";n+='<h2 class="dialogHeader">',n+='<paper-fab icon="arrow-back" mini class="btnCloseDialog" tabindex=-1""></paper-fab>',n+='<div style="display:inline-block;margin-left:.6em;vertical-align:middle;">'+Globalize.translate("ButtonRestorePreviousPurchase")+"</div>",n+="</h2>",n+='<div class="editorContent">',n+='<p style="margin:2em 0;">',n+=Globalize.translate("HowDidYouPay"),n+="</p>",n+="<p>",n+='<paper-button raised class="secondary block btnRestoreSub subdued"><span>'+Globalize.translate("IHaveEmbyPremiere")+"</span></paper-button>",n+="</p>",n+="<p>",n+='<paper-button raised class="secondary block btnRestoreUnlock subdued"><span>'+Globalize.translate("IPurchasedThisApp")+"</span></paper-button>",n+="</p>",n+="</div>",a.innerHTML=n,document.body.appendChild(a),e.open(a),a.querySelector(".btnCloseDialog").addEventListener("click",function(){e.close(a)}),a.querySelector(".btnRestoreSub").addEventListener("click",function(){e.close(a),Dashboard.alert({message:Globalize.translate("MessageToValidateSupporter"),title:Globalize.translate("TabEmbyPremiere")})}),a.querySelector(".btnRestoreUnlock").addEventListener("click",function(){e.close(a),IapManager.restorePurchase()})})}function p(e,a,n){return new Promise(function(t,r){require(["dialogHelper","paper-fab","paper-icon-item","paper-item-body"],function(o){window.TabBar&&TabBar.hide(),i(o,e,a,n,t,r),y=t,k=r})})}function d(e){if(ConnectionManager.isLoggedIntoConnect()){var a=ConnectionManager.connectUser();if(a&&a.Email)return void IapManager.beginPurchase(e,a.Email)}b(e)}function b(e){require(["prompt"],function(a){a({label:Globalize.translate("TextPleaseEnterYourEmailAddressForSubscription")}).then(function(a){a&&IapManager.beginPurchase(e,a)})})}function f(e,a){if(a.owned){var n=y;n&&h.filter(function(e){return a.id==e.id}).length&&(g=!1,t(),n())}}function m(){return a("Sync").catch(function(){return IapManager.getSubscriptionOptions().then(function(e){var a={title:Globalize.translate("HeaderUnlockSync"),feature:"sync"};return p(e,null,a)})})}function v(){Events.on(IapManager,"productupdated",f)}var g=!0,h=[],y=null,k=null;return window.RegistrationServices={renderPluginInfo:function(){},validateFeature:function(e){return"playback"==e?n(e):"livetv"==e?n(e):"sync"==e?m():Promise.resolve()}},browserInfo.android?requirejs(["cordova/android/iap"],v):requirejs(["cordova/iap"],v),window.RegistrationServices});