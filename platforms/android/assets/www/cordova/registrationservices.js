define(["appSettings","loading","emby-button"],function(e,t){function a(e){return ConnectionManager.getRegistrationInfo(e,ApiClient)}function n(t){var n="featurepurchased-"+t;if("1"==e.get(n))return Promise.resolve();var r=IapManager.getProductInfo(t);if(r){var i="productpurchased-"+r.id;if(r.owned)return e.set(n,"1"),e.set(i,"1"),Promise.resolve();if("1"==e.get(i))return Promise.resolve()}var o=r?{enableAppUnlock:!0,id:r.id,price:r.price,feature:t}:null,l=browserInfo.android?"android":"ios";return IapManager.isUnlockedOverride(t).then(function(e){return e?Promise.resolve():IapManager.getSubscriptionOptions().then(function(e){return e.filter(function(e){return e.owned}).length>0?Promise.resolve():a(l+"appunlock").catch(function(){var a={title:Globalize.translate("HeaderUnlockApp"),enablePlayMinute:"playback"==t,feature:t};return b(e,o,a)})})})}function r(){var e=document.querySelector(".inAppPurchaseOverlay");e&&require(["dialogHelper"],function(t){t.close(e)})}function i(){h=[],k=null}function o(e,a,n,i,o,c){function d(){e.close(b)}r(),h=a.slice(0),n&&h.push(n);var b=e.createDialog({size:"fullscreen-border"});b.classList.add("ui-body-b"),b.classList.add("background-theme-b");var p="";p+='<h2 class="dialogHeader">',p+='<paper-fab icon="arrow-back" mini class="btnCloseDialog" tabindex=-1""></paper-fab>',p+='<div style="display:inline-block;margin-left:.6em;vertical-align:middle;">'+i.title+"</div>",p+="</h2>",p+='<div class="editorContent">',p+='<form style="max-width: 800px;margin:auto;">',p+='<p style="margin:2em 0;">',p+=Globalize.translate(n?"MessageUnlockAppWithPurchaseOrSupporter":"MessageUnlockAppWithSupporter"),p+="</p>",p+='<p style="margin:2em 0;">',p+=Globalize.translate("MessageToValidateSupporter"),p+="</p>";for(var f=!1,m=0,y=a.length;y>m;m++)f=!0,p+="<p>",p+='<button is="emby-button" type="button" class="raised submit block btnPurchase" data-email="true" data-feature="'+a[m].feature+'"><iron-icon icon="check"></iron-icon><span>',p+=a[m].buttonText,p+="</span></button>",p+="</p>";if(n){f=!0;var g=Globalize.translate("ButtonUnlockWithPurchase");n.price&&(g=Globalize.translate("ButtonUnlockPrice",n.price)),p+="<p>",p+='<button is="emby-button" type="button" class="raised secondary block btnPurchase" data-feature="'+n.feature+'"><iron-icon icon="check"></iron-icon><span>'+g+"</span></button>",p+="</p>"}f&&IapManager.enableRestore(i.feature,a,n)&&(p+="<p>",p+=browserInfo.safari?'<button is="emby-button" type="button" class="raised secondary block btnRestorePurchase subdued"><iron-icon icon="check"></iron-icon><span>'+Globalize.translate("ButtonRestorePreviousPurchase")+"</span></button>":'<button is="emby-button" type="button" class="raised secondary block btnRestorePurchase subdued"><span>'+Globalize.translate("AlreadyPaid")+"</span></button>",p+="</p>"),a.length&&(p+="<br/>",p+="<h1>"+Globalize.translate("HeaderBenefitsEmbyPremiere")+"</h1>",p+='<div class="paperList" style="margin-bottom:1em;">',p+=l().map(s).join(""),p+="</div>"),i.enablePlayMinute&&(p+="<p>",p+='<button is="emby-button" type="button" class="raised secondary block btnCloseDialog subdued"><iron-icon icon="play-arrow"></iron-icon><span>'+Globalize.translate("ButtonPlayOneMinute")+"</span></button>",p+="</p>"),p+="</form>",p+="</div>",b.innerHTML=p,document.body.appendChild(b),u(b,i.feature,o,c),t.hide(),e.open(b);for(var v=b.querySelectorAll(".btnCloseDialog"),m=0,y=v.length;y>m;m++)v[m].addEventListener("click",d);b.addEventListener("close",function(){window.TabBar&&TabBar.show()}),b.classList.add("inAppPurchaseOverlay")}function l(){var e=[];return e.push({name:Globalize.translate("CoverArt"),icon:"photo",text:Globalize.translate("CoverArtFeatureDescription")}),e.push({name:Globalize.translate("HeaderFreeApps"),icon:"check",text:Globalize.translate("FreeAppsFeatureDescription")}),e.push(Dashboard.capabilities().SupportsSync?{name:Globalize.translate("HeaderMobileSync"),icon:"sync",text:Globalize.translate("MobileSyncFeatureDescription")}:AppInfo.isNativeApp?{name:Globalize.translate("HeaderCloudSync"),icon:"sync",text:Globalize.translate("CloudSyncFeatureDescription")}:{name:Globalize.translate("HeaderCinemaMode"),icon:"movie",text:Globalize.translate("CinemaModeFeatureDescription")}),e}function s(e){var t=!browserInfo.safari,a="";return a+="<paper-icon-item>",a+='<paper-fab mini style="background-color:#52B54B;" icon="'+e.icon+'" item-icon></paper-fab>',a+="<paper-item-body three-line>",t&&(a+='<a class="clearLink" href="https://emby.media/premiere" target="_blank">'),a+="<div>",a+=e.name,a+="</div>",a+='<div secondary style="white-space:normal;">',a+=e.text,a+="</div>",t&&(a+="</a>"),a+="</paper-item-body>",a+="</paper-icon-item>"}function c(){v=!1,"true"==this.getAttribute("data-email")?p(this.getAttribute("data-feature")):IapManager.beginPurchase(this.getAttribute("data-feature"))}function u(e,t,a,n){v=!0;for(var r=e.querySelectorAll(".btnPurchase"),o=0,l=r.length;l>o;o++)r[o].addEventListener("click",c);var s=e.querySelector(".btnRestorePurchase");s&&s.addEventListener("click",function(){v=!1,d()}),e.addEventListener("close",function(){i();v&&("playback"==t?Dashboard.alert({message:Globalize.translate("ThankYouForTryingEnjoyOneMinute"),title:Globalize.translate("HeaderTryPlayback"),callback:function(){n()}}):n())})}function d(){require(["dialogHelper"],function(e){var a=e.createDialog({size:"fullscreen-border",removeOnClose:!0});a.classList.add("ui-body-b"),a.classList.add("background-theme-b");var n="";n+='<h2 class="dialogHeader">',n+='<paper-fab icon="arrow-back" mini class="btnCloseDialog" tabindex=-1""></paper-fab>',n+='<div style="display:inline-block;margin-left:.6em;vertical-align:middle;">'+Globalize.translate("ButtonRestorePreviousPurchase")+"</div>",n+="</h2>",n+='<div class="editorContent">',n+='<p style="margin:2em 0;">',n+=Globalize.translate("HowDidYouPay"),n+="</p>",n+="<p>",n+='<button is="emby-button" type="button" class="raised secondary block btnRestoreSub subdued"><span>'+Globalize.translate("IHaveEmbyPremiere")+"</span></button>",n+="</p>",n+="<p>",n+='<button is="emby-button" type="button" class="raised secondary block btnRestoreUnlock subdued"><span>'+Globalize.translate("IPurchasedThisApp")+"</span></button>",n+="</p>",n+="</div>",a.innerHTML=n,document.body.appendChild(a),t.hide(),e.open(a),a.querySelector(".btnCloseDialog").addEventListener("click",function(){e.close(a)}),a.querySelector(".btnRestoreSub").addEventListener("click",function(){e.close(a),Dashboard.alert({message:Globalize.translate("MessageToValidateSupporter"),title:Globalize.translate("TabEmbyPremiere")})}),a.querySelector(".btnRestoreUnlock").addEventListener("click",function(){e.close(a),IapManager.restorePurchase()})})}function b(e,t,a){return new Promise(function(n,r){require(["dialogHelper","paper-fab","paper-icon-item","paper-item-body"],function(i){window.TabBar&&TabBar.hide(),o(i,e,t,a,n,r),k=n})})}function p(e){if(ConnectionManager.isLoggedIntoConnect()){var t=ConnectionManager.connectUser();if(t&&t.Email)return void IapManager.beginPurchase(e,t.Email)}f(e)}function f(e){require(["prompt"],function(t){t({label:Globalize.translate("TextPleaseEnterYourEmailAddressForSubscription")}).then(function(t){t&&IapManager.beginPurchase(e,t)})})}function m(e,t){if(t.owned){var a=k;a&&h.filter(function(e){return t.id==e.id}).length&&(v=!1,r(),a())}}function y(){return a("Sync").catch(function(){return IapManager.getSubscriptionOptions().then(function(e){var t={title:Globalize.translate("HeaderUnlockSync"),feature:"sync"};return b(e,null,t)})})}function g(){Events.on(IapManager,"productupdated",m)}var v=!0,h=[],k=null;return window.RegistrationServices={renderPluginInfo:function(){},validateFeature:function(e){return"playback"==e?n(e):"livetv"==e?n(e):"sync"==e?y():Promise.resolve()}},browserInfo.android?requirejs(["cordova/android/iap"],g):requirejs(["cordova/iap"],g),window.RegistrationServices});