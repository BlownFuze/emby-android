(function(){function setImageIntoElement(elem,url){if(elem.tagName!=="IMG"){elem.style.backgroundImage="url('"+url+"')";}else{elem.setAttribute("src",url);}
if(browserInfo.chrome&&!browserInfo.mobile){if(!elem.classList.contains('noFade')){fadeIn(elem,1);}}}
function fadeIn(elem,iterations){var keyframes=[{opacity:'0',offset:0},{opacity:'1',offset:1}];var timing={duration:200,iterations:iterations};return elem.animate(keyframes,timing);}
var requestedBytes=1024*1024*500;var imageCacheDirectoryEntry;var imageCacheFolder='images';function createDir(rootDirEntry,folders,callback,errorCallback){if(folders[0]=='.'||folders[0]==''){folders=folders.slice(1);}
rootDirEntry.getDirectory(folders[0],{create:true},function(dirEntry){if(folders.length>1){createDir(dirEntry,folders.slice(1),callback,errorCallback);}else{callback(dirEntry);}},errorCallback);}
navigator.webkitPersistentStorage.requestQuota(requestedBytes,function(grantedBytes){var requestMethod=window.webkitRequestFileSystem||window.requestFileSystem;requestMethod(PERSISTENT,grantedBytes,function(fs){fileSystem=fs;createDir(fileSystem.root,imageCacheFolder.split('/'),function(dirEntry){imageCacheDirectoryEntry=dirEntry;});});});var fileSystem;function imageFileStore(){var self=this;function getCacheKey(url){var index=url.indexOf('://');if(index!=-1){url=url.substring(index+3);index=url.indexOf('/');if(index!=-1){url=url.substring(index+1);}}
return CryptoJS.MD5(url).toString();}
function downloadToFile(url,dir,filename,callback,errorCallback){Logger.log('Downloading '+url);var xhr=new XMLHttpRequest();xhr.open('GET',url,true);xhr.responseType="arraybuffer";xhr.onload=function(e){if(this.status==200){writeData(dir,filename,this.getResponseHeader('Content-Type'),this.response,callback,errorCallback);}else{errorCallback('');}}
xhr.send();}
function writeData(dir,filename,fileType,data,callback,errorCallback){dir.getFile(filename,{create:true},function(fileEntry){fileEntry.createWriter(function(fileWriter){fileWriter.onwriteend=function(e){callback(fileEntry);};fileWriter.onerror=errorCallback;var blob=new Blob([data],{type:fileType});fileWriter.write(blob);},errorCallback);},errorCallback);}
self.getImageUrl=function(originalUrl){return new Promise(function(resolve,reject){if(originalUrl.indexOf('tag=')!=-1){originalUrl+="&accept=webp";}
var key=getCacheKey(originalUrl);var fileEntryCallback=function(fileEntry){resolve(fileEntry.toURL());};var errorCallback=function(e){Logger.log('Imagestore error: '+e.name);reject();};if(!fileSystem||!imageCacheDirectoryEntry){errorCallback('');return;}
var path='/'+imageCacheFolder+"/"+key;fileSystem.root.getFile(path,{create:false},fileEntryCallback,function(){downloadToFile(originalUrl,imageCacheDirectoryEntry,key,fileEntryCallback,errorCallback);});});};self.setImageInto=function(elem,url){self.getImageUrl(url).then(function(localUrl){setImageIntoElement(elem,localUrl);},function(){setImageIntoElement(elem,url);});};window.ImageStore=self;}
require(['cryptojs-sha1'],function(){new imageFileStore();});})();