define(["paperdialoghelper","appStorage","paper-fab","paper-item-body","paper-icon-item"],function(e,t){function i(e,t){Dashboard.showLoadingMsg();var i=$(".popupSubtitleViewer",e).popup("open");$(".subtitleContent",e).html("");var n="Videos/"+b.Id+"/Subtitles/"+t;ApiClient.ajax({type:"GET",url:n}).then(function(t){$(".subtitleContent",e).html(t),Dashboard.hideLoadingMsg(),i.popup("reposition",{})})}function n(e,t){Dashboard.showLoadingMsg();var i=$(".popupSubtitleViewer",e).popup("open");$(".subtitleContent",e).html("");var n="Providers/Subtitles/Subtitles/"+t;ApiClient.get(ApiClient.getUrl(n)).then(function(t){$(".subtitleContent",e).html(t),Dashboard.hideLoadingMsg(),i.popup("reposition",{})})}function a(e,t){var i="Items/"+b.Id+"/RemoteSearch/Subtitles/"+t;ApiClient.ajax({type:"POST",url:ApiClient.getUrl(i)}).then(function(){require(["toast"],function(e){e(Globalize.translate("MessageDownloadQueued"))})})}function o(e,t){var i=Globalize.translate("MessageAreYouSureDeleteSubtitles");require(["confirm"],function(n){n(i,Globalize.translate("HeaderConfirmDeletion")).then(function(){Dashboard.showLoadingMsg();var i=b.Id,n="Videos/"+i+"/Subtitles/"+t;ApiClient.ajax({type:"DELETE",url:ApiClient.getUrl(n)}).then(function(){u(e,i)})})})}function r(e,t){var n=t.MediaStreams||[],a=n.filter(function(e){return"Subtitle"==e.Type}),r="";a.length&&(r+='<h1 style="margin-top:1.5em;">'+Globalize.translate("HeaderCurrentSubtitles")+"</h1>",r+='<div class="paperList">',r+=a.map(function(e){var t="";t+="<paper-icon-item>",t+='<paper-fab mini class="blue" icon="closed-caption" item-icon></paper-fab>';var i=[];return i.push(e.Codec),e.IsDefault&&i.push("Default"),e.IsForced&&i.push("Forced"),t+=3==i.length?"<paper-item-body three-line>":"<paper-item-body two-line>",t+="<div>",t+=e.Language||Globalize.translate("LabelUnknownLanaguage"),t+="</div>",t+="<div secondary>"+i.join(" - ")+"</div>",e.Path&&(t+="<div secondary>"+e.Path+"</div>"),r+="</a>",t+="</paper-item-body>",e.Path&&(t+='<paper-icon-button icon="delete" data-index="'+e.Index+'" title="'+Globalize.translate("Delete")+'" class="btnDelete"></paper-icon-button>'),t+="</paper-icon-item>"}).join(""),r+="</div>");var l=$(".subtitleList",e).html(r);$(".btnViewSubtitles",l).on("click",function(){var t=this.getAttribute("data-index");i(e,t)}),$(".btnDelete",l).on("click",function(){var t=this.getAttribute("data-index");o(e,t)})}function l(e,i){$("#selectLanguage",e).html(i.map(function(e){return'<option value="'+e.ThreeLetterISOLanguageName+'">'+e.DisplayName+"</option>"}));var n=t.getItem("subtitleeditor-language");n?$("#selectLanguage",e).val(n):Dashboard.getCurrentUser().then(function(t){var i=t.Configuration.SubtitleLanguagePreference;i&&$("#selectLanguage",e).val(i)})}function s(e,t){var i="",o="";if(!t.length)return $(".noSearchResults",e).show(),$(".subtitleResults",e).html(""),void Dashboard.hideLoadingMsg();$(".noSearchResults",e).hide();for(var r=0,l=t.length;l>r;r++){var s=t[r],d=s.ProviderName;d!=i&&(r>0&&(o+="</div>"),o+="<h1>"+d+"</h1>",o+='<div class="paperList">',i=d),o+="<paper-icon-item>",o+='<paper-fab mini class="blue" icon="closed-caption" item-icon></paper-fab>',o+=s.Comment?"<paper-item-body three-line>":"<paper-item-body two-line>",o+="<div>"+s.Name+"</div>",o+="<div secondary>"+s.Format+"</div>",s.Comment&&(o+="<div secondary>"+s.Comment+"</div>"),o+="</paper-item-body>",o+='<div style="font-size:86%;opacity:.7;">'+(s.DownloadCount||0)+"</div>",o+='<paper-icon-button icon="cloud-download" data-subid="'+s.Id+'" title="'+Globalize.translate("ButtonDownload")+'" class="btnDownload"></paper-icon-button>',o+="</paper-icon-item>"}t.length&&(o+="</div>");var u=$(".subtitleResults",e).html(o);$(".btnViewSubtitle",u).on("click",function(){var t=this.getAttribute("data-subid");n(e,t)}),$(".btnDownload",u).on("click",function(){var t=this.getAttribute("data-subid");a(e,t)}),Dashboard.hideLoadingMsg()}function d(e,i){t.setItem("subtitleeditor-language",i),Dashboard.showLoadingMsg();var n=ApiClient.getUrl("Items/"+b.Id+"/RemoteSearch/Subtitles/"+i);ApiClient.getJSON(n).then(function(t){s(e,t)})}function u(e,t){function i(t){b=t,r(e,t);var i=t.Path||"",n=Math.max(i.lastIndexOf("/"),i.lastIndexOf("\\"));n>-1&&(i=i.substring(n+1)),i?(e.querySelector(".pathValue").innerHTML=i,e.querySelector(".originalFile").classList.remove("hide")):(e.querySelector(".pathValue").innerHTML="",e.querySelector(".originalFile").classList.add("hide")),Dashboard.hideLoadingMsg()}$(".noSearchResults",e).hide(),"string"==typeof t?ApiClient.getItem(Dashboard.getCurrentUserId(),t).then(i):i(t)}function p(){var e=this,t=$("#selectLanguage",e).val();return d($(e).parents(".editorContent"),t),!1}function c(t){Dashboard.showLoadingMsg();var i=new XMLHttpRequest;i.open("GET","components/subtitleeditor/subtitleeditor.template.html",!0),i.onload=function(){var i=this.response;ApiClient.getItem(Dashboard.getCurrentUserId(),t).then(function(t){var n=e.createDialog({size:"small",removeOnClose:!0});n.classList.add("ui-body-b"),n.classList.add("background-theme-b");var a="";a+='<div class="dialogHeader">',a+='<paper-icon-button icon="arrow-back" class="btnCancel" tabindex="-1"></paper-icon-button>',a+='<div class="dialogHeaderTitle">',a+=t.Name,a+="</div>",a+="</div>",a+='<div class="editorContent">',a+=Globalize.translateDocument(i),a+="</div>",n.innerHTML=a,document.body.appendChild(n),n.querySelector(".pathLabel").innerHTML=Globalize.translate("MediaInfoFile"),$(".subtitleSearchForm",n).off("submit",p).on("submit",p),e.open(n);var o=n.querySelector(".editorContent");u(o,t),ApiClient.getCultures().then(function(e){l(o,e)}),$(".btnCancel",n).on("click",function(){e.close(n)})})},i.send()}var b;return{show:c}});