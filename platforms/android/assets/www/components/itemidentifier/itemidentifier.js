define(["paperdialoghelper","jQuery","paper-fab","paper-input","paper-checkbox"],function(e,t){function a(e){var a={ProviderIds:{}};t(".identifyField",e).each(function(){var e=this.value;e&&("number"==this.type&&(e=parseInt(e)),a[this.getAttribute("data-lookup")]=e)});var r=!1;return t(".txtLookupId",e).each(function(){var e=this.value;e&&(r=!0),a.ProviderIds[this.getAttribute("data-providerkey")]=e}),r||a.Name?(h&&h.GameSystem&&(a.GameSystem=h.GameSystem),a={SearchInfo:a,IncludeDisabledProviders:!0},Dashboard.showLoadingMsg(),void ApiClient.ajax({type:"POST",url:ApiClient.getUrl("Items/RemoteSearch/"+v),data:JSON.stringify(a),contentType:"application/json",dataType:"json"}).then(function(t){Dashboard.hideLoadingMsg(),i(e,t)})):void require(["toast"],function(e){e(Globalize.translate("MessagePleaseEnterNameOrId"))})}function i(e,a){t(".popupIdentifyForm",e).hide(),t(".identificationSearchResults",e).show(),t(".identifyOptionsForm",e).hide(),t(".btnIdentifyBack",e).show();for(var i="",d=0,s=a.length;s>d;d++){var l=a[d];i+=o(l,d)}var c=t(".identificationSearchResultList",e).html(i);t(".searchImage",c).on("click",function(){var t=parseInt(this.getAttribute("data-index")),i=a[t];null!=h?n(e,i):r(e,i)})}function r(t,a){g=a,y=!0,Dashboard.hideLoadingMsg(),e.close(t)}function n(e,a){t(".popupIdentifyForm",e).hide(),t(".identificationSearchResults",e).hide(),t(".identifyOptionsForm",e).show(),t(".btnIdentifyBack",e).show(),t("#chkIdentifyReplaceImages",e).checked(!0),g=a;var i=[];i.push(a.Name),a.ProductionYear&&i.push(a.ProductionYear),a.GameSystem&&i.push(a.GameSystem);var r=i.join("<br/>");if(a.ImageUrl){var n=d(a.ImageUrl,a.SearchProviderName);r='<img src="'+n+'" style="max-height:160px;" /><br/>'+r}t(".selectedSearchResult",e).html(r)}function o(e,t){var a="",i="card";if(i+="Episode"==v?" backdropCard":"MusicAlbum"==v||"MusicArtist"==v?" squareCard":" portraitCard",a+='<div class="'+i+'">',a+='<div class="cardBox">',a+='<div class="cardScalable">',a+='<div class="cardPadder"></div>',a+='<a class="cardContent searchImage" href="#" data-index="'+t+'">',e.ImageUrl){var r=d(e.ImageUrl,e.SearchProviderName);a+='<div class="cardImage" style="background-image:url(\''+r+"');\"></div>"}else a+='<div class="cardImage iconCardImage"><iron-icon icon="search"></iron-icon></div>';return a+="</a>",a+="</div>",a+='<div class="cardFooter outerCardFooter">',a+='<div class="cardText cardTextCentered">'+e.Name+"</div>",a+='<div class="cardText cardTextCentered">',a+=e.ProductionYear||"&nbsp;",a+="</div>",e.GameSystem&&(a+='<div class="cardText cardTextCentered">',a+=e.GameSystem,a+="</div>"),a+="</div>",a+="</div>",a+="</div>"}function d(e,t){return ApiClient.getUrl("Items/RemoteSearch/Image",{imageUrl:e,ProviderName:t})}function s(a){Dashboard.showLoadingMsg();var i={ReplaceAllImages:t("#chkIdentifyReplaceImages",a).checked()};ApiClient.ajax({type:"POST",url:ApiClient.getUrl("Items/RemoteSearch/Apply/"+h.Id,i),data:JSON.stringify(g),contentType:"application/json"}).then(function(){y=!0,Dashboard.hideLoadingMsg(),e.close(a)},function(){Dashboard.hideLoadingMsg(),e.close(a)})}function l(e,a){ApiClient.getJSON(ApiClient.getUrl("Items/"+a.Id+"/ExternalIdInfos")).then(function(i){for(var r="",n=a.ProviderIds||{},o=0,d=i.length;d>o;o++){var s=i[o],l="txtLookup"+s.Key;r+="<div>";var c=Globalize.translate("LabelDynamicExternalId").replace("{0}",s.Name),u=n[s.Key]||"";r+='<paper-input class="txtLookupId" value="'+u+'" data-providerkey="'+s.Key+'" id="'+l+'" label="'+c+'"></paper-input>',r+="</div>"}t("#txtLookupName",e).val(a.Name),"Person"==a.Type||"BoxSet"==a.Type?(t(".fldLookupYear",e).hide(),t("#txtLookupYear",e).val("")):(t(".fldLookupYear",e).show(),t("#txtLookupYear",e).val(a.ProductionYear)),t(".identifyProviderIds",e).html(r),e.querySelector(".dialogHeaderTitle").innerHTML=Globalize.translate("HeaderIdentify")})}function c(i){Dashboard.showLoadingMsg();var r=new XMLHttpRequest;r.open("GET","components/itemidentifier/itemidentifier.template.html",!0),r.onload=function(){var r=this.response;ApiClient.getItem(Dashboard.getCurrentUserId(),i).then(function(i){h=i,v=h.Type;var n=e.createDialog({size:"medium"});n.classList.add("ui-body-b"),n.classList.add("background-theme-b");var o="";o+=Globalize.translateDocument(r),n.innerHTML=o,document.body.appendChild(n),t(n).on("close",u),e.open(n),n.querySelector(".popupIdentifyForm").addEventListener("submit",function(e){return e.preventDefault(),a(n),!1}),n.querySelector(".identifyOptionsForm").addEventListener("submit",function(e){return e.preventDefault(),s(n),!1}),t(".btnCancel",n).on("click",function(){e.close(n)}),n.classList.add("identifyDialog"),l(n,i),Dashboard.hideLoadingMsg()})},r.send()}function u(){t(this).remove(),Dashboard.hideLoadingMsg(),f.resolveWith(null,[y])}function p(t,i,r,n){h=null,v=r;var o=new XMLHttpRequest;o.open("GET","components/itemidentifier/itemidentifier.template.html",!0),o.onload=function(){var o=this.response,d=e.createDialog({size:"medium"});d.classList.add("ui-body-a"),d.classList.add("background-theme-a");var s="";s+=Globalize.translateDocument(o),d.innerHTML=s,document.body.appendChild(d),e.open(d),d.querySelector(".btnCancel").addEventListener("click",function(){e.close(d)}),d.querySelector(".popupIdentifyForm").addEventListener("submit",function(e){return e.preventDefault(),a(d),!1}),d.addEventListener("close",function(){Dashboard.hideLoadingMsg();var e=y?g:null;n(e)}),d.classList.add("identifyDialog"),m(d,t,i,r)},o.send()}function m(e,t,a,i){e.querySelector("#txtLookupName").value=t,"Person"==i||"BoxSet"==i?(e.querySelector(".fldLookupYear").classList.add("hide"),e.querySelector("#txtLookupYear").value=""):(e.querySelector(".fldLookupYear").classList.remove("hide"),e.querySelector("#txtLookupYear").value=a),e.querySelector(".dialogHeaderTitle").innerHTML=Globalize.translate("HeaderSearch")}var h,v,f,g,y=!1;return{show:function(e){var t=jQuery.Deferred();return f=t,y=!1,c(e),t.promise()},showFindNew:function(e,t,a){return new Promise(function(i){y=!1,p(e,t,a,i)})}}});