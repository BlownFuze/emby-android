define(["paperdialoghelper","paper-dialog","paper-fab","paper-input","paper-checkbox"],function(e){function t(e){var t={ProviderIds:{}};$(".identifyField",e).each(function(){var e=this.value;e&&("number"==this.type&&(e=parseInt(e)),t[this.getAttribute("data-lookup")]=e)});var i=!1;return $(".txtLookupId",e).each(function(){var e=this.value;e&&(i=!0),t.ProviderIds[this.getAttribute("data-providerkey")]=e}),i||t.Name?(m&&m.GameSystem&&(t.GameSystem=m.GameSystem),t={SearchInfo:t,IncludeDisabledProviders:!0},Dashboard.showLoadingMsg(),void ApiClient.ajax({type:"POST",url:ApiClient.getUrl("Items/RemoteSearch/"+h),data:JSON.stringify(t),contentType:"application/json",dataType:"json"}).then(function(t){Dashboard.hideLoadingMsg(),a(e,t)})):void require(["toast"],function(e){e(Globalize.translate("MessagePleaseEnterNameOrId"))})}function a(e,t){$(".popupIdentifyForm",e).hide(),$(".identificationSearchResults",e).show(),$(".identifyOptionsForm",e).hide(),$(".btnIdentifyBack",e).show();for(var a="",o=0,d=t.length;d>o;o++){var s=t[o];a+=n(s,o)}var l=$(".identificationSearchResultList",e).html(a).trigger("create");$(".searchImage",l).on("click",function(){var a=parseInt(this.getAttribute("data-index")),n=t[a];null!=m?r(e,n):i(e,n)})}function i(t,a){f=a,g=!0,Dashboard.hideLoadingMsg(),e.close(t)}function r(e,t){$(".popupIdentifyForm",e).hide(),$(".identificationSearchResults",e).hide(),$(".identifyOptionsForm",e).show(),$(".btnIdentifyBack",e).show(),$("#chkIdentifyReplaceImages",e).checked(!0),f=t;var a=[];a.push(t.Name),t.ProductionYear&&a.push(t.ProductionYear),t.GameSystem&&a.push(t.GameSystem);var i=a.join("<br/>");if(t.ImageUrl){var r=o(t.ImageUrl,t.SearchProviderName);i='<img src="'+r+'" style="max-height:160px;" /><br/>'+i}$(".selectedSearchResult",e).html(i)}function n(e,t){var a="",i="card";if(i+="Episode"==h?" backdropCard":"MusicAlbum"==h||"MusicArtist"==h?" squareCard":" portraitCard",a+='<div class="'+i+'">',a+='<div class="cardBox">',a+='<div class="cardScalable">',a+='<div class="cardPadder"></div>',a+='<a class="cardContent searchImage" href="#" data-index="'+t+'">',e.ImageUrl){var r=o(e.ImageUrl,e.SearchProviderName);a+='<div class="cardImage" style="background-image:url(\''+r+"');\"></div>"}else a+='<div class="cardImage iconCardImage"><iron-icon icon="search"></iron-icon></div>';return a+="</a>",a+="</div>",a+='<div class="cardFooter outerCardFooter">',a+='<div class="cardText cardTextCentered">'+e.Name+"</div>",a+='<div class="cardText cardTextCentered">',a+=e.ProductionYear||"&nbsp;",a+="</div>",e.GameSystem&&(a+='<div class="cardText cardTextCentered">',a+=e.GameSystem,a+="</div>"),a+="</div>",a+="</div>",a+="</div>"}function o(e,t){return ApiClient.getUrl("Items/RemoteSearch/Image",{imageUrl:e,ProviderName:t})}function d(t){Dashboard.showLoadingMsg();var a={ReplaceAllImages:$("#chkIdentifyReplaceImages",t).checked()};ApiClient.ajax({type:"POST",url:ApiClient.getUrl("Items/RemoteSearch/Apply/"+m.Id,a),data:JSON.stringify(f),contentType:"application/json"}).then(function(){g=!0,Dashboard.hideLoadingMsg(),e.close(t)},function(){Dashboard.hideLoadingMsg(),e.close(t)})}function s(e,t){ApiClient.getJSON(ApiClient.getUrl("Items/"+t.Id+"/ExternalIdInfos")).then(function(a){for(var i="",r=t.ProviderIds||{},n=0,o=a.length;o>n;n++){var d=a[n],s="txtLookup"+d.Key;i+="<div>";var l=Globalize.translate("LabelDynamicExternalId").replace("{0}",d.Name),c=r[d.Key]||"";i+='<paper-input class="txtLookupId" value="'+c+'" data-providerkey="'+d.Key+'" id="'+s+'" label="'+l+'"></paper-input>',i+="</div>"}$("#txtLookupName",e).val(t.Name),"Person"==t.Type||"BoxSet"==t.Type?($(".fldLookupYear",e).hide(),$("#txtLookupYear",e).val("")):($(".fldLookupYear",e).show(),$("#txtLookupYear",e).val(t.ProductionYear)),$(".identifyProviderIds",e).html(i).trigger("create"),e.querySelector(".dialogHeaderTitle").innerHTML=Globalize.translate("HeaderIdentify")})}function l(a){Dashboard.showLoadingMsg();var i=new XMLHttpRequest;i.open("GET","components/itemidentifier/itemidentifier.template.html",!0),i.onload=function(){var i=this.response;ApiClient.getItem(Dashboard.getCurrentUserId(),a).then(function(a){m=a,h=m.Type;var r=e.createDialog({size:"medium"});r.classList.add("ui-body-b"),r.classList.add("background-theme-b");var n="";n+=Globalize.translateDocument(i),r.innerHTML=n,document.body.appendChild(r),$(r).on("iron-overlay-closed",c),e.open(r),r.querySelector(".popupIdentifyForm").addEventListener("submit",function(e){return e.preventDefault(),t(r),!1}),r.querySelector(".identifyOptionsForm").addEventListener("submit",function(e){return e.preventDefault(),d(r),!1}),$(".btnCancel",r).on("click",function(){e.close(r)}),r.classList.add("identifyDialog"),s(r,a),Dashboard.hideLoadingMsg()})},i.send()}function c(){$(this).remove(),Dashboard.hideLoadingMsg(),v.resolveWith(null,[g])}function u(a,i,r,n){m=null,h=r;var o=new XMLHttpRequest;o.open("GET","components/itemidentifier/itemidentifier.template.html",!0),o.onload=function(){var o=this.response,d=e.createDialog({size:"medium"});d.classList.add("ui-body-a"),d.classList.add("background-theme-a");var s="";s+=Globalize.translateDocument(o),d.innerHTML=s,document.body.appendChild(d),e.open(d),d.querySelector(".btnCancel").addEventListener("click",function(){e.close(d)}),d.querySelector(".popupIdentifyForm").addEventListener("submit",function(e){return e.preventDefault(),t(d),!1}),d.addEventListener("iron-overlay-closed",function(){Dashboard.hideLoadingMsg();var e=g?f:null;n(e)}),d.classList.add("identifyDialog"),p(d,a,i,r)},o.send()}function p(e,t,a,i){e.querySelector("#txtLookupName").value=t,"Person"==i||"BoxSet"==i?(e.querySelector(".fldLookupYear").classList.add("hide"),e.querySelector("#txtLookupYear").value=""):(e.querySelector(".fldLookupYear").classList.remove("hide"),e.querySelector("#txtLookupYear").value=a),e.querySelector(".dialogHeaderTitle").innerHTML=Globalize.translate("HeaderSearch")}var m,h,v,f,g=!1;return{show:function(e){var t=jQuery.Deferred();return v=t,g=!1,l(e),t.promise()},showFindNew:function(e,t,a){return new Promise(function(i){g=!1,u(e,t,a,i)})}}});