!function(e,a,i){function t(){var a=e(this).parents(".editorContent");return r(a),!1}function r(a){var i={ProviderIds:{}};e(".identifyField",a).each(function(){var e=this.value;e&&("number"==this.type&&(e=parseInt(e)),i[this.getAttribute("data-lookup")]=e)});var t=!1;return e(".txtLookupId",a).each(function(){var e=this.value;e&&(t=!0),i.ProviderIds[this.getAttribute("data-providerkey")]=e}),t||i.Name?(v.GameSystem&&(i.GameSystem=v.GameSystem),i={SearchInfo:i,IncludeDisabledProviders:!0},Dashboard.showLoadingMsg(),void ApiClient.ajax({type:"POST",url:ApiClient.getUrl("Items/RemoteSearch/"+v.Type),data:JSON.stringify(i),contentType:"application/json"}).then(function(e){Dashboard.hideLoadingMsg(),n(a,e)})):void Dashboard.alert(Globalize.translate("MessagePleaseEnterNameOrId"))}function n(a,i){e(".popupIdentifyForm",a).hide(),e(".identificationSearchResults",a).show(),e(".identifyOptionsForm",a).hide(),e(".btnIdentifyBack",a).show();for(var t="",r=0,n=i.length;n>r;r++){var s=i[r];t+=d(s,r)}var l=e(".identificationSearchResultList",a).html(t).trigger("create");e(".searchImage",l).on("click",function(){var e=parseInt(this.getAttribute("data-index")),t=i[e];o(a,t)})}function o(a,i){e(".popupIdentifyForm",a).hide(),e(".identificationSearchResults",a).hide(),e(".identifyOptionsForm",a).show(),e(".btnIdentifyBack",a).show(),e("#chkIdentifyReplaceImages",a).checked(!0),g=i;var t=[];t.push(i.Name),i.ProductionYear&&t.push(i.ProductionYear),i.GameSystem&&t.push(i.GameSystem);var r=t.join("<br/>");if(i.ImageUrl){var n=s(i.ImageUrl,i.SearchProviderName);r='<img src="'+n+'" style="max-height:160px;" /><br/>'+r}e(".selectedSearchResult",a).html(r)}function d(e,a){var i="",t="card";if(t+="Episode"==v.Type?" backdropCard":"MusicAlbum"==v.Type||"MusicArtist"==v.Type?" squareCard":" portraitCard",i+='<div class="'+t+'">',i+='<div class="cardBox">',i+='<div class="cardScalable">',i+='<div class="cardPadder"></div>',i+='<a class="cardContent searchImage" href="#" data-index="'+a+'">',e.ImageUrl){var r=s(e.ImageUrl,e.SearchProviderName);i+='<div class="cardImage" style="background-image:url(\''+r+"');\"></div>"}else i+='<div class="cardImage iconCardImage"><iron-icon icon="search"></iron-icon></div>';return i+="</a>",i+="</div>",i+='<div class="cardFooter outerCardFooter">',i+='<div class="cardText cardTextCentered">'+e.Name+"</div>",i+='<div class="cardText cardTextCentered">',i+=e.ProductionYear||"&nbsp;",i+="</div>",e.GameSystem&&(i+='<div class="cardText cardTextCentered">',i+=e.GameSystem,i+="</div>"),i+="</div>",i+="</div>",i+="</div>"}function s(e,a){return ApiClient.getUrl("Items/RemoteSearch/Image",{imageUrl:e,ProviderName:a})}function l(){var a=e(this).parents(".editorContent");return c(a),!1}function c(a){Dashboard.showLoadingMsg();var t={ReplaceAllImages:e("#chkIdentifyReplaceImages",a).checked()};ApiClient.ajax({type:"POST",url:ApiClient.getUrl("Items/RemoteSearch/Apply/"+v.Id,t),data:JSON.stringify(g),contentType:"application/json"}).then(function(){y=!0,Dashboard.hideLoadingMsg(),PaperDialogHelper.close(i.querySelector(".identifyDialog"))},function(){Dashboard.hideLoadingMsg(),PaperDialogHelper.close(i.querySelector(".identifyDialog"))})}function p(a){e(".popupIdentifyForm",a).off("submit",t).on("submit",t),e(".identifyOptionsForm",a).off("submit",l).on("submit",l)}function u(a,i){ApiClient.getJSON(ApiClient.getUrl("Items/"+i.Id+"/ExternalIdInfos")).then(function(t){for(var r="",n=i.ProviderIds||{},o=0,d=t.length;d>o;o++){var s=t[o],l="txtLookup"+s.Key;r+="<div>";var c=Globalize.translate("LabelDynamicExternalId").replace("{0}",s.Name),p=n[s.Key]||"";r+='<paper-input class="txtLookupId" value="'+p+'" data-providerkey="'+s.Key+'" id="'+l+'" label="'+c+'"></paper-input>',r+="</div>"}e("#txtLookupName",a).val(i.Name),"Person"==i.Type||"BoxSet"==i.Type?(e(".fldLookupYear",a).hide(),e("#txtLookupYear",a).val("")):(e(".fldLookupYear",a).show(),e("#txtLookupYear",a).val(i.ProductionYear)),e(".identifyProviderIds",a).html(r).trigger("create"),e(".identificationHeader",a).html(Globalize.translate("HeaderIdentify"))})}function m(a){Dashboard.showLoadingMsg();var t=new XMLHttpRequest;t.open("GET","components/itemidentifier/itemidentifier.template.html",!0),t.onload=function(){var t=this.response;ApiClient.getItem(Dashboard.getCurrentUserId(),a).then(function(a){v=a;var r=PaperDialogHelper.createDialog(),n="";n+='<h2 class="dialogHeader">',n+='<paper-fab icon="arrow-back" mini class="btnCloseDialog"></paper-fab>',n+='<div style="display:inline-block;margin-left:.6em;vertical-align:middle;">'+Globalize.translate("HeaderIdentifyItem")+"</div>",n+="</h2>",n+='<div class="editorContent">',n+=Globalize.translateDocument(t),n+="</div>",r.innerHTML=n,i.body.appendChild(r),e(r).on("iron-overlay-closed",h),PaperDialogHelper.openWithHash(r,"itemidentifier");var o=r.querySelector(".editorContent");p(o),e(".btnCloseDialog",r).on("click",function(){PaperDialogHelper.close(r)}),r.classList.add("identifyDialog"),u(r,a),Dashboard.hideLoadingMsg()})},t.send()}function h(){e(this).remove(),Dashboard.hideLoadingMsg(),f.resolveWith(null,[y])}var v,f,g,y=!1;a.ItemIdentifier={show:function(e){var a=DeferredBuilder.Deferred();return f=a,y=!1,require(["components/paperdialoghelper"],function(){m(e)}),a.promise()}}}(jQuery,window,document);