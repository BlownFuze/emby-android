!function(e,a,t){function i(){var a=e(this).parents(".editorContent");return r(a),!1}function r(a){var t={ProviderIds:{}};e(".identifyField",a).each(function(){var e=this.value;e&&("number"==this.type&&(e=parseInt(e)),t[this.getAttribute("data-lookup")]=e)});var i=!1;return e(".txtLookupId",a).each(function(){var e=this.value;e&&(i=!0),t.ProviderIds[this.getAttribute("data-providerkey")]=e}),i||t.Name?(v.GameSystem&&(t.GameSystem=v.GameSystem),t={SearchInfo:t,IncludeDisabledProviders:!0},Dashboard.showLoadingMsg(),void ApiClient.ajax({type:"POST",url:ApiClient.getUrl("Items/RemoteSearch/"+v.Type),data:JSON.stringify(t),contentType:"application/json",dataType:"json"}).then(function(e){Dashboard.hideLoadingMsg(),n(a,e)})):void Dashboard.alert(Globalize.translate("MessagePleaseEnterNameOrId"))}function n(a,t){e(".popupIdentifyForm",a).hide(),e(".identificationSearchResults",a).show(),e(".identifyOptionsForm",a).hide(),e(".btnIdentifyBack",a).show();for(var i="",r=0,n=t.length;n>r;r++){var s=t[r];i+=d(s,r)}var l=e(".identificationSearchResultList",a).html(i).trigger("create");e(".searchImage",l).on("click",function(){var e=parseInt(this.getAttribute("data-index")),i=t[e];o(a,i)})}function o(a,t){e(".popupIdentifyForm",a).hide(),e(".identificationSearchResults",a).hide(),e(".identifyOptionsForm",a).show(),e(".btnIdentifyBack",a).show(),e("#chkIdentifyReplaceImages",a).checked(!0),g=t;var i=[];i.push(t.Name),t.ProductionYear&&i.push(t.ProductionYear),t.GameSystem&&i.push(t.GameSystem);var r=i.join("<br/>");if(t.ImageUrl){var n=s(t.ImageUrl,t.SearchProviderName);r='<img src="'+n+'" style="max-height:160px;" /><br/>'+r}e(".selectedSearchResult",a).html(r)}function d(e,a){var t="",i="card";if(i+="Episode"==v.Type?" backdropCard":"MusicAlbum"==v.Type||"MusicArtist"==v.Type?" squareCard":" portraitCard",t+='<div class="'+i+'">',t+='<div class="cardBox">',t+='<div class="cardScalable">',t+='<div class="cardPadder"></div>',t+='<a class="cardContent searchImage" href="#" data-index="'+a+'">',e.ImageUrl){var r=s(e.ImageUrl,e.SearchProviderName);t+='<div class="cardImage" style="background-image:url(\''+r+"');\"></div>"}else t+='<div class="cardImage iconCardImage"><iron-icon icon="search"></iron-icon></div>';return t+="</a>",t+="</div>",t+='<div class="cardFooter outerCardFooter">',t+='<div class="cardText cardTextCentered">'+e.Name+"</div>",t+='<div class="cardText cardTextCentered">',t+=e.ProductionYear||"&nbsp;",t+="</div>",e.GameSystem&&(t+='<div class="cardText cardTextCentered">',t+=e.GameSystem,t+="</div>"),t+="</div>",t+="</div>",t+="</div>"}function s(e,a){return ApiClient.getUrl("Items/RemoteSearch/Image",{imageUrl:e,ProviderName:a})}function l(){var a=e(this).parents(".editorContent");return c(a),!1}function c(a){Dashboard.showLoadingMsg();var i={ReplaceAllImages:e("#chkIdentifyReplaceImages",a).checked()};ApiClient.ajax({type:"POST",url:ApiClient.getUrl("Items/RemoteSearch/Apply/"+v.Id,i),data:JSON.stringify(g),contentType:"application/json"}).then(function(){y=!0,Dashboard.hideLoadingMsg(),PaperDialogHelper.close(t.querySelector(".identifyDialog"))},function(){Dashboard.hideLoadingMsg(),PaperDialogHelper.close(t.querySelector(".identifyDialog"))})}function p(a){e(".popupIdentifyForm",a).off("submit",i).on("submit",i),e(".identifyOptionsForm",a).off("submit",l).on("submit",l)}function u(a,t){ApiClient.getJSON(ApiClient.getUrl("Items/"+t.Id+"/ExternalIdInfos")).then(function(i){for(var r="",n=t.ProviderIds||{},o=0,d=i.length;d>o;o++){var s=i[o],l="txtLookup"+s.Key;r+="<div>";var c=Globalize.translate("LabelDynamicExternalId").replace("{0}",s.Name),p=n[s.Key]||"";r+='<paper-input class="txtLookupId" value="'+p+'" data-providerkey="'+s.Key+'" id="'+l+'" label="'+c+'"></paper-input>',r+="</div>"}e("#txtLookupName",a).val(t.Name),"Person"==t.Type||"BoxSet"==t.Type?(e(".fldLookupYear",a).hide(),e("#txtLookupYear",a).val("")):(e(".fldLookupYear",a).show(),e("#txtLookupYear",a).val(t.ProductionYear)),e(".identifyProviderIds",a).html(r).trigger("create"),e(".identificationHeader",a).html(Globalize.translate("HeaderIdentify"))})}function m(a){Dashboard.showLoadingMsg();var i=new XMLHttpRequest;i.open("GET","components/itemidentifier/itemidentifier.template.html",!0),i.onload=function(){var i=this.response;ApiClient.getItem(Dashboard.getCurrentUserId(),a).then(function(a){v=a;var r=PaperDialogHelper.createDialog(),n="";n+='<h2 class="dialogHeader">',n+='<paper-fab icon="arrow-back" mini class="btnCloseDialog"></paper-fab>',n+='<div style="display:inline-block;margin-left:.6em;vertical-align:middle;">'+Globalize.translate("HeaderIdentifyItem")+"</div>",n+="</h2>",n+='<div class="editorContent">',n+=Globalize.translateDocument(i),n+="</div>",r.innerHTML=n,t.body.appendChild(r),e(r).on("iron-overlay-closed",h),PaperDialogHelper.openWithHash(r,"itemidentifier");var o=r.querySelector(".editorContent");p(o),e(".btnCloseDialog",r).on("click",function(){PaperDialogHelper.close(r)}),r.classList.add("identifyDialog"),u(r,a),Dashboard.hideLoadingMsg()})},i.send()}function h(){e(this).remove(),Dashboard.hideLoadingMsg(),f.resolveWith(null,[y])}var v,f,g,y=!1;a.ItemIdentifier={show:function(e){var a=DeferredBuilder.Deferred();return f=a,y=!1,require(["components/paperdialoghelper","paper-input"],function(){m(e)}),a.promise()}}}(jQuery,window,document);