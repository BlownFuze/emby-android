define(["paperdialoghelper","paper-dialog","paper-fab","paper-input","paper-checkbox"],function(e){function a(){var e=$(this).parents("paper-dialog");return t(e),!1}function t(e){var a={ProviderIds:{}};$(".identifyField",e).each(function(){var e=this.value;e&&("number"==this.type&&(e=parseInt(e)),a[this.getAttribute("data-lookup")]=e)});var t=!1;return $(".txtLookupId",e).each(function(){var e=this.value;e&&(t=!0),a.ProviderIds[this.getAttribute("data-providerkey")]=e}),t||a.Name?(h.GameSystem&&(a.GameSystem=h.GameSystem),a={SearchInfo:a,IncludeDisabledProviders:!0},Dashboard.showLoadingMsg(),void ApiClient.ajax({type:"POST",url:ApiClient.getUrl("Items/RemoteSearch/"+h.Type),data:JSON.stringify(a),contentType:"application/json",dataType:"json"}).then(function(a){Dashboard.hideLoadingMsg(),i(e,a)})):void Dashboard.alert(Globalize.translate("MessagePleaseEnterNameOrId"))}function i(e,a){$(".popupIdentifyForm",e).hide(),$(".identificationSearchResults",e).show(),$(".identifyOptionsForm",e).hide(),$(".btnIdentifyBack",e).show();for(var t="",i=0,o=a.length;o>i;i++){var d=a[i];t+=n(d,i)}var s=$(".identificationSearchResultList",e).html(t).trigger("create");$(".searchImage",s).on("click",function(){var t=parseInt(this.getAttribute("data-index")),i=a[t];r(e,i)})}function r(e,a){$(".popupIdentifyForm",e).hide(),$(".identificationSearchResults",e).hide(),$(".identifyOptionsForm",e).show(),$(".btnIdentifyBack",e).show(),$("#chkIdentifyReplaceImages",e).checked(!0),v=a;var t=[];t.push(a.Name),a.ProductionYear&&t.push(a.ProductionYear),a.GameSystem&&t.push(a.GameSystem);var i=t.join("<br/>");if(a.ImageUrl){var r=o(a.ImageUrl,a.SearchProviderName);i='<img src="'+r+'" style="max-height:160px;" /><br/>'+i}$(".selectedSearchResult",e).html(i)}function n(e,a){var t="",i="card";if(i+="Episode"==h.Type?" backdropCard":"MusicAlbum"==h.Type||"MusicArtist"==h.Type?" squareCard":" portraitCard",t+='<div class="'+i+'">',t+='<div class="cardBox">',t+='<div class="cardScalable">',t+='<div class="cardPadder"></div>',t+='<a class="cardContent searchImage" href="#" data-index="'+a+'">',e.ImageUrl){var r=o(e.ImageUrl,e.SearchProviderName);t+='<div class="cardImage" style="background-image:url(\''+r+"');\"></div>"}else t+='<div class="cardImage iconCardImage"><iron-icon icon="search"></iron-icon></div>';return t+="</a>",t+="</div>",t+='<div class="cardFooter outerCardFooter">',t+='<div class="cardText cardTextCentered">'+e.Name+"</div>",t+='<div class="cardText cardTextCentered">',t+=e.ProductionYear||"&nbsp;",t+="</div>",e.GameSystem&&(t+='<div class="cardText cardTextCentered">',t+=e.GameSystem,t+="</div>"),t+="</div>",t+="</div>",t+="</div>"}function o(e,a){return ApiClient.getUrl("Items/RemoteSearch/Image",{imageUrl:e,ProviderName:a})}function d(){var e=$(this).parents("paper-dialog");return s(e),!1}function s(a){Dashboard.showLoadingMsg();var t={ReplaceAllImages:$("#chkIdentifyReplaceImages",a).checked()};ApiClient.ajax({type:"POST",url:ApiClient.getUrl("Items/RemoteSearch/Apply/"+h.Id,t),data:JSON.stringify(v),contentType:"application/json"}).then(function(){f=!0,Dashboard.hideLoadingMsg(),e.close(document.querySelector(".identifyDialog"))},function(){Dashboard.hideLoadingMsg(),e.close(document.querySelector(".identifyDialog"))})}function c(e){$(".popupIdentifyForm",e).off("submit",a).on("submit",a),$(".identifyOptionsForm",e).off("submit",d).on("submit",d)}function l(e,a){ApiClient.getJSON(ApiClient.getUrl("Items/"+a.Id+"/ExternalIdInfos")).then(function(t){for(var i="",r=a.ProviderIds||{},n=0,o=t.length;o>n;n++){var d=t[n],s="txtLookup"+d.Key;i+="<div>";var c=Globalize.translate("LabelDynamicExternalId").replace("{0}",d.Name),l=r[d.Key]||"";i+='<paper-input class="txtLookupId" value="'+l+'" data-providerkey="'+d.Key+'" id="'+s+'" label="'+c+'"></paper-input>',i+="</div>"}$("#txtLookupName",e).val(a.Name),"Person"==a.Type||"BoxSet"==a.Type?($(".fldLookupYear",e).hide(),$("#txtLookupYear",e).val("")):($(".fldLookupYear",e).show(),$("#txtLookupYear",e).val(a.ProductionYear)),$(".identifyProviderIds",e).html(i).trigger("create"),e.querySelector(".dialogHeaderTitle").innerHTML=Globalize.translate("HeaderIdentify")})}function p(a){Dashboard.showLoadingMsg();var t=new XMLHttpRequest;t.open("GET","components/itemidentifier/itemidentifier.template.html",!0),t.onload=function(){var t=this.response;ApiClient.getItem(Dashboard.getCurrentUserId(),a).then(function(a){h=a;var i=e.createDialog({size:"medium"});i.classList.add("ui-body-b"),i.classList.add("background-theme-b");var r="";r+=Globalize.translateDocument(t),i.innerHTML=r,document.body.appendChild(i),$(i).on("iron-overlay-closed",u),e.open(i),c(i),$(".btnCancel",i).on("click",function(){e.close(i)}),i.classList.add("identifyDialog"),l(i,a),Dashboard.hideLoadingMsg()})},t.send()}function u(){$(this).remove(),Dashboard.hideLoadingMsg(),m.resolveWith(null,[f])}var h,m,v,f=!1;return{show:function(e){var a=jQuery.Deferred();return m=a,f=!1,p(e),a.promise()}}});