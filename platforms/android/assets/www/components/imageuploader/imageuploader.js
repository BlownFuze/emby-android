define(["dialogHelper","jQuery","emby-button"],function(e,a){function t(e){switch(Dashboard.hideLoadingMsg(),e.target.error.code){case e.target.error.NOT_FOUND_ERR:require(["toast"],function(e){e(Globalize.translate("MessageFileNotFound"))});break;case e.target.error.ABORT_ERR:break;default:require(["toast"],function(e){e(Globalize.translate("MessageFileReadError"))})}}function n(e,n){var o=n[0];if(!o||!o.type.match("image.*"))return a("#imageOutput",e).html(""),a("#fldUpload",e).hide(),void(u=null);u=o;var i=new FileReader;i.onerror=t,i.onloadstart=function(){a("#fldUpload",e).hide()},i.onabort=function(){Dashboard.hideLoadingMsg()},i.onload=function(t){return function(n){var o=['<img style="max-width:300px;max-height:100px;" src="',n.target.result,'" title="',escape(t.name),'"/>'].join("");a("#imageOutput",e).html(o),a("#fldUpload",e).show()}}(o),i.readAsDataURL(o)}function o(){g=!0,history.back()}function i(){var e=u;if(!e)return!1;if("image/png"!=e.type&&"image/jpeg"!=e.type&&"image/jpeg"!=e.type)return!1;Dashboard.showLoadingMsg();var t=a(this).parents(".dialog"),n=a("#selectImageType",t).val();return ApiClient.uploadItemImage(d,n,e).then(function(){a("#uploadImage",t).val("").trigger("change"),Dashboard.hideLoadingMsg(),o(t)}),!1}function r(e){a("form",e).off("submit",i).on("submit",i),a("#uploadImage",e).on("change",function(){n(e,this.files)}),a("#imageDropZone",e).on("dragover",function(e){return e.preventDefault(),e.originalEvent.dataTransfer.dropEffect="Copy",!1}).on("drop",function(a){return a.preventDefault(),n(e,a.originalEvent.dataTransfer.files),!1})}function l(t,n){n=n||{};var o=new XMLHttpRequest;o.open("GET","components/imageuploader/imageuploader.template.html",!0),o.onload=function(){var o=this.response;d=t;var i=e.createDialog({size:"fullscreen-border"}),l=n.theme||"b";i.classList.add("ui-body-"+l),i.classList.add("background-theme-"+l),i.classList.add("popupEditor");var u="";u+='<h2 class="dialogHeader">',u+='<button type="button" is="emby-button" icon="arrow-back" class="fab mini btnCloseDialog autoSize" tabindex="-1"><i class="md-icon">&#xE5C4;</i></button>',u+='<div style="display:inline-block;margin-left:.6em;vertical-align:middle;">'+Globalize.translate("HeaderUploadImage")+"</div>",u+="</h2>",u+='<div class="editorContent" style="padding:0 1em;">',u+=Globalize.translateDocument(o),u+="</div>",i.innerHTML=u,document.body.appendChild(i),a(i).on("close",s),e.open(i);var c=i.querySelector(".editorContent");r(c),a("#selectImageType",i).val(n.imageType||"Primary"),a(".btnCloseDialog",i).on("click",function(){e.close(i)})},o.send()}function s(){a(this).remove(),Dashboard.hideLoadingMsg(),c.resolveWith(null,[g])}var d,u,c,g=!1;return{show:function(e,a){var t=jQuery.Deferred();return c=t,g=!1,l(e,a),t.promise()}}});