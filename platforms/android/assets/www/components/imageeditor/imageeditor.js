define(["dialogHelper","css!css/metadataeditor.css","emby-button","paper-fab","paper-icon-button-light"],function(e){function t(){var e={};return e.itemId=m.Id,e}function n(e,t){Dashboard.showLoadingMsg(),t?a(e,t):ApiClient.getItem(Dashboard.getCurrentUserId(),m.Id).then(function(t){a(e,t)})}function i(e,t,n){for(var i=0,a=e.length;a>i;i++)e[i].addEventListener(t,n)}function a(e,n){m=n,ApiClient.getRemoteImageProviders(t()).then(function(t){for(var i=e.querySelectorAll(".btnBrowseAllImages"),a=0,o=i.length;o>a;a++)t.length?i[a].classList.remove("hide"):i[a].classList.add("hide");ApiClient.getItemImageInfos(m.Id).then(function(i){r(e,n,i,t),l(e,n,i,t),c(e,n,i,t),Dashboard.hideLoadingMsg()})})}function o(e,t,a,o,r){for(var l="",c=0,d=a.length;d>c;c++){var u=a[c];l+='<div class="editorTile imageEditorTile">',l+='<div class="editorTileInner">';var g=150;l+='<div style="height:'+g+'px;vertical-align:top;background-repeat:no-repeat;background-position:center bottom;background-size:contain;" class="lazy" data-src="'+LibraryBrowser.getImageUrl(m,u.ImageType,u.ImageIndex,{height:g})+'"></div>',l+='<div class="editorTileFooter">',"Backdrop"!==u.ImageType&&"Screenshot"!==u.ImageType&&(l+="<h3>"+u.ImageType+"</h3>"),l+=u.Width&&u.Height?"<p>"+u.Width+" X "+u.Height+"</p>":"<p>&nbsp;</p>",l+="<div>","Backdrop"==u.ImageType||"Screenshot"==u.ImageType?(l+=c>0?'<button is="paper-icon-button-light"" class="btnMoveImage" data-imagetype="'+u.ImageType+'" data-index="'+u.ImageIndex+'" data-newindex="'+(u.ImageIndex-1)+'" title="'+Globalize.translate("ButtonMoveLeft")+'"><iron-icon icon="chevron-left"></iron-icon></button>':'<button is="paper-icon-button-light"" disabled title="'+Globalize.translate("ButtonMoveLeft")+'"><iron-icon icon="chevron-left"></iron-icon></button>',l+=d-1>c?'<button is="paper-icon-button-light"" class="btnMoveImage" data-imagetype="'+u.ImageType+'" data-index="'+u.ImageIndex+'" data-newindex="'+(u.ImageIndex+1)+'" title="'+Globalize.translate("ButtonMoveRight")+'"><iron-icon icon="chevron-right"></iron-icon></button>':'<button is="paper-icon-button-light"" disabled title="'+Globalize.translate("ButtonMoveRight")+'"><iron-icon icon="chevron-right"></iron-icon></button>'):o.length&&(l+='<button is="paper-icon-button-light"" data-imagetype="'+u.ImageType+'" class="btnSearchImages" title="'+Globalize.translate("ButtonBrowseOnlineImages")+'"><iron-icon icon="search"></iron-icon></button>'),l+='<button is="paper-icon-button-light"" data-imagetype="'+u.ImageType+'" data-index="'+(null!=u.ImageIndex?u.ImageIndex:"null")+'" class="btnDeleteImage" title="'+Globalize.translate("Delete")+'"><iron-icon icon="delete"></iron-icon></button>',l+="</div>",l+="</div>",l+="</div>",l+="</div>"}r.innerHTML=l,ImageLoader.lazyChildren(r),i(r.querySelectorAll(".btnSearchImages"),"click",function(){s(e,this.getAttribute("data-imagetype"))}),i(r.querySelectorAll(".btnDeleteImage"),"click",function(){var t=this.getAttribute("data-imagetype"),i=this.getAttribute("data-index");i="null"==i?null:parseInt(i),require(["confirm"],function(a){a(Globalize.translate("DeleteImageConfirmation"),Globalize.translate("HeaderDeleteImage")).then(function(){ApiClient.deleteItemImage(m.Id,t,i).then(function(){h=!0,n(e)})})})}),i(r.querySelectorAll(".btnMoveImage"),"click",function(){var t=this.getAttribute("data-imagetype"),i=parseInt(this.getAttribute("data-index")),a=parseInt(this.getAttribute("data-newindex"));ApiClient.updateItemImageIndex(m.Id,t,i,a).then(function(){h=!0,n(e)})})}function r(e,t,n,i){var a=n.filter(function(e){return"Screenshot"!=e.ImageType&&"Backdrop"!=e.ImageType&&"Chapter"!=e.ImageType});o(e,t,a,i,e.querySelector("#images"))}function l(e,t,n,i){var a=n.filter(function(e){return"Backdrop"==e.ImageType}).sort(function(e,t){return e.ImageIndex-t.ImageIndex});a.length?(e.querySelector("#backdropsContainer",e).classList.remove("hide"),o(e,t,a,i,e.querySelector("#backdrops"))):e.querySelector("#backdropsContainer",e).classList.add("hide")}function c(e,t,n,i){var a=n.filter(function(e){return"Screenshot"==e.ImageType}).sort(function(e,t){return e.ImageIndex-t.ImageIndex});a.length?(e.querySelector("#screenshotsContainer",e).classList.remove("hide"),o(e,t,a,i,e.querySelector("#screenshots"))):e.querySelector("#screenshotsContainer",e).classList.add("hide")}function s(e,t){require(["components/imagedownloader/imagedownloader"],function(i){i.show(m.Id,m.Type,t).then(function(t){t&&(h=!0,n(e))})})}function d(e,t){i(e.querySelectorAll(".btnOpenUploadMenu"),"click",function(){var i=this.getAttribute("data-imagetype");require(["components/imageuploader/imageuploader"],function(a){a.show(m.Id,{theme:t.theme,imageType:i}).then(function(t){t&&(h=!0,n(e))})})}),i(e.querySelectorAll(".btnBrowseAllImages"),"click",function(){s(e,this.getAttribute("data-imagetype")||"Primary")})}function u(t,i){i=i||{},Dashboard.showLoadingMsg();var a=new XMLHttpRequest;a.open("GET","components/imageeditor/imageeditor.template.html",!0),a.onload=function(){var a=this.response;ApiClient.getItem(Dashboard.getCurrentUserId(),t).then(function(t){var o=e.createDialog({size:"fullscreen-border",removeOnClose:!0}),r=i.theme||"b";o.classList.add("ui-body-"+r),o.classList.add("background-theme-"+r),o.classList.add("popupEditor");var l="";l+='<h2 class="dialogHeader">',l+='<button type="button" is="emby-button" icon="arrow-back" class="fab mini btnCloseDialog" tabindex="-1"><iron-icon icon="arrow-back"></iron-icon></button>',l+='<div style="display:inline-block;margin-left:.6em;vertical-align:middle;">'+t.Name+"</div>",l+="</h2>",l+='<div class="editorContent">',l+=Globalize.translateDocument(a),l+="</div>",o.innerHTML=l,document.body.appendChild(o),d(o,i),o.addEventListener("close",g),e.open(o);var c=o.querySelector(".editorContent");n(c,t),o.querySelector(".btnCloseDialog").addEventListener("click",function(){e.close(o)})})},a.send()}function g(){Dashboard.hideLoadingMsg(),p.resolveWith(null,[h])}var m,p,h=!1;return{show:function(e,t){var n=jQuery.Deferred();return p=n,h=!1,u(e,t),n.promise()}}});