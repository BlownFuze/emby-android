define(["dialogHelper","jQuery","css!css/metadataeditor.css","emby-button","paper-fab","paper-icon-button-light"],function(e,t){function n(){var e={};return e.itemId=m.Id,e}function i(e,t){Dashboard.showLoadingMsg(),t?o(e,t):ApiClient.getItem(Dashboard.getCurrentUserId(),m.Id).then(function(t){o(e,t)})}function o(e,i){m=i,ApiClient.getRemoteImageProviders(n()).then(function(n){n.length?t(".btnBrowseAllImages",e).removeClass("hide"):t(".btnBrowseAllImages",e).addClass("hide"),ApiClient.getItemImageInfos(m.Id).then(function(t){r(e,i,t,n),l(e,i,t,n),s(e,i,t,n),Dashboard.hideLoadingMsg()})})}function a(e,n,o,a,r){for(var l="",s=0,c=o.length;c>s;s++){var g=o[s];l+='<div class="editorTile imageEditorTile">',l+='<div class="editorTileInner">';var u=150;l+='<div style="height:'+u+'px;vertical-align:top;background-repeat:no-repeat;background-position:center bottom;background-size:contain;" class="lazy" data-src="'+LibraryBrowser.getImageUrl(m,g.ImageType,g.ImageIndex,{height:u})+'"></div>',l+='<div class="editorTileFooter">',"Backdrop"!==g.ImageType&&"Screenshot"!==g.ImageType&&(l+="<h3>"+g.ImageType+"</h3>"),l+=g.Width&&g.Height?"<p>"+g.Width+" X "+g.Height+"</p>":"<p>&nbsp;</p>",l+="<div>","Backdrop"==g.ImageType||"Screenshot"==g.ImageType?(l+=s>0?'<button is="paper-icon-button-light"" class="btnMoveImage" data-imagetype="'+g.ImageType+'" data-index="'+g.ImageIndex+'" data-newindex="'+(g.ImageIndex-1)+'" title="'+Globalize.translate("ButtonMoveLeft")+'"><iron-icon icon="chevron-left"></iron-icon></button>':'<button is="paper-icon-button-light"" disabled title="'+Globalize.translate("ButtonMoveLeft")+'"><iron-icon icon="chevron-left"></iron-icon></button>',l+=c-1>s?'<button is="paper-icon-button-light"" class="btnMoveImage" data-imagetype="'+g.ImageType+'" data-index="'+g.ImageIndex+'" data-newindex="'+(g.ImageIndex+1)+'" title="'+Globalize.translate("ButtonMoveRight")+'"><iron-icon icon="chevron-right"></iron-icon></button>':'<button is="paper-icon-button-light"" disabled title="'+Globalize.translate("ButtonMoveRight")+'"><iron-icon icon="chevron-right"></iron-icon></button>'):a.length&&(l+='<button is="paper-icon-button-light"" data-imagetype="'+g.ImageType+'" class="btnSearchImages" title="'+Globalize.translate("ButtonBrowseOnlineImages")+'"><iron-icon icon="search"></iron-icon></button>'),l+='<button is="paper-icon-button-light"" data-imagetype="'+g.ImageType+'" data-index="'+(null!=g.ImageIndex?g.ImageIndex:"null")+'" class="btnDeleteImage" title="'+Globalize.translate("Delete")+'"><iron-icon icon="delete"></iron-icon></button>',l+="</div>",l+="</div>",l+="</div>",l+="</div>"}r.innerHTML=l,ImageLoader.lazyChildren(r),t(".btnSearchImages",r).on("click",function(){d(e,this.getAttribute("data-imagetype"))}),t(".btnDeleteImage",r).on("click",function(){var t=this.getAttribute("data-imagetype"),n=this.getAttribute("data-index");n="null"==n?null:parseInt(n),require(["confirm"],function(o){o(Globalize.translate("DeleteImageConfirmation"),Globalize.translate("HeaderDeleteImage")).then(function(){ApiClient.deleteItemImage(m.Id,t,n).then(function(){h=!0,i(e)})})})}),t(".btnMoveImage",r).on("click",function(){var t=this.getAttribute("data-imagetype"),n=parseInt(this.getAttribute("data-index")),o=parseInt(this.getAttribute("data-newindex"));ApiClient.updateItemImageIndex(m.Id,t,n,o).then(function(){h=!0,i(e)})})}function r(e,t,n,i){var o=n.filter(function(e){return"Screenshot"!=e.ImageType&&"Backdrop"!=e.ImageType&&"Chapter"!=e.ImageType});a(e,t,o,i,e.querySelector("#images"))}function l(e,n,i,o){var r=i.filter(function(e){return"Backdrop"==e.ImageType}).sort(function(e,t){return e.ImageIndex-t.ImageIndex});r.length?(t("#backdropsContainer",e).show(),a(e,n,r,o,e.querySelector("#backdrops"))):t("#backdropsContainer",e).hide()}function s(e,n,i,o){var r=i.filter(function(e){return"Screenshot"==e.ImageType}).sort(function(e,t){return e.ImageIndex-t.ImageIndex});r.length?(t("#screenshotsContainer",e).show(),a(e,n,r,o,e.querySelector("#screenshots"))):t("#screenshotsContainer",e).hide()}function d(e,t){require(["components/imagedownloader/imagedownloader"],function(n){n.show(m.Id,m.Type,t).then(function(t){t&&(h=!0,i(e))})})}function c(e,n){t(".btnOpenUploadMenu",e).on("click",function(){var t=this.getAttribute("data-imagetype");require(["components/imageuploader/imageuploader"],function(o){o.show(m.Id,{theme:n.theme,imageType:t}).then(function(t){t&&(h=!0,i(e))})})}),t(".btnBrowseAllImages",e).on("click",function(){d(e,this.getAttribute("data-imagetype")||"Primary")})}function g(n,o){o=o||{},Dashboard.showLoadingMsg();var a=new XMLHttpRequest;a.open("GET","components/imageeditor/imageeditor.template.html",!0),a.onload=function(){var a=this.response;ApiClient.getItem(Dashboard.getCurrentUserId(),n).then(function(n){var r=e.createDialog({size:"fullscreen-border"}),l=o.theme||"b";r.classList.add("ui-body-"+l),r.classList.add("background-theme-"+l),r.classList.add("popupEditor");var s="";s+='<h2 class="dialogHeader">',s+='<button type="button" is="emby-button" icon="arrow-back" class="fab mini btnCloseDialog" tabindex="-1"><iron-icon icon="arrow-back"></iron-icon></button>',s+='<div style="display:inline-block;margin-left:.6em;vertical-align:middle;">'+n.Name+"</div>",s+="</h2>",s+='<div class="editorContent">',s+=Globalize.translateDocument(a),s+="</div>",r.innerHTML=s,document.body.appendChild(r),c(r,o),t(r).on("close",u),e.open(r);var d=r.querySelector(".editorContent");i(d,n),t(".btnCloseDialog",r).on("click",function(){e.close(r)})})},a.send()}function u(){t(this).remove(),Dashboard.hideLoadingMsg(),p.resolveWith(null,[h])}var m,p,h=!1;return{show:function(e,t){var n=jQuery.Deferred();return p=n,h=!1,g(e,t),n.promise()}}});