define(["components/paperdialoghelper","css!css/metadataeditor.css"],function(){function e(){var e={};return e.itemId=g.Id,e}function t(e,t){Dashboard.showLoadingMsg(),t?n(e,t):ApiClient.getItem(Dashboard.getCurrentUserId(),g.Id).then(function(t){n(e,t)})}function n(t,n){g=n,ApiClient.getRemoteImageProviders(e()).then(function(e){e.length?$(".btnBrowseAllImages",t).removeClass("hide"):$(".btnBrowseAllImages",t).addClass("hide"),ApiClient.getItemImageInfos(g.Id).then(function(a){i(t,n,a,e),o(t,n,a,e),r(t,n,a,e),Dashboard.hideLoadingMsg()})})}function a(e,n,a,i,o){for(var r="",d=0,s=a.length;s>d;d++){var c=a[d];r+='<div class="editorTile imageEditorTile">',r+='<div class="editorTileInner">';var p=150;r+='<div style="height:'+p+'px;vertical-align:top;background-repeat:no-repeat;background-position:center bottom;background-size:contain;" class="lazy" data-src="'+LibraryBrowser.getImageUrl(g,c.ImageType,c.ImageIndex,{height:p})+'"></div>',r+='<div class="editorTileFooter">',"Backdrop"!==c.ImageType&&"Screenshot"!==c.ImageType&&(r+="<h3>"+c.ImageType+"</h3>"),r+=c.Width&&c.Height?"<p>"+c.Width+" X "+c.Height+"</p>":"<p>&nbsp;</p>",r+="<div>","Backdrop"==c.ImageType||"Screenshot"==c.ImageType?(r+=d>0?'<paper-icon-button class="btnMoveImage" icon="chevron-left" data-imagetype="'+c.ImageType+'" data-index="'+c.ImageIndex+'" data-newindex="'+(c.ImageIndex-1)+'" title="'+Globalize.translate("ButtonMoveLeft")+'"></paper-icon-button>':'<paper-icon-button icon="chevron-left" disabled title="'+Globalize.translate("ButtonMoveLeft")+'"></paper-icon-button>',r+=s-1>d?'<paper-icon-button class="btnMoveImage" icon="chevron-right" data-imagetype="'+c.ImageType+'" data-index="'+c.ImageIndex+'" data-newindex="'+(c.ImageIndex+1)+'" title="'+Globalize.translate("ButtonMoveRight")+'"></paper-icon-button>':'<paper-icon-button icon="chevron-right" disabled title="'+Globalize.translate("ButtonMoveRight")+'"></paper-icon-button>'):i.length&&(r+='<paper-icon-button icon="search" data-imagetype="'+c.ImageType+'" class="btnSearchImages" title="'+Globalize.translate("ButtonBrowseOnlineImages")+'"></paper-icon-button>'),r+='<paper-icon-button icon="delete" data-imagetype="'+c.ImageType+'" data-index="'+(null!=c.ImageIndex?c.ImageIndex:"null")+'" class="btnDeleteImage" title="'+Globalize.translate("Delete")+'"></paper-icon-button>',r+="</div>",r+="</div>",r+="</div>",r+="</div>"}o.innerHTML=r,ImageLoader.lazyChildren(o),$(".btnSearchImages",o).on("click",function(){l(e,this.getAttribute("data-imagetype"))}),$(".btnDeleteImage",o).on("click",function(){var n=this.getAttribute("data-imagetype"),a=this.getAttribute("data-index");a="null"==a?null:parseInt(a),Dashboard.confirm(Globalize.translate("DeleteImageConfirmation"),Globalize.translate("HeaderDeleteImage"),function(i){i&&ApiClient.deleteItemImage(g.Id,n,a).then(function(){m=!0,t(e)})})}),$(".btnMoveImage",o).on("click",function(){var n=this.getAttribute("data-imagetype"),a=parseInt(this.getAttribute("data-index")),i=parseInt(this.getAttribute("data-newindex"));ApiClient.updateItemImageIndex(g.Id,n,a,i).then(function(){m=!0,t(e)})})}function i(e,t,n,i){var o=n.filter(function(e){return"Screenshot"!=e.ImageType&&"Backdrop"!=e.ImageType&&"Chapter"!=e.ImageType});a(e,t,o,i,e.querySelector("#images"))}function o(e,t,n,i){var o=n.filter(function(e){return"Backdrop"==e.ImageType}).sort(function(e,t){return e.ImageIndex-t.ImageIndex});o.length?($("#backdropsContainer",e).show(),a(e,t,o,i,e.querySelector("#backdrops"))):$("#backdropsContainer",e).hide()}function r(e,t,n,i){var o=n.filter(function(e){return"Screenshot"==e.ImageType}).sort(function(e,t){return e.ImageIndex-t.ImageIndex});o.length?($("#screenshotsContainer",e).show(),a(e,t,o,i,$("#screenshots",e))):$("#screenshotsContainer",e).hide()}function l(e,n){require(["components/imagedownloader/imagedownloader"],function(a){a.show(g.Id,g.Type,n).then(function(n){n&&(m=!0,t(e))})})}function d(e,n){$(".btnOpenUploadMenu",e).on("click",function(){require(["components/imageuploader/imageuploader"],function(){ImageUploader.show(g.Id,{theme:n.theme}).then(function(n){n&&(m=!0,t(e))})})}),$(".btnBrowseAllImages",e).on("click",function(){l(e,this.getAttribute("data-imagetype")||"Primary")})}function s(e,n){n=n||{},Dashboard.showLoadingMsg();var a=new XMLHttpRequest;a.open("GET","components/imageeditor/imageeditor.template.html",!0),a.onload=function(){var a=this.response;ApiClient.getItem(Dashboard.getCurrentUserId(),e).then(function(e){var i=PaperDialogHelper.createDialog({theme:n.theme}),o="";o+='<h2 class="dialogHeader">',o+='<paper-fab icon="arrow-back" mini class="btnCloseDialog"></paper-fab>',o+='<div style="display:inline-block;margin-left:.6em;vertical-align:middle;">'+e.Name+"</div>",o+="</h2>",o+='<div class="editorContent">',o+=Globalize.translateDocument(a),o+="</div>",i.innerHTML=o,document.body.appendChild(i),d(i,n),$(i).on("iron-overlay-closed",c),PaperDialogHelper.openWithHash(i,"imageeditor");var r=i.querySelector(".editorContent");t(r,e),$(".btnCloseDialog",i).on("click",function(){PaperDialogHelper.close(i)})})},a.send()}function c(){$(this).remove(),Dashboard.hideLoadingMsg(),p.resolveWith(null,[m])}var g,p,m=!1;return{show:function(e,t){var n=DeferredBuilder.Deferred();return p=n,m=!1,s(e,t),n.promise()}}});