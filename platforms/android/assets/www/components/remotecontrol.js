define(["browser","datetime","jQuery","libraryBrowser","paper-fab","paper-slider"],function(e,t,n,a){function r(e,t,n,a,r){var i=(a.MediaStreams||[]).filter(function(e){return"Audio"==e.Type}),o=i.map(function(e){var t=(e.Codec||"").toUpperCase();e.Profile&&(t+=" "+e.Profile),e.Language&&(t+=" · "+e.Language),e.Layout?t+=" · "+e.Layout:e.Channels&&(t+=" · "+e.Channels+" ch");var n={name:t,id:e.Index};return e.Index==r&&(n.ironIcon="check"),n});require(["actionsheet"],function(e){e.show({items:o,positionTo:n,callback:function(e){t.setAudioStreamIndex(parseInt(e))}})})}function i(e,t,n,a,r){var i=(a.MediaStreams||[]).filter(function(e){return"Subtitle"==e.Type}),o=i.map(function(e){var t=e.Language||Globalize.translate("LabelUnknownLanguage");e.IsDefault&&e.IsForced?t+=" · "+Globalize.translate("LabelDefaultForcedStream"):e.IsDefault?t+=" · "+Globalize.translate("LabelDefaultStream"):e.IsForced&&(t+=" · "+Globalize.translate("LabelForcedStream")),e.Codec&&(t+=" · "+e.Codec.toUpperCase());var n={name:t,id:e.Index};return e.Index==r&&(n.ironIcon="check"),n});o.unshift({id:-1,name:Globalize.translate("ButtonOff"),ironIcon:null==r?"check":null}),require(["actionsheet"],function(e){e.show({items:o,positionTo:n,callback:function(e){t.setSubtitleStreamIndex(parseInt(e))}})})}function o(e){e.classList.remove("hide")}function l(e){e.classList.add("hide")}function s(e,t){return e&&e.MediaStreams&&e.MediaStreams.filter(function(e){return e.Type==t}).length>0}function c(t,n){var r=n.NowPlayingItem,i=r?MediaController.getNowPlayingNameHtml(r).replace("<br/>"," - "):"";t.querySelector(".nowPlayingPageTitle").innerHTML=i,i.length>0?t.querySelector(".nowPlayingPageTitle").classList.remove("hide"):t.querySelector(".nowPlayingPageTitle").classList.add("hide");var o,l=null;r&&(r.PrimaryImageTag?o=ApiClient.getScaledImageUrl(r.PrimaryImageItemId,{type:"Primary",maxHeight:300,tag:r.PrimaryImageTag}):r.BackdropImageTag?o=ApiClient.getScaledImageUrl(r.BackdropItemId,{type:"Backdrop",maxHeight:300,tag:r.BackdropImageTag,index:0}):r.ThumbImageTag&&(o=ApiClient.getScaledImageUrl(r.ThumbImageItemId,{type:"Thumb",maxHeight:300,tag:r.ThumbImageTag}))),o!=m&&(r&&r.BackdropImageTag&&(l=ApiClient.getScaledImageUrl(r.BackdropItemId,{type:"Backdrop",maxHeight:300,tag:r.BackdropImageTag,index:0})),u(t,o),r?(e.mobile||require(["backdrop"],function(e){e.setBackdrop(l)}),ApiClient.getItem(Dashboard.getCurrentUserId(),r.Id).then(function(e){t.querySelector(".nowPlayingPageUserDataButtons").innerHTML=a.getUserDataIconsHtml(e,!1)})):t.querySelector(".nowPlayingPageUserDataButtons").innerHTML="")}function u(e,t){m=t,t?ImageLoader.lazyImage(e.querySelector(".nowPlayingPageImage"),t):e.querySelector(".nowPlayingPageImage").style.backgroundImage=""}function d(e,t){e.disabled=!t}function g(e,t){for(var n=e.querySelectorAll(".btnCommand"),a=0,r=n.length;r>a;a++)d(n[a],-1!=t.indexOf(n[a].getAttribute("data-command")))}function y(){}var m;return function(){function e(e){if(e&&N){var t=N;switch((t.PlayState||{}).RepeatMode){case"RepeatNone":e.setRepeatMode("RepeatAll");break;case"RepeatAll":e.setRepeatMode("RepeatOne");break;case"RepeatOne":e.setRepeatMode("RepeatNone")}}}function u(e,n){N=n;var a=n.NowPlayingItem,r=MediaController.getPlayerInfo(),i=r.supportedCommands,u=n.PlayState||{};d(e.querySelector(".btnToggleFullscreen"),a&&"Video"==a.MediaType&&-1!=i.indexOf("ToggleFullscreen")),d(e.querySelector(".btnAudioTracks"),s(a,"Audio")&&-1!=i.indexOf("SetAudioStreamIndex")),d(e.querySelector(".btnSubtitles"),s(a,"Subtitle")&&-1!=i.indexOf("SetSubtitleStreamIndex")),a&&a.Chapters&&a.Chapters.length&&u.CanSeek?d(e.querySelector(".btnChapters"),!0):(d(e.querySelector(".btnChapters"),!1),y(e)),-1!=i.indexOf("DisplayMessage")?e.querySelector(".sendMessageSection").classList.remove("hide"):e.querySelector(".sendMessageSection").classList.add("hide"),-1!=i.indexOf("SendString")?e.querySelector(".sendTextSection").classList.remove("hide"):e.querySelector(".sendTextSection").classList.add("hide"),d(e.querySelector(".btnStop"),null!=a),d(e.querySelector(".btnNextTrack"),null!=a),d(e.querySelector(".btnPreviousTrack"),null!=a);var g=e.querySelector(".btnPause"),m=e.querySelector(".btnPlay");d(g,null!=a),d(m,null!=a),u.IsPaused?(l(g),o(m)):(o(g),l(m));var p=e.querySelector(".nowPlayingPositionSlider");if(!p.dragging){if(a&&a.RunTimeTicks){var f=u.PositionTicks/a.RunTimeTicks;f*=100,p.value=f}else p.value=0;p.disabled=!u.CanSeek}e.querySelector(".positionTime").innerHTML=null==u.PositionTicks?"--:--":t.getDisplayRunningTime(u.PositionTicks),e.querySelector(".runtime").innerHTML=a&&null!=a.RunTimeTicks?t.getDisplayRunningTime(a.RunTimeTicks):"--:--",a&&"Video"==a.MediaType?e.classList.remove("hideVideoButtons"):e.classList.add("hideVideoButtons"),r.isLocalPlayer&&AppInfo.hasPhysicalVolumeButtons?e.classList.add("hideVolumeButtons"):e.classList.remove("hideVolumeButtons"),a&&"Audio"==a.MediaType?e.querySelector(".buttonsRow2").classList.add("hide"):e.querySelector(".buttonsRow2").classList.remove("hide");var v=e.querySelector(".repeatToggleButton");"RepeatAll"==u.RepeatMode?(v.icon="repeat",v.classList.add("nowPlayingPageRepeatActive")):"RepeatOne"==u.RepeatMode?(v.icon="repeat-one",v.classList.add("nowPlayingPageRepeatActive")):(v.icon="repeat",v.classList.remove("nowPlayingPageRepeatActive")),c(e,n)}function p(e){var t="",n=f(e);n&&(t+=a.getListViewHtml({items:MediaController.playlist(),smallIcon:!0}),H=!1);var r=[];n&&(r.push("paper-icon-item"),r.push("paper-item-body")),require(r,function(){var a=e.querySelector(".playlist");if(a.innerHTML=t,n){var r=MediaController.currentPlaylistIndex();if(-1!=r){var i=a.querySelectorAll(".listItem")[r];if(i){var o=i.querySelector(".listviewImage");o.classList.remove("lazy"),o.classList.add("playlistIndexIndicatorImage")}}}ImageLoader.lazyChildren(a)})}function f(e){return 2==a.selectedTab(e.querySelector(".mdl-tabs"))}function v(e,t){if("positionchange"==e.type){var n=(new Date).getTime();if(700>n-B)return;B=n}u(R,t)}function S(e,t){var n=this;n.beginPlayerUpdates(),v.call(n,e,t),f(R)?p(R):H=!0}function P(e){var t=this;t.endPlayerUpdates(),v.call(t,e,{}),f(R)?p(R):H=!0}function b(){E&&(Events.off(E,"playbackstart",S),Events.off(E,"playbackstop",P),Events.off(E,"volumechange",v),Events.off(E,"playstatechange",v),Events.off(E,"positionchange",v),E.endPlayerUpdates(),E=null)}function I(e,t){b(),E=t,t.getPlayerState().then(function(e){e.NowPlayingItem&&t.beginPlayerUpdates(),v.call(t,{type:"init"},e)}),Events.on(t,"playbackstart",S),Events.on(t,"playbackstop",P),Events.on(t,"volumechange",v),Events.on(t,"playstatechange",v),Events.on(t,"positionchange",v);var n=MediaController.getPlayerInfo(),a=n.supportedCommands;g(e,a)}function T(e){var t=MediaController.getPlayerInfo(),n=e.querySelector(".nowPlayingCastIcon");t.isLocalPlayer?(n.querySelector("iron-icon").icon="cast",n.classList.remove("btnActiveCast"),e.querySelector(".nowPlayingSelectedPlayer").innerHTML=""):(n.querySelector("iron-icon").icon="cast-connected",n.classList.add("btnActiveCast"),e.querySelector(".nowPlayingSelectedPlayer").innerHTML=t.deviceName||t.name)}function h(e,t){for(;!e.classList||!e.classList.contains(t);)if(e=e.parentNode,!e)return null;return e}function L(e){var t=h(e.target,"lnkPlayFromIndex");if(null!=t){var n=parseInt(t.getAttribute("data-index"));return MediaController.currentPlaylistIndex(n),p(context),e.preventDefault(),e.stopPropagation(),!1}var r=h(e.target,"lnkRemoveFromPlaylist");if(null!=r){var n=parseInt(r.getAttribute("data-index"));return MediaController.removeFromPlaylist(n),p(context),e.preventDefault(),e.stopPropagation(),!1}var i=h(e.target,"mediaItem");if(null!=i){var o=a.getListItemInfo(i);return MediaController.currentPlaylistIndex(o.index),e.preventDefault(),e.stopPropagation(),!1}}function q(a){n(".btnCommand",a).on("click",function(){E&&(this.classList.contains("repeatToggleButton")?e(E):MediaController.sendCommand({Name:this.getAttribute("data-command")},E))}),a.querySelector(".btnToggleFullscreen").addEventListener("click",function(e){E&&MediaController.sendCommand({Name:e.target.getAttribute("data-command")},E)}),a.querySelector(".btnAudioTracks").addEventListener("click",function(e){if(E&&N&&N.PlayState){var t=N.PlayState.AudioStreamIndex;r(a,E,e.target,N.NowPlayingItem,t)}}),a.querySelector(".btnSubtitles").addEventListener("click",function(e){if(E&&N&&N.PlayState){var t=N.PlayState.SubtitleStreamIndex;i(a,E,e.target,N.NowPlayingItem,t)}}),a.querySelector(".btnChapters").addEventListener("click",function(){}),a.querySelector(".btnStop").addEventListener("click",function(){E&&E.stop()}),a.querySelector(".btnPlay").addEventListener("click",function(){E&&E.unpause()}),a.querySelector(".btnPause").addEventListener("click",function(){E&&E.pause()}),a.querySelector(".btnNextTrack").addEventListener("click",function(){E&&E.nextTrack()}),a.querySelector(".btnPreviousTrack").addEventListener("click",function(){E&&E.previousTrack()}),a.querySelector(".nowPlayingPositionSlider").addEventListener("change",function(){var e=this.value;if(E&&N){var t=parseFloat(e),n=t/100*N.NowPlayingItem.RunTimeTicks;E.seek(Math.floor(n))}}),a.querySelector(".nowPlayingPositionSlider",a)._setPinValue=function(e){var n=N;if(!n||!n.NowPlayingItem||!n.NowPlayingItem.RunTimeTicks)return void(this.pinValue="--:--");var a=n.NowPlayingItem.RunTimeTicks;a/=100,a*=e,this.pinValue=t.getDisplayRunningTime(a)},a.addEventListener("click",L)}function k(){var e=R;T(e),I(e,MediaController.getCurrentPlayer())}function C(e){var t=e.target;return MediaController.sendCommand({Name:"DisplayMessage",Arguments:{Header:n("#txtMessageTitle",t).val(),Text:n("#txtMessageText",t).val()}},E),n("input",t).val(""),require(["toast"],function(e){e("Message sent.")}),e.preventDefault(),e.stopPropagation(),!1}function M(e){var t=e.target;return MediaController.sendCommand({Name:"SendString",Arguments:{String:n("#txtTypeText",t).val()}},E),n("input",t).val(""),require(["toast"],function(e){e("Text sent.")}),e.preventDefault(),e.stopPropagation(),!1}function x(e,t){require(["css!css/nowplaying.css"]),q(t),t.querySelector(".sendMessageForm").addEventListener("submit",C),t.querySelector(".typeTextForm").addEventListener("submit",M),t.querySelector(".nowPlayingCastIcon").addEventListener("click",function(){MediaController.showPlayerSelection()}),t.querySelector(".btnExitRemoteControl").addEventListener("click",function(){history.back()});var r=t.querySelector(".mdl-tabs");AppInfo.enableNowPlayingPageBottomTabs?t.querySelector(".libraryViewNav").classList.add("bottom"):t.querySelector(".libraryViewNav").classList.remove("bottom"),a.configurePaperLibraryTabs(e,r),r.addEventListener("tabchange",function(e){2==e.detail.selectedTabIndex&&H&&p(t)}),Events.on(MediaController,"playerchange",k),n(t.querySelector(".itemsContainer")).createCardMenus()}function w(){b(),Events.off(MediaController,"playerchange",k),N=null}function A(e){m=null,I(e,MediaController.getCurrentPlayer()),T(e)}var R,E,N,B=0,D=this,H=!0;D.init=function(e,t){R=t,AppInfo.enableNowPlayingPageBottomTabs||(t.querySelector(".btnExitRemoteControl").style.position="relative",t.querySelector(".topRightContainer").style.position="relative"),componentHandler.upgradeAllRegistered(R),x(e,R)},D.onShow=function(){A(R,window.location.hash)},D.destroy=function(){w()}}});