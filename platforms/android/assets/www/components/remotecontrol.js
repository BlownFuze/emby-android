define(["browser","datetime","libraryBrowser","listView","userdataButtons","cardStyle"],function(e,t,n,a,r){function i(e,t,n,a,r){var i=(a.MediaStreams||[]).filter(function(e){return"Audio"==e.Type}),o=i.map(function(e){var t=(e.Codec||"").toUpperCase();e.Profile&&(t+=" "+e.Profile),e.Language&&(t+=" · "+e.Language),e.Layout?t+=" · "+e.Layout:e.Channels&&(t+=" · "+e.Channels+" ch");var n={name:e.DisplayTitle||t,id:e.Index};return e.Index==r&&(n.selected=!0),n});require(["actionsheet"],function(e){e.show({items:o,positionTo:n,callback:function(e){t.setAudioStreamIndex(parseInt(e))}})})}function o(e,t,n,a,r){var i=(a.MediaStreams||[]).filter(function(e){return"Subtitle"==e.Type}),o=i.map(function(e){var t=e.Language||Globalize.translate("LabelUnknownLanguage");e.IsDefault&&e.IsForced?t+=" · "+Globalize.translate("LabelDefaultForcedStream"):e.IsDefault?t+=" · "+Globalize.translate("LabelDefaultStream"):e.IsForced&&(t+=" · "+Globalize.translate("LabelForcedStream")),e.Codec&&(t+=" · "+e.Codec.toUpperCase());var n={name:e.DisplayTitle||t,id:e.Index};return e.Index==r&&(n.selected=!0),n});o.unshift({id:-1,name:Globalize.translate("ButtonOff"),selected:null==r}),require(["actionsheet"],function(e){e.show({items:o,positionTo:n,callback:function(e){t.setSubtitleStreamIndex(parseInt(e))}})})}function l(e){e.classList.remove("hide")}function s(e){e.classList.add("hide")}function c(e,t){return e&&e.MediaStreams&&e.MediaStreams.filter(function(e){return e.Type==t}).length>0}function u(t,n){var a=n.NowPlayingItem,i=a?MediaController.getNowPlayingNameHtml(a).replace("<br/>"," - "):"";t.querySelector(".nowPlayingPageTitle").innerHTML=i,i.length>0?t.querySelector(".nowPlayingPageTitle").classList.remove("hide"):t.querySelector(".nowPlayingPageTitle").classList.add("hide");var o,l=null;a&&(a.PrimaryImageTag?o=ApiClient.getScaledImageUrl(a.PrimaryImageItemId,{type:"Primary",maxHeight:300,tag:a.PrimaryImageTag}):a.BackdropImageTag?o=ApiClient.getScaledImageUrl(a.BackdropItemId,{type:"Backdrop",maxHeight:300,tag:a.BackdropImageTag,index:0}):a.ThumbImageTag&&(o=ApiClient.getScaledImageUrl(a.ThumbImageItemId,{type:"Thumb",maxHeight:300,tag:a.ThumbImageTag}))),o!=p&&(a&&a.BackdropImageTag&&(l=ApiClient.getScaledImageUrl(a.BackdropItemId,{type:"Backdrop",maxHeight:300,tag:a.BackdropImageTag,index:0})),d(t,o),a?(e.mobile||require(["backdrop"],function(e){e.setBackdrop(l)}),ApiClient.getItem(Dashboard.getCurrentUserId(),a.Id).then(function(e){t.querySelector(".nowPlayingPageUserDataButtons").innerHTML=r.getIconsHtml({item:e,includePlayed:!1,style:"fab-mini"})})):t.querySelector(".nowPlayingPageUserDataButtons").innerHTML="")}function d(e,t){p=t,t?ImageLoader.lazyImage(e.querySelector(".nowPlayingPageImage"),t):e.querySelector(".nowPlayingPageImage").style.backgroundImage=""}function y(e,t){e.disabled=!t}function g(e,t){for(var n=e.querySelectorAll(".btnCommand"),a=0,r=n.length;r>a;a++)y(n[a],-1!=t.indexOf(n[a].getAttribute("data-command")))}function m(){}var p;return function(){function e(e){if(e&&R){var t=R;switch((t.PlayState||{}).RepeatMode){case"RepeatNone":e.setRepeatMode("RepeatAll");break;case"RepeatAll":e.setRepeatMode("RepeatOne");break;case"RepeatOne":e.setRepeatMode("RepeatNone")}}}function r(e,n){R=n;var a=n.NowPlayingItem,r=MediaController.getPlayerInfo(),i=r.supportedCommands,o=n.PlayState||{};y(e.querySelector(".btnToggleFullscreen"),a&&"Video"==a.MediaType&&-1!=i.indexOf("ToggleFullscreen")),y(e.querySelector(".btnAudioTracks"),c(a,"Audio")&&-1!=i.indexOf("SetAudioStreamIndex")),y(e.querySelector(".btnSubtitles"),c(a,"Subtitle")&&-1!=i.indexOf("SetSubtitleStreamIndex")),a&&a.Chapters&&a.Chapters.length&&o.CanSeek?y(e.querySelector(".btnChapters"),!0):(y(e.querySelector(".btnChapters"),!1),m(e)),-1!=i.indexOf("DisplayMessage")?e.querySelector(".sendMessageSection").classList.remove("hide"):e.querySelector(".sendMessageSection").classList.add("hide"),-1!=i.indexOf("SendString")?e.querySelector(".sendTextSection").classList.remove("hide"):e.querySelector(".sendTextSection").classList.add("hide"),y(e.querySelector(".btnStop"),null!=a),y(e.querySelector(".btnNextTrack"),null!=a),y(e.querySelector(".btnPreviousTrack"),null!=a);var d=e.querySelector(".btnPause"),g=e.querySelector(".btnPlay");y(d,null!=a),y(g,null!=a),o.IsPaused?(s(d),l(g)):(l(d),s(g));var p=e.querySelector(".nowPlayingPositionSlider");if(!p.dragging){if(a&&a.RunTimeTicks){var S=o.PositionTicks/a.RunTimeTicks;S*=100,p.value=S}else p.value=0;p.disabled=!o.CanSeek}e.querySelector(".positionTime").innerHTML=null==o.PositionTicks?"--:--":t.getDisplayRunningTime(o.PositionTicks),e.querySelector(".runtime").innerHTML=a&&null!=a.RunTimeTicks?t.getDisplayRunningTime(a.RunTimeTicks):"--:--",a&&"Video"==a.MediaType?e.classList.remove("hideVideoButtons"):e.classList.add("hideVideoButtons"),r.isLocalPlayer&&AppInfo.hasPhysicalVolumeButtons?e.classList.add("hideVolumeButtons"):e.classList.remove("hideVolumeButtons"),a&&"Audio"==a.MediaType?e.querySelector(".buttonsRow2").classList.add("hide"):e.querySelector(".buttonsRow2").classList.remove("hide");var f=e.querySelector(".repeatToggleButton");"RepeatAll"==o.RepeatMode?(f.innerHTML="<i class='md-icon'>repeat</i>",f.classList.add("nowPlayingPageRepeatActive")):"RepeatOne"==o.RepeatMode?(f.innerHTML="<i class='md-icon'>repeat_one</i>",f.classList.add("nowPlayingPageRepeatActive")):(f.innerHTML="<i class='md-icon'>repeat</i>",f.classList.remove("nowPlayingPageRepeatActive")),u(e,n)}function d(e){var t="";t+=a.getListViewHtml({items:MediaController.playlist(),smallIcon:!0,action:"setplaylistindex"}),B=!1;var n=[];require(n,function(){var n=e.querySelector(".playlist");n.innerHTML=t;var a=MediaController.currentPlaylistIndex();if(-1!=a){var r=n.querySelectorAll(".listItem")[a];if(r){var i=r.querySelector(".listItemImage");i.classList.remove("lazy"),i.classList.add("playlistIndexIndicatorImage")}}ImageLoader.lazyChildren(n)})}function S(e,t){if("positionchange"==e.type){var n=(new Date).getTime();if(700>n-E)return;E=n}r(x,t)}function f(e,t){var n=this;n.beginPlayerUpdates(),S.call(n,e,t),d(x)}function v(e){var t=this;t.endPlayerUpdates(),S.call(t,e,{}),d(x)}function b(){A&&(Events.off(A,"playbackstart",f),Events.off(A,"playbackstop",v),Events.off(A,"volumechange",S),Events.off(A,"playstatechange",S),Events.off(A,"positionchange",S),A.endPlayerUpdates(),A=null)}function T(e,t){b(),A=t,t.getPlayerState().then(function(e){e.NowPlayingItem&&t.beginPlayerUpdates(),S.call(t,{type:"init"},e)}),Events.on(t,"playbackstart",f),Events.on(t,"playbackstop",v),Events.on(t,"volumechange",S),Events.on(t,"playstatechange",S),Events.on(t,"positionchange",S);var n=MediaController.getPlayerInfo(),a=n.supportedCommands;g(e,a)}function P(e){var t=MediaController.getPlayerInfo(),n=e.querySelector(".nowPlayingCastIcon");t.isLocalPlayer?(n.querySelector("i").innerHTML="cast",n.classList.remove("btnActiveCast"),e.querySelector(".nowPlayingSelectedPlayer").innerHTML=""):(n.querySelector("i").innerHTML="cast-connected",n.classList.add("btnActiveCast"),e.querySelector(".nowPlayingSelectedPlayer").innerHTML=t.deviceName||t.name)}function I(){A&&(this.classList.contains("repeatToggleButton")?e(A):MediaController.sendCommand({Name:this.getAttribute("data-command")},A))}function h(e){for(var n=e.querySelectorAll(".btnCommand"),a=0,r=n.length;r>a;a++)n[a].addEventListener("click",I);e.querySelector(".btnToggleFullscreen").addEventListener("click",function(e){A&&MediaController.sendCommand({Name:e.target.getAttribute("data-command")},A)}),e.querySelector(".btnAudioTracks").addEventListener("click",function(t){if(A&&R&&R.PlayState){var n=R.PlayState.AudioStreamIndex;i(e,A,t.target,R.NowPlayingItem,n)}}),e.querySelector(".btnSubtitles").addEventListener("click",function(t){if(A&&R&&R.PlayState){var n=R.PlayState.SubtitleStreamIndex;o(e,A,t.target,R.NowPlayingItem,n)}}),e.querySelector(".btnChapters").addEventListener("click",function(){}),e.querySelector(".btnStop").addEventListener("click",function(){A&&A.stop()}),e.querySelector(".btnPlay").addEventListener("click",function(){A&&A.unpause()}),e.querySelector(".btnPause").addEventListener("click",function(){A&&A.pause()}),e.querySelector(".btnNextTrack").addEventListener("click",function(){A&&A.nextTrack()}),e.querySelector(".btnPreviousTrack").addEventListener("click",function(){A&&A.previousTrack()}),e.querySelector(".nowPlayingPositionSlider").addEventListener("change",function(){var e=this.value;if(A&&R){var t=parseFloat(e),n=t/100*R.NowPlayingItem.RunTimeTicks;A.seek(Math.floor(n))}}),e.querySelector(".nowPlayingPositionSlider",e).getBubbleText=function(e){var n=R;if(!n||!n.NowPlayingItem||!n.NowPlayingItem.RunTimeTicks)return"--:--";var a=n.NowPlayingItem.RunTimeTicks;return a/=100,a*=e,t.getDisplayRunningTime(a)}}function q(){var e=x;P(e),T(e,MediaController.getCurrentPlayer())}function L(e){var t=e.target;return MediaController.sendCommand({Name:"DisplayMessage",Arguments:{Header:t.querySelector("#txtMessageTitle").value,Text:t.querySelector("#txtMessageText",t).value}},A),t.querySelector("input").value="",require(["toast"],function(e){e("Message sent.")}),e.preventDefault(),e.stopPropagation(),!1}function k(e){var t=e.target;return MediaController.sendCommand({Name:"SendString",Arguments:{String:t.querySelector("#txtTypeText",t).value}},A),t.querySelector("input").value="",require(["toast"],function(e){e("Text sent.")}),e.preventDefault(),e.stopPropagation(),!1}function C(e,t){require(["css!css/nowplaying.css"]),h(t),t.querySelector(".sendMessageForm").addEventListener("submit",L),t.querySelector(".typeTextForm").addEventListener("submit",k),t.querySelector(".nowPlayingCastIcon").addEventListener("click",function(){MediaController.showPlayerSelection()}),t.querySelector(".btnExitRemoteControl").addEventListener("click",function(){history.back()});var a=t.querySelector(".libraryViewNav");AppInfo.enableNowPlayingPageBottomTabs?t.querySelector(".libraryViewNav").classList.add("bottom"):t.querySelector(".libraryViewNav").classList.remove("bottom"),n.configurePaperLibraryTabs(e,a,e.querySelectorAll(".pageTabContent")),a.addEventListener("tabchange",function(e){2==e.detail.selectedTabIndex&&B&&d(t)}),Events.on(MediaController,"playerchange",q)}function M(){b(),Events.off(MediaController,"playerchange",q),R=null}function w(e){p=null,T(e,MediaController.getCurrentPlayer()),P(e)}var x,A,R,E=0,N=this,B=!0;N.init=function(e,t){x=t,AppInfo.enableNowPlayingPageBottomTabs||(t.querySelector(".btnExitRemoteControl").style.position="relative",t.querySelector(".topRightContainer").style.position="relative"),C(e,x)},N.onShow=function(){w(x,window.location.hash)},N.destroy=function(){M()}}});