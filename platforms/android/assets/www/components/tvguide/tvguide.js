define(["jQuery","livetvcss","scripts/livetvcomponents","scrollStyles"],function(e){return function(t){function r(e){var t=e.getMinutes()-D;return t>=0?e.setHours(e.getHours(),D,0,0):e.setHours(e.getHours(),0,0,0),e}function a(e){S=null,i(e)}function i(r){Dashboard.showLoadingMsg(),H.UserId=Dashboard.getCurrentUserId(),H.Limit=Math.min(H.Limit||y,w),H.AddCurrentProgram=!1,S=S||ApiClient.getLiveTvChannels(H);var i=p;i=new Date(i.getTime()+1e3);var n=new Date(i.getTime()+b-2e3);S.then(function(s){if(ApiClient.getLiveTvPrograms({UserId:Dashboard.getCurrentUserId(),MaxStartDate:n.toISOString(),MinEndDate:i.toISOString(),channelIds:s.Items.map(function(e){return e.Id}).join(","),ImageTypeLimit:1,EnableImages:!1,SortBy:"StartDate"}).then(function(e){d(r,i,s.Items,e.Items),Dashboard.hideLoadingMsg(),LibraryBrowser.setLastRefreshed(r)}),t.enablePaging!==!1){var o=LibraryBrowser.getQueryPagingHtml({startIndex:H.StartIndex,limit:H.Limit,totalRecordCount:s.TotalRecordCount,updatePageSizeSetting:!1,showLimit:!0}),l=r.querySelector(".channelPaging");l.innerHTML=o,e(l)}r.querySelector(".btnNextPage").addEventListener("click",function(){H.StartIndex+=H.Limit,a(r)}),r.querySelector(".btnPreviousPage").addEventListener("click",function(){H.StartIndex-=H.Limit,a(r)}),r.querySelector("#selectPageSize").addEventListener("change",function(){H.Limit=parseInt(this.value),H.StartIndex=0,a(r)})})}function n(e,t){var r="";for(e=new Date(e.getTime()),r+='<div class="timeslotHeadersInner">';e.getTime()<t;)r+='<div class="timeslotHeader">',r+='<div class="timeslotHeaderInner">',r+=LibraryBrowser.getDisplayTime(e),r+="</div>",r+="</div>",e.setTime(e.getTime()+T);return r+="</div>"}function s(e){if(!e.StartDateLocal)try{e.StartDateLocal=parseISO8601Date(e.StartDate,{toLocal:!0})}catch(t){}if(!e.EndDateLocal)try{e.EndDateLocal=parseISO8601Date(e.EndDate,{toLocal:!0})}catch(t){}return null}function o(e,t,r,a){var i="",n=t.getTime(),o=n+b-1;a=a.filter(function(e){return e.ChannelId==r.Id}),i+='<div class="channelPrograms">';for(var l=0,c=a.length;c>l;l++){var d=a[l];if(d.ChannelId==r.Id&&(s(d),!(d.EndDateLocal.getTime()<n))){if(d.StartDateLocal.getTime()>o)break;var m=Math.max(d.StartDateLocal.getTime(),n),u=(d.StartDateLocal.getTime()-n)/b;u*=100,u=Math.max(u,0);var g=Math.min(d.EndDateLocal.getTime(),o),v=(g-m)/b;v*=100;var f="programCell",h=!0;d.IsKids?f+=" childProgramInfo":d.IsSports?f+=" sportsProgramInfo":d.IsNews?f+=" newsProgramInfo":d.IsMovie?f+=" movieProgramInfo":(f+=" plainProgramInfo",h=!1),i+='<a href="itemdetails.html?id='+d.Id+'" class="'+f+'" data-programid="'+d.Id+'" style="left:'+u+"%;width:"+v+'%;">',i+='<div class="guideProgramName">',i+=d.Name,i+="</div>",i+='<div class="guideProgramTime">',d.IsLive?i+='<span class="liveTvProgram">'+Globalize.translate("LabelLiveProgram")+"&nbsp;&nbsp;</span>":d.IsPremiere?i+='<span class="premiereTvProgram">'+Globalize.translate("LabelPremiereProgram")+"&nbsp;&nbsp;</span>":d.IsSeries&&!d.IsRepeat&&(i+='<span class="newTvProgram">'+Globalize.translate("LabelNewProgram")+"&nbsp;&nbsp;</span>"),i+=LibraryBrowser.getDisplayTime(d.StartDateLocal),i+=" - ",i+=LibraryBrowser.getDisplayTime(d.EndDateLocal),d.SeriesTimerId?(i+='<div class="timerCircle seriesTimerCircle"></div>',i+='<div class="timerCircle seriesTimerCircle"></div>',i+='<div class="timerCircle seriesTimerCircle"></div>'):d.TimerId&&(i+='<div class="timerCircle"></div>'),i+="</div>",h&&(i+='<div class="programAccent"></div>'),i+="</a>"}}return i+="</div>"}function l(t,r,a,i){for(var n=[],s=0,l=a.length;l>s;s++)n.push(o(t,r,a[s],i));var c=t.querySelector(".programGrid");c.innerHTML=n.join(""),e(c).scrollTop(0).scrollLeft(0)}function c(e,t){for(var r="",a=0,i=t.length;i>a;a++){var n=t[a];r+='<div class="channelHeaderCellContainer">',r+='<a class="channelHeaderCell" href="itemdetails.html?id='+n.Id+'">';var s=n.ImageTags.Primary,o=s?"guideChannelInfo guideChannelInfoWithImage":"guideChannelInfo";if(r+='<div class="'+o+'">'+n.Number+"</div>",s){var l=ApiClient.getScaledImageUrl(n.Id,{maxHeight:44,maxWidth:70,tag:n.ImageTags.Primary,type:"Primary"});r+='<div class="guideChannelImage lazy" data-src="'+l+'"></div>'}else r+='<div class="guideChannelName">'+n.Name+"</div>";r+="</a>",r+="</div>"}var c=e.querySelector(".channelList");c.innerHTML=r,ImageLoader.lazyChildren(c)}function d(e,t,r,a){c(e,r);var i=t,s=new Date(i.getTime()+b);e.querySelector(".timeslotHeaders").innerHTML=n(i,s),l(e,t,r,a)}function m(t,r){P||(C=!0,e(t.querySelector(".timeslotHeaders")).scrollLeft(e(r).scrollLeft()),C=!1)}function u(t,r){C||(P=!0,e(t.querySelector(".programGrid")).scrollLeft(e(r).scrollLeft()),P=!1)}function g(e,t){p=r(t),i(e);var a=LibraryBrowser.getFutureDateText(t);a='<span class="currentDay">'+a.replace(" "," </span>"),e.querySelector(".currentDate").innerHTML=a}function v(e,t){var r=new Date;r.setHours(r.getHours(),0,0,0);var a=parseISO8601Date(t.StartDate,{toLocal:!0}),i=parseISO8601Date(t.EndDate,{toLocal:!0});for(a.setHours(0,0,0,0),i.setHours(0,0,0,0),a.getTime()>=i.getTime()&&i.setDate(a.getDate()+1),a=new Date(Math.max(r,a)),q=[];i>=a;)q.push({name:LibraryBrowser.getFutureDateText(a),id:a.getTime(),ironIcon:"today"}),a.setDate(a.getDate()+1),a.setHours(0,0,0,0);var n=new Date;p&&n.setTime(p.getTime()),g(e,n)}function f(e,t){w=t,ApiClient.getLiveTvGuideInfo().then(function(t){v(e,t)})}function h(t){e(".guideRequiresUnlock",t).hide(),RegistrationServices.validateFeature("livetv").then(function(){Dashboard.showLoadingMsg(),f(t,1e3)},function(){Dashboard.showLoadingMsg();var r=5;e(".guideRequiresUnlock",t).show(),e(".unlockText",t).html(Globalize.translate("MessageLiveTvGuideRequiresUnlock",r)),f(t,r)})}function L(e){require(["actionsheet"],function(t){t.show({items:q,showCancel:!0,title:Globalize.translate("HeaderSelectDate"),callback:function(t){var r=new Date;r.setTime(parseInt(t)),g(e,r)}})})}var I=this;I.refresh=function(){h(t.element)};var p,S,D=30,T=60*D*1e3,b=864e5,y=browserInfo.mobile?50:100,w=1e3,H={StartIndex:0,Limit:y,EnableFavoriteSorting:!0},C=!1,P=!1,q=[],M=new XMLHttpRequest;M.open("GET","components/tvguide/tvguide.template.html",!0),M.onload=function(){var r=this.response,a=t.element;a.innerHTML=Globalize.translateDocument(r),a.querySelector(".programGrid").addEventListener("scroll",function(e){m(a,e.target)}),browserInfo.mobile?a.querySelector(".tvGuide").classList.add("mobileGuide"):(a.querySelector(".tvGuide").classList.remove("mobileGuide"),a.querySelector(".timeslotHeaders").addEventListener("scroll",function(e){u(a,e.target)})),AppInfo.enableHeadRoom&&t.enableHeadRoom&&requirejs(["headroom"],function(){var e=new Headroom(a.querySelector(".tvGuideHeader"));e.init()}),e(".btnUnlockGuide",a).on("click",function(){h(a)}),e(".btnSelectDate",a).on("click",function(){L(a)}),I.refresh()},M.send()}});