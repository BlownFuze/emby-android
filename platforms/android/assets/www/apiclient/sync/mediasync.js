!function(e){function r(){function e(e,r){Logger.log("Begin reportOfflineActions");var n=DeferredBuilder.Deferred();return require(["localassetmanager"],function(){LocalAssetManager.getOfflineActions(r.Id).then(function(r){return r.length?void e.reportOfflineActions(r).then(function(){LocalAssetManager.deleteOfflineActions(r).then(function(){n.resolve()},L(n))},L(n)):void n.resolve()},L(n))}),n.promise()}function r(e,r,t){Logger.log("Begin syncData");var o=DeferredBuilder.Deferred();return require(["localassetmanager"],function(){LocalAssetManager.getServerItemIds(r.Id).then(function(i){var a={TargetId:e.deviceId(),LocalItemIds:i,OfflineUserIds:(r.Users||[]).map(function(e){return e.Id})};e.syncData(a).then(function(i){n(e,r,t,i,o)},L(o))},L(o))}),o.promise()}function n(e,r,n,o,i){Logger.log("Begin afterSyncData"),t(o,r.Id).then(function(){n?m(o,r.Id).then(function(){i.resolve()},L(i)):i.resolve()},L(i)),i.resolve()}function t(e,r){Logger.log("Begin removeLocalItems");var n=DeferredBuilder.Deferred();return o(e.ItemIdsToRemove,0,r,n),n.promise()}function o(e,r,n,t){var a=e.length;return r>=a?void t.resolve():void i(e[r],n).then(function(){o(e,r+1,n,t)},function(){o(e,r+1,n,t)})}function i(e,r){Logger.log("Begin removeLocalItem");var n=DeferredBuilder.Deferred();return require(["localassetmanager"],function(){LocalAssetManager.removeLocalItem(e,r).then(function(){n.resolve()},L(n))}),n.promise()}function a(e,r,n){Logger.log("Begin getNewMedia");var t=DeferredBuilder.Deferred();return e.getReadySyncItems(e.deviceId()).then(function(o){s(o,0,e,r,n,t)},L(t)),t.promise()}function s(e,r,n,t,o,i){var a=e.length;if(r>=a)return void i.resolve();var l=!1,u=function(){l||(l=!0,s(e,r+1,n,t,o,i))};c(e[r],n,t,o).then(u,u)}function c(e,r,n,t){Logger.log("Begin getNewItem");var o=DeferredBuilder.Deferred();return require(["localassetmanager"],function(){var i=e.Item;LocalAssetManager.createLocalItem(i,n,e.OriginalFileName).then(function(n){l(r,e,n,t).then(function(t){return t?void o.resolve():void u(r,e,n).then(function(){f(r,e,n).then(function(){r.reportSyncJobItemTransferred(e.SyncJobItemId).then(function(){o.resolve()},L(o))},L(o))},L(o))},L(o))},L(o))}),o.promise()}function l(e,r,n,t){Logger.log("Begin downloadMedia");var o=DeferredBuilder.Deferred();return require(["localassetmanager"],function(){var i=e.getUrl("Sync/JobItems/"+r.SyncJobItemId+"/File",{api_key:e.accessToken()}),a=n.LocalPath;Logger.log("Downloading media. Url: "+i+". Local path: "+a),t=t||{},LocalAssetManager.downloadFile(i,a,t.enableBackgroundTransfer,t.enableNewDownloads).then(function(e,r){return r?void o.resolveWith(null,[!0]):void LocalAssetManager.addOrUpdateLocalItem(n).then(function(){o.resolveWith(null,[!1])},L(o))},L(o))}),o.promise()}function u(e,r,n){Logger.log("Begin getImages");var t=DeferredBuilder.Deferred();return d(0,e,n,t),t.promise()}function d(e,r,n,t){return Logger.log("Begin getNextImage"),e>=4?void t.resolve():void t.resolve()}function f(e,r,n){Logger.log("Begin getSubtitles");var t=DeferredBuilder.Deferred();return require(["localassetmanager"],function(){if(!r.Item.MediaSources.length)return logger.Error("Cannot download subtitles because video has no media source info."),void t.resolve();var o=r.AdditionalFiles.filter(function(e){return"Subtitles"==e.Type}),i=r.Item.MediaSources[0];g(o,0,e,r,n,i,t)}),t.promise()}function g(e,r,n,t,o,i,a){var s=e.length;return r>=s?void a.resolve():void v(file,n,t,o,i).then(function(){g(e,r+1,n,t,o,i,a)},function(){g(e,r+1,n,t,o,i,a)})}function v(e,r,n,t,o){Logger.log("Begin getItemSubtitle");var i=DeferredBuilder.Deferred(),a=o.MediaStreams.filter(function(r){return"Subtitle"==r.Type&&r.Index==e.Index})[0];if(!a)return Logger.log("Cannot download subtitles because matching stream info wasn't found."),void i.reject();var s=r.getUrl("Sync/JobItems/"+n.SyncJobItemId+"/AdditionalFiles",{Name:e.Name,api_key:r.accessToken()});return require(["localassetmanager"],function(){LocalAssetManager.downloadSubtitles(s,t,a).then(function(e){a.Path=e,LocalAssetManager.addOrUpdateLocalItem(t).then(function(){i.resolve()},L(i))},L(i))}),i.promise()}function m(e,r){Logger.log("Begin syncUserItemAccess");var n=DeferredBuilder.Deferred(),t=[];for(var o in e.ItemUserAccess)t.push(o);return I(t,0,e,r,n),n.promise()}function I(e,r,n,t,o){var i=e.length;return r>=i?void o.resolve():void h(e[r],n).then(function(){I(e,r+1,n,t,o)},function(){I(e,r+1,n,t,o)})}function h(e,r){Logger.log("Begin syncUserAccessForItem");var n=DeferredBuilder.Deferred();return require(["localassetmanager"],function(){LocalAssetManager.getUserIdsWithAccess(e,serverId).then(function(t){var o=r.ItemUserAccess[e];o.join(",")==t.join(",")?n.resolve():LocalAssetManager.saveUserIdsWithAccess(e,serverId,o).then(function(){n.resolve()},L(n))},L(n))}),n.promise()}function L(e){return function(){e.reject()}}var B=this;B.sync=function(n,t,o){var i=DeferredBuilder.Deferred();return e(n,t).then(function(){r(n,t,!1).then(function(){a(n,t,o).then(function(){r(n,t,!1).then(function(){i.resolve()},L(i))},L(i))},L(i))},L(i)),i.promise()}}e.MediaBrowser||(e.MediaBrowser={}),e.MediaBrowser.MediaSync=r}(this);