!function(e){e.MediaBrowser||(e.MediaBrowser={}),e.MediaBrowser.ConnectionState={Unavailable:0,ServerSelection:1,ServerSignIn:2,SignedIn:3,ConnectSignIn:4},e.MediaBrowser.ConnectionMode={Local:0,Remote:1,Manual:2},e.MediaBrowser.ServerInfo={getServerAddress:function(e,n){switch(n){case MediaBrowser.ConnectionMode.Local:return e.LocalAddress;case MediaBrowser.ConnectionMode.Manual:return e.ManualAddress;case MediaBrowser.ConnectionMode.Remote:return e.RemoteAddress;default:return e.ManualAddress||e.LocalAddress||e.RemoteAddress}}},e.MediaBrowser.ConnectionManager=function(n,r,t,o,s,c,i){function a(e,n){for(var t=0,o=n.length;o>t;t++)r.addOrUpdateServer(e,n[t]);return e}function d(e){e({State:MediaBrowser.ConnectionState.Unavailable,ConnectUser:x.connectUser()})}function u(e,n){e.Name=n.ServerName,e.Id=n.Id,n.LocalAddress&&(e.LocalAddress=n.LocalAddress),n.WanAddress&&(e.RemoteAddress=n.WanAddress),n.MacAddress&&(e.WakeOnLanInfos=[{MacAddress:n.MacAddress}])}function l(e,n){return e+"/emby/"+n}function f(e){var n=e.headers||{};"json"==e.dataType&&(n.accept="application/json");var r={headers:n,method:e.type};return e.data&&"string"==typeof e.data&&(r.body=e.data),e.contentType&&(n["Content-Type"]=e.contentType),fetch(e.url,r)}function v(e){return f(e).then(function(n){return n.status<400?"json"==e.dataType||"application/json"==e.headers.accept?n.json():n:(onFetchFail(e.url,n),Promise.reject(n))},function(){return onFetchFail(e.url,{}),Promise.reject({})})}function g(e,r){return e=l(e,"system/info/public"),n.log("tryConnect url: "+e),v({type:"GET",url:e,dataType:"json",timeout:r||W})}function p(e){R=e,Events.trigger(x,"connectusersignedin",[e])}function I(e,r){var i=x.getApiClient(e.Id);if(!i){var a=MediaBrowser.ServerInfo.getServerAddress(e,r);i=new MediaBrowser.ApiClient(n,a,t,o,s,c),G.push(i),i.serverInfo(e),i.onAuthenticated=function(e,n){S(e,n,{},!0)},Events.trigger(x,"apiclientcreated",[i])}return n.log("returning instance from getOrAddApiClient"),i}function S(e,n,t,o){var s=r.credentials(),c=s.Servers.filter(function(e){return e.Id==n.ServerId}),i=c.length?c[0]:e.serverInfo();t.updateDateLastAccessed!==!1&&(i.DateLastAccessed=(new Date).getTime(),i.LastConnectionMode==MediaBrowser.ConnectionMode.Local&&(i.DateLastLocalConnection=(new Date).getTime())),i.Id=n.ServerId,o?(i.UserId=n.User.Id,i.AccessToken=n.AccessToken):(i.UserId=null,i.AccessToken=null),r.addOrUpdateServer(s.Servers,i),C(i,n.User),r.credentials(s),h(e,t),w(n.User)}function C(e,n){var t={Id:n.Id,IsSignedInOffline:!0};r.addOrUpdateUser(e,t)}function h(e,r){r=r||{},r.reportCapabilities!==!1&&e.reportCapabilities(i),r.enableWebSocket!==!1&&!e.isWebSocketOpenOrConnecting&&e.isWebSocketSupported()&&(n.log("calling apiClient.openWebSocket"),e.openWebSocket())}function w(e){Events.trigger(x,"localusersignedin",[e])}function A(e){return new Promise(function(n){R&&R.Id==e.ConnectUserId?n():e.ConnectUserId&&e.ConnectAccessToken?(R=null,T(e.ConnectUserId,e.ConnectAccessToken).then(function(e){p(e),n()},function(){n()})):n()})}function T(e,n){if(!e)throw new Error("null userId");if(!n)throw new Error("null accessToken");var r="https://connect.emby.media/service/user?id="+e;return v({type:"GET",url:r,dataType:"json",headers:{"X-Application":t+"/"+o,"X-Connect-UserToken":n}})}function m(e,n,r){if(!e.ExchangeToken)throw new Error("server.ExchangeToken cannot be null");if(!r.ConnectUserId)throw new Error("credentials.ConnectUserId cannot be null");var t=MediaBrowser.ServerInfo.getServerAddress(e,n);return t=l(t,"Connect/Exchange?format=json&ConnectUserId="+r.ConnectUserId),v({type:"GET",url:t,dataType:"json",headers:{"X-MediaBrowser-Token":e.ExchangeToken}}).then(function(n){return e.UserId=n.LocalUserId,e.AccessToken=n.AccessToken,n},function(){return e.UserId=null,e.AccessToken=null,Promise.reject()})}function M(e,n){return new Promise(function(r){var t=MediaBrowser.ServerInfo.getServerAddress(e,n);v({type:"GET",url:l(t,"System/Info"),dataType:"json",headers:{"X-MediaBrowser-Token":e.AccessToken}}).then(function(n){u(e,n),e.UserId&&v({type:"GET",url:l(t,"users/"+e.UserId),dataType:"json",headers:{"X-MediaBrowser-Token":e.AccessToken}}).then(function(e){w(e),r()},function(){e.UserId=null,e.AccessToken=null,r()})},function(){e.UserId=null,e.AccessToken=null,r()})})}function U(e){if(R&&R.ImageUrl)return{url:R.ImageUrl};if(e&&e.PrimaryImageTag){var n=x.getApiClient(e),r=n.getUserImageUrl(e.Id,{tag:e.PrimaryImageTag,type:"Primary"});return{url:r,supportsParams:!0}}return{url:null,supportsParams:!1}}function L(e){var n=e.serverInfo()||{},r={serverId:n.Id};return e.logout().then(function(){Events.trigger(x,"localusersignedout",[r])},function(){Events.trigger(x,"localusersignedout",[r])})}function k(e){return n.log("Begin getConnectServers"),new Promise(function(n){if(!e.ConnectAccessToken||!e.ConnectUserId)return void n([]);var r="https://connect.emby.media/service/servers?userId="+e.ConnectUserId;v({type:"GET",url:r,dataType:"json",headers:{"X-Application":t+"/"+o,"X-Connect-UserToken":e.ConnectAccessToken}}).then(function(e){e=e.map(function(e){return{ExchangeToken:e.AccessKey,ConnectServerId:e.Id,Id:e.SystemId,Name:e.Name,RemoteAddress:e.Url,LocalAddress:e.LocalAddress,UserLinkType:"guest"==(e.UserType||"").toLowerCase()?"Guest":"LinkedUser"}}),n(e)},function(){n([])})})}function y(e,n){return e.filter(function(e){return e.ExchangeToken?n.filter(function(n){return e.Id==n.Id}).length>0:!0})}function E(){return new Promise(function(e){require(["serverdiscovery"],function(){ServerDiscovery.findServers(1e3).then(function(n){var r=n.map(function(e){var n={Id:e.Id,LocalAddress:e.Address,Name:e.Name,ManualAddress:B(e),DateLastLocalConnection:(new Date).getTime()};return n.LastConnectionMode=n.ManualAddress?MediaBrowser.ConnectionMode.Manual:MediaBrowser.ConnectionMode.Local,n});e(r)})})})}function B(e){if(e.Address&&e.EndpointAddress){var n=e.EndpointAddress.split(":")[0],r=e.Address.split(":");if(r.length>1){var t=r[r.length-1];isNaN(parseInt(t))||(n+=":"+t)}return j(n)}return null}function D(e){require(["wakeonlan"],function(){for(var n=e.WakeOnLanInfos||[],r=0,t=n.length;t>r;r++)WakeOnLan.send(n[r])})}function P(e,n){return(e||"").toLowerCase()==(n||"").toLowerCase()}function b(e,r,t,o,s,c){if(r>=e.length)return n.log("Tested all connection modes. Failing server connection."),void d(c);var i=e[r],a=MediaBrowser.ServerInfo.getServerAddress(t,i),u=!1,l=!1,f=W;return i==MediaBrowser.ConnectionMode.Local?(u=!0,f=8e3):i==MediaBrowser.ConnectionMode.Manual&&(P(a,t.LocalAddress)||P(a,t.RemoteAddress))&&(l=!0),l||!a?void b(e,r+1,t,o,s,c):(n.log("testing connection mode "+i+" with server "+t.Name),void g(a,f).then(function(e){n.log("calling onSuccessfulConnection with connection mode "+i+" with server "+t.Name),O(t,e,i,s,c)},function(){if(n.log("test failed for connection mode "+i+" with server "+t.Name),u){{1e4-((new Date).getTime()-o)}b(e,r+1,t,o,s,c)}else b(e,r+1,t,o,s,c)}))}function O(e,n,t,o,s){var c=r.credentials();c.ConnectAccessToken?A(c).then(function(){e.ExchangeToken?m(e,t,c).then(function(){N(e,c,n,t,!0,o,s)},function(){N(e,c,n,t,!0,o,s)}):N(e,c,n,t,!0,o,s)}):N(e,c,n,t,!0,o,s)}function N(e,n,t,o,s,c,i){if(s&&e.AccessToken)return void M(e,o).then(function(){N(e,n,t,o,!1,c,i)});u(e,t),e.LastConnectionMode=o,c.updateDateLastAccessed!==!1&&(e.DateLastAccessed=(new Date).getTime(),e.LastConnectionMode==MediaBrowser.ConnectionMode.Local&&(e.DateLastLocalConnection=(new Date).getTime())),r.addOrUpdateServer(n.Servers,e),r.credentials(n);var a={Servers:[]};a.ApiClient=I(e,o),a.State=e.AccessToken?MediaBrowser.ConnectionState.SignedIn:MediaBrowser.ConnectionState.ServerSignIn,a.Servers.push(e),a.ApiClient.updateServerInfo(e,o),a.State==MediaBrowser.ConnectionState.SignedIn&&h(a.ApiClient,c),i(a),Events.trigger(x,"connected",[a])}function j(e){return e=e.trim(),0!=e.toLowerCase().indexOf("http")&&(e="http://"+e),e=e.replace("Http:","http:"),e=e.replace("Https:","https:")}function X(e){var n=r.credentials(),t=n.Servers.filter(function(n){return n.Id==e}),o=t.length?t[0]:null;o&&(o.DateLastLocalConnection=(new Date).getTime(),r.addOrUpdateServer(n.Servers,o),r.credentials(n))}n.log("Begin MediaBrowser.ConnectionManager constructor");var R,x=this,G=[],W=2e4;return x.connectUser=function(){return R},x.appVersion=function(){return o},x.capabilities=function(){return i},x.deviceId=function(){return c},x.credentialProvider=function(){return r},x.connectUserId=function(){return r.credentials().ConnectUserId},x.connectToken=function(){return r.credentials().ConnectAccessToken},x.getServerInfo=function(e){var n=r.credentials().Servers;return n.filter(function(n){return n.Id==e})[0]},x.getLastUsedServer=function(){var e=r.credentials().Servers;return e.sort(function(e,n){return(n.DateLastAccessed||0)-(e.DateLastAccessed||0)}),e.length?e[0]:null},x.getLastUsedApiClient=function(){var e=r.credentials().Servers;if(e.sort(function(e,n){return(n.DateLastAccessed||0)-(e.DateLastAccessed||0)}),!e.length)return null;var n=e[0];return I(n,n.LastConnectionMode)},x.addApiClient=function(e){G.push(e);var n=r.credentials().Servers.filter(function(n){return P(n.ManualAddress,e.serverAddress())||P(n.LocalAddress,e.serverAddress())||P(n.RemoteAddress,e.serverAddress())}),t=n.length?n[0]:{};if(t.DateLastAccessed=(new Date).getTime(),t.LastConnectionMode=MediaBrowser.ConnectionMode.Manual,t.LastConnectionMode==MediaBrowser.ConnectionMode.Local&&(t.DateLastLocalConnection=(new Date).getTime()),t.ManualAddress=e.serverAddress(),e.serverInfo(t),e.onAuthenticated=function(e,n){S(e,n,{},!0)},!n.length){var o=r.credentials();o.Servers=[t],r.credentials(o)}Events.trigger(x,"apiclientcreated",[e]),t.Id||e.getPublicSystemInfo().then(function(n){var o=r.credentials();t.Id=n.Id,e.serverInfo(t),o.Servers=[t],r.credentials(o)})},x.clearData=function(){n.log("connection manager clearing data"),R=null;var e=r.credentials();e.ConnectAccessToken=null,e.ConnectUserId=null,e.Servers=[],r.credentials(e)},x.getOrCreateApiClient=function(e){var n=r.credentials(),t=n.Servers.filter(function(n){return P(n.Id,e)});if(!t.length)throw new Error("Server not found: "+e);var o=t[0];return I(o,o.LastConnectionMode)},x.user=function(e){return new Promise(function(n){function t(){var e=U(s);n({localUser:s,name:R?R.Name:s?s.Name:null,canManageServer:s?s.Policy.IsAdministrator:!1,imageUrl:e.url,supportsImageParams:e.supportsParams})}function o(){e&&e.getCurrentUserId()?e.getCurrentUser().then(function(e){s=e,t()},t):t()}var s,c=r.credentials();!c.ConnectUserId||!c.ConnectAccessToken||e&&e.getCurrentUserId()?o():A(c).then(o,o)})},x.isLoggedIntoConnect=function(){return x.connectToken()&&x.connectUserId()?!0:!1},x.logout=function(){Logger.log("begin connectionManager loguot");for(var e=[],n=0,t=G.length;t>n;n++){var o=G[n];o.accessToken()&&e.push(L(o))}return Promise.all(e).then(function(){for(var e=r.credentials(),n=e.Servers.filter(function(e){return"Guest"!=e.UserLinkType}),t=0,o=n.length;o>t;t++){var s=n[t];s.UserId=null,s.AccessToken=null,s.ExchangeToken=null;for(var c=s.Users||[],i=0,a=c.length;a>i;i++)c[i].IsSignedInOffline=!1}e.Servers=n,e.ConnectAccessToken=null,e.ConnectUserId=null,r.credentials(e),R&&(R=null,Events.trigger(x,"connectusersignedout"))})},x.getSavedServers=function(){var e=r.credentials(),n=e.Servers.slice(0);return n.sort(function(e,n){return(n.DateLastAccessed||0)-(e.DateLastAccessed||0)}),n},x.getAvailableServers=function(){n.log("Begin getAvailableServers");var e=r.credentials();return Promise.all([k(e),E()]).then(function(n){var t=n[0],o=n[1],s=e.Servers.slice(0);return a(s,o),a(s,t),s=y(s,t),s.sort(function(e,n){return(n.DateLastAccessed||0)-(e.DateLastAccessed||0)}),e.Servers=s,r.credentials(e),s})},x.connect=function(){return n.log("Begin connect"),new Promise(function(e){x.getAvailableServers().then(function(n){x.connectToServers(n).then(function(n){e(n)})})})},x.getOffineResult=function(){},x.connectToServers=function(e){return n.log("Begin connectToServers, with "+e.length+" servers"),new Promise(function(r){if(1==e.length)x.connectToServer(e[0]).then(function(e){e.State==MediaBrowser.ConnectionState.Unavailable&&(e.State=null==e.ConnectUser?MediaBrowser.ConnectionState.ConnectSignIn:MediaBrowser.ConnectionState.ServerSelection),n.log("resolving connectToServers with result.State: "+e.State),r(e)});else{var t=e.length?e[0]:null;t?x.connectToServer(t).then(function(n){r(n.State==MediaBrowser.ConnectionState.SignedIn?n:{Servers:e,State:e.length||x.connectUser()?MediaBrowser.ConnectionState.ServerSelection:MediaBrowser.ConnectionState.ConnectSignIn,ConnectUser:x.connectUser()})}):r({Servers:e,State:e.length||x.connectUser()?MediaBrowser.ConnectionState.ServerSelection:MediaBrowser.ConnectionState.ConnectSignIn,ConnectUser:x.connectUser()})}})},x.connectToServer=function(e,n){return new Promise(function(r){var t=[];null!=e.LastConnectionMode,-1==t.indexOf(MediaBrowser.ConnectionMode.Manual)&&t.push(MediaBrowser.ConnectionMode.Manual),-1==t.indexOf(MediaBrowser.ConnectionMode.Local)&&t.push(MediaBrowser.ConnectionMode.Local),-1==t.indexOf(MediaBrowser.ConnectionMode.Remote)&&t.push(MediaBrowser.ConnectionMode.Remote),D(e);var o=(new Date).getTime();n=n||{},b(t,0,e,o,n,r)})},x.connectToAddress=function(e){return new Promise(function(r,t){function o(){n.log("connectToAddress "+e+" failed"),d(r)}return e?(e=j(e),void g(e,W).then(function(t){n.log("connectToAddress "+e+" succeeded");var s={ManualAddress:e,LastConnectionMode:MediaBrowser.ConnectionMode.Manual};u(s,t),x.connectToServer(s).then(r,o)},o)):void t()})},x.loginToConnect=function(e,n){return new Promise(function(s,c){return e&&n?void require(["connectservice","cryptojs-md5"],function(){var i=x.getConnectPasswordHash(n);v({type:"POST",url:"https://connect.emby.media/service/user/authenticate",data:{nameOrEmail:e,password:i},dataType:"json",contentType:"application/x-www-form-urlencoded; charset=UTF-8",headers:{"X-Application":t+"/"+o}}).then(function(e){var n=r.credentials();n.ConnectAccessToken=e.AccessToken,n.ConnectUserId=e.User.Id,r.credentials(n),p(e.User),s(e)},c)}):void c()})},x.signupForConnect=function(e,n,r,s){return new Promise(function(c,i){return e&&n&&r?s?r!=s?void i({errorCode:"passwordmatch"}):void require(["connectservice","cryptojs-md5"],function(){var s=x.getConnectPasswordHash(r);v({type:"POST",url:"https://connect.emby.media/service/register",data:{email:e,userName:n,password:s},dataType:"json",contentType:"application/x-www-form-urlencoded; charset=UTF-8",headers:{"X-Application":t+"/"+o,"X-CONNECT-TOKEN":"CONNECT-REGISTER"}}).then(c,function(e){try{var n=JSON.parse(e.responseText);i({errorCode:n.Status})}catch(r){i({})}})}):void i({errorCode:"passwordmatch"}):void i({errorCode:"invalidinput"})})},x.getConnectPasswordHash=function(n){return n=e.MediaBrowser.ConnectService.cleanPassword(n),CryptoJS.MD5(n).toString()},x.getApiClient=function(e){return e.ServerId&&(e=e.ServerId),G.filter(function(n){var r=n.serverInfo();return!r||r.Id==e})[0]},x.getUserInvitations=function(){var e=x.connectToken();if(!e)throw new Error("null connectToken");if(!x.connectUserId())throw new Error("null connectUserId");var n="https://connect.emby.media/service/servers?userId="+x.connectUserId()+"&status=Waiting";return v({type:"GET",url:n,dataType:"json",headers:{"X-Connect-UserToken":e,"X-Application":t+"/"+o}})},x.deleteServer=function(e){if(!e)throw new Error("null serverId");var n=r.credentials().Servers.filter(function(n){return n.Id==e});return n=n.length?n[0]:null,new Promise(function(s){function c(){var n=r.credentials();n.Servers=n.Servers.filter(function(n){return n.Id!=e}),r.credentials(n),s()}if(!n.ConnectServerId)return void c();var i=x.connectToken(),a=x.connectUserId();if(!i||!a)return void c();var d="https://connect.emby.media/service/serverAuthorizations?serverId="+n.ConnectServerId+"&userId="+a;v({type:"DELETE",url:d,headers:{"X-Connect-UserToken":i,"X-Application":t+"/"+o}}).then(c,c)})},x.rejectServer=function(e){var n=x.connectToken();if(!e)throw new Error("null serverId");if(!n)throw new Error("null connectToken");if(!x.connectUserId())throw new Error("null connectUserId");var r="https://connect.emby.media/service/serverAuthorizations?serverId="+e+"&userId="+x.connectUserId();return fetch(r,{method:"DELETE",headers:{"X-Connect-UserToken":n,"X-Application":t+"/"+o}})},x.acceptServer=function(e){var n=x.connectToken();if(!e)throw new Error("null serverId");if(!n)throw new Error("null connectToken");if(!x.connectUserId())throw new Error("null connectUserId");var r="https://connect.emby.media/service/ServerAuthorizations/accept?serverId="+e+"&userId="+x.connectUserId();return v({type:"GET",url:r,headers:{"X-Connect-UserToken":n,"X-Application":t+"/"+o}})},x.getRegistrationInfo=function(e,n){return x.getAvailableServers().then(function(r){var t=r.filter(function(e){return P(e.Id,n.serverInfo().Id)});if(!t.length)return{};var o=t[0];return o.DateLastLocalConnection?n.getRegistrationInfo(e):ApiClient.getJSON(ApiClient.getUrl("System/Endpoint")).then(function(r){return r.IsInNetwork?(X(o.Id),n.getRegistrationInfo(e)):{}})})},x}}(window,window.Logger);