define(["events","appStorage"],function(e,n){return function(r){function s(){if(!o){var e=n.getItem(r)||"{}";o=JSON.parse(e),o.Servers=o.Servers||[]}}function t(){return s(),o}function a(s){s?(o=s,n.setItem(r,JSON.stringify(s))):d.clear(),e.trigger(d,"credentialsupdated")}var d=this,o=null;r=r||"servercredentials3",d.clear=function(){o=null,n.removeItem(r)},d.credentials=function(e){return e&&a(e),t()},d.addOrUpdateServer=function(e,n){if(!n.Id)throw new Error("Server.Id cannot be null or empty");var r=e.filter(function(e){return e.Id==n.Id})[0];return r?(r.DateLastAccessed=Math.max(r.DateLastAccessed||0,n.DateLastAccessed||0),r.UserLinkType=n.UserLinkType,n.AccessToken&&(r.AccessToken=n.AccessToken,r.UserId=n.UserId),n.ExchangeToken&&(r.ExchangeToken=n.ExchangeToken),n.RemoteAddress&&(r.RemoteAddress=n.RemoteAddress),n.ManualAddress&&(r.ManualAddress=n.ManualAddress),n.LocalAddress&&(r.LocalAddress=n.LocalAddress),n.Name&&(r.Name=n.Name),n.WakeOnLanInfos&&n.WakeOnLanInfos.length&&(r.WakeOnLanInfos=n.WakeOnLanInfos),null!=n.LastConnectionMode&&(r.LastConnectionMode=n.LastConnectionMode),n.ConnectServerId&&(r.ConnectServerId=n.ConnectServerId),r):(e.push(n),n)},d.addOrUpdateUser=function(e,n){e.Users=e.Users||[];var r=e.Users.filter(function(e){return e.Id==n.Id})[0];r?r.IsSignedInOffline=!0:e.Users.push(n)}}});