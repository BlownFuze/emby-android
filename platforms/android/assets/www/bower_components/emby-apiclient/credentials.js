define(["events"],function(e){return function(n){function r(){if(!o){var e=appStorage.getItem(n)||"{}";o=JSON.parse(e),o.Servers=o.Servers||[]}}function s(){return r(),o}function t(r){r?(o=r,appStorage.setItem(n,JSON.stringify(r))):a.clear(),e.trigger(a,"credentialsupdated")}var a=this,o=null;n=n||"servercredentials3",a.clear=function(){o=null,appStorage.removeItem(n)},a.credentials=function(e){return e&&t(e),s()},a.addOrUpdateServer=function(e,n){if(!n.Id)throw new Error("Server.Id cannot be null or empty");var r=e.filter(function(e){return e.Id==n.Id})[0];return r?(r.DateLastAccessed=Math.max(r.DateLastAccessed||0,n.DateLastAccessed||0),r.UserLinkType=n.UserLinkType,n.AccessToken&&(r.AccessToken=n.AccessToken,r.UserId=n.UserId),n.ExchangeToken&&(r.ExchangeToken=n.ExchangeToken),n.RemoteAddress&&(r.RemoteAddress=n.RemoteAddress),n.ManualAddress&&(r.ManualAddress=n.ManualAddress),n.LocalAddress&&(r.LocalAddress=n.LocalAddress),n.Name&&(r.Name=n.Name),n.WakeOnLanInfos&&n.WakeOnLanInfos.length&&(r.WakeOnLanInfos=n.WakeOnLanInfos),null!=n.LastConnectionMode&&(r.LastConnectionMode=n.LastConnectionMode),n.ConnectServerId&&(r.ConnectServerId=n.ConnectServerId),r.DateLastLocalConnection=Math.max(r.DateLastLocalConnection||0,n.DateLastLocalConnection||0),r):(e.push(n),n)},a.addOrUpdateUser=function(e,n){e.Users=e.Users||[];var r=e.Users.filter(function(e){return e.Id==n.Id})[0];r?r.IsSignedInOffline=!0:e.Users.push(n)}}});