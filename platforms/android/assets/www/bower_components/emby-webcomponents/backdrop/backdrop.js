define(["browser","connectionManager","playbackManager","css!./style"],function(e,n,t){function a(n){return e.mobile?!1:n.animate}function r(){function e(e,n){var t=[{opacity:"0",offset:0},{opacity:"1",offset:1}],a={duration:800,iterations:n,easing:"ease-in"};return e.animate(t,a)}function n(){var e=i;e&&(e.cancel(),i=null)}var t,r=this;r.load=function(n,r,o){var d=new Image;d.onload=function(){if(!t){var d=document.createElement("div");if(d.classList.add("backdropImage"),d.classList.add("displayingBackdropImage"),d.style.backgroundImage="url('"+n+"')",d.setAttribute("data-url",n),r.appendChild(d),!a(d))return o&&o.parentNode&&o.parentNode.removeChild(o),void u(!0);var c=e(d,1);i=c,c.onfinish=function(){c==i&&(i=null),o&&o.parentNode&&o.parentNode.removeChild(o)},u(!0)}},d.src=n};var i;r.destroy=function(){t=!0,n()}}function i(){return B||(B=document.querySelector(".backdropContainer")),B||(B=document.createElement("div"),B.classList.add("backdropContainer"),document.body.insertBefore(B,document.body.firstChild)),B}function o(e){I(),C&&(C.destroy(),C=null);var n=i();n.innerHTML="",e&&(L=!1),u(!1)}function d(){return b||(b=document.querySelector(".skinContainer")),b}function c(){w||L?d().classList.add("withBackdrop"):d().classList.remove("withBackdrop")}function u(e){w=e,c()}function l(e){L=e,c()}function s(e){C&&(C.destroy(),C=null);var n=i(),t=n.querySelector(".displayingBackdropImage");if(t&&t.getAttribute("data-url")==e){if(t.getAttribute("data-url")==e)return;t.classList.remove("displayingBackdropImage")}var a=new r;a.load(e,n,t),C=a}function f(){T=screen.availWidth||window.innerWidth}function g(e){var t=n.getApiClient(e.ServerId);return e.BackdropImageTags&&e.BackdropImageTags.length>0?e.BackdropImageTags.map(function(n,a){return t.getScaledImageUrl(e.Id,{type:"Backdrop",tag:n,maxWidth:Math.min(T,1920),index:a})}):e.ParentBackdropItemId&&e.ParentBackdropImageTags&&e.ParentBackdropImageTags.length?e.ParentBackdropImageTags.map(function(n,a){return t.getScaledImageUrl(e.ParentBackdropItemId,{type:"Backdrop",tag:n,maxWidth:Math.min(T,1920),index:a})}):[]}function p(e){for(var n=[],t=0,a=e.length;a>t;t++){var r=g(e[t]);r.forEach(function(e){n.push(e)})}return n}function m(e,n){if(e===n)return!0;if(null==e||null==n)return!1;if(e.length!=n.length)return!1;for(var t=0;t<e.length;++t)if(e[t]!==n[t])return!1;return!0}function v(e,n){var t=p(e);n=n||(new Date).getTime(),t.length?h(t,n):o()}function h(e){m(e,S)||(I(),S=e,x=-1,e.length>1&&(P=setInterval(k,2e4)),k())}function k(){if(!t.isPlayingVideo()){var e=x+1;e>=S.length&&(e=0),x=e,s(S[e])}}function I(){var e=P;e&&clearInterval(e),P=null,S=[],x=-1}function y(e){"string"!=typeof e&&(e=p([e])[0]),e?(I(),s(e)):o()}var B,b,w,L,C,T;window.addEventListener("orientationchange",f),window.addEventListener("resize",f),f();var P,S=[],x=-1;return{setBackdrops:v,setBackdrop:y,clear:o,externalBackdrop:l}});