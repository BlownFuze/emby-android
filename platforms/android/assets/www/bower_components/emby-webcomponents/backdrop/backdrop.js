define(["browser","connectionManager","playbackManager","dom","css!./style"],function(e,n,t,r){function a(n){return e.slow?!1:n.animate}function i(){return e.tv?!1:!0}function o(){function e(e,n){var t=[{opacity:"0",offset:0},{opacity:"1",offset:1}],r={duration:800,iterations:n,easing:"ease-in"};return e.animate(t,r)}function n(){var e=i;e&&(e.cancel(),i=null)}var t,r=this;r.load=function(n,r,o){var c=new Image;c.onload=function(){if(!t){var c=document.createElement("div");if(c.classList.add("backdropImage"),c.classList.add("displayingBackdropImage"),c.style.backgroundImage="url('"+n+"')",c.setAttribute("data-url",n),r.appendChild(c),!a(c))return o&&o.parentNode&&o.parentNode.removeChild(o),void s(!0);var d=e(c,1);i=d,d.onfinish=function(){d==i&&(i=null),o&&o.parentNode&&o.parentNode.removeChild(o)},s(!0)}},c.src=n};var i;r.destroy=function(){t=!0,n()}}function c(){return b||(b=document.querySelector(".backdropContainer")),b||(b=document.createElement("div"),b.classList.add("backdropContainer"),document.body.insertBefore(b,document.body.firstChild)),b}function d(e){y(),T&&(T.destroy(),T=null);var n=c();n.innerHTML="",e&&(S=!1),s(!1)}function u(){return w||(w=document.querySelector(".backgroundContainer")),w}function l(){C||S?u().classList.add("withBackdrop"):u().classList.remove("withBackdrop")}function s(e){C=e,l()}function f(e){S=e,l()}function g(e){T&&(T.destroy(),T=null);var n=c(),t=n.querySelector(".displayingBackdropImage");if(t&&t.getAttribute("data-url")==e){if(t.getAttribute("data-url")==e)return;t.classList.remove("displayingBackdropImage")}var r=new o;r.load(e,n,t),T=r}function p(e){var t=n.getApiClient(e.ServerId);return e.BackdropImageTags&&e.BackdropImageTags.length>0?e.BackdropImageTags.map(function(n,a){return t.getScaledImageUrl(e.Id,{type:"Backdrop",tag:n,maxWidth:Math.min(r.getWindowSize().innerWidth,1920),index:a})}):e.ParentBackdropItemId&&e.ParentBackdropImageTags&&e.ParentBackdropImageTags.length?e.ParentBackdropImageTags.map(function(n,a){return t.getScaledImageUrl(e.ParentBackdropItemId,{type:"Backdrop",tag:n,maxWidth:Math.min(r.getWindowSize().innerWidth,1920),index:a})}):[]}function m(e){for(var n=[],t=0,r=e.length;r>t;t++){var a=p(e[t]);a.forEach(function(e){n.push(e)})}return n}function v(e,n){if(e===n)return!0;if(null==e||null==n)return!1;if(e.length!=n.length)return!1;for(var t=0;t<e.length;++t)if(e[t]!==n[t])return!1;return!0}function h(e,n){var t=m(e);n=n||(new Date).getTime(),t.length?k(t,n):d()}function k(e){v(e,P)||(y(),P=e,W=-1,e.length>1&&i()&&(L=setInterval(I,2e4)),I())}function I(){if(!t.isPlayingVideo()){var e=W+1;e>=P.length&&(e=0),W=e,g(P[e])}}function y(){var e=L;e&&clearInterval(e),L=null,P=[],W=-1}function B(e){"string"!=typeof e&&(e=m([e])[0]),e?(y(),g(e)):d()}var b,w,C,S,T,L,P=[],W=-1;return{setBackdrops:h,setBackdrop:B,clear:d,externalBackdrop:f}});