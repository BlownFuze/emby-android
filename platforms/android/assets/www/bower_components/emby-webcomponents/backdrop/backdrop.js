define(["browser","connectionManager","playbackManager","css!./style"],function(n,e,t){function a(e){return n.mobile?!1:e.animate}function r(){return n.tv?!1:!0}function i(){function n(n,e){var t=[{opacity:"0",offset:0},{opacity:"1",offset:1}],a={duration:800,iterations:e,easing:"ease-in"};return n.animate(t,a)}function e(){var n=i;n&&(n.cancel(),i=null)}var t,r=this;r.load=function(e,r,o){var c=new Image;c.onload=function(){if(!t){var c=document.createElement("div");if(c.classList.add("backdropImage"),c.classList.add("displayingBackdropImage"),c.style.backgroundImage="url('"+e+"')",c.setAttribute("data-url",e),r.appendChild(c),!a(c))return o&&o.parentNode&&o.parentNode.removeChild(o),void l(!0);var d=n(c,1);i=d,d.onfinish=function(){d==i&&(i=null),o&&o.parentNode&&o.parentNode.removeChild(o)},l(!0)}},c.src=e};var i;r.destroy=function(){t=!0,e()}}function o(){return b||(b=document.querySelector(".backdropContainer")),b||(b=document.createElement("div"),b.classList.add("backdropContainer"),document.body.insertBefore(b,document.body.firstChild)),b}function c(n){y(),T&&(T.destroy(),T=null);var e=o();e.innerHTML="",n&&(C=!1),l(!1)}function d(){return w||(w=document.querySelector(".backgroundContainer")),w}function u(){L||C?d().classList.add("withBackdrop"):d().classList.remove("withBackdrop")}function l(n){L=n,u()}function s(n){C=n,u()}function f(n){T&&(T.destroy(),T=null);var e=o(),t=e.querySelector(".displayingBackdropImage");if(t&&t.getAttribute("data-url")==n){if(t.getAttribute("data-url")==n)return;t.classList.remove("displayingBackdropImage")}var a=new i;a.load(n,e,t),T=a}function g(){P=screen.availWidth||window.innerWidth}function p(n){var t=e.getApiClient(n.ServerId);return n.BackdropImageTags&&n.BackdropImageTags.length>0?n.BackdropImageTags.map(function(e,a){return t.getScaledImageUrl(n.Id,{type:"Backdrop",tag:e,maxWidth:Math.min(P,1920),index:a})}):n.ParentBackdropItemId&&n.ParentBackdropImageTags&&n.ParentBackdropImageTags.length?n.ParentBackdropImageTags.map(function(e,a){return t.getScaledImageUrl(n.ParentBackdropItemId,{type:"Backdrop",tag:e,maxWidth:Math.min(P,1920),index:a})}):[]}function m(n){for(var e=[],t=0,a=n.length;a>t;t++){var r=p(n[t]);r.forEach(function(n){e.push(n)})}return e}function v(n,e){if(n===e)return!0;if(null==n||null==e)return!1;if(n.length!=e.length)return!1;for(var t=0;t<n.length;++t)if(n[t]!==e[t])return!1;return!0}function h(n,e){var t=m(n);e=e||(new Date).getTime(),t.length?k(t,e):c()}function k(n){v(n,x)||(y(),x=n,E=-1,n.length>1&&r()&&(S=setInterval(I,2e4)),I())}function I(){if(!t.isPlayingVideo()){var n=E+1;n>=x.length&&(n=0),E=n,f(x[n])}}function y(){var n=S;n&&clearInterval(n),S=null,x=[],E=-1}function B(n){"string"!=typeof n&&(n=m([n])[0]),n?(y(),f(n)):c()}var b,w,L,C,T,P;window.addEventListener("orientationchange",g),window.addEventListener("resize",g),g();var S,x=[],E=-1;return{setBackdrops:h,setBackdrop:B,clear:c,externalBackdrop:s}});