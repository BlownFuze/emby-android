define(["serverNotifications","playbackManager","events","globalize","require"],function(e,t,n,a,r){function o(){document.removeEventListener("click",o),document.removeEventListener("keydown",o),window.Notification&&Notification.requestPermission()}function i(e,t){setTimeout(function(){e.close?e.close():e.cancel&&e.cancel()},t)}function s(){var e=navigator.serviceWorker;e&&e.ready.then(function(e){u=e})}function c(e,t){u.showNotification(e,t)}function l(e,t,n){try{var a=new Notification(e,t);a.show&&a.show(),n&&i(a,n)}catch(r){if(!t.actions)throw r;t.actions=[],l(e,t,n)}}function d(e,t,n){var a=e.title;return e.data=e.data||{},e.data.serverId=n.serverInfo().Id,e.icon=e.icon||v(),s(),u?void c(a,e,t):void l(a,e,t)}function m(e,t){var n={title:"New "+e.Type,body:e.Name,vibrate:!0,tag:"newItem"+e.Id,data:{}},a=e.ImageTags||{};a.Primary&&(n.icon=t.getScaledImageUrl(e.Id,{width:80,tag:a.Primary,type:"Primary"})),d(n,15e3,t)}function f(e,n){var a=e.ItemsAdded;a.length&&window.Notification&&"granted"===Notification.permission&&(t.isPlayingVideo()||n.getItems(n.getCurrentUserId(),{Recursive:!0,Limit:3,IsFolder:!1,SortBy:"DateCreated",SortOrder:"Descending",ImageTypes:"Primary",Ids:a.join(",")}).then(function(e){for(var t=e.Items,a=0,r=t.length;r>a;a++)m(t[a],n)}))}function v(e){return e=e||"notificationicon.png",r.toUrl(".").split("?")[0]+"/"+e}function g(e,t,n){e.getCurrentUser().then(function(r){if(r.Policy.IsAdministrator){var o={tag:"install"+t.Id,data:{}};if("completed"==n?(o.title=a.translate("sharedcomponents#PackageInstallCompleted").replace("{0}",t.Name+" "+t.Version),o.vibrate=!0):"cancelled"==n?o.title=a.translate("sharedcomponents#PackageInstallCancelled").replace("{0}",t.Name+" "+t.Version):"failed"==n?(o.title=a.translate("sharedcomponents#PackageInstallFailed").replace("{0}",t.Name+" "+t.Version),o.vibrate=!0):"progress"==n&&(o.title=a.translate("sharedcomponents#InstallingPackage").replace("{0}",t.Name+" "+t.Version),o.actions=[{action:"cancel-install",title:a.translate("sharedcomponents#ButtonCancel"),icon:v()}],o.data.id=t.id),"progress"==n){var i=Math.round(t.PercentComplete||0);o.body=i+"% complete."}var s="cancelled"==n?5e3:0;d(o,s,e)}})}document.addEventListener("click",o),document.addEventListener("keydown",o);var u;s(),n.on(e,"LibraryChanged",function(e,t,n){f(n,t)}),n.on(e,"PackageInstallationCompleted",function(e,t,n){g(t,n,"completed")}),n.on(e,"PackageInstallationFailed",function(e,t,n){g(t,n,"failed")}),n.on(e,"PackageInstallationCancelled",function(e,t,n){g(t,n,"cancelled")}),n.on(e,"PackageInstalling",function(e,t,n){g(t,n,"progress")}),n.on(e,"ServerShuttingDown",function(e,t){var n=t.serverInfo().Id,r={tag:"restart"+n,title:a.translate("sharedcomponents#ServerNameIsShuttingDown",t.serverInfo().Name)};d(r,0,t)}),n.on(e,"ServerRestarting",function(e,t){var n=t.serverInfo().Id,r={tag:"restart"+n,title:a.translate("sharedcomponents#ServerNameIsRestarting",t.serverInfo().Name)};d(r,0,t)}),n.on(e,"RestartRequired",function(e,t){var n=t.serverInfo().Id,r={tag:"restart"+n,title:a.translate("sharedcomponents#PleaseRestartServerName",t.serverInfo().Name)};r.actions=[{action:"restart",title:a.translate("sharedcomponents#ButtonRestart"),icon:v()}],d(r,0,t)})});