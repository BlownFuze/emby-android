define(["loading","viewManager","skinManager","pluginManager","backdrop","browser","pageJs"],function(e,t,n,r,o,a,i){function c(){o.clear(),e.show(),A.connect().then(function(t){u(t,e)})}function u(e,t){switch(e.State){case MediaBrowser.ConnectionState.SignedIn:t.hide(),n.loadUserSkin();break;case MediaBrowser.ConnectionState.ServerSignIn:e.ApiClient.getPublicUsers().then(function(t){t.length?I("/startup/login.html?serverid="+e.Servers[0].Id):s(e.ApiClient,e.Servers[0].Id)});break;case MediaBrowser.ConnectionState.ServerSelection:I("/startup/selectserver.html");break;case MediaBrowser.ConnectionState.ConnectSignIn:I("/startup/welcome.html");break;case MediaBrowser.ConnectionState.ServerUpdateNeeded:require(["alert"],function(e){e(Globalize.translate("core#ServerUpdateNeeded",'<a href="https://emby.media">https://emby.media</a>')).then(function(){I("/startup/selectserver.html")})})}}function s(e,t){I("/startup/manuallogin.html?serverid="+t)}function l(e,t,n,r){var o=n.contentPath||n.path;0!=o.toLowerCase().indexOf("http")&&0!=o.indexOf("file:")&&(0!=o.indexOf("/")&&(o="/"+o),o=b()+o),o+=-1==o.indexOf("?")?"?":"&",o+="v="+J;var a=new XMLHttpRequest;a.onload=a.onerror=function(){this.status<400?k(e,n,this.response,r):t()},a.onerror=t,a.open("GET",o,!0),a.send()}function d(e,t,n){w(e,n,function(){p(e,t,n)})}function p(e,t,n){var r=function(r){h(e,t,n,r)};require(n.dependencies||[],function(){n.controller?require([n.controller],r):r()})}function f(){var e=P;e&&(e.cancel=!0)}function h(e,n,r,o){f();var a=e.isBack,i={url:b()+e.path,transition:r.transition,isBack:a,state:e.state,type:r.type,controllerFactory:o,options:{supportsThemeMedia:r.supportsThemeMedia||!1},autoFocus:r.autoFocus};P=i;var c=function(){"string"==typeof r.path?l(e,n,r,i):n()};return a||"home"==r.type?void t.tryRestoreView(i).then(function(){j={route:r,path:e.path}},c):void c()}function m(t){e.show(),require(["connectionManager"],function(n){A=n,A.connect().then(function(n){V=n,e.hide(),t=t||{},i({click:t.click!==!1,hashbang:t.hashbang!==!1,enableHistory:v()})})})}function v(){return a.xboxOne?!1:!0}function g(){return i.enableNativeHistory()}function w(t,r,o){var a=V;if(a&&(V=null,a.State!=MediaBrowser.ConnectionState.SignedIn))return void u(a,e);{var i=A.currentApiClient();t.pathname.toLowerCase()}return i&&i.isLoggedIn()?void(t.isBack&&r.isDefaultRoute?S():r.isDefaultRoute?n.loadUserSkin():o()):void(r.anonymous?o():c())}function S(){n.loadUserSkin(),z||(z=!0,n.getCurrentSkin().showBackMenu().then(function(){z=!1}))}function k(e,n,r,o){r=Globalize.translateDocument(r,n.dictionary),o.view=r,t.loadView(o),j={route:n,path:e.path},e.handled=!0}function b(){return X}function y(e){return function(t,n){d(t,n,e)}}function C(){var e=j?j.path||"":"",t=e.indexOf("?"),n="";return-1!=t&&(n=e.substring(t)),n||""}function B(e,t){e=e.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var n="[\\?&]"+e+"=([^&#]*)",r=new RegExp(n,"i"),o=r.exec(t||C());return null==o?"":decodeURIComponent(o[1].replace(/\+/g," "))}function x(){i.back()}function M(){var e=R();return e?"home"==e.type?!1:i.canGoBack():!1}function I(e,t){return new Promise(function(n){var r=b();return e=e.replace(r,""),j&&j.path==e&&"home"!=j.route.type?void n():(i.show(e,t),void setTimeout(n,500))})}function R(){return j?j.route:null}function T(){var e=n.getCurrentSkin(),t=e.getRoutes().filter(function(e){return"home"==e.type})[0];return I(r.mapRoute(e,t))}function L(e){"string"==typeof e?Emby.Models.item(e).then(L):n.getCurrentSkin().showItem(e)}function O(e){n.getCurrentSkin().setTitle(e)}function E(){I("/settings/settings.html")}function U(){I("/startup/selectserver.html")}function D(){var e=n.getCurrentSkin(),t=e.getRoutes().filter(function(e){return"video-osd"==e.type})[0];return I(r.mapRoute(e,t))}function q(e,t){i(e,y(t)),K.push(t)}function F(){return K}function G(e){"full"==e||e==Emby.TransparencyLevel.Full?(o.clear(!0),document.documentElement.classList.add("transparentDocument")):"backdrop"==e||e==Emby.TransparencyLevel.Backdrop?(o.externalBackdrop(!0),document.documentElement.classList.add("transparentDocument")):(o.externalBackdrop(!1),document.documentElement.classList.remove("transparentDocument"))}function H(e,t,n){e.navigate=!1,i.pushState(e,t,n)}function N(){var e=window.location.pathname.replace("/index.html","");e.lastIndexOf("/")==e.length-1&&(e=e.substring(0,e.length-1)),i.base(e)}var A,P,V,z,J=(new Date).getTime(),X=window.location.href.split("?")[0].replace("/index.html","");X=X.split("#")[0],X.lastIndexOf("/")==X.length-1&&(X=X.substring(0,X.length-1));var j,K=[];return N(),{addRoute:q,param:B,back:x,show:I,start:m,baseUrl:b,canGoBack:M,current:R,redirectToLogin:c,goHome:T,gotoSettings:E,showItem:L,setTitle:O,selectServer:U,showVideoOsd:D,setTransparency:G,getRoutes:F,pushState:H,TransparencyLevel:{None:0,Backdrop:1,Full:2},enableNativeHistory:g}});