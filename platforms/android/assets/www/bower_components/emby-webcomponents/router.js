define(["loading","viewManager","skinManager","pluginManager","backdrop","browser","pageJs"],function(e,n,t,o,r,a,i){function c(){r.clear(),e.show(),F.connect().then(function(n){s(n,e)})}function s(e,n){switch(e.State){case MediaBrowser.ConnectionState.SignedIn:n.hide(),t.loadUserSkin();break;case MediaBrowser.ConnectionState.ServerSignIn:e.ApiClient.getPublicUsers().then(function(n){n.length?A.showLocalLogin(e.ApiClient,e.Servers[0].Id):A.showLocalLogin(e.ApiClient,e.Servers[0].Id,!0)});break;case MediaBrowser.ConnectionState.ServerSelection:A.showSelectServer();break;case MediaBrowser.ConnectionState.ConnectSignIn:A.showWelcome();break;case MediaBrowser.ConnectionState.ServerUpdateNeeded:require(["alert"],function(e){e(Globalize.translate("core#ServerUpdateNeeded",'<a href="https://emby.media">https://emby.media</a>')).then(function(){A.showSelectServer()})})}}function u(e,n,t,o){var r=t.contentPath||t.path;0!=r.toLowerCase().indexOf("http")&&0!=r.indexOf("file:")&&(0!=r.indexOf("/")&&(r="/"+r),r=b()+r),r+=-1==r.indexOf("?")?"?":"&",r+="v="+P;var a=new XMLHttpRequest;a.onload=a.onerror=function(){this.status<400?S(e,t,this.response,o):n()},a.onerror=n,a.open("GET",r,!0),a.send()}function l(e,n,t){v(e,t,function(){d(e,n,t)})}function d(e,n,t){var o=function(o){p(e,n,t,o)};require(t.dependencies||[],function(){t.controller?require([t.controller],o):o()})}function h(){var e=G;e&&(e.cancel=!0)}function p(e,t,o,r){h();var a=e.isBack,i={url:b()+e.path,transition:o.transition,isBack:a,state:e.state,type:o.type,controllerFactory:r,options:{supportsThemeMedia:o.supportsThemeMedia||!1},autoFocus:o.autoFocus};G=i;var c=function(){"string"==typeof o.path?u(e,t,o,i):t()};return a||"home"==o.type?void n.tryRestoreView(i).then(function(){V={route:o,path:e.path}},c):void c()}function f(n){e.show(),require(["connectionManager"],function(t){F=t,F.connect().then(function(t){H=t,e.hide(),n=n||{},i({click:n.click!==!1,hashbang:n.hashbang!==!1,enableHistory:m()})})})}function m(){return a.xboxOne?!1:!0}function g(){return i.enableNativeHistory()}function v(n,o,r){var a=H;if(a&&(H=null,a.State!=MediaBrowser.ConnectionState.SignedIn))return void s(a,e);{var i=F.currentApiClient();n.pathname.toLowerCase()}return i&&i.isLoggedIn()?void(n.isBack&&o.isDefaultRoute?w():o.isDefaultRoute?t.loadUserSkin():r()):void(o.anonymous?r():c())}function w(){t.loadUserSkin(),N||(N=!0,t.getCurrentSkin().showBackMenu().then(function(){N=!1}))}function S(e,t,o,r){o=Globalize.translateDocument(o,t.dictionary),r.view=o,n.loadView(r),V={route:t,path:e.path},e.handled=!0}function b(){return z}function k(e){return function(n,t){l(n,t,e)}}function y(){var e=V?V.path||"":"",n=e.indexOf("?"),t="";return-1!=n&&(t=e.substring(n)),t||""}function C(e,n){e=e.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var t="[\\?&]"+e+"=([^&#]*)",o=new RegExp(t,"i"),r=o.exec(n||y());return null==r?"":decodeURIComponent(r[1].replace(/\+/g," "))}function L(){i.back()}function B(){var e=M();return e?"home"==e.type?!1:i.canGoBack():!1}function x(e,n){return new Promise(function(t){var o=b();return e=e.replace(o,""),V&&V.path==e&&"home"!=V.route.type?void t():(i.show(e,n),void setTimeout(t,500))})}function M(){return V?V.route:null}function I(){var e=t.getCurrentSkin(),n=e.getRoutes().filter(function(e){return"home"==e.type})[0];return x(o.mapRoute(e,n))}function T(e){"string"==typeof e?Emby.Models.item(e).then(T):t.getCurrentSkin().showItem(e)}function R(e){t.getCurrentSkin().setTitle(e)}function E(e,n){i(e,k(n)),W.push(n)}function O(){return W}function U(e){"full"==e||e==Emby.TransparencyLevel.Full?(r.clear(!0),document.documentElement.classList.add("transparentDocument")):"backdrop"==e||e==Emby.TransparencyLevel.Backdrop?(r.externalBackdrop(!0),document.documentElement.classList.add("transparentDocument")):(r.externalBackdrop(!1),document.documentElement.classList.remove("transparentDocument"))}function D(e,n,t){e.navigate=!1,i.pushState(e,n,t)}function q(){var e=window.location.pathname.replace("/index.html","");e.lastIndexOf("/")==e.length-1&&(e=e.substring(0,e.length-1)),i.base(e)}var F,G,H,N,A={showLocalLogin:function(e,n,t){var o=t?"manuallogin":"login";x("/startup/"+o+".html?serverid="+n)},showSelectServer:function(){x("/startup/selectserver.html")},showWelcome:function(){x("/startup/welcome.html")},showSettings:function(){x("/settings/settings.html")}},P=(new Date).getTime(),z=window.location.href.split("?")[0].replace("/index.html","");z=z.split("#")[0],z.lastIndexOf("/")==z.length-1&&(z=z.substring(0,z.length-1));var V,W=[];return q(),A.addRoute=E,A.param=C,A.back=L,A.show=x,A.start=f,A.baseUrl=b,A.canGoBack=B,A.current=M,A.redirectToLogin=c,A.goHome=I,A.showItem=T,A.setTitle=R,A.setTransparency=U,A.getRoutes=O,A.pushState=D,A.enableNativeHistory=g,A.TransparencyLevel={None:0,Backdrop:1,Full:2},A});