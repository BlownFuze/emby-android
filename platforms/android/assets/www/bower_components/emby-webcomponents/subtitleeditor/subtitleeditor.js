define(["dialogHelper","require","layoutManager","globalize","appStorage","connectionManager","loading","focusManager","dom","apphost","emby-select","listViewStyle","paper-icon-button-light","css!./../formdialog","material-icons","css!./subtitleeditor","emby-button"],function(e,t,n,i,a,s,r,o,l,c){function u(e,n){var a="Items/"+D.Id+"/RemoteSearch/Subtitles/"+n,r=s.getApiClient(D.ServerId);r.ajax({type:"POST",url:r.getUrl(a)}).then(function(){q=!0,t(["toast"],function(e){e(i.translate("sharedcomponents#MessageDownloadQueued"))}),o.autoFocus(e)})}function d(e,n){var a=i.translate("sharedcomponents#MessageAreYouSureDeleteSubtitles");t(["confirm"],function(t){t(a,i.translate("sharedcomponents#ConfirmDeletion")).then(function(){r.show();var t=D.Id,i="Videos/"+t+"/Subtitles/"+n,a=s.getApiClient(D.ServerId);a.ajax({type:"DELETE",url:a.getUrl(i)}).then(function(){q=!0,g(e,a,t)})})})}function v(e,t){var a=t.MediaStreams||[],s=a.filter(function(e){return"Subtitle"==e.Type}),r="";s.length&&(r+="<h1>"+i.translate("sharedcomponents#MySubtitles")+"</h1>",r+=n.tv?'<div class="paperList paperList-clear">':'<div class="paperList">',r+=s.map(function(e){var t="",a=n.tv?"button":"div",s=n.tv&&e.Path?"listItem listItem-focusscale btnDelete":"listItem";return s+=" listItem-noborder",t+="<"+a+' class="'+s+'" data-index="'+e.Index+'">',t+='<i class="listItemIcon md-icon">closed_caption</i>',t+='<div class="listItemBody two-line">',t+="<div>",t+=e.DisplayTitle||"",t+="</div>",e.Path&&(t+='<div class="secondary listItemBodyText">'+e.Path+"</div>"),t+="</a>",t+="</div>",n.tv||e.Path&&(t+='<button is="paper-icon-button-light" data-index="'+e.Index+'" title="'+i.translate("sharedcomponents#Delete")+'" class="btnDelete listItemButton"><i class="md-icon">delete</i></button>'),t+="</"+a+">"}).join(""),r+="</div>");var o=e.querySelector(".subtitleList");s.length?o.classList.remove("hide"):o.classList.add("hide"),o.innerHTML=r}function m(e,t,n){var i=e.querySelector("#selectLanguage");i.innerHTML=n.map(function(e){return'<option value="'+e.ThreeLetterISOLanguageName+'">'+e.DisplayName+"</option>"});var s=a.getItem("subtitleeditor-language");s?i.value=s:t.getCurrentUser().then(function(e){var t=e.Configuration.SubtitleLanguagePreference;t&&(i.value=t)})}function h(e,t){var i="",a="";if(!t.length)return e.querySelector(".noSearchResults").classList.remove("hide"),e.querySelector(".subtitleResults").innerHTML="",void r.hide();e.querySelector(".noSearchResults").classList.add("hide");for(var s="dots-horiz"==c.moreIcon?"&#xE5D3;":"&#xE5D4;",o=0,l=t.length;l>o;o++){var u=t[o],d=u.ProviderName;d!=i&&(o>0&&(a+="</div>"),a+="<h1>"+d+"</h1>",a+=n.tv?'<div class="paperList paperList-clear">':'<div class="paperList">',i=d);var v=n.tv?"button":"div",m=n.tv?"listItem btnOptions":"listItem";a+="<"+v+' class="'+m+'" data-subid="'+u.Id+'">',a+='<i class="listItemIcon md-icon">closed_caption</i>',a+='<div class="listItemBody two-line">',a+="<div>"+u.Name+"</div>",a+='<div class="secondary listItemBodyText">'+u.Format+"</div>",u.Comment&&(a+='<div class="secondary listItemBodyText">'+u.Comment+"</div>"),a+="</div>",a+='<div class="secondary listItemAside">'+(u.DownloadCount||0)+"</div>",n.tv||(a+='<button type="button" is="paper-icon-button-light" data-subid="'+u.Id+'" class="btnOptions listItemButton"><i class="md-icon">'+s+"</i></button>"),a+="</"+v+">"}t.length&&(a+="</div>");var h=e.querySelector(".subtitleResults");h.innerHTML=a,r.hide()}function p(e,t){a.setItem("subtitleeditor-language",t),r.show();var n=s.getApiClient(D.ServerId),i=n.getUrl("Items/"+D.Id+"/RemoteSearch/Subtitles/"+t);n.getJSON(i).then(function(t){h(e,t)})}function g(e,t,n){function i(t){D=t,v(e,t);var n=t.Path||"",i=Math.max(n.lastIndexOf("/"),n.lastIndexOf("\\"));i>-1&&(n=n.substring(i+1)),n?(e.querySelector(".pathValue").innerHTML=n,e.querySelector(".originalFile").classList.remove("hide")):(e.querySelector(".pathValue").innerHTML="",e.querySelector(".originalFile").classList.add("hide")),r.hide()}e.querySelector(".noSearchResults").classList.add("hide"),"string"==typeof n?t.getItem(t.getCurrentUserId(),n).then(i):i(n)}function f(e){var t=this,n=t.querySelector("#selectLanguage",t).value;return p(l.parentWithClass(t,"formDialogContent"),n),e.preventDefault(),!1}function b(e){var t=l.parentWithClass(e.target,"btnDelete");if(t){var n=t.getAttribute("data-index"),i=l.parentWithClass(t,"subtitleEditorDialog");d(i,n)}}function S(e){var t=l.parentWithClass(e.target,"btnOptions");if(t){var n=t.getAttribute("data-subid"),i=l.parentWithClass(t,"subtitleEditorDialog");y(t,i,n)}}function y(e,n,i){var a=[];a.push({name:Globalize.translate("sharedcomponents#Download"),id:"download"}),t(["actionsheet"],function(t){t.show({items:a,positionTo:e}).then(function(e){switch(e){case"download":u(n,i)}})})}function I(e,n,i){t(["scrollHelper"],function(t){var a=i?"on":"off";t.centerFocus[a](e,n)})}function L(t,a,r){q=!1;var o=s.getApiClient(a);return o.getItem(o.getCurrentUserId(),t).then(function(t){var a={removeOnClose:!0,scrollY:!1};a.size=n.tv?"fullscreen":"small";var s=e.createDialog(a);s.classList.add("formDialog"),s.classList.add("subtitleEditorDialog"),s.innerHTML=i.translateDocument(r,"sharedcomponents"),document.body.appendChild(s),s.querySelector(".originalSubtitleFileLabel").innerHTML=i.translate("sharedcomponents#File"),s.querySelector(".subtitleSearchForm").addEventListener("submit",f);var l=s.querySelector(".btnSubmit");n.tv?(I(s.querySelector(".formDialogContent"),!1,!0),s.querySelector(".btnSearchSubtitles").classList.add("hide")):l.classList.add("hide");var c=s.querySelector(".formDialogContent");return s.querySelector(".subtitleList").addEventListener("click",b),s.querySelector(".subtitleResults").addEventListener("click",S),o.getCultures().then(function(e){m(c,o,e)}),s.querySelector(".btnCancel").addEventListener("click",function(){e.close(s)}),new Promise(function(i,a){s.addEventListener("close",function(){n.tv&&I(s.querySelector(".formDialogContent"),!1,!1),q?i():a()}),e.open(s),g(c,o,t)})})}function C(e,n){return r.show(),new Promise(function(i,a){t(["text!./subtitleeditor.template.html"],function(t){L(e,n,t).then(i,a)})})}var D,q;return{show:C}});