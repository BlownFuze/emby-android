define(["dialogHelper","require","layoutManager","globalize","scrollHelper","appStorage","connectionManager","loading","focusManager","dom","apphost","emby-select","listViewStyle","paper-icon-button-light","css!./../formdialog","material-icons","css!./subtitleeditor","emby-button"],function(e,t,n,i,a,s,r,o,l,c,d){function u(e,n){var a="Items/"+q.Id+"/RemoteSearch/Subtitles/"+n,s=r.getApiClient(q.ServerId);s.ajax({type:"POST",url:s.getUrl(a)}).then(function(){D=!0,t(["toast"],function(e){e(i.translate("sharedcomponents#MessageDownloadQueued"))}),l.autoFocus(e)})}function v(e,n){var a=i.translate("sharedcomponents#MessageAreYouSureDeleteSubtitles");t(["confirm"],function(t){t(a,i.translate("sharedcomponents#ConfirmDeletion")).then(function(){o.show();var t=q.Id,i="Videos/"+t+"/Subtitles/"+n,a=r.getApiClient(q.ServerId);a.ajax({type:"DELETE",url:a.getUrl(i)}).then(function(){D=!0,b(e,a,t)})})})}function h(e,t){var a=t.MediaStreams||[],s=a.filter(function(e){return"Subtitle"==e.Type}),r="";s.length&&(r+="<h1>"+i.translate("sharedcomponents#MySubtitles")+"</h1>",r+=n.tv?'<div class="paperList clear">':'<div class="paperList">',r+=s.map(function(e){var t="",a=n.tv?"button":"div",s=n.tv&&e.Path?"listItem btnDelete":"listItem";return t+="<"+a+' class="'+s+'" data-index="'+e.Index+'">',t+='<i class="listItemIcon md-icon">closed_caption</i>',t+='<div class="listItemBody two-line">',t+="<div>",t+=e.DisplayTitle||"",t+="</div>",e.Path&&(t+='<div class="secondary listItemBodyText">'+e.Path+"</div>"),t+="</a>",t+="</div>",n.tv||e.Path&&(t+='<button is="paper-icon-button-light" data-index="'+e.Index+'" title="'+i.translate("sharedcomponents#Delete")+'" class="btnDelete"><i class="md-icon">delete</i></button>'),t+="</"+a+">"}).join(""),r+="</div>");var o=e.querySelector(".subtitleList");s.length?o.classList.remove("hide"):o.classList.add("hide"),o.innerHTML=r}function m(e,t,n){var i=e.querySelector("#selectLanguage");i.innerHTML=n.map(function(e){return'<option value="'+e.ThreeLetterISOLanguageName+'">'+e.DisplayName+"</option>"});var a=s.getItem("subtitleeditor-language");a?i.value=a:t.getCurrentUser().then(function(e){var t=e.Configuration.SubtitleLanguagePreference;t&&(i.value=t)})}function g(e,t){var i="",a="";if(!t.length)return e.querySelector(".noSearchResults").classList.remove("hide"),e.querySelector(".subtitleResults").innerHTML="",void o.hide();e.querySelector(".noSearchResults").classList.add("hide");for(var s="dots-horiz"==d.moreIcon?"&#xE5D3;":"&#xE5D4;",r=0,l=t.length;l>r;r++){var c=t[r],u=c.ProviderName;u!=i&&(r>0&&(a+="</div>"),a+="<h1>"+u+"</h1>",a+=n.tv?'<div class="paperList clear">':'<div class="paperList">',i=u);var v=n.tv?"button":"div",h=n.tv?"listItem btnOptions":"listItem";a+="<"+v+' class="'+h+'" data-subid="'+c.Id+'">',a+='<i class="listItemIcon md-icon">closed_caption</i>',a+='<div class="listItemBody two-line">',a+="<div>"+c.Name+"</div>",a+='<div class="secondary listItemBodyText">'+c.Format+"</div>",c.Comment&&(a+='<div class="secondary listItemBodyText">'+c.Comment+"</div>"),a+="</div>",a+='<div class="secondary">'+(c.DownloadCount||0)+"</div>",n.tv||(a+='<button type="button" is="paper-icon-button-light" data-subid="'+c.Id+'" class="btnOptions"><i class="md-icon">'+s+"</i></button>"),a+="</"+v+">"}t.length&&(a+="</div>");var m=e.querySelector(".subtitleResults");m.innerHTML=a,o.hide()}function p(e,t){s.setItem("subtitleeditor-language",t),o.show();var n=r.getApiClient(q.ServerId),i=n.getUrl("Items/"+q.Id+"/RemoteSearch/Subtitles/"+t);n.getJSON(i).then(function(t){g(e,t)})}function b(e,t,n){function i(t){q=t,h(e,t);var n=t.Path||"",i=Math.max(n.lastIndexOf("/"),n.lastIndexOf("\\"));i>-1&&(n=n.substring(i+1)),n?(e.querySelector(".pathValue").innerHTML=n,e.querySelector(".originalFile").classList.remove("hide")):(e.querySelector(".pathValue").innerHTML="",e.querySelector(".originalFile").classList.add("hide")),o.hide()}e.querySelector(".noSearchResults").classList.add("hide"),"string"==typeof n?t.getItem(t.getCurrentUserId(),n).then(i):i(n)}function f(e){var t=this,n=t.querySelector("#selectLanguage",t).value;return p(c.parentWithClass(t,"dialogContent"),n),e.preventDefault(),!1}function S(e){var t=c.parentWithClass(e.target,"btnDelete");if(t){var n=t.getAttribute("data-index"),i=c.parentWithClass(t,"subtitleEditorDialog");v(i,n)}}function y(e){var t=c.parentWithClass(e.target,"btnOptions");if(t){var n=t.getAttribute("data-subid"),i=c.parentWithClass(t,"subtitleEditorDialog");L(t,i,n)}}function L(e,n,i){var a=[];a.push({name:Globalize.translate("sharedcomponents#Download"),id:"download"}),t(["actionsheet"],function(t){t.show({items:a,positionTo:e}).then(function(e){switch(e){case"download":u(n,i)}})})}function I(t,s,o){D=!1;var l=r.getApiClient(s);return l.getItem(l.getCurrentUserId(),t).then(function(t){var s={removeOnClose:!0};s.size=n.tv?"fullscreen":"small";var r=e.createDialog(s);r.classList.add("formDialog"),r.classList.add("subtitleEditorDialog"),r.innerHTML=i.translateDocument(o,"sharedcomponents"),document.body.appendChild(r),r.querySelector(".originalFileLabel").innerHTML=i.translate("sharedcomponents#File"),r.querySelector(".subtitleSearchForm").addEventListener("submit",f);var c=r.querySelector(".btnSubmit");n.tv?(a.centerFocus.on(r.querySelector(".dialogContent"),!1),r.querySelector(".btnSearchSubtitles").classList.add("hide")):c.classList.add("hide");var d=r.querySelector(".dialogContent");return r.querySelector(".subtitleList").addEventListener("click",S),r.querySelector(".subtitleResults").addEventListener("click",y),l.getCultures().then(function(e){m(d,l,e)}),r.querySelector(".btnCancel").addEventListener("click",function(){e.close(r)}),new Promise(function(n,i){r.addEventListener("close",function(){D?n():i()}),e.open(r),b(d,l,t)})})}function C(e,n){return o.show(),new Promise(function(i,a){t(["text!./subtitleeditor.template.html"],function(t){I(e,n,t).then(i,a)})})}var q,D;return{show:C}});