define(["dialogHelper","require","layoutManager","globalize","scrollHelper","appStorage","connectionManager","loading","focusManager","emby-select","listViewStyle","paper-icon-button-light","css!./../formdialog","html!./../icons/mediainfo.html","html!./../icons/nav.html","css!./subtitleeditor"],function(e,t,n,i,o,a,r,s,l){function c(e,n){var o="Items/"+C.Id+"/RemoteSearch/Subtitles/"+n,a=r.getApiClient(C.ServerId);a.ajax({type:"POST",url:a.getUrl(o)}).then(function(){T=!0,t(["toast"],function(e){e(i.translate("sharedcomponents#MessageDownloadQueued"))}),l.autoFocus(e)})}function u(e,n){var o=i.translate("sharedcomponents#MessageAreYouSureDeleteSubtitles");t(["confirm"],function(t){t(o,i.translate("sharedcomponents#ConfirmDeletion")).then(function(){s.show();var t=C.Id,i="Videos/"+t+"/Subtitles/"+n,o=r.getApiClient(C.ServerId);o.ajax({type:"DELETE",url:o.getUrl(i)}).then(function(){T=!0,g(e,o,t)})})})}function d(e,t){var o=t.MediaStreams||[],a=o.filter(function(e){return"Subtitle"==e.Type}),r="";a.length&&(r+="<h1>"+i.translate("sharedcomponents#MySubtitles")+"</h1>",r+=n.tv?'<div class="paperList clear">':'<div class="paperList">',r+=a.map(function(e){var t="",o=n.tv?"button":"div",a=n.tv&&e.Path?"listItem btnDelete":"listItem";return t+="<"+o+' class="'+a+'" data-index="'+e.Index+'">',t+='<iron-icon class="listItemIcon" icon="mediainfo:closed-caption"></iron-icon>',t+='<div class="listItemBody">',t+='<h3 class="listItemBodyText">',t+=e.DisplayTitle||"",t+="</h3>",e.Path&&(t+='<div class="secondary listItemBodyText">'+e.Path+"</div>"),t+="</a>",t+="</div>",n.tv||e.Path&&(t+='<button is="paper-icon-button-light" data-index="'+e.Index+'" title="'+i.translate("sharedcomponents#Delete")+'" class="btnDelete"><iron-icon icon="nav:delete"></iron-icon></button>'),t+="</"+o+">"}).join(""),r+="</div>");var s=e.querySelector(".subtitleList");a.length?s.classList.remove("hide"):s.classList.add("hide"),s.innerHTML=r}function v(e,t,n){var i=e.querySelector("#selectLanguage");i.innerHTML=n.map(function(e){return'<option value="'+e.ThreeLetterISOLanguageName+'">'+e.DisplayName+"</option>"});var o=a.getItem("subtitleeditor-language");o?i.value=o:t.getCurrentUser().then(function(e){var t=e.Configuration.SubtitleLanguagePreference;t&&(i.value=t)})}function h(e,t){var i="",o="";if(!t.length)return e.querySelector(".noSearchResults").classList.remove("hide"),e.querySelector(".subtitleResults").innerHTML="",void s.hide();e.querySelector(".noSearchResults").classList.add("hide");for(var a=0,r=t.length;r>a;a++){var l=t[a],c=l.ProviderName;c!=i&&(a>0&&(o+="</div>"),o+="<h1>"+c+"</h1>",o+=n.tv?'<div class="paperList clear">':'<div class="paperList">',i=c);var u=n.tv?"button":"div",d=n.tv?"listItem btnOptions":"listItem";o+="<"+u+' class="'+d+'" data-subid="'+l.Id+'">',o+='<iron-icon class="listItemIcon" icon="mediainfo:closed-caption"></iron-icon>',o+='<div class="listItemBody">',o+='<h3 class="listItemBodyText">'+l.Name+"</h3>",o+='<div class="secondary listItemBodyText">'+l.Format+"</div>",l.Comment&&(o+='<div class="secondary listItemBodyText">'+l.Comment+"</div>"),o+="</div>",o+='<div class="secondary">'+(l.DownloadCount||0)+"</div>",n.tv||(o+='<button type="button" is="paper-icon-button-light" data-subid="'+l.Id+'" class="btnOptions"><iron-icon icon="nav:more-vert"></iron-icon></button>'),o+="</"+u+">"}t.length&&(o+="</div>");var v=e.querySelector(".subtitleResults");v.innerHTML=o,s.hide()}function m(e,t){a.setItem("subtitleeditor-language",t),s.show();var n=r.getApiClient(C.ServerId),i=n.getUrl("Items/"+C.Id+"/RemoteSearch/Subtitles/"+t);n.getJSON(i).then(function(t){h(e,t)})}function g(e,t,n){function i(t){C=t,d(e,t);var n=t.Path||"",i=Math.max(n.lastIndexOf("/"),n.lastIndexOf("\\"));i>-1&&(n=n.substring(i+1)),n?(e.querySelector(".pathValue").innerHTML=n,e.querySelector(".originalFile").classList.remove("hide")):(e.querySelector(".pathValue").innerHTML="",e.querySelector(".originalFile").classList.add("hide")),s.hide()}e.querySelector(".noSearchResults").classList.add("hide"),"string"==typeof n?t.getItem(t.getCurrentUserId(),n).then(i):i(n)}function p(e,t){for(;!e.classList||!e.classList.contains(t);)if(e=e.parentNode,!e)return null;return e}function f(e){var t=this,n=t.querySelector("#selectLanguage",t).value;return m(p(t,"dialogContent"),n),e.preventDefault(),!1}function b(e){var t=p(e.target,"btnDelete");if(t){var n=t.getAttribute("data-index"),i=p(t,"subtitleEditorDialog");u(i,n)}}function S(e){var t=p(e.target,"btnOptions");if(t){var n=t.getAttribute("data-subid"),i=p(t,"subtitleEditorDialog");y(t,i,n)}}function y(e,n,i){var o=[];o.push({name:Globalize.translate("sharedcomponents#Download"),id:"download"}),t(["actionsheet"],function(t){t.show({items:o,positionTo:e}).then(function(e){switch(e){case"download":c(n,i)}})})}function L(){var e=document.createElement("input");e.setAttribute("type","submit"),e.style.display="none";var t=p(this,"subtitleSearchForm");t.appendChild(e),e.click(),setTimeout(function(){t.removeChild(e)},500)}function I(t,a,s){T=!1;var l=r.getApiClient(a);return l.getItem(l.getCurrentUserId(),t).then(function(t){var a={removeOnClose:!0};a.size=n.tv?"fullscreen":"small";var r=e.createDialog(a);r.classList.add("formDialog"),r.classList.add("subtitleEditorDialog"),r.innerHTML=i.translateDocument(s,"sharedcomponents"),document.body.appendChild(r),r.querySelector(".originalFileLabel").innerHTML=i.translate("sharedcomponents#File"),r.querySelector(".subtitleSearchForm").addEventListener("submit",f);var c=r.querySelector(".btnSubmit");n.tv?(o.centerFocus.on(r.querySelector(".dialogContent"),!1),r.querySelector(".btnSearchSubtitles").classList.add("hide")):c.classList.add("hide");var u=r.querySelector(".dialogContent");return r.querySelector(".subtitleList").addEventListener("click",b),r.querySelector(".subtitleResults").addEventListener("click",S),l.getCultures().then(function(e){v(u,l,e)}),r.querySelector(".btnCancel").addEventListener("click",function(){e.close(r)}),c.addEventListener("click",L),new Promise(function(n,i){r.addEventListener("close",function(){T?n():i()}),e.open(r),g(u,l,t)})})}function q(e,n){return s.show(),new Promise(function(i,o){t(["text!./subtitleeditor.template.html"],function(t){I(e,n,t).then(i,o)})})}var C,T;return{show:q}});