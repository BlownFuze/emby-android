define(["viewcontainer","focusManager","queryString","connectionManager","events"],function(e,t,n){function i(e,n,i){var c=(n.type,s);c&&a(c,"viewhide"),s=e;var r=o(e,n,i);i?e.activeElement&&document.body.contains(e.activeElement)&&t.isCurrentlyFocusable(e.activeElement)?t.focus(e.activeElement):t.autoFocus(e):n.autoFocus!==!1&&t.autoFocus(e),e.dispatchEvent(new CustomEvent("viewshow",r)),l&&e.dispatchEvent(new CustomEvent("pageshow",r))}function a(e,t,n,i){var a=e.dispatchEvent(new CustomEvent(t,{detail:{type:e.getAttribute("data-type"),isRestored:n},bubbles:!0,cancelable:i||!1}));return l&&e.dispatchEvent(new CustomEvent(t.replace("view","page"),{detail:{type:e.getAttribute("data-type"),isRestored:n},bubbles:!0,cancelable:!1})),a}function o(e,t,i){var a=t.url,o=(t.state,a.indexOf("?")),c=-1==o?{}:n.parse(a.substring(o+1));return{detail:{type:e.getAttribute("data-type"),params:c,isRestored:i,state:t.state,options:t.options||{}},bubbles:!0,cancelable:!1}}function c(){e.reset()}function r(e,t,n,a){t.cancel||e.tryRestoreView(t).then(function(e){i(e,t,!0),n()},a)}function u(){var t=this;t.loadView=function(t){var n=s;n&&(n.activeElement=document.activeElement),t.cancel||e.loadView(t).then(function(e){i(e,t)})},t.tryRestoreView=function(t){return new Promise(function(n,i){t.cancel||(s&&(s.activeElement=document.activeElement),r(e,t,n,i))})},t.currentView=function(){return s},t.dispatchPageEvents=function(e){l=e}}var s,l;return e.setOnBeforeChange(function(e,t,n){var i=s;if(i){a(i,"viewbeforehide",null,!0)}if(!e.initComplete){e.initComplete=!0;var c=o(e,n,!1);if(n.controllerFactory){new n.controllerFactory(e,c.detail.params)}(!n.controllerFactory||l)&&a(e,"viewinit")}a(e,"viewbeforeshow",t)}),document.addEventListener("skinunload",c),new u});