define(["viewcontainer","focusManager","queryString","layoutManager"],function(e,t,n,i){function a(e,n,a){var r=(n.type,l);r&&o(r,"viewhide"),l=e;var u=c(e,n,a);a?i.mobile||(e.activeElement&&document.body.contains(e.activeElement)&&t.isCurrentlyFocusable(e.activeElement)?t.focus(e.activeElement):t.autoFocus(e)):n.autoFocus!==!1&&t.autoFocus(e),e.dispatchEvent(new CustomEvent("viewshow",u)),v&&e.dispatchEvent(new CustomEvent("pageshow",u))}function o(e,t,n,i){var a=e.dispatchEvent(new CustomEvent(t,{detail:{type:e.getAttribute("data-type"),isRestored:n},bubbles:!0,cancelable:i||!1}));return v&&e.dispatchEvent(new CustomEvent(t.replace("view","page"),{detail:{type:e.getAttribute("data-type"),isRestored:n},bubbles:!0,cancelable:!1})),a}function c(e,t,i){var a=t.url,o=(t.state,a.indexOf("?")),c=-1==o?{}:n.parse(a.substring(o+1));return{detail:{type:e.getAttribute("data-type"),params:c,isRestored:i,state:t.state,options:t.options||{}},bubbles:!0,cancelable:!1}}function r(){e.reset()}function u(e,t,n,i){t.cancel||e.tryRestoreView(t).then(function(e){a(e,t,!0),n()},i)}function s(){var t=this;t.loadView=function(t){var n=l;n&&(n.activeElement=document.activeElement),t.cancel||e.loadView(t).then(function(e){a(e,t)})},t.tryRestoreView=function(t){return new Promise(function(n,i){t.cancel||(l&&(l.activeElement=document.activeElement),u(e,t,n,i))})},t.currentView=function(){return l},t.dispatchPageEvents=function(e){v=e}}var l,v;return e.setOnBeforeChange(function(e,t,n){var i=l;if(i){o(i,"viewbeforehide",null,!0)}if(!e.initComplete){e.initComplete=!0;var a=c(e,n,!1);if(n.controllerFactory){new n.controllerFactory(e,a.detail.params)}(!n.controllerFactory||v)&&o(e,"viewinit")}o(e,"viewbeforeshow",t)}),document.addEventListener("skinunload",r),new s});