define(["browser"],function(e){function n(){return A?e.tv?!1:!0:!1}function t(e){if(!e.cancel){f();var n=v(w),t=-1==n?null:w[n],o=n+1;o>=L&&(o=0);var s='<div class="page-view" data-type="'+(e.type||"")+'" data-url="'+e.url+'">';s+=e.view,s+="</div>";var u=w[o],c=u.querySelector(".page-view");c&&m(c),u.innerHTML=s;var l=u.querySelector(".page-view");return y&&y(l,!1,e),r(w,o,n),a(u,t,e.transition,e.isBack).then(function(){return!e.cancel&&t&&i(w,o),l})}}function r(e,n,t){for(var r=0,i=e.length;i>r;r++)n==r||t==r||e[r].classList.add("hide")}function i(e,n){for(var t=0,r=e.length;r>t;t++)n==t||e[t].classList.add("hide")}function a(e,t,r,i){if(n()&&e.animate){if("slide"==r)return s(e,t,r,i);if("fade"==r)return u(e,t,r,i)}return o(e,t,r,i)}function o(e){return e.classList.remove("hide"),Promise.resolve()}function s(e,n,t,r){var i={duration:450,iterations:1,easing:"ease-out",fill:"both"},a=[];if(n){var o=r?"100%":"-100%";a.push(n.animate([{transform:"none",offset:0},{transform:"translateX("+o+")",offset:1}],i))}e.classList.remove("hide");var s=r?"-100%":"100%";return a.push(e.animate([{transform:"translateX("+s+")",offset:0},{transform:"none",offset:1}],i)),P=a,new Promise(function(e){a[a.length-1].onfinish=e})}function u(e,n){var t={duration:q,iterations:1,easing:"ease-out",fill:"both"},r=[];return n&&r.push(n.animate([{opacity:1,offset:0},{opacity:0,offset:1}],t)),e.classList.remove("hide"),r.push(e.animate([{opacity:0,offset:0},{opacity:1,offset:1}],t)),P=r,new Promise(function(e){r[r.length-1].onfinish=e})}function f(){for(var e=P,n=0,t=e.length;t>n;n++)c(e[n])}function c(e){try{e.cancel()}catch(n){}}function l(e){y=e}function v(e){for(var n=0,t=e.length;t>n;n++)if(!e[n].classList.contains("hide"))return n;return-1}function d(e){var n=e.url,t=document.querySelector(".page-view[data-url='"+n+"']"),o=g(t,"mainAnimatedPage");if(t){for(var s=-1,u=document.querySelectorAll(".mainAnimatedPage"),c=0,l=u.length;l>c;c++)if(u[c]==o){s=c;break}if(-1!=s){if(e.cancel)return;f();var d=w[s],m=v(w),h=-1==m?null:w[m],t=d.querySelector(".page-view");return y&&y(t,!0,e),r(w,s,m),a(d,h,e.transition,e.isBack).then(function(){return!e.cancel&&h&&i(w,s),t})}}return Promise.reject()}function m(e){e.dispatchEvent(new CustomEvent("viewdestroy",{}))}function h(){for(var e=document.querySelectorAll(".mainAnimatedPage.hide .page-view"),n=0,t=e.length;t>n;n++){var r=e[n];m(r),r.parentNode.removeChild(r)}}function g(e,n){for(;!e.classList||!e.classList.contains(n);)if(e=e.parentNode,!e)return null;return e}function p(){A&&n()&&!e.animate&&require(["webAnimations"])}var y,w=document.querySelectorAll(".mainAnimatedPage"),L=w.length,q=500,A=!0,P=[];return{loadView:t,tryRestoreView:d,reset:h,setOnBeforeChange:l,init:p}});