define(["dom"],function(t){function e(t){x.push(t)}function n(){x.length&&(x.length-=1)}function i(t,e,n){var i;return n!==!1&&(i=t.querySelector("*[autofocus]"))?(o(i),i):e!==!1&&(i=s(t)[0])?(o(i),i):null}function o(t){try{t.focus()}catch(e){}}function a(t){return-1!=w.indexOf(t.tagName)?!0:t.classList&&t.classList.contains("focusable")?!0:!1}function r(t){for(;!a(t);)if(t=t.parentNode,!t)return null;return t}function f(t){return null===t.offsetParent?!1:!0}function u(t){if(t.disabled)return!1;if("-1"==t.getAttribute("tabindex"))return!1;if("INPUT"==t.tagName){var e=t.type;if("range"==e)return!1}return f(t)}function c(){return x[0]||document.body}function s(t){for(var e=(t||c()).querySelectorAll(N),n=[],i=0,o=e.length;o>i;i++){var a=e[i];f(a)&&n.push(a)}return n}function l(t,e){if(-1!=L.indexOf(t.tagName))return!0;if(t.classList.contains("focuscontainer"))return!0;if(2>e){if(t.classList.contains("focuscontainer-x"))return!0}else if(3==e&&t.classList.contains("focuscontainer-down"))return!0;return!1}function h(t,e){for(;!l(t,e);)if(t=t.parentNode,!t)return c();return t}function p(t,e){return{pageYOffset:t.pageYOffset,pageXOffset:t.pageXOffset,clientTop:e.clientTop,clientLeft:e.clientLeft}}function d(t,e){var n={top:0,left:0};return t.getBoundingClientRect&&(n=t.getBoundingClientRect()),{top:n.top+e.pageYOffset-e.clientTop,left:n.left+e.pageXOffset-e.clientLeft}}function g(t,e){var n=d(t,e),i=n.top-e.pageYOffset,o=n.left-e.pageXOffset,a=t.offsetWidth,r=t.offsetHeight;return{left:o,top:i,width:a,height:r,right:o+a,bottom:i+r}}function b(e,n){e=e||document.activeElement,e&&(e=r(e));var a=e?h(e,n):c();if(!e)return void i(a,!0,!1);for(var f=t.parentWithClass(e,"focusable"),u=e.ownerDocument,s=p(u.defaultView,u.documentElement),l=g(e,s),d=[],b=a.querySelectorAll(N),m=0,v=b.length;v>m;m++){var T=b[m];if(T!=e&&T!=f){var O=g(T,s);switch(n){case 0:if(O.left>=l.left)continue;if(O.right==l.right)continue;break;case 1:if(O.right<=l.right)continue;if(O.left==l.left)continue;break;case 2:if(O.top>=l.top)continue;if(O.bottom>=l.bottom)continue;break;case 3:if(O.bottom<=l.bottom)continue;if(O.top<=l.top)continue}d.push({element:T,clientRect:O})}}var x=M(d,l,n);if(x.length){var w=x[0].node,L=t.parentWithClass(w,"focusable");L&&L!=w&&e&&t.parentWithClass(e,"focusable")!=L&&(w=L),o(w)}}function m(t,e,n,i){return n>=t&&e>=n||i>=t&&e>=i}function v(t,e,n,i){return m(t,e,n,i)||m(n,i,t,e)}function M(t,e,n){for(var i=[],o=parseFloat(e.left)||0,a=parseFloat(e.top)||0,r=parseFloat(o+e.width-1)||o,f=parseFloat(a+e.height-1)||a,u=(Math.min,Math.max,e.left+e.width/2),c=e.top+e.height/2,s=0,l=t.length;l>s;s++){var h,p,d=t[s],g=d.element,b=d.clientRect,m=b.left,M=b.top,O=m+b.width-1,x=M+b.height-1,w=v(o,r,m,O),L=v(a,f,M,x),N=b.left+b.width/2,y=b.top+b.height/2;switch(n){case 0:h=Math.abs(o-Math.min(o,O)),p=L?0:Math.abs(c-y);break;case 1:h=Math.abs(r-Math.max(r,m)),p=L?0:Math.abs(c-y);break;case 2:p=Math.abs(a-Math.min(a,x)),h=w?0:Math.abs(u-N);break;case 3:p=Math.abs(f-Math.max(f,M)),h=w?0:Math.abs(u-N)}var E=Math.sqrt(h*h+p*p);i.push({node:g,distX:h,distY:p,distT:E,index:s})}return i.sort(T),i}function T(t,e){var n=t.distT-e.distT;return 0!=n?n:(n=t.index-e.index,0!=n?n:0)}function O(t){var e=document.activeElement;e.value=t}var x=[],w=["INPUT","TEXTAREA","SELECT","BUTTON","A"],L=["BODY","DIALOG"],N=w.map(function(t){return"INPUT"==t&&(t+=':not([type="range"])'),t+':not([tabindex="-1"]):not(:disabled)'}).join(",")+",.focusable";return{autoFocus:i,focus:o,focusableParent:r,getFocusableElements:s,moveLeft:function(t){b(t,0)},moveRight:function(t){b(t,1)},moveUp:function(t){b(t,2)},moveDown:function(t){b(t,3)},sendText:O,isCurrentlyFocusable:u,pushScope:e,popScope:n}});