define(["dialogHelper","inputManager","connectionManager","layoutManager","focusManager","apphost","css!./style","html!./icons","iron-icon-set","paper-icon-button-light","paper-spinner"],function(e,t,i,a,n,o){function s(e,t,i){return t=t||{},t.type=t.type||"Primary","string"==typeof e?i.getScaledImageUrl(e,t):e.ImageTags&&e.ImageTags[t.type]?(t.tag=e.ImageTags[t.type],i.getScaledImageUrl(e.Id,t)):"Primary"==t.type&&e.AlbumId&&e.AlbumPrimaryImageTag?(t.tag=e.AlbumPrimaryImageTag,i.getScaledImageUrl(e.AlbumId,t)):null}function r(e,t,i){return t=t||{},t.type=t.type||"Backdrop",t.maxWidth||t.width||t.maxHeight||t.height||(t.quality=100),e.BackdropImageTags&&e.BackdropImageTags.length?(t.tag=e.BackdropImageTags[0],i.getScaledImageUrl(e.Id,t)):null}function l(e,t){var a=i.getApiClient(e.ServerId),n={};return t||(n.maxWidth=screen.availWidth),e.BackdropImageTags&&e.BackdropImageTags.length?r(e,n,a):"Photo"==e.MediaType&&t?a.getUrl("Items/"+e.Id+"/Download",{api_key:a.accessToken()}):(n.type="Primary",s(e,n,a))}function d(e,t,i,a){var n=i?"":' tabindex="-1"';return a=a?" autofocus":"",'<button is="paper-icon-button-light" class="'+t+'"'+n+a+'><iron-icon icon="'+e+'"></iron-icon></button>'}return function(i){function s(i){H=e.createDialog({exitAnimationDuration:i.interactive?400:800,size:"fullscreen",autoFocus:!1,scrollY:!1,exitAnimation:"fadeout"}),H.classList.add("slideshowDialog");var n="";if(i.interactive){var s=a.mobile;n+="<div>",n+='<div class="slideshowSwiperContainer"><div class="swiper-wrapper"></div></div>',n+=d("slideshow:keyboard-arrow-left","btnSlideshowPrevious slideshowButton",!1),n+=d("slideshow:keyboard-arrow-right","btnSlideshowNext slideshowButton",!1),n+='<div class="topActionButtons">',s&&(o.supports("filedownload")&&(n+=d("slideshow:file-download","btnDownload slideshowButton",!0)),o.supports("sharing")&&(n+=d("slideshow:share","btnShare slideshowButton",!0))),n+=d("slideshow:close","slideshowButton btnSlideshowExit",!1),n+="</div>",s||(n+='<div class="slideshowBottomBar hide">',n+=d("slideshow:pause","btnSlideshowPause slideshowButton",!0,!0),o.supports("filedownload")&&(n+=d("slideshow:file-download","btnDownload slideshowButton",!0)),o.supports("sharing")&&(n+=d("slideshow:share","btnShare slideshowButton",!0)),n+="</div>"),n+="</div>"}else n+='<div class="slideshowImage"></div><h1 class="slideshowImageText"></h1>';if(H.innerHTML=n,i.interactive){H.querySelector(".btnSlideshowExit").addEventListener("click",function(){e.close(H)}),H.querySelector(".btnSlideshowNext").addEventListener("click",m),H.querySelector(".btnSlideshowPrevious").addEventListener("click",v);var l=H.querySelector(".btnSlideshowPause");l&&l.addEventListener("click",S);var c=H.querySelector(".btnDownload");c&&c.addEventListener("click",g);var u=H.querySelector(".btnShare");u&&u.addEventListener("click",w)}document.body.appendChild(H),e.open(H).then(function(){z(),H.parentNode.removeChild(H)}),t.on(window,D),document.addEventListener("mousemove",M),H.addEventListener("close",b),i.interactive&&r(H)}function r(e){e.querySelector(".swiper-wrapper").innerHTML=W.slides?W.slides.map(f).join(""):W.items.map(c).join(""),require(["swiper"],function(){C=new Swiper(e.querySelector(".slideshowSwiperContainer"),{direction:"horizontal",loop:i.loop!==!1,autoplay:i.interval||8e3,preloadImages:!1,lazyLoading:!0,lazyLoadingInPrevNext:!0,autoplayDisableOnInteraction:!1,initialSlide:i.startIndex||0,speed:240}),C.on("onLazyImageLoad",u),C.on("onLazyImageReady",p),a.mobile?I():y()})}function c(e){return f({imageUrl:l(e),originalImage:l(e,!0),Id:e.Id,ServerId:e.ServerId})}function u(e,t){var i=t.querySelector("paper-spinner");i&&(i.active=!0)}function p(e,t){var i=t.querySelector("paper-spinner");i&&(i.active=!1,i.parentNode.removeChild(i))}function f(e){var t="";return t+='<div class="swiper-slide" data-original="'+e.originalImage+'" data-itemid="'+e.Id+'" data-serverid="'+e.ServerId+'">',t+='<img data-src="'+e.imageUrl+'" class="swiper-lazy">',t+="<paper-spinner></paper-spinner>",(e.title||e.subtitle)&&(t+='<div class="slideText">',t+='<div class="slideTextInner">',e.title&&(t+='<div class="slideTitle">',t+=e.title,t+="</div>"),e.description&&(t+='<div class="slideSubtitle">',t+=e.description,t+="</div>"),t+="</div>",t+="</div>"),t+="</div>"}function v(){C?C.slidePrev():(z(),N(j-1))}function m(){if(C){if(i.loop===!1&&C.activeIndex>=C.slides.length-1)return void e.close(H);C.slideNext()}else z(),N(j+1)}function h(){if(C){var e=document.querySelector(".swiper-slide-active");return e?{url:e.getAttribute("data-original"),itemId:e.getAttribute("data-itemid"),serverId:e.getAttribute("data-serverid")}:null}return null}function g(){var e=h();require(["fileDownloader"],function(t){t.download([e])})}function w(){var e=h();require(["sharingmanager"],function(t){t.showMenu(e)})}function y(){var e=H.querySelector(".btnSlideshowPause iron-icon");e&&(e.icon="slideshow:pause"),C.startAutoplay()}function I(){var e=H.querySelector(".btnSlideshowPause iron-icon");e&&(e.icon="slideshow:play-arrow"),C.stopAutoplay()}function S(){var e="slideshow:pause"!=H.querySelector(".btnSlideshowPause iron-icon").icon;e?y():I()}function b(){var e=C;e&&(e.off("onLazyImageLoad"),e.off("onLazyImageReady"),e.destroy(!0,!0),C=null),t.off(window,D),document.removeEventListener("mousemove",M)}function L(e){W=e,z(),s(e),e.interactive||(F=e.interval||8e3,N(e.startIndex||0,!0))}function x(){return X}function T(){return H.querySelector(".slideshowBottomBar")}function q(){var e=T();e&&(A(e),B())}function k(){var e=T();e&&E(e)}function B(){P(),R=setTimeout(k,4e3)}function P(){R&&(clearTimeout(R),R=null)}function A(e){e.classList.contains("hide")&&(X=!0,e.classList.remove("hide"),requestAnimationFrame(function(){var t=[{transform:"translate3d(0,"+e.offsetHeight+"px,0)",opacity:".3",offset:0},{transform:"translate3d(0,0,0)",opacity:"1",offset:1}],i={duration:300,iterations:1,easing:"ease-out"};e.animate(t,i).onfinish=function(){n.focus(e.querySelector(".btnSlideshowPause"))}}))}function E(e){e.classList.contains("hide")||requestAnimationFrame(function(){var t=[{transform:"translate3d(0,0,0)",opacity:"1",offset:0},{transform:"translate3d(0,"+e.offsetHeight+"px,0)",opacity:".3",offset:1}],i={duration:300,iterations:1,easing:"ease-out"};e.animate(t,i).onfinish=function(){e.classList.add("hide"),X=!1}})}function M(e){var t=e.screenX||0,i=e.screenY||0,a=Y;return a?void(Math.abs(t-a.x)<10&&Math.abs(i-a.y)<10||(a.x=t,a.y=i,q())):void(Y={x:t,y:i})}function D(e){switch(e.detail.command){case"left":x()||(e.preventDefault(),v());break;case"right":x()||(e.preventDefault(),m());break;case"up":case"down":case"select":case"menu":case"info":case"play":case"playpause":case"pause":case"fastforward":case"rewind":case"next":case"previous":q()}}function N(e,t){e=Math.max(0,e),e>=W.items.length&&(e=0),j=e;var i=W,a=i.items,n=a[e],o=l(n),s=function(){var t=H.querySelector(".slideshowImage"),a=document.createElement("div");a.className=t.className,i.cover&&a.classList.add("cover"),a.style.backgroundImage="url('"+o+"')",a.classList.add("hide"),t.parentNode.appendChild(a),H.querySelector(".slideshowImageText").innerHTML=i.showTitle?n.Name:"",a.classList.remove("hide");var s=function(){var e=t.parentNode;e&&e.removeChild(t)};if(a.animate){var r=[{opacity:"0",offset:0},{opacity:"1",offset:1}],l={duration:1200,iterations:1};a.animate(r,l).onfinish=s}else s();z(),U=setTimeout(function(){N(e+1,!0)},F)};if(t)s();else{var r=new Image;r.onload=s,r.src=o}}function z(){U&&(clearTimeout(U),U=null)}var C,H,U,F,W,j,R,Y,O=this,X=!1;O.show=function(){L(i)},O.hide=function(){var t=H;t&&e.close(t)}}});