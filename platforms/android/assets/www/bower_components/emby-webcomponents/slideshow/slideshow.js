define(["dialogHelper","inputManager","connectionManager","layoutManager","focusManager","apphost","css!./style","html!./icons","iron-icon-set","paper-icon-button-light","paper-spinner"],function(e,t,i,a,n,o){function r(e,t,i){return t=t||{},t.type=t.type||"Primary","string"==typeof e?i.getScaledImageUrl(e,t):e.ImageTags&&e.ImageTags[t.type]?(t.tag=e.ImageTags[t.type],i.getScaledImageUrl(e.Id,t)):"Primary"==t.type&&e.AlbumId&&e.AlbumPrimaryImageTag?(t.tag=e.AlbumPrimaryImageTag,i.getScaledImageUrl(e.AlbumId,t)):null}function s(e,t,i){return t=t||{},t.type=t.type||"Backdrop",t.width=null,delete t.width,t.maxWidth=null,delete t.maxWidth,t.maxHeight=null,delete t.maxHeight,t.height=null,delete t.height,t.maxWidth||t.width||t.maxHeight||t.height||(t.quality=100),e.BackdropImageTags&&e.BackdropImageTags.length?(t.tag=e.BackdropImageTags[0],i.getScaledImageUrl(e.Id,t)):null}function l(e,t){var a=i.getApiClient(e.ServerId),n={};return t||(n.maxWidth=screen.availWidth),e.BackdropImageTags&&e.BackdropImageTags.length?s(e,n,a):"Photo"==e.MediaType&&t?a.getUrl("Items/"+e.Id+"/Download",{api_key:a.accessToken()}):(n.type="Primary",r(e,n,a))}function d(e,t,i,a){var n=i?"":' tabindex="-1"';return a=a?" autofocus":"",'<button is="paper-icon-button-light" class="'+t+'"'+n+a+'><iron-icon icon="'+e+'"></iron-icon></button>'}return function(i){function r(i){C=e.createDialog({exitAnimationDuration:i.interactive?400:800,size:"fullscreen",autoFocus:!1,scrollY:!1}),C.classList.add("slideshowDialog");var n="";if(i.interactive){var r=a.mobile;n+="<div>",n+='<div class="slideshowSwiperContainer"><div class="swiper-wrapper"></div></div>',n+=d("slideshow:keyboard-arrow-left","btnSlideshowPrevious slideshowButton",!1),n+=d("slideshow:keyboard-arrow-right","btnSlideshowNext slideshowButton",!1),n+='<div class="topActionButtons">',r&&(o.supports("filedownload")&&(n+=d("slideshow:file-download","btnDownload slideshowButton",!0)),o.supports("sharing")&&(n+=d("slideshow:share","btnShare slideshowButton",!0))),n+=d("slideshow:close","slideshowButton btnSlideshowExit",!1),n+="</div>",r||(n+='<div class="slideshowBottomBar hide">',n+=d("slideshow:pause","btnSlideshowPause slideshowButton",!0,!0),o.supports("filedownload")&&(n+=d("slideshow:file-download","btnDownload slideshowButton",!0)),o.supports("sharing")&&(n+=d("slideshow:share","btnShare slideshowButton",!0)),n+="</div>"),n+="</div>"}else n+='<div class="slideshowImage"></div><h1 class="slideshowImageText"></h1>';if(C.innerHTML=n,i.interactive){C.querySelector(".btnSlideshowExit").addEventListener("click",function(){e.close(C)}),C.querySelector(".btnSlideshowNext").addEventListener("click",m),C.querySelector(".btnSlideshowPrevious").addEventListener("click",f);var l=C.querySelector(".btnSlideshowPause");l&&l.addEventListener("click",S);var c=C.querySelector(".btnDownload");c&&c.addEventListener("click",g);var u=C.querySelector(".btnShare");u&&u.addEventListener("click",w)}document.body.appendChild(C),e.open(C).then(function(){z(),C.parentNode.removeChild(C)}),t.on(window,D),document.addEventListener("mousemove",M),C.addEventListener("close",b),i.interactive&&s(C)}function s(e){e.querySelector(".swiper-wrapper").innerHTML=F.slides?F.slides.map(p).join(""):F.items.map(c).join(""),require(["swiper"],function(){H=new Swiper(e.querySelector(".slideshowSwiperContainer"),{direction:"horizontal",loop:i.loop!==!1,autoplay:i.interval||8e3,preloadImages:!1,lazyLoading:!0,lazyLoadingInPrevNext:!0,autoplayDisableOnInteraction:!1,initialSlide:i.startIndex||0}),H.on("onLazyImageLoad",u),H.on("onLazyImageReady",h),a.mobile?I():y()})}function c(e){return p({imageUrl:l(e),originalImage:l(e,!0),Id:e.Id,ServerId:e.ServerId})}function u(e,t){var i=t.querySelector("paper-spinner");i&&(i.active=!0)}function h(e,t){var i=t.querySelector("paper-spinner");i&&(i.active=!1,i.parentNode.removeChild(i))}function p(e){var t="";return t+='<div class="swiper-slide" data-original="'+e.originalImage+'" data-itemid="'+e.Id+'" data-serverid="'+e.ServerId+'">',t+='<img data-src="'+e.imageUrl+'" class="swiper-lazy">',t+="<paper-spinner></paper-spinner>",(e.title||e.subtitle)&&(t+='<div class="slideText">',t+='<div class="slideTextInner">',e.title&&(t+='<div class="slideTitle">',t+=e.title,t+="</div>"),e.description&&(t+='<div class="slideSubtitle">',t+=e.description,t+="</div>"),t+="</div>",t+="</div>"),t+="</div>"}function f(){H?H.slidePrev():(z(),N(j-1))}function m(){if(H){if(i.loop===!1&&H.activeIndex>=H.slides.length-1)return void e.close(C);H.slideNext()}else z(),N(j+1)}function v(){if(H){var e=document.querySelector(".swiper-slide-active");return e?{url:e.getAttribute("data-original"),itemId:e.getAttribute("data-itemid"),serverId:e.getAttribute("data-serverid")}:null}return null}function g(){var e=v();require(["fileDownloader"],function(t){t.download([e])})}function w(){var e=v();require(["sharingmanager"],function(t){t.showMenu(e)})}function y(){var e=C.querySelector(".btnSlideshowPause iron-icon");e&&(e.icon="slideshow:pause"),H.startAutoplay()}function I(){var e=C.querySelector(".btnSlideshowPause iron-icon");e&&(e.icon="slideshow:play-arrow"),H.stopAutoplay()}function S(){var e="slideshow:pause"!=C.querySelector(".btnSlideshowPause iron-icon").icon;e?y():I()}function b(){var e=H;e&&(e.off("onLazyImageLoad"),e.off("onLazyImageReady"),e.destroy(!0,!0),H=null),t.off(window,D),document.removeEventListener("mousemove",M)}function x(e){F=e,z(),r(e),e.interactive||(W=e.interval||8e3,N(e.startIndex||0,!0))}function L(){return X}function T(){return C.querySelector(".slideshowBottomBar")}function q(){var e=T();e&&(A(e),B())}function k(){var e=T();e&&E(e)}function B(){P(),R=setTimeout(k,4e3)}function P(){R&&(clearTimeout(R),R=null)}function A(e){e.classList.contains("hide")&&(X=!0,e.classList.remove("hide"),requestAnimationFrame(function(){var t=[{transform:"translate3d(0,"+e.offsetHeight+"px,0)",opacity:".3",offset:0},{transform:"translate3d(0,0,0)",opacity:"1",offset:1}],i={duration:300,iterations:1,easing:"ease-out"};e.animate(t,i).onfinish=function(){n.focus(e.querySelector(".btnSlideshowPause"))}}))}function E(e){e.classList.contains("hide")||requestAnimationFrame(function(){var t=[{transform:"translate3d(0,0,0)",opacity:"1",offset:0},{transform:"translate3d(0,"+e.offsetHeight+"px,0)",opacity:".3",offset:1}],i={duration:300,iterations:1,easing:"ease-out"};e.animate(t,i).onfinish=function(){e.classList.add("hide"),X=!1}})}function M(e){var t=e.screenX||0,i=e.screenY||0,a=Y;return a?void(Math.abs(t-a.x)<10&&Math.abs(i-a.y)<10||(a.x=t,a.y=i,q())):void(Y={x:t,y:i})}function D(e){switch(e.detail.command){case"left":L()||(e.preventDefault(),f());break;case"right":L()||(e.preventDefault(),m());break;case"up":case"down":case"select":case"menu":case"info":case"play":case"playpause":case"pause":case"fastforward":case"rewind":case"next":case"previous":q()}}function N(e,t){e=Math.max(0,e),e>=F.items.length&&(e=0),j=e;var i=F,a=i.items,n=a[e],o=l(n),r=function(){var t=C.querySelector(".slideshowImage"),a=document.createElement("div");a.className=t.className,i.cover&&a.classList.add("cover"),a.style.backgroundImage="url('"+o+"')",a.classList.add("hide"),t.parentNode.appendChild(a),C.querySelector(".slideshowImageText").innerHTML=i.showTitle?n.Name:"",a.classList.remove("hide");var r=function(){var e=t.parentNode;e&&e.removeChild(t)};if(a.animate){var s=[{opacity:"0",offset:0},{opacity:"1",offset:1}],l={duration:1200,iterations:1};a.animate(s,l).onfinish=r}else r();z(),U=setTimeout(function(){N(e+1,!0)},W)};if(t)r();else{var s=new Image;s.onload=r,s.src=o}}function z(){U&&(clearTimeout(U),U=null)}var H,C,U,W,F,j,R,Y,O=this,X=!1;O.show=function(){x(i)},O.hide=function(){var t=C;t&&e.close(t)}}});