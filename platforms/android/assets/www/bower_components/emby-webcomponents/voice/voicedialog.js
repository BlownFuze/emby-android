define(["dialogHelper","voiceReceiver","voiceProcessor","globalize","emby-button","css!./voice.css","material-icons","css!./../formdialog"],function(e,n,t,o){function i(e){for(var n,t,o=e.length;0!==o;)t=Math.floor(Math.random()*o),o-=1,n=e[o],e[o]=e[t],e[t]=n;return e}function a(e){return t.getCommandGroups().then(function(n){e="undefined"!=typeof e?e:"";var t=[];return n.map(function(n){n.items&&n.items.length>0&&(e==n.groupid||""==e)&&n.items.map(function(e){e.commandtemplates&&e.commandtemplates.length>0&&e.commandtemplates.map(function(e){t.push(e)})})}),i(t)})}function c(e){return n.getCommandGroups().then(function(n){if(n){var t=-1;return t=n.map(function(e){return e.groupid}).indexOf(e),t>-1?n[t]:null}return null})}function s(e,n){n.length=Math.min(n.length,4),n=n.map(function(e){return'<div class="exampleCommand"><span class="exampleCommandText">"'+e+'"</span></div>'}).join(""),e.querySelector(".exampleCommands").innerHTML=n}function r(t,i){function r(){e.close(l)}var l,d=!1;if(!g){d=!0,l=e.createDialog({size:"medium",removeOnClose:!0}),l.classList.add("formDialog");var u="";u+='<div class="dialogHeader">',u+='<button is="paper-icon-button-light" class="btnCancelVoiceInput autoSize" tabindex="-1"><i class="md-icon">&#xE5C4;</i></button>',u+='<div class="dialogHeaderTitle">',u+=o.translate("sharedcomponents#VoiceInput"),u+="</div>",u+="</div>",u+="<div>",u+='<div class="dialogContent smoothScrollY" style="padding-top:2em;">',u+='<div class="dialogContentInner centeredContent">',u+='<div class="voiceHelpContent">',u+='<div class="defaultVoiceHelp">',u+='<h1 style="margin-bottom:1.25em;margin-top:0;">'+o.translate("sharedcomponents#HeaderSaySomethingLike")+"</h1>",u+='<div class="exampleCommands">',u+="</div>",u+="</div>",u+='<div class="unrecognizedCommand hide">',u+='<h1 style="margin-top:0;">'+o.translate("sharedcomponents#HeaderYouSaid")+"</h1>",u+='<p class="exampleCommand voiceInputContainer"><i class="fa fa-quote-left"></i><span class="voiceInputText exampleCommandText"></span><i class="fa fa-quote-right"></i></p>',u+="<p>"+o.translate("sharedcomponents#MessageWeDidntRecognizeCommand")+"</p>",u+="<br/>",u+='<button is="emby-button" type="button" class="submit block btnRetry raised"><i class="md-icon">mic</i><span>'+o.translate("sharedcomponents#ButtonTryAgain")+"</span></button>",u+='<p class="blockedMessage hide">'+o.translate("sharedcomponents#MessageIfYouBlockedVoice")+"<br/><br/></p>",u+="</div>",u+="</div>",u+="</div>",u+="</div>",u+="</div>",l.innerHTML=u,document.body.appendChild(l),e.open(l),g=l,l.addEventListener("close",function(){n.cancel(),g=null});for(var m=l.querySelectorAll(".btnCancelVoiceInput"),p=0,v=m.length;v>p;p++)m[p].addEventListener("click",r);l.querySelector(".btnRetry").addEventListener("click",function(){l.querySelector(".unrecognizedCommand").classList.add("hide"),l.querySelector(".defaultVoiceHelp").classList.remove("hide"),f()})}l=g,t?(c(t).then(function(e){l.querySelector("#voiceDialogGroupName").innerText="  "+e.name}),a(t).then(function(e){s(g,e),f()}).catch(function(e){})):d&&a().then(function(e){s(g,e)})}function l(e){return t.processTranscript(e)}function d(e){e&&(g.querySelector(".voiceInputText").innerText=e),g.querySelector(".unrecognizedCommand").classList.remove("hide"),g.querySelector(".defaultVoiceHelp").classList.add("hide")}function u(e){e?r(e.groupid,e.name):r()}function m(){g&&(g.querySelector(".unrecognizedCommand").classList.add("hide"),g.querySelector(".defaultVoiceHelp").classList.remove("hide"))}function p(){m(),u(),f()}function f(){n.listen({lang:h||"en-US"}).then(l).then(function(e){v(),setTimeout(function(){e.fn()},1)},function(e){return"group"==e.error?void r(e.item.groupid,e.groupName):void d(e.text||"")})}function v(){e.close(g),n.cancel()}var g,h="en-US";return{showDialog:p}});