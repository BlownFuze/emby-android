define(["apphost","globalize","connectionManager","itemHelper"],function(e,n,t,r){function o(o){var a=o.item,s=a.ServerId,i=t.getApiClient(s);return i.getCurrentUser().then(function(t){var o=[];return r.supportsAddingToCollection(a)&&o.push({name:n.translate("sharedcomponents#AddToCollection"),id:"addtocollection"}),r.supportsAddingToPlaylist(a)&&o.push({name:n.translate("sharedcomponents#AddToPlaylist"),id:"addtoplaylist"}),a.CanDelete&&o.push({name:n.translate("sharedcomponents#Delete"),id:"delete"}),a.CanDownload&&e.supports("filedownload")&&o.push({name:n.translate("sharedcomponents#Download"),id:"download"}),t.Policy.IsAdministrator&&o.push({name:n.translate("Refresh"),id:"refresh"}),"Timer"!=a.Type&&t.Policy.EnablePublicSharing&&e.supports("sharing")&&o.push({name:n.translate("Share"),id:"share"}),o})}function a(e,n){var r=e.Id,o=e.ServerId,a=t.getApiClient(o);return new Promise(function(e,t){switch(n){case"addtocollection":require(["collectionEditor"],function(e){(new e).show({items:[r],serverId:o}).then(t,t)});break;case"addtoplaylist":require(["playlistEditor"],function(e){(new e).show({items:[r],serverId:o}).then(t,t)});break;case"download":require(["fileDownloader"],function(e){var n=a.getUrl("Items/"+r+"/Download",{api_key:a.accessToken()});e.download([{url:n,itemId:r,serverId:o}]),t()});break;case"refresh":i(a,r),t();break;case"delete":s(a,r).then(function(){e(!0)});break;case"share":require(["sharingmanager"],function(e){e.showMenu({serverId:o,itemId:r}).then(t)});break;default:t()}})}function s(e,t){return new Promise(function(r,o){var a=n.translate("sharedcomponents#ConfirmDeleteItem"),s=n.translate("sharedcomponents#HeaderDeleteItem");require(["confirm"],function(n){n(a,s).then(function(){e.deleteItem(t).then(function(){r(!0)})},o)})})}function i(e,t){e.refreshItem(t,{Recursive:!0,ImageRefreshMode:"FullRefresh",MetadataRefreshMode:"FullRefresh",ReplaceAllImages:!1,ReplaceAllMetadata:!0}),require(["toast"],function(e){e(n.translate("sharedcomponents#RefreshQueued"))})}function l(e){return o(e).then(function(n){return new Promise(function(t,r){require(["actionsheet"],function(o){o.show({items:n}).then(function(n){a(e.item,n).then(t)},r)})})})}return{getCommands:o,show:l}});