define(["apphost","globalize","connectionManager","itemHelper"],function(e,t,n,r){function a(a){var o=a.item,s=o.ServerId,i=n.getApiClient(s);return i.getCurrentUser().then(function(n){var a=[];return r.supportsAddingToCollection(o)&&a.push({name:t.translate("sharedcomponents#AddToCollection"),id:"addtocollection"}),r.supportsAddingToPlaylist(o)&&a.push({name:t.translate("sharedcomponents#AddToPlaylist"),id:"addtoplaylist"}),o.CanDelete&&a.push({name:t.translate("sharedcomponents#Delete"),id:"delete"}),n.Policy.IsAdministrator&&"Video"==o.MediaType&&"TvChannel"!=o.Type&&"Program"!=o.Type&&"Virtual"!=o.LocationType&&a.push({name:t.translate("sharedcomponents#EditSubtitles"),id:"editsubtitles"}),o.CanDownload&&e.supports("filedownload")&&a.push({name:t.translate("sharedcomponents#Download"),id:"download"}),n.Policy.IsAdministrator&&a.push({name:t.translate("Refresh"),id:"refresh"}),"Timer"!=o.Type&&n.Policy.EnablePublicSharing&&e.supports("sharing")&&a.push({name:t.translate("Share"),id:"share"}),a})}function o(e,t){var r=e.Id,a=e.ServerId,o=n.getApiClient(a);return new Promise(function(e,n){switch(t){case"addtocollection":require(["collectionEditor"],function(e){(new e).show({items:[r],serverId:a}).then(n,n)});break;case"addtoplaylist":require(["playlistEditor"],function(e){(new e).show({items:[r],serverId:a}).then(n,n)});break;case"download":require(["fileDownloader"],function(e){var t=o.getUrl("Items/"+r+"/Download",{api_key:o.accessToken()});e.download([{url:t,itemId:r,serverId:a}]),n()});break;case"editsubtitles":require(["subtitleEditor"],function(t){var a=o.serverInfo().Id;t.show(r,a).then(e,n)});break;case"refresh":i(o,r),n();break;case"delete":s(o,r).then(function(){e(!0)});break;case"share":require(["sharingmanager"],function(e){e.showMenu({serverId:a,itemId:r}).then(n)});break;default:n()}})}function s(e,n){return new Promise(function(r,a){var o=t.translate("sharedcomponents#ConfirmDeleteItem"),s=t.translate("sharedcomponents#HeaderDeleteItem");require(["confirm"],function(t){t(o,s).then(function(){e.deleteItem(n).then(function(){r(!0)})},a)})})}function i(e,n){e.refreshItem(n,{Recursive:!0,ImageRefreshMode:"FullRefresh",MetadataRefreshMode:"FullRefresh",ReplaceAllImages:!1,ReplaceAllMetadata:!0}),require(["toast"],function(e){e(t.translate("sharedcomponents#RefreshQueued"))})}function l(e){return a(e).then(function(t){return new Promise(function(n,r){require(["actionsheet"],function(a){a.show({items:t}).then(function(t){o(e.item,t).then(n)},r)})})})}return{getCommands:a,show:l}});