define(["apphost","globalize","connectionManager","itemHelper","embyRouter","playbackManager","loading"],function(e,n,t,a,r,s,o){function i(r){var o=r.item,i=o.ServerId,d=t.getApiClient(i),l=s.canPlay(o);return d.getCurrentUser().then(function(t){var i=[];if(a.supportsAddingToCollection(o)&&i.push({name:n.translate("sharedcomponents#AddToCollection"),id:"addtocollection"}),a.supportsAddingToPlaylist(o)&&i.push({name:n.translate("sharedcomponents#AddToPlaylist"),id:"addtoplaylist"}),"Timer"==o.Type&&t.Policy.EnableLiveTvManagement&&i.push({name:n.translate("sharedcomponents#ButtonCancel"),id:"canceltimer"}),o.CanDelete&&i.push({name:n.translate("sharedcomponents#Delete"),id:"delete"}),a.canEdit(t,o.Type)&&!y&&r.edit!==!1){var d=n.translate("Timer"==o.Type?"sharedcomponents#Edit":"sharedcomponents#EditInfo");i.push({name:d,id:"edit"})}return a.canEditImages(t,o.Type)&&(y||r.editImages!==!1&&i.push({name:n.translate("sharedcomponents#EditImages"),id:"editimages"})),a.canEdit(t,o.Type)&&"Video"==o.MediaType&&"TvChannel"!=o.Type&&"Program"!=o.Type&&"Virtual"!=o.LocationType&&r.editSubtitles!==!1&&i.push({name:n.translate("sharedcomponents#EditSubtitles"),id:"editsubtitles"}),o.CanDownload&&e.supports("filedownload")&&i.push({name:n.translate("sharedcomponents#Download"),id:"download"}),y||r.identify===!1||a.canIdentify(t,o.Type)&&i.push({name:n.translate("sharedcomponents#Identify"),id:"identify"}),("Audio"==o.MediaType||"MusicAlbum"==o.Type||"MusicArtist"==o.Type||"MusicGenre"==o.Type||"music"==o.CollectionType)&&r.instantMix!==!1&&i.push({name:n.translate("sharedcomponents#InstantMix"),id:"instantmix"}),r.open!==!1&&"Timer"!=o.Type&&"Audio"!=o.Type&&i.push({name:n.translate("sharedcomponents#Open"),id:"open"}),l&&(r.play!==!1&&i.push({name:n.translate("sharedcomponents#Play"),id:"resume"}),r.playAllFromHere&&"Program"!=o.Type&&"TvChannel"!=o.Type&&i.push({name:n.translate("sharedcomponents#PlayAllFromHere"),id:"playallfromhere"}),s.canQueueMediaType(o.MediaType)&&(r.queue!==!1&&i.push({name:n.translate("sharedcomponents#Queue"),id:"queue"}),r.queueAllFromHere&&i.push({name:n.translate("sharedcomponents#QueueAllFromHere"),id:"queueallfromhere"}))),"Program"!=o.Type||o.TimerId||o.SeriesTimerId||i.push({name:Globalize.translate("sharedcomponents#Record"),id:"record"}),t.Policy.IsAdministrator&&"Timer"!=o.Type&&"Program"!=o.Type&&i.push({name:n.translate("sharedcomponents#Refresh"),id:"refresh"}),o.PlaylistItemId&&r.playlistId&&i.push({name:n.translate("sharedcomponents#RemoveFromPlaylist"),id:"removefromplaylist"}),r.collectionId&&i.push({name:n.translate("sharedcomponents#RemoveFromCollection"),id:"removefromcollection"}),r.share!==!1&&a.canShare(t,o)&&i.push({name:n.translate("sharedcomponents#Share"),id:"share"}),(o.IsFolder||"MusicArtist"==o.Type||"MusicGenre"==o.Type)&&r.shuffle!==!1&&i.push({name:n.translate("sharedcomponents#Shuffle"),id:"shuffle"}),y||r.sync===!1||a.canSync(t,o)&&i.push({name:n.translate("sharedcomponents#Sync"),id:"sync"}),r.openAlbum!==!1&&o.AlbumId&&i.push({name:Globalize.translate("sharedcomponents#ViewAlbum"),id:"album"}),r.openArtist!==!1&&o.ArtistItems&&o.ArtistItems.length&&i.push({name:Globalize.translate("sharedcomponents#ViewArtist"),id:"artist"}),i})}function d(e,n,t,a){return function(){e({command:n,updated:t,deleted:a})}}function l(e,n,a){var o=e.Id,i=e.ServerId,l=t.getApiClient(i);return new Promise(function(t,f){switch(n){case"addtocollection":require(["collectionEditor"],function(e){(new e).show({items:[o],serverId:i}).then(d(t,n,!0),d(t,n))});break;case"addtoplaylist":require(["playlistEditor"],function(e){(new e).show({items:[o],serverId:i}).then(d(t,n,!0),d(t,n))});break;case"download":require(["fileDownloader"],function(e){var a=l.getUrl("Items/"+o+"/Download",{api_key:l.accessToken()});e.download([{url:a,itemId:o,serverId:i}]),d(d(t,n),n)()});break;case"editsubtitles":require(["subtitleEditor"],function(e){var a=l.serverInfo().Id;e.show(o,a).then(d(t,n,!0),d(t,n))});break;case"edit":u(l,e).then(d(t,n,!0),d(t,n));break;case"editimages":require(["components/imageeditor/imageeditor"],function(e){e.show(o).then(d(t,n,!0),d(t,n))});break;case"identify":require(["components/itemidentifier/itemidentifier"],function(e){e.show(o).then(d(t,n,!0),d(t,n))});break;case"refresh":h(l,o),d(t,n)();break;case"open":r.showItem(e),d(t,n)();break;case"play":m(e,!1),d(t,n)();break;case"resume":m(e,!0),d(t,n)();break;case"queue":m(e,!1,!0),d(t,n)();break;case"record":require(["recordingCreator"],function(e){e.show(o,i).then(d(t,n,!0),d(t,n))});break;case"shuffle":s.shuffle(e),d(t,n)();break;case"instantmix":s.instantMix(e),d(t,n)();break;case"delete":p(l,o).then(d(t,n,!0,!0),d(t,n));break;case"share":require(["sharingmanager"],function(e){e.showMenu({serverId:i,itemId:o}).then(d(t,n))});break;case"album":r.showItem(e.AlbumId,e.ServerId),d(t,n)();break;case"artist":r.showItem(e.ArtistItems[0].Id,e.ServerId),d(t,n)();break;case"playallfromhere":d(t,n)();break;case"queueallfromhere":d(t,n)();break;case"sync":require(["syncDialog"],function(e){e.showMenu({items:[{Id:o}]})}),d(t,n)();break;case"removefromplaylist":l.ajax({url:l.getUrl("Playlists/"+a.playlistId+"/Items",{EntryIds:[e.PlaylistItemId].join(",")}),type:"DELETE"}).then(function(){d(t,n,!0)()});break;case"removefromcollection":l.ajax({type:"DELETE",url:l.getUrl("Collections/"+a.collectionId+"/Items",{Ids:[e.Id].join(",")})}).then(function(){d(t,n,!0)()});break;case"canceltimer":c(l,e,t,n);break;default:f()}})}function c(e,t,a,r){require(["confirm"],function(s){s(n.translate("sharedcomponents#MessageConfirmRecordingCancellation"),n.translate("sharedcomponents#HeaderConfirmRecordingCancellation")).then(function(){o.show(),e.cancelLiveTvTimer(t.Id).then(function(){require(["toast"],function(e){e(n.translate("sharedcomponents#RecordingCancelled"))}),o.hide(),d(a,r,!0)()})})})}function m(e,n,t){var a=t?"queue":"play",r=0;n&&e.UserData&&e.UserData.PlaybackPositionTicks&&(r=e.UserData.PlaybackPositionTicks),s[a]("Program"==e.Type?{ids:[e.ChannelId],startPositionTicks:r}:{items:[e],startPositionTicks:r})}function u(e,n){return new Promise(function(t,a){"Timer"==n.Type?require(["recordingEditor"],function(r){var s=e.serverInfo().Id;r.show(n.Id,s).then(t,a)}):require(["components/metadataeditor/metadataeditor"],function(e){e.show(n.Id).then(t,a)})})}function p(e,t){return new Promise(function(a,r){var s=n.translate("sharedcomponents#ConfirmDeleteItem"),o=n.translate("sharedcomponents#HeaderDeleteItem");require(["confirm"],function(n){n(s,o).then(function(){e.deleteItem(t).then(function(){a(!0)})},r)})})}function h(e,n){require(["refreshDialog"],function(t){new t({itemIds:[n],serverId:e.serverInfo().Id}).show()})}function f(e){return i(e).then(function(n){return new Promise(function(t,a){require(["actionsheet"],function(r){r.show({items:n,positionTo:e.positionTo}).then(function(n){l(e.item,n,e).then(t)},a)})})})}var y=!0;return e.appInfo().then(function(e){y=-1!=e.appName.toLowerCase().indexOf("theater")}),{getCommands:i,show:f}});