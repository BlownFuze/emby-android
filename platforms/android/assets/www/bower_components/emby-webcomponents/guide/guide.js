define(["require","browser","globalize","connectionManager","loading","scrollHelper","datetime","focusManager","imageLoader","events","layoutManager","itemShortcuts","registrationservices","clearButtonStyle","css!./guide.css","html!./../icons/mediainfo.html","html!./../icons/nav.html","scrollStyles"],function(e,t,r,a,n,o,i,s,c,l,d,u,m){function v(v){function g(e){var t=e.getMinutes()-K;return t>=0?e.setHours(e.getHours(),K,0,0):e.setHours(e.getHours(),0,0,0),e}function f(){n.show()}function h(){n.hide()}function p(e){return m.validateFeature("livetv").then(function(){var r=t.mobile?100:400;return e.querySelector(".guideRequiresUnlock").classList.add("hide"),r},function(){var t=5;return e.querySelector(".guideRequiresUnlock").classList.remove("hide"),e.querySelector(".unlockText").innerHTML=r.translate("LiveTvGuideRequiresUnlock",t),t})}function I(e,t){var r=a.currentApiClient();Q.UserId=r.getCurrentUserId(),p(e).then(function(a){f(),Q.Limit=a,Q.AddCurrentProgram=!1,j=j||r.getLiveTvChannels(Q);var n=t;n=new Date(n.getTime()+1e3);var o=new Date(n.getTime()+J-2e3);j.then(function(t){r.getLiveTvPrograms({UserId:r.getCurrentUserId(),MaxStartDate:o.toISOString(),MinEndDate:n.toISOString(),channelIds:t.Items.map(function(e){return e.Id}).join(","),ImageTypeLimit:1,EnableImageTypes:"Primary,Backdrop",SortBy:"StartDate",EnableTotalRecordCount:!1}).then(function(a){H(e,n,t.Items,a.Items,r),h()})})})}function S(e){if("string"===(typeof e).toString().toLowerCase())try{e=i.parseISO8601Date(e,{toLocal:!0})}catch(t){return e}return i.getDisplayTime(e).toLowerCase()}function T(e,t){var r="";for(e=new Date(e.getTime()),r+='<div class="timeslotHeadersInner">';e.getTime()<t;)r+='<div class="timeslotHeader">',r+=S(e),r+="</div>",e.setTime(e.getTime()+Y);return r+="</div>"}function L(e){if(!e.StartDateLocal)try{e.StartDateLocal=i.parseISO8601Date(e.StartDate,{toLocal:!0})}catch(t){}if(!e.EndDateLocal)try{e.EndDateLocal=i.parseISO8601Date(e.EndDate,{toLocal:!0})}catch(t){}return null}function y(e,t,a,n,o){var i="",s=t.getTime(),c=s+J-1;n=n.filter(function(e){return e.ChannelId==a.Id}),i+='<div class="channelPrograms" data-channelid="'+a.Id+'">';for(var l=0,d=n.length;d>l;l++){var u=n[l];if(u.ChannelId==a.Id&&(L(u),!(u.EndDateLocal.getTime()<s))){if(u.StartDateLocal.getTime()>c)break;B[u.Id]=u;var m=Math.max(u.StartDateLocal.getTime(),s),v=(u.StartDateLocal.getTime()-s)/J;v*=100,v=Math.max(v,0);var g=Math.min(u.EndDateLocal.getTime(),c),f=(g-m)/J;f*=100;var h="programCell clearButton itemAction",p=!0;u.IsKids?h+=" childProgramInfo":u.IsSports?h+=" sportsProgramInfo":u.IsNews?h+=" newsProgramInfo":u.IsMovie?h+=" movieProgramInfo":(h+=" plainProgramInfo",p=!1);var I="";u.TimerId&&(I+=' data-timerid="'+u.TimerId+'"'),u.SeriesTimerId&&(I+=' data-seriestimerid="'+u.SeriesTimerId+'"'),i+='<button data-action="link"'+I+' data-isfolder="'+u.IsFolder+'" data-id="'+u.Id+'" data-serverid="'+u.ServerId+'" data-type="'+u.Type+'" class="'+h+'" style="left:'+v+"%;width:"+f+'%;">';var S="guideProgramName";i+='<div class="'+S+'">',u.IsLive&&o.showLiveIndicator?i+='<span class="liveTvProgram">'+r.translate("sharedcomponents#AttributeLive")+"&nbsp;</span>":u.IsPremiere&&o.showPremiereIndicator?i+='<span class="premiereTvProgram">'+r.translate("sharedcomponents#AttributePremiere")+"&nbsp;</span>":u.IsSeries&&!u.IsRepeat&&o.showNewIndicator&&(i+='<span class="newTvProgram">'+r.translate("sharedcomponents#AttributeNew")+"&nbsp;</span>"),i+=u.Name,i+="</div>",u.IsHD&&o.showHdIcon&&(i+='<iron-icon class="guideHdIcon" icon="mediainfo:hd"></iron-icon>'),u.SeriesTimerId?i+='<iron-icon class="seriesTimerIcon" icon="mediainfo:fiber-smart-record"></iron-icon>':u.TimerId&&(i+='<iron-icon class="timerIcon" icon="mediainfo:fiber-manual-record"></iron-icon>'),p&&(i+='<div class="programAccent"></div>'),i+="</button>"}}return i+="</div>"}function D(e,t,r,a){var n=[],o=window.innerWidth>=800;o=!1;for(var i={showHdIcon:o,showLiveIndicator:o,showPremiereIndicator:o,showNewIndicator:o},s=0,c=r.length;c>s;s++)n.push(y(e,t,r[s],a,i));var l=e.querySelector(".programGrid");l.innerHTML=n.join(""),l.scrollTop=0,l.scrollLeft=0}function w(e,t,r){for(var a="",n=0,o=t.length;o>n;n++){var i=t[n],s=i.ImageTags.Primary,l="";if(s){var d=r.getScaledImageUrl(i.Id,{maxHeight:200,tag:i.ImageTags.Primary,type:"Primary"});l=' data-src="'+d+'"'}var u="channelHeaderCell clearButton itemAction lazy";s&&(u+=" withImage"),a+='<button type="button" class="'+u+'"'+l+' data-action="link" data-isfolder="'+i.IsFolder+'" data-id="'+i.Id+'" data-serverid="'+i.ServerId+'" data-type="'+i.Type+'">',a+='<div class="guideChannelNumber">'+i.Number+"</div>",s||(a+='<div class="guideChannelName">'+i.Name+"</div>"),a+="</button>"}var m=e.querySelector(".channelList");m.innerHTML=a,c.lazyChildren(m)}function b(e,t){for(;!e.classList||!e.classList.contains(t);)if(e=e.parentNode,!e)return null;return e}function H(e,t,r,a,n){var o=document.activeElement,i=o&&o.getAttribute?o.getAttribute("data-id"):null,c=null;o&&(c=b(o,"channelPrograms"),c=c&&c.getAttribute?c.getAttribute("data-channelid"):null),w(e,r,n);var l=t,u=new Date(l.getTime()+J);if(e.querySelector(".timeslotHeaders").innerHTML=T(l,u),B={},D(e,t,r,a),d.tv){var m;if(i&&(m=e.querySelector('[data-id="'+i+'"]')),m)s.focus(m);else{var v;c&&(v=e.querySelector('[data-channelid="'+c+'"]')),v||(v=e.querySelector(".programGrid")),s.autoFocus(v,!0)}}}function P(e,t,r){e.scrollTo?r?e.scrollTo(t,0):e.scrollTo(0,t):r?e.scrollLeft=Math.round(t):e.scrollTop=Math.round(t)}function q(e,t,r){(new Date).getTime()-X>=1e3&&(V=(new Date).getTime(),P(r,t.scrollLeft,!0))}function C(e,t,r){(new Date).getTime()-V>=1e3&&(X=(new Date).getTime(),P(r,t.scrollLeft,!0))}function M(e){var t=[];t[0]=r.translate("sharedcomponents#OptionSundayShort"),t[1]=r.translate("sharedcomponents#OptionMondayShort"),t[2]=r.translate("sharedcomponents#OptionTuesdayShort"),t[3]=r.translate("sharedcomponents#OptionWednesdayShort"),t[4]=r.translate("sharedcomponents#OptionThursdayShort"),t[5]=r.translate("sharedcomponents#OptionFridayShort"),t[6]=r.translate("sharedcomponents#OptionSaturdayShort");var a=t[e.getDay()];return e=i.toLocaleDateString(e),-1==e.toLowerCase().indexOf(a.toLowerCase())?a+" "+e:e}function E(e,t){var r=g(t);R=r,I(e,r);var a=M(t);a='<span class="guideCurrentDay">'+a.replace(" "," </span>"),e.querySelector(".btnSelectDate").innerHTML=a}function O(e,t){var r=new Date;r.setHours(r.getHours(),0,0,0);var a=i.parseISO8601Date(t.StartDate,{toLocal:!0}),n=i.parseISO8601Date(t.EndDate,{toLocal:!0});for(a.setHours(0,0,0,0),n.setHours(0,0,0,0),a.getTime()>=n.getTime()&&n.setDate(a.getDate()+1),a=new Date(Math.max(r,a)),Z=[];n>=a;)Z.push({name:M(a),id:a.getTime()}),a.setDate(a.getDate()+1),a.setHours(0,0,0,0);var o=new Date;R&&o.setTime(R.getTime()),E(e,o)}function A(e){f();var t=a.currentApiClient();t.getLiveTvGuideInfo().then(function(t){O(e,t)})}function k(t){e(["actionsheet"],function(e){e.show({items:Z,title:r.translate("sharedcomponents#HeaderSelectDate"),callback:function(e){var r=new Date;r.setTime(parseInt(e)),E(t,r)}})})}function N(e){if(d.tv){o.centerFocus.on(e.querySelector(".smoothScrollY"),!1);var t=e.querySelector(".programGrid");o.centerFocus.on(t,!0)}}function b(e,t){for(;!e.classList||!e.classList.contains(t);)if(e=e.parentNode,!e)return null;return e}function x(e){var t=b(e.target,"programCell");t&&(W=e.target,z&&clearTimeout(z),z=setTimeout(U,700))}function U(){var e=W;if(e&&document.activeElement==e){var t=e.getAttribute("data-id"),r=B[t];r&&l.trigger(G,"focus",[{item:r}])}}function F(e,t,r,a){var n=a;$||(n=a.capture),e.addEventListener(t,r,n)}var G=this,B={};G.refresh=function(){A(v.element)},G.destroy=function(){u.off(v.element),B={}},G.options=v;var R,j,z,W,K=30,Y=60*K*1e3,J=864e5,Q={StartIndex:0,EnableFavoriteSorting:!0},V=0,X=0,Z=[],$=!1;try{var _=Object.defineProperty({},"capture",{get:function(){$=!0}});window.addEventListener("test",null,_)}catch(et){}e(["text!./tvguide.template.html"],function(e){var t=v.element;t.innerHTML=r.translateDocument(e,"core");var a=t.querySelector(".programGrid"),n=t.querySelector(".timeslotHeaders");a.addEventListener("focus",x,!0),F(a,"scroll",function(){q(t,this,n)},{passive:!0}),F(n,"scroll",function(){C(t,this,a)},{passive:!0}),t.querySelector(".btnSelectDate").addEventListener("click",function(){k(t)}),t.querySelector(".btnUnlockGuide").addEventListener("click",function(){A(t)}),t.classList.add("tvguide"),N(t,G),u.on(t),l.trigger(G,"load"),G.refresh()})}return v});