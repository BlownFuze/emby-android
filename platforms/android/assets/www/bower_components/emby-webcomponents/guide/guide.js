define(["require","browser","globalize","connectionManager","serverNotifications","loading","datetime","focusManager","imageLoader","events","layoutManager","itemShortcuts","registrationservices","dom","clearButtonStyle","css!./guide.css","material-icons","scrollStyles","emby-button"],function(e,t,r,a,n,i,o,s,c,l,d,u,m,v){function g(g){function f(e){var t=e.getMinutes()-Q;return t>=0?e.setHours(e.getHours(),Q,0,0):e.setHours(e.getHours(),0,0,0),e}function h(){i.show()}function I(){i.hide()}function p(){T(),tt=setInterval(S,6e4),S()}function T(){var e=tt;e&&clearInterval(e),tt=null,rt=null,at=null}function S(){rt||(rt=g.element.querySelector(".currentTimeIndicatorBar")),at||(at=g.element.querySelector(".currentTimeIndicatorArrowContainer"));var e=(new Date).getTime()-Y.getTime(),t=e>0?e/$:0;t=Math.min(t,1),0>=t||t>=1?(rt.classList.add("hide"),at.classList.add("hide")):(rt.classList.remove("hide"),at.classList.remove("hide"),rt.style.transform="scaleX("+t+")",at.style.transform="translateX("+100*t+"%)")}function y(e){return m.validateFeature("livetv").then(function(){var r=t.slow?100:400;return e.querySelector(".guideRequiresUnlock").classList.add("hide"),r},function(){var t=5;return e.querySelector(".guideRequiresUnlock").classList.remove("hide"),e.querySelector(".unlockText").innerHTML=r.translate("sharedcomponents#LiveTvGuideRequiresUnlock",t),t})}function L(e,t){var r=a.currentApiClient();et.UserId=r.getCurrentUserId(),y(e).then(function(a){h(),et.Limit=a,et.AddCurrentProgram=!1,J=J||r.getLiveTvChannels(et);var n=t;n=new Date(n.getTime()+1e3);var i=new Date(n.getTime()+Z-2e3);J.then(function(t){r.getLiveTvPrograms({UserId:r.getCurrentUserId(),MaxStartDate:i.toISOString(),MinEndDate:n.toISOString(),channelIds:t.Items.map(function(e){return e.Id}).join(","),ImageTypeLimit:1,EnableImageTypes:"Primary,Backdrop",SortBy:"StartDate",EnableTotalRecordCount:!1}).then(function(a){M(e,n,t.Items,a.Items,r),I()})})})}function D(e){if("string"===(typeof e).toString().toLowerCase())try{e=o.parseISO8601Date(e,{toLocal:!0})}catch(t){return e}return o.getDisplayTime(e).toLowerCase()}function w(e,t){var r="";for(e=new Date(e.getTime()),r+='<div class="timeslotHeadersInner">';e.getTime()<t;)r+='<div class="timeslotHeader">',r+=D(e),r+="</div>",e.setTime(e.getTime()+V);return r+='<div class="currentTimeIndicatorBar hide">',r+="</div>",r+='<div class="currentTimeIndicatorArrowContainer hide">',r+='<i class="currentTimeIndicatorArrow md-icon">arrow_drop_down</i>',r+="</div>"}function b(e){if(!e.StartDateLocal)try{e.StartDateLocal=o.parseISO8601Date(e.StartDate,{toLocal:!0})}catch(t){}if(!e.EndDateLocal)try{e.EndDateLocal=o.parseISO8601Date(e.EndDate,{toLocal:!0})}catch(t){}return null}function C(e,t,a,n,i){var o="",s=t.getTime(),c=s+Z-1;n=n.filter(function(e){return e.ChannelId==a.Id}),o+='<div class="channelPrograms" data-channelid="'+a.Id+'">';for(var l=0,d=n.length;d>l;l++){var u=n[l];if(u.ChannelId==a.Id&&(b(u),!(u.EndDateLocal.getTime()<s))){if(u.StartDateLocal.getTime()>c)break;X[u.Id]=u;var m=Math.max(u.StartDateLocal.getTime(),s),v=(u.StartDateLocal.getTime()-s)/Z;v*=100,v=Math.max(v,0);var g=Math.min(u.EndDateLocal.getTime(),c),f=(g-m)/Z;f*=100;var h="programCell clearButton itemAction",I=!0;u.IsKids?h+=" childProgramInfo":u.IsSports?h+=" sportsProgramInfo":u.IsNews?h+=" newsProgramInfo":u.IsMovie?h+=" movieProgramInfo":(h+=" plainProgramInfo",I=!1);var p="";u.TimerId&&(p+=' data-timerid="'+u.TimerId+'"'),u.SeriesTimerId&&(p+=' data-seriestimerid="'+u.SeriesTimerId+'"'),o+='<button data-action="link"'+p+' data-isfolder="'+u.IsFolder+'" data-id="'+u.Id+'" data-serverid="'+u.ServerId+'" data-type="'+u.Type+'" class="'+h+'" style="left:'+v+"%;width:"+f+'%;">';var T="guideProgramName";o+='<div class="'+T+'">',u.IsLive&&i.showLiveIndicator?o+='<span class="liveTvProgram">'+r.translate("sharedcomponents#AttributeLive")+"&nbsp;</span>":u.IsPremiere&&i.showPremiereIndicator?o+='<span class="premiereTvProgram">'+r.translate("sharedcomponents#AttributePremiere")+"&nbsp;</span>":u.IsSeries&&!u.IsRepeat&&i.showNewIndicator&&(o+='<span class="newTvProgram">'+r.translate("sharedcomponents#AttributeNew")+"&nbsp;</span>"),o+=u.Name,o+="</div>",u.IsHD&&i.showHdIcon&&(o+='<i class="guideHdIcon md-icon programIcon">hd</i>'),u.SeriesTimerId?o+='<i class="seriesTimerIcon md-icon programIcon">fiber_smart_record</i>':u.TimerId&&(o+='<i class="timerIcon md-icon programIcon">fiber_manual_record</i>'),I&&(u.IsKids?o+='<div class="programAccent childAccent"></div>':u.IsSports?o+='<div class="programAccent sportsAccent"></div>':u.IsNews?o+='<div class="programAccent newsAccent"></div>':u.IsMovie&&(o+='<div class="programAccent movieAccent"></div>')),o+="</button>"}}return o+="</div>"}function A(e,t,r,a){var n=[],i=window.innerWidth>=800;i=!1;for(var o={showHdIcon:i,showLiveIndicator:i,showPremiereIndicator:i,showNewIndicator:i},s=0,c=r.length;c>s;s++)n.push(C(e,t,r[s],a,o));var l=e.querySelector(".programGrid");l.innerHTML=n.join(""),l.scrollTop=0,l.scrollLeft=0}function q(e,t,r){for(var a="",n=0,i=t.length;i>n;n++){var o=t[n],s=o.ImageTags.Primary,l="";if(s){var d=r.getScaledImageUrl(o.Id,{maxHeight:200,tag:o.ImageTags.Primary,type:"Primary"});l=' data-src="'+d+'"'}var u="channelHeaderCell clearButton itemAction lazy";a+='<button type="button" class="'+u+'"'+l+' data-action="link" data-isfolder="'+o.IsFolder+'" data-id="'+o.Id+'" data-serverid="'+o.ServerId+'" data-type="'+o.Type+'">',u="guideChannelNumber",s&&(u+=" guideChannelNumberWithImage"),a+='<div class="'+u+'">'+o.Number+"</div>",s||(a+='<div class="guideChannelName">'+o.Name+"</div>"),a+="</button>"}var m=e.querySelector(".channelList");m.innerHTML=a,c.lazyChildren(m)}function H(e,t){for(;!e.classList||!e.classList.contains(t);)if(e=e.parentNode,!e)return null;return e}function M(e,t,r,a,n){var i=document.activeElement,o=i&&i.getAttribute?i.getAttribute("data-id"):null,c=null;i&&(c=H(i,"channelPrograms"),c=c&&c.getAttribute?c.getAttribute("data-channelid"):null),q(e,r,n);var l=t,u=new Date(l.getTime()+Z);if(e.querySelector(".timeslotHeaders").innerHTML=w(l,u),p(),X={},A(e,t,r,a),d.tv){var m;if(o&&(m=e.querySelector('[data-id="'+o+'"]')),m)s.focus(m);else{var v;c&&(v=e.querySelector('[data-channelid="'+c+'"]')),v||(v=e.querySelector(".programGrid")),s.autoFocus(v,!0)}}}function P(e,t,r){e.scrollTo?r?e.scrollTo(t,0):e.scrollTo(0,t):r?e.scrollLeft=Math.round(t):e.scrollTop=Math.round(t)}function E(e,t,r){(new Date).getTime()-st>=1e3&&(ot=(new Date).getTime(),P(r,t.scrollLeft,!0))}function N(e,t,r){(new Date).getTime()-ot>=1e3&&(st=(new Date).getTime(),P(r,t.scrollLeft,!0))}function O(e){var t=[];t[0]=r.translate("sharedcomponents#OptionSundayShort"),t[1]=r.translate("sharedcomponents#OptionMondayShort"),t[2]=r.translate("sharedcomponents#OptionTuesdayShort"),t[3]=r.translate("sharedcomponents#OptionWednesdayShort"),t[4]=r.translate("sharedcomponents#OptionThursdayShort"),t[5]=r.translate("sharedcomponents#OptionFridayShort"),t[6]=r.translate("sharedcomponents#OptionSaturdayShort");var a=t[e.getDay()];return e=o.toLocaleDateString(e),-1==e.toLowerCase().indexOf(a.toLowerCase())?a+" "+e:e}function k(e,t){T();var r=f(t);Y=r,L(e,r);var a=O(t);a='<span class="guideCurrentDay">'+a.replace(" "," </span>"),e.querySelector(".btnSelectDate").innerHTML=a}function x(e,t){var r=new Date;r.setHours(r.getHours(),0,0,0);var a=o.parseISO8601Date(t.StartDate,{toLocal:!0}),n=o.parseISO8601Date(t.EndDate,{toLocal:!0});for(a.setHours(0,0,0,0),n.setHours(0,0,0,0),a.getTime()>=n.getTime()&&n.setDate(a.getDate()+1),a=new Date(Math.max(r,a)),ct=[];n>=a;)ct.push({name:O(a),id:a.getTime()}),a.setDate(a.getDate()+1),a.setHours(0,0,0,0);var i=new Date;Y&&i.setTime(Y.getTime()),k(e,i)}function U(e){h();var t=a.currentApiClient();t.getLiveTvGuideInfo().then(function(t){x(e,t)})}function F(t){e(["actionsheet"],function(e){e.show({items:ct,title:r.translate("sharedcomponents#HeaderSelectDate"),callback:function(e){var r=new Date;r.setTime(parseInt(e)),k(t,r)}})})}function _(t,r){d.tv&&e(["scrollHelper"],function(e){var a=r?"on":"off";e.centerFocus[a](t.querySelector(".smoothScrollY"),!1),e.centerFocus[a](t.querySelector(".programGrid"),!0)})}function H(e,t){for(;!e.classList||!e.classList.contains(t);)if(e=e.parentNode,!e)return null;return e}function B(e){var t=H(e.target,"programCell");t&&(it=e.target,nt&&clearTimeout(nt),nt=setTimeout(G,700))}function G(){var e=it;if(e&&document.activeElement==e){var t=e.getAttribute("data-id"),r=X[t];r&&l.trigger(K,"focus",[{item:r}])}}function R(e,t,r){for(var a=r.ProgramId,n=r.Id,i=g.element.querySelectorAll('.programCell[data-id="'+a+'"]'),o=0,s=i.length;s>o;o++){var c=i[o],l=c.querySelector(".timerIcon");l||c.insertAdjacentHTML("beforeend",'<i class="timerIcon md-icon">fiber_manual_record</i>'),n&&c.setAttribute("data-timerid",n)}}function j(){}function z(e,t,r){for(var a=r.Id,n=g.element.querySelectorAll('.programCell[data-timerid="'+a+'"]'),i=0,o=n.length;o>i;i++){var n=n[i],s=cell.querySelector(".timerIcon");s&&s.parentNode.removeChild(s),cell.removeAttribute("data-timerid")}}function W(e,t,r){for(var a=r.Id,n=g.element.querySelectorAll('.programCell[data-seriestimerid="'+a+'"]'),i=0,o=n.length;o>i;i++){var n=n[i],s=cell.querySelector(".seriesTimerIcon");s&&s.parentNode.removeChild(s),cell.removeAttribute("data-seriestimerid")}}var K=this,X={};K.options=g;var Y,J,Q=30,V=60*Q*1e3,Z=864e5,$=Z,et={StartIndex:0,EnableFavoriteSorting:!0};K.refresh=function(){Y=null,U(g.element)},K.destroy=function(){l.off(n,"TimerCreated",R),l.off(n,"SeriesTimerCreated",j),l.off(n,"TimerCancelled",z),l.off(n,"SeriesTimerCancelled",W),T(),_(g.element,!1),u.off(g.element),X={}};var tt,rt,at,nt,it,ot=0,st=0,ct=[];e(["text!./tvguide.template.html"],function(e){var t=g.element;t.innerHTML=r.translateDocument(e,"sharedcomponents");var a=t.querySelector(".programGrid"),i=t.querySelector(".timeslotHeaders");a.addEventListener("focus",B,!0),v.addEventListener(a,"scroll",function(){E(t,this,i)},{passive:!0}),v.addEventListener(i,"scroll",function(){N(t,this,a)},{passive:!0}),t.querySelector(".btnSelectDate").addEventListener("click",function(){F(t)}),t.querySelector(".btnUnlockGuide").addEventListener("click",function(){U(t)}),t.classList.add("tvguide"),_(t,!0),u.on(t),l.trigger(K,"load"),l.on(n,"TimerCreated",R),l.on(n,"SeriesTimerCreated",j),l.on(n,"TimerCancelled",z),l.on(n,"SeriesTimerCancelled",W),K.refresh()})}return g});