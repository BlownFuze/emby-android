define(["require","browser","globalize","connectionManager","loading","scrollHelper","datetime","focusManager","imageLoader","events","layoutManager","itemShortcuts","registrationservices","clearButtonStyle","css!./guide.css","html!./../icons/mediainfo.html","html!./../icons/nav.html","scrollStyles","emby-button"],function(e,t,r,n,a,i,o,s,c,l,d,u,m){function v(v){function g(e){var t=e.getMinutes()-Z;return t>=0?e.setHours(e.getHours(),Z,0,0):e.setHours(e.getHours(),0,0,0),e}function f(){a.show()}function h(){a.hide()}function p(){I(),K=setInterval(T,6e4),T()}function I(){var e=K;e&&clearInterval(e),K=null,Y=null,J=null}function T(){Y||(Y=v.element.querySelector(".currentTimeIndicatorBar")),J||(J=v.element.querySelector(".currentTimeIndicatorArrowContainer"));var e=(new Date).getTime()-W.getTime(),t=e>0?e/et:0;t=Math.min(t,1),0>=t||t>=1?(Y.classList.add("hide"),J.classList.add("hide")):(Y.classList.remove("hide"),J.classList.remove("hide"),Y.style.transform="scaleX("+t+")",J.style.transform="translateX("+100*t+"%)")}function S(e){return m.validateFeature("livetv").then(function(){var r=t.mobile?100:400;return e.querySelector(".guideRequiresUnlock").classList.add("hide"),r},function(){var t=5;return e.querySelector(".guideRequiresUnlock").classList.remove("hide"),e.querySelector(".unlockText").innerHTML=r.translate("LiveTvGuideRequiresUnlock",t),t})}function y(e,t){var r=n.currentApiClient();tt.UserId=r.getCurrentUserId(),S(e).then(function(n){f(),tt.Limit=n,tt.AddCurrentProgram=!1,X=X||r.getLiveTvChannels(tt);var a=t;a=new Date(a.getTime()+1e3);var i=new Date(a.getTime()+_-2e3);X.then(function(t){r.getLiveTvPrograms({UserId:r.getCurrentUserId(),MaxStartDate:i.toISOString(),MinEndDate:a.toISOString(),channelIds:t.Items.map(function(e){return e.Id}).join(","),ImageTypeLimit:1,EnableImageTypes:"Primary,Backdrop",SortBy:"StartDate",EnableTotalRecordCount:!1}).then(function(n){P(e,a,t.Items,n.Items,r),h()})})})}function L(e){if("string"===(typeof e).toString().toLowerCase())try{e=o.parseISO8601Date(e,{toLocal:!0})}catch(t){return e}return o.getDisplayTime(e).toLowerCase()}function D(e,t){var r="";for(e=new Date(e.getTime()),r+='<div class="timeslotHeadersInner">';e.getTime()<t;)r+='<div class="timeslotHeader">',r+=L(e),r+="</div>",e.setTime(e.getTime()+$);return r+='<div class="currentTimeIndicatorBar hide">',r+="</div>",r+='<div class="currentTimeIndicatorArrowContainer hide">',r+='<iron-icon class="currentTimeIndicatorArrow" icon="nav:arrow-drop-down"></iron-icon>',r+="</div>"}function w(e){if(!e.StartDateLocal)try{e.StartDateLocal=o.parseISO8601Date(e.StartDate,{toLocal:!0})}catch(t){}if(!e.EndDateLocal)try{e.EndDateLocal=o.parseISO8601Date(e.EndDate,{toLocal:!0})}catch(t){}return null}function b(e,t,n,a,i){var o="",s=t.getTime(),c=s+_-1;a=a.filter(function(e){return e.ChannelId==n.Id}),o+='<div class="channelPrograms" data-channelid="'+n.Id+'">';for(var l=0,d=a.length;d>l;l++){var u=a[l];if(u.ChannelId==n.Id&&(w(u),!(u.EndDateLocal.getTime()<s))){if(u.StartDateLocal.getTime()>c)break;z[u.Id]=u;var m=Math.max(u.StartDateLocal.getTime(),s),v=(u.StartDateLocal.getTime()-s)/_;v*=100,v=Math.max(v,0);var g=Math.min(u.EndDateLocal.getTime(),c),f=(g-m)/_;f*=100;var h="programCell clearButton itemAction",p=!0;u.IsKids?h+=" childProgramInfo":u.IsSports?h+=" sportsProgramInfo":u.IsNews?h+=" newsProgramInfo":u.IsMovie?h+=" movieProgramInfo":(h+=" plainProgramInfo",p=!1);var I="";u.TimerId&&(I+=' data-timerid="'+u.TimerId+'"'),u.SeriesTimerId&&(I+=' data-seriestimerid="'+u.SeriesTimerId+'"'),o+='<button data-action="link"'+I+' data-isfolder="'+u.IsFolder+'" data-id="'+u.Id+'" data-serverid="'+u.ServerId+'" data-type="'+u.Type+'" class="'+h+'" style="left:'+v+"%;width:"+f+'%;">';var T="guideProgramName";o+='<div class="'+T+'">',u.IsLive&&i.showLiveIndicator?o+='<span class="liveTvProgram">'+r.translate("sharedcomponents#AttributeLive")+"&nbsp;</span>":u.IsPremiere&&i.showPremiereIndicator?o+='<span class="premiereTvProgram">'+r.translate("sharedcomponents#AttributePremiere")+"&nbsp;</span>":u.IsSeries&&!u.IsRepeat&&i.showNewIndicator&&(o+='<span class="newTvProgram">'+r.translate("sharedcomponents#AttributeNew")+"&nbsp;</span>"),o+=u.Name,o+="</div>",u.IsHD&&i.showHdIcon&&(o+='<iron-icon class="guideHdIcon" icon="mediainfo:hd"></iron-icon>'),u.SeriesTimerId?o+='<iron-icon class="seriesTimerIcon" icon="mediainfo:fiber-smart-record"></iron-icon>':u.TimerId&&(o+='<iron-icon class="timerIcon" icon="mediainfo:fiber-manual-record"></iron-icon>'),p&&(o+='<div class="programAccent"></div>'),o+="</button>"}}return o+="</div>"}function H(e,t,r,n){var a=[],i=window.innerWidth>=800;i=!1;for(var o={showHdIcon:i,showLiveIndicator:i,showPremiereIndicator:i,showNewIndicator:i},s=0,c=r.length;c>s;s++)a.push(b(e,t,r[s],n,o));var l=e.querySelector(".programGrid");l.innerHTML=a.join(""),l.scrollTop=0,l.scrollLeft=0}function q(e,t,r){for(var n="",a=0,i=t.length;i>a;a++){var o=t[a],s=o.ImageTags.Primary,l="";if(s){var d=r.getScaledImageUrl(o.Id,{maxHeight:200,tag:o.ImageTags.Primary,type:"Primary"});l=' data-src="'+d+'"'}var u="channelHeaderCell clearButton itemAction lazy";s&&(u+=" withImage"),n+='<button type="button" class="'+u+'"'+l+' data-action="link" data-isfolder="'+o.IsFolder+'" data-id="'+o.Id+'" data-serverid="'+o.ServerId+'" data-type="'+o.Type+'">',n+='<div class="guideChannelNumber">'+o.Number+"</div>",s||(n+='<div class="guideChannelName">'+o.Name+"</div>"),n+="</button>"}var m=e.querySelector(".channelList");m.innerHTML=n,c.lazyChildren(m)}function C(e,t){for(;!e.classList||!e.classList.contains(t);)if(e=e.parentNode,!e)return null;return e}function P(e,t,r,n,a){var i=document.activeElement,o=i&&i.getAttribute?i.getAttribute("data-id"):null,c=null;i&&(c=C(i,"channelPrograms"),c=c&&c.getAttribute?c.getAttribute("data-channelid"):null),q(e,r,a);var l=t,u=new Date(l.getTime()+_);if(e.querySelector(".timeslotHeaders").innerHTML=D(l,u),p(),z={},H(e,t,r,n),d.tv){var m;if(o&&(m=e.querySelector('[data-id="'+o+'"]')),m)s.focus(m);else{var v;c&&(v=e.querySelector('[data-channelid="'+c+'"]')),v||(v=e.querySelector(".programGrid")),s.autoFocus(v,!0)}}}function M(e,t,r){e.scrollTo?r?e.scrollTo(t,0):e.scrollTo(0,t):r?e.scrollLeft=Math.round(t):e.scrollTop=Math.round(t)}function A(e,t,r){(new Date).getTime()-nt>=1e3&&(rt=(new Date).getTime(),M(r,t.scrollLeft,!0))}function E(e,t,r){(new Date).getTime()-rt>=1e3&&(nt=(new Date).getTime(),M(r,t.scrollLeft,!0))}function O(e){var t=[];t[0]=r.translate("sharedcomponents#OptionSundayShort"),t[1]=r.translate("sharedcomponents#OptionMondayShort"),t[2]=r.translate("sharedcomponents#OptionTuesdayShort"),t[3]=r.translate("sharedcomponents#OptionWednesdayShort"),t[4]=r.translate("sharedcomponents#OptionThursdayShort"),t[5]=r.translate("sharedcomponents#OptionFridayShort"),t[6]=r.translate("sharedcomponents#OptionSaturdayShort");var n=t[e.getDay()];return e=o.toLocaleDateString(e),-1==e.toLowerCase().indexOf(n.toLowerCase())?n+" "+e:e}function k(e,t){I();var r=g(t);W=r,y(e,r);var n=O(t);n='<span class="guideCurrentDay">'+n.replace(" "," </span>"),e.querySelector(".btnSelectDate").innerHTML=n}function N(e,t){var r=new Date;r.setHours(r.getHours(),0,0,0);var n=o.parseISO8601Date(t.StartDate,{toLocal:!0}),a=o.parseISO8601Date(t.EndDate,{toLocal:!0});for(n.setHours(0,0,0,0),a.setHours(0,0,0,0),n.getTime()>=a.getTime()&&a.setDate(n.getDate()+1),n=new Date(Math.max(r,n)),at=[];a>=n;)at.push({name:O(n),id:n.getTime()}),n.setDate(n.getDate()+1),n.setHours(0,0,0,0);var i=new Date;W&&i.setTime(W.getTime()),k(e,i)}function x(e){f();var t=n.currentApiClient();t.getLiveTvGuideInfo().then(function(t){N(e,t)})}function U(t){e(["actionsheet"],function(e){e.show({items:at,title:r.translate("sharedcomponents#HeaderSelectDate"),callback:function(e){var r=new Date;r.setTime(parseInt(e)),k(t,r)}})})}function F(e){if(d.tv){i.centerFocus.on(e.querySelector(".smoothScrollY"),!1);var t=e.querySelector(".programGrid");i.centerFocus.on(t,!0)}}function C(e,t){for(;!e.classList||!e.classList.contains(t);)if(e=e.parentNode,!e)return null;return e}function B(e){var t=C(e.target,"programCell");t&&(V=e.target,Q&&clearTimeout(Q),Q=setTimeout(G,700))}function G(){var e=V;if(e&&document.activeElement==e){var t=e.getAttribute("data-id"),r=z[t];r&&l.trigger(j,"focus",[{item:r}])}}function R(e,t,r,n){var a=n;it||(a=n.capture),e.addEventListener(t,r,a)}var j=this,z={};j.refresh=function(){x(v.element)},j.destroy=function(){I(),u.off(v.element),z={}},j.options=v;var W,X,K,Y,J,Q,V,Z=30,$=60*Z*1e3,_=864e5,et=_,tt={StartIndex:0,EnableFavoriteSorting:!0},rt=0,nt=0,at=[],it=!1;try{var ot=Object.defineProperty({},"capture",{get:function(){it=!0}});window.addEventListener("test",null,ot)}catch(st){}e(["text!./tvguide.template.html"],function(e){var t=v.element;t.innerHTML=r.translateDocument(e,"core");var n=t.querySelector(".programGrid"),a=t.querySelector(".timeslotHeaders");n.addEventListener("focus",B,!0),R(n,"scroll",function(){A(t,this,a)},{passive:!0}),R(a,"scroll",function(){E(t,this,n)},{passive:!0}),t.querySelector(".btnSelectDate").addEventListener("click",function(){U(t)}),t.querySelector(".btnUnlockGuide").addEventListener("click",function(){x(t)}),t.classList.add("tvguide"),F(t,j),u.on(t),l.trigger(j,"load"),j.refresh()})}return v});