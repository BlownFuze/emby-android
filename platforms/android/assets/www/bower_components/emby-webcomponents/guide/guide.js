define(["require","browser","globalize","connectionManager","serverNotifications","loading","scrollHelper","datetime","focusManager","imageLoader","events","layoutManager","itemShortcuts","registrationservices","clearButtonStyle","css!./guide.css","html!./../icons/mediainfo.html","html!./../icons/nav.html","scrollStyles","emby-button"],function(e,t,r,n,a,i,o,s,c,l,d,u,m,v){function f(f){function g(e){var t=e.getMinutes()-Z;return t>=0?e.setHours(e.getHours(),Z,0,0):e.setHours(e.getHours(),0,0,0),e}function h(){i.show()}function I(){i.hide()}function p(){T(),rt=setInterval(S,6e4),S()}function T(){var e=rt;e&&clearInterval(e),rt=null,nt=null,at=null}function S(){nt||(nt=f.element.querySelector(".currentTimeIndicatorBar")),at||(at=f.element.querySelector(".currentTimeIndicatorArrowContainer"));var e=(new Date).getTime()-Q.getTime(),t=e>0?e/et:0;t=Math.min(t,1),0>=t||t>=1?(nt.classList.add("hide"),at.classList.add("hide")):(nt.classList.remove("hide"),at.classList.remove("hide"),nt.style.transform="scaleX("+t+")",at.style.transform="translateX("+100*t+"%)")}function y(e){return v.validateFeature("livetv").then(function(){var r=t.mobile?100:400;return e.querySelector(".guideRequiresUnlock").classList.add("hide"),r},function(){var t=5;return e.querySelector(".guideRequiresUnlock").classList.remove("hide"),e.querySelector(".unlockText").innerHTML=r.translate("sharedcomponents#LiveTvGuideRequiresUnlock",t),t})}function L(e,t){var r=n.currentApiClient();tt.UserId=r.getCurrentUserId(),y(e).then(function(n){h(),tt.Limit=n,tt.AddCurrentProgram=!1,V=V||r.getLiveTvChannels(tt);var a=t;a=new Date(a.getTime()+1e3);var i=new Date(a.getTime()+_-2e3);V.then(function(t){r.getLiveTvPrograms({UserId:r.getCurrentUserId(),MaxStartDate:i.toISOString(),MinEndDate:a.toISOString(),channelIds:t.Items.map(function(e){return e.Id}).join(","),ImageTypeLimit:1,EnableImageTypes:"Primary,Backdrop",SortBy:"StartDate",EnableTotalRecordCount:!1}).then(function(n){P(e,a,t.Items,n.Items,r),I()})})})}function D(e){if("string"===(typeof e).toString().toLowerCase())try{e=s.parseISO8601Date(e,{toLocal:!0})}catch(t){return e}return s.getDisplayTime(e).toLowerCase()}function w(e,t){var r="";for(e=new Date(e.getTime()),r+='<div class="timeslotHeadersInner">';e.getTime()<t;)r+='<div class="timeslotHeader">',r+=D(e),r+="</div>",e.setTime(e.getTime()+$);return r+='<div class="currentTimeIndicatorBar hide">',r+="</div>",r+='<div class="currentTimeIndicatorArrowContainer hide">',r+='<iron-icon class="currentTimeIndicatorArrow" icon="nav:arrow-drop-down"></iron-icon>',r+="</div>"}function b(e){if(!e.StartDateLocal)try{e.StartDateLocal=s.parseISO8601Date(e.StartDate,{toLocal:!0})}catch(t){}if(!e.EndDateLocal)try{e.EndDateLocal=s.parseISO8601Date(e.EndDate,{toLocal:!0})}catch(t){}return null}function C(e,t,n,a,i){var o="",s=t.getTime(),c=s+_-1;a=a.filter(function(e){return e.ChannelId==n.Id}),o+='<div class="channelPrograms" data-channelid="'+n.Id+'">';for(var l=0,d=a.length;d>l;l++){var u=a[l];if(u.ChannelId==n.Id&&(b(u),!(u.EndDateLocal.getTime()<s))){if(u.StartDateLocal.getTime()>c)break;J[u.Id]=u;var m=Math.max(u.StartDateLocal.getTime(),s),v=(u.StartDateLocal.getTime()-s)/_;v*=100,v=Math.max(v,0);var f=Math.min(u.EndDateLocal.getTime(),c),g=(f-m)/_;g*=100;var h="programCell clearButton itemAction",I=!0;u.IsKids?h+=" childProgramInfo":u.IsSports?h+=" sportsProgramInfo":u.IsNews?h+=" newsProgramInfo":u.IsMovie?h+=" movieProgramInfo":(h+=" plainProgramInfo",I=!1);var p="";u.TimerId&&(p+=' data-timerid="'+u.TimerId+'"'),u.SeriesTimerId&&(p+=' data-seriestimerid="'+u.SeriesTimerId+'"'),o+='<button data-action="link"'+p+' data-isfolder="'+u.IsFolder+'" data-id="'+u.Id+'" data-serverid="'+u.ServerId+'" data-type="'+u.Type+'" class="'+h+'" style="left:'+v+"%;width:"+g+'%;">';var T="guideProgramName";o+='<div class="'+T+'">',u.IsLive&&i.showLiveIndicator?o+='<span class="liveTvProgram">'+r.translate("sharedcomponents#AttributeLive")+"&nbsp;</span>":u.IsPremiere&&i.showPremiereIndicator?o+='<span class="premiereTvProgram">'+r.translate("sharedcomponents#AttributePremiere")+"&nbsp;</span>":u.IsSeries&&!u.IsRepeat&&i.showNewIndicator&&(o+='<span class="newTvProgram">'+r.translate("sharedcomponents#AttributeNew")+"&nbsp;</span>"),o+=u.Name,o+="</div>",u.IsHD&&i.showHdIcon&&(o+='<iron-icon class="guideHdIcon" icon="mediainfo:hd"></iron-icon>'),u.SeriesTimerId?o+='<iron-icon class="seriesTimerIcon" icon="mediainfo:fiber-smart-record"></iron-icon>':u.TimerId&&(o+='<iron-icon class="timerIcon" icon="mediainfo:fiber-manual-record"></iron-icon>'),I&&(o+='<div class="programAccent"></div>'),o+="</button>"}}return o+="</div>"}function q(e,t,r,n){var a=[],i=window.innerWidth>=800;i=!1;for(var o={showHdIcon:i,showLiveIndicator:i,showPremiereIndicator:i,showNewIndicator:i},s=0,c=r.length;c>s;s++)a.push(C(e,t,r[s],n,o));var l=e.querySelector(".programGrid");l.innerHTML=a.join(""),l.scrollTop=0,l.scrollLeft=0}function H(e,t,r){for(var n="",a=0,i=t.length;i>a;a++){var o=t[a],s=o.ImageTags.Primary,c="";if(s){var d=r.getScaledImageUrl(o.Id,{maxHeight:200,tag:o.ImageTags.Primary,type:"Primary"});c=' data-src="'+d+'"'}var u="channelHeaderCell clearButton itemAction lazy";s&&(u+=" withImage"),n+='<button type="button" class="'+u+'"'+c+' data-action="link" data-isfolder="'+o.IsFolder+'" data-id="'+o.Id+'" data-serverid="'+o.ServerId+'" data-type="'+o.Type+'">',n+='<div class="guideChannelNumber">'+o.Number+"</div>",s||(n+='<div class="guideChannelName">'+o.Name+"</div>"),n+="</button>"}var m=e.querySelector(".channelList");m.innerHTML=n,l.lazyChildren(m)}function A(e,t){for(;!e.classList||!e.classList.contains(t);)if(e=e.parentNode,!e)return null;return e}function P(e,t,r,n,a){var i=document.activeElement,o=i&&i.getAttribute?i.getAttribute("data-id"):null,s=null;i&&(s=A(i,"channelPrograms"),s=s&&s.getAttribute?s.getAttribute("data-channelid"):null),H(e,r,a);var l=t,d=new Date(l.getTime()+_);if(e.querySelector(".timeslotHeaders").innerHTML=w(l,d),p(),J={},q(e,t,r,n),u.tv){var m;if(o&&(m=e.querySelector('[data-id="'+o+'"]')),m)c.focus(m);else{var v;s&&(v=e.querySelector('[data-channelid="'+s+'"]')),v||(v=e.querySelector(".programGrid")),c.autoFocus(v,!0)}}}function M(e,t,r){e.scrollTo?r?e.scrollTo(t,0):e.scrollTo(0,t):r?e.scrollLeft=Math.round(t):e.scrollTop=Math.round(t)}function E(e,t,r){(new Date).getTime()-ct>=1e3&&(st=(new Date).getTime(),M(r,t.scrollLeft,!0))}function O(e,t,r){(new Date).getTime()-st>=1e3&&(ct=(new Date).getTime(),M(r,t.scrollLeft,!0))}function N(e){var t=[];t[0]=r.translate("sharedcomponents#OptionSundayShort"),t[1]=r.translate("sharedcomponents#OptionMondayShort"),t[2]=r.translate("sharedcomponents#OptionTuesdayShort"),t[3]=r.translate("sharedcomponents#OptionWednesdayShort"),t[4]=r.translate("sharedcomponents#OptionThursdayShort"),t[5]=r.translate("sharedcomponents#OptionFridayShort"),t[6]=r.translate("sharedcomponents#OptionSaturdayShort");var n=t[e.getDay()];return e=s.toLocaleDateString(e),-1==e.toLowerCase().indexOf(n.toLowerCase())?n+" "+e:e}function k(e,t){T();var r=g(t);Q=r,L(e,r);var n=N(t);n='<span class="guideCurrentDay">'+n.replace(" "," </span>"),e.querySelector(".btnSelectDate").innerHTML=n}function x(e,t){var r=new Date;r.setHours(r.getHours(),0,0,0);var n=s.parseISO8601Date(t.StartDate,{toLocal:!0}),a=s.parseISO8601Date(t.EndDate,{toLocal:!0});for(n.setHours(0,0,0,0),a.setHours(0,0,0,0),n.getTime()>=a.getTime()&&a.setDate(n.getDate()+1),n=new Date(Math.max(r,n)),lt=[];a>=n;)lt.push({name:N(n),id:n.getTime()}),n.setDate(n.getDate()+1),n.setHours(0,0,0,0);var i=new Date;Q&&i.setTime(Q.getTime()),k(e,i)}function U(e){h();var t=n.currentApiClient();t.getLiveTvGuideInfo().then(function(t){x(e,t)})}function F(t){e(["actionsheet"],function(e){e.show({items:lt,title:r.translate("sharedcomponents#HeaderSelectDate"),callback:function(e){var r=new Date;r.setTime(parseInt(e)),k(t,r)}})})}function B(e){if(u.tv){o.centerFocus.on(e.querySelector(".smoothScrollY"),!1);var t=e.querySelector(".programGrid");o.centerFocus.on(t,!0)}}function A(e,t){for(;!e.classList||!e.classList.contains(t);)if(e=e.parentNode,!e)return null;return e}function G(e){var t=A(e.target,"programCell");t&&(ot=e.target,it&&clearTimeout(it),it=setTimeout(R,700))}function R(){var e=ot;if(e&&document.activeElement==e){var t=e.getAttribute("data-id"),r=J[t];r&&d.trigger(Y,"focus",[{item:r}])}}function j(e,t,r,n){var a=n;dt||(a=n.capture),e.addEventListener(t,r,a)}function z(e,t,r){for(var n=r.ProgramId,a=r.Id,i=f.element.querySelectorAll('.programCell[data-id="'+n+'"]'),o=0,s=i.length;s>o;o++){var c=i[o],l=c.querySelector(".timerIcon");l||c.insertAdjacentHTML("beforeend",'<iron-icon class="timerIcon" icon="mediainfo:fiber-manual-record"></iron-icon>'),a&&c.setAttribute("data-timerid",a)}}function W(){}function X(e,t,r){for(var n=r.Id,a=f.element.querySelectorAll('.programCell[data-timerid="'+n+'"]'),i=0,o=a.length;o>i;i++){var a=a[i],s=cell.querySelector(".timerIcon");s&&s.parentNode.removeChild(s),cell.removeAttribute("data-timerid")}}function K(e,t,r){for(var n=r.Id,a=f.element.querySelectorAll('.programCell[data-seriestimerid="'+n+'"]'),i=0,o=a.length;o>i;i++){var a=a[i],s=cell.querySelector(".seriesTimerIcon");s&&s.parentNode.removeChild(s),cell.removeAttribute("data-seriestimerid")}}var Y=this,J={};Y.options=f;var Q,V,Z=30,$=60*Z*1e3,_=864e5,et=_,tt={StartIndex:0,EnableFavoriteSorting:!0};Y.refresh=function(){Q=null,U(f.element)},Y.destroy=function(){d.off(a,"TimerCreated",z),d.off(a,"SeriesTimerCreated",W),d.off(a,"TimerCancelled",X),d.off(a,"SeriesTimerCancelled",K),T(),m.off(f.element),J={}};var rt,nt,at,it,ot,st=0,ct=0,lt=[],dt=!1;try{var ut=Object.defineProperty({},"capture",{get:function(){dt=!0}});window.addEventListener("test",null,ut)}catch(mt){}e(["text!./tvguide.template.html"],function(e){var t=f.element;t.innerHTML=r.translateDocument(e,"sharedcomponents");var n=t.querySelector(".programGrid"),i=t.querySelector(".timeslotHeaders");n.addEventListener("focus",G,!0),j(n,"scroll",function(){E(t,this,i)},{passive:!0}),j(i,"scroll",function(){O(t,this,n)},{passive:!0}),t.querySelector(".btnSelectDate").addEventListener("click",function(){F(t)}),t.querySelector(".btnUnlockGuide").addEventListener("click",function(){U(t)}),t.classList.add("tvguide"),B(t,Y),m.on(t),d.trigger(Y,"load"),d.on(a,"TimerCreated",z),d.on(a,"SeriesTimerCreated",W),d.on(a,"TimerCancelled",X),d.on(a,"SeriesTimerCancelled",K),Y.refresh()})}return f});