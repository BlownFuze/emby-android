define(["cryptojs-md5"],function(){function e(e,t){return"IMG"!==e.tagName?new Promise(function(n){var i=new Image;i.onload=function(){e.style.backgroundImage="url('"+t+"')",n(e)},i.src=t}):(e.setAttribute("src",t),Promise.resolve(e))}function t(e,n,i,o){("."==n[0]||""==n[0])&&(n=n.slice(1)),e.getDirectory(n[0],{create:!0},function(e){n.length>1?t(e,n.slice(1),i,o):i(e)},o)}function n(e){return Array.prototype.slice.call(e||[],0)}function i(){var e=s.createReader(),t=[],i=function(){},r=function(){e.readEntries(function(e){e.length?(t=t.concat(n(e)),r()):t.forEach(o)},i)};r()}function o(e){e.isFile&&e.file(function(t){r(t,e).then(function(t){var n=(new Date).getTime()-t,i=3456e6;if(n>=i){{e.fullPath}e.remove(function(){},function(){})}})})}function r(e,t){var n=e.lastModified||e.lastModifiedDate||e.modificationTime;return n?(n.getTime&&(n=n.getTime()),Promise.resolve(n)):new Promise(function(e){t.getMetadata(function(t){var n=t.lastModified||t.lastModifiedDate||t.modificationTime;n&&n.getTime&&(n=n.getTime()),e(n)})})}function u(e){var t=e.indexOf("://");return-1!=t&&(e=e.substring(t+3),t=e.indexOf("/"),-1!=t&&(e=e.substring(t+1))),CryptoJS.MD5(e).toString()}function c(e,t,n,i,o){var r=new XMLHttpRequest;r.open("GET",e,!0),r.responseType="arraybuffer",r.onload=function(){200==this.status?a(t,n,this.getResponseHeader("Content-Type"),this.response,i,o):o()},r.send()}function a(e,t,n,i,o,r){e.getFile(t,{create:!0},function(e){e.createWriter(function(t){t.onwriteend=function(){o(e)},t.onerror=r;var u=new Blob([i],{type:n});t.write(u)},r)},r)}function f(e){return new Promise(function(t,n){-1!=e.indexOf("tag=")&&(e+="&accept=webp");var i=u(e),o=function(e){t(e.toURL())},r=function(e){n()};if(!g||!s)return void r("");var a="/"+l+"/"+i;g.root.getFile(a,{create:!1},o,function(){c(e,s,i,o,r)})})}var s,d=1572864e3,l="images";navigator.webkitPersistentStorage.requestQuota(d,function(e){var n=window.webkitRequestFileSystem||window.requestFileSystem;n(PERSISTENT,e,function(e){g=e,t(g.root,l.split("/"),function(e){s=e,setTimeout(i,6e4)})})});var g;return{loadImage:function(t,n){return f(n).then(function(n){return e(t,n)},function(){return e(t,n)})}}});