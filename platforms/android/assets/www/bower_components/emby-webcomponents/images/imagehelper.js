define(["visibleinviewport","imageFetcher"],function(e,t){function n(t,n){return e(t,!0,v,d,n)}function r(e){var n=e.getAttribute("data-src");n&&(g.enableFade?t.loadImage(e,n).then(a):t.loadImage(e,n),e.setAttribute("data-src",""))}function a(e){if(!e.classList.contains("noFade")){var t=[{opacity:"0",offset:0},{opacity:"1",offset:1}],n={duration:300,iterations:1};e.animate(t,n)}}function i(e){for(var t=0,n=e.length;n>t;t++)e[t]=!0}function o(e,t,n,r){var a=r;m||(a=r.capture),e.addEventListener(t,n,a)}function s(e){function t(t){for(var i=[],o=!1,u=!1,c={innerHeight:window.innerHeight,innerWidth:window.innerWidth},l=0,f=e.length;f>l;l++){if(s[t])return;var v=e[l];!u&&n(v,c)?(o=!0,r(v)):(o&&(u=!0),i.push(v))}e=i,e.length||(document.removeEventListener("focus",a,!0),document.removeEventListener("scroll",a,!0),document.removeEventListener(h,a,!0),window.removeEventListener("resize",a,!0))}function a(){i(s);var e=s.length;s.length++,setTimeout(function(){t(e)},1)}if(e.length){var s=[];o(document,"scroll",a,{capture:!0,passive:!0}),document.addEventListener("focus",a,!0),o(document,h,a,{capture:!0,passive:!0}),o(window,"resize",a,{capture:!0,passive:!0}),a()}}function u(e){for(var t=0,n=e.length;n>t;t++){var r=e[0],a=r.getAttribute("data-src");a&&(ImageStore.setImageInto(r,a),r.setAttribute("data-src",""))}}function c(e){s(e.getElementsByClassName("lazy"))}function l(e,t){e.setAttribute("data-src",t),u([e])}function f(e){for(var t=[],n=0,r=e.length;r>n;n++){var a=e[n].PrimaryImageAspectRatio||0;a&&(t[t.length]=a)}if(!t.length)return null;t.sort(function(e,t){return e-t});var i,o=Math.floor(t.length/2);i=t.length%2?t[o]:(t[o-1]+t[o])/2;var s=2/3;if(Math.abs(s-i)<=.15)return s;var u=16/9;if(Math.abs(u-i)<=.2)return u;if(Math.abs(1-i)<=.15)return 1;var c=4/3;return Math.abs(c-i)<=.15?c:i}function u(e){for(var t=0,n=e.length;n>t;t++){var a=e[0];r(a)}}function l(e,t){e.setAttribute("data-src",t),r(e)}var v=screen.availWidth,d=screen.availHeight,h=document.implementation.hasFeature("Event.wheel","3.0")?"wheel":"mousewheel",g={},m=!1;try{var p=Object.defineProperty({},"capture",{get:function(){m=!0}});window.addEventListener("test",null,p)}catch(w){}return g.fillImages=u,g.lazyImage=l,g.lazyChildren=c,g.getPrimaryImageAspectRatio=f,g});