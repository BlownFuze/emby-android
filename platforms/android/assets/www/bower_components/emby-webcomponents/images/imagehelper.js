define(["visibleinviewport","imageFetcher","layoutManager","events"],function(e,t,n,r){function a(){var e=screen.availWidth,t=screen.availHeight;n.mobile&&(e*=2,t*=2),g=e,m=t,i()}function i(){w={innerHeight:window.innerHeight,innerWidth:window.innerWidth}}function o(t){return e(t,!0,g,m,w)}function u(e,n,r){n||(n=e.getAttribute("data-src")),n&&(y.enableFade&&r!==!1?t.loadImage(e,n).then(s):t.loadImage(e,n),e.setAttribute("data-src",""))}function s(e){var t=[{opacity:"0",offset:0},{opacity:"1",offset:1}],n={duration:300,iterations:1};e.animate(t,n)}function c(e){for(var t=0,n=e.length;n>t;t++)e[t]=!0}function v(e,t,n,r){var a=r;E||(a=r.capture),e.addEventListener(t,n,a)}function l(e){function t(t){for(var a=[],i=!1,s=!1,c=0,v=e.length;v>c;c++){if(r[t])return;var l=e[c];if(!s&&o(l)?(i=!0,u(l)):(i&&(s=!0),a.push(l)),s)return}e=a,e.length||(document.removeEventListener("focus",n,!0),document.removeEventListener("scroll",n,!0),document.removeEventListener(p,n,!0),window.removeEventListener("resize",n,!0))}function n(){c(r);var e=r.length;r.length++,setTimeout(function(){t(e)},1)}if(e.length){var r=[];v(document,"scroll",n,{capture:!0,passive:!0}),document.addEventListener("focus",n,!0),v(document,p,n,{capture:!0,passive:!0}),v(window,"resize",n,{capture:!0,passive:!0}),n()}}function f(e){l(e.getElementsByClassName("lazy"))}function d(e){for(var t=[],n=0,r=e.length;r>n;n++){var a=e[n].PrimaryImageAspectRatio||0;a&&(t[t.length]=a)}if(!t.length)return null;t.sort(function(e,t){return e-t});var i,o=Math.floor(t.length/2);i=t.length%2?t[o]:(t[o-1]+t[o])/2;var u=2/3;if(Math.abs(u-i)<=.15)return u;var s=16/9;if(Math.abs(s-i)<=.2)return s;if(Math.abs(1-i)<=.15)return 1;var c=4/3;return Math.abs(c-i)<=.15?c:i}function h(e){for(var t=0,n=e.length;n>t;t++){var r=e[0];u(r)}}var g,m,w;window.addEventListener("orientationchange",a),window.addEventListener("resize",a),r.on(n,"modechange",a);var p=document.implementation.hasFeature("Event.wheel","3.0")?"wheel":"mousewheel";a();var y={},E=!1;try{var b=Object.defineProperty({},"capture",{get:function(){E=!0}});window.addEventListener("test",null,b)}catch(L){}return y.fillImages=h,y.lazyImage=u,y.lazyChildren=f,y.getPrimaryImageAspectRatio=d,y});