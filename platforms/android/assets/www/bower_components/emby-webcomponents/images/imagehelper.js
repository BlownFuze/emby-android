define(["visibleinviewport","imageFetcher","layoutManager","events"],function(e,t,n,r){function a(){var e=screen.availWidth,t=screen.availHeight;n.mobile&&(e*=2,t*=2),g=e,m=t}function i(t,n){return e(t,!0,g,m,n)}function o(e){var n=e.getAttribute("data-src");n&&(w.enableFade?t.loadImage(e,n).then(s):t.loadImage(e,n),e.setAttribute("data-src",""))}function s(e){if(!e.classList.contains("noFade")){var t=[{opacity:"0",offset:0},{opacity:"1",offset:1}],n={duration:300,iterations:1};e.animate(t,n)}}function u(e){for(var t=0,n=e.length;n>t;t++)e[t]=!0}function c(e,t,n,r){var a=r;b||(a=r.capture),e.addEventListener(t,n,a)}function l(e){function t(t){for(var a=[],s=!1,u=!1,c={innerHeight:window.innerHeight,innerWidth:window.innerWidth},l=0,v=e.length;v>l;l++){if(r[t])return;var f=e[l];!u&&i(f,c)?(s=!0,o(f)):(s&&(u=!0),a.push(f))}e=a,e.length||(document.removeEventListener("focus",n,!0),document.removeEventListener("scroll",n,!0),document.removeEventListener(p,n,!0),window.removeEventListener("resize",n,!0))}function n(){u(r);var e=r.length;r.length++,setTimeout(function(){t(e)},1)}if(e.length){var r=[];c(document,"scroll",n,{capture:!0,passive:!0}),document.addEventListener("focus",n,!0),c(document,p,n,{capture:!0,passive:!0}),c(window,"resize",n,{capture:!0,passive:!0}),n()}}function v(e){for(var t=0,n=e.length;n>t;t++){var r=e[0],a=r.getAttribute("data-src");a&&(ImageStore.setImageInto(r,a),r.setAttribute("data-src",""))}}function f(e){l(e.getElementsByClassName("lazy"))}function d(e,t){e.setAttribute("data-src",t),v([e])}function h(e){for(var t=[],n=0,r=e.length;r>n;n++){var a=e[n].PrimaryImageAspectRatio||0;a&&(t[t.length]=a)}if(!t.length)return null;t.sort(function(e,t){return e-t});var i,o=Math.floor(t.length/2);i=t.length%2?t[o]:(t[o-1]+t[o])/2;var s=2/3;if(Math.abs(s-i)<=.15)return s;var u=16/9;if(Math.abs(u-i)<=.2)return u;if(Math.abs(1-i)<=.15)return 1;var c=4/3;return Math.abs(c-i)<=.15?c:i}function v(e){for(var t=0,n=e.length;n>t;t++){var r=e[0];o(r)}}function d(e,t){e.setAttribute("data-src",t),o(e)}var g,m;a(),window.addEventListener("orientationchange",a),r.on(n,"modechange",a);var p=document.implementation.hasFeature("Event.wheel","3.0")?"wheel":"mousewheel",w={},b=!1;try{var y=Object.defineProperty({},"capture",{get:function(){b=!0}});window.addEventListener("test",null,y)}catch(E){}return w.fillImages=v,w.lazyImage=d,w.lazyChildren=f,w.getPrimaryImageAspectRatio=h,w});