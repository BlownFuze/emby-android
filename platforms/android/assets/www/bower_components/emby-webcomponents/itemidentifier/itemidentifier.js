define(["dialogHelper","loading","cardBuilder","connectionManager","require","globalize","scrollHelper","layoutManager","focusManager","emby-input","emby-checkbox","paper-icon-button-light","css!./../formdialog","material-icons","cardStyle"],function(e,t,r,a,n,o,i,l,d){function c(){return a.getApiClient(b)}function s(e){var r,a,i={ProviderIds:{}},l=e.querySelectorAll(".identifyField");for(r=0,a=l.length;a>r;r++){var d=l[r].value;d&&("number"==l[r].type&&(d=parseInt(d)),i[l[r].getAttribute("data-lookup")]=d)}var s=!1,m=e.querySelectorAll(".txtLookupId");for(r=0,a=m.length;a>r;r++){var d=m[r].value;d&&(s=!0),i.ProviderIds[m[r].getAttribute("data-providerkey")]=d}if(!s&&!i.Name)return void n(["toast"],function(e){e(o.translate("sharedcomponents#PleaseEnterNameOrId"))});q&&q.GameSystem&&(i.GameSystem=q.GameSystem),i={SearchInfo:i,IncludeDisabledProviders:!0},t.show();var v=c();v.ajax({type:"POST",url:v.getUrl("Items/RemoteSearch/"+x),data:JSON.stringify(i),contentType:"application/json",dataType:"json"}).then(function(r){t.hide(),u(e,r)})}function u(e,t){function r(){var r=parseInt(this.getAttribute("data-index")),a=t[r];null!=q?v(e,a):m(e,a)}var a=e.querySelector(".identificationSearchResults");e.querySelector(".popupIdentifyForm").classList.add("hide"),a.classList.remove("hide"),e.querySelector(".identifyOptionsForm").classList.add("hide"),e.querySelector(".dialogContentInner").classList.remove("dialog-content-centered");var n,o,i="";for(n=0,o=t.length;o>n;n++){var c=t[n];i+=p(c,n)}var s=e.querySelector(".identificationSearchResultList");s.innerHTML=i;var u=s.querySelectorAll(".card");for(n=0,o=u.length;o>n;n++)u[n].addEventListener("click",r);l.tv&&d.autoFocus(a)}function m(r,a){T=a,D=!0,t.hide(),e.close(r)}function v(e,t){var r=e.querySelector(".identifyOptionsForm");e.querySelector(".popupIdentifyForm").classList.add("hide"),e.querySelector(".identificationSearchResults").classList.add("hide"),r.classList.remove("hide"),e.querySelector("#chkIdentifyReplaceImages").checked=!0,e.querySelector(".dialogContentInner").classList.add("dialog-content-centered"),T=t;var a=[];a.push(t.Name),t.ProductionYear&&a.push(t.ProductionYear),t.GameSystem&&a.push(t.GameSystem);var n=a.join("<br/>");if(t.ImageUrl){var o=y(t.ImageUrl,t.SearchProviderName);n='<div style="display:flex;align-items:center;"><img src="'+o+'" style="max-height:240px;" /><div style="margin-left:1em;">'+n+"</div>"}e.querySelector(".selectedSearchResult").innerHTML=n,d.focus(r.querySelector(".btnSubmit"))}function p(e,t){var a="",n="card scalableCard";if(n+="Episode"==x?" backdropCard":"MusicAlbum"==x||"MusicArtist"==x?" squareCard":" portraitCard",a+='<button type="button" class="'+n+'" data-index="'+t+'">',a+='<div class="cardBox visualCardBox">',a+='<div class="cardScalable">',a+='<div class="cardPadder"></div>',a+='<div class="cardContent searchImage">',e.ImageUrl){var o=y(e.ImageUrl,e.SearchProviderName);a+='<div class="cardImageContainer coveredImage" style="background-image:url(\''+o+"');\"></div>"}else a+='<div class="cardImageContainer coveredImage '+r.getDefaultColorClass(e.Name)+'"><div class="cardText cardCenteredText">'+e.Name+"</div></div>";return a+="</div>",a+="</div>",a+='<div class="cardFooter">',a+='<div class="cardText cardTextCentered">'+e.Name+"</div>",a+='<div class="cardText cardTextCentered">',a+=e.ProductionYear||"&nbsp;",a+="</div>",e.GameSystem&&(a+='<div class="cardText cardTextCentered">',a+=e.GameSystem,a+="</div>"),a+="</div>",a+="</div>",a+="</button>"}function y(e,t){var r=c();return r.getUrl("Items/RemoteSearch/Image",{imageUrl:e,ProviderName:t})}function f(r){t.show();var a={ReplaceAllImages:r.querySelector("#chkIdentifyReplaceImages").checked},n=c();n.ajax({type:"POST",url:n.getUrl("Items/RemoteSearch/Apply/"+q.Id,a),data:JSON.stringify(T),contentType:"application/json"}).then(function(){D=!0,t.hide(),e.close(r)},function(){t.hide(),e.close(r)})}function g(e,t){var r=c();r.getJSON(r.getUrl("Items/"+t.Id+"/ExternalIdInfos")).then(function(r){for(var a="",n=t.ProviderIds||{},i=0,l=r.length;l>i;i++){var d=r[i],c="txtLookup"+d.Key;a+='<div class="inputContainer">';{var s=o.translate("sharedcomponents#LabelDynamicExternalId").replace("{0}",d.Name);n[d.Key]||""}a+='<input is="emby-input" class="txtLookupId" data-providerkey="'+d.Key+'" id="'+c+'" label="'+s+'"/>',a+="</div>"}e.querySelector("#txtLookupName").value="","Person"==t.Type||"BoxSet"==t.Type?(e.querySelector(".fldLookupYear").classList.add("hide"),e.querySelector("#txtLookupYear").value=""):(e.querySelector(".fldLookupYear").classList.remove("hide"),e.querySelector("#txtLookupYear").value=""),e.querySelector(".identifyProviderIds").innerHTML=a,e.querySelector(".formDialogHeaderTitle").innerHTML=o.translate("sharedcomponents#Identify")})}function h(r){t.show(),n(["text!./itemidentifier.template.html"],function(a){var n=c();n.getItem(n.getCurrentUserId(),r).then(function(r){q=r,x=q.Type;var n={size:"medium",removeOnClose:!0,scrollY:!1};l.tv&&(n.size="fullscreen");var d=e.createDialog(n);d.classList.add("formDialog"),d.classList.add("recordingDialog");var c="";c+=o.translateDocument(a,"sharedcomponents"),d.innerHTML=c,document.body.appendChild(d),d.addEventListener("close",S),l.tv&&i.centerFocus.on(d.querySelector(".formDialogContent"),!1),e.open(d),d.querySelector(".popupIdentifyForm").addEventListener("submit",function(e){return e.preventDefault(),s(d),!1}),d.querySelector(".identifyOptionsForm").addEventListener("submit",function(e){return e.preventDefault(),f(d),!1}),d.querySelector(".btnCancel").addEventListener("click",function(){e.close(d)}),d.classList.add("identifyDialog"),g(d,r),t.hide()})})}function S(){t.hide(),D?C():k()}function L(r,a,d,c){q=null,x=d,n(["text!./itemidentifier.template.html"],function(n){var u={size:"medium",removeOnClose:!0,scrollY:!1};l.tv&&(u.size="fullscreen");var m=e.createDialog(u);m.classList.add("formDialog"),m.classList.add("recordingDialog");var v="";v+=o.translateDocument(n,"sharedcomponents"),m.innerHTML=v,document.body.appendChild(m),l.tv&&i.centerFocus.on(m.querySelector(".formDialogContent"),!1),e.open(m),m.querySelector(".btnCancel").addEventListener("click",function(){e.close(m)}),m.querySelector(".popupIdentifyForm").addEventListener("submit",function(e){return e.preventDefault(),s(m),!1}),m.addEventListener("close",function(){t.hide();var e=D?T:null;c(e)}),m.classList.add("identifyDialog"),I(m,r,a,d)})}function I(e,t,r,a){e.querySelector("#txtLookupName").value=t,"Person"==a||"BoxSet"==a?(e.querySelector(".fldLookupYear").classList.add("hide"),e.querySelector("#txtLookupYear").value=""):(e.querySelector(".fldLookupYear").classList.remove("hide"),e.querySelector("#txtLookupYear").value=r),e.querySelector(".formDialogHeaderTitle").innerHTML=o.translate("sharedcomponents#Search")}var q,x,b,C,k,T,D=!1;return{show:function(e,t){return new Promise(function(r,a){C=r,k=a,b=t,D=!1,h(e)})},showFindNew:function(e,t,r,a){return new Promise(function(n){b=a,D=!1,L(e,t,r,n)})}}});