define(["dialogHelper","loading","cardBuilder","connectionManager","require","globalize","scrollHelper","layoutManager","focusManager","emby-input","emby-checkbox","paper-icon-button-light","css!./../formdialog","material-icons","cardStyle"],function(e,t,r,a,n,o,i,d,c){function l(){return a.getApiClient(b)}function s(e){var r,a,i={ProviderIds:{}},d=e.querySelectorAll(".identifyField");for(r=0,a=d.length;a>r;r++){var c=d[r].value;c&&("number"==d[r].type&&(c=parseInt(c)),i[d[r].getAttribute("data-lookup")]=c)}var s=!1,m=e.querySelectorAll(".txtLookupId");for(r=0,a=m.length;a>r;r++){var c=m[r].value;c&&(s=!0),i.ProviderIds[m[r].getAttribute("data-providerkey")]=c}if(!s&&!i.Name)return void n(["toast"],function(e){e(o.translate("sharedcomponents#PleaseEnterNameOrId"))});q&&q.GameSystem&&(i.GameSystem=q.GameSystem),i={SearchInfo:i,IncludeDisabledProviders:!0},t.show();var v=l();v.ajax({type:"POST",url:v.getUrl("Items/RemoteSearch/"+x),data:JSON.stringify(i),contentType:"application/json",dataType:"json"}).then(function(r){t.hide(),u(e,r)})}function u(e,t){function r(){var r=parseInt(this.getAttribute("data-index")),a=t[r];null!=q?v(e,a):m(e,a)}var a=e.querySelector(".identificationSearchResults");e.querySelector(".popupIdentifyForm").classList.add("hide"),a.classList.remove("hide"),e.querySelector(".identifyOptionsForm").classList.add("hide"),e.querySelector(".dialogContentInner").classList.remove("dialog-content-centered");var n,o,i="";for(n=0,o=t.length;o>n;n++){var l=t[n];i+=y(l,n)}var s=e.querySelector(".identificationSearchResultList");s.innerHTML=i;var u=s.querySelectorAll(".card");for(n=0,o=u.length;o>n;n++)u[n].addEventListener("click",r);d.tv&&c.autoFocus(a)}function m(r,a){k=a,D=!0,t.hide(),e.close(r)}function v(e,t){var r=e.querySelector(".identifyOptionsForm");e.querySelector(".popupIdentifyForm").classList.add("hide"),e.querySelector(".identificationSearchResults").classList.add("hide"),r.classList.remove("hide"),e.querySelector("#chkIdentifyReplaceImages").checked=!0,e.querySelector(".dialogContentInner").classList.add("dialog-content-centered"),k=t;var a=[];a.push(t.Name),t.ProductionYear&&a.push(t.ProductionYear),t.GameSystem&&a.push(t.GameSystem);var n=a.join("<br/>");if(t.ImageUrl){var o=p(t.ImageUrl,t.SearchProviderName);n='<div style="display:flex;align-items:center;"><img src="'+o+'" style="max-height:240px;" /><div style="margin-left:1em;">'+n+"</div>"}e.querySelector(".selectedSearchResult").innerHTML=n,c.focus(r.querySelector(".btnSubmit"))}function y(e,t){var a="",n="card scalableCard";if(n+="Episode"==x?" backdropCard":"MusicAlbum"==x||"MusicArtist"==x?" squareCard":" portraitCard",a+='<button type="button" class="'+n+'" data-index="'+t+'">',a+='<div class="cardBox visualCardBox">',a+='<div class="cardScalable">',a+='<div class="cardPadder-portrait"></div>',a+='<div class="cardContent searchImage">',e.ImageUrl){var o=p(e.ImageUrl,e.SearchProviderName);a+='<div class="cardImageContainer coveredImage" style="background-image:url(\''+o+"');\"></div>"}else a+='<div class="cardImageContainer coveredImage '+r.getDefaultColorClass(e.Name)+'"><div class="cardText cardCenteredText">'+e.Name+"</div></div>";return a+="</div>",a+="</div>",a+='<div class="cardFooter cardFooter-visual">',a+='<div class="cardText cardTextCentered">'+e.Name+"</div>",a+='<div class="cardText cardText-secondary cardTextCentered">',a+=e.ProductionYear||"&nbsp;",a+="</div>",e.GameSystem&&(a+='<div class="cardText cardText-secondary cardTextCentered">',a+=e.GameSystem,a+="</div>"),a+="</div>",a+="</div>",a+="</button>"}function p(e,t){var r=l();return r.getUrl("Items/RemoteSearch/Image",{imageUrl:e,ProviderName:t})}function f(r){t.show();var a={ReplaceAllImages:r.querySelector("#chkIdentifyReplaceImages").checked},n=l();n.ajax({type:"POST",url:n.getUrl("Items/RemoteSearch/Apply/"+q.Id,a),data:JSON.stringify(k),contentType:"application/json"}).then(function(){D=!0,t.hide(),e.close(r)},function(){t.hide(),e.close(r)})}function g(e,t){var r=l();r.getJSON(r.getUrl("Items/"+t.Id+"/ExternalIdInfos")).then(function(r){for(var a="",n=t.ProviderIds||{},i=0,d=r.length;d>i;i++){var c=r[i],l="txtLookup"+c.Key;a+='<div class="inputContainer">';{var s=o.translate("sharedcomponents#LabelDynamicExternalId").replace("{0}",c.Name);n[c.Key]||""}a+='<input is="emby-input" class="txtLookupId" data-providerkey="'+c.Key+'" id="'+l+'" label="'+s+'"/>',a+="</div>"}e.querySelector("#txtLookupName").value="","Person"==t.Type||"BoxSet"==t.Type?(e.querySelector(".fldLookupYear").classList.add("hide"),e.querySelector("#txtLookupYear").value=""):(e.querySelector(".fldLookupYear").classList.remove("hide"),e.querySelector("#txtLookupYear").value=""),e.querySelector(".identifyProviderIds").innerHTML=a,e.querySelector(".formDialogHeaderTitle").innerHTML=o.translate("sharedcomponents#Identify")})}function h(r){t.show(),n(["text!./itemidentifier.template.html"],function(a){var n=l();n.getItem(n.getCurrentUserId(),r).then(function(r){q=r,x=q.Type;var n={size:"medium",removeOnClose:!0,scrollY:!1};d.tv&&(n.size="fullscreen");var c=e.createDialog(n);c.classList.add("formDialog"),c.classList.add("recordingDialog");var l="";l+=o.translateDocument(a,"sharedcomponents"),c.innerHTML=l,document.body.appendChild(c),c.addEventListener("close",S),d.tv&&i.centerFocus.on(c.querySelector(".formDialogContent"),!1),e.open(c),c.querySelector(".popupIdentifyForm").addEventListener("submit",function(e){return e.preventDefault(),s(c),!1}),c.querySelector(".identifyOptionsForm").addEventListener("submit",function(e){return e.preventDefault(),f(c),!1}),c.querySelector(".btnCancel").addEventListener("click",function(){e.close(c)}),c.classList.add("identifyDialog"),g(c,r),t.hide()})})}function S(){t.hide(),D?C():T()}function L(r,a,c,l){q=null,x=c,n(["text!./itemidentifier.template.html"],function(n){var u={size:"medium",removeOnClose:!0,scrollY:!1};d.tv&&(u.size="fullscreen");var m=e.createDialog(u);m.classList.add("formDialog"),m.classList.add("recordingDialog");var v="";v+=o.translateDocument(n,"sharedcomponents"),m.innerHTML=v,document.body.appendChild(m),d.tv&&i.centerFocus.on(m.querySelector(".formDialogContent"),!1),e.open(m),m.querySelector(".btnCancel").addEventListener("click",function(){e.close(m)}),m.querySelector(".popupIdentifyForm").addEventListener("submit",function(e){return e.preventDefault(),s(m),!1}),m.addEventListener("close",function(){t.hide();var e=D?k:null;l(e)}),m.classList.add("identifyDialog"),I(m,r,a,c)})}function I(e,t,r,a){e.querySelector("#txtLookupName").value=t,"Person"==a||"BoxSet"==a?(e.querySelector(".fldLookupYear").classList.add("hide"),e.querySelector("#txtLookupYear").value=""):(e.querySelector(".fldLookupYear").classList.remove("hide"),e.querySelector("#txtLookupYear").value=r),e.querySelector(".formDialogHeaderTitle").innerHTML=o.translate("sharedcomponents#Search")}var q,x,b,C,T,k,D=!1;return{show:function(e,t){return new Promise(function(r,a){C=r,T=a,b=t,D=!1,h(e)})},showFindNew:function(e,t,r,a){return new Promise(function(n){b=a,D=!1,L(e,t,r,n)})}}});