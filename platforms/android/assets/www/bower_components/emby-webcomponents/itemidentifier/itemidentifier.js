define(["dialogHelper","loading","cardBuilder","connectionManager","require","globalize","scrollHelper","layoutManager","focusManager","emby-input","emby-checkbox","paper-icon-button-light","css!./../formdialog","material-icons","cardStyle"],function(e,t,r,a,n,i,o,d,l){function c(){return a.getApiClient(b)}function s(e){var r,a,o={ProviderIds:{}},d=e.querySelectorAll(".identifyField");for(r=0,a=d.length;a>r;r++){var l=d[r].value;l&&("number"==d[r].type&&(l=parseInt(l)),o[d[r].getAttribute("data-lookup")]=l)}var s=!1,m=e.querySelectorAll(".txtLookupId");for(r=0,a=m.length;a>r;r++){var l=m[r].value;l&&(s=!0),o.ProviderIds[m[r].getAttribute("data-providerkey")]=l}if(!s&&!o.Name)return void n(["toast"],function(e){e(i.translate("sharedcomponents#PleaseEnterNameOrId"))});q&&q.GameSystem&&(o.GameSystem=q.GameSystem),o={SearchInfo:o,IncludeDisabledProviders:!0},t.show();var v=c();v.ajax({type:"POST",url:v.getUrl("Items/RemoteSearch/"+x),data:JSON.stringify(o),contentType:"application/json",dataType:"json"}).then(function(r){t.hide(),u(e,r)})}function u(e,t){function r(){var r=parseInt(this.getAttribute("data-index")),a=t[r];null!=q?v(e,a):m(e,a)}var a=e.querySelector(".identificationSearchResults");e.querySelector(".popupIdentifyForm").classList.add("hide"),a.classList.remove("hide"),e.querySelector(".identifyOptionsForm").classList.add("hide"),e.querySelector(".dialogContentInner").classList.remove("centeredContent");var n,i,o="";for(n=0,i=t.length;i>n;n++){var c=t[n];o+=p(c,n)}var s=e.querySelector(".identificationSearchResultList");s.innerHTML=o;var u=s.querySelectorAll(".card");for(n=0,i=u.length;i>n;n++)u[n].addEventListener("click",r);d.tv&&l.autoFocus(a)}function m(r,a){T=a,P=!0,t.hide(),e.close(r)}function v(e,t){var r=e.querySelector(".identifyOptionsForm");e.querySelector(".popupIdentifyForm").classList.add("hide"),e.querySelector(".identificationSearchResults").classList.add("hide"),r.classList.remove("hide"),e.querySelector("#chkIdentifyReplaceImages").checked=!0,e.querySelector(".dialogContentInner").classList.add("centeredContent"),T=t;var a=[];a.push(t.Name),t.ProductionYear&&a.push(t.ProductionYear),t.GameSystem&&a.push(t.GameSystem);var n=a.join("<br/>");if(t.ImageUrl){var i=y(t.ImageUrl,t.SearchProviderName);n='<div style="display:flex;align-items:center;"><img src="'+i+'" style="max-height:240px;" /><div style="margin-left:1em;">'+n+"</div>"}e.querySelector(".selectedSearchResult").innerHTML=n,l.focus(r.querySelector(".btnSubmit"))}function p(e,t){var a="",n="card scalableCard";if(n+="Episode"==x?" backdropCard":"MusicAlbum"==x||"MusicArtist"==x?" squareCard":" portraitCard",a+='<button type="button" class="'+n+'" data-index="'+t+'">',a+='<div class="cardBox visualCardBox">',a+='<div class="cardScalable">',a+='<div class="cardPadder"></div>',a+='<div class="cardContent searchImage">',e.ImageUrl){var i=y(e.ImageUrl,e.SearchProviderName);a+='<div class="cardImageContainer coveredImage" style="background-image:url(\''+i+"');\"></div>"}else a+='<div class="cardImageContainer coveredImage '+r.getDefaultColorClass(e.Name)+'"><div class="cardText cardCenteredText">'+e.Name+"</div></div>";return a+="</div>",a+="</div>",a+='<div class="cardFooter">',a+='<div class="cardText cardTextCentered">'+e.Name+"</div>",a+='<div class="cardText cardTextCentered">',a+=e.ProductionYear||"&nbsp;",a+="</div>",e.GameSystem&&(a+='<div class="cardText cardTextCentered">',a+=e.GameSystem,a+="</div>"),a+="</div>",a+="</div>",a+="</button>"}function y(e,t){var r=c();return r.getUrl("Items/RemoteSearch/Image",{imageUrl:e,ProviderName:t})}function f(r){t.show();var a={ReplaceAllImages:r.querySelector("#chkIdentifyReplaceImages").checked},n=c();n.ajax({type:"POST",url:n.getUrl("Items/RemoteSearch/Apply/"+q.Id,a),data:JSON.stringify(T),contentType:"application/json"}).then(function(){P=!0,t.hide(),e.close(r)},function(){t.hide(),e.close(r)})}function h(e,t){var r=c();r.getJSON(r.getUrl("Items/"+t.Id+"/ExternalIdInfos")).then(function(r){for(var a="",n=t.ProviderIds||{},o=0,d=r.length;d>o;o++){var l=r[o],c="txtLookup"+l.Key;a+='<div class="inputContainer">';{var s=i.translate("sharedcomponents#LabelDynamicExternalId").replace("{0}",l.Name);n[l.Key]||""}a+='<input is="emby-input" class="txtLookupId" data-providerkey="'+l.Key+'" id="'+c+'" label="'+s+'"/>',a+="</div>"}e.querySelector("#txtLookupName").value="","Person"==t.Type||"BoxSet"==t.Type?(e.querySelector(".fldLookupYear").classList.add("hide"),e.querySelector("#txtLookupYear").value=""):(e.querySelector(".fldLookupYear").classList.remove("hide"),e.querySelector("#txtLookupYear").value=""),e.querySelector(".identifyProviderIds").innerHTML=a,e.querySelector(".dialogHeaderTitle").innerHTML=i.translate("sharedcomponents#Identify")})}function S(r){t.show(),n(["text!./itemidentifier.template.html"],function(a){var n=c();n.getItem(n.getCurrentUserId(),r).then(function(r){q=r,x=q.Type;var n={size:"medium",removeOnClose:!0,scrollY:!1};d.tv&&(n.size="fullscreen");var l=e.createDialog(n);l.classList.add("formDialog"),l.classList.add("recordingDialog");var c="";c+=i.translateDocument(a,"sharedcomponents"),l.innerHTML=c,document.body.appendChild(l),l.addEventListener("close",g),d.tv&&o.centerFocus.on(l.querySelector(".dialogContent"),!1),e.open(l),l.querySelector(".popupIdentifyForm").addEventListener("submit",function(e){return e.preventDefault(),s(l),!1}),l.querySelector(".identifyOptionsForm").addEventListener("submit",function(e){return e.preventDefault(),f(l),!1}),l.querySelector(".btnCancel").addEventListener("click",function(){e.close(l)}),l.classList.add("identifyDialog"),h(l,r),t.hide()})})}function g(){t.hide(),P?C():k()}function L(r,a,l,c){q=null,x=l,n(["text!./itemidentifier.template.html"],function(n){var u={size:"medium",removeOnClose:!0,scrollY:!1};d.tv&&(u.size="fullscreen");var m=e.createDialog(u);m.classList.add("formDialog"),m.classList.add("recordingDialog");var v="";v+=i.translateDocument(n,"sharedcomponents"),m.innerHTML=v,document.body.appendChild(m),d.tv&&o.centerFocus.on(m.querySelector(".dialogContent"),!1),e.open(m),m.querySelector(".btnCancel").addEventListener("click",function(){e.close(m)}),m.querySelector(".popupIdentifyForm").addEventListener("submit",function(e){return e.preventDefault(),s(m),!1}),m.addEventListener("close",function(){t.hide();var e=P?T:null;c(e)}),m.classList.add("identifyDialog"),I(m,r,a,l)})}function I(e,t,r,a){e.querySelector("#txtLookupName").value=t,"Person"==a||"BoxSet"==a?(e.querySelector(".fldLookupYear").classList.add("hide"),e.querySelector("#txtLookupYear").value=""):(e.querySelector(".fldLookupYear").classList.remove("hide"),e.querySelector("#txtLookupYear").value=r),e.querySelector(".dialogHeaderTitle").innerHTML=i.translate("sharedcomponents#Search")}var q,x,b,C,k,T,P=!1;return{show:function(e,t){return new Promise(function(r,a){C=r,k=a,b=t,P=!1,S(e)})},showFindNew:function(e,t,r,a){return new Promise(function(n){b=a,P=!1,L(e,t,r,n)})}}});