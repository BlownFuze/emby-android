define(["connectionManager","userSettings","events"],function(n,t,e){function r(){return w}function a(){var n=document.documentElement.getAttribute("data-culture");return n?n:navigator.language?navigator.language:navigator.userLanguage?navigator.userLanguage:navigator.languages&&navigator.languages.length?navigator.languages[0]:"en-us"}function i(){var n;try{n=t.get("language")}catch(e){}n=n||a(),w=s(n),o(w)}function o(n){for(var t in C)u(C[t],n)}function u(n,t){return n.dictionaries[t]?Promise.resolve():l(n.translations,t).then(function(e){n.dictionaries[t]=e})}function s(n){n=n.replace("_","-");var t=n.split("-");2==t.length&&t[0].toLowerCase()==t[1].toLowerCase()&&(n=t[0].toLowerCase());var e=n.toLowerCase();return"ca-es"==e?"ca":e}function g(n){n||(n=p());var t=C[n];return t?t.dictionaries[r()]:{}}function c(n){C[n.name]={translations:n.translations,dictionaries:{}};var t=r();return u(C[n.name],t)}function l(n,t){t=s(t);var e=n.filter(function(n){return s(n.lang)==t});return e.length||(e=n.filter(function(n){return"en-us"==s(n.lang)})),new Promise(function(n){if(!e.length)return void n();var t=e[0].path;t+=-1==t.indexOf("?")?"?":"&",t+="v="+O;var r=new XMLHttpRequest;r.open("GET",t,!0),r.onload=function(){this.status<400&&n(JSON.parse(this.response)),n({})},r.onerror=function(){n({})},r.send()})}function f(n){var t,e=n.split("#");return e.length>1&&(t=e[0],n=e[1]),v(n,t)}function v(n,t){return g(t)[n]||n}function d(n,t,e){return n.split(t).join(e)}function m(n){for(var t=f(n),e=1;e<arguments.length;e++)t=d(t,"{"+(e-1)+"}",arguments[e]);return t}function h(n,t){if(t||(t=p()),!t)throw new Error("module cannot be null or empty");var e=n.indexOf("${");if(-1==e)return n;e+=2;var r=n.indexOf("}",e);if(-1==r)return n;var a=n.substring(e,r),i=v(a,t);return n=n.replace("${"+a+"}",i),h(n,t)}function p(n){return n&&(L=n),L}var w,L,C={},O=(new Date).getTime();return i(),e.on(n,"localusersignedin",i),e.on(t,"change",function(n,t){"language"==t&&i()}),{getString:m,translate:m,translateDocument:h,translateHtml:h,loadStrings:c,defaultModule:p}});