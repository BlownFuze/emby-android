define(["connectionManager","userSettings","events"],function(n,t,e){function r(){return L}function a(){var n=document.documentElement.getAttribute("data-culture");return n?n:navigator.language?navigator.language:navigator.userLanguage?navigator.userLanguage:navigator.languages&&navigator.languages.length?navigator.languages[0]:"en-us"}function i(){var n;try{n=t.get("language")}catch(e){}n=n||a(),L=s(n),o(L)}function o(n){for(var t in O)u(O[t],n)}function u(n,t){return n.dictionaries[t]?Promise.resolve():f(n.translations,t).then(function(e){n.dictionaries[t]=e})}function s(n){n=n.replace("_","-");var t=n.split("-");2==t.length&&t[0].toLowerCase()==t[1].toLowerCase()&&(n=t[0].toLowerCase());var e=n.toLowerCase();return"ca-es"==e?"ca":e}function g(n){n||(n=w());var t=O[n];return t?t.dictionaries[r()]:{}}function c(n){O[n.name]={translations:n.strings||n.translations,dictionaries:{}}}function l(n){var t=r();return"string"==typeof n?u(O[n],t):(c(n),u(O[n.name],t))}function f(n,t){t=s(t);var e=n.filter(function(n){return s(n.lang)==t});return e.length||(e=n.filter(function(n){return"en-us"==s(n.lang)})),new Promise(function(n){if(!e.length)return void n();var t=e[0].path;t+=-1==t.indexOf("?")?"?":"&",t+="v="+S;var r=new XMLHttpRequest;r.open("GET",t,!0),r.onload=function(){this.status<400&&n(JSON.parse(this.response)),n({})},r.onerror=function(){n({})},r.send()})}function v(n){var t,e=n.split("#");return e.length>1&&(t=e[0],n=e[1]),d(n,t)}function d(n,t){return g(t)[n]||n}function m(n,t,e){return n.split(t).join(e)}function h(n){for(var t=v(n),e=1;e<arguments.length;e++)t=m(t,"{"+(e-1)+"}",arguments[e]);return t}function p(n,t){if(t||(t=w()),!t)throw new Error("module cannot be null or empty");var e=n.indexOf("${");if(-1==e)return n;e+=2;var r=n.indexOf("}",e);if(-1==r)return n;var a=n.substring(e,r),i=d(a,t);return n=n.replace("${"+a+"}",i),p(n,t)}function w(n){return n&&(C=n),C}var L,C,O={},S=(new Date).getTime();return i(),e.on(n,"localusersignedin",i),e.on(t,"change",function(n,t){"language"==t&&i()}),{getString:h,translate:h,translateDocument:p,translateHtml:p,loadStrings:l,defaultModule:w,getCurrentLocale:r,register:c}});