define(["jQuery"],function(e){function t(t,a){var n="";n+="<option value=''></option>";var l,o,r,i=[];for(l=0,o=t.length;o>l;l++){if(r=t[l],i.length){var c=i[i.length-1];if(c.Value===r.Value){c.Name+="/"+r.Name;continue}}i.push({Name:r.Name,Value:r.Value})}for(l=0,o=i.length;o>l;l++)r=i[l],n+="<option value='"+r.Value+"'>"+r.Name+"</option>";e("#selectMaxParentalRating",a).html(n)}function a(t,a){var n=[{name:Globalize.translate("OptionBlockBooks"),value:"Book"},{name:Globalize.translate("OptionBlockGames"),value:"Game"},{name:Globalize.translate("OptionBlockChannelContent"),value:"ChannelContent"},{name:Globalize.translate("OptionBlockLiveTvChannels"),value:"LiveTvChannel"},{name:Globalize.translate("OptionBlockLiveTvPrograms"),value:"LiveTvProgram"},{name:Globalize.translate("OptionBlockMovies"),value:"Movie"},{name:Globalize.translate("OptionBlockMusic"),value:"Music"},{name:Globalize.translate("OptionBlockTrailers"),value:"Trailer"},{name:Globalize.translate("OptionBlockTvShows"),value:"Series"},{name:Globalize.translate("OptionBlockOthers"),value:"Other"}],l="";l+='<p class="paperListLabel">'+Globalize.translate("HeaderBlockItemsWithNoRating")+"</p>",l+='<div class="paperCheckboxList">';for(var o=0,r=n.length;r>o;o++){var i=n[o],c=-1!=a.Policy.BlockUnratedItems.indexOf(i.value)?' checked="checked"':"";l+='<paper-checkbox class="chkUnratedItem" data-itemtype="'+i.value+'" type="checkbox"'+c+">"+i.name+"</paper-checkbox>"}l+="</div>",e(".blockUnratedItems",t).html(l).trigger("create")}function n(n,o,i){Dashboard.setPageTitle(o.Name),a(n,o),l(n,o.Policy.BlockedTags),t(i,n);var c="";if(o.Policy.MaxParentalRating)for(var u=0,s=i.length;s>u;u++){var d=i[u];o.Policy.MaxParentalRating>=d.Value&&(c=d.Value)}e("#selectMaxParentalRating",n).val(c),o.Policy.IsAdministrator?e(".accessScheduleSection",n).hide():e(".accessScheduleSection",n).show(),r(n,o.Policy.AccessSchedules||[]),Dashboard.hideLoadingMsg()}function l(t,a){var n='<ul data-role="listview" data-inset="true" data-split-icon="delete">'+a.map(function(e){var t="<li>";return t+='<a href="#">',t+='<div style="font-weight:normal;">'+e+"</div>",t+="</a>",t+='<a class="blockedTag btnDeleteTag" href="#" data-tag="'+e+'" data-icon="delete"></a>',t+="</li>"}).join("")+"</ul>",o=e(".blockedTags",t).html(n).trigger("create");e(".btnDeleteTag",o).on("click",function(){var e=this.getAttribute("data-tag"),n=a.filter(function(t){return t!=e});l(t,n)})}function o(e,t,a){t.splice(a,1),r(e,t)}function r(t,a){var n='<ul data-role="listview" data-inset="true" data-split-icon="minus">',l=0;n+=a.map(function(e){var t="";return t+='<li class="liSchedule" data-day="'+e.DayOfWeek+'" data-start="'+e.StartHour+'" data-end="'+e.EndHour+'">',t+='<a href="#">',t+="<h3>"+Globalize.translate("Option"+e.DayOfWeek)+"</h3>",t+="<p>"+u(e.StartHour)+" - "+u(e.EndHour)+"</p>",t+="</a>",t+='<a href="#" data-icon="delete" class="btnDelete" data-index="'+l+'">',t+="</a>",t+="</li>",l++,t}).join(""),n+="</ul>";var r=e(".accessScheduleList",t).html(n).trigger("create");e(".btnDelete",r).on("click",function(){o(t,a,parseInt(this.getAttribute("data-index")))})}function i(){Dashboard.hideLoadingMsg(),require(["toast"],function(e){e(Globalize.translate("SettingsSaved"))})}function c(t,a){t.Policy.MaxParentalRating=e("#selectMaxParentalRating",a).val()||null,t.Policy.BlockUnratedItems=e(".chkUnratedItem",a).get().filter(function(e){return e.checked}).map(function(e){return e.getAttribute("data-itemtype")}),t.Policy.AccessSchedules=p(a),t.Policy.BlockedTags=g(a),ApiClient.updateUserPolicy(t.Id,t.Policy).then(function(){i(a)})}function u(e){var t=0,a=e%1;return a&&(t=parseInt(60*a)),new Date(2e3,1,1,e,t,0,0).toLocaleTimeString()}function s(t){for(var a="",n=0;24>n;n++)a+='<option value="'+n+'">'+u(n)+"</option>";a+='<option value="24">'+u(0)+"</option>",e("#selectStart",t).html(a),e("#selectEnd",t).html(a)}function d(t,a,n){a=a||{},e("#popupSchedule",t).popup("open"),e("#fldScheduleIndex",t).val(n),e("#selectDay",t).val(a.DayOfWeek||"Sunday"),e("#selectStart",t).val(a.StartHour||0),e("#selectEnd",t).val(a.EndHour||0)}function h(t){var a={DayOfWeek:e("#selectDay",t).val(),StartHour:e("#selectStart",t).val(),EndHour:e("#selectEnd",t).val()};if(parseFloat(a.StartHour)>=parseFloat(a.EndHour))return void alert(Globalize.translate("ErrorMessageStartHourGreaterThanEnd"));var n=p(t),l=parseInt(e("#fldScheduleIndex",t).val());-1==l&&(l=n.length),n[l]=a,r(t,n),e("#popupSchedule",t).popup("close")}function p(t){return e(".liSchedule",t).map(function(){return{DayOfWeek:this.getAttribute("data-day"),StartHour:this.getAttribute("data-start"),EndHour:this.getAttribute("data-end")}}).get()}function g(t){return e(".blockedTag",t).map(function(){return this.getAttribute("data-tag")}).get()}function v(e){require(["prompt"],function(t){t({label:Globalize.translate("LabelTag")}).then(function(t){var a=g(e);-1==a.indexOf(t)&&(a.push(t),l(e,a))})})}window.UserParentalControlPage={onSubmit:function(){var t=e(this).parents(".page");Dashboard.showLoadingMsg();var a=getParameterByName("userId");return ApiClient.getUser(a).then(function(e){c(e,t)}),!1},onScheduleFormSubmit:function(){var t=e(this).parents(".page");return h(t),!1}},e(document).on("pageinit","#userParentalControlPage",function(){var t=this;e(".btnAddSchedule",t).on("click",function(){d(t,{},-1)}),e(".btnAddBlockedTag",t).on("click",function(){v(t)}),s(t),e(".scheduleForm").off("submit",UserParentalControlPage.onScheduleFormSubmit).on("submit",UserParentalControlPage.onScheduleFormSubmit),e(".userParentalControlForm").off("submit",UserParentalControlPage.onSubmit).on("submit",UserParentalControlPage.onSubmit)}).on("pageshow","#userParentalControlPage",function(){var e=this;Dashboard.showLoadingMsg();var t=getParameterByName("userId"),a=ApiClient.getUser(t),l=ApiClient.getParentalRatings();Promise.all([a,l]).then(function(t){n(e,t[0],t[1])})})});