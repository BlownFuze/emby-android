define(["jQuery"],function(e){function n(n,a){var l="";l+='<fieldset data-role="controlgroup">',l+="<legend>"+Globalize.translate("HeaderLibraries")+"</legend>";for(var t=0,r=a.length;r>t;t++){var i=a[t],c="mediaFolder"+t,s=' checked="checked"';l+='<input class="chkFolder" data-id="'+i.Id+'" type="checkbox" id="'+c+'"'+s+" />",l+='<label for="'+c+'">'+i.Name+"</label>"}l+="</fieldset>",e(".folderAccess",n).html(l).trigger("create"),e("#chkEnableAllFolders",n).checked(!0).checkboxradio("refresh").trigger("change")}function a(n,a){var l="";l+='<fieldset data-role="controlgroup">',l+="<legend>"+Globalize.translate("HeaderChannels")+"</legend>";for(var t=0,r=a.length;r>t;t++){var i=a[t],c="channels"+t,s=' checked="checked"';l+='<input class="chkChannel" data-id="'+i.Id+'" type="checkbox" id="'+c+'"'+s+" />",l+='<label for="'+c+'">'+i.Name+"</label>"}l+="</fieldset>",e(".channelAccess",n).show().html(l).trigger("create"),a.length?e(".channelAccessContainer",n).show():e(".channelAccessContainer",n).hide(),e("#chkEnableAllChannels",n).checked(!0).checkboxradio("refresh").trigger("change")}function l(l){e("#txtUserName",l).val(""),Dashboard.showLoadingMsg();var t=ApiClient.getJSON(ApiClient.getUrl("Library/MediaFolders",{IsHidden:!1})),r=ApiClient.getJSON(ApiClient.getUrl("Channels"));Promise.all([t,r]).then(function(e){n(l,e[0].Items),a(l,e[1].Items),Dashboard.hideLoadingMsg()})}function t(n){var a=e("#txtUserName",n).val();ApiClient.createUser(a).then(function(a){a.Policy.EnableAllFolders=e("#chkEnableAllFolders",n).checked(),a.Policy.EnabledFolders=a.Policy.EnableAllFolders?[]:e(".chkFolder:checked",n).map(function(){return this.getAttribute("data-id")}).get(),a.Policy.EnableAllChannels=e("#chkEnableAllChannels",n).checked(),a.Policy.EnabledChannels=a.Policy.EnableAllChannels?[]:e(".chkChannel:checked",n).map(function(){return this.getAttribute("data-id")}).get(),ApiClient.updateUserPolicy(a.Id,a.Policy).then(function(){Dashboard.navigate("useredit.html?userId="+a.Id)})},function(e){400==e.status?Dashboard.alert({message:n.querySelector(".labelNewUserNameHelp").innerHTML}):require(["toast"],function(e){e(Globalize.translate("DefaultErrorMessage"))}),Dashboard.hideLoadingMsg()})}function r(){var n=e(this).parents(".page")[0];return Dashboard.showLoadingMsg(),t(n),!1}function i(e){l(e)}e(document).on("pageinit","#newUserPage",function(){var n=this;e("#chkEnableAllChannels",n).on("change",function(){this.checked?e(".channelAccessListContainer",n).hide():e(".channelAccessListContainer",n).show()}),e("#chkEnableAllFolders",n).on("change",function(){this.checked?e(".folderAccessListContainer",n).hide():e(".folderAccessListContainer",n).show()}),e(".newUserProfileForm").off("submit",r).on("submit",r)}).on("pageshow","#newUserPage",function(){var e=this;i(e)})});