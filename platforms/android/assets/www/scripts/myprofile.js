define(["jQuery"],function(e){function a(a){var t=getParameterByName("userId");Dashboard.showLoadingMsg(),ApiClient.getUser(t).then(function(t){e(".username",a).html(t.Name),e("#uploadUserImage",a).val("").trigger("change"),Dashboard.setPageTitle(t.Name);var r;r=t.PrimaryImageTag?ApiClient.getUserImageUrl(t.Id,{height:200,tag:t.PrimaryImageTag,type:"Primary"}):"css/images/logindefault.png",e("#fldImage",a).show().html("").html("<img width='140px' src='"+r+"' />");var o=!1;"Guest"==t.ConnectLinkType?e(".connectMessage",a).show():t.PrimaryImageTag?(e("#headerUploadNewImage",a).show(),o=!0,e(".connectMessage",a).hide()):(o=!0,e("#headerUploadNewImage",a).show(),e(".connectMessage",a).hide()),Dashboard.getCurrentUser().then(function(r){o&&AppInfo.supportsFileInput&&(r.Policy.IsAdministrator||t.Policy.EnableUserPreferenceAccess)?(e(".newImageForm",a).show(),e("#btnDeleteImage",a).removeClass("hide")):(e(".newImageForm",a).hide(),e("#btnDeleteImage",a).addClass("hide"))}),Dashboard.hideLoadingMsg()})}function t(){Dashboard.hideLoadingMsg();var t=e(e.mobile.activePage)[0];a(t)}function r(e){switch(Dashboard.hideLoadingMsg(),e.target.error.code){case e.target.error.NOT_FOUND_ERR:require(["toast"],function(e){e(Globalize.translate("FileNotFound"))});break;case e.target.error.NOT_READABLE_ERR:require(["toast"],function(e){e(Globalize.translate("FileReadError"))});break;case e.target.error.ABORT_ERR:break;default:require(["toast"],function(e){e(Globalize.translate("FileReadError"))})}}function o(){e("#fldUpload",e.mobile.activePage).hide()}function s(){Dashboard.hideLoadingMsg(),require(["toast"],function(e){e(Globalize.translate("FileReadCancelled"))})}function n(a,t){var n=t[0];if(!n||!n.type.match("image.*"))return e("#userImageOutput",a).html(""),e("#fldUpload",a).hide(),void(f=null);f=n;var i=new FileReader;i.onerror=r,i.onloadstart=o,i.onabort=s,i.onload=function(t){var r=['<img style="max-width:500px;max-height:200px;" src="',t.target.result,'" title="',escape(n.name),'"/>'].join("");e("#userImageOutput",a).html(r),e("#fldUpload",a).show()},i.readAsDataURL(n)}function i(a){return a.preventDefault(),n(e.mobile.activePage,a.originalEvent.dataTransfer.files),!1}function d(e){return e.preventDefault(),e.originalEvent.dataTransfer.dropEffect="Copy",!1}function l(){var e=this;e.onImageSubmit=function(){var e=f;if(!e)return!1;if("image/png"!=e.type&&"image/jpeg"!=e.type&&"image/jpeg"!=e.type)return!1;Dashboard.showLoadingMsg();var a=getParameterByName("userId");return ApiClient.uploadUserImage(a,"Primary",e).then(t),!1}}function c(a){var t=getParameterByName("userId");ApiClient.getUser(t).then(function(t){Dashboard.getCurrentUser().then(function(r){Dashboard.setPageTitle(t.Name);var o=!0,s=!1;"Guest"==t.ConnectLinkType?(e(".localAccessSection",a).hide(),o=!1):t.HasConfiguredPassword?(e("#btnResetPassword",a).show(),e("#fldCurrentPassword",a).show(),s=!0):(e("#btnResetPassword",a).hide(),e("#fldCurrentPassword",a).hide()),o&&(r.Policy.IsAdministrator||t.Policy.EnableUserPreferenceAccess)?e(".passwordSection",a).show():e(".passwordSection",a).hide(),s&&(r.Policy.IsAdministrator||t.Policy.EnableUserPreferenceAccess)?e(".localAccessSection",a).show():e(".localAccessSection",a).hide(),t.HasConfiguredEasyPassword?e("#txtEasyPassword",a).val("").attr("placeholder","******"):e("#txtEasyPassword",a).val("").attr("placeholder",""),a.querySelector(".chkEnableLocalEasyPassword").checked=t.Configuration.EnableLocalPassword})}),e("#txtCurrentPassword",a).val(""),e("#txtNewPassword",a).val(""),e("#txtNewPasswordConfirm",a).val("")}function g(a){var t=getParameterByName("userId"),r=e("#txtEasyPassword",a).val();r?ApiClient.updateEasyPassword(t,r).then(function(){u(a,t)}):u(a,t)}function u(e,a){ApiClient.getUser(a).then(function(a){a.Configuration.EnableLocalPassword=e.querySelector(".chkEnableLocalEasyPassword").checked,ApiClient.updateUserConfiguration(a.Id,a.Configuration).then(function(){Dashboard.hideLoadingMsg(),require(["toast"],function(e){e(Globalize.translate("MessageSettingsSaved"))}),c(e)})})}function m(a){var t=getParameterByName("userId"),r=e("#txtCurrentPassword",a).val(),o=e("#txtNewPassword",a).val();ApiClient.updateUserPassword(t,r,o).then(function(){Dashboard.hideLoadingMsg(),require(["toast"],function(e){e(Globalize.translate("PasswordSaved"))}),c(a)},function(){Dashboard.hideLoadingMsg(),Dashboard.alert({title:Globalize.translate("HeaderLoginFailure"),message:Globalize.translate("MessageInvalidUser")})})}function h(){var a=this;a.onSubmit=function(){var a=e(e.mobile.activePage)[0];return e("#txtNewPassword",a).val()!=e("#txtNewPasswordConfirm",a).val()?require(["toast"],function(e){e(Globalize.translate("PasswordMatchError"))}):(Dashboard.showLoadingMsg(),m(a)),!1},a.onLocalAccessSubmit=function(){var a=e(e.mobile.activePage)[0];return Dashboard.showLoadingMsg(),g(a),!1},a.resetPassword=function(){var a=Globalize.translate("PasswordResetConfirmation"),t=e(e.mobile.activePage)[0];require(["confirm"],function(e){e(a,Globalize.translate("PasswordResetHeader")).then(function(){var e=getParameterByName("userId");Dashboard.showLoadingMsg(),ApiClient.resetUserPassword(e).then(function(){Dashboard.hideLoadingMsg(),Dashboard.alert({message:Globalize.translate("PasswordResetComplete"),title:Globalize.translate("PasswordResetHeader")}),c(t)})})})}}var f;window.MyProfilePage=new l,e(document).on("pageinit","#userImagePage",function(){var r=this;a(r),e("#userImageDropZone",r).on("dragover",d).on("drop",i),e("#btnDeleteImage",r).on("click",function(){require(["confirm"],function(e){e(Globalize.translate("DeleteImageConfirmation"),Globalize.translate("DeleteImage")).then(function(){Dashboard.showLoadingMsg();var e=getParameterByName("userId");ApiClient.deleteUserImage(e,"primary").then(t)})})}),e(".newImageForm").off("submit",MyProfilePage.onImageSubmit).on("submit",MyProfilePage.onImageSubmit),r.querySelector("#uploadUserImage").addEventListener("change",function(e){n(r,e.target.files)})}),window.UpdatePasswordPage=new h,e(document).on("pageinit",".userPasswordPage",function(){e(".updatePasswordForm").off("submit",UpdatePasswordPage.onSubmit).on("submit",UpdatePasswordPage.onSubmit),e(".localAccessForm").off("submit",UpdatePasswordPage.onLocalAccessSubmit).on("submit",UpdatePasswordPage.onLocalAccessSubmit)}).on("pageshow",".userPasswordPage",function(){var e=this;c(e)})});