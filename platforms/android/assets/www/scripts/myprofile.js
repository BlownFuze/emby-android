define(["scripts/userpasswordpage"],function(e){function r(e){var r=getParameterByName("userId");Dashboard.showLoadingMsg(),ApiClient.getUser(r).then(function(r){e.querySelector(".username").innerHTML=r.Name;var a=e.querySelector("#uploadUserImage");a.value="",a.dispatchEvent(new CustomEvent("change",{})),Dashboard.setPageTitle(r.Name);var t;t=r.PrimaryImageTag?ApiClient.getUserImageUrl(r.Id,{height:200,tag:r.PrimaryImageTag,type:"Primary"}):"css/images/logindefault.png";var n=e.querySelector("#fldImage");n.classList.remove("hide"),n.innerHTML="<img width='140px' src='"+t+"' />";var i=!1;"Guest"==r.ConnectLinkType?e.querySelector(".connectMessage").classList.remove("hide"):r.PrimaryImageTag?(i=!0,e.querySelector(".connectMessage").classList.add("hide")):(i=!0,e.querySelector(".connectMessage").classList.add("hide")),Dashboard.getCurrentUser().then(function(a){i&&AppInfo.supportsFileInput&&(a.Policy.IsAdministrator||r.Policy.EnableUserPreferenceAccess)?(e.querySelector(".newImageForm").classList.remove("hide"),e.querySelector("#btnDeleteImage").classList.remove("hide")):(e.querySelector(".newImageForm").classList.add("hide"),e.querySelector("#btnDeleteImage").classList.add("hide"))}),Dashboard.hideLoadingMsg()})}function a(e){switch(Dashboard.hideLoadingMsg(),e.target.error.code){case e.target.error.NOT_FOUND_ERR:require(["toast"],function(e){e(Globalize.translate("FileNotFound"))});break;case e.target.error.NOT_READABLE_ERR:require(["toast"],function(e){e(Globalize.translate("FileReadError"))});break;case e.target.error.ABORT_ERR:break;default:require(["toast"],function(e){e(Globalize.translate("FileReadError"))})}}function t(){Dashboard.hideLoadingMsg(),require(["toast"],function(e){e(Globalize.translate("FileReadCancelled"))})}function n(e,r){var n=r[0];if(!n||!n.type.match("image.*"))return e.querySelector("#userImageOutput").innerHTML="",e.querySelector("#fldUpload").classList.add("hide"),void(o=null);o=n;var i=new FileReader;i.onerror=a,i.onloadstart=function(){e.querySelector("#fldUpload").classList.add("hide")},i.onabort=t,i.onload=function(r){var a=['<img style="max-width:500px;max-height:200px;" src="',r.target.result,'" title="',escape(n.name),'"/>'].join("");e.querySelector("#userImageOutput").innerHTML=a,e.querySelector("#fldUpload").classList.remove("hide")},i.readAsDataURL(n)}function i(e){return e.preventDefault(),e.originalEvent.dataTransfer.dropEffect="Copy",!1}var o;return function(a,t){r(a);var s=(new e(a,t),a.querySelector("#userImageDropZone"));s.addEventListener("dragOver",i),s.addEventListener("drop",function(e){return e.preventDefault(),n(a,e.originalEvent.dataTransfer.files),!1}),a.querySelector("#btnDeleteImage").addEventListener("click",function(){require(["confirm"],function(e){e(Globalize.translate("DeleteImageConfirmation"),Globalize.translate("DeleteImage")).then(function(){Dashboard.showLoadingMsg();var e=getParameterByName("userId");ApiClient.deleteUserImage(e,"primary").then(function(){Dashboard.hideLoadingMsg(),r(a)})})})}),a.querySelector(".newImageForm").addEventListener("submit",function(e){var t=o;if(!t)return!1;if("image/png"!=t.type&&"image/jpeg"!=t.type&&"image/jpeg"!=t.type)return!1;Dashboard.showLoadingMsg();var n=getParameterByName("userId");return ApiClient.uploadUserImage(n,"Primary",t).then(function(){Dashboard.hideLoadingMsg(),r(a)}),e.preventDefault(),!1}),a.querySelector("#uploadUserImage").addEventListener("change",function(e){n(a,e.target.files)})}});