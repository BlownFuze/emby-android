define(["jQuery"],function(e){function a(a){var t=getParameterByName("userId");Dashboard.showLoadingMsg(),ApiClient.getUser(t).then(function(t){e(".username",a).html(t.Name),e("#uploadUserImage",a).val("").trigger("change"),Dashboard.setPageTitle(t.Name);var r;r=t.PrimaryImageTag?ApiClient.getUserImageUrl(t.Id,{height:200,tag:t.PrimaryImageTag,type:"Primary"}):"css/images/logindefault.png",e("#fldImage",a).show().html("").html("<img width='140px' src='"+r+"' />");var s=!1;"Guest"==t.ConnectLinkType?e(".connectMessage",a).show():t.PrimaryImageTag?(e("#headerUploadNewImage",a).show(),s=!0,e(".connectMessage",a).hide()):(s=!0,e("#headerUploadNewImage",a).show(),e(".connectMessage",a).hide()),Dashboard.getCurrentUser().then(function(r){s&&AppInfo.supportsFileInput&&(r.Policy.IsAdministrator||t.Policy.EnableUserPreferenceAccess)?(e(".newImageForm",a).show(),e("#btnDeleteImage",a).removeClass("hide")):(e(".newImageForm",a).hide(),e("#btnDeleteImage",a).addClass("hide"))}),Dashboard.hideLoadingMsg()})}function t(e){switch(Dashboard.hideLoadingMsg(),e.target.error.code){case e.target.error.NOT_FOUND_ERR:require(["toast"],function(e){e(Globalize.translate("FileNotFound"))});break;case e.target.error.NOT_READABLE_ERR:require(["toast"],function(e){e(Globalize.translate("FileReadError"))});break;case e.target.error.ABORT_ERR:break;default:require(["toast"],function(e){e(Globalize.translate("FileReadError"))})}}function r(){Dashboard.hideLoadingMsg(),require(["toast"],function(e){e(Globalize.translate("FileReadCancelled"))})}function s(a,s){var o=s[0];if(!o||!o.type.match("image.*"))return e("#userImageOutput",a).html(""),e("#fldUpload",a).hide(),void(u=null);u=o;var n=new FileReader;n.onerror=t,n.onloadstart=function(){e("#fldUpload",a).hide()},n.onabort=r,n.onload=function(t){var r=['<img style="max-width:500px;max-height:200px;" src="',t.target.result,'" title="',escape(o.name),'"/>'].join("");e("#userImageOutput",a).html(r),e("#fldUpload",a).show()},n.readAsDataURL(o)}function o(e){return e.preventDefault(),e.originalEvent.dataTransfer.dropEffect="Copy",!1}function n(a){var t=getParameterByName("userId");ApiClient.getUser(t).then(function(t){Dashboard.getCurrentUser().then(function(r){Dashboard.setPageTitle(t.Name);var s=!0,o=!1;"Guest"==t.ConnectLinkType?(e(".localAccessSection",a).hide(),s=!1):t.HasConfiguredPassword?(e("#btnResetPassword",a).show(),e("#fldCurrentPassword",a).show(),o=!0):(e("#btnResetPassword",a).hide(),e("#fldCurrentPassword",a).hide()),s&&(r.Policy.IsAdministrator||t.Policy.EnableUserPreferenceAccess)?e(".passwordSection",a).show():e(".passwordSection",a).hide(),o&&(r.Policy.IsAdministrator||t.Policy.EnableUserPreferenceAccess)?e(".localAccessSection",a).show():e(".localAccessSection",a).hide(),t.HasConfiguredEasyPassword?(e("#txtEasyPassword",a).val("").attr("placeholder","******"),e("#btnResetEasyPassword",a).removeClass("hide")):(e("#txtEasyPassword",a).val("").attr("placeholder",""),e("#btnResetEasyPassword",a).addClass("hide")),a.querySelector(".chkEnableLocalEasyPassword").checked=t.Configuration.EnableLocalPassword})}),e("#txtCurrentPassword",a).val(""),e("#txtNewPassword",a).val(""),e("#txtNewPasswordConfirm",a).val("")}function i(a){var t=getParameterByName("userId"),r=e("#txtEasyPassword",a).val();r?ApiClient.updateEasyPassword(t,r).then(function(){d(a,t)}):d(a,t)}function d(e,a){ApiClient.getUser(a).then(function(a){a.Configuration.EnableLocalPassword=e.querySelector(".chkEnableLocalEasyPassword").checked,ApiClient.updateUserConfiguration(a.Id,a.Configuration).then(function(){Dashboard.hideLoadingMsg(),require(["toast"],function(e){e(Globalize.translate("MessageSettingsSaved"))}),n(e)})})}function l(a){var t=getParameterByName("userId"),r=e("#txtCurrentPassword",a).val(),s=e("#txtNewPassword",a).val();ApiClient.updateUserPassword(t,r,s).then(function(){Dashboard.hideLoadingMsg(),require(["toast"],function(e){e(Globalize.translate("PasswordSaved"))}),n(a)},function(){Dashboard.hideLoadingMsg(),Dashboard.alert({title:Globalize.translate("HeaderLoginFailure"),message:Globalize.translate("MessageInvalidUser")})})}function c(){var a=this;a.onSubmit=function(){var a=this,t=e(a).parents(".page")[0];return e("#txtNewPassword",t).val()!=e("#txtNewPasswordConfirm",t).val()?require(["toast"],function(e){e(Globalize.translate("PasswordMatchError"))}):(Dashboard.showLoadingMsg(),l(t)),!1},a.onLocalAccessSubmit=function(){var a=this,t=e(a).parents(".page")[0];return Dashboard.showLoadingMsg(),i(t),!1},a.resetPassword=function(){var a=Globalize.translate("PasswordResetConfirmation"),t=e(e.mobile.activePage)[0];require(["confirm"],function(e){e(a,Globalize.translate("PasswordResetHeader")).then(function(){var e=getParameterByName("userId");Dashboard.showLoadingMsg(),ApiClient.resetUserPassword(e).then(function(){Dashboard.hideLoadingMsg(),Dashboard.alert({message:Globalize.translate("PasswordResetComplete"),title:Globalize.translate("PasswordResetHeader")}),n(t)})})})},a.resetEasyPassword=function(){var a=Globalize.translate("PinCodeResetConfirmation"),t=e(e.mobile.activePage)[0];require(["confirm"],function(e){e(a,Globalize.translate("HeaderPinCodeReset")).then(function(){var e=getParameterByName("userId");Dashboard.showLoadingMsg(),ApiClient.resetEasyPassword(e).then(function(){Dashboard.hideLoadingMsg(),Dashboard.alert({message:Globalize.translate("PinCodeResetComplete"),title:Globalize.translate("HeaderPinCodeReset")}),n(t)})})})}}var u;e(document).on("pageinit","#userImagePage",function(){var t=this;a(t),e("#userImageDropZone",t).on("dragover",o).on("drop",function(e){return e.preventDefault(),s(t,e.originalEvent.dataTransfer.files),!1}),e("#btnDeleteImage",t).on("click",function(){require(["confirm"],function(e){e(Globalize.translate("DeleteImageConfirmation"),Globalize.translate("DeleteImage")).then(function(){Dashboard.showLoadingMsg();var e=getParameterByName("userId");ApiClient.deleteUserImage(e,"primary").then(function(){Dashboard.hideLoadingMsg(),a(t)})})})}),e(".newImageForm").on("submit",function(){var e=this;e.onImageSubmit=function(){var e=u;if(!e)return!1;if("image/png"!=e.type&&"image/jpeg"!=e.type&&"image/jpeg"!=e.type)return!1;Dashboard.showLoadingMsg();var r=getParameterByName("userId");return ApiClient.uploadUserImage(r,"Primary",e).then(function(){Dashboard.hideLoadingMsg(),a(t)}),!1}}),t.querySelector("#uploadUserImage").addEventListener("change",function(e){s(t,e.target.files)})}),window.UpdatePasswordPage=new c,e(document).on("pageinit",".userPasswordPage",function(){e(".updatePasswordForm").off("submit",UpdatePasswordPage.onSubmit).on("submit",UpdatePasswordPage.onSubmit),e(".localAccessForm").off("submit",UpdatePasswordPage.onLocalAccessSubmit).on("submit",UpdatePasswordPage.onLocalAccessSubmit)}).on("pageshow",".userPasswordPage",function(){var e=this;n(e)})});