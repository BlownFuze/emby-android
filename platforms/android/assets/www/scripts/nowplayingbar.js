define(["datetime","jQuery","paper-icon-button-light"],function(e,n){function t(){var e="";return e+='<div class="nowPlayingBar hide">',e+='<div class="nowPlayingBarPositionContainer">',e+='<paper-slider pin step=".1" min="0" max="100" value="0" class="nowPlayingBarPositionSlider"></paper-slider>',e+="</div>",e+='<div class="nowPlayingBarInfoContainer">',e+='<div class="nowPlayingImage"></div>',e+='<div class="nowPlayingBarText"></div>',e+="</div>",e+='<div class="nowPlayingBarCenter">',e+='<button is="paper-icon-button-light" class="previousTrackButton mediaButton"><iron-icon icon="skip-previous"></iron-icon></button>',e+='<button is="paper-icon-button-light" class="unpauseButton mediaButton"><iron-icon icon="play-arrow"></iron-icon></button>',e+='<button is="paper-icon-button-light" class="pauseButton mediaButton"><iron-icon icon="pause"></iron-icon></button>',e+='<button is="paper-icon-button-light" class="stopButton mediaButton"><iron-icon icon="stop"></iron-icon></button>',e+='<button is="paper-icon-button-light" class="nextTrackButton mediaButton"><iron-icon icon="skip-next"></iron-icon></button>',e+='<div class="nowPlayingBarCurrentTime"></div>',e+="</div>",e+='<div class="nowPlayingBarRight">',e+='<button is="paper-icon-button-light" class="muteButton mediaButton"><iron-icon icon="volume-up"></iron-icon></button>',e+='<button is="paper-icon-button-light" class="unmuteButton mediaButton"><iron-icon icon="volume-off"></iron-icon></button>',e+='<paper-slider pin step="1" min="0" max="100" value="0" class="nowPlayingBarVolumeSlider" style="width:100px;vertical-align:middle;display:inline-block;"></paper-slider>',e+='<button is="paper-icon-button-light" class="toggleRepeatButton mediaButton"><iron-icon icon="repeat"></iron-icon></button>',e+='<div class="nowPlayingBarUserDataButtons">',e+="</div>",e+='<button is="paper-icon-button-light" class="unpauseButton mediaButton"><iron-icon icon="play-arrow"></iron-icon></button>',e+='<button is="paper-icon-button-light" class="pauseButton mediaButton"><iron-icon icon="pause"></iron-icon></button>',e+='<button is="paper-icon-button-light" class="remoteControlButton mediaButton"><iron-icon icon="tablet-android"></iron-icon></button>',e+='<button is="paper-icon-button-light" class="playlistButton mediaButton"><iron-icon icon="queue-music"></iron-icon></button>',e+="</div>",e+="</div>"}function i(e){return U||(U=e.offsetHeight),U+"px"}function o(e){if(!e.classList.contains("hide")){var n=function(){e.classList.add("hide")};return!browserInfo.animate||browserInfo.mobile?void n():void requestAnimationFrame(function(){var t=[{height:i(e),offset:0},{height:"0",display:"none",offset:1}],o={duration:200,iterations:1,fill:"both",easing:"ease-out"};e.animate(t,o).onfinish=n})}}function a(e){e.classList.contains("hide")&&(e.classList.remove("hide"),browserInfo.animate&&!browserInfo.mobile&&requestAnimationFrame(function(){var n=[{height:"0",offset:0},{height:i(e),offset:1}],t={duration:200,iterations:1,fill:"both",easing:"ease-out"};e.animate(n,t)}))}function r(t){T=t.querySelector(".nowPlayingBarCurrentTime"),k=t.querySelector(".nowPlayingImage"),R=t.querySelector(".nowPlayingBarText"),C=t.querySelector(".nowPlayingBarUserDataButtons"),L=n(".unmuteButton",t).on("click",function(){w&&w.unMute()}),M=n(".muteButton",t).on("click",function(){w&&w.mute()}),n(".stopButton",t).on("click",function(){w&&w.stop()}),x=n(".pauseButton",t).on("click",function(){w&&w.pause()}),N=n(".unpauseButton",t).on("click",function(){w&&w.unpause()}),n(".nextTrackButton",t).on("click",function(){w&&w.nextTrack()}),n(".previousTrackButton",t).on("click",function(){w&&w.previousTrack()}),t.querySelector(".remoteControlButton").addEventListener("click",function(){s()}),t.querySelector(".playlistButton").addEventListener("click",function(){s("playlist")}),E=n(".toggleRepeatButton",t).on("click",function(){if(w){var e=q||{};switch((e.PlayState||{}).RepeatMode){case"RepeatAll":w.setRepeatMode("RepeatOne");break;case"RepeatOne":w.setRepeatMode("RepeatNone");break;default:w.setRepeatMode("RepeatAll")}}})[0],D=E.querySelector("iron-icon"),setTimeout(function(){S=n(".nowPlayingBarVolumeSlider",t).on("change",function(){w&&w.setVolume(this.value)})[0],A=n(".nowPlayingBarPositionSlider",t).on("change",function(){if(w&&q){var e=parseFloat(this.value),n=e/100*q.NowPlayingItem.RunTimeTicks;w.seek(Math.floor(n))}})[0],A._setPinValue=function(n){var t=q;if(!t||!t.NowPlayingItem||!t.NowPlayingItem.RunTimeTicks)return void(this.pinValue="--:--");var i=t.NowPlayingItem.RunTimeTicks;i/=100,i*=n,this.pinValue=e.getDisplayRunningTime(i)}},300)}function s(e){Dashboard.navigate(e?"nowplaying.html?tab="+e:"nowplaying.html")}function l(){return new Promise(function(e){return V?void e(V):void require(["jQuery","css!css/nowplayingbar.css","paper-slider"],function(n){return(V=document.querySelector(".nowPlayingBar"))?void e(V):(V=n(t()).appendTo(document.body)[0],!browserInfo.safari&&AppInfo.isNativeApp||!browserInfo.mobile||V.classList.add("noMediaProgress"),r(V),void e(V))})})}function u(e){e.removeClass("hide")}function c(e){e.addClass("hide")}function d(e,n){return n.NowPlayingItem?V?void p(e,n):void l().then(function(){p(e,n)}):void v()}function p(n,t){if(f(),"positionchange"==n.type){var i=(new Date).getTime();if(700>i-O)return;O=i}q=t;var o=MediaController.getPlayerInfo(),a=t.PlayState||{};a.IsPaused?(c(x),u(N)):(u(x),c(N)),g(t,o);var r=t.NowPlayingItem||{};if(A&&!A.dragging){if(r.RunTimeTicks){var s=a.PositionTicks/r.RunTimeTicks;s*=100,A.value=s}else A.value=0;A.disabled=!a.CanSeek}var l=e.getDisplayRunningTime(a.PositionTicks);r.RunTimeTicks&&(l+=" / "+e.getDisplayRunningTime(r.RunTimeTicks)),T.innerHTML=l,m(t)}function g(e,n){n=n||MediaController.getPlayerInfo();var t=e.PlayState||{},i=n.supportedCommands,o=!0,a=!0,r=!0;-1==i.indexOf("Mute")&&(o=!1),-1==i.indexOf("Unmute")&&(a=!1),t.IsMuted?o=!1:a=!1,-1==i.indexOf("SetRepeatMode")?E.classList.add("hide"):E.classList.remove("hide"),"RepeatAll"==t.RepeatMode?(D.icon="repeat",E.classList.add("repeatActive")):"RepeatOne"==t.RepeatMode?(D.icon="repeat-one",E.classList.add("repeatActive")):(D.icon="repeat",E.classList.remove("repeatActive")),-1==i.indexOf("SetVolume")&&(r=!1),n.isLocalPlayer&&AppInfo.hasPhysicalVolumeButtons&&(o=!1,a=!1,r=!1),o?u(M):c(M),a?u(L):c(L),S&&(r?S.classList.remove("hide"):S.classList.add("hide"),S.dragging||(S.value=t.VolumeLevel||0))}function m(e){var n=MediaController.getNowPlayingNameHtml(e.NowPlayingItem)||"";-1!=n.indexOf("<br/>")?R.classList.add("nowPlayingDoubleText"):R.classList.remove("nowPlayingDoubleText"),e.NowPlayingItem.Id&&(n='<a style="color:inherit;text-decoration:none;" href="'+LibraryBrowser.getHref(e.NowPlayingItem)+'">'+n+"</a>"),R.innerHTML=n;var t,i=80,o=e.NowPlayingItem;t=o.PrimaryImageTag?ApiClient.getScaledImageUrl(o.PrimaryImageItemId,{type:"Primary",height:i,tag:o.PrimaryImageTag}):o.BackdropImageTag?ApiClient.getScaledImageUrl(o.BackdropItemId,{type:"Backdrop",height:i,tag:o.BackdropImageTag,index:0}):o.ThumbImageTag?ApiClient.getScaledImageUrl(o.ThumbImageItemId,{type:"Thumb",height:i,tag:o.ThumbImageTag}):"TvChannel"==o.Type||"Recording"==o.Type?"css/images/items/detail/tv.png":"Audio"==o.MediaType?"css/images/items/detail/audio.png":"css/images/items/detail/video.png",t!=H&&(H=t,ImageLoader.lazyImage(k,t),o.Id?ApiClient.getItem(Dashboard.getCurrentUserId(),o.Id).then(function(e){C.innerHTML=LibraryBrowser.getUserDataIconsHtml(e,!1)}):C.innerHTML="")}function y(e,n){var t=this;t.beginPlayerUpdates(),b.call(t,e,n)}function f(){l().then(a)}function v(){var e=document.getElementsByClassName("nowPlayingBar")[0];e&&o(e)}function h(e){var n=this;n.endPlayerUpdates(),v()}function b(e,n){var t=this;t.isDefaultPlayer&&n.NowPlayingItem&&"Video"==n.NowPlayingItem.MediaType||d(e,n)}function P(){w&&(Events.off(w,"playbackstart",y),Events.off(w,"playbackstop",h),Events.off(w,"volumechange",B),Events.off(w,"playstatechange",b),Events.off(w,"positionchange",b),w.endPlayerUpdates(),w=null,v())}function B(){var e=this;Promise.all([e.getPlayerState(),l()]).then(function(n){var t=n[0];e.isDefaultPlayer&&t.NowPlayingItem&&"Video"==t.NowPlayingItem.MediaType||g(t)})}function I(e){P(),w=e,e.getPlayerState().then(function(n){n.NowPlayingItem&&e.beginPlayerUpdates(),b.call(e,{type:"init"},n)}),Events.on(e,"playbackstart",y),Events.on(e,"playbackstop",h),Events.on(e,"volumechange",B),Events.on(e,"playstatechange",b),Events.on(e,"positionchange",b)}var w,T,k,R,C,L,M,S,N,x,A,E,D,q,U,V,H,O=0;Events.on(MediaController,"playerchange",function(){I(MediaController.getCurrentPlayer())}),I(MediaController.getCurrentPlayer())});