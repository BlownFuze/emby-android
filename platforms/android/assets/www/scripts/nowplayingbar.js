define([],function(){function e(){var e="";return e+='<div class="nowPlayingBar hide">',e+='<div class="nowPlayingBarPositionContainer">',e+='<paper-slider pin step=".1" min="0" max="100" value="0" class="nowPlayingBarPositionSlider"></paper-slider>',e+="</div>",e+='<div class="nowPlayingBarInfoContainer">',e+='<div class="nowPlayingImage"></div>',e+='<div class="nowPlayingBarText"></div>',e+="</div>",e+='<div class="nowPlayingBarCenter">',e+='<paper-icon-button icon="skip-previous" class="previousTrackButton mediaButton"></paper-icon-button>',e+='<paper-icon-button icon="play-arrow" class="mediaButton unpauseButton"></paper-icon-button>',e+='<paper-icon-button icon="pause" class="mediaButton pauseButton"></paper-icon-button>',e+='<paper-icon-button icon="stop" class="stopButton mediaButton"></paper-icon-button>',e+='<paper-icon-button icon="skip-next" class="nextTrackButton mediaButton"></paper-icon-button>',e+='<div class="nowPlayingBarCurrentTime"></div>',e+="</div>",e+='<div class="nowPlayingBarRight">',e+='<paper-icon-button icon="volume-up" class="muteButton mediaButton"></paper-icon-button>',e+='<paper-icon-button icon="volume-off" class="unmuteButton mediaButton"></paper-icon-button>',e+='<paper-slider pin step="1" min="0" max="100" value="0" class="nowPlayingBarVolumeSlider" style="width:100px;vertical-align:middle;display:inline-block;"></paper-slider>',e+='<paper-icon-button icon="repeat" class="mediaButton toggleRepeatButton"></paper-icon-button>',e+='<div class="nowPlayingBarUserDataButtons">',e+="</div>",e+='<paper-icon-button icon="play-arrow" class="mediaButton unpauseButton"></paper-icon-button>',e+='<paper-icon-button icon="pause" class="mediaButton pauseButton"></paper-icon-button>',e+='<paper-icon-button icon="tablet-android" class="mediaButton remoteControlButton"></paper-icon-button>',e+='<paper-icon-button icon="queue-music" class="mediaButton playlistButton"></paper-icon-button>',e+="</div>",e+="</div>"}function t(e){return D||(D=e.offsetHeight),D+"px"}function n(e){if(!e.classList.contains("hide")){var n=function(){e.classList.add("hide")};return!browserInfo.animate||browserInfo.mobile?void n():void requestAnimationFrame(function(){var a=[{height:t(e),offset:0},{height:"0",display:"none",offset:1}],i={duration:200,iterations:1,fill:"both",easing:"ease-out"};e.animate(a,i).onfinish=n})}}function a(e){e.classList.contains("hide")&&(e.classList.remove("hide"),browserInfo.animate&&!browserInfo.mobile&&requestAnimationFrame(function(){var n=[{height:"0",offset:0},{height:t(e),offset:1}],a={duration:200,iterations:1,fill:"both",easing:"ease-out"};e.animate(n,a)}))}function i(e){w=$(".nowPlayingBarCurrentTime",e),I=e.querySelector(".nowPlayingImage"),T=$(".nowPlayingBarText",e),k=$(".nowPlayingBarUserDataButtons",e),C=$(".unmuteButton",e).on("click",function(){B&&B.unMute()}),R=$(".muteButton",e).on("click",function(){B&&B.mute()}),$(".stopButton",e).on("click",function(){B&&B.stop()}),x=$(".pauseButton",e).on("click",function(){B&&B.pause()}),N=$(".unpauseButton",e).on("click",function(){B&&B.unpause()}),$(".nextTrackButton",e).on("click",function(){B&&B.nextTrack()}),$(".previousTrackButton",e).on("click",function(){B&&B.previousTrack()}),e.querySelector(".remoteControlButton").addEventListener("click",function(){o()}),e.querySelector(".playlistButton").addEventListener("click",function(){o("playlist")}),S=$(".toggleRepeatButton",e).on("click",function(){if(B){var e=A||{};switch((e.PlayState||{}).RepeatMode){case"RepeatAll":B.setRepeatMode("RepeatOne");break;case"RepeatOne":B.setRepeatMode("RepeatNone");break;default:B.setRepeatMode("RepeatAll")}}})[0],setTimeout(function(){M=$(".nowPlayingBarVolumeSlider",e).on("change",function(){B&&B.setVolume(this.value)})[0],L=$(".nowPlayingBarPositionSlider",e).on("change",function(){if(B&&A){var e=parseFloat(this.value),t=e/100*A.NowPlayingItem.RunTimeTicks;B.seek(Math.floor(t))}})[0],L._setPinValue=function(e){var t=A;if(!t||!t.NowPlayingItem||!t.NowPlayingItem.RunTimeTicks)return void(this.pinValue="--:--");var n=t.NowPlayingItem.RunTimeTicks;n/=100,n*=e,this.pinValue=Dashboard.getDisplayTime(n)}},300)}function o(e){e?$.mobile.changePage("nowplaying.html",{dataUrl:"nowplaying.html#"+e}):Dashboard.navigate("nowplaying.html")}function s(){return new Promise(function(t){return E?void t(E):void require(["css!css/nowplayingbar.css","paper-slider"],function(){return(E=document.querySelector(".nowPlayingBar"))?void t(E):(E=$(e()).appendTo(document.body)[0],!browserInfo.safari&&AppInfo.isNativeApp||!browserInfo.mobile||E.classList.add("noMediaProgress"),i(E),void t(E))})})}function r(e){e.removeClass("hide")}function l(e){e.addClass("hide")}function u(e,t){return t.NowPlayingItem?E?void c(e,t):void s().then(function(){c(e,t)}):void f()}function c(e,t){if(g(),"positionchange"==e.type){var n=(new Date).getTime();if(700>n-V)return;V=n}A=t;var a=MediaController.getPlayerInfo(),i=t.PlayState||{};i.IsPaused?(l(x),r(N)):(r(x),l(N)),p(t,a);var o=t.NowPlayingItem||{};if(L&&!L.dragging){if(o.RunTimeTicks){var s=i.PositionTicks/o.RunTimeTicks;s*=100,L.value=s}else L.value=0;L.disabled=!i.CanSeek}var u=Dashboard.getDisplayTime(i.PositionTicks);o.RunTimeTicks&&(u+=" / "+Dashboard.getDisplayTime(o.RunTimeTicks)),w.html(u),d(t)}function p(e,t){t=t||MediaController.getPlayerInfo();var n=e.PlayState||{},a=t.supportedCommands,i=!0,o=!0,s=!0;-1==a.indexOf("Mute")&&(i=!1),-1==a.indexOf("Unmute")&&(o=!1),n.IsMuted?i=!1:o=!1,-1==a.indexOf("SetRepeatMode")?S.classList.add("hide"):S.classList.remove("hide"),"RepeatAll"==n.RepeatMode?(S.icon="repeat",S.classList.add("repeatActive")):"RepeatOne"==n.RepeatMode?(S.icon="repeat-one",S.classList.add("repeatActive")):(S.icon="repeat",S.classList.remove("repeatActive")),-1==a.indexOf("SetVolume")&&(s=!1),t.isLocalPlayer&&AppInfo.hasPhysicalVolumeButtons&&(i=!1,o=!1,s=!1),i?r(R):l(R),o?r(C):l(C),M&&(s?M.classList.remove("hide"):M.classList.add("hide"),M.dragging||(M.value=n.VolumeLevel||0))}function d(e){var t=MediaController.getNowPlayingNameHtml(e.NowPlayingItem)||"";-1!=t.indexOf("<br/>")?T.addClass("nowPlayingDoubleText"):T.removeClass("nowPlayingDoubleText"),e.NowPlayingItem.Id&&(t='<a style="color:inherit;text-decoration:none;" href="'+LibraryBrowser.getHref(e.NowPlayingItem)+'">'+t+"</a>"),T.html(t);var n,a=80,i=e.NowPlayingItem;n=i.PrimaryImageTag?ApiClient.getScaledImageUrl(i.PrimaryImageItemId,{type:"Primary",height:a,tag:i.PrimaryImageTag}):i.BackdropImageTag?ApiClient.getScaledImageUrl(i.BackdropItemId,{type:"Backdrop",height:a,tag:i.BackdropImageTag,index:0}):i.ThumbImageTag?ApiClient.getScaledImageUrl(i.ThumbImageItemId,{type:"Thumb",height:a,tag:i.ThumbImageTag}):"TvChannel"==i.Type||"Recording"==i.Type?"css/images/items/detail/tv.png":"Audio"==i.MediaType?"css/images/items/detail/audio.png":"css/images/items/detail/video.png",n!=U&&(U=n,ImageLoader.lazyImage(I,n),i.Id?ApiClient.getItem(Dashboard.getCurrentUserId(),i.Id).then(function(e){k.html(LibraryBrowser.getUserDataIconsHtml(e,!1))}):k.html(""))}function m(e,t){var n=this;n.beginPlayerUpdates(),v.call(n,e,t)}function g(){s().then(a)}function f(){var e=document.getElementsByClassName("nowPlayingBar")[0];e&&n(e)}function y(e){var t=this;t.endPlayerUpdates(),f()}function v(e,t){var n=this;n.isDefaultPlayer&&t.NowPlayingItem&&"Video"==t.NowPlayingItem.MediaType||u(e,t)}function h(){B&&(Events.off(B,"playbackstart",m),Events.off(B,"playbackstop",y),Events.off(B,"volumechange",P),Events.off(B,"playstatechange",v),Events.off(B,"positionchange",v),B.endPlayerUpdates(),B=null,f())}function P(){var e=this;Promise.all([e.getPlayerState(),s()]).then(function(t){var n=t[0];e.isDefaultPlayer&&n.NowPlayingItem&&"Video"==n.NowPlayingItem.MediaType||p(n)})}function b(e){h(),B=e,e.getPlayerState().then(function(t){t.NowPlayingItem&&e.beginPlayerUpdates(),v.call(e,{type:"init"},t)}),Events.on(e,"playbackstart",m),Events.on(e,"playbackstop",y),Events.on(e,"volumechange",P),Events.on(e,"playstatechange",v),Events.on(e,"positionchange",v)}var B,w,I,T,k,C,R,M,N,x,L,S,A,D,E,U,V=0;Events.on(MediaController,"playerchange",function(){b(MediaController.getCurrentPlayer())}),b(MediaController.getCurrentPlayer())});