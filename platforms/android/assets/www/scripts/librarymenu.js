define(["imageLoader","paper-icon-button","paper-button","emby-icons"],function(e){function n(){var n="",a=browserInfo.safari?"chevron-left":"arrow-back";n+='<paper-icon-button icon="'+a+'" class="headerButton headerButtonLeft headerBackButton hide"></paper-icon-button>',AppInfo.enableNavDrawer&&(n+='<paper-icon-button icon="menu" class="headerButton mainDrawerButton barsMenuButton headerButtonLeft"></paper-icon-button>'),n+='<div class="libraryMenuButtonText headerButton">'+Globalize.translate("ButtonHome")+"</div>",n+='<div class="viewMenuSecondary">',n+='<span class="headerSelectedPlayer"></span>',n+='<paper-icon-button icon="cast" class="btnCast headerButton headerButtonRight hide"></paper-icon-button>',AppInfo.enableSearchInTopMenu&&(n+='<paper-icon-button icon="search" class="headerButton headerButtonRight headerSearchButton hide" onclick="Search.showSearchPanel();"></paper-icon-button>',n+='<div class="viewMenuSearch hide">',n+='<form class="viewMenuSearchForm">',n+='<input type="text" data-role="none" data-type="search" class="headerSearchInput" autocomplete="off" spellcheck="off" />',n+='<paper-icon-button icon="close" class="btnCloseSearch"></paper-icon-button>',n+="</form>",n+="</div>"),n+='<paper-icon-button icon="mic" class="headerButton headerButtonRight headerVoiceButton hide"></paper-icon-button>',n+='<paper-button class="headerButton headerButtonRight btnNotifications subdued" type="button" title="Notifications"><div class="btnNotificationsInner">0</div></paper-button>',n+='<paper-icon-button icon="person" class="headerButton headerButtonRight headerUserButton"></paper-icon-button>',browserInfo.mobile||Dashboard.isConnectMode()||(n+='<paper-icon-button icon="settings" class="headerButton headerButtonRight dashboardEntryHeaderButton" onclick="return LibraryMenu.onSettingsClicked(event);"></paper-icon-button>'),n+="</div>";var t=document.createElement("div");t.classList.add("viewMenuBar"),t.classList.add("ui-body-b"),t.innerHTML=n,document.body.appendChild(t),e.lazyChildren(document.querySelector(".viewMenuBar")),document.dispatchEvent(new CustomEvent("headercreated",{})),l()}function a(){Dashboard.exitOnBack()?Dashboard.exit():history.back()}function t(e){var n,a=document.querySelector(".viewMenuBar"),t=a.querySelector(".headerUserButton");if(e&&e.name&&e.imageUrl){var i=26,s=e.imageUrl;e.supportsImageParams&&(s+="&height="+i*Math.max(window.devicePixelRatio||1,2)),t&&(r(t,s,null),n=!0)}t&&!n&&r(t,null,"person"),e&&o(e.localUser),z=!1}function r(e,n,a){var t=e,e=document.createElement("paper-icon-button");e.className=t.className,e.addEventListener("click",c),n?(e.classList.add("headerUserButtonRound"),e.src=n):a?(e.classList.remove("headerUserButtonRound"),header.icon=a):e.classList.remove("headerUserButtonRound"),t.parentNode.replaceChild(e,t)}function o(e){var n=document.querySelector(".viewMenuBar"),a=n.querySelector(".headerSearchButton"),t=n.querySelector(".btnCast"),i=n.querySelector(".dashboardEntryHeaderButton");e?(t.classList.remove("hide"),a&&a.classList.remove("hide"),i&&(e.Policy.IsAdministrator?i.classList.remove("hide"):i.classList.add("hide")),require(["voice/voice"],function(e){e.isSupported()?n.querySelector(".headerVoiceButton").classList.remove("hide"):n.querySelector(".headerVoiceButton").classList.add("hide")})):(t.classList.add("hide"),n.querySelector(".headerVoiceButton").classList.add("hide"),a&&a.classList.add("hide"),i&&i.classList.add("hide"))}function s(){require(["voice/voice"],function(e){e.startListening()})}function c(e){Dashboard.showUserFlyout(e.target)}function l(){var e=document.querySelector(".mainDrawerButton");e&&e.addEventListener("click",u);var n=document.querySelector(".headerBackButton");n&&n.addEventListener("click",a);var t=document.querySelector(".headerVoiceButton");t&&t.addEventListener("click",s);var i=document.querySelector(".headerUserButton");i&&i.addEventListener("click",c);var r=document.querySelector(".viewMenuBar");A(r),r.querySelector(".btnNotifications").addEventListener("click",function(){Dashboard.navigate("notificationlist.html")})}function d(e,n){return LibraryBrowser.getHref(e,n)}function u(){var e=document.querySelector(".mainDrawerPanel");"drawer"==e.selected?m(e):v(e)}function v(e){e=e||document.querySelector(".mainDrawerPanel"),e.openDrawer(),U=(new Date).getTime()}function h(){browserInfo.mobile&&document.body.classList.add("bodyWithPopupOpen");var e=$($.mobile.activePage)[0];(N||x)&&ConnectionManager.user(window.ApiClient).then(function(n){var a=document.querySelector(".mainDrawerPanel .mainDrawer");N&&(p(a),y(n,a),L(n,a),g(n,a),document.dispatchEvent(new CustomEvent("libraryMenuCreated",{})),M(n.localUser)),(N||x)&&(f(e,n,a),x=!1),N=!1}),T(e),document.querySelector(".mainDrawerPanel #drawer").classList.add("verticalScrollingDrawer")}function m(e){e=e||document.querySelector(".mainDrawerPanel"),e.closeDrawer()}function b(e){var n=e.target;"drawer"!=n.selected?(document.body.classList.remove("bodyWithPopupOpen"),document.querySelector(".mainDrawerPanel #drawer").classList.remove("verticalScrollingDrawer")):h()}function p(e){if(!e.querySelector(".mainDrawerContent")){var n='<div class="mainDrawerContent">';n+='<div class="userheader">',n+="</div>",n+='<div class="libraryDrawerContent">',n+="</div>",n+='<div class="dashboardDrawerContent">',n+="</div>",n+='<div class="userFooter">',n+="</div>",n+="</div>",e.innerHTML=n}}function y(e,n){var a="",t=window.ApiClient?"home.html":"selectserver.html?showuser=1";a+='<div style="margin-top:5px;"></div>',a+='<a class="lnkMediaFolder sidebarLink" href="'+t+'" onclick="return LibraryMenu.onLinkClicked(event, this);">',a+="<div style=\"background-image:url('css/images/mblogoicon.png');width:28px;height:28px;background-size:contain;background-repeat:no-repeat;background-position:center center;border-radius:1000px;vertical-align:middle;margin:0 1.6em 0 1.5em;display:inline-block;\"></div>",a+=Globalize.translate("ButtonHome"),a+="</a>",a+='<a class="sidebarLink lnkMediaFolder" data-itemid="remote" href="nowplaying.html" onclick="return LibraryMenu.onLinkClicked(event, this);"><iron-icon icon="tablet-android" class="sidebarLinkIcon" style="color:#673AB7;"></iron-icon><span class="sidebarLinkText">'+Globalize.translate("ButtonRemote")+"</span></a>";var i=n.querySelector(".userheader");i.innerHTML=a,require(["imageLoader"],function(e){e.fillImages(i.getElementsByClassName("lazy"))})}function L(e,n){var a="";a+='<div class="sidebarDivider"></div>',a+='<div class="libraryMenuOptions">',a+="</div>",n.querySelector(".libraryDrawerContent").innerHTML=a}function f(e,n,a){var t="";t+='<div class="sidebarDivider"></div>',t+=Dashboard.getToolsMenuHtml(e),t=t.split("href=").join('onclick="return LibraryMenu.onLinkClicked(event, this);" href='),a.querySelector(".dashboardDrawerContent").innerHTML=t}function g(e,n){var a="";a+='<div class="adminMenuOptions">',a+='<div class="sidebarDivider"></div>',a+='<div class="sidebarHeader">',a+=Globalize.translate("HeaderAdmin"),a+="</div>",a+='<a class="sidebarLink lnkMediaFolder lnkManageServer" data-itemid="dashboard" href="#"><iron-icon icon="dashboard" class="sidebarLinkIcon"></iron-icon><span class="sidebarLinkText">'+Globalize.translate("ButtonManageServer")+"</span></a>",a+='<a class="sidebarLink lnkMediaFolder editorViewMenu" data-itemid="editor" onclick="return LibraryMenu.onLinkClicked(event, this);" href="edititemmetadata.html"><iron-icon icon="mode-edit" class="sidebarLinkIcon"></iron-icon><span class="sidebarLinkText">'+Globalize.translate("ButtonMetadataManager")+"</span></a>",browserInfo.mobile||(a+='<a class="sidebarLink lnkMediaFolder" data-itemid="reports" onclick="return LibraryMenu.onLinkClicked(event, this);" href="reports.html"><iron-icon icon="insert-chart" class="sidebarLinkIcon"></iron-icon><span class="sidebarLinkText">'+Globalize.translate("ButtonReports")+"</span></a>"),a+="</div>",a+='<div class="userMenuOptions">',a+='<div class="sidebarDivider"></div>',e.localUser&&AppInfo.isNativeApp&&browserInfo.android&&(a+='<a class="sidebarLink lnkMediaFolder lnkMySettings" onclick="return LibraryMenu.onLinkClicked(event, this);" href="mypreferencesmenu.html?userId='+e.localUser.Id+'"><iron-icon icon="settings" class="sidebarLinkIcon"></iron-icon><span class="sidebarLinkText">'+Globalize.translate("ButtonSettings")+"</span></a>"),a+='<a class="sidebarLink lnkMediaFolder lnkMySync" data-itemid="mysync" onclick="return LibraryMenu.onLinkClicked(event, this);" href="mysync.html"><iron-icon icon="sync" class="sidebarLinkIcon"></iron-icon><span class="sidebarLinkText">'+Globalize.translate("ButtonSync")+"</span></a>",Dashboard.isConnectMode()&&(a+='<a class="sidebarLink lnkMediaFolder" data-itemid="selectserver" onclick="return LibraryMenu.onLinkClicked(event, this);" href="selectserver.html?showuser=1"><iron-icon icon="wifi" class="sidebarLinkIcon"></iron-icon><span class="sidebarLinkText">'+Globalize.translate("ButtonSelectServer")+"</span></a>"),e.localUser&&(a+='<a class="sidebarLink lnkMediaFolder" data-itemid="logout" onclick="return LibraryMenu.onLogoutClicked(this);" href="#"><iron-icon icon="lock" class="sidebarLinkIcon"></iron-icon><span class="sidebarLinkText">'+Globalize.translate("ButtonSignOut")+"</span></a>"),a+="</div>",n.querySelector(".userFooter").innerHTML=a,n.querySelector(".lnkManageServer").addEventListener("click",B)}function k(){var e=this.getElementsByClassName("sectionName")[0],n=e?e.innerHTML:this.innerHTML;LibraryMenu.setTitle(n)}function w(e,n){return e.getUserViews({},n).then(function(e){for(var n=e.Items,a=[],t=0,i=n.length;i>t;t++){var r=n[t];if(a.push(r),"livetv"==r.CollectionType){r.ImageTags={},r.icon="live-tv",r.onclick="LibraryBrowser.showTab('livetv.html', 0);";var o=$.extend({},r);o.Name=Globalize.translate("ButtonGuide"),o.ImageTags={},o.icon="dvr",o.url="livetv.html?tab=1",o.onclick="LibraryBrowser.showTab('livetv.html', 1);",a.push(o);var s=$.extend({},r);s.Name=Globalize.translate("ButtonRecordedTv"),s.ImageTags={},s.icon="video-library",s.url="livetv.html?tab=3",s.onclick="LibraryBrowser.showTab('livetv.html', 3);",a.push(s)}}return a})}function M(e){if(!e)return $(".adminMenuOptions").addClass("hide"),$(".lnkMySync").addClass("hide"),void $(".userMenuOptions").addClass("hide");var n=Dashboard.getCurrentUserId(),a=window.ApiClient;w(a,n).then(function(e){var n=e,a="";a+='<div class="sidebarHeader">',a+=Globalize.translate("HeaderMedia"),a+="</div>",a+=n.map(function(e){var n="folder",a="inherit",t=e.Id;"channels"==e.CollectionType?t="channels":"livetv"==e.CollectionType&&(t="livetv"),"photos"==e.CollectionType?(n="photo-library",a="#009688"):"music"==e.CollectionType||"musicvideos"==e.CollectionType?(n="library-music",a="#FB8521"):"books"==e.CollectionType?(n="library-books",a="#1AA1E1"):"playlists"==e.CollectionType?(n="view-list",a="#795548"):"games"==e.CollectionType?(n="games",a="#F44336"):"movies"==e.CollectionType?(n="video-library",a="#CE5043"):"channels"==e.CollectionType||"Channel"==e.Type?(n="videocam",a="#E91E63"):"tvshows"==e.CollectionType?(n="tv",a="#4CAF50"):"livetv"==e.CollectionType&&(n="live-tv",a="#293AAE"),n=e.icon||n;var i=e.onclick?" function(){"+e.onclick+"}":"null";return'<a data-itemid="'+t+'" class="lnkMediaFolder sidebarLink" onclick="return LibraryMenu.onLinkClicked(event, this, '+i+');" href="'+d(e,e.CollectionType)+'"><iron-icon icon="'+n+'" class="sidebarLinkIcon" style="color:'+a+'"></iron-icon><span class="sectionName">'+e.Name+"</span></a>"}).join("");var t=document.querySelector(".libraryMenuOptions");t.innerHTML=a;var i=t;$(".sidebarLink",i).off("click",k).on("click",k)}),e.Policy.IsAdministrator?$(".adminMenuOptions").removeClass("hide"):$(".adminMenuOptions").addClass("hide"),e.Policy.EnableSync?$(".lnkMySync").removeClass("hide"):$(".lnkMySync").addClass("hide")}function B(){m(),Dashboard.navigate("dashboard.html")}function C(){return getParameterByName("topParentId")||null}function S(){var e=document,n=e.querySelector(".btnCast"),a=MediaController.getPlayerInfo();a.isLocalPlayer?(n.icon="cast",n.classList.remove("btnActiveCast"),e.querySelector(".headerSelectedPlayer").innerHTML=""):(n.icon="cast-connected",n.classList.add("btnActiveCast"),e.querySelector(".headerSelectedPlayer").innerHTML=a.deviceName||a.name)}function T(e){var n,a,t=e.classList.contains("liveTvPage"),i=e.classList.contains("channelsPage"),r=e.classList.contains("metadataEditorPage"),o=e.classList.contains("reportsPage"),s=e.classList.contains("mySyncPage"),c=t||i||r||o||s||e.classList.contains("allLibraryPage")?"":C()||"",l=document.getElementsByClassName("lnkMediaFolder");for(n=0,a=l.length;a>n;n++){var d=l[n],u=d.getAttribute("data-itemid");i&&"channels"==u?d.classList.add("selectedMediaFolder"):t&&"livetv"==u?d.classList.add("selectedMediaFolder"):r&&"editor"==u?d.classList.add("selectedMediaFolder"):o&&"reports"==u?d.classList.add("selectedMediaFolder"):s&&"mysync"==u?d.classList.add("selectedMediaFolder"):c&&u==c?d.classList.add("selectedMediaFolder"):d.classList.remove("selectedMediaFolder")}}function D(e){var n=e.querySelectorAll(".scopedLibraryViewNav a"),a=e.classList.contains("liveTvPage")||e.classList.contains("channelsPage")||e.classList.contains("metadataEditorPage")||e.classList.contains("reportsPage")||e.classList.contains("mySyncPage")||e.classList.contains("allLibraryPage")?"":C()||"";if(a)for(i=0,length=n.length;length>i;i++){var t=n[i],r=t.href;-1==r.indexOf("#")&&(r=replaceQueryString(r,"topParentId",a),t.href=r)}}function q(e,n){var a=n;"UserConfigurationUpdated"===a.MessageType&&a.Data.Id==Dashboard.getCurrentUserId()&&(G=!0)}function I(e){var n=document.querySelector(".viewMenuBar");e.classList.contains("standalonePage")?n.classList.add("hide"):n.classList.remove("hide"),z&&ConnectionManager.user(window.ApiClient).then(t)}function P(e){var n=e.getAttribute("data-title")||e.getAttribute("data-contextname");if(!n){var a=getParameterByName("titlekey");a&&(n=Globalize.translate(a))}n||e.classList.contains("type-interior")&&(n=Globalize.translate("ButtonHome")),n&&LibraryMenu.setTitle(n)}function E(e){var n=!e.classList.contains("homePage")&&history.length>0,a=document.querySelector(".headerBackButton"),t=AppInfo.enableBackButton;t||(t="true"==e.getAttribute("data-backbutton")),a&&(n&&t?a.classList.remove("hide"):a.classList.add("hide"))}function A(e){AppInfo.enableHeadRoom&&require(["headroom"],function(){var n=new Headroom(e,{tolerance:{down:40,up:0}});n.init(),e.classList.add("headroomEnabled")})}function H(e){G=!0,Events.off(e,"websocketmessage",q),Events.on(e,"websocketmessage",q)}function F(){var e=document.querySelector(".mainDrawerPanel #drawer");e&&e.classList.add("darkDrawer")}var N=!0,x=!0,z=!0,U=(new Date).getTime(),G=!1;window.LibraryMenu={getTopParentId:C,onLinkClicked:function(e,n,a){return 1!=e.which?!0:((new Date).getTime()-U>200&&setTimeout(function(){m();var e=browserInfo.mobile?350:200;setTimeout(function(){a?a():Dashboard.navigate(n.href)},e)},50),e.stopPropagation(),e.preventDefault(),!1)},onLogoutClicked:function(){if((new Date).getTime()-U>200){m();var e=browserInfo.mobile?350:200;setTimeout(function(){Dashboard.logout()},e)}return!1},onHardwareMenuButtonClick:function(){u()},onSettingsClicked:function(e){return 1!=e.which?!0:(Dashboard.navigate("dashboard.html"),!1)},setTitle:function(e){document.querySelector(".libraryMenuButtonText").innerHTML=e},setBackButtonVisible:function(e){var n=document.querySelector(".headerBackButton");n&&(e?n.classList.remove("hide"):n.classList.add("hide"))},setMenuButtonVisible:function(e){var n=document.querySelector(".mainDrawerButton");n&&n.classList.remove(!e&&browserInfo.mobile?"hide":"hide")},setTransparentMenu:function(e){var n=document.querySelector(".viewMenuBar");n&&(e?n.classList.add("semiTransparent"):n.classList.remove("semiTransparent"))}},pageClassOn("pageinit","page",function(){var e=this,n=e.classList.contains("libraryPage");if(n)for(var a=e.querySelectorAll(".libraryViewNav"),t=0,i=a.length;i>t;t++)A(a[t])}),pageClassOn("pagebeforeshow","page",function(){var e=this;e.classList.contains("type-interior")&&(x=!0),I(e),D(e)}),pageClassOn("pageshow","page",function(){var e=this;NavHelper.isBack()||window.scrollTo(0,0),P(e),E(e);var n=e.classList.contains("libraryPage");n?(document.body.classList.add("libraryDocument"),document.body.classList.remove("dashboardDocument"),document.body.classList.remove("hideMainDrawer")):e.classList.contains("type-interior")?(document.body.classList.remove("libraryDocument"),document.body.classList.add("dashboardDocument"),document.body.classList.remove("hideMainDrawer")):(document.body.classList.remove("libraryDocument"),document.body.classList.remove("dashboardDocument"),document.body.classList.add("hideMainDrawer"))}),window.ApiClient&&H(window.ApiClient);var O=document.querySelector(".mainDrawerPanel");O.addEventListener("iron-select",b),n(),Events.on(ConnectionManager,"apiclientcreated",function(e,n){H(n)}),Events.on(ConnectionManager,"localusersignedin",function(e,n){G=!0,N=!0,F(),ConnectionManager.user(ConnectionManager.getApiClient(n.ServerId)).then(t)}),Events.on(ConnectionManager,"localusersignedout",function(){G=!0,N=!0,t()}),Events.on(MediaController,"playerchange",function(){S()}),F()}),function(){function e(){return n}var n=!1;window.addEventListener("navigate",function(e){var a=e.detail.state||{},t=a.direction;n="back"==t}),window.NavHelper={isBack:e}}();