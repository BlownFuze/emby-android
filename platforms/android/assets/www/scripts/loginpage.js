define([],function(){function e(){Dashboard.alert({message:Globalize.translate("MessageUnableToConnectToServer"),title:Globalize.translate("HeaderConnectionFailure")})}function a(){var e=getParameterByName("serverid");return Promise.resolve(e?ConnectionManager.getOrCreateApiClient(e):ApiClient)}function t(e,a,t){e.querySelector(".manualLoginForm").classList.remove("hide"),e.querySelector(".visualLoginForm").classList.add("hide"),t?e.querySelector("#txtManualPassword").focus():e.querySelector("#txtManualName").focus(),a?e.querySelector(".btnCancel").classList.remove("hide"):e.querySelector(".btnCancel").classList.add("hide")}function r(e,a,t){for(var r="",n=0,i=t.length;i>n;n++){var o=t[n];r+='<div class="card squareCard bottomPaddedCard"><div class="cardBox visualCardBox">',r+='<div class="cardScalable">',r+='<div class="cardPadder"></div>',r+='<a class="cardContent" href="#" data-ajax="false" data-haspw="'+o.HasPassword+'" data-username="'+o.Name+'" data-userid="'+o.Id+'">';var d;if(o.PrimaryImageTag)d=a.getUserImageUrl(o.Id,{width:300,tag:o.PrimaryImageTag,type:"Primary"}),r+='<div class="cardImage" style="background-image:url(\''+d+"');\"></div>";else{var l=LibraryBrowser.getMetroColor(o.Id);d="css/images/logindefault.png",r+='<div class="cardImage" style="background-image:url(\''+d+"');background-color:"+l+';"></div>'}r+="</a>",r+="</div>",r+='<div class="cardFooter">',r+='<div class="cardText">'+o.Name+"</div>",r+='<div class="cardText">';var c=s.getLastSeenText(o.LastActivityDate);r+=""!=c?c:"&nbsp;",r+="</div>",r+="</div>",r+="</div>",r+="</div>"}e.querySelector("#divUsers").innerHTML=r}function n(e,a){for(;!e.classList||!e.classList.contains(a);)if(e=e.parentNode,!e)return null;return e}var s={showVisualForm:function(e){e.querySelector(".visualLoginForm").classList.remove("hide"),e.querySelector(".manualLoginForm").classList.add("hide")},getLastSeenText:function(e){return e?"Last seen "+humane_date(e):""},authenticateUserByName:function(a,t,r,n){Dashboard.showLoadingMsg(),t.authenticateUserByName(r,n).then(function(e){var a,r=e.User,n=getParameterByName("serverid");a=r.Policy.IsAdministrator&&!n?"dashboard.html":"home.html",Dashboard.hideLoadingMsg(),Dashboard.onServerChanged(r.Id,e.AccessToken,t),Dashboard.navigate(a)},function(t){a.querySelector("#txtManualName").value="",a.querySelector("#txtManualPassword").value="",Dashboard.hideLoadingMsg(),401==t.status?require(["toast"],function(e){e(Globalize.translate("MessageInvalidUser"))}):e()})}};return function(e){e.querySelector("#divUsers").addEventListener("click",function(r){var i=n(r.target,"cardContent");if(i){var o=e,d=i.getAttribute("data-userid"),l=i.getAttribute("data-username"),c=i.getAttribute("data-haspw");"manual"==d?t(o,!0):"false"==c?s.authenticateUserByName(o,a(),l,""):(o.querySelector("#txtManualName").value=l,o.querySelector("#txtManualPassword").value="",t(o,!0,!0))}}),e.querySelector(".manualLoginForm").addEventListener("submit",function(t){return a().then(function(a){s.authenticateUserByName(e,a,e.querySelector("#txtManualName").value,e.querySelector("#txtManualPassword").value)}),t.preventDefault(),!1}),e.querySelector(".btnForgotPassword").addEventListener("click",function(){Dashboard.navigate("forgotpassword.html")}),e.querySelector(".btnCancel").addEventListener("click",function(){s.showVisualForm(e)}),e.querySelector(".btnManual").addEventListener("click",function(){t(e,!0)}),e.addEventListener("viewshow",function(){Dashboard.showLoadingMsg(),a().then(function(a){a.getPublicUsers().then(function(n){n.length?(s.showVisualForm(e),r(e,a,n)):t(e,!1,!1),Dashboard.hideLoadingMsg()}),a.getJSON(a.getUrl("Branding/Configuration")).then(function(a){e.querySelector(".disclaimer").innerHTML=a.LoginDisclaimer||""})}),Dashboard.isConnectMode()?e.querySelector(".connectButtons").classList.remove("hide"):e.querySelector(".connectButtons").classList.add("hide")})}});