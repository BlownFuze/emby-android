define(["libraryBrowser","cardStyle"],function(){function e(){var e=getParameterByName("serverid");return e?ConnectionManager.getOrCreateApiClient(e):ApiClient}function a(){Dashboard.alert({message:Globalize.translate("MessageUnableToConnectToServer"),title:Globalize.translate("HeaderConnectionFailure")})}function t(e,a,t){e.querySelector(".manualLoginForm").classList.remove("hide"),e.querySelector(".visualLoginForm").classList.add("hide"),t?e.querySelector("#txtManualPassword").focus():e.querySelector("#txtManualName").focus(),a?e.querySelector(".btnCancel").classList.remove("hide"):e.querySelector(".btnCancel").classList.add("hide")}function r(){var e=Math.floor(Math.random()*(d.length-1));return d[e]}function n(e){if(e){for(var a=String(e.substr(0,1).charCodeAt()),t=0,n=0;n<a.length;n++)t+=parseInt(a.charAt(n));var s=String(t).substr(-1);return d[s]}return r()}function s(e,a,t){for(var r="",s=0,o=t.length;o>s;s++){var d=t[s];r+='<div class="card squareCard scalableCard"><div class="cardBox cardBox-bottompadded visualCardBox">',r+='<div class="cardScalable">',r+='<div class="cardPadder cardPadder-square"></div>',r+='<a class="cardContent" href="#" data-ajax="false" data-haspw="'+d.HasPassword+'" data-username="'+d.Name+'" data-userid="'+d.Id+'">';var l;if(d.PrimaryImageTag)l=a.getUserImageUrl(d.Id,{width:300,tag:d.PrimaryImageTag,type:"Primary"}),r+='<div class="cardImageContainer coveredImage noScale" style="background-image:url(\''+l+"');\"></div>";else{var c=n(d.Id);l="css/images/logindefault.png",r+='<div class="cardImageContainer coveredImage noScale" style="background-image:url(\''+l+"');background-color:"+c+';"></div>'}r+="</a>",r+="</div>",r+='<div class="cardFooter">',r+='<div class="cardText">'+d.Name+"</div>",r+='<div class="cardText cardText-secondary">';var u=i.getLastSeenText(d.LastActivityDate);r+=""!=u?u:"&nbsp;",r+="</div>",r+="</div>",r+="</div>",r+="</div>"}e.querySelector("#divUsers").innerHTML=r}function o(e,a){for(;!e.classList||!e.classList.contains(a);)if(e=e.parentNode,!e)return null;return e}var i={showVisualForm:function(e){e.querySelector(".visualLoginForm").classList.remove("hide"),e.querySelector(".manualLoginForm").classList.add("hide")},getLastSeenText:function(e){return e?"Last seen "+humane_date(e):""},authenticateUserByName:function(e,t,r,n){Dashboard.showLoadingMsg(),t.authenticateUserByName(r,n).then(function(e){var a,r=e.User,n=getParameterByName("serverid");a=r.Policy.IsAdministrator&&!n?"dashboard.html":"home.html",Dashboard.hideLoadingMsg(),Dashboard.onServerChanged(r.Id,e.AccessToken,t),Dashboard.navigate(a)},function(t){e.querySelector("#txtManualName").value="",e.querySelector("#txtManualPassword").value="",Dashboard.hideLoadingMsg(),401==t.status?require(["toast"],function(e){e(Globalize.translate("MessageInvalidUser"))}):a()})}},d=["#6FBD45","#4BB3DD","#4164A5","#E12026","#800080","#E1B222","#008040","#0094FF","#FF00C7","#FF870F","#7F0037"];return function(a){a.querySelector("#divUsers").addEventListener("click",function(r){var n=o(r.target,"cardContent");if(n){var s=a,d=n.getAttribute("data-userid"),l=n.getAttribute("data-username"),c=n.getAttribute("data-haspw");"manual"==d?(s.querySelector("#txtManualName").value="",t(s,!0)):"false"==c?i.authenticateUserByName(s,e(),l,""):(s.querySelector("#txtManualName").value=l,s.querySelector("#txtManualPassword").value="",t(s,!0,!0))}}),a.querySelector(".manualLoginForm").addEventListener("submit",function(t){var r=e();return i.authenticateUserByName(a,r,a.querySelector("#txtManualName").value,a.querySelector("#txtManualPassword").value),t.preventDefault(),!1}),a.querySelector(".btnForgotPassword").addEventListener("click",function(){Dashboard.navigate("forgotpassword.html")}),a.querySelector(".btnCancel").addEventListener("click",function(){i.showVisualForm(a)}),a.querySelector(".btnManual").addEventListener("click",function(){a.querySelector("#txtManualName").value="",t(a,!0)}),a.addEventListener("viewshow",function(){Dashboard.showLoadingMsg();var r=e();r.getPublicUsers().then(function(e){e.length?(i.showVisualForm(a),s(a,r,e)):(a.querySelector("#txtManualName").value="",t(a,!1,!1)),Dashboard.hideLoadingMsg()}),r.getJSON(r.getUrl("Branding/Configuration")).then(function(e){a.querySelector(".disclaimer").innerHTML=e.LoginDisclaimer||""}),Dashboard.isConnectMode()?a.querySelector(".connectButtons").classList.remove("hide"):a.querySelector(".connectButtons").classList.add("hide")})}});