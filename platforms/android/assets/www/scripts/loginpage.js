define(["jQuery"],function(a){function e(){var a=getParameterByName("serverid");return Promise.resolve(a?ConnectionManager.getOrCreateApiClient(a):ApiClient)}function t(){var t=a(this).parents(".page");return e().then(function(e){i.authenticateUserByName(t,e,a("#txtManualName",t).val(),a("#txtManualPassword",t).val())}),!1}function n(e,t,n){a(".visualLoginForm",e).hide(),a(".manualLoginForm",e).show(),n?a("#txtManualPassword input",e).focus():a("#txtManualName input",e).focus(),t?a(".btnCancel",e).show():a(".btnCancel",e).hide()}function r(e,t,r){for(var s="",o=0,d=r.length;d>o;o++){var c=r[o];s+='<div class="card squareCard bottomPaddedCard"><div class="cardBox visualCardBox">',s+='<div class="cardScalable">',s+='<div class="cardPadder"></div>',s+='<a class="cardContent" href="#" data-ajax="false" data-haspw="'+c.HasPassword+'" data-username="'+c.Name+'" data-userid="'+c.Id+'">';var l;if(c.PrimaryImageTag)l=t.getUserImageUrl(c.Id,{width:300,tag:c.PrimaryImageTag,type:"Primary"}),s+='<div class="cardImage" style="background-image:url(\''+l+"');\"></div>";else{var u=LibraryBrowser.getMetroColor(c.Id);l="css/images/logindefault.png",s+='<div class="cardImage" style="background-image:url(\''+l+"');background-color:"+u+';"></div>'}s+="</a>",s+="</div>",s+='<div class="cardFooter">',s+='<div class="cardText">'+c.Name+"</div>",s+='<div class="cardText">';var g=i.getLastSeenText(c.LastActivityDate);s+=""!=g?g:"&nbsp;",s+="</div>",s+="</div>",s+="</div>",s+="</div>"}var h=a("#divUsers",e).html(s);a("a",h).on("click",function(){var r=this.getAttribute("data-userid"),s=this.getAttribute("data-username"),o=this.getAttribute("data-haspw");"manual"==r?n(e,!0):"false"==o?i.authenticateUserByName(e,t,s,""):(a("#txtManualName",e).val(s),a("#txtManualPassword",e).val(""),n(e,!0,!0))})}var i={showVisualForm:function(e){a(".visualLoginForm",e).show(),a(".manualLoginForm",e).hide()},getLastSeenText:function(a){return a?"Last seen "+humane_date(a):""},authenticateUserByName:function(e,t,n,r){Dashboard.showLoadingMsg(),t.authenticateUserByName(n,r).then(function(a){var e,n=a.User,r=getParameterByName("serverid");e=n.Policy.IsAdministrator&&!r?"dashboard.html":"home.html",Dashboard.hideLoadingMsg(),Dashboard.onServerChanged(n.Id,a.AccessToken,t),Dashboard.navigate(e)},function(){a("#pw",e).val(""),a("#txtManualName",e).val(""),a("#txtManualPassword",e).val(""),Dashboard.hideLoadingMsg(),setTimeout(function(){require(["toast"],function(a){a(Globalize.translate("MessageInvalidUser"))})},300)})}};return function(s){a(".manualLoginForm",s).on("submit",t),s.querySelector(".btnForgotPassword").addEventListener("click",function(){Dashboard.navigate("forgotpassword.html")}),s.querySelector(".btnCancel").addEventListener("click",function(){i.showVisualForm(s)}),s.querySelector(".btnManual").addEventListener("click",function(){n(s,!0)}),s.addEventListener("viewshow",function(){Dashboard.showLoadingMsg(),e().then(function(e){e.getPublicUsers().then(function(a){var t=!a.length;t?t(s,!1,!1):(i.showVisualForm(s),r(s,e,a)),Dashboard.hideLoadingMsg()}),e.getJSON(e.getUrl("Branding/Configuration")).then(function(e){a(".disclaimer",s).html(e.LoginDisclaimer||"")})}),Dashboard.isConnectMode()?a(".connectButtons",s).show():a(".connectButtons",s).hide()})}});