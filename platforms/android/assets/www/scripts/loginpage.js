define(["jQuery"],function(a){function e(){var a=getParameterByName("serverid");return Promise.resolve(a?ConnectionManager.getOrCreateApiClient(a):ApiClient)}function t(){var t=a(this).parents(".page");return e().then(function(e){s.authenticateUserByName(t,e,a("#txtManualName",t).val(),a("#txtManualPassword",t).val())}),!1}function n(e,t,n){a(".visualLoginForm",e).hide(),a(".manualLoginForm",e).show(),n?a("#txtManualPassword",e).focus():a("#txtManualName",e).focus(),t?a(".btnCancel",e).show():a(".btnCancel",e).hide()}function r(e,t,r){for(var i="",o=0,d=r.length;d>o;o++){var c=r[o];i+='<div class="card squareCard bottomPaddedCard"><div class="cardBox visualCardBox">',i+='<div class="cardScalable">',i+='<div class="cardPadder"></div>',i+='<a class="cardContent" href="#" data-ajax="false" data-haspw="'+c.HasPassword+'" data-username="'+c.Name+'" data-userid="'+c.Id+'">';var l;if(c.PrimaryImageTag)l=t.getUserImageUrl(c.Id,{width:300,tag:c.PrimaryImageTag,type:"Primary"}),i+='<div class="cardImage" style="background-image:url(\''+l+"');\"></div>";else{var u=LibraryBrowser.getMetroColor(c.Id);l="css/images/logindefault.png",i+='<div class="cardImage" style="background-image:url(\''+l+"');background-color:"+u+';"></div>'}i+="</a>",i+="</div>",i+='<div class="cardFooter">',i+='<div class="cardText">'+c.Name+"</div>",i+='<div class="cardText">';var g=s.getLastSeenText(c.LastActivityDate);i+=""!=g?g:"&nbsp;",i+="</div>",i+="</div>",i+="</div>",i+="</div>"}var h=a("#divUsers",e).html(i);a("a",h).on("click",function(){var r=this.getAttribute("data-userid"),i=this.getAttribute("data-username"),o=this.getAttribute("data-haspw");"manual"==r?n(e,!0):"false"==o?s.authenticateUserByName(e,t,i,""):(a("#txtManualName",e).val(i),a("#txtManualPassword",e).val(""),n(e,!0,!0))})}var s={showVisualForm:function(e){a(".visualLoginForm",e).show(),a(".manualLoginForm",e).hide()},getLastSeenText:function(a){return a?"Last seen "+humane_date(a):""},authenticateUserByName:function(e,t,n,r){Dashboard.showLoadingMsg(),t.authenticateUserByName(n,r).then(function(a){var e,n=a.User,r=getParameterByName("serverid");e=n.Policy.IsAdministrator&&!r?"dashboard.html":"home.html",Dashboard.hideLoadingMsg(),Dashboard.onServerChanged(n.Id,a.AccessToken,t),Dashboard.navigate(e)},function(){a("#pw",e).val(""),a("#txtManualName",e).val(""),a("#txtManualPassword",e).val(""),Dashboard.hideLoadingMsg(),setTimeout(function(){require(["toast"],function(a){a(Globalize.translate("MessageInvalidUser"))})},300)})}};return function(i){a(".manualLoginForm",i).on("submit",t),i.querySelector(".btnForgotPassword").addEventListener("click",function(){Dashboard.navigate("forgotpassword.html")}),i.querySelector(".btnCancel").addEventListener("click",function(){s.showVisualForm(i)}),i.querySelector(".btnManual").addEventListener("click",function(){n(i,!0)}),i.addEventListener("viewshow",function(){Dashboard.showLoadingMsg(),e().then(function(e){e.getPublicUsers().then(function(a){a.length?(s.showVisualForm(i),r(i,e,a)):n(i,!1,!1),Dashboard.hideLoadingMsg()}),e.getJSON(e.getUrl("Branding/Configuration")).then(function(e){a(".disclaimer",i).html(e.LoginDisclaimer||"")})}),Dashboard.isConnectMode()?a(".connectButtons",i).show():a(".connectButtons",i).hide()})}});