var SupporterKeyPage={onPageShow:function(){SupporterKeyPage.load(this)},load:function(e){Dashboard.showLoadingMsg(),ApiClient.getPluginSecurityInfo().then(function(r){$("#txtSupporterKey",e).val(r.SupporterKey),r.SupporterKey&&!r.IsMBSupporter?(e.querySelector("#txtSupporterKey").classList.add("invalidEntry"),$(".notSupporter",e).show()):(e.querySelector("#txtSupporterKey").classList.remove("invalidEntry"),$(".notSupporter",e).hide()),Dashboard.hideLoadingMsg()})},updateSupporterKey:function(){Dashboard.showLoadingMsg();var e=this,r=$("#txtSupporterKey",e).val(),t={SupporterKey:r};return ApiClient.updatePluginSecurityInfo(t).then(function(){Dashboard.resetPluginSecurityInfo(),Dashboard.hideLoadingMsg(),Dashboard.alert(r?{message:Globalize.translate("MessageKeyUpdated"),title:Globalize.translate("HeaderConfirmation")}:{message:Globalize.translate("MessageKeyRemoved"),title:Globalize.translate("HeaderConfirmation")});var t=$(e).parents(".page")[0];SupporterKeyPage.load(t)}),!1},linkSupporterKeys:function(){Dashboard.showLoadingMsg();var e=this,r=$("#txtNewEmail",e).val(),t=$("#txtNewKey",e).val(),o=$("#txtOldKey",e).val(),a={email:r,newkey:t,oldkey:o},n="http://mb3admin.com/admin/service/supporter/linkKeys";return Logger.log(n),$.post(n,a).then(function(e){var r=JSON.parse(e);Dashboard.hideLoadingMsg(),Dashboard.alert(r.Success?Globalize.translate("MessageKeysLinked"):r.ErrorMessage),Logger.log(r)}),!1},retrieveSupporterKey:function(){Dashboard.showLoadingMsg();var e=this,r=$("#txtEmail",e).val(),t="http://mb3admin.com/admin/service/supporter/retrievekey?email="+r;return Logger.log(t),$.post(t).then(function(e){var t=JSON.parse(e);Dashboard.hideLoadingMsg(),Dashboard.alert(t.Success?Globalize.translate("MessageKeyEmailedTo").replace("{0}",r):t.ErrorMessage),Logger.log(t)}),!1}};$(document).on("pageshow","#supporterKeyPage",SupporterKeyPage.onPageShow),function(){function e(e){$(".popupAddUser",e).popup("open"),$("#selectUserToAdd",e).html(i.EligibleUsers.map(function(e){return'<option value="'+e.ConnectUserId+'">'+e.Name+"</option>"}).join(""))}function r(e,r){Dashboard.showLoadingMsg(),ApiClient.ajax({type:"POST",url:ApiClient.getUrl("Connect/Supporters",{Id:r})}).then(function(){$(".popupAddUser",e).popup("close"),n(e)})}function t(e,r){Dashboard.confirm(Globalize.translate("MessageConfirmRemoveConnectSupporter"),Globalize.translate("HeaderConfirmRemoveUser"),function(t){t&&(Dashboard.showLoadingMsg(),ApiClient.ajax({type:"DELETE",url:ApiClient.getUrl("Connect/Supporters",{Id:r})}).then(function(){n(e)}))})}function o(e){var r="";r+="<li>",r+='<a href="#">';var t=e.ImageUrl||"css/images/userflyoutdefault.png";return r+='<img src="'+t+'" />',r+="<h3>",r+=e.DisplayName||e.Name,r+="</h3>",r+="<p>",r+=e.Email,r+="</p>",r+="</a>",r+='<a href="#" data-icon="delete" class="btnRemoveUser" data-id="'+e.Id+'">',r+="</a>",r+="</li>"}function a(e,r){$(".linkSupporterKeyMessage",e).html(Globalize.translate("MessageLinkYourSupporterKey",r.MaxUsers));var a="";r.Users.length&&(a+='<ul data-role="listview" data-inset="true">',a+='<li data-role="list-divider">'+Globalize.translate("HeaderUsers"),a+=r.Users.map(o).join(""),a+="</ul>");var n=$(".supporters",e).html(a).trigger("create");$(".btnRemoveUser",n).on("click",function(){t(e,this.getAttribute("data-id"))})}function n(e){Dashboard.showLoadingMsg(),Dashboard.suppressAjaxErrors=!0,ApiClient.ajax({type:"GET",url:ApiClient.getUrl("Connect/Supporters"),dataType:"json"}).then(function(r){i=r,a(e,r),Dashboard.hideLoadingMsg(),Dashboard.suppressAjaxErrors=!1},function(){$(".supporters",e).html("<p>"+Globalize.translate("MessageErrorLoadingSupporterInfo")+"</p>"),Dashboard.suppressAjaxErrors=!1})}function s(e){ApiClient.getJSON(ApiClient.getUrl("System/SupporterInfo")).then(function(r){r.IsActiveSupporter?$(".supporterContainer",e).addClass("hide"):$(".supporterContainer",e).removeClass("hide")})}var i;$(document).on("pageinit","#supporterKeyPage",function(){var r=this;$("#btnAddConnectUser",r).on("click",function(){e(r)}),$("#supporterKeyForm").on("submit",SupporterKeyPage.updateSupporterKey),$("#lostKeyForm").on("submit",SupporterKeyPage.retrieveSupporterKey),$("#linkKeysForm").on("submit",SupporterKeyPage.linkSupporterKeys),$(".popupAddUserForm").on("submit",SupporterKeyPage.onAddConnectUserSubmit).on("submit",SupporterKeyPage.onAddConnectUserSubmit),$(".benefits",r).html(Globalize.translate("HeaderSupporterBenefit",'<a href="http://emby.media/premiere" target="_blank">',"</a>"))}).on("pageshow","#supporterKeyPage",function(){var e=this;n(e),s(e)}),window.SupporterKeyPage.onAddConnectUserSubmit=function(){var e=$(this).parents(".page"),t=$("#selectUserToAdd",e).val();return r(e,t),!1}}();