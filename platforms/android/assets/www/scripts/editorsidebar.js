define(["jQuery"],function(e){function t(e,t,i){var n=r(e),a={id:e.Id,text:n,state:{opened:e.IsFolder&&"open"==t,selected:i},li_attr:{}};return e.IsFolder?(a.children=[{text:"Loading...",icon:!1}],a.icon=!1):a.icon=!1,a.state.opened&&(a.li_attr.loadedFromServer=!0),i&&(I=e.Id),a}function r(e){var t=e.Name;e.Number&&(t=e.Number+" - "+t),null!=e.IndexNumber&&"Season"!=e.Type&&(t=e.IndexNumber+" - "+t);var r="editorNode";"Offline"==e.LocationType&&(r+=" offlineEditorNode");var i="<div class='"+r+"'>";if(e.LockData&&(i+='<img src="css/images/editor/lock.png" />'),i+=t,e.ImageTags&&e.ImageTags.Primary||(i+='<img src="css/images/editor/missingprimaryimage.png" title="'+Globalize.translate("MissingPrimaryImage")+'" />'),e.BackdropImageTags&&e.BackdropImageTags.length||"Episode"!==e.Type&&"Season"!==e.Type&&"Audio"!==e.MediaType&&"TvChannel"!==e.Type&&"MusicAlbum"!==e.Type&&(i+='<img src="css/images/editor/missingbackdrop.png" title="'+Globalize.translate("MissingBackdropImage")+'" />'),e.ImageTags&&e.ImageTags.Logo||("Movie"==e.Type||"Trailer"==e.Type||"Series"==e.Type||"MusicArtist"==e.Type||"BoxSet"==e.Type)&&(i+='<img src="css/images/editor/missinglogo.png" title="'+Globalize.translate("MissingLogoImage")+'" />'),"Episode"==e.Type&&"Virtual"==e.LocationType)try{e.PremiereDate&&(new Date).getTime()>=parseISO8601Date(e.PremiereDate,{toLocal:!0}).getTime()&&(i+='<img src="css/images/editor/missing.png" title="'+Globalize.translate("MissingEpisode")+'" />')}catch(n){}return i+="</div>"}function i(e,t,r){ApiClient.getLiveTvChannels({limit:0}).then(function(e){var i=[];i.push({id:"MediaFolders",text:Globalize.translate("HeaderMediaFolders"),state:{opened:!0},li_attr:{itemtype:"mediafolders",loadedFromServer:!0},icon:!1}),e.TotalRecordCount&&i.push({id:"livetv",text:Globalize.translate("HeaderLiveTV"),state:{opened:!1},li_attr:{itemtype:"livetv"},children:[{text:"Loading...",icon:!1}],icon:!1}),r.call(t,i),T.push("MediaFolders")})}function n(e,r,i){ApiClient.getLiveTvChannels({ServiceName:e,AddCurrentProgram:!1}).then(function(e){var n=e.Items.map(function(e){var i=-1==r.indexOf(e.Id)?"closed":"open";return t(e,i,!1)});i(n)})}function a(e,r,i,n){ApiClient.getJSON(ApiClient.getUrl("Library/MediaFolders")).then(function(e){var a=e.Items.map(function(e){var r=-1==i.indexOf(e.Id)?"closed":"open";return t(e,r,!1)});n.call(r,a);for(var o=0,d=a.length;d>o;o++)a[o].state.opened&&T.push(a[o].id)})}function o(e,r,o,d,s,l,c){var m=o.id;if("#"==m)return void i(e,r,c);if("livetv"==m)return void n(m,d,c);if("MediaFolders"==m)return void a(e,r,d,c);var u={ParentId:m,Fields:"Settings"},g=o.li_attr.itemtype;"Season"!=g&&"Series"!=g&&(u.SortBy="SortName"),ApiClient.getItems(Dashboard.getCurrentUserId(),u).then(function(e){var i=e.Items.map(function(e){var r=-1==d.indexOf(e.Id)?"closed":"open";return t(e,r,e.Id==s)});c.call(r,i);for(var n=0,a=i.length;a>n;n++)i[n].state.opened&&T.push(i[n].id)})}function d(t,r){var i=e("#"+r,t)[0];i&&i.scrollIntoView()}function s(e,t,r,i){require(["jstree"],function(){u(e,t,r,i)})}function l(t,r){var i=r.node,n={id:i.id,itemType:i.li_attr.itemtype};"livetv"!=n.itemType&&"mediafolders"!=n.itemType&&e(this).trigger("itemclicked",[n])}function c(t,r){var i=e(this).parents(".page")[0],n=r.node;n.children&&n.children&&g(i,n),n.li_attr&&"#"!=n.id&&!n.li_attr.loadedFromServer&&(n.li_attr.loadedFromServer=!0,e.jstree.reference(".libraryTree",i).load_node(n.id,f))}function m(t,r){var i=e(this).parents(".page")[0],n=r.node;n.children&&n.children&&g(i,n),n.li_attr&&"#"!=n.id&&!n.li_attr.loadedFromServer&&(n.li_attr.loadedFromServer=!0,e.jstree.reference(".libraryTree",i).load_node(n.id,f))}function u(t,r,i,n){T=[],I=null,e.jstree.destroy(),e(".libraryTree",t).jstree({plugins:["wholerow"],core:{check_callback:!0,data:function(e,a){o(t,this,e,i,n,r,a)},themes:{variant:"large"}}}).off("select_node.jstree",l).on("select_node.jstree",l).off("open_node.jstree",c).on("open_node.jstree",c).off("load_node.jstree",m).on("load_node.jstree",m)}function g(t,r){for(var i=r.children,n=0,a=i.length;a>n;n++){var o=i[n];-1!=T.indexOf(o)&&(T=T.filter(function(e){return e!=o}),e.jstree.reference(".libraryTree",t).load_node(o,f))}}function f(t){I&&t.children&&-1!=t.children.indexOf(I)&&setTimeout(function(){d(e.mobile.activePage,I)},500)}function p(t,i){var n=e("#"+i.Id+">a",t)[0];if(null!=n&&(e(".editorNode",n).remove(),e(n).append(r(i)),i.IsFolder)){var a=jQuery.jstree._reference(".libraryTree"),o=a._get_node(null,!1);a.refresh(o)}}function v(e){y=e}function h(){if(y)return y;var e=window.location.hash||window.location.href;return getParameterByName("id",e)}var I,T=[];e(document).on("itemsaved",".metadataEditorPage",function(e,t){p(this,t)}).on("pagebeforeshow",".metadataEditorPage",function(){require(["css!css/metadataeditor.css"])}).on("pagebeforeshow",".metadataEditorPage",function(){var e=this;Dashboard.getCurrentUser().then(function(t){var r=h();r?ApiClient.getAncestorItems(r,t.Id).then(function(i){var n=i.map(function(e){return e.Id});s(e,t,n,r)}):s(e,t,[])})}).on("pagebeforehide",".metadataEditorPage",function(){var t=this;e(".libraryTree",t).off("select_node.jstree",l).off("open_node.jstree",c).off("load_node.jstree",m)});var y;window.MetadataEditor={getItemPromise:function(){var e=h();return e?ApiClient.getItem(Dashboard.getCurrentUserId(),e):ApiClient.getRootFolder(Dashboard.getCurrentUserId())},getCurrentItemId:h,setCurrentItemId:v}});