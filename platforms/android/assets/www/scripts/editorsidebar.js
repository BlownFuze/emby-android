define(["jQuery"],function(e){function t(e,t,i){var n=r(e),o={id:e.Id,text:n,state:{opened:e.IsFolder&&"open"==t,selected:i},li_attr:{}};return e.IsFolder?(o.children=[{text:"Loading...",icon:!1}],o.icon=!1):o.icon=!1,o.state.opened&&(o.li_attr.loadedFromServer=!0),i&&(I=e.Id),o}function r(e){var t=e.Name;e.Number&&(t=e.Number+" - "+t),null!=e.IndexNumber&&"Season"!=e.Type&&(t=e.IndexNumber+" - "+t);var r="editorNode";"Offline"==e.LocationType&&(r+=" offlineEditorNode");var i="<div class='"+r+"'>";if(e.LockData&&(i+='<iron-icon icon="lock" style="height:18px"></iron-icon>'),i+=t,e.ImageTags&&e.ImageTags.Primary||(i+='<img src="css/images/editor/missingprimaryimage.png" title="'+Globalize.translate("MissingPrimaryImage")+'" />'),e.BackdropImageTags&&e.BackdropImageTags.length||"Episode"!==e.Type&&"Season"!==e.Type&&"Audio"!==e.MediaType&&"TvChannel"!==e.Type&&"MusicAlbum"!==e.Type&&(i+='<img src="css/images/editor/missingbackdrop.png" title="'+Globalize.translate("MissingBackdropImage")+'" />'),e.ImageTags&&e.ImageTags.Logo||("Movie"==e.Type||"Trailer"==e.Type||"Series"==e.Type||"MusicArtist"==e.Type||"BoxSet"==e.Type)&&(i+='<img src="css/images/editor/missinglogo.png" title="'+Globalize.translate("MissingLogoImage")+'" />'),"Episode"==e.Type&&"Virtual"==e.LocationType)try{e.PremiereDate&&(new Date).getTime()>=parseISO8601Date(e.PremiereDate,{toLocal:!0}).getTime()&&(i+='<img src="css/images/editor/missing.png" title="'+Globalize.translate("MissingEpisode")+'" />')}catch(n){}return i+="</div>"}function i(e,t,r){ApiClient.getLiveTvChannels({limit:0}).then(function(e){var i=[];i.push({id:"MediaFolders",text:Globalize.translate("HeaderMediaFolders"),state:{opened:!0},li_attr:{itemtype:"mediafolders",loadedFromServer:!0},icon:!1}),e.TotalRecordCount&&i.push({id:"livetv",text:Globalize.translate("HeaderLiveTV"),state:{opened:!1},li_attr:{itemtype:"livetv"},children:[{text:"Loading...",icon:!1}],icon:!1}),r.call(t,i),y.push("MediaFolders")})}function n(e,r,i){ApiClient.getLiveTvChannels({ServiceName:e,AddCurrentProgram:!1}).then(function(e){var n=e.Items.map(function(e){var i=-1==r.indexOf(e.Id)?"closed":"open";return t(e,i,!1)});i(n)})}function o(e,r,i,n){ApiClient.getJSON(ApiClient.getUrl("Library/MediaFolders")).then(function(e){var o=e.Items.map(function(e){var r=-1==i.indexOf(e.Id)?"closed":"open";return t(e,r,!1)});n.call(r,o);for(var a=0,d=o.length;d>a;a++)o[a].state.opened&&y.push(o[a].id)})}function a(e,r,a,d,s,l,c){var u=a.id;if("#"==u)return void i(e,r,c);if("livetv"==u)return void n(u,d,c);if("MediaFolders"==u)return void o(e,r,d,c);var m={ParentId:u,Fields:"Settings"},f=a.li_attr.itemtype;"Season"!=f&&"Series"!=f&&(m.SortBy="SortName"),ApiClient.getItems(Dashboard.getCurrentUserId(),m).then(function(e){var i=e.Items.map(function(e){var r=-1==d.indexOf(e.Id)?"closed":"open";return t(e,r,e.Id==s)});c.call(r,i);for(var n=0,o=i.length;o>n;n++)i[n].state.opened&&y.push(i[n].id)})}function d(t,r){var i=e("#"+r,t)[0];i&&i.scrollIntoView()}function s(e,t,r,i){require(["jstree"],function(){m(e,t,r,i)})}function l(t,r){var i=r.node,n={id:i.id,itemType:i.li_attr.itemtype};"livetv"!=n.itemType&&"mediafolders"!=n.itemType&&e(this).trigger("itemclicked",[n])}function c(t,r){var i=e(this).parents(".page")[0],n=r.node;n.children&&n.children&&f(i,n),n.li_attr&&"#"!=n.id&&!n.li_attr.loadedFromServer&&(n.li_attr.loadedFromServer=!0,e.jstree.reference(".libraryTree",i).load_node(n.id,g))}function u(t,r){var i=e(this).parents(".page")[0],n=r.node;n.children&&n.children&&f(i,n),n.li_attr&&"#"!=n.id&&!n.li_attr.loadedFromServer&&(n.li_attr.loadedFromServer=!0,e.jstree.reference(".libraryTree",i).load_node(n.id,g))}function m(t,r,i,n){y=[],I=null,e.jstree.destroy(),e(".libraryTree",t).jstree({plugins:["wholerow"],core:{check_callback:!0,data:function(e,o){a(t,this,e,i,n,r,o)},themes:{variant:"large"}}}).off("select_node.jstree",l).on("select_node.jstree",l).off("open_node.jstree",c).on("open_node.jstree",c).off("load_node.jstree",u).on("load_node.jstree",u)}function f(t,r){for(var i=r.children,n=0,o=i.length;o>n;n++){var a=i[n];-1!=y.indexOf(a)&&(y=y.filter(function(e){return e!=a}),e.jstree.reference(".libraryTree",t).load_node(a,g))}}function g(t){I&&t.children&&-1!=t.children.indexOf(I)&&setTimeout(function(){d(e.mobile.activePage,I)},500)}function p(t,i){var n=e("#"+i.Id+">a",t)[0];if(null!=n&&(e(".editorNode",n).remove(),e(n).append(r(i)),i.IsFolder)){var o=jQuery.jstree._reference(".libraryTree"),a=o._get_node(null,!1);o.refresh(a)}}function v(e){T=e}function h(){if(T)return T;var e=window.location.hash||window.location.href;return getParameterByName("id",e)}var I,y=[];e(document).on("itemsaved",".metadataEditorPage",function(e,t){p(this,t)}).on("pagebeforeshow",".metadataEditorPage",function(){require(["css!css/metadataeditor.css"])}).on("pagebeforeshow",".metadataEditorPage",function(){var e=this;Dashboard.getCurrentUser().then(function(t){var r=h();r?ApiClient.getAncestorItems(r,t.Id).then(function(i){var n=i.map(function(e){return e.Id});s(e,t,n,r)}):s(e,t,[])})}).on("pagebeforehide",".metadataEditorPage",function(){var t=this;e(".libraryTree",t).off("select_node.jstree",l).off("open_node.jstree",c).off("load_node.jstree",u)});var T;window.MetadataEditor={getItemPromise:function(){var e=h();return e?ApiClient.getItem(Dashboard.getCurrentUserId(),e):ApiClient.getRootFolder(Dashboard.getCurrentUserId())},getCurrentItemId:h,setCurrentItemId:v}});