define(["appSettings","userSettings"],function(e,t){function a(e,t){var a="";a+="<option value=''></option>";for(var r=0,n=t.length;n>r;r++){var o=t[r];a+="<option value='"+o.ThreeLetterISOLanguageName+"'>"+o.DisplayName+"</option>"}e.innerHTML=a}function r(r,n,o,i){i.then(function(e){a(r.querySelector("#selectAudioLanguage"),e),a(r.querySelector("#selectSubtitleLanguage"),e),r.querySelector("#selectAudioLanguage",r).value=n.Configuration.AudioLanguagePreference||"",r.querySelector("#selectSubtitleLanguage",r).value=n.Configuration.SubtitleLanguagePreference||"",r.querySelector(".chkEpisodeAutoPlay").checked=n.Configuration.EnableNextEpisodeAutoPlay||!1}),r.querySelector("#selectSubtitlePlaybackMode").value=n.Configuration.SubtitleMode||"",r.querySelector(".chkPlayDefaultAudioTrack").checked=n.Configuration.PlayDefaultAudioTrack||!1,r.querySelector(".chkEnableCinemaMode").checked=t.enableCinemaMode(),r.querySelector(".chkExternalVideoPlayer").checked=e.enableExternalPlayers(),require(["qualityoptions"],function(t){var a=t.getVideoQualityOptions(e.maxStreamingBitrate()).map(function(e){return'<option value="'+e.bitrate+'">'+e.name+"</option>"}).join("");a='<option value="">'+Globalize.translate("OptionAutomatic")+"</option>"+a,r.querySelector("#selectMaxBitrate").innerHTML=a,r.querySelector("#selectMaxChromecastBitrate").innerHTML=a,r.querySelector("#selectMaxBitrate").value=e.enableAutomaticBitrateDetection()?"":e.maxStreamingBitrate(),r.querySelector("#selectMaxChromecastBitrate").value=e.maxChromecastBitrate()||"",Dashboard.hideLoadingMsg()})}function n(e){Dashboard.showLoadingMsg();var t=getParameterByName("userId")||Dashboard.getCurrentUserId(),a=ApiClient.getUser(t),n=Dashboard.getCurrentUser(),o=ApiClient.getCultures();Promise.all([a,n]).then(function(t){r(e,t[1],t[0],o)}),ApiClient.getNamedConfiguration("cinemamode").then(function(t){t.EnableIntrosForMovies||t.EnableIntrosForEpisodes?e.querySelector(".cinemaModeOptions").classList.remove("hide"):e.querySelector(".cinemaModeOptions").classList.add("hide")})}function o(e,a){return a.Configuration.AudioLanguagePreference=e.querySelector("#selectAudioLanguage").value,a.Configuration.SubtitleLanguagePreference=e.querySelector("#selectSubtitleLanguage").value,a.Configuration.SubtitleMode=e.querySelector("#selectSubtitlePlaybackMode").value,a.Configuration.PlayDefaultAudioTrack=e.querySelector(".chkPlayDefaultAudioTrack").checked,a.Configuration.EnableNextEpisodeAutoPlay=e.querySelector(".chkEpisodeAutoPlay").checked,t.enableCinemaMode(e.querySelector(".chkEnableCinemaMode").checked),ApiClient.updateUserConfiguration(a.Id,a.Configuration)}function i(t){e.enableExternalPlayers(t.querySelector(".chkExternalVideoPlayer").checked),t.querySelector("#selectMaxBitrate").value?(e.maxStreamingBitrate(t.querySelector("#selectMaxBitrate").value),e.enableAutomaticBitrateDetection(!1)):e.enableAutomaticBitrateDetection(!0),e.maxChromecastBitrate(t.querySelector("#selectMaxChromecastBitrate").value);var a=getParameterByName("userId")||Dashboard.getCurrentUserId();AppInfo.enableAutoSave||Dashboard.showLoadingMsg(),ApiClient.getUser(a).then(function(e){o(t,e).then(function(){Dashboard.hideLoadingMsg(),AppInfo.enableAutoSave||require(["toast"],function(e){e(Globalize.translate("SettingsSaved"))})},function(){Dashboard.hideLoadingMsg()})})}return function(e){e.querySelector("#selectSubtitlePlaybackMode").addEventListener("change",function(){for(var t=e.querySelectorAll(".subtitlesHelp"),a=0,r=t.length;r>a;a++)t[a].classList.add("hide");e.querySelector(".subtitles"+this.value+"Help").classList.remove("hide")}),e.querySelector(".languagePreferencesForm").addEventListener("submit",function(t){return i(e),t.preventDefault(),!1}),AppInfo.enableAutoSave?e.querySelector(".btnSave").classList.add("hide"):e.querySelector(".btnSave").classList.remove("hide"),e.addEventListener("viewshow",function(){AppInfo.supportsExternalPlayers?e.querySelector(".fldExternalPlayer").classList.remove("hide"):e.querySelector(".fldExternalPlayer").classList.add("hide"),AppInfo.supportsExternalPlayerMenu?(e.querySelector(".labelNativeExternalPlayers").classList.remove("hide"),e.querySelector(".labelGenericExternalPlayers").classList.add("hide")):(e.querySelector(".labelGenericExternalPlayers").classList.remove("hide"),e.querySelector(".labelNativeExternalPlayers").classList.add("hide")),n(e)}),e.addEventListener("viewbeforehide",function(){var e=this;AppInfo.enableAutoSave&&i(e)})}});