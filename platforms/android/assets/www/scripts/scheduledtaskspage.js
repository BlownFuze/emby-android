!function(t,e){function a(t){ApiClient.getScheduledTasks({isHidden:!1}).then(function(e){n(t,e),Dashboard.hideLoadingMsg()})}function n(t,e){e=e.sort(function(t,e){return t=t.Category+" "+t.Name,e=e.Category+" "+e.Name,t==e?0:e>t?-1:1});for(var a,n="",s=0,o=e.length;o>s;s++){var l=e[s];l.Category!=a&&(a=l.Category,a&&(n+="</div>",n+="</div>"),n+='<div style="margin-bottom:2em;">',n+="<h1>",n+=a,n+="</h1>",n+='<div class="paperList">'),n+='<paper-icon-item class="scheduledTaskPaperIconItem" data-status="'+l.State+'">',n+="<a item-icon class='clearLink' href='scheduledtask.html?id="+l.Id+"'>",n+='<paper-fab mini icon="schedule"></paper-fab>',n+="</a>",n+="<paper-item-body two-line>",n+="<a class='clearLink' href='scheduledtask.html?id="+l.Id+"'>",n+="<div>"+l.Name+"</div>",n+="<div secondary id='taskProgress"+l.Id+"'>"+i(l)+"</div>",n+="</a>",n+="</paper-item-body>",n+="Idle"==l.State?'<paper-icon-button id="btnTask'+l.Id+'" icon="play-arrow" class="btnStartTask" data-taskid="'+l.Id+'" title="'+Globalize.translate("ButtonStart")+'"></paper-icon-button>':"Running"==l.State?'<paper-icon-button id="btnTask'+l.Id+'" icon="stop" class="btnStopTask" data-taskid="'+l.Id+'" title="'+Globalize.translate("ButtonStop")+'"></paper-icon-button>':'<paper-icon-button id="btnTask'+l.Id+'" icon="play-arrow" class="btnStartTask hide" data-taskid="'+l.Id+'" title="'+Globalize.translate("ButtonStart")+'"></paper-icon-button>',n+="</paper-icon-item>"}e.length&&(n+="</div>",n+="</div>");var r=t.querySelector(".divScheduledTasks");r.innerHTML=n}function s(t,e){var a=new Date(t),n=new Date(e),s=(n.getTime()-a.getTime())/1e3,i=Math.floor(s%31536e3/86400),o=Math.floor(s%31536e3%86400/3600),l=Math.floor(s%31536e3%86400%3600/60),r=Math.round(s%31536e3%86400%3600%60),d="";return d+=1==i?i+" day ":"",d+=i>1?i+" days ":"",d+=1==o?o+" hour ":"",d+=o>1?o+" hours ":"",d+=1==l?l+" minute ":"",d+=l>1?l+" minutes ":"",d+=d.length>0?"and ":"",d+=1==r?r+" second":"",d+=0==r||r>1?r+" seconds":""}function i(t){var e="";if("Idle"==t.State)t.LastExecutionResult&&(e+=Globalize.translate("LabelScheduledTaskLastRan").replace("{0}",humane_date(t.LastExecutionResult.EndTimeUtc)).replace("{1}",s(t.LastExecutionResult.StartTimeUtc,t.LastExecutionResult.EndTimeUtc)),"Failed"==t.LastExecutionResult.Status?e+=" <span style='color:#FF0000;'>"+Globalize.translate("LabelFailed")+"</span>":"Cancelled"==t.LastExecutionResult.Status?e+=" <span style='color:#0026FF;'>"+Globalize.translate("LabelCancelled")+"</span>":"Aborted"==t.LastExecutionResult.Status&&(e+=" <span style='color:#FF0000;'>"+Globalize.translate("LabelAbortedByServerShutdown")+"</span>"));else if("Running"==t.State){var a=(t.CurrentProgressPercentage||0).toFixed(1);e+='<paper-progress max="100" value="'+a+'" title="'+a+'%">',e+=""+a+"%",e+="</paper-progress>",e+="<span style='color:#009F00;margin-left:5px;'>"+a+"%</span>"}else e+="<span style='color:#FF0000;'>"+Globalize.translate("LabelStopping")+"</span>";return e}function o(e,a){if("ScheduledTasksInfo"==a.MessageType){var n=a.Data,s=t(t.mobile.activePage)[0];l(s,n)}}function l(t,e){for(var a=0,n=e.length;n>a;a++){var s=e[a];t.querySelector("#taskProgress"+s.Id).innerHTML=i(s);var o=t.querySelector("#btnTask"+s.Id);r(o,s.State)}}function r(e,a){"Idle"==a?(e.classList.add("btnStartTask"),e.classList.remove("btnStopTask"),e.classList.remove("hide"),e.icon="play-arrow",e.title=Globalize.translate("ButtonStart")):"Running"==a?(e.classList.remove("btnStartTask"),e.classList.add("btnStopTask"),e.classList.remove("hide"),e.icon="stop",e.title=Globalize.translate("ButtonStop")):(e.classList.add("btnStartTask"),e.classList.remove("btnStopTask"),e.classList.add("hide"),e.icon="play-arrow",e.title=Globalize.translate("ButtonStart"));var n=t(e).parents("paper-icon-item")[0];n.setAttribute("data-status",a)}function d(){var e=t(t.mobile.activePage)[0];u(),a(e)}function c(){var e=t(t.mobile.activePage)[0];ApiClient.isWebSocketOpen()||a(e)}function u(){ApiClient.isWebSocketOpen()&&ApiClient.sendWebSocketMessage("ScheduledTasksInfoStart","1000,1000"),b&&clearInterval(b),b=setInterval(c,5e3)}function p(){ApiClient.isWebSocketOpen()&&ApiClient.sendWebSocketMessage("ScheduledTasksInfoStop"),b&&clearInterval(b)}var b;t(e).on("pageinit","#scheduledTasksPage",function(){var e=this;t(".divScheduledTasks",e).on("click",".btnStartTask",function(){var t=this,n=t.getAttribute("data-taskid");ApiClient.startScheduledTask(n).then(function(){r(t,"Running"),a(e)})}).on("click",".btnStopTask",function(){var t=this,n=t.getAttribute("data-taskid");ApiClient.stopScheduledTask(n).then(function(){r(t,""),a(e)})})}).on("pageshow","#scheduledTasksPage",function(){var e=this;Dashboard.showLoadingMsg(),u(),a(e),t(ApiClient).on("websocketmessage",o).on("websocketopen",d)}).on("pagebeforehide","#scheduledTasksPage",function(){t(ApiClient).off("websocketmessage",o).off("websocketopen",d),p()})}(jQuery,document,window);