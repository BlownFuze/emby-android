define(["jQuery"],function(t){function e(t){ApiClient.getScheduledTasks({isHidden:!1}).then(function(e){a(t,e),Dashboard.hideLoadingMsg()})}function a(t,e){e=e.sort(function(t,e){return t=t.Category+" "+t.Name,e=e.Category+" "+e.Name,t==e?0:e>t?-1:1});for(var a,n="",s=0,o=e.length;o>s;s++){var r=e[s];r.Category!=a&&(a=r.Category,a&&(n+="</div>",n+="</div>"),n+='<div style="margin-bottom:2em;">',n+="<h1>",n+=a,n+="</h1>",n+='<div class="paperList">'),n+='<paper-icon-item class="scheduledTaskPaperIconItem" data-status="'+r.State+'">',n+="<a item-icon class='clearLink' href='scheduledtask.html?id="+r.Id+"'>",n+='<paper-fab mini icon="schedule"></paper-fab>',n+="</a>",n+="<paper-item-body two-line>",n+="<a class='clearLink' href='scheduledtask.html?id="+r.Id+"'>",n+="<div>"+r.Name+"</div>",n+="<div secondary id='taskProgress"+r.Id+"'>"+i(r)+"</div>",n+="</a>",n+="</paper-item-body>",n+="Idle"==r.State?'<button type="button" is="paper-icon-button-light" id="btnTask'+r.Id+'" class="btnStartTask" data-taskid="'+r.Id+'" title="'+Globalize.translate("ButtonStart")+'"><iron-icon icon="play-arrow"></iron-icon></button>':"Running"==r.State?'<button type="button" is="paper-icon-button-light" id="btnTask'+r.Id+'" class="btnStopTask" data-taskid="'+r.Id+'" title="'+Globalize.translate("ButtonStop")+'"><iron-icon icon="stop"></iron-icon></button>':'<button type="button" is="paper-icon-button-light" id="btnTask'+r.Id+'" class="btnStartTask hide" data-taskid="'+r.Id+'" title="'+Globalize.translate("ButtonStart")+'"><iron-icon icon="play-arrow"></iron-icon></button>',n+="</paper-icon-item>"}e.length&&(n+="</div>",n+="</div>");var l=t.querySelector(".divScheduledTasks");l.innerHTML=n}function n(t,e){var a=new Date(t),n=new Date(e),i=(n.getTime()-a.getTime())/1e3,s=Math.floor(i%31536e3/86400),o=Math.floor(i%31536e3%86400/3600),r=Math.floor(i%31536e3%86400%3600/60),l=Math.round(i%31536e3%86400%3600%60),c="";return c+=1==s?s+" day ":"",c+=s>1?s+" days ":"",c+=1==o?o+" hour ":"",c+=o>1?o+" hours ":"",c+=1==r?r+" minute ":"",c+=r>1?r+" minutes ":"",c+=c.length>0?"and ":"",c+=1==l?l+" second":"",c+=0==l||l>1?l+" seconds":""}function i(t){var e="";if("Idle"==t.State)t.LastExecutionResult&&(e+=Globalize.translate("LabelScheduledTaskLastRan").replace("{0}",humane_date(t.LastExecutionResult.EndTimeUtc)).replace("{1}",n(t.LastExecutionResult.StartTimeUtc,t.LastExecutionResult.EndTimeUtc)),"Failed"==t.LastExecutionResult.Status?e+=" <span style='color:#FF0000;'>("+Globalize.translate("LabelFailed")+")</span>":"Cancelled"==t.LastExecutionResult.Status?e+=" <span style='color:#0026FF;'>("+Globalize.translate("LabelCancelled")+")</span>":"Aborted"==t.LastExecutionResult.Status&&(e+=" <span style='color:#FF0000;'>"+Globalize.translate("LabelAbortedByServerShutdown")+"</span>"));else if("Running"==t.State){var a=(t.CurrentProgressPercentage||0).toFixed(1);e+='<paper-progress max="100" value="'+a+'" title="'+a+'%">',e+=""+a+"%",e+="</paper-progress>",e+="<span style='color:#009F00;margin-left:5px;'>"+a+"%</span>"}else e+="<span style='color:#FF0000;'>"+Globalize.translate("LabelStopping")+"</span>";return e}function s(e,a){if("ScheduledTasksInfo"==a.MessageType){var n=a.Data,i=t(t.mobile.activePage)[0];o(i,n)}}function o(t,e){for(var a=0,n=e.length;n>a;a++){var s=e[a];t.querySelector("#taskProgress"+s.Id).innerHTML=i(s);var o=t.querySelector("#btnTask"+s.Id);r(o,s.State)}}function r(e,a){"Idle"==a?(e.classList.add("btnStartTask"),e.classList.remove("btnStopTask"),e.classList.remove("hide"),e.querySelector("iron-icon").icon="play-arrow",e.title=Globalize.translate("ButtonStart")):"Running"==a?(e.classList.remove("btnStartTask"),e.classList.add("btnStopTask"),e.classList.remove("hide"),e.querySelector("iron-icon").icon="stop",e.title=Globalize.translate("ButtonStop")):(e.classList.add("btnStartTask"),e.classList.remove("btnStopTask"),e.classList.add("hide"),e.querySelector("iron-icon").icon="play-arrow",e.title=Globalize.translate("ButtonStart"));var n=t(e).parents("paper-icon-item")[0];n.setAttribute("data-status",a)}function l(){var a=t(t.mobile.activePage)[0];d(),e(a)}function c(){var a=t(t.mobile.activePage)[0];ApiClient.isWebSocketOpen()||e(a)}function d(){ApiClient.isWebSocketOpen()&&ApiClient.sendWebSocketMessage("ScheduledTasksInfoStart","1000,1000"),p&&clearInterval(p),p=setInterval(c,5e3)}function u(){ApiClient.isWebSocketOpen()&&ApiClient.sendWebSocketMessage("ScheduledTasksInfoStop"),p&&clearInterval(p)}var p;t(document).on("pageinit","#scheduledTasksPage",function(){var a=this;t(".divScheduledTasks",a).on("click",".btnStartTask",function(){var t=this,n=t.getAttribute("data-taskid");ApiClient.startScheduledTask(n).then(function(){r(t,"Running"),e(a)})}).on("click",".btnStopTask",function(){var t=this,n=t.getAttribute("data-taskid");ApiClient.stopScheduledTask(n).then(function(){r(t,""),e(a)})})}).on("pageshow","#scheduledTasksPage",function(){var t=this;Dashboard.showLoadingMsg(),d(),require(["paper-fab","paper-progress","paper-item-body","paper-icon-item"],function(){e(t)}),Events.on(ApiClient,"websocketmessage",s),Events.on(ApiClient,"websocketopen",l)}).on("pagebeforehide","#scheduledTasksPage",function(){Events.off(ApiClient,"websocketmessage",s),Events.off(ApiClient,"websocketopen",l),u()})});