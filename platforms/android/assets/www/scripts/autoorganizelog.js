define(["jQuery","datetime","paper-icon-button-light"],function(t,e){function a(t){var e=b.Items.filter(function(e){return e.Id==t})[0];Dashboard.alert({title:s(e,!1),message:e.StatusMessage})}function i(t,e){var a=b.Items.filter(function(t){return t.Id==e})[0],i=Globalize.translate("MessageFileWillBeDeleted")+"<br/><br/>"+a.OriginalPath+"<br/><br/>"+Globalize.translate("MessageSureYouWishToProceed");require(["confirm"],function(a){a(i,Globalize.translate("HeaderDeleteFile")).then(function(){Dashboard.showLoadingMsg(),ApiClient.deleteOriginalFileFromOrganizationResult(e).then(function(){Dashboard.hideLoadingMsg(),l(t)},c)})})}function n(t,e){r(t,e)}function r(t,e){require(["components/fileorganizer/fileorganizer"],function(a){a.show(e).then(function(){l(t)})})}function o(t,e){var a=b.Items.filter(function(t){return t.Id==e})[0];if(!a.TargetPath)return void("Episode"==a.Type&&n(t,a));var i=Globalize.translate("MessageFollowingFileWillBeMovedFrom")+"<br/><br/>"+a.OriginalPath+"<br/><br/>"+Globalize.translate("MessageDestinationTo")+"<br/><br/>"+a.TargetPath;a.DuplicatePaths.length&&(i+="<br/><br/>"+Globalize.translate("MessageDuplicatesWillBeDeleted"),i+="<br/><br/>"+a.DuplicatePaths.join("<br/>")),i+="<br/><br/>"+Globalize.translate("MessageSureYouWishToProceed"),require(["confirm"],function(a){a(i,Globalize.translate("HeaderOrganizeFile")).then(function(){Dashboard.showLoadingMsg(),ApiClient.performOrganization(e).then(function(){Dashboard.hideLoadingMsg(),l(t)},c)})})}function l(t){Dashboard.showLoadingMsg(),ApiClient.getFileOrganizationResults(h).then(function(e){b=e,u(t,e),Dashboard.hideLoadingMsg()},c)}function s(t,e){var a=t.Status,i=null;return"SkippedExisting"==a?a=Globalize.translate("StatusSkipped"):"Failure"==a&&(i="#cc0000",a=Globalize.translate("StatusFailed")),"Success"==a&&(i="green",a=Globalize.translate("StatusSuccess")),e?t.StatusMessage?'<a style="color:'+i+';" data-resultid="'+t.Id+'" href="#" class="btnShowStatusMessage">'+a+"</a>":'<span data-resultid="'+t.Id+'" style="color:'+i+';">'+a+"</span>":a}function u(n,r){var s=r.Items.map(function(t){var a="";a+="<tr>",a+="<td>";var i=e.parseISO8601Date(t.Date,!0);a+=i.toLocaleDateString(),a+="</td>",a+="<td>";var n=t.Status;return"SkippedExisting"==n?(a+='<a data-resultid="'+t.Id+'" style="color:blue;" href="#" class="btnShowStatusMessage">',a+=t.OriginalFileName,a+="</a>"):"Failure"==n?(a+='<a data-resultid="'+t.Id+'" style="color:red;" href="#" class="btnShowStatusMessage">',a+=t.OriginalFileName,a+="</a>"):(a+='<div style="color:green;">',a+=t.OriginalFileName,a+="</div>"),a+="</td>",a+="<td>",a+=t.TargetPath||"",a+="</td>",a+='<td class="organizerButtonCell">',"Success"!=t.Status&&(a+='<button type="button" is="paper-icon-button-light" data-resultid="'+t.Id+'" class="btnProcessResult organizerButton" title="'+Globalize.translate("ButtonOrganizeFile")+'"><iron-icon icon="folder"></iron-icon></button>',a+='<button type="button" is="paper-icon-button-light" data-resultid="'+t.Id+'" class="btnDeleteResult organizerButton" title="'+Globalize.translate("ButtonDeleteFile")+'"></iron-icon></button>'),a+="</td>",a+="</tr>"}).join(""),u=t(".resultBody",n).html(s).parents(".tblOrganizationResults").table("refresh").trigger("create");t(".btnShowStatusMessage",u).on("click",function(){var t=this.getAttribute("data-resultid");a(t)}),t(".btnProcessResult",u).on("click",function(){var t=this.getAttribute("data-resultid");o(n,t)}),t(".btnDeleteResult",u).on("click",function(){var t=this.getAttribute("data-resultid");i(n,t)});var g=LibraryBrowser.getQueryPagingHtml({startIndex:h.StartIndex,limit:h.Limit,totalRecordCount:r.TotalRecordCount,showLimit:!1,updatePageSizeSetting:!1});t(n)[0].querySelector(".listTopPaging").innerHTML=g,r.TotalRecordCount>h.Limit&&r.TotalRecordCount>50?t(".listBottomPaging",n).html(g).trigger("create"):t(".listBottomPaging",n).empty(),t(".btnNextPage",n).on("click",function(){h.StartIndex+=h.Limit,l(n)}),t(".btnPreviousPage",n).on("click",function(){h.StartIndex-=h.Limit,l(n)}),r.TotalRecordCount?t(".btnClearLog",n).show():t(".btnClearLog",n).hide()}function g(e,a){var i=t.mobile.activePage;("ScheduledTaskEnded"==a.MessageType&&"AutoOrganize"==a.Data.Key||"AutoOrganizeUpdate"==a.MessageType)&&l(i)}function c(t){Dashboard.hideLoadingMsg(),Dashboard.alert(0==t.status?{title:"Auto-Organize",message:"The operation is going to take a little longer. The view will be updated on completion."}:{title:Globalize.translate("AutoOrganizeError"),message:Globalize.translate("ErrorOrganizingFileWithErrorCode",t.headers.get("X-Application-Error-Code"))})}function d(){return[{href:"autoorganizelog.html",name:Globalize.translate("TabActivityLog")},{href:"autoorganizetv.html",name:Globalize.translate("TabTV")},{href:"autoorganizesmart.html",name:Globalize.translate("TabSmartMatches")}]}var b,h={StartIndex:0,Limit:50};t(document).on("pageinit","#libraryFileOrganizerLogPage",function(){var e=this;t(".btnClearLog",e).on("click",function(){ApiClient.clearOrganizationLog().then(function(){l(e)},c)})}).on("pageshow","#libraryFileOrganizerLogPage",function(){LibraryMenu.setTabs("autoorganize",0,d);var e=this;l(e),t(".btnOrganize",e).taskButton({mode:"on",progressElem:e.querySelector(".organizeProgress"),panel:t(".organizeTaskPanel",e),taskKey:"AutoOrganize"}),Events.on(ApiClient,"websocketmessage",g)}).on("pagebeforehide","#libraryFileOrganizerLogPage",function(){var e=this;b=null,t(".btnOrganize",e).taskButton({mode:"off"}),Events.off(ApiClient,"websocketmessage",g)})});