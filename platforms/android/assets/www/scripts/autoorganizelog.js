define(["jQuery"],function(e){function t(e){var t=c.Items.filter(function(t){return t.Id==e})[0];Dashboard.alert({title:l(t,!1),message:t.StatusMessage})}function a(e,t){var a=c.Items.filter(function(e){return e.Id==t})[0],i=Globalize.translate("MessageFileWillBeDeleted")+"<br/><br/>"+a.OriginalPath+"<br/><br/>"+Globalize.translate("MessageSureYouWishToProceed");require(["confirm"],function(a){a(i,Globalize.translate("HeaderDeleteFile")).then(function(){Dashboard.showLoadingMsg(),ApiClient.deleteOriginalFileFromOrganizationResult(t).then(function(){Dashboard.hideLoadingMsg(),o(e)},g)})})}function i(e,t){n(e,t)}function n(e,t){require(["components/fileorganizer/fileorganizer"],function(a){a.show(t).then(function(){o(e)})})}function r(e,t){var a=c.Items.filter(function(e){return e.Id==t})[0];if(!a.TargetPath)return void("Episode"==a.Type&&i(e,a));var n=Globalize.translate("MessageFollowingFileWillBeMovedFrom")+"<br/><br/>"+a.OriginalPath+"<br/><br/>"+Globalize.translate("MessageDestinationTo")+"<br/><br/>"+a.TargetPath;a.DuplicatePaths.length&&(n+="<br/><br/>"+Globalize.translate("MessageDuplicatesWillBeDeleted"),n+="<br/><br/>"+a.DuplicatePaths.join("<br/>")),n+="<br/><br/>"+Globalize.translate("MessageSureYouWishToProceed"),require(["confirm"],function(a){a(n,Globalize.translate("HeaderOrganizeFile")).then(function(){Dashboard.showLoadingMsg(),ApiClient.performOrganization(t).then(function(){Dashboard.hideLoadingMsg(),o(e)},g)})})}function o(e){Dashboard.showLoadingMsg(),ApiClient.getFileOrganizationResults(d).then(function(t){c=t,s(e,t),Dashboard.hideLoadingMsg()},g)}function l(e,t){var a=e.Status,i=null;return"SkippedExisting"==a?a=Globalize.translate("StatusSkipped"):"Failure"==a&&(i="#cc0000",a=Globalize.translate("StatusFailed")),"Success"==a&&(i="green",a=Globalize.translate("StatusSuccess")),t?e.StatusMessage?'<a style="color:'+i+';" data-resultid="'+e.Id+'" href="#" class="btnShowStatusMessage">'+a+"</a>":'<span data-resultid="'+e.Id+'" style="color:'+i+';">'+a+"</span>":a}function s(i,n){var l=n.Items.map(function(e){var t="";t+="<tr>",t+="<td>";var a=parseISO8601Date(e.Date,{toLocal:!0});t+=a.toLocaleDateString(),t+="</td>",t+="<td>";var i=e.Status;return"SkippedExisting"==i?(t+='<a data-resultid="'+e.Id+'" style="color:blue;" href="#" class="btnShowStatusMessage">',t+=e.OriginalFileName,t+="</a>"):"Failure"==i?(t+='<a data-resultid="'+e.Id+'" style="color:red;" href="#" class="btnShowStatusMessage">',t+=e.OriginalFileName,t+="</a>"):(t+='<div style="color:green;">',t+=e.OriginalFileName,t+="</div>"),t+="</td>",t+="<td>",t+=e.TargetPath||"",t+="</td>",t+='<td class="organizerButtonCell">',"Success"!=e.Status&&(t+='<paper-icon-button data-resultid="'+e.Id+'" icon="folder" class="btnProcessResult organizerButton" title="'+Globalize.translate("ButtonOrganizeFile")+'"></paper-icon-button>',t+='<paper-icon-button data-resultid="'+e.Id+'" icon="delete" class="btnDeleteResult organizerButton" title="'+Globalize.translate("ButtonDeleteFile")+'"></paper-icon-button>'),t+="</td>",t+="</tr>"}).join(""),s=e(".resultBody",i).html(l).parents(".tblOrganizationResults").table("refresh").trigger("create");e(".btnShowStatusMessage",s).on("click",function(){var e=this.getAttribute("data-resultid");t(e)}),e(".btnProcessResult",s).on("click",function(){var e=this.getAttribute("data-resultid");r(i,e)}),e(".btnDeleteResult",s).on("click",function(){var e=this.getAttribute("data-resultid");a(i,e)});var u=LibraryBrowser.getQueryPagingHtml({startIndex:d.StartIndex,limit:d.Limit,totalRecordCount:n.TotalRecordCount,showLimit:!1,updatePageSizeSetting:!1});e(i)[0].querySelector(".listTopPaging").innerHTML=u,n.TotalRecordCount>d.Limit&&n.TotalRecordCount>50?e(".listBottomPaging",i).html(u).trigger("create"):e(".listBottomPaging",i).empty(),e(".btnNextPage",i).on("click",function(){d.StartIndex+=d.Limit,o(i)}),e(".btnPreviousPage",i).on("click",function(){d.StartIndex-=d.Limit,o(i)}),n.TotalRecordCount?e(".btnClearLog",i).show():e(".btnClearLog",i).hide()}function u(t,a){var i=e.mobile.activePage;("ScheduledTaskEnded"==a.MessageType&&"AutoOrganize"==a.Data.Key||"AutoOrganizeUpdate"==a.MessageType)&&o(i)}function g(t){Dashboard.hideLoadingMsg();var a=e.mobile.activePage;e(".episodeCorrectionPopup",a).popup("close"),Dashboard.alert(0==t.status?{title:"Auto-Organize",message:"The operation is going to take a little longer. The view will be updated on completion."}:{title:Globalize.translate("AutoOrganizeError"),message:Globalize.translate("ErrorOrganizingFileWithErrorCode",t.getResponseHeader("X-Application-Error-Code"))})}var c,d={StartIndex:0,Limit:50};e(document).on("pageinit","#libraryFileOrganizerLogPage",function(){var t=this;e(".btnClearLog",t).on("click",function(){ApiClient.clearOrganizationLog().then(function(){o(t)},g)})}).on("pageshow","#libraryFileOrganizerLogPage",function(){var t=this;o(t),e(".btnOrganize",t).taskButton({mode:"on",progressElem:t.querySelector(".organizeProgress"),panel:e(".organizeTaskPanel",t),taskKey:"AutoOrganize"}),Events.on(ApiClient,"websocketmessage",u)}).on("pagebeforehide","#libraryFileOrganizerLogPage",function(){var t=this;c=null,e(".btnOrganize",t).taskButton({mode:"off"}),Events.off(ApiClient,"websocketmessage",u)})});