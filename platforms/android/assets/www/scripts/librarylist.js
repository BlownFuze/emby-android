define(["appSettings","appStorage","libraryBrowser","apphost","jQuery"],function(e,t,a,n,r){function i(e){var t=e.target;t.classList.contains("card")&&(Q&&(clearTimeout(Q),Q=null),t=t.querySelector(".cardOverlayTarget"),t&&o(t))}function o(e){return e.classList.contains("hide")?void 0:e.animate?void requestAnimationFrame(function(){var t=[{transform:"translateY(0)",offset:0},{transform:"translateY(100%)",offset:1}],a={duration:300,iterations:1,fill:"forwards",easing:"ease-out"};e.animate(t,a).onfinish=function(){e.classList.add("hide")}}):void e.classList.add("hide")}function s(e){e.classList.contains("hide")&&(e.classList.remove("hide"),e.animate&&requestAnimationFrame(function(){var t=[{transform:"translateY(100%)",offset:0},{transform:"translateY(0)",offset:1}],a={duration:300,iterations:1,fill:"forwards",easing:"ease-out"};e.animate(t,a)}))}function l(e,t,n,r){var i="";i+='<div class="cardOverlayInner">';var o=n.className.toLowerCase(),s=-1!=o.indexOf("mini"),l=s||-1!=o.indexOf("small"),c=-1!=o.indexOf("portrait"),d=(-1!=o.indexOf("square"),l||s||c?null:e.SeriesName),u=a.getPosterViewDisplayName(e,!0);i+='<div style="margin-bottom:1em;">';var m,f=l||s?20:26;d&&e.ParentLogoItemId?(m=ApiClient.getScaledImageUrl(e.ParentLogoItemId,{maxHeight:f,type:"logo",tag:e.ParentLogoImageTag}),i+='<img src="'+m+'" style="max-height:'+f+'px;max-width:100%;" />'):e.ImageTags.Logo?(m=ApiClient.getScaledImageUrl(e.Id,{maxHeight:f,type:"logo",tag:e.ImageTags.Logo}),i+='<img src="'+m+'" style="max-height:'+f+'px;max-width:100%;" />'):i+=d||u,i+="</div>",d?(i+="<p>",i+=u,i+="</p>"):l||s||(i+='<p class="itemMiscInfo" style="white-space:nowrap;">',i+=a.getMiscInfoHtml(e),i+="</p>"),s||(i+='<div style="margin:1em 0 .75em;">',c?(i+='<div class="itemCommunityRating">',i+=a.getRatingHtml(e,!1),i+="</div>",i+='<div class="userDataIcons" style="margin:.5em 0 0em;">',i+=a.getUserDataIconsHtml(e),i+="</div>"):(i+='<span class="itemCommunityRating" style="vertical-align:middle;">',i+=a.getRatingHtml(e,!1),i+="</span>",i+='<span class="userDataIcons" style="vertical-align:middle;">',i+=a.getUserDataIconsHtml(e),i+="</span>"),i+="</div>"),i+="<div>";var p=0;if(MediaController.canPlay(e)){var g=(e.UserData||{}).PlaybackPositionTicks||0;i+='<button is="paper-icon-button-light" class="btnPlayItem" data-itemid="'+e.Id+'" data-itemtype="'+e.Type+'" data-isfolder="'+e.IsFolder+'" data-mediatype="'+e.MediaType+'" data-resumeposition="'+g+'"><iron-icon icon="play-circle-outline"></iron-icon></button>',p++}return-1!=r.indexOf("trailer")&&(i+='<button is="paper-icon-button-light" class="btnPlayTrailer" data-itemid="'+e.Id+'"><iron-icon icon="videocam"></iron-icon></button>',p++),i+='<button is="paper-icon-button-light" class="btnMoreCommands"><iron-icon icon="'+AppInfo.moreIcon+'"></iron-icon></button>',p++,i+="</div>",i+="</div>"}function c(){var e=this.getAttribute("data-itemid");return ApiClient.getLocalTrailers(Dashboard.getCurrentUserId(),e).then(function(e){MediaController.play({items:e})}),!1}function d(){var e=this,t=e.getAttribute("data-itemid"),n=e.getAttribute("data-itemtype"),r="true"==e.getAttribute("data-isfolder"),i=e.getAttribute("data-mediatype"),o=parseInt(e.getAttribute("data-resumeposition"));return a.showPlayMenu(this,t,n,r,i,o),!1}function u(){var e=y(this,"card");return p(e,{showPlayOptions:!1}),!1}function m(e){var t=y(e.target,"card");if(t){var a=t.querySelector(".itemSelectionPanel");return a||p(t,{}),e.preventDefault(),!1}}function f(e,t){require(["confirm"],function(a){a(Globalize.translate("MessageConfirmRecordingCancellation"),Globalize.translate("HeaderConfirmRecordingCancellation")).then(function(){Dashboard.showLoadingMsg(),ApiClient.cancelLiveTvTimer(e).then(function(){require(["toast"],function(e){e(Globalize.translate("MessageRecordingCancelled"))}),Dashboard.hideLoadingMsg(),t.dispatchEvent(new CustomEvent("timercancelled",{}))})})})}function p(t,i){var o=t;t.classList.contains("card")||t.classList.contains("listItem")||(t=r(t).parents(".listItem,.card")[0]);var s=t.getAttribute("data-itemid"),l=t.getAttribute("data-playlistitemid"),c=t.getAttribute("data-commands").split(","),d=t.getAttribute("data-itemtype"),u=t.getAttribute("data-mediatype"),m=parseInt(t.getAttribute("data-positionticks")||"0"),p=t.getAttribute("data-playaccess"),g=t.getAttribute("data-locationtype"),h=t.getAttribute("data-index"),b=t.getAttribute("data-albumid"),v=t.getAttribute("data-artistid"),I=ApiClient.serverInfo().Id;Dashboard.getCurrentUser().then(function(C){var A=[];-1!=c.indexOf("addtocollection")&&A.push({name:Globalize.translate("ButtonAddToCollection"),id:"addtocollection",ironIcon:"add"}),-1!=c.indexOf("playlist")&&A.push({name:Globalize.translate("ButtonAddToPlaylist"),id:"playlist",ironIcon:"playlist-add"}),C.Policy.EnableContentDownloading&&n.supports("filedownload")&&u&&A.push({name:Globalize.translate("ButtonDownload"),id:"download",ironIcon:"file-download"}),-1!=c.indexOf("delete")&&A.push({name:Globalize.translate("ButtonDelete"),id:"delete",ironIcon:"delete"}),C.Policy.IsAdministrator&&(-1!=c.indexOf("edit")&&A.push({name:Globalize.translate("ButtonEdit"),id:"edit",ironIcon:"mode-edit"}),-1!=c.indexOf("editimages")&&A.push({name:Globalize.translate("ButtonEditImages"),id:"editimages",ironIcon:"photo"}),-1!=c.indexOf("editsubtitles")&&A.push({name:Globalize.translate("ButtonEditSubtitles"),id:"editsubtitles",ironIcon:"closed-caption"})),-1!=c.indexOf("instantmix")&&A.push({name:Globalize.translate("ButtonInstantMix"),id:"instantmix",ironIcon:"shuffle"}),"Timer"==d&&C.Policy.EnableLiveTvManagement&&A.push({name:Globalize.translate("ButtonCancel"),id:"canceltimer",ironIcon:"cancel"}),A.push({name:Globalize.translate("Timer"==d?"ButtonEdit":"ButtonOpen"),id:"open",ironIcon:"folder-open"}),i.showPlayOptions!==!1&&(MediaController.canPlayByAttributes(d,u,p,g)&&(A.push({name:Globalize.translate("ButtonPlay"),id:"play",ironIcon:"play-arrow"}),-1!=c.indexOf("playfromhere")&&A.push({name:Globalize.translate("ButtonPlayAllFromHere"),id:"playallfromhere",ironIcon:"play-arrow"})),"Video"==u&&AppInfo.supportsExternalPlayers&&e.enableExternalPlayers()&&A.push({name:Globalize.translate("ButtonPlayExternalPlayer"),id:"externalplayer",ironIcon:"airplay"}),m&&"Audio"!=u&&A.push({name:Globalize.translate("ButtonResume"),id:"resume",ironIcon:"play-arrow"}),-1!=c.indexOf("trailer")&&A.push({name:Globalize.translate("ButtonPlayTrailer"),id:"trailer",ironIcon:"play-arrow"})),MediaController.canQueueMediaType(u,d)&&(A.push({name:Globalize.translate("ButtonQueue"),id:"queue",ironIcon:"playlist-add"}),-1!=c.indexOf("queuefromhere")&&A.push({name:Globalize.translate("ButtonQueueAllFromHere"),id:"queueallfromhere",ironIcon:"playlist-add"})),-1!=c.indexOf("shuffle")&&A.push({name:Globalize.translate("ButtonShuffle"),id:"shuffle",ironIcon:"shuffle"}),-1!=c.indexOf("record")&&A.push({name:Globalize.translate("ButtonRecord"),id:"record",ironIcon:"videocam"}),-1!=c.indexOf("removefromcollection")&&A.push({name:Globalize.translate("ButtonRemoveFromCollection"),id:"removefromcollection",ironIcon:"remove"}),-1!=c.indexOf("removefromplaylist")&&A.push({name:Globalize.translate("ButtonRemoveFromPlaylist"),id:"removefromplaylist",ironIcon:"remove"}),C.Policy.EnablePublicSharing&&-1!=c.indexOf("share")&&A.push({name:Globalize.translate("ButtonShare"),id:"share",ironIcon:"share"}),-1!=c.indexOf("sync")&&A.push({name:Globalize.translate("ButtonSync"),id:"sync",ironIcon:"sync"}),b&&A.push({name:Globalize.translate("ButtonViewAlbum"),id:"album",ironIcon:"album"}),v&&A.push({name:Globalize.translate("ButtonViewArtist"),id:"artist",ironIcon:"person"});var P=t.getAttribute("data-href")||t.href;if(!P){var M=t.getElementsByTagName("a");M.length&&(P=M[0].href)}require(["actionsheet"],function(e){e.show({items:A,positionTo:o,callback:function(e){switch(e){case"addtocollection":require(["collectioneditor"],function(e){(new e).show([s])});break;case"playlist":require(["playlistManager"],function(e){e.showPanel([s])});break;case"delete":a.deleteItems([s]);break;case"download":require(["fileDownloader"],function(e){var t=ApiClient.getUrl("Items/"+s+"/Download",{api_key:ApiClient.accessToken()});e.download([{url:t,itemId:s,serverId:I}])});break;case"edit":a.editMetadata(s);break;case"refresh":ApiClient.refreshItem(s,{Recursive:!0,ImageRefreshMode:"FullRefresh",MetadataRefreshMode:"FullRefresh",ReplaceAllImages:!1,ReplaceAllMetadata:!0}),require(["toast"],function(e){e(Globalize.translate("MessageRefreshQueued"))});break;case"instantmix":MediaController.instantMix(s);break;case"shuffle":MediaController.shuffle(s);break;case"open":Dashboard.navigate(P);break;case"album":Dashboard.navigate("itemdetails.html?id="+b);break;case"record":require(["components/recordingcreator/recordingcreator"],function(e){e.show(s)});break;case"artist":Dashboard.navigate("itemdetails.html?context=music&id="+v);break;case"play":MediaController.play(s);break;case"playallfromhere":B(h,y(t,"itemsContainer"),"play");break;case"queue":MediaController.queue(s);break;case"trailer":ApiClient.getLocalTrailers(Dashboard.getCurrentUserId(),s).then(function(e){MediaController.play({items:e})});break;case"resume":MediaController.play({ids:[s],startPositionTicks:m});break;case"queueallfromhere":B(h,y(t,"itemsContainer"),"queue");break;case"sync":require(["syncDialog"],function(e){e.showMenu({items:[{Id:s}]})});break;case"editsubtitles":a.editSubtitles(s);break;case"editimages":a.editImages(s);break;case"externalplayer":a.playInExternalPlayer(s);break;case"canceltimer":f(s,r(t).parents(".itemsContainer")[0]);break;case"share":require(["sharingmanager"],function(e){e.showMenu({serverId:I,itemId:s})});break;case"removefromplaylist":r(t).parents(".itemsContainer").trigger("removefromplaylist",[l]);break;case"removefromcollection":r(t).parents(".collectionItems").trigger("removefromcollection",[s])}}})})})}function g(e,t){var n=e.target;n.classList.contains("card")||n.classList.contains("listItem")||(n=r(n).parents(".listItem,.card")[0]);var i=n.getAttribute("data-itemid"),o=n.getAttribute("data-itemtype"),s="true"==n.getAttribute("data-isfolder"),l=n.getAttribute("data-mediatype"),c=parseInt(n.getAttribute("data-positionticks"));return("MusicAlbum"==o||"MusicArtist"==o||"MusicGenre"==o||"Playlist"==o)&&(s=!0),"Program"==o&&(i=n.getAttribute("data-channelid")),a.showPlayMenu(t,i,o,s,l,c),e.preventDefault(),!1}function h(e){for(;null!=e;){var t=e.tagName||"";return"A"==t||-1!=t.indexOf("BUTTON")||-1!=t.indexOf("INPUT")?!0:!1}return!1}function b(e){var t=y(e.target,"cardOverlayPlayButton");if(t)return g(e,t);var a=y(e.target,"listviewMenuButton")||y(e.target,"cardOverlayMoreButton");if(a)return p(a,{}),e.preventDefault(),!1;var n=y(e.target,"btnUserItemRating");if(n)return e.stopPropagation(),e.preventDefault(),!1;var r=y(e.target,"card");if(r){var i=r.querySelector(".itemSelectionPanel");if(i)return k(e,i);if(r.classList.contains("groupedCard"))return v(e,r)}}function v(e,t){var n=t.getAttribute("data-itemid"),i=t.getAttribute("data-context"),o=Dashboard.getCurrentUserId(),s={Limit:parseInt(r(".playedIndicator",t).html()||"10"),Fields:"PrimaryImageAspectRatio,DateCreated",ParentId:n,GroupItems:!1},l=e.target;return h(l)?void 0:(ApiClient.getJSON(ApiClient.getUrl("Users/"+o+"/Items/Latest",s)).then(function(e){if(1==e.length)return void Dashboard.navigate(a.getHref(e[0],i));var t="itemdetails.html?id="+n;i&&(t+="&context="+i),Dashboard.navigate(t)}),e.stopPropagation(),e.preventDefault(),!1)}function y(e,t){for(;!e.classList||!e.classList.contains(t);)if(e=e.parentNode,!e)return null;return e}function I(e){if(e.classList.contains("itemsContainer"))return void C(e);for(var t=e.querySelectorAll(".itemsContainer"),a=0,n=t.length;n>a;a++)C(t[a])}function C(e){a.allowSwipe(e)&&(e.classList.contains("hasTapHold")||(require(["hammer"],function(t){var a=new t.Manager(e),n=new t.Press({time:500});a.add(n),e.classList.add("hasTapHold"),a.on("press",M)}),A(e)))}function A(e){var a=y(e,"page");if(a&&!(a.classList.contains("homePage")||a.classList.contains("itemDetailPage")||a.classList.contains("liveTvPage"))){var n="8";t.getItem("tapholdhelp")!=n&&(t.setItem("tapholdhelp",n),Dashboard.alert({message:Globalize.translate("TryMultiSelectMessage"),title:Globalize.translate("HeaderTryMultiSelect")}))}}function P(e){return e.preventDefault(),e.stopPropagation(),!1}function M(e){var t=y(e.target,"card");return t?(D(t),e.stopPropagation&&e.stopPropagation(),e.preventDefault(),!1):(e.preventDefault(),e.stopPropagation&&e.stopPropagation(),!1)}function k(e,t){if(!y(e.target,"chkItemSelect")){var a=t.querySelector(".chkItemSelect");if(a)if(a.classList.contains("checkedInitial"))a.classList.remove("checkedInitial");else{var n=!a.checked;a.checked=n,T(a,n)}}return e.preventDefault(),e.stopPropagation(),!1}function L(){T(this,this.checked)}function x(e,t){var a=e.querySelector(".itemSelectionPanel");if(!a){a=document.createElement("div"),a.classList.add("itemSelectionPanel"),e.querySelector(".cardContent").appendChild(a);var n="chkItemSelect";t&&!browserInfo.firefox&&(n+=" checkedInitial");var r=t?" checked":"";a.innerHTML='<paper-checkbox class="'+n+'"'+r+"></paper-checkbox>";var i=a.querySelector("paper-checkbox");i.addEventListener("change",L)}}function S(){var e=document.querySelector(".selectionCommandsPanel");if(!e){e=document.createElement("div"),e.classList.add("selectionCommandsPanel"),document.body.appendChild(e);var t="";t+='<div style="float:left;">',t+='<button is="paper-icon-button-light" class="btnCloseSelectionPanel"><iron-icon icon="close"></iron-icon></button>',t+='<span class="itemSelectionCount"></span>',t+="</div>",t+='<button is="paper-icon-button-light" class="btnSelectionPanelOptions" style="margin-left:auto;"><iron-icon icon="more-vert"></iron-icon></button>',e.innerHTML=t,e.querySelector(".btnCloseSelectionPanel").addEventListener("click",q);var a=e.querySelector(".btnSelectionPanelOptions");a.addEventListener("click",G),browserInfo.mobile||w(a,1)}}function w(e,t){var a=[{transform:"translate3d(0, 0, 0)",offset:0},{transform:"translate3d(-10px, 0, 0)",offset:.1},{transform:"translate3d(10px, 0, 0)",offset:.2},{transform:"translate3d(-10px, 0, 0)",offset:.3},{transform:"translate3d(10px, 0, 0)",offset:.4},{transform:"translate3d(-10px, 0, 0)",offset:.5},{transform:"translate3d(10px, 0, 0)",offset:.6},{transform:"translate3d(-10px, 0, 0)",offset:.7},{transform:"translate3d(10px, 0, 0)",offset:.8},{transform:"translate3d(-10px, 0, 0)",offset:.9},{transform:"translate3d(0, 0, 0)",offset:1}],n={duration:900,iterations:t};e.animate&&e.animate(a,n)}function D(e){require(["paper-checkbox"],function(){for(var t=document.querySelectorAll(".card"),a=0,n=t.length;n>a;a++)x(t[a],e==t[a]);S(),T(e,!0)})}function q(){var e=document.querySelector(".selectionCommandsPanel");if(e){e.parentNode.removeChild(e),j=[];for(var t=document.querySelectorAll(".itemSelectionPanel"),a=0,n=t.length;n>a;a++)t[a].parentNode.removeChild(t[a])}}function T(e,t){var a=y(e,"card").getAttribute("data-itemid");if(t){var n=j.filter(function(e){return e==a});n.length||j.push(a)}else j=j.filter(function(e){return e!=a});if(j.length){var r=document.querySelector(".itemSelectionCount");r&&(r.innerHTML=j.length)}else q()}function G(e){Dashboard.getCurrentUser().then(function(t){var i=[];i.push({name:Globalize.translate("ButtonAddToCollection"),id:"addtocollection",ironIcon:"add"}),i.push({name:Globalize.translate("ButtonAddToPlaylist"),id:"playlist",ironIcon:"playlist-add"}),t.Policy.EnableContentDeletion&&i.push({name:Globalize.translate("ButtonDelete"),id:"delete",ironIcon:"delete"}),t.Policy.EnableContentDownloading&&n.supports("filedownload"),i.push({name:Globalize.translate("HeaderGroupVersions"),id:"groupvideos",ironIcon:"call-merge"}),i.push({name:Globalize.translate("MarkPlayed"),id:"markplayed"}),i.push({name:Globalize.translate("MarkUnplayed"),id:"markunplayed"}),i.push({name:Globalize.translate("ButtonRefresh"),id:"refresh",ironIcon:"refresh"}),i.push({name:Globalize.translate("ButtonSync"),id:"sync",ironIcon:"sync"}),require(["actionsheet"],function(t){t.show({items:i,positionTo:e.target,callback:function(e){var t=j.slice(0);switch(e){case"addtocollection":require(["collectioneditor"],function(e){(new e).show(t)}),q();break;case"playlist":require(["playlistManager"],function(e){e.showPanel(t),q()});break;case"delete":a.deleteItems(t).then(function(){Dashboard.navigate("home.html")}),q();break;case"groupvideos":E(r.mobile.activePage,t);break;case"markplayed":t.forEach(function(e){ApiClient.markPlayed(Dashboard.getCurrentUserId(),e)}),q();break;case"markunplayed":t.forEach(function(e){ApiClient.markUnplayed(Dashboard.getCurrentUserId(),e)}),q();break;case"refresh":t.map(function(e){ApiClient.refreshItem(e,{Recursive:!0,ImageRefreshMode:"FullRefresh",MetadataRefreshMode:"FullRefresh",ReplaceAllImages:!1,ReplaceAllMetadata:!0})}),require(["toast"],function(e){e(Globalize.translate("MessageRefreshQueued"))}),q();break;case"sync":require(["syncDialog"],function(e){e.showMenu({items:t.map(function(e){return{Id:e}})})}),q()}}})})})}function E(e,t){if(t.length<2)return void Dashboard.alert({message:Globalize.translate("MessagePleaseSelectTwoItems"),title:Globalize.translate("HeaderError")});var a=Globalize.translate("MessageTheSelectedItemsWillBeGrouped");require(["confirm"],function(n){n(a,Globalize.translate("HeaderGroupVersions")).then(function(){Dashboard.showLoadingMsg(),ApiClient.ajax({type:"POST",url:ApiClient.getUrl("Videos/MergeVersions",{Ids:t.join(",")})}).then(function(){Dashboard.hideLoadingMsg(),q(),r(".itemsContainer",e).trigger("needsrefresh")})})})}function z(e){var t=y(e.target,"itemWithAction");if(t){var a=t.getAttribute("data-action"),n=t;if(a)for(;!n.getAttribute("data-itemid");)n=n.parentNode;var r,i,o=n.getAttribute("data-itemid");return"play"==a?MediaController.play(o):"playallfromhere"==a?(r=n.getAttribute("data-index"),i=y(t,"itemsContainer"),B(r,i,"play")):"instantmix"==a&&MediaController.instantMix(o),e.stopPropagation(),e.preventDefault(),!1}}function B(e,t,a){var n=r(".mediaItem",t).get().map(function(e){for(var t=e,a=t.getAttribute("data-itemid");!a;)t=t.parentNode,a=t.getAttribute("data-itemid");return a});n=n.slice(e),ApiClient.getItems(Dashboard.getCurrentUserId(),{Ids:n.join(","),Fields:"MediaSources,Chapters",Limit:100}).then(function(e){MediaController[a]({items:e.Items})})}function O(e){var t=window.ApiClient;t&&t.getCurrentUserId()&&Dashboard.getCurrentUser().then(function(t){var n={SupportsSync:!0};a.enableSync(n,t)?r(".categorySyncButton",e).removeClass("hide"):r(".categorySyncButton",e).addClass("hide")})}function U(e,t){var a=t.getAttribute("data-category"),n=LibraryMenu.getTopParentId();require(["syncDialog"],function(e){e.showMenu({ParentId:n,Category:a})})}function R(e,t){if(t.Played){var n=e.querySelector(".playedIndicator");n||(n=document.createElement("div"),n.classList.add("playedIndicator"),e.querySelector(".cardContent").appendChild(n)),n.innerHTML='<iron-icon icon="check"></iron-icon>'}else if(t.UnplayedItemCount){var n=e.querySelector(".playedIndicator");n||(n=document.createElement("div"),n.classList.add("playedIndicator"),e.querySelector(".cardContent").appendChild(n)),n.innerHTML=t.UnplayedItemCount}var i=a.getItemProgressBarHtml(t);if(i){var o=e.querySelector(".cardProgress");o||(o=document.createElement("div"),o.classList.add("cardProgress"),r(".cardFooter",e).append(o)),o.innerHTML=i}else r(".cardProgress",e).remove()}function H(e){r(document.querySelectorAll("*[data-itemid='"+e.ItemId+"']")).each(function(){var t=this.getAttribute("data-mediatype");"Video"==t&&(this.setAttribute("data-positionticks",e.PlaybackPositionTicks||0),this.classList.contains("card")&&R(this,e))})}function N(e,t){var a=t;if("UserDataChanged"===a.MessageType&&a.Data.UserId==Dashboard.getCurrentUserId())for(var n=0,r=a.Data.UserDataList.length;r>n;n++)H(a.Data.UserDataList[n])}function F(e){Events.off(e,"websocketmessage",N),Events.on(e,"websocketmessage",N)}function V(){r(".hasrefreshtime").removeClass("hasrefreshtime").removeAttr("data-lastrefresh")}var Q;a.createCardMenus=function(e){function t(e){if(e=e.querySelector("a"),!e.querySelector(".itemSelectionPanel")){var t=e.querySelector(".cardOverlayTarget");t||(t=document.createElement("div"),t.classList.add("hide"),t.classList.add("cardOverlayTarget"),y(e,"cardContent").appendChild(t));for(var a=e;a&&!a.getAttribute("data-itemid");)a=a.parentNode;var n=a.getAttribute("data-itemid"),i=a.getAttribute("data-commands").split(","),o=ApiClient.getItem(Dashboard.getCurrentUserId(),n),m=Dashboard.getCurrentUser();Promise.all([o,m]).then(function(a){for(var n=a[0],o=a[1],s=e;!s.classList.contains("card");)s=s.parentNode;t.innerHTML=l(n,o,s,i),r(".btnPlayItem",t).on("click",d),r(".btnPlayTrailer",t).on("click",c),r(".btnMoreCommands",t).on("click",u)}),r(t).show(),s(t)}}function a(e){var a=e.target;if(a.classList.contains("cardImage")){if(o===!0)return void(o=!1);for(Q&&(clearTimeout(Q),Q=null);!a.classList.contains("card");)a=a.parentNode;Q=setTimeout(function(){t(a)},1200)}}function n(){o=!0}var o=!1;e.removeEventListener("click",b),e.addEventListener("click",b),AppInfo.isTouchPreferred?(e.removeEventListener("contextmenu",P),e.addEventListener("contextmenu",P)):(e.removeEventListener("contextmenu",m),e.addEventListener("contextmenu",m),e.removeEventListener("mouseenter",a),e.addEventListener("mouseenter",a,!0),e.removeEventListener("mouseleave",i),e.addEventListener("mouseleave",i,!0),e.removeEventListener("touchstart",n),e.addEventListener("touchstart",n)),I(e)},r.fn.createCardMenus=function(e){for(var t=0,n=this.length;n>t;t++){var r=this[t];a.createCardMenus(r,e)}return this};var j=[];pageClassOn("pageinit","libraryPage",function(){var e=this;e.addEventListener("click",z);for(var t=e.querySelectorAll(".itemsContainer:not(.noautoinit)"),n=0,i=t.length;i>n;n++)a.createCardMenus(t[n]);r(".categorySyncButton",e).on("click",function(){U(e,this)})}),pageClassOn("pageshow","libraryPage",function(){var e=this;Dashboard.isServerlessPage()||O(e)}),pageClassOn("pagebeforehide","libraryPage",function(){q()}),window.ApiClient&&F(window.ApiClient),Events.on(ConnectionManager,"apiclientcreated",function(e,t){F(t)}),Events.on(ConnectionManager,"localusersignedin",V),Events.on(ConnectionManager,"localusersignedout",V)});