define(["appStorage","jQuery"],function(e,r){function t(){var e=a(),r=d[e];return r||(r=d[e]={query:{Fields:"PrimaryImageAspectRatio,SyncInfo",EnableImageTypes:"Primary,Backdrop,Banner,Thumb",StartIndex:0,Limit:200},view:LibraryBrowser.getSavedView(e)||LibraryBrowser.getDefaultItemsView("List","List")},r.query.ParentId=LibraryMenu.getTopParentId(),LibraryBrowser.loadSavedQueryValues(e,r.query)),r}function i(){return t().query}function a(){return LibraryBrowser.getSavedQueryKey()}function n(e,a){Dashboard.showLoadingMsg();var l=i();l.UserId=Dashboard.getCurrentUserId(),ApiClient.getJSON(ApiClient.getUrl("Playlists/"+a.Id+"/Items",l)).then(function(i){window.scrollTo(0,0);var d="";d+=LibraryBrowser.getQueryPagingHtml({startIndex:l.StartIndex,limit:l.Limit,totalRecordCount:i.TotalRecordCount,showLimit:!1,updatePageSizeSetting:!1});var u=t().view;"List"==u&&(d=LibraryBrowser.getListViewHtml({items:i.Items,sortBy:l.SortBy,showIndex:!1,showRemoveFromPlaylist:!0,playFromHere:!0,defaultAction:"playallfromhere",smallIcon:!0}));var y=e.querySelector("#childrenContent .itemsContainer");y.innerHTML=d;for(var g=[],c=y.querySelectorAll("PAPER-ICON-ITEM"),f=0,m=c.length;m>f;f++)g.push(c[f]);var p=y.querySelector(".paperList");AppInfo.isTouchPreferred||require(["sortable"],function(r){new r(p,{draggable:".listItem",onEnd:function(r){o(r,e,a)}})}),ImageLoader.lazyChildren(y),r(y).createCardMenus(),r(y).off("needsrefresh").on("needsrefresh",function(){n(e,a)}).off("removefromplaylist").on("removefromplaylist",function(r,t){s(e,a,[t])}),r(".btnNextPage",y).on("click",function(){l.StartIndex+=l.Limit,n(e,a)}),r(".btnPreviousPage",y).on("click",function(){l.StartIndex-=l.Limit,n(e,a)}),Dashboard.hideLoadingMsg()})}function o(e,r,t){var i=e.item,a=e.newIndex,o=i.getAttribute("data-playlistitemid");Dashboard.showLoadingMsg(),ApiClient.ajax({url:ApiClient.getUrl("Playlists/"+t.Id+"/Items/"+o+"/Move/"+a),type:"POST"}).then(function(){Dashboard.hideLoadingMsg()},function(){Dashboard.hideLoadingMsg(),n(r,t)})}function s(e,r,t){ApiClient.ajax({url:ApiClient.getUrl("Playlists/"+r.Id+"/Items",{EntryIds:t.join(",")}),type:"DELETE"}).then(function(){n(e,r)})}function l(){if(!AppInfo.isTouchPreferred){var r="7";e.getItem("playlistitemdragdrophelp")!=r&&(e.setItem("playlistitemdragdrophelp",r),Dashboard.alert({message:Globalize.translate("TryDragAndDropMessage"),title:Globalize.translate("HeaderTryDragAndDrop")}))}}var d={};window.PlaylistViewer={render:function(e,r){n(e,r),l()}}});