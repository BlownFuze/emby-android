define(["appStorage","jQuery"],function(e,t){function r(){var e=n(),t=u[e];return t||(t=u[e]={query:{Fields:"PrimaryImageAspectRatio,SyncInfo",EnableImageTypes:"Primary,Backdrop,Banner,Thumb",StartIndex:0,Limit:200},view:LibraryBrowser.getSavedView(e)||LibraryBrowser.getDefaultItemsView("List","List")},t.query.ParentId=LibraryMenu.getTopParentId(),LibraryBrowser.loadSavedQueryValues(e,t.query)),t}function i(){return r().query}function n(){return LibraryBrowser.getSavedQueryKey()}function a(e,n){Dashboard.showLoadingMsg();var l=i();l.UserId=Dashboard.getCurrentUserId(),ApiClient.getJSON(ApiClient.getUrl("Playlists/"+n.Id+"/Items",l)).then(function(i){window.scrollTo(0,0);var s="";s+=LibraryBrowser.getQueryPagingHtml({startIndex:l.StartIndex,limit:l.Limit,totalRecordCount:i.TotalRecordCount,showLimit:!1,updatePageSizeSetting:!1});var d=r().view;"List"==d&&(s=LibraryBrowser.getListViewHtml({items:i.Items,sortBy:l.SortBy,showIndex:!1,showRemoveFromPlaylist:!0,playFromHere:!0,defaultAction:"playallfromhere",smallIcon:!0}));var u=e.querySelector("#childrenContent .itemsContainer");u.innerHTML=s;for(var y=[],g=u.querySelectorAll("PAPER-ICON-ITEM"),c=0,m=g.length;m>c;c++)y.push(g[c]);var p=u.querySelector(".paperList");AppInfo.isTouchPreferred||require(["sortable"],function(t){new t(p,{draggable:".listItem",onEnd:function(t){o(t,e,n)}})}),ImageLoader.lazyChildren(u),LibraryBrowser.createCardMenus(u),t(".btnNextPage",u).on("click",function(){l.StartIndex+=l.Limit,a(e,n)}),t(".btnPreviousPage",u).on("click",function(){l.StartIndex-=l.Limit,a(e,n)}),Dashboard.hideLoadingMsg()})}function o(e,t,r){var i=e.item,n=e.newIndex,o=i.getAttribute("data-playlistitemid");Dashboard.showLoadingMsg(),ApiClient.ajax({url:ApiClient.getUrl("Playlists/"+r.Id+"/Items/"+o+"/Move/"+n),type:"POST"}).then(function(){Dashboard.hideLoadingMsg()},function(){Dashboard.hideLoadingMsg(),a(t,r)})}function l(e,t,r){ApiClient.ajax({url:ApiClient.getUrl("Playlists/"+t.Id+"/Items",{EntryIds:r.join(",")}),type:"DELETE"}).then(function(){a(e,t)})}function s(){if(!AppInfo.isTouchPreferred){var t="7";e.getItem("playlistitemdragdrophelp")!=t&&(e.setItem("playlistitemdragdrophelp",t),Dashboard.alert({message:Globalize.translate("TryDragAndDropMessage"),title:Globalize.translate("HeaderTryDragAndDrop")}))}}function d(e,t){var r=e.querySelector("#childrenContent .itemsContainer");r.addEventListener("removefromplaylist",function(r){var i=r.detail.playlistItemId;l(e,t,[i])}),r.addEventListener("needsrefresh",function(){a(e,t)})}var u={};window.PlaylistViewer={render:function(e,t){e.playlistInit||(e.playlistInit=!0,d(e,t)),a(e,t),s()}}});