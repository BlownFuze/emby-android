define(["libraryBrowser","alphaPicker","listView","emby-itemscontainer"],function(e,t,r){return function(a,n){function i(){var t=y;if(!t){t=y={query:{SortBy:"IsFolder,SortName",SortOrder:"Ascending",Fields:"DateCreated,PrimaryImageAspectRatio,MediaSourceCount,SyncInfo",ImageTypeLimit:1,EnableImageTypes:"Primary,Backdrop,Banner,Thumb",StartIndex:0,Limit:e.getDefaultPageSize()}},t.query.Filters="",t.query.NameStartsWithOrGreater="";var r=l();t.view=e.getSavedView(r)||e.getDefaultItemsView("Poster","Poster"),t.query.ParentId=n.parentId||null,e.loadSavedQueryValues(r,t.query)}return t}function o(){return i().query}function l(){return a.savedQueryKey||(a.savedQueryKey=e.getSavedQueryKey("itemsv1")),a.savedQueryKey}function s(){Dashboard.showLoadingMsg();var t=o(),l=Dashboard.getCurrentUserId(),u=t.ParentId?ApiClient.getItem(l,t.ParentId):ApiClient.getRootFolder(l),d=ApiClient.getItems(l,t);Promise.all([u,d]).then(function(o){function l(){t.StartIndex+=t.Limit,s(a)}function u(){t.StartIndex-=t.Limit,s(a)}var d=o[0];m=d;var y=o[1];window.scrollTo(0,0);var v=i(a).view,g="",f=e.getQueryPagingHtml({startIndex:t.StartIndex,limit:t.Limit,totalRecordCount:y.TotalRecordCount,showLimit:!1,addLayoutButton:!1,currentLayout:v,sortButton:!1,filterButton:!1});a.querySelector(".paging").innerHTML=f,c();var h=n.context,p={items:y.Items,shape:"auto",centerText:!0,lazy:!0,coverImage:"PhotoAlbum"==d.Type};"Backdrop"==v?(p.shape="backdrop",p.showTitle=!0,p.preferBackdrop=!0,g=e.getPosterViewHtml(p)):"PosterCard"==v?(p.showTitle=!0,p.showYear=!0,p.cardLayout=!0,p.centerText=!1,g=e.getPosterViewHtml(p)):"List"==v?g=r.getListViewHtml({items:y.Items,sortBy:t.SortBy}):"Thumb"==v?(p.preferThumb=!0,p.shape="backdrop",g=e.getPosterViewHtml(p)):(p.showTitle="photos"==h?"auto":!0,p.overlayText="photos"==h,g=e.getPosterViewHtml(p)),"boxsets"==m.CollectionType?(a.querySelector(".btnNewCollection").classList.remove("hide"),y.Items.length||(g='<p style="text-align:center;">'+Globalize.translate("MessageNoCollectionsAvailable")+"</p>")):a.querySelector(".btnNewCollection").classList.add("hide");var S=a.querySelector("#items");S.innerHTML=g+f,ImageLoader.lazyChildren(S);var b,w,L=a.querySelectorAll(".paging");for(b=0,w=L.length;w>b;b++)L[b].innerHTML=f;for(L=a.querySelectorAll(".btnNextPage"),b=0,w=L.length;w>b;b++)L[b].addEventListener("click",l);for(L=a.querySelectorAll(".btnPreviousPage"),b=0,w=L.length;w>b;b++)L[b].addEventListener("click",u);e.saveQueryValues(n.parentId,t);var P=d.Name;null!=d.IndexNumber&&(P=d.IndexNumber+" - "+P),null!=d.ParentIndexNumber&&(P=d.ParentIndexNumber+"."+P),LibraryMenu.setTitle(P),a.dispatchEvent(new CustomEvent("displayingitem",{detail:{item:d},bubbles:!0})),Dashboard.hideLoadingMsg()})}function u(){require(["components/filterdialog/filterdialog"],function(e){var t=new e({query:o()});Events.on(t,"filterchange",function(){s()}),t.show()})}function d(e,t){for(;!e.classList||!e.classList.contains(t);)if(e=e.parentNode,!e)return null;return e}function c(){var e=o();self.alphaPicker.value(e.NameStartsWithOrGreater)}var m,y,v=a.querySelector(".alphaPicker");v.addEventListener("alphavaluechanged",function(e){var t=e.detail.value,r=o();r.NameStartsWithOrGreater=t,r.StartIndex=0,s(a)}),self.alphaPicker=new t({element:v,valueChangeEvent:"click"}),a.addEventListener("click",function(t){var r=d(t.target,"mediaItem");if(r){var n=o(),i=e.getListItemInfo(r);if("Photo"==i.mediaType)return require(["scripts/photos"],function(){Photos.startSlideshow(a,n,i.id)}),t.preventDefault(),!1}});var g=a.querySelector(".btnSelectView");g.addEventListener("click",function(t){e.showLayoutMenu(t.target,i().view,"List,Poster,PosterCard,Thumb".split(","))}),g.addEventListener("layoutchange",function(t){var r=t.detail.viewStyle;i().view=r,e.saveViewSetting(l(),r),s(a)}),a.querySelector(".btnFilter").addEventListener("click",function(){u()}),a.querySelector(".btnSort").addEventListener("click",function(){e.showSortMenu({items:[{name:Globalize.translate("OptionNameSort"),id:"IsFolder,SortName"},{name:Globalize.translate("OptionCommunityRating"),id:"CommunityRating,SortName"},{name:Globalize.translate("OptionCriticRating"),id:"CriticRating,SortName"},{name:Globalize.translate("OptionDateAdded"),id:"DateCreated,SortName"},{name:Globalize.translate("OptionDatePlayed"),id:"DatePlayed,SortName"},{name:Globalize.translate("OptionParentalRating"),id:"OfficialRating,SortName"},{name:Globalize.translate("OptionPlayCount"),id:"PlayCount,SortName"},{name:Globalize.translate("OptionReleaseDate"),id:"PremiereDate,SortName"},{name:Globalize.translate("OptionRuntime"),id:"Runtime,SortName"}],callback:function(){s(a)},query:o()})}),a.querySelector(".btnNewCollection").addEventListener("click",function(){require(["collectionEditor"],function(e){var t=ApiClient.serverInfo().Id;(new e).show({items:[],serverId:t})})}),a.addEventListener("viewbeforeshow",function(){s(a),c(),LibraryMenu.setBackButtonVisible(n.context)}),a.addEventListener("viewdestroy",function(){self.alphaPicker&&self.alphaPicker.destroy()})}});