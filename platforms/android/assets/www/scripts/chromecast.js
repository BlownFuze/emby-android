define([],function(){function e(e){var t=n,s=i;n=null,i=null,e?t&&t():s?s():MediaController.removeActivePlayer(a)}function t(){function t(){var e=s.lastPlayerData||{};return e=e.PlayState||{},null==e.VolumeLevel?100:e.VolumeLevel}var s=this;s.name=a,s.getItemsForPlayback=function(e){var t=Dashboard.getCurrentUserId();return e.Ids&&1==e.Ids.split(",").length?new Promise(function(s){ApiClient.getItem(t,e.Ids.split(",")).then(function(e){s({Items:[e],TotalRecordCount:1})})}):(e.Limit=e.Limit||100,e.ExcludeLocationTypes="Virtual",ApiClient.getItems(t,e))},Events.on(l,"connect",function(){n?e(!0):MediaController.setActivePlayer(a,s.getCurrentTargetInfo()),s.lastPlayerData={}}),Events.on(l,"playbackstart",function(e,t){l.initializeCastPlayer();var n=s.getPlayerStateInternal(t);Events.trigger(s,"playbackstart",[n])}),Events.on(l,"playbackstop",function(e,t){var n=s.getPlayerStateInternal(t);Events.trigger(s,"playbackstop",[n]),s.lastPlayerData={}}),Events.on(l,"playbackprogress",function(e,t){var n=s.getPlayerStateInternal(t);Events.trigger(s,"positionchange",[n])}),s.play=function(e){Dashboard.getCurrentUser().then(function(){e.items?s.playWithCommand(e,"PlayNow"):s.getItemsForPlayback({Ids:e.ids.join(",")}).then(function(t){e.items=t.Items,s.playWithCommand(e,"PlayNow")})})},s.playWithCommand=function(e,t){return e.items?void l.loadMedia(e,t):void ApiClient.getItem(Dashboard.getCurrentUserId(),e.ids[0]).then(function(n){e.items=[n],s.playWithCommand(e,t)})},s.unpause=function(){l.sendMessage({options:{},command:"Unpause"})},s.pause=function(){l.sendMessage({options:{},command:"Pause"})},s.shuffle=function(e){var t=Dashboard.getCurrentUserId();ApiClient.getItem(t,e).then(function(e){s.playWithCommand({items:[e]},"Shuffle")})},s.instantMix=function(e){var t=Dashboard.getCurrentUserId();ApiClient.getItem(t,e).then(function(e){s.playWithCommand({items:[e]},"InstantMix")})},s.canQueueMediaType=function(e){return"Audio"==e},s.queue=function(e){s.playWithCommnd(e,"PlayLast")},s.queueNext=function(e){s.playWithCommand(e,"PlayNext")},s.stop=function(){l.sendMessage({options:{},command:"Stop"})},s.displayContent=function(e){l.sendMessage({options:e,command:"DisplayContent"})},s.mute=function(){l.sendMessage({options:{},command:"Mute"})},s.unMute=function(){s.setVolume(t()+2)},s.setRepeatMode=function(e){l.sendMessage({options:{RepeatMode:e},command:"SetRepeatMode"})},s.toggleMute=function(){var e=s.lastPlayerData||{};e=e.PlayState||{},e.IsMuted?s.unMute():s.mute()},s.getTargets=function(){return new Promise(function(e){var t=[];l.hasReceivers&&t.push(s.getCurrentTargetInfo()),e(t)})},s.getCurrentTargetInfo=function(){var e=null;return l.session&&l.session.receiver&&l.session.receiver.friendlyName&&(e=l.session.receiver.friendlyName),{name:a,id:a,playerName:a,playableMediaTypes:["Audio","Video"],isLocalPlayer:!1,appName:a,deviceName:e,supportedCommands:["VolumeUp","VolumeDown","Mute","Unmute","ToggleMute","SetVolume","SetAudioStreamIndex","SetSubtitleStreamIndex","DisplayContent","SetRepeatMode","EndSession"]}},s.seek=function(e){e=parseInt(e),e/=1e7,l.sendMessage({options:{position:e},command:"Seek"})},s.setAudioStreamIndex=function(e){l.sendMessage({options:{index:e},command:"SetAudioStreamIndex"})},s.setSubtitleStreamIndex=function(e){l.sendMessage({options:{index:e},command:"SetSubtitleStreamIndex"})},s.nextTrack=function(){l.sendMessage({options:{},command:"NextTrack"})},s.previousTrack=function(){l.sendMessage({options:{},command:"PreviousTrack"})},s.beginPlayerUpdates=function(){},s.endPlayerUpdates=function(){},s.volumeDown=function(){l.sendMessage({options:{},command:"VolumeDown"})},s.endSession=function(){s.stop(),setTimeout(function(){l.stopApp()},1e3)},s.volumeUp=function(){l.sendMessage({options:{},command:"VolumeUp"})},s.setVolume=function(e){e=Math.min(e,100),e=Math.max(e,0),l.sendMessage({options:{volume:e},command:"SetVolume"})},s.getPlayerState=function(){return new Promise(function(e){var t=s.getPlayerStateInternal();e(t)})},s.lastPlayerData={},s.getPlayerStateInternal=function(e){return e=e||s.lastPlayerData,s.lastPlayerData=e,e},s.tryPair=function(){return new Promise(function(e,t){l.deviceState!=o.ACTIVE&&l.isInitialized?(n=e,i=t,l.launchApp()):(n=null,i=null,t())})}}function s(){l=new u;var e=new t;MediaController.registerPlayer(e),document.dispatchEvent(new CustomEvent("chromecastloaded",{detail:{player:e}}))}var n,i,a="Chromecast",o={IDLE:0,ACTIVE:1,WARNING:2,ERROR:3},r={IDLE:"IDLE",LOADING:"LOADING",LOADED:"LOADED",PLAYING:"PLAYING",PAUSED:"PAUSED",STOPPED:"STOPPED",SEEKING:"SEEKING",ERROR:"ERROR"},d="2D4B1DA3",c="urn:x-cast:com.connectsdk",u=function(){this.deviceState=o.IDLE,this.currentMediaSession=null,this.session=null,this.castPlayerState=r.IDLE,this.hasReceivers=!1,this.errorHandler=this.onError.bind(this),this.mediaStatusUpdateHandler=this.onMediaStatusUpdate.bind(this),this.initializeCastPlayer()};u.prototype.initializeCastPlayer=function(){var e=window.chrome;if(e){if(!e.cast||!e.cast.isAvailable)return void setTimeout(this.initializeCastPlayer.bind(this),1e3);var t=new e.cast.SessionRequest(d),s=new e.cast.ApiConfig(t,this.sessionListener.bind(this),this.receiverListener.bind(this));e.cast.initialize(s,this.onInitSuccess.bind(this),this.errorHandler)}},u.prototype.onInitSuccess=function(){this.isInitialized=!0},u.prototype.onError=function(){},u.prototype.sessionListener=function(e){this.session=e,this.session&&(this.session.media[0]&&this.onMediaDiscovered("activeSession",this.session.media[0]),this.onSessionConnected(e))},u.prototype.messageListener=function(e,t){if(t=JSON.parse(t),"playbackerror"==t.type){var s=t.data;setTimeout(function(){Dashboard.alert({message:Globalize.translate("MessagePlaybackError"+s),title:Globalize.translate("HeaderPlaybackError")})},300)}else"connectionerror"==t.type?setTimeout(function(){Dashboard.alert({message:Globalize.translate("MessageChromecastConnectionError"),title:Globalize.translate("HeaderError")})},300):t.type&&0==t.type.indexOf("playback")&&Events.trigger(this,t.type,[t.data])},u.prototype.receiverListener=function(e){this.hasReceivers="available"===e?!0:!1},u.prototype.sessionUpdateListener=function(t){t||(this.session=null,this.deviceState=o.IDLE,this.castPlayerState=r.IDLE,this.currentMediaSession=null,e(!1))},u.prototype.launchApp=function(){chrome.cast.requestSession(this.onRequestSessionSuccess.bind(this),this.onLaunchError.bind(this))},u.prototype.onRequestSessionSuccess=function(e){this.onSessionConnected(e)},u.prototype.onSessionConnected=function(e){this.session=e,this.deviceState=o.ACTIVE,this.session.addMessageListener(c,this.messageListener.bind(this)),this.session.addMediaListener(this.sessionMediaListener.bind(this)),this.session.addUpdateListener(this.sessionUpdateListener.bind(this)),Events.trigger(this,"connect"),this.sendMessage({options:{},command:"Identify"})},u.prototype.sessionMediaListener=function(e){this.currentMediaSession=e,this.currentMediaSession.addUpdateListener(this.mediaStatusUpdateHandler)},u.prototype.onLaunchError=function(){this.deviceState=o.ERROR,e(!1)},u.prototype.stopApp=function(){this.session&&this.session.stop(this.onStopAppSuccess.bind(this,"Session stopped"),this.errorHandler)},u.prototype.onStopAppSuccess=function(e){this.deviceState=o.IDLE,this.castPlayerState=r.IDLE,this.currentMediaSession=null},u.prototype.loadMedia=function(e,t){this.session&&(e.items=e.items.map(function(e){return{Id:e.Id,Name:e.Name,Type:e.Type,MediaType:e.MediaType,IsFolder:e.IsFolder}}),this.sendMessage({options:e,command:t}))},u.prototype.sendMessage=function(e){var t=this,s=null;l.session&&l.session.receiver&&l.session.receiver.friendlyName&&(s=l.session.receiver.friendlyName),e=$.extend(e,{userId:Dashboard.getCurrentUserId(),deviceId:ApiClient.deviceId(),accessToken:ApiClient.accessToken(),serverAddress:ApiClient.serverAddress(),receiverName:s});var n=AppSettings.maxChromecastBitrate();n&&(e.maxBitrate=n),require(["chromecasthelpers"],function(s){s.getServerAddress(ApiClient).then(function(s){e.serverAddress=s,t.sendMessageInternal(e)})})},u.prototype.sendMessageInternal=function(e){e=JSON.stringify(e),this.session.sendMessage(c,e,this.onPlayCommandSuccess.bind(this),this.errorHandler)},u.prototype.onPlayCommandSuccess=function(){},u.prototype.onMediaDiscovered=function(e,t){this.currentMediaSession=t,"loadMedia"==e&&(this.castPlayerState=r.PLAYING),"activeSession"==e&&(this.castPlayerState=t.playerState),this.currentMediaSession.addUpdateListener(this.mediaStatusUpdateHandler)},u.prototype.onMediaStatusUpdate=function(e){0==e&&(this.castPlayerState=r.IDLE)},u.prototype.setReceiverVolume=function(e,t){this.currentMediaSession&&(e?this.session.setReceiverMuted(!0,this.mediaCommandSuccessCallback.bind(this),this.errorHandler):this.session.setReceiverVolumeLevel(t||1,this.mediaCommandSuccessCallback.bind(this),this.errorHandler))},u.prototype.mute=function(){this.setReceiverVolume(!0)},u.prototype.mediaCommandSuccessCallback=function(e){};var l,p=document.createElement("script");p.setAttribute("type","text/javascript"),p.onload=s,p.setAttribute("src","https://www.gstatic.com/cv/js/sender/v1/cast_sender.js"),document.querySelector("head").appendChild(p)});