define(["jQuery"],function(e){function t(e,t,i,n,o,r){var s='<div data-role="controlgroup">';s+=t.map(function(e){var t=n+e.Id,s=r?-1!=o.indexOf(e.Id):-1==o.indexOf(e.Id),a=s?' checked="checked"':"";return'<label for="'+t+'">'+e.Name+'</label><input class="'+i+'" type="checkbox" data-itemid="'+e.Id+'" id="'+t+'"'+a+" />"}).join(""),s+="</div>",e.html(s).trigger("create")}function i(i){var n=getParameterByName("type"),o=ApiClient.getUsers(),s=ApiClient.getNamedConfiguration(r),a=ApiClient.getJSON(ApiClient.getUrl("Notifications/Types")),c=ApiClient.getJSON(ApiClient.getUrl("Notifications/Services"));Promise.all([o,s,a,c]).then(function(o){var r=o[0],s=o[1],a=o[2],c=o[3],l=s.Options.filter(function(e){return e.Type==n})[0],d=a.filter(function(e){return e.Type==n})[0]||{};d.IsBasedOnUserEvent?e(".monitorUsers",i).show():e(".monitorUsers",i).hide(),d.Variables.length?(e(".tokenHelp",i).show(),e(".tokenList",i).html(d.Variables.map(function(e){return"{"+e+"}"}).join(", "))):e(".tokenHelp",i).hide(),e(".notificationType",i).html(d.Name||"Unknown Notification"),l||(l={DisabledMonitorUsers:[],SendToUsers:[],DisabledServices:[],SendToUserMode:"Admins"}),t(e(".monitorUsersList",i),r,"chkMonitor","chkMonitor",l.DisabledMonitorUsers),t(e(".sendToUsersList",i),r,"chkSendTo","chkSendTo",l.SendToUsers,!0),t(e(".servicesList",i),c,"chkService","chkService",l.DisabledServices),e("#chkEnabled",i).checked(l.Enabled||!1).checkboxradio("refresh"),e("#txtTitle",i).val(l.Title||d.DefaultTitle),e("#selectUsers",i).val(l.SendToUserMode).trigger("change")})}function n(t){var i=getParameterByName("type"),n=ApiClient.getNamedConfiguration(r),o=ApiClient.getJSON(ApiClient.getUrl("Notifications/Types"));Promise.all([n,o]).then(function(n){var o=n[0],s=n[1],a=o.Options.filter(function(e){return e.Type==i})[0];a||(a={Type:i},o.Options.push(a));var c=s.filter(function(e){return e.Type==i})[0]||{};a.Enabled=e("#chkEnabled",t).checked(),a.Title=e("#txtTitle",t).val(),a.SendToUserMode=e("#selectUsers",t).val(),a.Title==c.DefaultTitle&&(a.Title=null),a.DisabledMonitorUsers=e(".chkMonitor:not(:checked)",t).get().map(function(e){return e.getAttribute("data-itemid")}),a.SendToUsers=e(".chkSendTo:checked",t).get().map(function(e){return e.getAttribute("data-itemid")}),a.DisabledServices=e(".chkService:not(:checked)",t).get().map(function(e){return e.getAttribute("data-itemid")}),ApiClient.updateNamedConfiguration(r,o).then(function(){Dashboard.navigate("notificationsettings.html")})})}function o(){var t=e(this).parents(".page");return n(t),!1}var r="notifications";e(document).on("pageinit","#notificationSettingPage",function(){var t=this;e("#selectUsers",t).on("change",function(){"Custom"==this.value?e(".selectCustomUsers",t).show():e(".selectCustomUsers",t).hide()}),e(".notificationSettingForm").off("submit",o).on("submit",o)}).on("pageshow","#notificationSettingPage",function(){var e=this;i(e)})});