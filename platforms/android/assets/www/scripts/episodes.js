define(["ironCardList","scrollThreshold","events","libraryBrowser","jQuery"],function(e,t,r,a,i){return function(n,o,s){function l(e){var t=u(e),r=v[t];return r||(r=v[t]={query:{SortBy:"SeriesSortName,SortName",SortOrder:"Ascending",IncludeItemTypes:"Episode",Recursive:!0,Fields:"PrimaryImageAspectRatio,MediaSourceCount,UserData,SyncInfo",IsMissing:!1,IsVirtualUnaired:!1,ImageTypeLimit:1,EnableImageTypes:"Primary,Backdrop,Banner,Thumb",StartIndex:0,Limit:p},view:a.getSavedView(t)||a.getDefaultItemsView("Poster","Poster")},r.query.ParentId=o.topParentId,a.loadSavedQueryValues(t,r.query)),r}function d(e){return l(e).query}function u(e){return e.savedQueryKey||(e.savedQueryKey=a.getSavedQueryKey("episodes")),e.savedQueryKey}function m(e){var t,r=g.getCurrentViewStyle();"List"==r?html=a.getListViewHtml({items:e.Items,sortBy:query.SortBy}):t="PosterCard"==r?{items:e.Items,shape:"backdrop",showTitle:!0,showParentTitle:!0,lazy:!0,cardLayout:!0,showDetailsMenu:!0}:{items:e.Items,shape:"backdrop",showTitle:!0,showParentTitle:!0,overlayText:!0,lazy:!0,showDetailsMenu:!0,overlayPlayButton:!0},g.cardOptions=t}function c(e){g.isLoading=!0,Dashboard.showLoadingMsg();var t=d(e),r=t.StartIndex,i=!g.cardOptions||0==r;ApiClient.getItems(Dashboard.getCurrentUserId(),t).then(function(n){S(e);var o=!0;i&&(m(n),o=!1),a.setPosterViewData(g.cardOptions),a.setPosterViewDataOnItems(g.cardOptions,n.Items);var s=e.querySelector("#ironList");if(o)for(var l=0,d=n.Items.length;d>l;l++)s.push("items",n.Items[l]);else s.items=n.Items;setTimeout(function(){s.notifyResize(),g.scrollThreshold.resetSize()},300),a.saveQueryValues(u(e),t),Dashboard.hideLoadingMsg(),g.hasMoreItems=n.TotalRecordCount>r+n.Items.length,g.isLoading=!1})}function S(e){var t=d(e);i(".alphabetPicker",e).alphaValue(t.NameStartsWithOrGreater)}function h(e){i(".alphabetPicker",e).on("alphaselect",function(t,r){var a=d(e);a.NameStartsWithOrGreater=r,a.StartIndex=0,c(e)}).on("alphaclear",function(){var t=d(e);t.NameStartsWithOrGreater="",c(e)}),i(".itemsContainer",e).on("needsrefresh",function(){c(e)}),e.querySelector(".btnFilter").addEventListener("click",function(){g.showFilterMenu()}),e.querySelector(".btnSort").addEventListener("click",function(t){a.showSortMenu({items:[{name:Globalize.translate("OptionNameSort"),id:"SeriesSortName,SortName"},{name:Globalize.translate("OptionTvdbRating"),id:"CommunityRating,SeriesSortName,SortName"},{name:Globalize.translate("OptionDateAdded"),id:"DateCreated,SeriesSortName,SortName"},{name:Globalize.translate("OptionPremiereDate"),id:"PremiereDate,SeriesSortName,SortName"},{name:Globalize.translate("OptionDatePlayed"),id:"DatePlayed,SeriesSortName,SortName"},{name:Globalize.translate("OptionParentalRating"),id:"OfficialRating,SeriesSortName,SortName"},{name:Globalize.translate("OptionPlayCount"),id:"PlayCount,SeriesSortName,SortName"},{name:Globalize.translate("OptionRuntime"),id:"Runtime,SeriesSortName,SortName"},{name:Globalize.translate("OptionVideoBitrate"),id:"VideoBitRate,SeriesSortName,SortName"}],callback:function(){c(e)},query:d(e),button:t.target})}),e.querySelector(".btnSelectView").addEventListener("click",function(e){a.showLayoutMenu(e.target,g.getCurrentViewStyle(),"List,Poster,PosterCard".split(","))}),e.querySelector(".btnSelectView").addEventListener("layoutchange",function(t){var r=t.detail.viewStyle;l(e).view=r,a.saveViewSetting(u(e),r),c(e)})}function y(){return g.listCreated?Promise.resolve():e.getTemplate("episodesTab").then(function(e){s.querySelector(".itemsContainer").innerHTML=e,g.listCreated=!0})}function f(){!g.isLoading&&g.hasMoreItems&&(d(s).StartIndex+=p,c(s))}var g=this,p=a.getDefaultPageSize(),v={};g.showFilterMenu=function(){require(["components/filterdialog/filterdialog"],function(e){var t=new e({query:d(s),mode:"episodes"});Events.on(t,"filterchange",function(){c(s)}),t.show()})},g.getCurrentViewStyle=function(){return l(s).view},h(s),g.scrollThreshold=new t(s,!1),r.on(g.scrollThreshold,"lower-threshold",f),g.renderTab=function(){y().then(function(){c(s),S(s)})},g.destroy=function(){r.off(g.scrollThreshold,"lower-threshold",f),g.scrollThreshold&&g.scrollThreshold.destroy()}}});