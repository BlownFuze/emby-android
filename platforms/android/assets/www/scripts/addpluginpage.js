define(["jQuery"],function(e){function i(i,t){for(var a="",n=0,r=Math.min(i.versions.length,10);r>n;n++){var s=i.versions[n];a+='<h2 style="margin:.5em 0;">'+s.versionStr+" ("+s.classification+")</h2>",a+='<div style="margin-bottom:1.5em;">'+s.description+"</div>"}e("#revisionHistory",t).html(a)}function t(i,t,a){for(var n="",r=0,s=i.versions.length;s>r;r++){var o=i.versions[r];n+='<option value="'+o.versionStr+"|"+o.classification+'">'+o.versionStr+" ("+o.classification+")</option>"}var l=e("#selectVersion",t).html(n);a||e("#pCurrentVersion",t).hide().html("");var g=i.versions.filter(function(e){return"Release"==e.classification})[0];if(g||(g=i.versions.filter(function(e){return"Beta"==e.classification})[0]),g){var h=g.versionStr+"|"+g.classification;l.val(h)}}function a(i,t){ApiClient.getPackageReviews(i,null,null,3).then(function(i){var a="";if(i&&i.length>0){a+='<div data-role="collapsible" data-collapsed="true" style="margin-top: 2em;" >',a+="<h3>"+Globalize.translate("HeaderLatestReviews")+"</h3>",a+="<div><br/>";for(var n=0;n<i.length;n++){var r=i[n];a+="<div>",a+="<span class='storeItemReviewText'>",a+=new Date(r.timestamp).toDateString(),r.rating&&(a+='<iron-icon icon="star" style="color:#666;height:20px;width:20px;min-height:20px;min-width:20px;margin-right:.25em;"></iron-icon>',a+=r.rating.toFixed(1)),a+=" "+r.title,a+="</span>",r.review&&(a+="<p class='storeItemReviewText'>",a+=r.review,a+="</p>"),a+="</div>",a+="<hr/>"}a+="</div>",a+="</div>"}e("#latestReviews",t).html(a).trigger("create")})}function n(n,r,s,o){var l=r.filter(function(e){return e.Name==n.name})[0];if(t(n,o,l),i(n,o),n.totalRatings>0&&a(n.id,o),e(".pluginName",o).html(n.name),"Server"==n.targetSystem)e("#btnInstallDiv",o).removeClass("hide"),e("#nonServerMsg",o).hide(),e("#pSelectVersion",o).removeClass("hide");else{e("#btnInstallDiv",o).addClass("hide"),e("#pSelectVersion",o).addClass("hide");var g=Globalize.translate("MessageInstallPluginFromApp");e("#nonServerMsg",o).html(g).show()}n.shortDescription?e("#tagline",o).show().html(n.shortDescription):e("#tagline",o).hide(),e("#overview",o).html(n.overview||""),e("#developer",o).html(n.owner),RegistrationServices.renderPluginInfo(o,n,s);var h="";if(n.avgRating&&(h+='<iron-icon icon="star" style="color:#666;height:20px;width:20px;min-height:20px;min-width:20px;margin-right:.25em;"></iron-icon>',h+=n.avgRating.toFixed(1)),h+="<span>",h+=" "+Globalize.translate("ValueReviewCount").replace("{0}",n.totalRatings),h+="</span>",e("#ratingLine",o).html(h),n.richDescUrl?(e("#pViewWebsite",o).show(),e("#pViewWebsite a",o).attr("href",n.richDescUrl)):e("#pViewWebsite",o).hide(),n.previewImage||n.thumbImage){var d=n.tileColor||"#38c",u=n.previewImage?n.previewImage:n.thumbImage;e("#pPreviewImage",o).show().html("<img src='"+u+"' style='max-width: 100%;-moz-box-shadow: 0 0 20px 3px "+d+";-webkit-box-shadow: 0 0 20px 3px "+d+";box-shadow: 0 0 20px 3px "+d+";' />")}else e("#pPreviewImage",o).hide().html("");if(l){var m=Globalize.translate("MessageYouHaveVersionInstalled").replace("{0}","<strong>"+l.Version+"</strong>");e("#pCurrentVersion",o).show().html(m)}else e("#pCurrentVersion",o).hide().html("");Dashboard.hideLoadingMsg()}function r(i,t,a,n,r){var s=e("#developer",i).html().toLowerCase(),o=function(e){e&&(Dashboard.showLoadingMsg(),i.querySelector("#btnInstall").disabled=!0,ApiClient.installPlugin(t,a,n,r).then(function(){Dashboard.hideLoadingMsg()}))};if("luke"!=s&&"ebr"!=s){Dashboard.hideLoadingMsg();var l=Globalize.translate("MessagePluginInstallDisclaimer");l+="<br/>",l+="<br/>",l+=Globalize.translate("PleaseConfirmPluginInstallation"),require(["confirm"],function(e){e(l,Globalize.translate("HeaderConfirmPluginInstallation")).then(function(){o(!0)},function(){o(!1)})})}else o(!0)}function s(){var i=this;i.onSubmit=function(){Dashboard.showLoadingMsg();var i=e(this).parents("#addPluginPage")[0],t=getParameterByName("name"),a=getParameterByName("guid");return ApiClient.getInstalledPlugins().then(function(n){var s=n.filter(function(e){return e.Name==t})[0],o=e("#selectVersion",i).val().split("|"),l=o[0];s&&s.Version==l?(Dashboard.hideLoadingMsg(),Dashboard.alert({message:Globalize.translate("MessageAlreadyInstalled"),title:Globalize.translate("HeaderPluginInstallation")})):r(i,t,a,o[1],l)}),!1}}e(document).on("pageinit","#addPluginPage",function(){e(".addPluginForm").off("submit",AddPluginPage.onSubmit).on("submit",AddPluginPage.onSubmit)}).on("pageshow","#addPluginPage",function(){var e=this;Dashboard.showLoadingMsg();var i=getParameterByName("name"),t=getParameterByName("guid"),a=ApiClient.getPackageInfo(i,t),r=ApiClient.getInstalledPlugins(),s=ApiClient.getPluginSecurityInfo();Promise.all([a,r,s]).then(function(i){n(i[0],i[1],i[2],e)})}).on("pagebeforeshow pageinit pageshow","#addPluginPage",function(){var i=this,t=getParameterByName("context");e(".notificationsTabs",i).hide(),"sync"==t?(i.setAttribute("data-helpurl","https://github.com/MediaBrowser/Wiki/wiki/Sync"),Dashboard.setPageTitle(Globalize.translate("TitleSync"))):"livetv"==t?(Dashboard.setPageTitle(Globalize.translate("TitleLiveTV")),i.setAttribute("data-helpurl","https://github.com/MediaBrowser/Wiki/wiki/Live%20TV")):"notifications"==t?(e(".notificationsTabs",i).show(),Dashboard.setPageTitle(Globalize.translate("TitleNotifications")),i.setAttribute("data-helpurl","https://github.com/MediaBrowser/Wiki/wiki/Notifications")):(i.setAttribute("data-helpurl","https://github.com/MediaBrowser/Wiki/wiki/Plugins"),Dashboard.setPageTitle(Globalize.translate("TitlePlugins")))}),window.AddPluginPage=new s});