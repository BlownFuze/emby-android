(function(){var updatedProducts=[];var enteredEmail;function getStoreFeatureId(feature){if(feature=='embypremieremonthly'){return'emby.subscription.monthly';}
return'appunlock';}
function updateProductInfo(product){updatedProducts=updatedProducts.filter(function(r){return r.id!=product.id;});updatedProducts.push(product);Events.trigger(IapManager,'productupdated',[product]);}
function getProduct(feature){var id=getStoreFeatureId(feature);var products=updatedProducts.filter(function(r){return r.id==id;});return products.length?products[0]:null;}
function isPurchaseAvailable(feature){var product=getProduct(feature);return product!=null&&product.valid;}
function beginPurchase(feature,email){if(email){enteredEmail=email;}
validationCache={};var id=getStoreFeatureId(feature);store.order(id);}
function restorePurchase(id){validationCache={};store.refresh();}
var validationCache={};function validateProduct(product,callback){var productId=product.id;if((productId||'').toLowerCase().indexOf('appunlock')!=-1){callback(true,product);return;}
var cacheKey=productId+(product.transaction.id||'');var cachedResult=validationCache[cacheKey];if(cachedResult&&(new Date().getTime()-cachedResult.date)<60000){if(cachedResult.result){callback(true,product);}else{callback(false,{code:cachedResult.errorCode,error:{message:cachedResult.errorMessage}});}
return;}
var receipt=product.transaction.appStoreReceipt;var price=product.price;var postData={store:"Apple",application:"com.emby.mobile",product:productId,type:"Subscription",storeToken:receipt,amt:price};var promise;if(enteredEmail){postData.email=enteredEmail;postData.storeId=enteredEmail;postData.feature="MBSClubMonthly";promise=ApiClient.ajax({type:"POST",url:ApiClient.getUrl("Appstore/Register"),data:{Parameters:JSON.stringify(postData)}});}else{promise=fetch("http://mb3admin.com/admin/service/appstore/register",{method:'POST',body:JSON.stringify(postData),headers:{"X-Emby-Token":"EMBY-APPLE-VALIDATE","Content-Type":"application/json"}});}
promise.then(function(){setCachedResult(cacheKey,true);callback(true,product);},function(e){if(e.status==402){setCachedResult(cacheKey,false,store.PURCHASE_EXPIRED,'Subscription Expired');callback(false,{code:store.PURCHASE_EXPIRED,error:{message:"Subscription Expired"}});}else{validationCache={};callback(false,{code:store.CONNECTION_FAILED,error:{message:"Connection Failure"}});}});}
function setCachedResult(key,result,code,message){validationCache[key]={date:new Date().getTime(),result:result,errorCode:code,errorMessage:message};}
function initProduct(id,requiresVerification,type){store.register({id:id,alias:id,type:type});store.when(id).approved(function(product){if(requiresVerification){product.verify();}else{product.finish();}});if(requiresVerification){store.when(id).verified(function(p){updateProductInfo(p);p.finish();});}
store.when(id).updated(function(product){if(product.loaded&&product.valid&&product.state==store.APPROVED){Logger.log('finishing previously created transaction');if(requiresVerification){if(product.owned){}}else{product.finish();}}
updateProductInfo(product);});}
function initializeStore(){store.verbosity=store.INFO;store.validator=validateProduct;initProduct(getStoreFeatureId(""),false,store.NON_CONSUMABLE);initProduct(getStoreFeatureId("embypremieremonthly"),true,store.PAID_SUBSCRIPTION);store.ready(function(){Logger.log("Store ready");});store.refresh();}
function getSubscriptionOptions(){return new Promise(function(resolve,reject){var options=[];options.push({feature:'embypremieremonthly',buttonText:'EmbyPremiereMonthlyWithPrice'});options=options.filter(function(o){return getProduct(o.feature)!=null;}).map(function(o){o.id=getStoreFeatureId(o.feature);o.buttonText=Globalize.translate(o.buttonText,getProduct(o.feature).price);o.owned=getProduct(o.feature).owned;return o;});resolve(options);});}
function isUnlockedOverride(feature){return new Promise(function(resolve,reject){resolve(false);});}
window.IapManager={isPurchaseAvailable:isPurchaseAvailable,getProductInfo:getProduct,beginPurchase:beginPurchase,restorePurchase:restorePurchase,getSubscriptionOptions:getSubscriptionOptions,isUnlockedOverride:isUnlockedOverride};initializeStore();})();